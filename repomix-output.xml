This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
apps/api/.git/COMMIT_EDITMSG
apps/api/.git/config
apps/api/.git/description
apps/api/.git/FETCH_HEAD
apps/api/.git/HEAD
apps/api/.git/hooks/applypatch-msg.sample
apps/api/.git/hooks/commit-msg.sample
apps/api/.git/hooks/fsmonitor-watchman.sample
apps/api/.git/hooks/post-update.sample
apps/api/.git/hooks/pre-applypatch.sample
apps/api/.git/hooks/pre-commit.sample
apps/api/.git/hooks/pre-merge-commit.sample
apps/api/.git/hooks/pre-push.sample
apps/api/.git/hooks/pre-rebase.sample
apps/api/.git/hooks/pre-receive.sample
apps/api/.git/hooks/prepare-commit-msg.sample
apps/api/.git/hooks/push-to-checkout.sample
apps/api/.git/hooks/sendemail-validate.sample
apps/api/.git/hooks/update.sample
apps/api/.git/index
apps/api/.git/info/exclude
apps/api/.git/logs/HEAD
apps/api/.git/logs/refs/heads/main
apps/api/.git/logs/refs/remotes/origin/HEAD
apps/api/.git/logs/refs/remotes/origin/main
apps/api/.git/objects/00/b45e967e10a6c6692bd215db923ed4ee163611
apps/api/.git/objects/00/fdb3f033dcb317813cb91e70854457cd98e5d9
apps/api/.git/objects/01/74e05a5753ee05952b51a7a4bf8f129b7d685e
apps/api/.git/objects/02/6260e696c0c71ef35cbd3ab7e64bd26c3bfff1
apps/api/.git/objects/02/9832daac96fd4af0e1786c511d19b13111ca8c
apps/api/.git/objects/03/3870e20f7d0d296be6f0aee56d86006ce0b760
apps/api/.git/objects/04/10a886bcfecf025b6a1a4bb59450e5778c391a
apps/api/.git/objects/04/c2de144cd824981dca3840bdf59ab3ad01b2e4
apps/api/.git/objects/04/d52c163f700ba353ff214473651d24edad286f
apps/api/.git/objects/05/1d5053af3c76a94c431e482691ce70b4816231
apps/api/.git/objects/05/cc7fe9c8224a421d3a80ca931a0e1c0975e852
apps/api/.git/objects/05/e9d6943879eb9863498ac27ce0d5cad9775d4d
apps/api/.git/objects/06/a24b62978117b11ab9b28550685efafa753e44
apps/api/.git/objects/07/0de64eff24ed8fbce21f5c6191efcac1c00241
apps/api/.git/objects/07/1e22b65ed777bfd62725d706f32907ca2d8695
apps/api/.git/objects/07/aff4280f0408b6eeafc7c17d9b9a1d3411479a
apps/api/.git/objects/08/3fb9a391328097901b5a94ed4c8a3d44ddd801
apps/api/.git/objects/08/7353f397dc330104c6f8d1cfa01d4cdca99f33
apps/api/.git/objects/08/c47dce9e7e834978fc78954341fd0a2dfb1f16
apps/api/.git/objects/09/16dc9f334f973a1a13e4588b67f349b67a7f04
apps/api/.git/objects/0a/328a0ec89a5c72c39bb014536fad3f26c7dcf1
apps/api/.git/objects/0c/2dd67bad4b4a7c899e801bf3ff9ed4d5f753c0
apps/api/.git/objects/0c/2f032604d6851949a853083ab4074379b6a001
apps/api/.git/objects/0c/5162d99d43781cf00d2e7ba466c9f5af701ce3
apps/api/.git/objects/0d/398b738c0bfc0d6dfb55f5491208156b0a5229
apps/api/.git/objects/0e/a049649e6a7955c3ae9218d40aa8c7232f554a
apps/api/.git/objects/10/14e66d23ab90982037355d156b7be7accee16f
apps/api/.git/objects/10/ef8b86e8ee81a57a6700ae78ee898f584c96b4
apps/api/.git/objects/11/b2a2283bef3bdbee2f534b7c2223b8ab5f61d0
apps/api/.git/objects/12/2d7ce609e37f729760373c41747174102ee0af
apps/api/.git/objects/14/0a09b51455fabcfe6ee05d0bb12353cde80e0a
apps/api/.git/objects/14/7b5b552eb1be30ae694e3274cdddfbd6370c9d
apps/api/.git/objects/14/89f359a38c589862d1ea6dc1fc215ef7886b3e
apps/api/.git/objects/14/97cf31255206ac7d2b04bedc8120a3b8d3df95
apps/api/.git/objects/14/a9dba9bcf3ed39d62659a6d6891fd84994416b
apps/api/.git/objects/15/0bf3bd846a2d4e083f9b8495b3a6ef9043543c
apps/api/.git/objects/15/dc947d46d4aca95a6d832ac97829c4d6116a8f
apps/api/.git/objects/16/4ad5cd82027819bfb6403075f098400d9f6329
apps/api/.git/objects/17/5f2ffeea109846c5fe1b17d43de74705ff0e64
apps/api/.git/objects/17/8ddd6410471d4020dfdadc6d6eb7f8de653c5f
apps/api/.git/objects/17/9920125a73ca03564b49d7c3e407c5a12201a1
apps/api/.git/objects/18/35cee8ec939bc82bfe243cfce6afa2c11718e4
apps/api/.git/objects/18/47c60c399a4414ab1d53a3a07c2c1165981281
apps/api/.git/objects/18/de283ac5888c0e2e669fed7829a752f7271df6
apps/api/.git/objects/19/17a080159a0f3693bcf4e199e6b60d232a6c05
apps/api/.git/objects/19/936adf37de6c0b2d52982b75374e05ceec17ac
apps/api/.git/objects/19/c39ef62ad161f381984eafe98d5604e63eabe6
apps/api/.git/objects/1a/12a483d90bb5bccf3f7d0eb78cc73fc5607087
apps/api/.git/objects/1a/76f2e6471056c1b04e65c2221b529414f15c87
apps/api/.git/objects/1b/edf87bee7e3c9283fb28e45ea41a674b94196f
apps/api/.git/objects/1c/87517e3c0d6694dba40ae57fb0fb93127313a4
apps/api/.git/objects/1d/1db0b3d76b4bdda6e4beab05e3265e5bc9174c
apps/api/.git/objects/1e/34505cbd80e5086e4ea7d75535f90b5a00ad04
apps/api/.git/objects/1e/546f00e763ba5853be8755d73c5234c5631af6
apps/api/.git/objects/1e/55af44d11d1e076a3e0067d8ee6379d65dc73f
apps/api/.git/objects/1e/c3827d16d3437177dc2c332291111a0df0b527
apps/api/.git/objects/1f/2678fa13ab8e5903f6142aafd58d9c4db40582
apps/api/.git/objects/1f/986e906a2b36944a8d864024292e27ef43c0b7
apps/api/.git/objects/20/31d47627039f6fbc00b2b7880fbbb6df4eeac7
apps/api/.git/objects/20/4be4c7171468dbc78df35eb149c48cac645f0b
apps/api/.git/objects/22/221cc826e601cdf271f0a49bad6e4a04a6c100
apps/api/.git/objects/22/f86f3d8a8cf547c04609f3f923240d6102e6ad
apps/api/.git/objects/23/d91893ec9e13002053b81a4d691f2ef17e540d
apps/api/.git/objects/23/e47957323e7224813e0b2cdf0f19eba16f40a2
apps/api/.git/objects/23/f100a39d3a76b5dc504a52965b717b527edff2
apps/api/.git/objects/25/64b6794c0519a53283b707fb674cbb612cf7b7
apps/api/.git/objects/26/ac95d0f7b9d6e8515c155830f2e86664c61aaf
apps/api/.git/objects/27/4548f18a0ce99d72fb2c739c23f993391c08db
apps/api/.git/objects/28/5d709e6f62ec4d067c244f12c6d6929a1d140d
apps/api/.git/objects/28/ac5de519dc87eb15d48a07cba905a8cbcd89ea
apps/api/.git/objects/28/b706e3146a1af9047e889d75884dffe208ded9
apps/api/.git/objects/29/12198120d9b7ea6f797eaec0742bda75ec3ea9
apps/api/.git/objects/29/1e34f614bc70ecd6653630777253a031c4cf05
apps/api/.git/objects/29/4e35bf03d349dab1cab945d3761bef64b19519
apps/api/.git/objects/2a/1ad468032fc9085b178754f02e700f4e1251f3
apps/api/.git/objects/2a/9e4a0a99b5bd30d00d4f3b30cd518e33a2fbc3
apps/api/.git/objects/2c/ab6f2101f1a4a91ad5b71405a2b74fdaba69ac
apps/api/.git/objects/2d/26bf4817a4ddcbaa1e3a127cdcbafc6417ce20
apps/api/.git/objects/2e/239f74d21ed862d94053da852c2b8688fee121
apps/api/.git/objects/2e/6d1b7450ab45c94cc580e3a87c894a4de28699
apps/api/.git/objects/2e/8141354ff75f451975dd17a52b4a0684d5b50f
apps/api/.git/objects/2e/95ca9b0c6c5c5a0243e40bfd167d957af8a6d7
apps/api/.git/objects/2e/a98fd840bdccde75889f5a943def1280171e13
apps/api/.git/objects/2f/3d5a0168970855f46dc792cddf15a27130a70e
apps/api/.git/objects/2f/4b736c1b12e69bb2bf46cd0d808b73e64cc9bd
apps/api/.git/objects/2f/6360716aa26e0ebcfdf6aae8c682648881d6a4
apps/api/.git/objects/2f/8a60d26b34e5b0aca52c1a0d9396b818144541
apps/api/.git/objects/30/64f62f2e2140f0e169198ef1881c838a1afa63
apps/api/.git/objects/30/6680cdca7cb4012a6d2dd624d9591e0085fa19
apps/api/.git/objects/31/3a45c1c764fd7daf3191f637157703c42b7d86
apps/api/.git/objects/31/80f8153b019857e85f2c115cfd5776c0958dfe
apps/api/.git/objects/32/692e997e1d411778da881f298ba64e3bf4edff
apps/api/.git/objects/32/8ce9a5daa62ace1f273e37e8114bcbc9436090
apps/api/.git/objects/33/3bfea36b1b942ca2d2189a2f4ea87c48a3b4cc
apps/api/.git/objects/33/48f5432b2abd329033c8f47475a0ac2da8b624
apps/api/.git/objects/33/750d12d522623c24c2bcc540a09e2107a8ccdd
apps/api/.git/objects/33/aebd7b8cd73225dbb41b017f4cbc5d350764fd
apps/api/.git/objects/33/cb6b0b10dd369d334e9d37bfdca506e7e50ef1
apps/api/.git/objects/34/8e9bfcaba8e953ce2782d4a0a6b54fb0a4fecf
apps/api/.git/objects/35/2e30e9f611e2c5e1744c8c7c636322f6d1a5fc
apps/api/.git/objects/35/c565fa8bca9a025e29912304e4a7732d5e8aec
apps/api/.git/objects/35/e832f7e7de6ed1a942bda00e3990d01046fe29
apps/api/.git/objects/37/88a663bb8ee11effccc214debbe275238fee21
apps/api/.git/objects/39/69bbd74c65659e766dfa679e648ed531d0715f
apps/api/.git/objects/39/b509ac3ad5565c6782c6ba8924d3ddf17f8dc5
apps/api/.git/objects/3b/1b55272a370646795c30d75470080d50e38bf3
apps/api/.git/objects/3b/deb134aac8e6f0f9cb85cf34ed5090bc38b2a3
apps/api/.git/objects/3c/8a9d99cdca80b8dced44aa928257ef997dd163
apps/api/.git/objects/3e/1f89e2fdd1521f3259be02ad5439136f43e889
apps/api/.git/objects/3e/758ee2ecb9fc4392231f35a3d27d481674fab1
apps/api/.git/objects/3e/bb90a188ed87f419dcaff7756a5e0967204210
apps/api/.git/objects/3e/ee3cb7515c0e55d4e572ac698b69655ca3d835
apps/api/.git/objects/3f/dd19a6a2b34e55b8cb146da9c1ef285393339e
apps/api/.git/objects/40/e43cbf82f7db342703d93df915edeb33910f6f
apps/api/.git/objects/40/ea324a73b7930a1c6f612bd0fecd068b7aeeb0
apps/api/.git/objects/41/30b1f808cb8a818bae5274975f74b401f1d24c
apps/api/.git/objects/41/87acc3feb0400aea2dec90999467ee6019aa05
apps/api/.git/objects/44/08ca386c742233f8e7a419e000928216f6a8c6
apps/api/.git/objects/44/37c159233928217474d13f899a90edc187c17f
apps/api/.git/objects/44/49791be4431f155b39d053fffd8e68a18d49c9
apps/api/.git/objects/44/8173227e26e340038360d511de9fa301cd07e0
apps/api/.git/objects/44/c48cc7d0f4b47e0c2eb6c8bf31a265b66dda4d
apps/api/.git/objects/45/2675c0cc5273002c1875910c71c0f726199c1a
apps/api/.git/objects/45/48985887093bda9301c52431bf1739064df428
apps/api/.git/objects/46/a560d92050b1a10c0d744bbd7d5f081cb1f071
apps/api/.git/objects/46/ae53b974854e0f87a132a314ede9a33b69ddaf
apps/api/.git/objects/47/5f4d1761956023939091bc3a0a2404bc1fd912
apps/api/.git/objects/47/74dfd71ae41f492449fee50d2f482e9240c98f
apps/api/.git/objects/47/846ca4bfc24cacc538ff9e98c4f910b4ebfad8
apps/api/.git/objects/48/1edfe155cf14ffd99d41db2cb76a3ef8bdbc7b
apps/api/.git/objects/48/e0f533f2090611ea31aa3a14858bb88f3247f3
apps/api/.git/objects/48/e7112565949c446ac1e4ceacdfc67881651854
apps/api/.git/objects/49/be63b897228e4981d85fe0172f4ce54544c2a0
apps/api/.git/objects/4a/35d3ead5965eccba2c6e7e0c95c71e0d26660a
apps/api/.git/objects/4a/50e789755ad3a6c0bc5a692d41988c693913c8
apps/api/.git/objects/4a/fd8b3919aacede46527958b50e1019d140c2ea
apps/api/.git/objects/4b/575e809d7aa6d096e50dd058fef4605f99ef0a
apps/api/.git/objects/4b/d8526fc454c7dd46ef33cad2cf76b62906eb50
apps/api/.git/objects/4c/27a5163dd8d32f88db8b57c8e3ce4aa1f6de63
apps/api/.git/objects/4c/28e446968f8743043bde088a545ed4d6a03519
apps/api/.git/objects/4c/a984c91a3bedbe6d185dabf13204fd4fad355b
apps/api/.git/objects/4d/160b6b6a0f85287993185b1ce2d8176bc07da6
apps/api/.git/objects/4d/18406f6b2dc30cb5dce7be1897e8e27100bfd8
apps/api/.git/objects/4f/33620008aa9f6a9c391de0fb7fcf53a907c6d1
apps/api/.git/objects/50/2491f7a0166ea072ca72bce1558bc6d915fdc7
apps/api/.git/objects/50/921092d59a69e6ca4532dc9f0ded9c0eebf500
apps/api/.git/objects/50/b8eeb91d007723151d993858f48c483dd32ab0
apps/api/.git/objects/51/41267a849fb95fdad20504952545091f78ca9c
apps/api/.git/objects/51/a1e84f247b3e58a2018c4e87554893cbc7150d
apps/api/.git/objects/51/c9a425ec1688b597def1dc604b67f0d53d5be1
apps/api/.git/objects/51/e282cc7eea568e2bf25f7f9256ae536cb1a149
apps/api/.git/objects/52/0b7a848b041653810065345e477df9801d3ad4
apps/api/.git/objects/52/6ab8f8913499e6610316cb74b2f935624872e5
apps/api/.git/objects/52/9b4b1ab1cb275a9f7265eac25a715d2d018108
apps/api/.git/objects/52/9fbedb388100209abc6cd2bfd6a456c4a0010c
apps/api/.git/objects/52/d7ebc739ca48915f90457f116ee67f76290b6b
apps/api/.git/objects/53/e08e6408c2403479b58e5718a05e415c9feda9
apps/api/.git/objects/53/eded4d9826ae566dda234ce62af027cac17f5b
apps/api/.git/objects/53/ffa246b0b164c1691bb2cc52456d243cc3b8d6
apps/api/.git/objects/54/79134a6f27fb07f826175288ac77934c5996f6
apps/api/.git/objects/54/ecc1350c0c6bb6d3d71b504189159854018d9d
apps/api/.git/objects/55/9a800b677458e4ee762e7ffa9eb15ae2bbdb53
apps/api/.git/objects/56/7d604e0fef95729312bfe95346b1484e1f63b8
apps/api/.git/objects/56/be8416890ceaa7e1c496dc32b84aa00bfe267a
apps/api/.git/objects/56/d5b417e59f0c72e460911c05350278b5e29d23
apps/api/.git/objects/56/fd7bb21a8a1b592360822bde3ade2e503da9a0
apps/api/.git/objects/59/c44cb4f8915f46178d574d718cdd4089b7253c
apps/api/.git/objects/5a/21c81f0fe3e3deb62a2852ed76278a3bdb82fe
apps/api/.git/objects/5a/4c5d4dcffb9d065501d7718e2d8829d720b21c
apps/api/.git/objects/5b/3093f29a3583857c08e7ff8871ee9d6f407021
apps/api/.git/objects/5b/8a58c8d6669beb440bfbe7149653a3fd2abafb
apps/api/.git/objects/5c/23b58edb0a5c5bdf225b670d97fc2c3c330ee0
apps/api/.git/objects/5c/2d4ab8e50ed532331f3eb5ebc2251262faa642
apps/api/.git/objects/5c/73ff28b5c64e77aeb56c95f0f7d0f75f9b8e57
apps/api/.git/objects/5d/768ce90eb8784c9195da3110268ed7e35327b9
apps/api/.git/objects/5e/51252ee541bc5616a20ce4254fb11e5286690b
apps/api/.git/objects/5e/f69a3c2d8b87f55b204411994744275bcb468a
apps/api/.git/objects/60/2291970e80cc373f97dfbabdffa52b172b9c42
apps/api/.git/objects/62/93a4e45b200ed5417bce8c4f9669fa3ca41e2b
apps/api/.git/objects/63/59a599481ab725fc92481a2b6b67ad019bc320
apps/api/.git/objects/63/be794c67108dc604550bb3db2d96a665223452
apps/api/.git/objects/64/0049e617a980520fa856bbca112a8ff729b1c9
apps/api/.git/objects/64/38477ec4777168cb1c2d512ac319578d9e0c2e
apps/api/.git/objects/64/b865b3a128778cd0ef346ae07bd609dd8780b3
apps/api/.git/objects/65/d476524a69d7f391dd8c2249d809532e8f080c
apps/api/.git/objects/67/46d96a9a38d75e4ab6c2f35a331ab2f076ff38
apps/api/.git/objects/68/209eba22080d381af7730ae7490c26dea7a62e
apps/api/.git/objects/68/494afce93a3aff16681d07ee2798cdf767b1bd
apps/api/.git/objects/68/5fb97500f55aabe91d9ac306bc6ebaf38eb7c1
apps/api/.git/objects/68/9e039ff33dc4092b9bc5905410d49d78cef290
apps/api/.git/objects/6a/101b6ac3096a0745e9e95c6eaae774c332efbc
apps/api/.git/objects/6a/3e77f3be9695e69e590f3443d8a6a2522f6897
apps/api/.git/objects/6a/59e4f64b5199e8d254c655251ad33df73c0653
apps/api/.git/objects/6a/d550c2434fe4f62a8f2e799cd6bd365ead8ad9
apps/api/.git/objects/6b/79202b95c5002be33e0093f4863500c831b76c
apps/api/.git/objects/6d/a87cf587e0975a123721a022878c02df6cb695
apps/api/.git/objects/6e/d3d68900e913b0836d742333d00bd79ff71148
apps/api/.git/objects/6f/ae4c591fc7b1ee13711983d0df22abcfa32a4d
apps/api/.git/objects/70/696dad904e92e8da05ec30eb58d334cf9e54ed
apps/api/.git/objects/71/092db04548bb2a4835f697ff6b0f656b557300
apps/api/.git/objects/71/21dfe298b5ac0db7a069516176b1b1c94b9d1c
apps/api/.git/objects/72/f49b05f1d9924802ec8a7b9538de0289f3f0dd
apps/api/.git/objects/73/750715368101aa9439d95512a2f19b6fee4d64
apps/api/.git/objects/74/d8ff9500a5438385cd9e3e349ef4cc324f8ee0
apps/api/.git/objects/76/23bee13cc19b86b0f722a0827093d4b66c017b
apps/api/.git/objects/76/5c5362b9356144b9271cb0fef95632f5d3bec9
apps/api/.git/objects/77/0325b64e2ab67795b1d4d2bd51905819c5b214
apps/api/.git/objects/77/4289395242c236f2d2bacb8dbb021bdf42e7e0
apps/api/.git/objects/77/64c52f5fd845b744025e7d2bad711b1039e2b8
apps/api/.git/objects/77/905f17d5bd48789dd90855cf7c07c245f39e13
apps/api/.git/objects/79/15d352b9697431bdc7cb8c562a621fef696473
apps/api/.git/objects/79/4f58dbf5509cc04020dfcd4e0397e7205f3d5e
apps/api/.git/objects/79/a2c8bf507f9b5e66cdca61d46d190ddc1f74f6
apps/api/.git/objects/7a/403501c5363d019460af19950ad3f3f54a0579
apps/api/.git/objects/7a/f6f9bbd7e2e2acd82a021e5cd4366d56a9a0d9
apps/api/.git/objects/7b/0bf3a12b5bfcb5b712b33f26530f895babf129
apps/api/.git/objects/7b/50b83eee3f4013b8a4e781d0d3e01e356b0cde
apps/api/.git/objects/7b/dad87d891f07ea055ffb64e8561f24e437385b
apps/api/.git/objects/7c/63d0e79cad11a78ff367e95e92e47019ab0bf1
apps/api/.git/objects/7c/9ced87db2d3688be66b54ec54610ae131a2164
apps/api/.git/objects/7c/e2f755cfa04c0e2f538c12e2a0f9bb518fc6ff
apps/api/.git/objects/7c/fe7992a4bc1dc495e2af313c6dd2e18a1a7622
apps/api/.git/objects/7d/382f5a68811d279bc47e7f64054cc5c3e73ec9
apps/api/.git/objects/7f/bf2243806531bd0893016847c936a5829d32b3
apps/api/.git/objects/80/7326dfbff7f1a8029f68119e0873405e79ed2d
apps/api/.git/objects/80/c1ee243a5805b17297c277cf61398ad787abed
apps/api/.git/objects/80/cd5d17cb1c88d8aa702077f7a791335b6ad9ca
apps/api/.git/objects/81/99edba0a9e4363f510743d6c7893c09afb1afa
apps/api/.git/objects/81/b1c82595ffd623a263909ace851f66cc75bf61
apps/api/.git/objects/82/9e3c3743026bcda1a35ce9c23781cde7e5ed43
apps/api/.git/objects/83/16c0e696904fb3d2ecf42545ec3fa6ca421f55
apps/api/.git/objects/83/460ab4e42e59b1f938ec40dc422ee51cfcf6b0
apps/api/.git/objects/83/85bcb1679502ea0aaebb6fd0c466dd21d5742e
apps/api/.git/objects/84/b21b85f0d2465fcfd4e190c35c04350e1a9ff2
apps/api/.git/objects/85/10ea35e34cd4a6a173730585e731f82255673f
apps/api/.git/objects/85/55ee5df773b719556e17ab8ac05650c693ee00
apps/api/.git/objects/85/7239ad49fdf8c4bf1ce5463484d808a427e762
apps/api/.git/objects/86/5fc7dfd7133bac12fc683ee0fc68df796c2b00
apps/api/.git/objects/87/81b17170bc01e2fe40b927dc2723ba38d96989
apps/api/.git/objects/88/b06ee918af5ef20a5391a0c73cf27499651567
apps/api/.git/objects/89/4d4009af0f3bd6497f9c4c7dd4ee8a8bfbd2b8
apps/api/.git/objects/89/8e159b2b53f5480f1e7162f1ea5fbd9fa1e068
apps/api/.git/objects/89/c2c1d89feae0d23e418747008954da11ab4ff7
apps/api/.git/objects/89/c3400132002085466c92e6fa6d50a77ef7f9f3
apps/api/.git/objects/8a/64a5983e473367e530c6dd7fdb836e1298ea01
apps/api/.git/objects/8b/3e5badcc9c11c60b88095afd9b17ba0e01f259
apps/api/.git/objects/8b/7fad96d6749c89c4ea6c5465bc5029caf3e170
apps/api/.git/objects/8c/3569eb3eafa4b76a47a115d0709a7a43f99961
apps/api/.git/objects/8c/59b13cc2ff58f5ad30e49c37f9a1df16838819
apps/api/.git/objects/8c/8aac8b0a2efda3748b4bdba8ed12cb0a91379f
apps/api/.git/objects/8d/07a58c82808f6fa05d6d0696bc7f2e810716e7
apps/api/.git/objects/8d/3473f9552f4d51f568cb0fc807fad854ebe810
apps/api/.git/objects/8d/7466faa8ac524b2baa079fc49def2f60ca9c6b
apps/api/.git/objects/8d/852ac4ba7be21ddf862e47dca29a9a129102eb
apps/api/.git/objects/8d/da929e4d76172e0707bd4fcbe97248591c59ab
apps/api/.git/objects/8d/ff97407fe37a064e4e3e5f4057727b22b98078
apps/api/.git/objects/8e/cf12e683c590ff55b516209737d6ea2d0eafba
apps/api/.git/objects/8e/dc1efb30b846268e5668eafc5f4835ae6bcd4a
apps/api/.git/objects/91/1775d66b34408f272125eb26462bf510ab07ac
apps/api/.git/objects/91/bfcb86dc9f95cbc074008dfd883c2060264bcd
apps/api/.git/objects/91/ec93db31ab9115ac963ccc3ef572af4acc3521
apps/api/.git/objects/92/4b7cd997fc8ab3ebb4a9fd6cdc9d47f3d6475e
apps/api/.git/objects/92/7dd95bbf7d7f089ccf06724c1d7ea922933754
apps/api/.git/objects/92/993b04f000f179ab1234dc532afd38e6c9b458
apps/api/.git/objects/92/9d13ab0f637e49d052f317a521bed7bea0a2d8
apps/api/.git/objects/93/44b8e408ed0e67308de13855604bd1c48bc3ae
apps/api/.git/objects/93/dea831ca362d5d32aa453de0184998cc3a842c
apps/api/.git/objects/94/11492bfd9cff51c72980d12e6e46b93188ec70
apps/api/.git/objects/95/0cb4351587ec6e20c2d88b571aaecac7fef2a9
apps/api/.git/objects/95/e360c4ce8e12007f2e0c9552300a97c40ed424
apps/api/.git/objects/97/8adc20343aa968346f05eda2bff4cca64e8b60
apps/api/.git/objects/98/3e3eef50f52296d54f1d72222aaf3a33fd5a84
apps/api/.git/objects/99/86d6893f49943095050eefd9d4fbeda69d2941
apps/api/.git/objects/99/f3abdd0b6615fc5ce9044ca75f7cf23991d292
apps/api/.git/objects/9a/96756521eb6830c5d69b491b705b1c57700111
apps/api/.git/objects/9b/d2edfbde3e13f4444832a171726bf4229a67cb
apps/api/.git/objects/9b/fc3de1837d0024beb25ed7679fc79eea800fd7
apps/api/.git/objects/9c/c76c05bea7337655505a6e6f305e450c24aab7
apps/api/.git/objects/9d/423ef70595d7882864be7792757f5ba8ab7f8c
apps/api/.git/objects/9d/8acb166770f886b6e24cd935f7d6b393ef1f41
apps/api/.git/objects/9f/1a7eee075a6c5f4ec9f7d63e76d7a17a684ba9
apps/api/.git/objects/9f/33ea5916f13ac46603d4caf632004d3dc47217
apps/api/.git/objects/9f/598bb415e8dae0ec5d6395490a8182d0748c6a
apps/api/.git/objects/a0/fb56b222f992f96e25ca37c5c6ce0db3d22aa4
apps/api/.git/objects/a1/65b225add864301df88c41b75e38304264d258
apps/api/.git/objects/a1/c95cac68977903295ba227c704357320876452
apps/api/.git/objects/a1/db39b0d6712a7985486bf30688f62baf1e9277
apps/api/.git/objects/a2/4ef075eb6df8a1ceacf45bcca6195cda9ffd8b
apps/api/.git/objects/a3/011162898ae32d1465083232a5a35c53289eef
apps/api/.git/objects/a4/2d70f1092b04cf3f8701256508440655ad9e02
apps/api/.git/objects/a5/2a8ed575d5461f15a0339aa9340d50687ac775
apps/api/.git/objects/a5/d55c0216ae7939b8aeffd0f26cb08bacee7b1b
apps/api/.git/objects/a7/62b4f87268798ae072c7c4b234e9877a75a724
apps/api/.git/objects/a9/002005825b4393929beb51fa9b71caee1cc050
apps/api/.git/objects/a9/c0fdb7806701b9b5565636b32a78d5a305fcf2
apps/api/.git/objects/aa/02e63f75e33d5f5991b50e40c241cde025b07a
apps/api/.git/objects/aa/1529c1680f1701c18fbf81c4275f97faf710d1
apps/api/.git/objects/aa/382b94ec6b3fa4862c614a86d1276441c740cf
apps/api/.git/objects/aa/87e8c82a7e46c2ff10db0e2c93ecba99c412e5
apps/api/.git/objects/aa/8e9128fe22fd8d0ae07f4b4033aa35a0d3767f
apps/api/.git/objects/aa/9a698b4c4f7d723dfce248b8ce2dd16bb9a15b
apps/api/.git/objects/ab/90fb8e7f5d6fd4b4a8036491f1f27ec91272b0
apps/api/.git/objects/ab/9b533c54472531ab41148af8378a5724d88e52
apps/api/.git/objects/ac/82fa92dc19f57f382ae820a226889336d6fa56
apps/api/.git/objects/ad/2394ef51d71dbfeb700af1a534585c4771d9c0
apps/api/.git/objects/ad/9d27911887521f7733a4bd01e4d7ea44d77bf3
apps/api/.git/objects/ad/a37a11ee61613e0b637d5d8548fe296e40189a
apps/api/.git/objects/ad/b231f4a263dbccd806d9f9ef5bd3849c2f166d
apps/api/.git/objects/ae/41077e4a61935f1f7760b0fc8a638884612f68
apps/api/.git/objects/ae/c524a280f0b352cde91dd201806831330878c5
apps/api/.git/objects/af/486c9f82ef2284c460f6603a9790e475c5385f
apps/api/.git/objects/af/749aeffab4fc220f5ff73f4bbe00ca70065877
apps/api/.git/objects/af/860fc0bd7ba18d38a5578cdeb297089d08cb3d
apps/api/.git/objects/b1/5eadc1b49600be3f1fad51cb1597e194e796aa
apps/api/.git/objects/b2/e8680da8122e5f9df07335d3d18d164c85f60d
apps/api/.git/objects/b2/fc63a60540325ee99570f48ec6ae19be1236ae
apps/api/.git/objects/b3/020a05075f1c721a56438d208995b2df2ab2bf
apps/api/.git/objects/b3/fce654a1b1386ec8e3e7ac744f9a53d82e1caa
apps/api/.git/objects/b5/51004029a1f7c1fde78d4d2254cf907bb8bd6e
apps/api/.git/objects/b5/c045ced8bbc12e7722265881efef7bed298702
apps/api/.git/objects/b5/db0bc535de9a9eef37558c23b979c979401112
apps/api/.git/objects/b5/ed397bc9d15f7ab4057724808068e26f1a78ed
apps/api/.git/objects/b5/f8f4920fc40c5ee26b7677bf9cb2fae0a1b257
apps/api/.git/objects/b6/1816dd0b72dc75230948da5c92c5a600eed64f
apps/api/.git/objects/b6/3a758abd3b50a6fd9d6edb986d2e8998037769
apps/api/.git/objects/b6/bd745d6b6df8102e143de336d028799c3d40b1
apps/api/.git/objects/b6/d63adf1d1d9236ba556c810379bd99efc50de3
apps/api/.git/objects/b7/a60759a4227a9a0aaae8d0975985b7b3c5a953
apps/api/.git/objects/b8/00e5146f2b1c8e9384789d9b2185b7900e5fc3
apps/api/.git/objects/b8/2ecd54903072bc12e9dc28a611d66594594f15
apps/api/.git/objects/b9/17e650dd8e1a8dc15f2b08d6a2fd2ea3ba908a
apps/api/.git/objects/b9/1fe5f937fbf321c4ff9cf0bc7caeed9419acff
apps/api/.git/objects/b9/b46416fde05a14adebabd5020f2b86c220be86
apps/api/.git/objects/ba/7c3ade1e46e1dcfe332fc62148f8b6beea7023
apps/api/.git/objects/bc/198c9eb7eabfde0735505d2bebcebe87523054
apps/api/.git/objects/bc/6f29319b5f0c2aa6098891004f3d581ce1ea2c
apps/api/.git/objects/bc/d18a195067d39df886d6449e16acae5e64596a
apps/api/.git/objects/bc/f4d017abb33785fecb94ad88c0dd906b066b1f
apps/api/.git/objects/bd/0739bbb3d155e1622cab9b461e444e538c48ac
apps/api/.git/objects/bd/79ea31e7e260d1d6e0908a9c23022d61289b50
apps/api/.git/objects/bd/a8a76bfe7d15b33dd4ab9cf9c553b476382069
apps/api/.git/objects/be/3c92812b8898ef5c761f11cde8433888980c75
apps/api/.git/objects/be/7424b283d4ef49dff536fae985c00726e2e0cb
apps/api/.git/objects/bf/7239ad18adfb3aa6709a0d4e359ca49221fb7d
apps/api/.git/objects/bf/be7b06a43d8fc604946675ca13c4226def7e77
apps/api/.git/objects/c0/9dc7c032ec35ecf5d40896ea0a202d5b295d92
apps/api/.git/objects/c0/b06a9a3482daa94819e4d2600dc8ffde0eb3a2
apps/api/.git/objects/c1/dcc5d1c112691d798da38a177f8f51fabc6094
apps/api/.git/objects/c2/11f80f378b1b09ff2a7d967f4d19bf87660c6a
apps/api/.git/objects/c2/129aa2945e5331f4368765c0cf7f2b24d4e446
apps/api/.git/objects/c2/4d4aa695f7d8c80c0d91dc15da715de2b2de43
apps/api/.git/objects/c2/7e6bab969e40040dc85d621943937a59850c55
apps/api/.git/objects/c2/a69e96a5c197f67c64a8b59906b3292802f1aa
apps/api/.git/objects/c2/cf4f37a3a84d8669e3f7500018fc877fb88df5
apps/api/.git/objects/c3/188cf73d59ec5cdc10dea9640e35812287f78a
apps/api/.git/objects/c4/108cd3724841be9db3f39f24daa01fbb955718
apps/api/.git/objects/c5/0fa537c5a452e4e0bd394e070d0084cc5f2b23
apps/api/.git/objects/c5/b4ff6bb4bce0f394e19ac1bc8a58c4cc39929a
apps/api/.git/objects/c6/205e0ec9a1224dc86069379115ff660e27db22
apps/api/.git/objects/c6/286d1e45e1ce0628d8d77eb5f1ed09fdafb577
apps/api/.git/objects/c6/8e97fee7542a4016cc76211b158f7d7a545977
apps/api/.git/objects/c6/a84246183de55c4d102aa795bf8588b3ae1544
apps/api/.git/objects/c8/2e183f744db86d2786c5f1c485837643bb7408
apps/api/.git/objects/c8/2e3b0fd96cb19323ac1ab2be025abbe3af476b
apps/api/.git/objects/c8/7059f59067eae723df12502220a3038309264d
apps/api/.git/objects/c8/99aabb71ecaa2a64ee2d343dbd1b8cf459d5b3
apps/api/.git/objects/c8/eb9920121a6650bcadc86288c12ef08fe496e2
apps/api/.git/objects/c8/fdad4fbdb4b728b34270007fafbf10099a4a89
apps/api/.git/objects/c9/5440cbe808fe87bda94874dae37ba2f5008ae6
apps/api/.git/objects/c9/6843c077ff5493c2a516b1e9ef064f06d71d02
apps/api/.git/objects/c9/ef5f0c3b7146abb11bd62cc7421f8b08b448a2
apps/api/.git/objects/ca/35a2c4aa9b1f837797f401b58e85dcf6ea0d19
apps/api/.git/objects/cb/5c1b56945599ce641c39548e84266e1e14a671
apps/api/.git/objects/cc/18c2c35e4ac26efb11b437f285a860301cd6f1
apps/api/.git/objects/cc/ebd514158448b73e5252e6118bc4a4baa60f99
apps/api/.git/objects/cd/4acfb4da776f9d97ddf40585d4c6cd015b6c79
apps/api/.git/objects/cd/5f342af2771dd4df22d6537b1d9bed66034c4a
apps/api/.git/objects/cd/af8a8d5208b720fc5e4b5a749e971350bd9c56
apps/api/.git/objects/cd/c2ad7056e5671986becc1e2f9098fd8c0202e5
apps/api/.git/objects/ce/e4f5c18c610304201eb32cac8df5b0f7e71434
apps/api/.git/objects/cf/25d44415fca7403bef687730723d548a26c198
apps/api/.git/objects/d0/005c5ded1afbe6a4b915b8e7814063483bc6ee
apps/api/.git/objects/d0/435fb51304322ea7d470c3e28e104bea128ad9
apps/api/.git/objects/d0/c93607735aefa50a048c2c20d0255429d5f577
apps/api/.git/objects/d0/e721495217b59ca8bbe6a4a6ca4b61462527f3
apps/api/.git/objects/d1/416e610c05adf5dd0144813f45f43c3e15e7e8
apps/api/.git/objects/d1/723e43787e65b3915e188f7680c03c411cd428
apps/api/.git/objects/d1/b2350b227648b6a3315947b881192d85e45dfd
apps/api/.git/objects/d2/3249b6fb6407c73c06e0dcd7c86df8e36e377e
apps/api/.git/objects/d2/ae1f523471b3ac38ef1998891d0106a213fe5a
apps/api/.git/objects/d4/130e10c836fad1364a5d4defc90845d92edbf6
apps/api/.git/objects/d4/4b681054edab5728b68375dd6339d2a0f580a9
apps/api/.git/objects/d4/ea3cc371c2fdfe0d795ef71beeb69ac9f403e2
apps/api/.git/objects/d4/fe90224e6f4111bdc385430f6a8a86615df20c
apps/api/.git/objects/d5/3b6304a648ef553e27053ecb4f7f6a28042868
apps/api/.git/objects/d5/e72468401c572285b1c4e37aa5963609b92329
apps/api/.git/objects/d6/2f885d87c5fee6f4027ed3bb4792663f479838
apps/api/.git/objects/d6/6dba976471e02b02c75b4986ec030594807b85
apps/api/.git/objects/d7/d351efb35fac17b5cdd5a7f0e03ca1392ff16d
apps/api/.git/objects/d8/0bc6e9b8632745bfe5cead415b50fda50c6ede
apps/api/.git/objects/d8/c6afc83255101e2980f79ed5d64b0ec5f562ed
apps/api/.git/objects/d8/db710508a699c8ccbfb299aae36cebcbb05b62
apps/api/.git/objects/d9/2b5fb2f1adafd3701e9c31556dac6624b3b63b
apps/api/.git/objects/da/951656822d10fa5016f2d3f409e892ad8424ea
apps/api/.git/objects/db/57c3157cc363b01af16d2d575582ef99044b8b
apps/api/.git/objects/db/5aa31dd22db541c903713871fa0c429cc1f982
apps/api/.git/objects/dc/a9611508240083118ea11ebd407e3357e0900d
apps/api/.git/objects/dc/e70155eed1e30c7d83ce08de132abf1f8c17d8
apps/api/.git/objects/dd/75505b2de63b9d22b889997e0c644eea0f3504
apps/api/.git/objects/dd/9887258d057c8b75bc2ccc4be0b144ec215c23
apps/api/.git/objects/dd/f9a30138ffa9d527ed5fb46ca9e259b054d8de
apps/api/.git/objects/de/7168a070aec6b14325426e531f9121349ecb75
apps/api/.git/objects/de/c109f8a5e4160e853af144e40974a299cfa71d
apps/api/.git/objects/df/44c967f840f0298f56d45e1bd2912dd54c14e6
apps/api/.git/objects/df/9f2a4e8c7b4d98049c8aeef03d89d334aa5812
apps/api/.git/objects/e0/555a6aadcd0fb7a7132873f0d63db55080520d
apps/api/.git/objects/e0/8a6691d52f0ffeb810e782a33ae09422abe4ec
apps/api/.git/objects/e2/140a1c0f514be1cf27d6ee2fec4b06022ed1e6
apps/api/.git/objects/e2/214ec009a0e16fc32b5af8c7a90fbcebdf314f
apps/api/.git/objects/e2/52f5796a3a07fbff16f9d874be07e0c143e2e0
apps/api/.git/objects/e2/77ad353ad8e70d80307f8cc4ea197b1f3ef800
apps/api/.git/objects/e2/818adc599ff6dddeef358d0d31a23c9db0c017
apps/api/.git/objects/e3/a23d42834404fc370d6a31633ed946e67073eb
apps/api/.git/objects/e4/0d71b421f88b7b21991ef454bc596ec8b631fe
apps/api/.git/objects/e4/146f25ceadc227860c1293e7484f21a42d212d
apps/api/.git/objects/e4/4b2b31983cde3d6d887c8596b51e6cc590499d
apps/api/.git/objects/e6/030303cef8b5502643d5ecf607d7cc4aacfcb5
apps/api/.git/objects/e6/03ec248063dd10df588ccd54fcaa61145d6fc6
apps/api/.git/objects/e8/323a6baa306d4df745e5cc45290c3b72b7ef30
apps/api/.git/objects/e8/5939af42a6329d353d184d7b248fd642bd6765
apps/api/.git/objects/e9/c5ecfbac987447979747436f0a64c64933d0b1
apps/api/.git/objects/e9/f5d01a6893b3bf3a1f5145342e794841e1e17c
apps/api/.git/objects/eb/43b4d960a449c776a6783274ad5b2f69118a38
apps/api/.git/objects/ec/7118d35a332e736523b54cb8a24f9ecf9bf7ea
apps/api/.git/objects/ec/912c082e084721aa8432fa308c37b74236e11f
apps/api/.git/objects/ee/d41204e978bb1bd03bdf8333e57fd6a11dad18
apps/api/.git/objects/ef/1dd8338e1b0991134aaee222060e7dcdd9b27d
apps/api/.git/objects/ef/e322f058dac32936e496e15bdc8917c85a318f
apps/api/.git/objects/f0/975ba8347360f4b223c0221f49cdaee25ddae4
apps/api/.git/objects/f1/c2166c2dc1ac3b643a92d4bc19fde44767485d
apps/api/.git/objects/f2/37951ac3606045c2b6335a6da7a1044c3e677d
apps/api/.git/objects/f2/5d989e21e50496c13884c19e4bf063a500bc1f
apps/api/.git/objects/f2/a7b96ff5a1e860406e4b84048c588e882a46d9
apps/api/.git/objects/f2/fe799604273157dffef71b66f527246e44f784
apps/api/.git/objects/f5/cd780de6cbc266c4a2aecc515ecff43cb24186
apps/api/.git/objects/f6/55f78eb471ebef3cfb532316453a2759deab38
apps/api/.git/objects/f7/8a17b4b0c2c360b705efd749fa9ad20758cabf
apps/api/.git/objects/f7/ed7e4c91f67398ab574647deabfa523b6ac533
apps/api/.git/objects/f8/3e9093a7434406c918885043d6cc453bd7aacf
apps/api/.git/objects/f8/9e8d83b438b5568ca64cd152813c4401dc5e38
apps/api/.git/objects/f9/53cb4df3a6d4d4a4929b9131abaf399db2f609
apps/api/.git/objects/f9/5d79aa9ad325203af5101bccc0ba0b7c45c212
apps/api/.git/objects/fa/40f419775089df02764aa11410a4e3bb3162fd
apps/api/.git/objects/fb/4b8c47382941367850ef2af01bfa8edb9dc190
apps/api/.git/objects/fb/8293437c7a2bb305fb727296e821912eed61f5
apps/api/.git/objects/fb/956ad27adb87401fe3259e0c40a4e1af5cadf1
apps/api/.git/objects/fc/0ea2a08a799bebac09ce714d97d63d200fe41f
apps/api/.git/objects/fc/5c94947ccb28207187002378dee18527676134
apps/api/.git/objects/fd/73cc9576f55683822be11fed0e53d15ffb40f9
apps/api/.git/objects/fe/41e6c27e11ea0b5c66f9f0c53e531239df42c7
apps/api/.git/objects/ff/33b2c4744512699b48de578fdebc6d0330afa8
apps/api/.git/objects/ff/9f4bac936d51c9e5056199e4e415eb9da6d438
apps/api/.git/objects/pack/pack-ae6e4b36a09fe83b1d7be2800148e373b695141f.idx
apps/api/.git/objects/pack/pack-ae6e4b36a09fe83b1d7be2800148e373b695141f.pack
apps/api/.git/objects/pack/pack-ae6e4b36a09fe83b1d7be2800148e373b695141f.rev
apps/api/.git/ORIG_HEAD
apps/api/.git/packed-refs
apps/api/.git/refs/heads/main
apps/api/.git/refs/remotes/origin/HEAD
apps/api/.git/refs/remotes/origin/main
apps/api/.gitignore
apps/api/docs/flask-clean-architecture.md
apps/api/README.md
apps/api/repomix-output.xml
apps/api/scripts/check_imports.py
apps/api/scripts/run_postgres.sh
apps/api/scripts/seed_users.py
apps/api/scripts/test_login.js
apps/api/scripts/test_login.py
apps/api/seed_all_data.py
apps/api/src/api/controllers/academic_year_controller.py
apps/api/src/api/controllers/ai_controller.py
apps/api/src/api/controllers/assessment_clo_controller.py
apps/api/src/api/controllers/assessment_component_controller.py
apps/api/src/api/controllers/assessment_scheme_controller.py
apps/api/src/api/controllers/auth_controller.py
apps/api/src/api/controllers/clo_plo_mapping_controller.py
apps/api/src/api/controllers/dashboard_controller.py
apps/api/src/api/controllers/department_controller.py
apps/api/src/api/controllers/faculty_controller.py
apps/api/src/api/controllers/file_controller.py
apps/api/src/api/controllers/notification_controller.py
apps/api/src/api/controllers/program_controller.py
apps/api/src/api/controllers/program_outcome_controller.py
apps/api/src/api/controllers/role_controller.py
apps/api/src/api/controllers/rubric_controller.py
apps/api/src/api/controllers/student_controller.py
apps/api/src/api/controllers/subject_controller.py
apps/api/src/api/controllers/subject_relationship_controller.py
apps/api/src/api/controllers/syllabus_clo_controller.py
apps/api/src/api/controllers/syllabus_comment_controller.py
apps/api/src/api/controllers/syllabus_controller.py
apps/api/src/api/controllers/syllabus_material_controller.py
apps/api/src/api/controllers/system_setting_controller.py
apps/api/src/api/controllers/teaching_plan_controller.py
apps/api/src/api/controllers/user_controller.py
apps/api/src/api/middleware.py
apps/api/src/api/requests.py
apps/api/src/api/responses.py
apps/api/src/api/routes.py
apps/api/src/api/schemas/...  # Marshmallow schemas
apps/api/src/api/schemas/academic_year_schema.py
apps/api/src/api/schemas/assessment_clo_mapping_schema.py
apps/api/src/api/schemas/assessment_component_schema.py
apps/api/src/api/schemas/assessment_scheme_schema.py
apps/api/src/api/schemas/base_schema.py
apps/api/src/api/schemas/clo_plo_mapping_schema.py
apps/api/src/api/schemas/department_schema.py
apps/api/src/api/schemas/faculty_schema.py
apps/api/src/api/schemas/file_schema.py
apps/api/src/api/schemas/notification_schema.py
apps/api/src/api/schemas/program_outcome_schema.py
apps/api/src/api/schemas/program_schema.py
apps/api/src/api/schemas/role_schema.py
apps/api/src/api/schemas/rubric_schema.py
apps/api/src/api/schemas/student_schema.py
apps/api/src/api/schemas/subject_relationship_schema.py
apps/api/src/api/schemas/subject_schema.py
apps/api/src/api/schemas/syllabus_clo_schema.py
apps/api/src/api/schemas/syllabus_comment_schema.py
apps/api/src/api/schemas/syllabus_detail_schema.py
apps/api/src/api/schemas/syllabus_material_schema.py
apps/api/src/api/schemas/syllabus_schema.py
apps/api/src/api/schemas/system_setting_schema.py
apps/api/src/api/schemas/teaching_plan_schema.py
apps/api/src/api/schemas/user_schema.py
apps/api/src/api/schemas/user.py
apps/api/src/api/schemas/workflow_log_schema.py
apps/api/src/api/swagger.py
apps/api/src/app_logging.py
apps/api/src/app.py
apps/api/src/config.py
apps/api/src/cors.py
apps/api/src/create_app.py
apps/api/src/dependency_container.py
apps/api/src/domain/constants.py
apps/api/src/domain/exceptions.py
apps/api/src/domain/models/...  # Business logic models
apps/api/src/domain/models/user.py
apps/api/src/error_handler.py
apps/api/src/infrastructure/databases/__init__.py
apps/api/src/infrastructure/databases/base.py
apps/api/src/infrastructure/databases/mssql.py
apps/api/src/infrastructure/databases/mysql.py
apps/api/src/infrastructure/models/__init__.py
apps/api/src/infrastructure/models/academic_year_model.py
apps/api/src/infrastructure/models/ai_auditlog_model.py
apps/api/src/infrastructure/models/assessment_clo_model.py
apps/api/src/infrastructure/models/assessment_component_model.py
apps/api/src/infrastructure/models/assessment_scheme_model.py
apps/api/src/infrastructure/models/clo_plo_mapping_model.py
apps/api/src/infrastructure/models/department_model.py
apps/api/src/infrastructure/models/faculty_model.py
apps/api/src/infrastructure/models/file_model.py
apps/api/src/infrastructure/models/notification_model.py
apps/api/src/infrastructure/models/notification_template_model.py
apps/api/src/infrastructure/models/program_model.py
apps/api/src/infrastructure/models/program_outcome_model.py
apps/api/src/infrastructure/models/role_model.py
apps/api/src/infrastructure/models/rubric_model.py
apps/api/src/infrastructure/models/student_report_model.py
apps/api/src/infrastructure/models/student_subscription_model.py
apps/api/src/infrastructure/models/subject_model.py
apps/api/src/infrastructure/models/subject_relationship_model.py
apps/api/src/infrastructure/models/syllabus_clo_model.py
apps/api/src/infrastructure/models/syllabus_comment_model.py
apps/api/src/infrastructure/models/syllabus_current_workflow.py
apps/api/src/infrastructure/models/syllabus_material_model.py
apps/api/src/infrastructure/models/syllabus_model.py
apps/api/src/infrastructure/models/system_auditlog_model.py
apps/api/src/infrastructure/models/system_setting_model.py
apps/api/src/infrastructure/models/teaching_plan_model.py
apps/api/src/infrastructure/models/user_model.py
apps/api/src/infrastructure/models/user_role_model.py
apps/api/src/infrastructure/models/workflow_log_model.py
apps/api/src/infrastructure/models/workflow_state_model.py
apps/api/src/infrastructure/models/workflow_transition_model.py
apps/api/src/infrastructure/repositories/academic_year_repository.py
apps/api/src/infrastructure/repositories/ai_auditlog_repository.py
apps/api/src/infrastructure/repositories/assessment_clo_repository.py
apps/api/src/infrastructure/repositories/assessment_component_repository.py
apps/api/src/infrastructure/repositories/assessment_scheme_repository.py
apps/api/src/infrastructure/repositories/clo_plo_mapping_repository.py
apps/api/src/infrastructure/repositories/department_repository.py
apps/api/src/infrastructure/repositories/faculty_repository.py
apps/api/src/infrastructure/repositories/file_repository.py
apps/api/src/infrastructure/repositories/notification_repository.py
apps/api/src/infrastructure/repositories/program_outcome_repository.py
apps/api/src/infrastructure/repositories/program_repository.py
apps/api/src/infrastructure/repositories/role_repository.py
apps/api/src/infrastructure/repositories/rubric_repository.py
apps/api/src/infrastructure/repositories/student_report_repository.py
apps/api/src/infrastructure/repositories/student_subscription_repository.py
apps/api/src/infrastructure/repositories/subject_relationship_repository.py
apps/api/src/infrastructure/repositories/subject_repository.py
apps/api/src/infrastructure/repositories/syllabus_clo_repository.py
apps/api/src/infrastructure/repositories/syllabus_comment_repository.py
apps/api/src/infrastructure/repositories/syllabus_material_repository.py
apps/api/src/infrastructure/repositories/syllabus_repository.py
apps/api/src/infrastructure/repositories/system_setting_repository.py
apps/api/src/infrastructure/repositories/teaching_plan_repository.py
apps/api/src/infrastructure/repositories/user_repository.py
apps/api/src/infrastructure/repositories/workflow_log_repository.py
apps/api/src/infrastructure/services/...  # Services that use third party libraries or services (e.g. email service)
apps/api/src/migrations
apps/api/src/README.md
apps/api/src/requirements.txt
apps/api/src/scripts/import_check.py
apps/api/src/scripts/run_postgres.sh
apps/api/src/scripts/seed_users.py
apps/api/src/SDM-workspace.code-workspace
apps/api/src/services/...  # Services for interacting with the domain (business logic)
apps/api/src/services/academic_year_service.py
apps/api/src/services/ai_service.py
apps/api/src/services/assessment_clo_service.py
apps/api/src/services/assessment_component_service.py
apps/api/src/services/assessment_scheme_service.py
apps/api/src/services/clo_plo_mapping_service.py
apps/api/src/services/department_service.py
apps/api/src/services/faculty_service.py
apps/api/src/services/file_service.py
apps/api/src/services/notification_service.py
apps/api/src/services/program_outcome_service.py
apps/api/src/services/program_service.py
apps/api/src/services/role_service.py
apps/api/src/services/rubric_service.py
apps/api/src/services/student_service.py
apps/api/src/services/subject_relationship_service.py
apps/api/src/services/subject_service.py
apps/api/src/services/syllabus_clo_service.py
apps/api/src/services/syllabus_comment_service.py
apps/api/src/services/syllabus_material_service.py
apps/api/src/services/syllabus_service.py
apps/api/src/services/system_setting_service.py
apps/api/src/services/teaching_plan_service.py
apps/api/src/services/user_service.py
apps/api/src/swagger_config.json
apps/api/src/tests/test_file_service.py
apps/api/src/tests/test_program_outcome_service.py
apps/api/src/tests/test_smoke_imports.py
apps/api/src/tests/test_syllabus_service.py
apps/api/tests/e2e_test_flow.py
apps/web/app/(auth)/login/page.tsx
apps/web/app/(main)/admin/logs/page.tsx
apps/web/app/(main)/admin/settings/page.tsx
apps/web/app/(main)/admin/users/page.tsx
apps/web/app/(main)/layout.tsx
apps/web/app/(main)/page.tsx
apps/web/app/(main)/profile/page.tsx
apps/web/app/(main)/reviews/page.tsx
apps/web/app/(main)/syllabus/[id]/edit/page.tsx
apps/web/app/(main)/syllabus/[id]/page.tsx
apps/web/app/(main)/syllabus/compare/page.tsx
apps/web/app/(main)/syllabus/create/page.tsx
apps/web/app/(public)/layout.tsx
apps/web/app/(public)/portal/[id]/page.tsx
apps/web/app/(public)/portal/page.tsx
apps/web/app/favicon.ico
apps/web/app/globals.css
apps/web/app/layout.tsx
apps/web/components.json
apps/web/components/DashboardCharts.tsx
apps/web/components/Header.tsx
apps/web/components/Sidebar.tsx
apps/web/components/syllabus-form/MaterialsTab.tsx
apps/web/components/SyllabusDeleteButton.tsx
apps/web/components/SyllabusDetailView.tsx
apps/web/components/SyllabusEditForm.tsx
apps/web/components/Types.ts
apps/web/components/ui/alert-dialog.tsx
apps/web/components/ui/avatar.tsx
apps/web/components/ui/badge.tsx
apps/web/components/ui/button.tsx
apps/web/components/ui/card.tsx
apps/web/components/ui/dialog.tsx
apps/web/components/ui/input.tsx
apps/web/components/ui/popover.tsx
apps/web/components/ui/sheet.tsx
apps/web/components/ui/table.tsx
apps/web/components/ui/tabs.tsx
apps/web/components/ui/textarea.tsx
apps/web/Dockerfile
apps/web/eslint.config.mjs
apps/web/lib/apiClient.ts
apps/web/lib/axios.ts
apps/web/lib/utils.ts
apps/web/next-env.d.ts
apps/web/next.config.ts
apps/web/package.json
apps/web/postcss.config.mjs
apps/web/public/file.svg
apps/web/public/globe.svg
apps/web/public/next.svg
apps/web/public/vercel.svg
apps/web/public/window.svg
apps/web/README.md
apps/web/scripts/test_api.js
apps/web/tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="apps/api/.git/COMMIT_EDITMSG">
feat(api): enhance controllers with detailed API documentation and improve schema handling
</file>

<file path="apps/api/.git/config">
[core]
	repositoryformatversion = 0
	filemode = false
	bare = false
	logallrefupdates = true
	symlinks = false
	ignorecase = true
[remote "origin"]
	url = https://github.com/vux311/Backend_SMD.git
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch "main"]
	remote = origin
	merge = refs/heads/main
	vscode-merge-base = origin/main
</file>

<file path="apps/api/.git/description">
Unnamed repository; edit this file 'description' to name the repository.
</file>

<file path="apps/api/.git/FETCH_HEAD">
640049e617a980520fa856bbca112a8ff729b1c9		branch 'main' of https://github.com/vux311/Backend_SMD
</file>

<file path="apps/api/.git/HEAD">
ref: refs/heads/main
</file>

<file path="apps/api/.git/hooks/applypatch-msg.sample">
#!/bin/sh
#
# An example hook script to check the commit log message taken by
# applypatch from an e-mail message.
#
# The hook should exit with non-zero status after issuing an
# appropriate message if it wants to stop the commit.  The hook is
# allowed to edit the commit message file.
#
# To enable this hook, rename this file to "applypatch-msg".

. git-sh-setup
commitmsg="$(git rev-parse --git-path hooks/commit-msg)"
test -x "$commitmsg" && exec "$commitmsg" ${1+"$@"}
:
</file>

<file path="apps/api/.git/hooks/commit-msg.sample">
#!/bin/sh
#
# An example hook script to check the commit log message.
# Called by "git commit" with one argument, the name of the file
# that has the commit message.  The hook should exit with non-zero
# status after issuing an appropriate message if it wants to stop the
# commit.  The hook is allowed to edit the commit message file.
#
# To enable this hook, rename this file to "commit-msg".

# Uncomment the below to add a Signed-off-by line to the message.
# Doing this in a hook is a bad idea in general, but the prepare-commit-msg
# hook is more suited to it.
#
# SOB=$(git var GIT_AUTHOR_IDENT | sed -n 's/^\(.*>\).*$/Signed-off-by: \1/p')
# grep -qs "^$SOB" "$1" || echo "$SOB" >> "$1"

# This example catches duplicate Signed-off-by lines.

test "" = "$(grep '^Signed-off-by: ' "$1" |
	 sort | uniq -c | sed -e '/^[ 	]*1[ 	]/d')" || {
	echo >&2 Duplicate Signed-off-by lines.
	exit 1
}
</file>

<file path="apps/api/.git/hooks/fsmonitor-watchman.sample">
#!/usr/bin/perl

use strict;
use warnings;
use IPC::Open2;

# An example hook script to integrate Watchman
# (https://facebook.github.io/watchman/) with git to speed up detecting
# new and modified files.
#
# The hook is passed a version (currently 2) and last update token
# formatted as a string and outputs to stdout a new update token and
# all files that have been modified since the update token. Paths must
# be relative to the root of the working tree and separated by a single NUL.
#
# To enable this hook, rename this file to "query-watchman" and set
# 'git config core.fsmonitor .git/hooks/query-watchman'
#
my ($version, $last_update_token) = @ARGV;

# Uncomment for debugging
# print STDERR "$0 $version $last_update_token\n";

# Check the hook interface version
if ($version ne 2) {
	die "Unsupported query-fsmonitor hook version '$version'.\n" .
	    "Falling back to scanning...\n";
}

my $git_work_tree = get_working_dir();

my $retry = 1;

my $json_pkg;
eval {
	require JSON::XS;
	$json_pkg = "JSON::XS";
	1;
} or do {
	require JSON::PP;
	$json_pkg = "JSON::PP";
};

launch_watchman();

sub launch_watchman {
	my $o = watchman_query();
	if (is_work_tree_watched($o)) {
		output_result($o->{clock}, @{$o->{files}});
	}
}

sub output_result {
	my ($clockid, @files) = @_;

	# Uncomment for debugging watchman output
	# open (my $fh, ">", ".git/watchman-output.out");
	# binmode $fh, ":utf8";
	# print $fh "$clockid\n@files\n";
	# close $fh;

	binmode STDOUT, ":utf8";
	print $clockid;
	print "\0";
	local $, = "\0";
	print @files;
}

sub watchman_clock {
	my $response = qx/watchman clock "$git_work_tree"/;
	die "Failed to get clock id on '$git_work_tree'.\n" .
		"Falling back to scanning...\n" if $? != 0;

	return $json_pkg->new->utf8->decode($response);
}

sub watchman_query {
	my $pid = open2(\*CHLD_OUT, \*CHLD_IN, 'watchman -j --no-pretty')
	or die "open2() failed: $!\n" .
	"Falling back to scanning...\n";

	# In the query expression below we're asking for names of files that
	# changed since $last_update_token but not from the .git folder.
	#
	# To accomplish this, we're using the "since" generator to use the
	# recency index to select candidate nodes and "fields" to limit the
	# output to file names only. Then we're using the "expression" term to
	# further constrain the results.
	my $last_update_line = "";
	if (substr($last_update_token, 0, 1) eq "c") {
		$last_update_token = "\"$last_update_token\"";
		$last_update_line = qq[\n"since": $last_update_token,];
	}
	my $query = <<"	END";
		["query", "$git_work_tree", {$last_update_line
			"fields": ["name"],
			"expression": ["not", ["dirname", ".git"]]
		}]
	END

	# Uncomment for debugging the watchman query
	# open (my $fh, ">", ".git/watchman-query.json");
	# print $fh $query;
	# close $fh;

	print CHLD_IN $query;
	close CHLD_IN;
	my $response = do {local $/; <CHLD_OUT>};

	# Uncomment for debugging the watch response
	# open ($fh, ">", ".git/watchman-response.json");
	# print $fh $response;
	# close $fh;

	die "Watchman: command returned no output.\n" .
	"Falling back to scanning...\n" if $response eq "";
	die "Watchman: command returned invalid output: $response\n" .
	"Falling back to scanning...\n" unless $response =~ /^\{/;

	return $json_pkg->new->utf8->decode($response);
}

sub is_work_tree_watched {
	my ($output) = @_;
	my $error = $output->{error};
	if ($retry > 0 and $error and $error =~ m/unable to resolve root .* directory (.*) is not watched/) {
		$retry--;
		my $response = qx/watchman watch "$git_work_tree"/;
		die "Failed to make watchman watch '$git_work_tree'.\n" .
		    "Falling back to scanning...\n" if $? != 0;
		$output = $json_pkg->new->utf8->decode($response);
		$error = $output->{error};
		die "Watchman: $error.\n" .
		"Falling back to scanning...\n" if $error;

		# Uncomment for debugging watchman output
		# open (my $fh, ">", ".git/watchman-output.out");
		# close $fh;

		# Watchman will always return all files on the first query so
		# return the fast "everything is dirty" flag to git and do the
		# Watchman query just to get it over with now so we won't pay
		# the cost in git to look up each individual file.
		my $o = watchman_clock();
		$error = $output->{error};

		die "Watchman: $error.\n" .
		"Falling back to scanning...\n" if $error;

		output_result($o->{clock}, ("/"));
		$last_update_token = $o->{clock};

		eval { launch_watchman() };
		return 0;
	}

	die "Watchman: $error.\n" .
	"Falling back to scanning...\n" if $error;

	return 1;
}

sub get_working_dir {
	my $working_dir;
	if ($^O =~ 'msys' || $^O =~ 'cygwin') {
		$working_dir = Win32::GetCwd();
		$working_dir =~ tr/\\/\//;
	} else {
		require Cwd;
		$working_dir = Cwd::cwd();
	}

	return $working_dir;
}
</file>

<file path="apps/api/.git/hooks/post-update.sample">
#!/bin/sh
#
# An example hook script to prepare a packed repository for use over
# dumb transports.
#
# To enable this hook, rename this file to "post-update".

exec git update-server-info
</file>

<file path="apps/api/.git/hooks/pre-applypatch.sample">
#!/bin/sh
#
# An example hook script to verify what is about to be committed
# by applypatch from an e-mail message.
#
# The hook should exit with non-zero status after issuing an
# appropriate message if it wants to stop the commit.
#
# To enable this hook, rename this file to "pre-applypatch".

. git-sh-setup
precommit="$(git rev-parse --git-path hooks/pre-commit)"
test -x "$precommit" && exec "$precommit" ${1+"$@"}
:
</file>

<file path="apps/api/.git/hooks/pre-commit.sample">
#!/bin/sh
#
# An example hook script to verify what is about to be committed.
# Called by "git commit" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message if
# it wants to stop the commit.
#
# To enable this hook, rename this file to "pre-commit".

if git rev-parse --verify HEAD >/dev/null 2>&1
then
	against=HEAD
else
	# Initial commit: diff against an empty tree object
	against=$(git hash-object -t tree /dev/null)
fi

# If you want to allow non-ASCII filenames set this variable to true.
allownonascii=$(git config --type=bool hooks.allownonascii)

# Redirect output to stderr.
exec 1>&2

# Cross platform projects tend to avoid non-ASCII filenames; prevent
# them from being added to the repository. We exploit the fact that the
# printable range starts at the space character and ends with tilde.
if [ "$allownonascii" != "true" ] &&
	# Note that the use of brackets around a tr range is ok here, (it's
	# even required, for portability to Solaris 10's /usr/bin/tr), since
	# the square bracket bytes happen to fall in the designated range.
	test $(git diff-index --cached --name-only --diff-filter=A -z $against |
	  LC_ALL=C tr -d '[ -~]\0' | wc -c) != 0
then
	cat <<\EOF
Error: Attempt to add a non-ASCII file name.

This can cause problems if you want to work with people on other platforms.

To be portable it is advisable to rename the file.

If you know what you are doing you can disable this check using:

  git config hooks.allownonascii true
EOF
	exit 1
fi

# If there are whitespace errors, print the offending file names and fail.
exec git diff-index --check --cached $against --
</file>

<file path="apps/api/.git/hooks/pre-merge-commit.sample">
#!/bin/sh
#
# An example hook script to verify what is about to be committed.
# Called by "git merge" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message to
# stderr if it wants to stop the merge commit.
#
# To enable this hook, rename this file to "pre-merge-commit".

. git-sh-setup
test -x "$GIT_DIR/hooks/pre-commit" &&
        exec "$GIT_DIR/hooks/pre-commit"
:
</file>

<file path="apps/api/.git/hooks/pre-push.sample">
#!/bin/sh

# An example hook script to verify what is about to be pushed.  Called by "git
# push" after it has checked the remote status, but before anything has been
# pushed.  If this script exits with a non-zero status nothing will be pushed.
#
# This hook is called with the following parameters:
#
# $1 -- Name of the remote to which the push is being done
# $2 -- URL to which the push is being done
#
# If pushing without using a named remote those arguments will be equal.
#
# Information about the commits which are being pushed is supplied as lines to
# the standard input in the form:
#
#   <local ref> <local oid> <remote ref> <remote oid>
#
# This sample shows how to prevent push of commits where the log message starts
# with "WIP" (work in progress).

remote="$1"
url="$2"

zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')

while read local_ref local_oid remote_ref remote_oid
do
	if test "$local_oid" = "$zero"
	then
		# Handle delete
		:
	else
		if test "$remote_oid" = "$zero"
		then
			# New branch, examine all commits
			range="$local_oid"
		else
			# Update to existing branch, examine new commits
			range="$remote_oid..$local_oid"
		fi

		# Check for WIP commit
		commit=$(git rev-list -n 1 --grep '^WIP' "$range")
		if test -n "$commit"
		then
			echo >&2 "Found WIP commit in $local_ref, not pushing"
			exit 1
		fi
	fi
done

exit 0
</file>

<file path="apps/api/.git/hooks/pre-rebase.sample">
#!/bin/sh
#
# Copyright (c) 2006, 2008 Junio C Hamano
#
# The "pre-rebase" hook is run just before "git rebase" starts doing
# its job, and can prevent the command from running by exiting with
# non-zero status.
#
# The hook is called with the following parameters:
#
# $1 -- the upstream the series was forked from.
# $2 -- the branch being rebased (or empty when rebasing the current branch).
#
# This sample shows how to prevent topic branches that are already
# merged to 'next' branch from getting rebased, because allowing it
# would result in rebasing already published history.

publish=next
basebranch="$1"
if test "$#" = 2
then
	topic="refs/heads/$2"
else
	topic=`git symbolic-ref HEAD` ||
	exit 0 ;# we do not interrupt rebasing detached HEAD
fi

case "$topic" in
refs/heads/??/*)
	;;
*)
	exit 0 ;# we do not interrupt others.
	;;
esac

# Now we are dealing with a topic branch being rebased
# on top of master.  Is it OK to rebase it?

# Does the topic really exist?
git show-ref -q "$topic" || {
	echo >&2 "No such branch $topic"
	exit 1
}

# Is topic fully merged to master?
not_in_master=`git rev-list --pretty=oneline ^master "$topic"`
if test -z "$not_in_master"
then
	echo >&2 "$topic is fully merged to master; better remove it."
	exit 1 ;# we could allow it, but there is no point.
fi

# Is topic ever merged to next?  If so you should not be rebasing it.
only_next_1=`git rev-list ^master "^$topic" ${publish} | sort`
only_next_2=`git rev-list ^master           ${publish} | sort`
if test "$only_next_1" = "$only_next_2"
then
	not_in_topic=`git rev-list "^$topic" master`
	if test -z "$not_in_topic"
	then
		echo >&2 "$topic is already up to date with master"
		exit 1 ;# we could allow it, but there is no point.
	else
		exit 0
	fi
else
	not_in_next=`git rev-list --pretty=oneline ^${publish} "$topic"`
	/usr/bin/perl -e '
		my $topic = $ARGV[0];
		my $msg = "* $topic has commits already merged to public branch:\n";
		my (%not_in_next) = map {
			/^([0-9a-f]+) /;
			($1 => 1);
		} split(/\n/, $ARGV[1]);
		for my $elem (map {
				/^([0-9a-f]+) (.*)$/;
				[$1 => $2];
			} split(/\n/, $ARGV[2])) {
			if (!exists $not_in_next{$elem->[0]}) {
				if ($msg) {
					print STDERR $msg;
					undef $msg;
				}
				print STDERR " $elem->[1]\n";
			}
		}
	' "$topic" "$not_in_next" "$not_in_master"
	exit 1
fi

<<\DOC_END

This sample hook safeguards topic branches that have been
published from being rewound.

The workflow assumed here is:

 * Once a topic branch forks from "master", "master" is never
   merged into it again (either directly or indirectly).

 * Once a topic branch is fully cooked and merged into "master",
   it is deleted.  If you need to build on top of it to correct
   earlier mistakes, a new topic branch is created by forking at
   the tip of the "master".  This is not strictly necessary, but
   it makes it easier to keep your history simple.

 * Whenever you need to test or publish your changes to topic
   branches, merge them into "next" branch.

The script, being an example, hardcodes the publish branch name
to be "next", but it is trivial to make it configurable via
$GIT_DIR/config mechanism.

With this workflow, you would want to know:

(1) ... if a topic branch has ever been merged to "next".  Young
    topic branches can have stupid mistakes you would rather
    clean up before publishing, and things that have not been
    merged into other branches can be easily rebased without
    affecting other people.  But once it is published, you would
    not want to rewind it.

(2) ... if a topic branch has been fully merged to "master".
    Then you can delete it.  More importantly, you should not
    build on top of it -- other people may already want to
    change things related to the topic as patches against your
    "master", so if you need further changes, it is better to
    fork the topic (perhaps with the same name) afresh from the
    tip of "master".

Let's look at this example:

		   o---o---o---o---o---o---o---o---o---o "next"
		  /       /           /           /
		 /   a---a---b A     /           /
		/   /               /           /
	       /   /   c---c---c---c B         /
	      /   /   /             \         /
	     /   /   /   b---b C     \       /
	    /   /   /   /             \     /
    ---o---o---o---o---o---o---o---o---o---o---o "master"


A, B and C are topic branches.

 * A has one fix since it was merged up to "next".

 * B has finished.  It has been fully merged up to "master" and "next",
   and is ready to be deleted.

 * C has not merged to "next" at all.

We would want to allow C to be rebased, refuse A, and encourage
B to be deleted.

To compute (1):

	git rev-list ^master ^topic next
	git rev-list ^master        next

	if these match, topic has not merged in next at all.

To compute (2):

	git rev-list master..topic

	if this is empty, it is fully merged to "master".

DOC_END
</file>

<file path="apps/api/.git/hooks/pre-receive.sample">
#!/bin/sh
#
# An example hook script to make use of push options.
# The example simply echoes all push options that start with 'echoback='
# and rejects all pushes when the "reject" push option is used.
#
# To enable this hook, rename this file to "pre-receive".

if test -n "$GIT_PUSH_OPTION_COUNT"
then
	i=0
	while test "$i" -lt "$GIT_PUSH_OPTION_COUNT"
	do
		eval "value=\$GIT_PUSH_OPTION_$i"
		case "$value" in
		echoback=*)
			echo "echo from the pre-receive-hook: ${value#*=}" >&2
			;;
		reject)
			exit 1
		esac
		i=$((i + 1))
	done
fi
</file>

<file path="apps/api/.git/hooks/prepare-commit-msg.sample">
#!/bin/sh
#
# An example hook script to prepare the commit log message.
# Called by "git commit" with the name of the file that has the
# commit message, followed by the description of the commit
# message's source.  The hook's purpose is to edit the commit
# message file.  If the hook fails with a non-zero status,
# the commit is aborted.
#
# To enable this hook, rename this file to "prepare-commit-msg".

# This hook includes three examples. The first one removes the
# "# Please enter the commit message..." help message.
#
# The second includes the output of "git diff --name-status -r"
# into the message, just before the "git status" output.  It is
# commented because it doesn't cope with --amend or with squashed
# commits.
#
# The third example adds a Signed-off-by line to the message, that can
# still be edited.  This is rarely a good idea.

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

/usr/bin/perl -i.bak -ne 'print unless(m/^. Please enter the commit message/..m/^#$/)' "$COMMIT_MSG_FILE"

# case "$COMMIT_SOURCE,$SHA1" in
#  ,|template,)
#    /usr/bin/perl -i.bak -pe '
#       print "\n" . `git diff --cached --name-status -r`
# 	 if /^#/ && $first++ == 0' "$COMMIT_MSG_FILE" ;;
#  *) ;;
# esac

# SOB=$(git var GIT_COMMITTER_IDENT | sed -n 's/^\(.*>\).*$/Signed-off-by: \1/p')
# git interpret-trailers --in-place --trailer "$SOB" "$COMMIT_MSG_FILE"
# if test -z "$COMMIT_SOURCE"
# then
#   /usr/bin/perl -i.bak -pe 'print "\n" if !$first_line++' "$COMMIT_MSG_FILE"
# fi
</file>

<file path="apps/api/.git/hooks/push-to-checkout.sample">
#!/bin/sh

# An example hook script to update a checked-out tree on a git push.
#
# This hook is invoked by git-receive-pack(1) when it reacts to git
# push and updates reference(s) in its repository, and when the push
# tries to update the branch that is currently checked out and the
# receive.denyCurrentBranch configuration variable is set to
# updateInstead.
#
# By default, such a push is refused if the working tree and the index
# of the remote repository has any difference from the currently
# checked out commit; when both the working tree and the index match
# the current commit, they are updated to match the newly pushed tip
# of the branch. This hook is to be used to override the default
# behaviour; however the code below reimplements the default behaviour
# as a starting point for convenient modification.
#
# The hook receives the commit with which the tip of the current
# branch is going to be updated:
commit=$1

# It can exit with a non-zero status to refuse the push (when it does
# so, it must not modify the index or the working tree).
die () {
	echo >&2 "$*"
	exit 1
}

# Or it can make any necessary changes to the working tree and to the
# index to bring them to the desired state when the tip of the current
# branch is updated to the new commit, and exit with a zero status.
#
# For example, the hook can simply run git read-tree -u -m HEAD "$1"
# in order to emulate git fetch that is run in the reverse direction
# with git push, as the two-tree form of git read-tree -u -m is
# essentially the same as git switch or git checkout that switches
# branches while keeping the local changes in the working tree that do
# not interfere with the difference between the branches.

# The below is a more-or-less exact translation to shell of the C code
# for the default behaviour for git's push-to-checkout hook defined in
# the push_to_deploy() function in builtin/receive-pack.c.
#
# Note that the hook will be executed from the repository directory,
# not from the working tree, so if you want to perform operations on
# the working tree, you will have to adapt your code accordingly, e.g.
# by adding "cd .." or using relative paths.

if ! git update-index -q --ignore-submodules --refresh
then
	die "Up-to-date check failed"
fi

if ! git diff-files --quiet --ignore-submodules --
then
	die "Working directory has unstaged changes"
fi

# This is a rough translation of:
#
#   head_has_history() ? "HEAD" : EMPTY_TREE_SHA1_HEX
if git cat-file -e HEAD 2>/dev/null
then
	head=HEAD
else
	head=$(git hash-object -t tree --stdin </dev/null)
fi

if ! git diff-index --quiet --cached --ignore-submodules $head --
then
	die "Working directory has staged changes"
fi

if ! git read-tree -u -m "$commit"
then
	die "Could not update working tree to new HEAD"
fi
</file>

<file path="apps/api/.git/hooks/sendemail-validate.sample">
#!/bin/sh

# An example hook script to validate a patch (and/or patch series) before
# sending it via email.
#
# The hook should exit with non-zero status after issuing an appropriate
# message if it wants to prevent the email(s) from being sent.
#
# To enable this hook, rename this file to "sendemail-validate".
#
# By default, it will only check that the patch(es) can be applied on top of
# the default upstream branch without conflicts in a secondary worktree. After
# validation (successful or not) of the last patch of a series, the worktree
# will be deleted.
#
# The following config variables can be set to change the default remote and
# remote ref that are used to apply the patches against:
#
#   sendemail.validateRemote (default: origin)
#   sendemail.validateRemoteRef (default: HEAD)
#
# Replace the TODO placeholders with appropriate checks according to your
# needs.

validate_cover_letter () {
	file="$1"
	# TODO: Replace with appropriate checks (e.g. spell checking).
	true
}

validate_patch () {
	file="$1"
	# Ensure that the patch applies without conflicts.
	git am -3 "$file" || return
	# TODO: Replace with appropriate checks for this patch
	# (e.g. checkpatch.pl).
	true
}

validate_series () {
	# TODO: Replace with appropriate checks for the whole series
	# (e.g. quick build, coding style checks, etc.).
	true
}

# main -------------------------------------------------------------------------

if test "$GIT_SENDEMAIL_FILE_COUNTER" = 1
then
	remote=$(git config --default origin --get sendemail.validateRemote) &&
	ref=$(git config --default HEAD --get sendemail.validateRemoteRef) &&
	worktree=$(mktemp --tmpdir -d sendemail-validate.XXXXXXX) &&
	git worktree add -fd --checkout "$worktree" "refs/remotes/$remote/$ref" &&
	git config --replace-all sendemail.validateWorktree "$worktree"
else
	worktree=$(git config --get sendemail.validateWorktree)
fi || {
	echo "sendemail-validate: error: failed to prepare worktree" >&2
	exit 1
}

unset GIT_DIR GIT_WORK_TREE
cd "$worktree" &&

if grep -q "^diff --git " "$1"
then
	validate_patch "$1"
else
	validate_cover_letter "$1"
fi &&

if test "$GIT_SENDEMAIL_FILE_COUNTER" = "$GIT_SENDEMAIL_FILE_TOTAL"
then
	git config --unset-all sendemail.validateWorktree &&
	trap 'git worktree remove -ff "$worktree"' EXIT &&
	validate_series
fi
</file>

<file path="apps/api/.git/hooks/update.sample">
#!/bin/sh
#
# An example hook script to block unannotated tags from entering.
# Called by "git receive-pack" with arguments: refname sha1-old sha1-new
#
# To enable this hook, rename this file to "update".
#
# Config
# ------
# hooks.allowunannotated
#   This boolean sets whether unannotated tags will be allowed into the
#   repository.  By default they won't be.
# hooks.allowdeletetag
#   This boolean sets whether deleting tags will be allowed in the
#   repository.  By default they won't be.
# hooks.allowmodifytag
#   This boolean sets whether a tag may be modified after creation. By default
#   it won't be.
# hooks.allowdeletebranch
#   This boolean sets whether deleting branches will be allowed in the
#   repository.  By default they won't be.
# hooks.denycreatebranch
#   This boolean sets whether remotely creating branches will be denied
#   in the repository.  By default this is allowed.
#

# --- Command line
refname="$1"
oldrev="$2"
newrev="$3"

# --- Safety check
if [ -z "$GIT_DIR" ]; then
	echo "Don't run this script from the command line." >&2
	echo " (if you want, you could supply GIT_DIR then run" >&2
	echo "  $0 <ref> <oldrev> <newrev>)" >&2
	exit 1
fi

if [ -z "$refname" -o -z "$oldrev" -o -z "$newrev" ]; then
	echo "usage: $0 <ref> <oldrev> <newrev>" >&2
	exit 1
fi

# --- Config
allowunannotated=$(git config --type=bool hooks.allowunannotated)
allowdeletebranch=$(git config --type=bool hooks.allowdeletebranch)
denycreatebranch=$(git config --type=bool hooks.denycreatebranch)
allowdeletetag=$(git config --type=bool hooks.allowdeletetag)
allowmodifytag=$(git config --type=bool hooks.allowmodifytag)

# check for no description
projectdesc=$(sed -e '1q' "$GIT_DIR/description")
case "$projectdesc" in
"Unnamed repository"* | "")
	echo "*** Project description file hasn't been set" >&2
	exit 1
	;;
esac

# --- Check types
# if $newrev is 0000...0000, it's a commit to delete a ref.
zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')
if [ "$newrev" = "$zero" ]; then
	newrev_type=delete
else
	newrev_type=$(git cat-file -t $newrev)
fi

case "$refname","$newrev_type" in
	refs/tags/*,commit)
		# un-annotated tag
		short_refname=${refname##refs/tags/}
		if [ "$allowunannotated" != "true" ]; then
			echo "*** The un-annotated tag, $short_refname, is not allowed in this repository" >&2
			echo "*** Use 'git tag [ -a | -s ]' for tags you want to propagate." >&2
			exit 1
		fi
		;;
	refs/tags/*,delete)
		# delete tag
		if [ "$allowdeletetag" != "true" ]; then
			echo "*** Deleting a tag is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/tags/*,tag)
		# annotated tag
		if [ "$allowmodifytag" != "true" ] && git rev-parse $refname > /dev/null 2>&1
		then
			echo "*** Tag '$refname' already exists." >&2
			echo "*** Modifying a tag is not allowed in this repository." >&2
			exit 1
		fi
		;;
	refs/heads/*,commit)
		# branch
		if [ "$oldrev" = "$zero" -a "$denycreatebranch" = "true" ]; then
			echo "*** Creating a branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/heads/*,delete)
		# delete branch
		if [ "$allowdeletebranch" != "true" ]; then
			echo "*** Deleting a branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/remotes/*,commit)
		# tracking branch
		;;
	refs/remotes/*,delete)
		# delete tracking branch
		if [ "$allowdeletebranch" != "true" ]; then
			echo "*** Deleting a tracking branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	*)
		# Anything else (is there anything else?)
		echo "*** Update hook: unknown type of update to ref $refname of type $newrev_type" >&2
		exit 1
		;;
esac

# --- Finished
exit 0
</file>

<file path="apps/api/.git/info/exclude">
# git ls-files --others --exclude-from=.git/info/exclude
# Lines that start with '#' are comments.
# For a project mostly in C, the following would be a good set of
# exclude patterns (uncomment them if you want to use them):
# *.[oa]
# *~
</file>

<file path="apps/api/.git/logs/HEAD">
0000000000000000000000000000000000000000 7629cdef36ce1dcc15f6ab1a994f76a80d2bb69d vux311 <thuanduaxe123@gmail.com> 1767601415 +0700	clone: from https://github.com/vux311/Backend_SMD.git
7629cdef36ce1dcc15f6ab1a994f76a80d2bb69d efe322f058dac32936e496e15bdc8917c85a318f vux311 <thuanduaxe123@gmail.com> 1767629187 +0700	pull --tags origin main: Fast-forward
efe322f058dac32936e496e15bdc8917c85a318f 7bdad87d891f07ea055ffb64e8561f24e437385b vux311 <thuanduaxe123@gmail.com> 1767708475 +0700	commit: Backup before cleanup
7bdad87d891f07ea055ffb64e8561f24e437385b 7915d352b9697431bdc7cb8c562a621fef696473 vux311 <thuanduaxe123@gmail.com> 1767709188 +0700	commit: Remove legacy todo/course/auth controllers, services, repos, schemas and legacy models
7915d352b9697431bdc7cb8c562a621fef696473 6359a599481ab725fc92481a2b6b67ad019bc320 vux311 <thuanduaxe123@gmail.com> 1767709211 +0700	commit: Remove legacy blueprint registration and clean database model imports
6359a599481ab725fc92481a2b6b67ad019bc320 50b8eeb91d007723151d993858f48c483dd32ab0 vux311 <thuanduaxe123@gmail.com> 1767709753 +0700	commit: Add Subject module (repo/service/schema/controller) and DI Container; add dependency-injector to requirements
50b8eeb91d007723151d993858f48c483dd32ab0 2f3d5a0168970855f46dc792cddf15a27130a70e vux311 <thuanduaxe123@gmail.com> 1767709917 +0700	commit: Remove legacy Todo schema references from swagger and rename API title to Syllabus Management API
2f3d5a0168970855f46dc792cddf15a27130a70e 8ecf12e683c590ff55b516209737d6ea2d0eafba vux311 <thuanduaxe123@gmail.com> 1767710300 +0700	commit: Fix imports to allow running app.py from src/: remove 'src.' prefixes and update wiring modules
8ecf12e683c590ff55b516209737d6ea2d0eafba e3a23d42834404fc370d6a31633ed946e67073eb vux311 <thuanduaxe123@gmail.com> 1767711727 +0700	commit: Add Faculty & Department modules (repo, service, schema, controller); wire into Container and register blueprints
e3a23d42834404fc370d6a31633ed946e67073eb b2e8680da8122e5f9df07335d3d18d164c85f60d vux311 <thuanduaxe123@gmail.com> 1767711777 +0700	commit: Add Faculty & Department modules; wire Container and register blueprints; update Subject schema defaults
b2e8680da8122e5f9df07335d3d18d164c85f60d e603ec248063dd10df588ccd54fcaa61145d6fc6 vux311 <thuanduaxe123@gmail.com> 1767712448 +0700	commit: Add Role and User modules (repo/service/schema/controller); update UserRepository and Container; add seed script
e603ec248063dd10df588ccd54fcaa61145d6fc6 559a800b677458e4ee762e7ffa9eb15ae2bbdb53 vux311 <thuanduaxe123@gmail.com> 1767712476 +0700	commit: Assign roles to seeded users in seed_users script
559a800b677458e4ee762e7ffa9eb15ae2bbdb53 7a403501c5363d019460af19950ad3f3f54a0579 vux311 <thuanduaxe123@gmail.com> 1767713536 +0700	commit: Fix seed_users: ensure admin/lecturer variables and idempotent UserRole assignments
7a403501c5363d019460af19950ad3f3f54a0579 56fd7bb21a8a1b592360822bde3ade2e503da9a0 vux311 <thuanduaxe123@gmail.com> 1767713839 +0700	commit: Remove legacy domain models and auth schema
56fd7bb21a8a1b592360822bde3ade2e503da9a0 d1723e43787e65b3915e188f7680c03c411cd428 vux311 <thuanduaxe123@gmail.com> 1767713883 +0700	commit: Update Swagger titles to 'Syllabus Management API'
d1723e43787e65b3915e188f7680c03c411cd428 b2fc63a60540325ee99570f48ec6ae19be1236ae vux311 <thuanduaxe123@gmail.com> 1767714594 +0700	commit: Add AcademicYear and Program modules; wire into Container and register blueprints; clean Program model
b2fc63a60540325ee99570f48ec6ae19be1236ae d4130e10c836fad1364a5d4defc90845d92edbf6 vux311 <thuanduaxe123@gmail.com> 1767715106 +0700	commit: Add Syllabus module (repo/service/schema/controller); wire Container and register blueprint
d4130e10c836fad1364a5d4defc90845d92edbf6 48e7112565949c446ac1e4ceacdfc67881651854 vux311 <thuanduaxe123@gmail.com> 1767715400 +0700	commit: Add Syllabus CLO and Material modules; register in DI and app
48e7112565949c446ac1e4ceacdfc67881651854 ad2394ef51d71dbfeb700af1a534585c4771d9c0 vux311 <thuanduaxe123@gmail.com> 1767715774 +0700	commit: Add Teaching Plan module; register in DI and app
ad2394ef51d71dbfeb700af1a534585c4771d9c0 89c3400132002085466c92e6fa6d50a77ef7f9f3 vux311 <thuanduaxe123@gmail.com> 1767715947 +0700	commit: Rewrite seed script to comprehensively seed identity, org, academic, syllabus, CLOs and materials
89c3400132002085466c92e6fa6d50a77ef7f9f3 c6a84246183de55c4d102aa795bf8588b3ae1544 vux311 <thuanduaxe123@gmail.com> 1767716798 +0700	commit: Add Assessment Scheme and Component modules; wire DI and register blueprints
c6a84246183de55c4d102aa795bf8588b3ae1544 c5b4ff6bb4bce0f394e19ac1bc8a58c4cc39929a vux311 <thuanduaxe123@gmail.com> 1767717750 +0700	commit: Add Rubric and Assessment-CLO mapping modules; wire DI and register blueprints
c5b4ff6bb4bce0f394e19ac1bc8a58c4cc39929a e08a6691d52f0ffeb810e782a33ae09422abe4ec vux311 <thuanduaxe123@gmail.com> 1767720253 +0700	commit: Clean up DI duplicates, register missing blueprints, and remove unused imports
e08a6691d52f0ffeb810e782a33ae09422abe4ec 40e43cbf82f7db342703d93df915edeb33910f6f vux311 <thuanduaxe123@gmail.com> 1767720297 +0700	commit: Add auth controller, token_required decorator, protect create_syllabus, and wire auth blueprint
40e43cbf82f7db342703d93df915edeb33910f6f be3c92812b8898ef5c761f11cde8433888980c75 vux311 <thuanduaxe123@gmail.com> 1767720453 +0700	commit: Add Workflow logging, syllabus workflow endpoints, auth controller & token decorator; DI cleanup and seed updates
be3c92812b8898ef5c761f11cde8433888980c75 3b1b55272a370646795c30d75470080d50e38bf3 vux311 <thuanduaxe123@gmail.com> 1767720808 +0700	commit: Docs: update README for Syllabus Management System (SMD) backend
3b1b55272a370646795c30d75470080d50e38bf3 f95d79aa9ad325203af5101bccc0ba0b7c45c212 vux311 <thuanduaxe123@gmail.com> 1767784708 +0700	commit: fix(svc): enforce syllabus update status; add assessment_clo integrity checks; fix DI provider; add e2e test script
f95d79aa9ad325203af5101bccc0ba0b7c45c212 0ea049649e6a7955c3ae9218d40aa8c7232f554a vux311 <thuanduaxe123@gmail.com> 1767785609 +0700	commit: docs(swagger): add Flasgger docstrings to controllers
0ea049649e6a7955c3ae9218d40aa8c7232f554a 10ef8b86e8ee81a57a6700ae78ee898f584c96b4 vux311 <thuanduaxe123@gmail.com> 1767941040 +0700	pull --tags origin main: Fast-forward
10ef8b86e8ee81a57a6700ae78ee898f584c96b4 d7d351efb35fac17b5cdd5a7f0e03ca1392ff16d vux311 <thuanduaxe123@gmail.com> 1767941133 +0700	commit: Refactor models to use NVARCHAR and UnicodeText for string fields
d7d351efb35fac17b5cdd5a7f0e03ca1392ff16d aa382b94ec6b3fa4862c614a86d1276441c740cf vux311 <thuanduaxe123@gmail.com> 1767941238 +0700	commit: feat(seed): implement data seeding for roles, users, departments, programs, and syllabus
aa382b94ec6b3fa4862c614a86d1276441c740cf 33cb6b0b10dd369d334e9d37bfdca506e7e50ef1 vux311 <thuanduaxe123@gmail.com> 1767941649 +0700	pull --tags origin main: Fast-forward
33cb6b0b10dd369d334e9d37bfdca506e7e50ef1 087353f397dc330104c6f8d1cfa01d4cdca99f33 vux311 <thuanduaxe123@gmail.com> 1768018742 +0700	commit: Add schemas, services, and repositories for file management, notifications, program outcomes, and student subscriptions
087353f397dc330104c6f8d1cfa01d4cdca99f33 e4146f25ceadc227860c1293e7484f21a42d212d vux311 <thuanduaxe123@gmail.com> 1768020214 +0700	commit: feat(seed): enhance data seeding script with additional models and improved structure
e4146f25ceadc227860c1293e7484f21a42d212d 640049e617a980520fa856bbca112a8ff729b1c9 vux311 <thuanduaxe123@gmail.com> 1768021404 +0700	commit: feat(api): enhance controllers with detailed API documentation and improve schema handling
</file>

<file path="apps/api/.git/logs/refs/heads/main">
0000000000000000000000000000000000000000 7629cdef36ce1dcc15f6ab1a994f76a80d2bb69d vux311 <thuanduaxe123@gmail.com> 1767601415 +0700	clone: from https://github.com/vux311/Backend_SMD.git
7629cdef36ce1dcc15f6ab1a994f76a80d2bb69d efe322f058dac32936e496e15bdc8917c85a318f vux311 <thuanduaxe123@gmail.com> 1767629187 +0700	pull --tags origin main: Fast-forward
efe322f058dac32936e496e15bdc8917c85a318f 7bdad87d891f07ea055ffb64e8561f24e437385b vux311 <thuanduaxe123@gmail.com> 1767708475 +0700	commit: Backup before cleanup
7bdad87d891f07ea055ffb64e8561f24e437385b 7915d352b9697431bdc7cb8c562a621fef696473 vux311 <thuanduaxe123@gmail.com> 1767709188 +0700	commit: Remove legacy todo/course/auth controllers, services, repos, schemas and legacy models
7915d352b9697431bdc7cb8c562a621fef696473 6359a599481ab725fc92481a2b6b67ad019bc320 vux311 <thuanduaxe123@gmail.com> 1767709211 +0700	commit: Remove legacy blueprint registration and clean database model imports
6359a599481ab725fc92481a2b6b67ad019bc320 50b8eeb91d007723151d993858f48c483dd32ab0 vux311 <thuanduaxe123@gmail.com> 1767709753 +0700	commit: Add Subject module (repo/service/schema/controller) and DI Container; add dependency-injector to requirements
50b8eeb91d007723151d993858f48c483dd32ab0 2f3d5a0168970855f46dc792cddf15a27130a70e vux311 <thuanduaxe123@gmail.com> 1767709917 +0700	commit: Remove legacy Todo schema references from swagger and rename API title to Syllabus Management API
2f3d5a0168970855f46dc792cddf15a27130a70e 8ecf12e683c590ff55b516209737d6ea2d0eafba vux311 <thuanduaxe123@gmail.com> 1767710300 +0700	commit: Fix imports to allow running app.py from src/: remove 'src.' prefixes and update wiring modules
8ecf12e683c590ff55b516209737d6ea2d0eafba e3a23d42834404fc370d6a31633ed946e67073eb vux311 <thuanduaxe123@gmail.com> 1767711727 +0700	commit: Add Faculty & Department modules (repo, service, schema, controller); wire into Container and register blueprints
e3a23d42834404fc370d6a31633ed946e67073eb b2e8680da8122e5f9df07335d3d18d164c85f60d vux311 <thuanduaxe123@gmail.com> 1767711777 +0700	commit: Add Faculty & Department modules; wire Container and register blueprints; update Subject schema defaults
b2e8680da8122e5f9df07335d3d18d164c85f60d e603ec248063dd10df588ccd54fcaa61145d6fc6 vux311 <thuanduaxe123@gmail.com> 1767712448 +0700	commit: Add Role and User modules (repo/service/schema/controller); update UserRepository and Container; add seed script
e603ec248063dd10df588ccd54fcaa61145d6fc6 559a800b677458e4ee762e7ffa9eb15ae2bbdb53 vux311 <thuanduaxe123@gmail.com> 1767712476 +0700	commit: Assign roles to seeded users in seed_users script
559a800b677458e4ee762e7ffa9eb15ae2bbdb53 7a403501c5363d019460af19950ad3f3f54a0579 vux311 <thuanduaxe123@gmail.com> 1767713536 +0700	commit: Fix seed_users: ensure admin/lecturer variables and idempotent UserRole assignments
7a403501c5363d019460af19950ad3f3f54a0579 56fd7bb21a8a1b592360822bde3ade2e503da9a0 vux311 <thuanduaxe123@gmail.com> 1767713839 +0700	commit: Remove legacy domain models and auth schema
56fd7bb21a8a1b592360822bde3ade2e503da9a0 d1723e43787e65b3915e188f7680c03c411cd428 vux311 <thuanduaxe123@gmail.com> 1767713883 +0700	commit: Update Swagger titles to 'Syllabus Management API'
d1723e43787e65b3915e188f7680c03c411cd428 b2fc63a60540325ee99570f48ec6ae19be1236ae vux311 <thuanduaxe123@gmail.com> 1767714594 +0700	commit: Add AcademicYear and Program modules; wire into Container and register blueprints; clean Program model
b2fc63a60540325ee99570f48ec6ae19be1236ae d4130e10c836fad1364a5d4defc90845d92edbf6 vux311 <thuanduaxe123@gmail.com> 1767715106 +0700	commit: Add Syllabus module (repo/service/schema/controller); wire Container and register blueprint
d4130e10c836fad1364a5d4defc90845d92edbf6 48e7112565949c446ac1e4ceacdfc67881651854 vux311 <thuanduaxe123@gmail.com> 1767715400 +0700	commit: Add Syllabus CLO and Material modules; register in DI and app
48e7112565949c446ac1e4ceacdfc67881651854 ad2394ef51d71dbfeb700af1a534585c4771d9c0 vux311 <thuanduaxe123@gmail.com> 1767715774 +0700	commit: Add Teaching Plan module; register in DI and app
ad2394ef51d71dbfeb700af1a534585c4771d9c0 89c3400132002085466c92e6fa6d50a77ef7f9f3 vux311 <thuanduaxe123@gmail.com> 1767715947 +0700	commit: Rewrite seed script to comprehensively seed identity, org, academic, syllabus, CLOs and materials
89c3400132002085466c92e6fa6d50a77ef7f9f3 c6a84246183de55c4d102aa795bf8588b3ae1544 vux311 <thuanduaxe123@gmail.com> 1767716798 +0700	commit: Add Assessment Scheme and Component modules; wire DI and register blueprints
c6a84246183de55c4d102aa795bf8588b3ae1544 c5b4ff6bb4bce0f394e19ac1bc8a58c4cc39929a vux311 <thuanduaxe123@gmail.com> 1767717750 +0700	commit: Add Rubric and Assessment-CLO mapping modules; wire DI and register blueprints
c5b4ff6bb4bce0f394e19ac1bc8a58c4cc39929a e08a6691d52f0ffeb810e782a33ae09422abe4ec vux311 <thuanduaxe123@gmail.com> 1767720253 +0700	commit: Clean up DI duplicates, register missing blueprints, and remove unused imports
e08a6691d52f0ffeb810e782a33ae09422abe4ec 40e43cbf82f7db342703d93df915edeb33910f6f vux311 <thuanduaxe123@gmail.com> 1767720297 +0700	commit: Add auth controller, token_required decorator, protect create_syllabus, and wire auth blueprint
40e43cbf82f7db342703d93df915edeb33910f6f be3c92812b8898ef5c761f11cde8433888980c75 vux311 <thuanduaxe123@gmail.com> 1767720453 +0700	commit: Add Workflow logging, syllabus workflow endpoints, auth controller & token decorator; DI cleanup and seed updates
be3c92812b8898ef5c761f11cde8433888980c75 3b1b55272a370646795c30d75470080d50e38bf3 vux311 <thuanduaxe123@gmail.com> 1767720808 +0700	commit: Docs: update README for Syllabus Management System (SMD) backend
3b1b55272a370646795c30d75470080d50e38bf3 f95d79aa9ad325203af5101bccc0ba0b7c45c212 vux311 <thuanduaxe123@gmail.com> 1767784708 +0700	commit: fix(svc): enforce syllabus update status; add assessment_clo integrity checks; fix DI provider; add e2e test script
f95d79aa9ad325203af5101bccc0ba0b7c45c212 0ea049649e6a7955c3ae9218d40aa8c7232f554a vux311 <thuanduaxe123@gmail.com> 1767785609 +0700	commit: docs(swagger): add Flasgger docstrings to controllers
0ea049649e6a7955c3ae9218d40aa8c7232f554a 10ef8b86e8ee81a57a6700ae78ee898f584c96b4 vux311 <thuanduaxe123@gmail.com> 1767941040 +0700	pull --tags origin main: Fast-forward
10ef8b86e8ee81a57a6700ae78ee898f584c96b4 d7d351efb35fac17b5cdd5a7f0e03ca1392ff16d vux311 <thuanduaxe123@gmail.com> 1767941133 +0700	commit: Refactor models to use NVARCHAR and UnicodeText for string fields
d7d351efb35fac17b5cdd5a7f0e03ca1392ff16d aa382b94ec6b3fa4862c614a86d1276441c740cf vux311 <thuanduaxe123@gmail.com> 1767941238 +0700	commit: feat(seed): implement data seeding for roles, users, departments, programs, and syllabus
aa382b94ec6b3fa4862c614a86d1276441c740cf 33cb6b0b10dd369d334e9d37bfdca506e7e50ef1 vux311 <thuanduaxe123@gmail.com> 1767941649 +0700	pull --tags origin main: Fast-forward
33cb6b0b10dd369d334e9d37bfdca506e7e50ef1 087353f397dc330104c6f8d1cfa01d4cdca99f33 vux311 <thuanduaxe123@gmail.com> 1768018742 +0700	commit: Add schemas, services, and repositories for file management, notifications, program outcomes, and student subscriptions
087353f397dc330104c6f8d1cfa01d4cdca99f33 e4146f25ceadc227860c1293e7484f21a42d212d vux311 <thuanduaxe123@gmail.com> 1768020214 +0700	commit: feat(seed): enhance data seeding script with additional models and improved structure
e4146f25ceadc227860c1293e7484f21a42d212d 640049e617a980520fa856bbca112a8ff729b1c9 vux311 <thuanduaxe123@gmail.com> 1768021404 +0700	commit: feat(api): enhance controllers with detailed API documentation and improve schema handling
</file>

<file path="apps/api/.git/logs/refs/remotes/origin/HEAD">
0000000000000000000000000000000000000000 7629cdef36ce1dcc15f6ab1a994f76a80d2bb69d vux311 <thuanduaxe123@gmail.com> 1767601415 +0700	clone: from https://github.com/vux311/Backend_SMD.git
</file>

<file path="apps/api/.git/logs/refs/remotes/origin/main">
7629cdef36ce1dcc15f6ab1a994f76a80d2bb69d efe322f058dac32936e496e15bdc8917c85a318f vux311 <thuanduaxe123@gmail.com> 1767629187 +0700	pull --tags origin main: fast-forward
efe322f058dac32936e496e15bdc8917c85a318f be3c92812b8898ef5c761f11cde8433888980c75 vux311 <thuanduaxe123@gmail.com> 1767720457 +0700	update by push
be3c92812b8898ef5c761f11cde8433888980c75 3b1b55272a370646795c30d75470080d50e38bf3 vux311 <thuanduaxe123@gmail.com> 1767720811 +0700	update by push
3b1b55272a370646795c30d75470080d50e38bf3 f95d79aa9ad325203af5101bccc0ba0b7c45c212 vux311 <thuanduaxe123@gmail.com> 1767784725 +0700	update by push
f95d79aa9ad325203af5101bccc0ba0b7c45c212 0ea049649e6a7955c3ae9218d40aa8c7232f554a vux311 <thuanduaxe123@gmail.com> 1767785615 +0700	update by push
0ea049649e6a7955c3ae9218d40aa8c7232f554a 10ef8b86e8ee81a57a6700ae78ee898f584c96b4 vux311 <thuanduaxe123@gmail.com> 1767941040 +0700	pull --tags origin main: fast-forward
10ef8b86e8ee81a57a6700ae78ee898f584c96b4 d7d351efb35fac17b5cdd5a7f0e03ca1392ff16d vux311 <thuanduaxe123@gmail.com> 1767941143 +0700	update by push
d7d351efb35fac17b5cdd5a7f0e03ca1392ff16d aa382b94ec6b3fa4862c614a86d1276441c740cf vux311 <thuanduaxe123@gmail.com> 1767941244 +0700	update by push
aa382b94ec6b3fa4862c614a86d1276441c740cf 33cb6b0b10dd369d334e9d37bfdca506e7e50ef1 vux311 <thuanduaxe123@gmail.com> 1767941649 +0700	pull --tags origin main: fast-forward
33cb6b0b10dd369d334e9d37bfdca506e7e50ef1 087353f397dc330104c6f8d1cfa01d4cdca99f33 vux311 <thuanduaxe123@gmail.com> 1768018765 +0700	update by push
087353f397dc330104c6f8d1cfa01d4cdca99f33 e4146f25ceadc227860c1293e7484f21a42d212d vux311 <thuanduaxe123@gmail.com> 1768020419 +0700	update by push
e4146f25ceadc227860c1293e7484f21a42d212d 640049e617a980520fa856bbca112a8ff729b1c9 vux311 <thuanduaxe123@gmail.com> 1768021411 +0700	update by push
</file>

<file path="apps/api/.git/ORIG_HEAD">
e4146f25ceadc227860c1293e7484f21a42d212d
</file>

<file path="apps/api/.git/packed-refs">
# pack-refs with: peeled fully-peeled sorted 
7629cdef36ce1dcc15f6ab1a994f76a80d2bb69d refs/remotes/origin/main
</file>

<file path="apps/api/.git/refs/heads/main">
640049e617a980520fa856bbca112a8ff729b1c9
</file>

<file path="apps/api/.git/refs/remotes/origin/HEAD">
ref: refs/remotes/origin/main
</file>

<file path="apps/api/.git/refs/remotes/origin/main">
640049e617a980520fa856bbca112a8ff729b1c9
</file>

<file path="apps/api/.gitignore">
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[codz]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py.cover
.hypothesis/
.pytest_cache/
cover/

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/

# PyBuilder
.pybuilder/
target/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
#   For a library or package, you might want to ignore these files since the code is
#   intended to run in multiple environments; otherwise, check them in:
# .python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# UV
#   Similar to Pipfile.lock, it is generally recommended to include uv.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#uv.lock

# poetry
#   Similar to Pipfile.lock, it is generally recommended to include poetry.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#   https://python-poetry.org/docs/basic-usage/#commit-your-poetrylock-file-to-version-control
#poetry.lock
#poetry.toml

# pdm
#   Similar to Pipfile.lock, it is generally recommended to include pdm.lock in version control.
#   pdm recommends including project-wide configuration in pdm.toml, but excluding .pdm-python.
#   https://pdm-project.org/en/latest/usage/project/#working-with-version-control
#pdm.lock
#pdm.toml
.pdm-python
.pdm-build/

# pixi
#   Similar to Pipfile.lock, it is generally recommended to include pixi.lock in version control.
#pixi.lock
#   Pixi creates a virtual environment in the .pixi directory, just like venv module creates one
#   in the .venv directory. It is recommended not to include this directory in version control.
.pixi

# PEP 582; used by e.g. github.com/David-OConnor/pyflow and github.com/pdm-project/pdm
__pypackages__/

# Celery stuff
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
.env
.envrc
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# pytype static type analyzer
.pytype/

# Cython debug symbols
cython_debug/

# PyCharm
#  JetBrains specific template is maintained in a separate JetBrains.gitignore that can
#  be found at https://github.com/github/gitignore/blob/main/Global/JetBrains.gitignore
#  and can be added to the global gitignore or merged into this file.  For a more nuclear
#  option (not recommended) you can uncomment the following to ignore the entire idea folder.
#.idea/

# Abstra
# Abstra is an AI-powered process automation framework.
# Ignore directories containing user credentials, local state, and settings.
# Learn more at https://abstra.io/docs
.abstra/

# Visual Studio Code
#  Visual Studio Code specific template is maintained in a separate VisualStudioCode.gitignore 
#  that can be found at https://github.com/github/gitignore/blob/main/Global/VisualStudioCode.gitignore
#  and can be added to the global gitignore or merged into this file. However, if you prefer, 
#  you could uncomment the following to ignore the entire vscode folder
# .vscode/

# Ruff stuff:
.ruff_cache/

# PyPI configuration file
.pypirc

# Cursor
#  Cursor is an AI-powered code editor. `.cursorignore` specifies files/directories to
#  exclude from AI features like autocomplete and code analysis. Recommended for sensitive data
#  refer to https://docs.cursor.com/context/ignore-files
.cursorignore
.cursorindexingignore

# Marimo
marimo/_static/
marimo/_lsp/
__marimo__/
</file>

<file path="apps/api/docs/flask-clean-architecture.md">
# Architecture

```bash
     migrations
     scripts
        run_postgres.sh
     src
        api
           controllers
              ...  # controllers for the api
           schemas
              ...  # Marshmallow schemas
           middleware.py
           responses.py
           requests.py
        infrastructure
           services
              ...  # Services that use third party libraries or services (e.g. email service)
           databases
              ...  # Database adapaters and initialization
           repositories
              ...  # Repositories for interacting with the databases
           models
              ...  # Database models
        domain
           constants.py
           exceptions.py
           models
              ...  # Business logic models
        services
            ...  # Services for interacting with the domain (business logic)
        app.py
        config.py
        cors.py
        create_app.py
        dependency_container.py
        error_handler.py
        logging.py
```

## Domain Layer

## Services Layer

## Infrastructure Layer

## ORM  c trin khai trong Flask python 
nh x cc class python --> Table CSDL
</file>

<file path="apps/api/README.md">
# Syllabus Management System (SMD) - Backend 

## Description
A RESTful API built with **Flask** following a **Clean Architecture** style for managing university course syllabuses. The backend supports creating syllabuses, defining Course Learning Outcomes (CLOs), managing teaching plans, assessment schemes, rubrics, and an approval workflow with history logging.

---

## Tech Stack 
- **Framework:** Flask
- **Database:** MS SQL Server (accessed via SQLAlchemy + pymssql)
- **Architecture:** Clean Architecture (Controller  Service  Repository  Model)
- **DI Container:** dependency-injector
- **Serialization/Validation:** Marshmallow
- **Documentation:** Swagger UI (Flasgger)

---

## Key Features 
- **Master Data Management:** Faculties, Departments, Subjects, Academic Years, Programs, Users, Roles
- **Syllabus Management:** Create / Update syllabus header and general info (time allocation, prerequisites, versioning)
- **Syllabus Components:**
  - **CLOs:** Manage Course Learning Outcomes
  - **Materials:** Manage textbooks and references
  - **Teaching Plan:** Weekly schedule and activities
- **Assessment System:**
  - Define **Schemes** (Progress, Midterm, Final)
  - Define **Components** (Quiz, Lab, Exam)
  - **Rubrics:** Detailed scoring criteria
  - **Mapping:** Map assessment components to CLOs
- **Workflow:** Submit  Approve / Reject process with **WorkflowLog** history
- **Auth (Demo):** Basic auth controller returning a demo token; token decorator available for protecting endpoints

---

## Project Structure (brief)
```
src/
 api/                # HTTP controllers, schemas, middleware, swagger
   controllers/     # Blueprints for each resource
   schemas/         # Marshmallow schemas
 services/           # Business logic (services)
 infrastructure/     # DB models, repositories, DB adapters
   models/
   repositories/
 domain/             # Domain models/constants/exceptions
 scripts/            # Helper scripts (seed data, etc.)
 dependency_container.py  # DI wiring
 app.py              # App factory + blueprint registration
```

## Setup & Installation 

Follow these steps to get the backend running locally.

1. Clone the repository

```bash
git clone https://github.com/vux311/Backend_SMD.git
cd Backend_SMD
```

2. Create a virtual environment and activate it

```bash
python -m venv .venv
# Windows (PowerShell)
.venv\Scripts\Activate.ps1
# macOS / Linux
source .venv/bin/activate
```

3. Install dependencies

```bash
pip install -r src/requirements.txt
```

4. Environment variables

Create a `.env` file inside the `src/` folder containing at least:

```env
# Flask
SECRET_KEY=your_secret_key

# Database (SQLAlchemy URL)
DATABASE_URI=mssql+pymssql://sa:YourPassword@127.0.0.1:1433/YourDatabase
```

5. Database (MS SQL Server) via Docker (example)

```bash
docker pull mcr.microsoft.com/mssql/server:2025-latest
docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=YourPassword" -p 1433:1433 --name sql1 -d mcr.microsoft.com/mssql/server:2025-latest
```

---

## Seeding Data (Important) 

A seed script creates default roles and an example syllabus (Admin, Lecturer, Subject, sample CLOs, materials).

Run from repository root:

```bash
python -m src.scripts.seed_users
```

The script is idempotent and can be re-run safely.

---

## Running the App 

Start the development server:

```bash
python src/app.py
```

- Default port: **9999**
- Swagger UI: **http://localhost:9999/docs**

---

## API Documentation

Interactive API specification is available at the Swagger UI endpoint above. Use it to explore endpoints, request/response schemas, and try sample requests.

---

## Project Notes & Next Steps 

- Authentication included in a demo form (dummy tokens). For production, integrate full JWT-based auth and role-based access control.
- Recommended: add automated tests (unit + integration) and CI checks (linting/tests) for PR validation.

---

If you'd like, I can add a CONTRIBUTING guide, CI pipeline, or a small integration test that exercises the workflow (submit  approve/reject).
</file>

<file path="apps/api/repomix-output.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
default.db
docs/flask-clean-architecture.md
README.md
scripts/check_imports.py
scripts/run_postgres.sh
scripts/seed_users.py
scripts/test_login.js
scripts/test_login.py
seed_all_data.py
src/api/controllers/academic_year_controller.py
src/api/controllers/ai_controller.py
src/api/controllers/assessment_clo_controller.py
src/api/controllers/assessment_component_controller.py
src/api/controllers/assessment_scheme_controller.py
src/api/controllers/auth_controller.py
src/api/controllers/clo_plo_mapping_controller.py
src/api/controllers/dashboard_controller.py
src/api/controllers/department_controller.py
src/api/controllers/faculty_controller.py
src/api/controllers/file_controller.py
src/api/controllers/notification_controller.py
src/api/controllers/program_controller.py
src/api/controllers/program_outcome_controller.py
src/api/controllers/role_controller.py
src/api/controllers/rubric_controller.py
src/api/controllers/student_controller.py
src/api/controllers/subject_controller.py
src/api/controllers/subject_relationship_controller.py
src/api/controllers/syllabus_clo_controller.py
src/api/controllers/syllabus_comment_controller.py
src/api/controllers/syllabus_controller.py
src/api/controllers/syllabus_material_controller.py
src/api/controllers/system_setting_controller.py
src/api/controllers/teaching_plan_controller.py
src/api/controllers/user_controller.py
src/api/middleware.py
src/api/requests.py
src/api/responses.py
src/api/routes.py
src/api/schemas/...  # Marshmallow schemas
src/api/schemas/academic_year_schema.py
src/api/schemas/assessment_clo_mapping_schema.py
src/api/schemas/assessment_component_schema.py
src/api/schemas/assessment_scheme_schema.py
src/api/schemas/base_schema.py
src/api/schemas/clo_plo_mapping_schema.py
src/api/schemas/department_schema.py
src/api/schemas/faculty_schema.py
src/api/schemas/file_schema.py
src/api/schemas/notification_schema.py
src/api/schemas/program_outcome_schema.py
src/api/schemas/program_schema.py
src/api/schemas/role_schema.py
src/api/schemas/rubric_schema.py
src/api/schemas/student_schema.py
src/api/schemas/subject_relationship_schema.py
src/api/schemas/subject_schema.py
src/api/schemas/syllabus_clo_schema.py
src/api/schemas/syllabus_comment_schema.py
src/api/schemas/syllabus_detail_schema.py
src/api/schemas/syllabus_material_schema.py
src/api/schemas/syllabus_schema.py
src/api/schemas/system_setting_schema.py
src/api/schemas/teaching_plan_schema.py
src/api/schemas/user_schema.py
src/api/schemas/user.py
src/api/schemas/workflow_log_schema.py
src/api/swagger.py
src/app_logging.py
src/app.py
src/config.py
src/cors.py
src/create_app.py
src/default.db
src/dependency_container.py
src/domain/constants.py
src/domain/exceptions.py
src/domain/models/...  # Business logic models
src/domain/models/user.py
src/error_handler.py
src/infrastructure/databases/__init__.py
src/infrastructure/databases/base.py
src/infrastructure/databases/mssql.py
src/infrastructure/databases/mysql.py
src/infrastructure/models/__init__.py
src/infrastructure/models/academic_year_model.py
src/infrastructure/models/ai_auditlog_model.py
src/infrastructure/models/assessment_clo_model.py
src/infrastructure/models/assessment_component_model.py
src/infrastructure/models/assessment_scheme_model.py
src/infrastructure/models/clo_plo_mapping_model.py
src/infrastructure/models/department_model.py
src/infrastructure/models/faculty_model.py
src/infrastructure/models/file_model.py
src/infrastructure/models/notification_model.py
src/infrastructure/models/notification_template_model.py
src/infrastructure/models/program_model.py
src/infrastructure/models/program_outcome_model.py
src/infrastructure/models/role_model.py
src/infrastructure/models/rubric_model.py
src/infrastructure/models/student_report_model.py
src/infrastructure/models/student_subscription_model.py
src/infrastructure/models/subject_model.py
src/infrastructure/models/subject_relationship_model.py
src/infrastructure/models/syllabus_clo_model.py
src/infrastructure/models/syllabus_comment_model.py
src/infrastructure/models/syllabus_current_workflow.py
src/infrastructure/models/syllabus_material_model.py
src/infrastructure/models/syllabus_model.py
src/infrastructure/models/system_auditlog_model.py
src/infrastructure/models/system_setting_model.py
src/infrastructure/models/teaching_plan_model.py
src/infrastructure/models/user_model.py
src/infrastructure/models/user_role_model.py
src/infrastructure/models/workflow_log_model.py
src/infrastructure/models/workflow_state_model.py
src/infrastructure/models/workflow_transition_model.py
src/infrastructure/repositories/academic_year_repository.py
src/infrastructure/repositories/ai_auditlog_repository.py
src/infrastructure/repositories/assessment_clo_repository.py
src/infrastructure/repositories/assessment_component_repository.py
src/infrastructure/repositories/assessment_scheme_repository.py
src/infrastructure/repositories/clo_plo_mapping_repository.py
src/infrastructure/repositories/department_repository.py
src/infrastructure/repositories/faculty_repository.py
src/infrastructure/repositories/file_repository.py
src/infrastructure/repositories/notification_repository.py
src/infrastructure/repositories/program_outcome_repository.py
src/infrastructure/repositories/program_repository.py
src/infrastructure/repositories/role_repository.py
src/infrastructure/repositories/rubric_repository.py
src/infrastructure/repositories/student_report_repository.py
src/infrastructure/repositories/student_subscription_repository.py
src/infrastructure/repositories/subject_relationship_repository.py
src/infrastructure/repositories/subject_repository.py
src/infrastructure/repositories/syllabus_clo_repository.py
src/infrastructure/repositories/syllabus_comment_repository.py
src/infrastructure/repositories/syllabus_material_repository.py
src/infrastructure/repositories/syllabus_repository.py
src/infrastructure/repositories/system_setting_repository.py
src/infrastructure/repositories/teaching_plan_repository.py
src/infrastructure/repositories/user_repository.py
src/infrastructure/repositories/workflow_log_repository.py
src/infrastructure/services/...  # Services that use third party libraries or services (e.g. email service)
src/migrations
src/README.md
src/requirements.txt
src/scripts/import_check.py
src/scripts/run_postgres.sh
src/scripts/seed_users.py
src/SDM-workspace.code-workspace
src/services/...  # Services for interacting with the domain (business logic)
src/services/academic_year_service.py
src/services/ai_service.py
src/services/assessment_clo_service.py
src/services/assessment_component_service.py
src/services/assessment_scheme_service.py
src/services/clo_plo_mapping_service.py
src/services/department_service.py
src/services/faculty_service.py
src/services/file_service.py
src/services/notification_service.py
src/services/program_outcome_service.py
src/services/program_service.py
src/services/role_service.py
src/services/rubric_service.py
src/services/student_service.py
src/services/subject_relationship_service.py
src/services/subject_service.py
src/services/syllabus_clo_service.py
src/services/syllabus_comment_service.py
src/services/syllabus_material_service.py
src/services/syllabus_service.py
src/services/system_setting_service.py
src/services/teaching_plan_service.py
src/services/user_service.py
src/swagger_config.json
src/tests/test_file_service.py
src/tests/test_program_outcome_service.py
src/tests/test_smoke_imports.py
src/tests/test_syllabus_service.py
tests/e2e_test_flow.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[codz]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py.cover
.hypothesis/
.pytest_cache/
cover/

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/

# PyBuilder
.pybuilder/
target/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
#   For a library or package, you might want to ignore these files since the code is
#   intended to run in multiple environments; otherwise, check them in:
# .python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# UV
#   Similar to Pipfile.lock, it is generally recommended to include uv.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#uv.lock

# poetry
#   Similar to Pipfile.lock, it is generally recommended to include poetry.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#   https://python-poetry.org/docs/basic-usage/#commit-your-poetrylock-file-to-version-control
#poetry.lock
#poetry.toml

# pdm
#   Similar to Pipfile.lock, it is generally recommended to include pdm.lock in version control.
#   pdm recommends including project-wide configuration in pdm.toml, but excluding .pdm-python.
#   https://pdm-project.org/en/latest/usage/project/#working-with-version-control
#pdm.lock
#pdm.toml
.pdm-python
.pdm-build/

# pixi
#   Similar to Pipfile.lock, it is generally recommended to include pixi.lock in version control.
#pixi.lock
#   Pixi creates a virtual environment in the .pixi directory, just like venv module creates one
#   in the .venv directory. It is recommended not to include this directory in version control.
.pixi

# PEP 582; used by e.g. github.com/David-OConnor/pyflow and github.com/pdm-project/pdm
__pypackages__/

# Celery stuff
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
.env
.envrc
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# pytype static type analyzer
.pytype/

# Cython debug symbols
cython_debug/

# PyCharm
#  JetBrains specific template is maintained in a separate JetBrains.gitignore that can
#  be found at https://github.com/github/gitignore/blob/main/Global/JetBrains.gitignore
#  and can be added to the global gitignore or merged into this file.  For a more nuclear
#  option (not recommended) you can uncomment the following to ignore the entire idea folder.
#.idea/

# Abstra
# Abstra is an AI-powered process automation framework.
# Ignore directories containing user credentials, local state, and settings.
# Learn more at https://abstra.io/docs
.abstra/

# Visual Studio Code
#  Visual Studio Code specific template is maintained in a separate VisualStudioCode.gitignore 
#  that can be found at https://github.com/github/gitignore/blob/main/Global/VisualStudioCode.gitignore
#  and can be added to the global gitignore or merged into this file. However, if you prefer, 
#  you could uncomment the following to ignore the entire vscode folder
# .vscode/

# Ruff stuff:
.ruff_cache/

# PyPI configuration file
.pypirc

# Cursor
#  Cursor is an AI-powered code editor. `.cursorignore` specifies files/directories to
#  exclude from AI features like autocomplete and code analysis. Recommended for sensitive data
#  refer to https://docs.cursor.com/context/ignore-files
.cursorignore
.cursorindexingignore

# Marimo
marimo/_static/
marimo/_lsp/
__marimo__/
</file>

<file path="docs/flask-clean-architecture.md">
# Architecture

```bash
     migrations
     scripts
        run_postgres.sh
     src
        api
           controllers
              ...  # controllers for the api
           schemas
              ...  # Marshmallow schemas
           middleware.py
           responses.py
           requests.py
        infrastructure
           services
              ...  # Services that use third party libraries or services (e.g. email service)
           databases
              ...  # Database adapaters and initialization
           repositories
              ...  # Repositories for interacting with the databases
           models
              ...  # Database models
        domain
           constants.py
           exceptions.py
           models
              ...  # Business logic models
        services
            ...  # Services for interacting with the domain (business logic)
        app.py
        config.py
        cors.py
        create_app.py
        dependency_container.py
        error_handler.py
        logging.py
```

## Domain Layer

## Services Layer

## Infrastructure Layer

## ORM  c trin khai trong Flask python 
nh x cc class python --> Table CSDL
</file>

<file path="scripts/check_imports.py">
import importlib
modules = [
    'src.infrastructure.databases',
    'src.api.routes',
    'src.create_app'
]

for m in modules:
    try:
        importlib.import_module(m)
        print(f'{m}: OK')
    except Exception as e:
        print(f'{m}: {type(e).__name__}: {e}')
</file>

<file path="scripts/run_postgres.sh">
#!/bin/bash

# Function to check if PostgreSQL is running
is_postgres_running() {
    pg_isready -q
    return $?
}

# Start PostgreSQL if it's not already running
if ! is_postgres_running; then
    echo "PostgreSQL is not running. Starting it now..."
    pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start
else
    echo "PostgreSQL is already running."
fi

# Create the database if it doesn't exist
if ! psql -lqt | cut -d \| -f 1 | grep -qw dbname; then
    createdb dbname
fi
</file>

<file path="scripts/seed_users.py">
from dependency_container import Container
from datetime import date


def get_or_create(service, list_method_name, check_attr, check_value, create_method_name, create_data):
    list_method = getattr(service, list_method_name)
    for item in list_method():
        if getattr(item, check_attr) == check_value:
            return item
    create_method = getattr(service, create_method_name)
    return create_method(create_data)


def seed():
    container = Container()

    # Services
    role_service = container.role_service()
    user_service = container.user_service()
    faculty_service = container.faculty_service()
    department_service = container.department_service()
    academic_year_service = container.academic_year_service()
    program_service = container.program_service()
    subject_service = container.subject_service()
    syllabus_service = container.syllabus_service()
    syllabus_clo_service = container.syllabus_clo_service()
    syllabus_material_service = container.syllabus_material_service()

    # 1) Roles
    admin_role = role_service.get_by_name('ADMIN') or role_service.create_role({'name': 'ADMIN', 'description': 'ADMIN role'})
    print('  Role:', admin_role.name)
    lecturer_role = role_service.get_by_name('LECTURER') or role_service.create_role({'name': 'LECTURER', 'description': 'LECTURER role'})
    print('  Role:', lecturer_role.name)

    # 2) Users
    admin = user_service.get_by_username('admin')
    if not admin:
        admin = user_service.create_user({'username': 'admin', 'email': 'admin@example.com', 'full_name': 'Admin User', 'password': 'password123', 'is_active': True})
        print('  Created User: admin')
    else:
        print('  Found User: admin')

    lecturer = user_service.get_by_username('lecturer')
    if not lecturer:
        lecturer = user_service.create_user({'username': 'lecturer', 'email': 'lecturer@example.com', 'full_name': 'Lecturer User', 'password': 'password123', 'is_active': True})
        print('  Created User: lecturer')
    else:
        print('  Found User: lecturer')

    # Assign roles idempotently
    session = container.db_session()
    from infrastructure.models.user_role_model import UserRole

    def ensure_role(user, role):
        if not session.query(UserRole).filter_by(user_id=user.id, role_id=role.id).first():
            try:
                session.add(UserRole(user_id=user.id, role_id=role.id))
                session.commit()
                print(f"  Assigned role {role.name} to user {user.username}")
            except Exception:
                session.rollback()

    ensure_role(admin, admin_role)
    ensure_role(lecturer, lecturer_role)

    # 3) Faculty & Department
    faculty = get_or_create(faculty_service, 'list_faculties', 'code', 'FIT', 'create_faculty', {'code': 'FIT', 'name': 'Faculty of Information Technology'})
    print(f"  Faculty: {faculty.code} - {faculty.name}")

    department = None
    # department needs faculty_id
    for d in department_service.list_departments():
        if d.code == 'SE' and d.faculty_id == faculty.id:
            department = d
            break
    if not department:
        department = department_service.create_department({'faculty_id': faculty.id, 'code': 'SE', 'name': 'Software Engineering'})
        print('  Created Department: SE')
    else:
        print('  Found Department: SE')

    # 4) Academic Year, Program, Subject
    academic_year = get_or_create(academic_year_service, 'list_academic_years', 'code', '2025-2026', 'create_academic_year', {'code': '2025-2026', 'start_date': date(2025,9,1), 'end_date': date(2026,6,30)})
    print(f"  AcademicYear: {academic_year.code}")

    program = get_or_create(program_service, 'list_programs', 'name', 'Software Engineering K18', 'create_program', {'department_id': department.id, 'name': 'Software Engineering K18', 'total_credits': 120})
    print(f"  Program: {program.name}")

    subject = None
    for s in subject_service.list_subjects():
        if s.code == 'SWT301' and s.department_id == department.id:
            subject = s
            break
    if not subject:
        subject = subject_service.create_subject({'department_id': department.id, 'code': 'SWT301', 'name_vi': 'Gii thiu K thut Phn mm', 'name_en': 'Introduction to Software Engineering', 'credits': 3})
        print('  Created Subject: SWT301')
    else:
        print('  Found Subject: SWT301')

    # 5) Syllabus
    syllabus = None
    for sy in syllabus_service.list_syllabuses():
        if sy.subject_id == subject.id and sy.program_id == program.id and sy.academic_year_id == academic_year.id:
            syllabus = sy
            break
    if not syllabus:
        syllabus = syllabus_service.create_syllabus({'subject_id': subject.id, 'program_id': program.id, 'academic_year_id': academic_year.id, 'lecturer_id': lecturer.id, 'version': '1.0'})
        print(f"  Created Syllabus ID: {syllabus.id}")
    else:
        print(f"  Found Syllabus ID: {syllabus.id}")

    # 6) Syllabus Details - CLOs
    existing_clos = {c.code for c in syllabus_clo_service.get_by_syllabus(syllabus.id)}
    clos_to_add = [
        {'code': 'CLO1', 'description': 'Explain software lifecycle.'},
        {'code': 'CLO2', 'description': 'Apply software requirements engineering.'},
        {'code': 'CLO3', 'description': 'Design basic software architecture.'},
    ]
    for clo in clos_to_add:
        if clo['code'] not in existing_clos:
            item = syllabus_clo_service.create_clo({'syllabus_id': syllabus.id, **clo})
            print(f"  Added CLO: {item.code}")
        else:
            print(f"  CLO exists: {clo['code']}")

    # Materials
    existing_mats = {m.title for m in syllabus_material_service.get_by_syllabus(syllabus.id)}
    mats_to_add = [
        {'type': 'MAIN', 'title': 'Software Engineering (Textbook)', 'author': 'Ian Sommerville', 'publisher': 'Pearson', 'isbn': '1234567890', 'syllabus_id': syllabus.id},
        {'type': 'REFERENCE', 'title': 'Design Patterns', 'author': 'Gamma et al.', 'publisher': 'Addison-Wesley', 'isbn': '0987654321', 'syllabus_id': syllabus.id},
    ]
    for mat in mats_to_add:
        if mat['title'] not in existing_mats:
            item = syllabus_material_service.create_material(mat)
            print(f"  Added Material: {item.title}")
        else:
            print(f"  Material exists: {mat['title']}")

    # Teaching Plans
    teaching_plan_service = container.teaching_plan_service()
    existing_weeks = {p.week for p in teaching_plan_service.list_plans_for_syllabus(syllabus.id)}
    plans_to_add = [
        {'week': 1, 'topic': 'Introduction to Software Engineering', 'activity': 'Lecture', 'assessment': 'Quiz', 'syllabus_id': syllabus.id},
        {'week': 2, 'topic': 'Software Process Models', 'activity': 'Lecture', 'assessment': 'Assignment 1', 'syllabus_id': syllabus.id},
        {'week': 3, 'topic': 'Requirements Engineering', 'activity': 'Lecture', 'assessment': 'Assignment 2', 'syllabus_id': syllabus.id},
    ]
    for plan in plans_to_add:
        if plan['week'] not in existing_weeks:
            item = teaching_plan_service.create_teaching_plan(plan)
            print(f"  Added Teaching Plan Week: {item.week}")
        else:
            print(f"  Teaching Plan exists for week: {plan['week']}")

    # Assessments: Schemes, Components, Rubrics, CLO mappings
    assessment_scheme_service = container.assessment_scheme_service()
    assessment_component_service = container.assessment_component_service()
    rubric_service = container.rubric_service()
    assessment_clo_service = container.assessment_clo_service()

    existing_schemes = {s.name for s in assessment_scheme_service.list_schemes_for_syllabus(syllabus.id)}

    # Example scheme: Midterm
    if 'Midterm' not in existing_schemes:
        scheme = assessment_scheme_service.create_scheme({'syllabus_id': syllabus.id, 'name': 'Midterm', 'weight': 30.0})
        print(f"  Created Assessment Scheme: {scheme.name}")
        comp = assessment_component_service.create_component({'scheme_id': scheme.id, 'name': 'Midterm Exam', 'weight': 30.0})
        print(f"  Created Assessment Component: {comp.name}")
        rubric = rubric_service.create_rubric({'component_id': comp.id, 'criteria': 'Comprehensive exam', 'max_score': 100})
        print(f"  Created Rubric for component: {rubric.criteria}")
        # Map to CLO1 if exists
        clo1 = None
        for c in syllabus_clo_service.get_by_syllabus(syllabus.id):
            if c.code == 'CLO1':
                clo1 = c
                break
        if clo1:
            assessment_clo_service.add_mapping(comp.id, clo1.id)
            print(f"  Mapped component {comp.name} to CLO {clo1.code}")
    else:
        print('  Midterm scheme exists')

    print('\n  Seeding complete!')


if __name__ == '__main__':
    seed()
</file>

<file path="scripts/test_login.js">
const axios = require('axios');

axios.post('http://localhost:9999/auth/login', { username: 'gv1', password: '123456' })
  .then(res => {
    console.log('status', res.status);
    console.log('data', res.data);
  })
  .catch(err => {
    if (err.response) {
      console.error('status', err.response.status);
      console.error(err.response.data);
    } else {
      console.error('error', err.message);
    }
    process.exit(1);
  });
</file>

<file path="scripts/test_login.py">
import requests

r = requests.post('http://localhost:9999/auth/login', json={'username':'gv1','password':'123456'})
print('status:', r.status_code)
print('headers:', r.headers)
print('body:', r.text)
</file>

<file path="src/api/controllers/academic_year_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.academic_year_service import AcademicYearService
from api.schemas.academic_year_schema import AcademicYearSchema

academic_year_bp = Blueprint('academic_year', __name__, url_prefix='/academic-years')

schema = AcademicYearSchema()

@academic_year_bp.route('/', methods=['GET'])
@inject
def list_academic_years(academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    """Get all academic years
    ---
    get:
      summary: Get all academic years
      tags:
        - AcademicYears
      responses:
        200:
          description: List of academic years
    """
    items = academic_year_service.list_academic_years()
    return jsonify(schema.dump(items, many=True)), 200

@academic_year_bp.route('/', methods=['POST'])
@inject
def create_academic_year(academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    """Create a new academic year
    ---
    post:
      summary: Create an academic year
      tags:
        - AcademicYears
      requestBody:
        required: true
      responses:
        201:
          description: Created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    ay = academic_year_service.create_academic_year(data)
    return jsonify(schema.dump(ay)), 201

@academic_year_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_academic_year(id: int, academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    ay = academic_year_service.update_academic_year(id, data)
    if not ay:
        return jsonify({'message': 'AcademicYear not found'}), 404
    return jsonify(schema.dump(ay)), 200

@academic_year_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_academic_year(id: int, academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    ok = academic_year_service.delete_academic_year(id)
    if not ok:
        return jsonify({'message': 'AcademicYear not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/ai_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.ai_service import AiService

ai_bp = Blueprint('ai', __name__, url_prefix='/ai')

@ai_bp.route('/generate', methods=['POST'])
@inject
def generate(ai_service: AiService = Provide[Container.ai_service]):
    data = request.get_json() or {}
    subject_name = data.get('subject_name')
    if not subject_name:
        return jsonify({'message': 'subject_name is required'}), 400

    res = ai_service.generate(subject_name)
    if isinstance(res, dict) and res.get('error'):
        return jsonify({'message': res.get('error')}), 500

    return jsonify(res), 200
</file>

<file path="src/api/controllers/dashboard_controller.py">
from flask import Blueprint, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_service import SyllabusService
from services.user_service import UserService

dashboard_bp = Blueprint('dashboard', __name__, url_prefix='/stats')

@dashboard_bp.route('/', methods=['GET'])
@inject
def get_stats(syllabus_service: SyllabusService = Provide[Container.syllabus_service], user_service: UserService = Provide[Container.user_service]):
    syllabuses = syllabus_service.list_syllabuses() or []
    users = user_service.list_users() or []

    total_syllabuses = len(syllabuses)
    total_users = len(users)

    # Group by status
    stats_by_status = {
        'Approved': 0,
        'Pending': 0,
        'Draft': 0,
        'Returned': 0
    }
    for s in syllabuses:
        status = getattr(s, 'status', None) or getattr(s, 'state', None) or 'Draft'
        # Normalize
        if status.upper() in ('APPROVED',):
            stats_by_status['Approved'] += 1
        elif 'PENDING' in status.upper():
            stats_by_status['Pending'] += 1
        elif status.upper() in ('RETURNED', 'REJECTED'):
            stats_by_status['Returned'] += 1
        else:
            stats_by_status['Draft'] += 1

    return jsonify({
        'total_syllabuses': total_syllabuses,
        'total_users': total_users,
        'by_status': stats_by_status
    }), 200
</file>

<file path="src/api/controllers/department_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.department_service import DepartmentService
from api.schemas.department_schema import DepartmentSchema

department_bp = Blueprint('department', __name__, url_prefix='/departments')

schema = DepartmentSchema()

@department_bp.route('/', methods=['GET'])
@inject
def list_departments(department_service: DepartmentService = Provide[Container.department_service]):
    """Get all departments
    ---
    get:
      summary: Get all departments
      tags:
        - Departments
      responses:
        200:
          description: List of departments
    """
    departments = department_service.list_departments()
    return jsonify(schema.dump(departments, many=True)), 200

@department_bp.route('/<int:id>', methods=['GET'])
@inject
def get_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Get department by id
    ---
    get:
      summary: Get department by ID
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Department object
        404:
          description: Not found
    """
    department = department_service.get_department(id)
    if not department:
        return jsonify({'message': 'Department not found'}), 404
    return jsonify(schema.dump(department)), 200

@department_bp.route('/', methods=['POST'])
@inject
def create_department(department_service: DepartmentService = Provide[Container.department_service]):
    """Create a new department
    ---
    post:
      summary: Create a new department
      tags:
        - Departments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Department'
      responses:
        201:
          description: Department created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    department = department_service.create_department(data)
    return jsonify(schema.dump(department)), 201

@department_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Update an existing department
    ---
    put:
      summary: Update department
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Department'
      responses:
        200:
          description: Department updated
        400:
          description: Invalid input
        404:
          description: Department not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    department = department_service.update_department(id, data)
    if not department:
        return jsonify({'message': 'Department not found'}), 404
    return jsonify(schema.dump(department)), 200

@department_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Delete department
    ---
    delete:
      summary: Delete department
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Department not found
    """
    ok = department_service.delete_department(id)
    if not ok:
        return jsonify({'message': 'Department not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/faculty_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.faculty_service import FacultyService
from api.schemas.faculty_schema import FacultySchema

faculty_bp = Blueprint('faculty', __name__, url_prefix='/faculties')

schema = FacultySchema()

@faculty_bp.route('/', methods=['GET'])
@inject
def list_faculties(faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Get all faculties
    ---
    get:
      summary: Get all faculties
      tags:
        - Faculties
      responses:
        200:
          description: List of faculties
    """
    faculties = faculty_service.list_faculties()
    return jsonify(schema.dump(faculties, many=True)), 200

@faculty_bp.route('/<int:id>', methods=['GET'])
@inject
def get_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Get faculty by id
    ---
    get:
      summary: Get faculty by ID
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Faculty object
        404:
          description: Not found
    """
    faculty = faculty_service.get_faculty(id)
    if not faculty:
        return jsonify({'message': 'Faculty not found'}), 404
    return jsonify(schema.dump(faculty)), 200

@faculty_bp.route('/', methods=['POST'])
@inject
def create_faculty(faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Create a new faculty
    ---
    post:
      summary: Create a new faculty
      tags:
        - Faculties
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Faculty'
      responses:
        201:
          description: Faculty created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    faculty = faculty_service.create_faculty(data)
    return jsonify(schema.dump(faculty)), 201

@faculty_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Update an existing faculty
    ---
    put:
      summary: Update faculty
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Faculty'
      responses:
        200:
          description: Faculty updated
        400:
          description: Invalid input
        404:
          description: Faculty not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    faculty = faculty_service.update_faculty(id, data)
    if not faculty:
        return jsonify({'message': 'Faculty not found'}), 404
    return jsonify(schema.dump(faculty)), 200

@faculty_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Delete faculty
    ---
    delete:
      summary: Delete faculty
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Faculty not found
    """
    ok = faculty_service.delete_faculty(id)
    if not ok:
        return jsonify({'message': 'Faculty not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/file_controller.py">
from flask import Blueprint, request, jsonify, send_file
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.file_service import FileService
from api.schemas.file_schema import FileSchema
import os

file_bp = Blueprint('file', __name__, url_prefix='/files')
schema = FileSchema()

@file_bp.route('/upload', methods=['POST'])
@inject
def upload_file(service: FileService = Provide[Container.file_service]):
    if 'file' not in request.files:
        return jsonify({'error': 'No file part'}), 400
    file = request.files['file']
    # Demo: assume user_id=1 if no auth (In production, get from token)
    user_id = request.form.get('user_id', 1) 
    try:
        record = service.upload_file(file, int(user_id))
        return jsonify(schema.dump(record)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@file_bp.route('/<int:id>', methods=['GET'])
@inject
def download_file(id: int, service: FileService = Provide[Container.file_service]):
    record = service.get_file(id)
    if not record:
        return jsonify({'message': 'File not found'}), 404
    try:
        return send_file(os.path.abspath(record.file_path), as_attachment=True, download_name=record.file_name)
    except Exception:
        return jsonify({'message': 'File not found on disk'}), 404
</file>

<file path="src/api/controllers/program_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.program_service import ProgramService
from api.schemas.program_schema import ProgramSchema

program_bp = Blueprint('program', __name__, url_prefix='/programs')

schema = ProgramSchema()

@program_bp.route('/', methods=['GET'])
@inject
def list_programs(program_service: ProgramService = Provide[Container.program_service]):
    """Get all programs
    ---
    get:
      summary: Get all programs
      tags:
        - Programs
      responses:
        200:
          description: List of programs
    """
    items = program_service.list_programs()
    return jsonify(schema.dump(items, many=True)), 200

@program_bp.route('/', methods=['POST'])
@inject
def create_program(program_service: ProgramService = Provide[Container.program_service]):
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    p = program_service.create_program(data)
    return jsonify(schema.dump(p)), 201

@program_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_program(id: int, program_service: ProgramService = Provide[Container.program_service]):
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    p = program_service.update_program(id, data)
    if not p:
        return jsonify({'message': 'Program not found'}), 404
    return jsonify(schema.dump(p)), 200

@program_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_program(id: int, program_service: ProgramService = Provide[Container.program_service]):
    ok = program_service.delete_program(id)
    if not ok:
        return jsonify({'message': 'Program not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/program_outcome_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.program_outcome_service import ProgramOutcomeService
from api.schemas.program_outcome_schema import ProgramOutcomeSchema

program_outcome_bp = Blueprint('program_outcome', __name__, url_prefix='/program-outcomes')
schema = ProgramOutcomeSchema()

@program_outcome_bp.route('/program/<int:program_id>', methods=['GET'])
@inject
def list_plos(program_id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    items = service.list_by_program(program_id)
    return jsonify(schema.dump(items, many=True)), 200

@program_outcome_bp.route('/', methods=['POST'])
@inject
def create_plo(service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_plo(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@program_outcome_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_plo(id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    data = request.get_json() or {}
    item = service.update_plo(id, data)
    if not item:
        return jsonify({'message': 'PLO not found'}), 404
    return jsonify(schema.dump(item)), 200

@program_outcome_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_plo(id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    ok = service.delete_plo(id)
    if not ok:
        return jsonify({'message': 'PLO not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/role_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.role_service import RoleService
from api.schemas.role_schema import RoleSchema

role_bp = Blueprint('role', __name__, url_prefix='/roles')

schema = RoleSchema()

@role_bp.route('/', methods=['GET'])
@inject
def list_roles(role_service: RoleService = Provide[Container.role_service]):
    """Get all roles
    ---
    get:
      summary: Get all roles
      tags:
        - Roles
      responses:
        200:
          description: List of roles
    """
    roles = role_service.list_roles()
    return jsonify(schema.dump(roles, many=True)), 200

@role_bp.route('/', methods=['POST'])
@inject
def create_role(role_service: RoleService = Provide[Container.role_service]):
    """Create a new role
    ---
    post:
      summary: Create a new role
      tags:
        - Roles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        201:
          description: Role created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    role = role_service.create_role(data)
    return jsonify(schema.dump(role)), 201
</file>

<file path="src/api/requests.py">
# requests.py

from flask import request, jsonify

def get_request_data():
    """Extracts and returns JSON data from the request."""
    data = request.get_json()
    if not data:
        return jsonify({"error": "No data provided"}), 400
    return data

def validate_request_schema(schema):
    """Validates the incoming request data against the provided schema."""
    data = get_request_data()
    errors = schema.validate(data)
    if errors:
        return jsonify({"errors": errors}), 400
    return data

def handle_get_request():
    """Handles GET requests."""
    # Logic for handling GET requests goes here
    pass

def handle_post_request():
    """Handles POST requests."""
    # Logic for handling POST requests goes here
    pass

def handle_put_request():
    """Handles PUT requests."""
    # Logic for handling PUT requests goes here
    pass

def handle_delete_request():
    """Handles DELETE requests."""
    # Logic for handling DELETE requests goes here
    pass
</file>

<file path="src/api/responses.py">
# src/api/responses.py

from flask import jsonify

def success_response(data, message="Success"):
    return jsonify({"message": message, "data": data}), 200

def error_response(message="An error occurred", status_code=400):
    return jsonify({"message": message}), status_code

def not_found_response(message="Resource not found"):
    return jsonify({"message": message}), 404

def validation_error_response(errors):
    return jsonify({"message": "Validation errors", "errors": errors}), 422
</file>

<file path="src/api/schemas/...  # Marshmallow schemas">
# This file is intentionally left blank.
</file>

<file path="src/api/schemas/academic_year_schema.py">
from marshmallow import Schema, fields

class AcademicYearSchema(Schema):
    id = fields.Int(dump_only=True)
    code = fields.Str(required=True)
    start_date = fields.Date(required=True)
    end_date = fields.Date(required=True)
</file>

<file path="src/api/schemas/assessment_clo_mapping_schema.py">
from marshmallow import Schema, fields

class AssessmentCloMappingSchema(Schema):
    assessment_component_id = fields.Int(required=True)
    syllabus_clo_id = fields.Int(required=True)
</file>

<file path="src/api/schemas/base_schema.py">
from marshmallow import Schema, post_dump
import re

def snake_to_camel(s: str) -> str:
    parts = s.split('_')
    return parts[0] + ''.join(p.capitalize() for p in parts[1:])

def _convert(obj):
    if isinstance(obj, dict):
        new = {}
        for k, v in obj.items():
            nk = snake_to_camel(k)
            new[nk] = _convert(v)
        return new
    elif isinstance(obj, list):
        return [_convert(x) for x in obj]
    else:
        return obj

class BaseSchema(Schema):
    @post_dump
    def to_camel(self, data, many=False, **kwargs):
        # marshmallow may or may not pass `many`; accept it optionally
        if many and isinstance(data, list):
            return [_convert(x) for x in data]
        return _convert(data)
</file>

<file path="src/api/schemas/clo_plo_mapping_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import OneOf

class CloPloMappingSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_clo_id = fields.Int(required=True)
    program_plo_id = fields.Int(required=True)
    level = fields.Str(required=True, validate=OneOf(['I', 'R', 'M', 'A']))
</file>

<file path="src/api/schemas/department_schema.py">
from marshmallow import Schema, fields

class DepartmentSchema(Schema):
    id = fields.Int(dump_only=True)
    faculty_id = fields.Int(required=True)
    code = fields.Str(required=True)
    name = fields.Str(required=True)
</file>

<file path="src/api/schemas/faculty_schema.py">
from marshmallow import Schema, fields

class FacultySchema(Schema):
    id = fields.Int(dump_only=True)
    code = fields.Str(required=True)
    name = fields.Str(required=True)
    # Optional fields example: use load_default for Marshmallow
    description = fields.Str(load_default=None)
</file>

<file path="src/api/schemas/file_schema.py">
from marshmallow import Schema, fields

class FileSchema(Schema):
    id = fields.Int(dump_only=True)
    uploader_id = fields.Int(dump_only=True)
    file_name = fields.Str(dump_only=True)
    file_path = fields.Str(dump_only=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="src/api/schemas/notification_schema.py">
from marshmallow import Schema, fields

class NotificationSchema(Schema):
    id = fields.Int(dump_only=True)
    user_id = fields.Int(required=True)
    title = fields.Str(required=True)
    message = fields.Str(load_default=None)
    link = fields.Str(load_default=None)
    is_read = fields.Bool(dump_only=True)
    type = fields.Str(load_default='SYSTEM')
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="src/api/schemas/program_outcome_schema.py">
from marshmallow import Schema, fields

class ProgramOutcomeSchema(Schema):
    id = fields.Int(dump_only=True)
    program_id = fields.Int(required=True)
    code = fields.Str(required=True)
    description = fields.Str(required=True)
</file>

<file path="src/api/schemas/program_schema.py">
from marshmallow import Schema, fields

class ProgramSchema(Schema):
    id = fields.Int(dump_only=True)
    department_id = fields.Int(required=True)
    name = fields.Str(required=True)
    total_credits = fields.Int(load_default=0)
</file>

<file path="src/api/schemas/role_schema.py">
from marshmallow import Schema, fields

class RoleSchema(Schema):
    id = fields.Int(dump_only=True)
    name = fields.Str(required=True)
    description = fields.Str(load_default=None)
</file>

<file path="src/api/schemas/rubric_schema.py">
from marshmallow import Schema, fields

class RubricSchema(Schema):
    id = fields.Int(dump_only=True)
    component_id = fields.Int(required=True)
    criteria = fields.Str(required=True)
    max_score = fields.Float(required=True)
    description_level_pass = fields.Str(load_default=None)
    description_level_fail = fields.Str(load_default=None)
</file>

<file path="src/api/schemas/student_schema.py">
from marshmallow import Schema, fields

class StudentSubscriptionSchema(Schema):
    id = fields.Int(dump_only=True)
    student_id = fields.Int(required=True)
    subject_id = fields.Int(required=True)
    created_at = fields.DateTime(dump_only=True)

class StudentReportSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    student_id = fields.Int(required=True)
    content = fields.Str(required=True)
    status = fields.Str(dump_only=True)
    admin_note = fields.Str(load_default=None)
</file>

<file path="src/api/schemas/subject_relationship_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import OneOf

class SubjectRelationshipSchema(Schema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    related_subject_id = fields.Int(required=True)
    type = fields.Str(required=True, validate=OneOf(['PREREQUISITE', 'COREQUISITE', 'PARALLEL']))
</file>

<file path="src/api/schemas/syllabus_clo_schema.py">
from marshmallow import Schema, fields

class SyllabusCloSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    code = fields.Str(required=True)
    description = fields.Str(required=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="src/api/schemas/syllabus_comment_schema.py">
from marshmallow import Schema, fields

class SyllabusCommentSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    user_id = fields.Int(required=True)
    content = fields.Str(required=True)
    parent_id = fields.Int(load_default=None)
    is_resolved = fields.Bool(dump_only=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="src/api/schemas/syllabus_material_schema.py">
from marshmallow import Schema, fields

class SyllabusMaterialSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    type = fields.Str(required=True)
    title = fields.Str(required=True)
    author = fields.Str(load_default=None)
    publisher = fields.Str(load_default=None)
    isbn = fields.Str(load_default=None)
    url = fields.Str(load_default=None)
</file>

<file path="src/api/schemas/system_setting_schema.py">
from marshmallow import Schema, fields

class SystemSettingSchema(Schema):
    key = fields.Str(required=True)
    value = fields.Str(required=True)
    type = fields.Str(dump_only=True)
    description = fields.Str(load_default=None)
</file>

<file path="src/api/schemas/teaching_plan_schema.py">
from marshmallow import Schema, fields

class TeachingPlanSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    week = fields.Int(required=True)
    topic = fields.Str(load_default=None)
    activity = fields.Str(load_default=None)
    assessment = fields.Str(load_default=None)
    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)
</file>

<file path="src/api/schemas/user.py">

</file>

<file path="src/api/schemas/workflow_log_schema.py">
from marshmallow import Schema, fields

class WorkflowLogSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    actor_id = fields.Int(required=True)
    action = fields.Str(required=True)
    from_status = fields.Str(load_default=None)
    to_status = fields.Str(load_default=None)
    comment = fields.Str(load_default=None)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="src/app_logging.py">
import logging

def setup_logging():
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler("app.log"),
            logging.StreamHandler()
        ]
    )

setup_logging()
</file>

<file path="src/create_app.py">
from flask import Flask
from .config import Config
from .api.middleware import setup_middleware
from .api.routes import register_routes
from .infrastructure.databases import init_db
from .app_logging import setup_logging

def create_app():
    app = Flask(__name__)
    app.config.from_object(Config)

    setup_logging(app)
    init_db(app)
    setup_middleware(app)
    register_routes(app)

    return app
</file>

<file path="src/domain/constants.py">
# Constants

# Define any constants used throughout the application here. 
# For example, you might define API version, error messages, or configuration keys.

API_VERSION = "v1"
DEFAULT_PAGE_SIZE = 20
MAX_PAGE_SIZE = 100

# Add more constants as needed for your application.
</file>

<file path="src/domain/exceptions.py">
class CustomException(Exception):
    """Base class for all custom exceptions in the application."""
    pass

class NotFoundException(CustomException):
    """Exception raised when a resource is not found."""
    def __init__(self, message="Resource not found"):
        self.message = message
        super().__init__(self.message)

class ValidationException(CustomException):
    """Exception raised for validation errors."""
    def __init__(self, message="Validation error"):
        self.message = message
        super().__init__(self.message)

class UnauthorizedException(CustomException):
    """Exception raised for unauthorized access."""
    def __init__(self, message="Unauthorized access"):
        self.message = message
        super().__init__(self.message)

class ConflictException(CustomException):
    """Exception raised for conflicts in the application."""
    def __init__(self, message="Conflict occurred"):
        self.message = message
        super().__init__(self.message)
</file>

<file path="src/domain/models/...  # Business logic models">
# This file is intentionally left blank.
</file>

<file path="src/domain/models/user.py">
from sqlalchemy import Column, Integer, String, DateTime, Boolean
from infrastructure.databases.base import Base

class User:
    
    def __innit__(self, user_name: str, password: str, description: str = None, status: bool = True):
        self.user_name = user_name
        self.password = password
        self.description = description
        self.status = status
        self.created_at = None
        self.updated_at = None
</file>

<file path="src/error_handler.py">
# Error handling logic for the Flask application

from flask import jsonify

class CustomError(Exception):
    status_code = 400

    def __init__(self, message, status_code=None):
        super().__init__(message)
        if status_code is not None:
            self.status_code = status_code
        self.message = message

    def to_dict(self):
        return {'message': self.message}

def handle_error(error):
    if isinstance(error, CustomError):
        response = jsonify(error.to_dict())
        response.status_code = error.status_code
        return response

    response = jsonify({'message': 'An unexpected error occurred.'})
    response.status_code = 500
    return response

def register_error_handlers(app):
    app.register_error_handler(Exception, handle_error)
</file>

<file path="src/infrastructure/databases/base.py">
from sqlalchemy.orm import declarative_base

Base = declarative_base()


# ORM: object relational mapping base class
# OOP : object oriented programming

# ERD --> class relational
# Lp trinhf hng i tng (logic) mapping class -> table (database)
</file>

<file path="src/infrastructure/databases/mysql.py">

</file>

<file path="src/infrastructure/repositories/academic_year_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.academic_year_model import AcademicYear

class AcademicYearRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[AcademicYear]:
        return self.session.query(AcademicYear).all()

    def get_by_id(self, id: int) -> Optional[AcademicYear]:
        return self.session.query(AcademicYear).filter_by(id=id).first()

    def create(self, data: dict) -> AcademicYear:
        ay = AcademicYear(**data)
        self.session.add(ay)
        self.session.commit()
        self.session.refresh(ay)
        return ay

    def update(self, id: int, data: dict) -> Optional[AcademicYear]:
        ay = self.get_by_id(id)
        if not ay:
            return None
        for key, value in data.items():
            if hasattr(ay, key):
                setattr(ay, key, value)
        self.session.commit()
        self.session.refresh(ay)
        return ay

    def delete(self, id: int) -> bool:
        ay = self.get_by_id(id)
        if not ay:
            return False
        self.session.delete(ay)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/ai_auditlog_repository.py">
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.ai_auditlog_model import AiAuditLog

class AiAuditLogRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, syllabus_id: int, action: str, input_tokens: int, output_tokens: int):
        log = AiAuditLog(syllabus_id=syllabus_id, action=action, input_tokens=input_tokens, output_tokens=output_tokens)
        self.session.add(log)
        self.session.commit()
        return log
</file>

<file path="src/infrastructure/repositories/assessment_clo_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_clo_model import AssessmentClo
from infrastructure.models.syllabus_clo_model import SyllabusClo

class AssessmentCloRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def add_mapping(self, component_id: int, syllabus_clo_id: int) -> AssessmentClo:
        mapping = AssessmentClo(assessment_component_id=component_id, syllabus_clo_id=syllabus_clo_id)
        self.session.add(mapping)
        self.session.commit()
        return mapping

    def remove_mapping(self, component_id: int, syllabus_clo_id: int) -> bool:
        mapping = self.session.query(AssessmentClo).filter_by(assessment_component_id=component_id, syllabus_clo_id=syllabus_clo_id).first()
        if not mapping:
            return False
        self.session.delete(mapping)
        self.session.commit()
        return True

    def get_clos_by_component(self, component_id: int) -> List[SyllabusClo]:
        mappings = self.session.query(AssessmentClo).filter_by(assessment_component_id=component_id).all()
        return [m.syllabus_clo for m in mappings]
</file>

<file path="src/infrastructure/repositories/assessment_component_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_component_model import AssessmentComponent

class AssessmentComponentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[AssessmentComponent]:
        return self.session.query(AssessmentComponent).filter_by(id=id).first()

    def create(self, data: dict) -> AssessmentComponent:
        item = AssessmentComponent(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[AssessmentComponent]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/assessment_scheme_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session, joinedload
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_scheme_model import AssessmentScheme

class AssessmentSchemeRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[AssessmentScheme]:
        return self.session.query(AssessmentScheme).all()

    def get_by_id(self, id: int) -> Optional[AssessmentScheme]:
        return self.session.query(AssessmentScheme).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[AssessmentScheme]:
        # Load components eagerly
        return self.session.query(AssessmentScheme).options(joinedload(AssessmentScheme.components)).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> AssessmentScheme:
        s = AssessmentScheme(**data)
        self.session.add(s)
        self.session.commit()
        self.session.refresh(s)
        return s

    def update(self, id: int, data: dict) -> Optional[AssessmentScheme]:
        s = self.get_by_id(id)
        if not s:
            return None
        for k, v in data.items():
            if hasattr(s, k):
                setattr(s, k, v)
        self.session.commit()
        self.session.refresh(s)
        return s

    def delete(self, id: int) -> bool:
        s = self.get_by_id(id)
        if not s:
            return False
        self.session.delete(s)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/clo_plo_mapping_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.clo_plo_mapping_model import CloPloMapping

class CloPloMappingRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[CloPloMapping]:
        return self.session.query(CloPloMapping).filter_by(id=id).first()

    def get_by_syllabus_clo(self, syllabus_clo_id: int) -> List[CloPloMapping]:
        return self.session.query(CloPloMapping).filter_by(syllabus_clo_id=syllabus_clo_id).all()

    def create(self, data: dict) -> CloPloMapping:
        item = CloPloMapping(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/department_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.department_model import Department

class DepartmentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Department]:
        return self.session.query(Department).all()

    def get_by_id(self, id: int) -> Optional[Department]:
        return self.session.query(Department).filter_by(id=id).first()

    def create(self, data: dict) -> Department:
        department = Department(**data)
        self.session.add(department)
        self.session.commit()
        self.session.refresh(department)
        return department

    def update(self, id: int, data: dict) -> Optional[Department]:
        department = self.get_by_id(id)
        if not department:
            return None
        for key, value in data.items():
            if hasattr(department, key):
                setattr(department, key, value)
        self.session.commit()
        self.session.refresh(department)
        return department

    def delete(self, id: int) -> bool:
        department = self.get_by_id(id)
        if not department:
            return False
        self.session.delete(department)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/faculty_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.faculty_model import Faculty

class FacultyRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Faculty]:
        return self.session.query(Faculty).all()

    def get_by_id(self, id: int) -> Optional[Faculty]:
        return self.session.query(Faculty).filter_by(id=id).first()

    def create(self, data: dict) -> Faculty:
        faculty = Faculty(**data)
        self.session.add(faculty)
        self.session.commit()
        self.session.refresh(faculty)
        return faculty

    def update(self, id: int, data: dict) -> Optional[Faculty]:
        faculty = self.get_by_id(id)
        if not faculty:
            return None
        for key, value in data.items():
            if hasattr(faculty, key):
                setattr(faculty, key, value)
        self.session.commit()
        self.session.refresh(faculty)
        return faculty

    def delete(self, id: int) -> bool:
        faculty = self.get_by_id(id)
        if not faculty:
            return False
        self.session.delete(faculty)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/file_repository.py">
from typing import Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.file_model import File

class FileRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[File]:
        return self.session.query(File).filter_by(id=id).first()

    def create(self, data: dict) -> File:
        file_record = File(**data)
        self.session.add(file_record)
        self.session.commit()
        self.session.refresh(file_record)
        return file_record

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/notification_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.notification_model import Notification

class NotificationRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_user(self, user_id: int, limit: int = 20, unread_only: bool = False) -> List[Notification]:
        query = self.session.query(Notification).filter_by(user_id=user_id)
        if unread_only:
            query = query.filter_by(is_read=False)
        return query.order_by(Notification.created_at.desc()).limit(limit).all()

    def create(self, data: dict) -> Notification:
        item = Notification(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def mark_as_read(self, id: int) -> bool:
        item = self.session.query(Notification).filter_by(id=id).first()
        if not item:
            return False
        item.is_read = True
        self.session.commit()
        return True

    def mark_all_as_read(self, user_id: int):
        self.session.query(Notification).filter_by(user_id=user_id, is_read=False).update({'is_read': True})
        self.session.commit()
</file>

<file path="src/infrastructure/repositories/program_outcome_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.program_outcome_model import ProgramOutcome

class ProgramOutcomeRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[ProgramOutcome]:
        return self.session.query(ProgramOutcome).filter_by(id=id).first()

    def get_by_program_id(self, program_id: int) -> List[ProgramOutcome]:
        return self.session.query(ProgramOutcome).filter_by(program_id=program_id).all()

    def create(self, data: dict) -> ProgramOutcome:
        item = ProgramOutcome(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[ProgramOutcome]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/program_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.program_model import Program

class ProgramRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Program]:
        return self.session.query(Program).all()

    def get_by_id(self, id: int) -> Optional[Program]:
        return self.session.query(Program).filter_by(id=id).first()

    def create(self, data: dict) -> Program:
        p = Program(**data)
        self.session.add(p)
        self.session.commit()
        self.session.refresh(p)
        return p

    def update(self, id: int, data: dict) -> Optional[Program]:
        p = self.get_by_id(id)
        if not p:
            return None
        for key, value in data.items():
            if hasattr(p, key):
                setattr(p, key, value)
        self.session.commit()
        self.session.refresh(p)
        return p

    def delete(self, id: int) -> bool:
        p = self.get_by_id(id)
        if not p:
            return False
        self.session.delete(p)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/role_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.role_model import Role

class RoleRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Role]:
        return self.session.query(Role).all()

    def get_by_id(self, id: int) -> Optional[Role]:
        return self.session.query(Role).filter_by(id=id).first()

    def get_by_name(self, name: str) -> Optional[Role]:
        return self.session.query(Role).filter_by(name=name).first()

    def create(self, data: dict) -> Role:
        role = Role(**data)
        self.session.add(role)
        self.session.commit()
        self.session.refresh(role)
        return role

    def delete(self, id: int) -> bool:
        role = self.get_by_id(id)
        if not role:
            return False
        self.session.delete(role)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/rubric_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.rubric_model import Rubric

class RubricRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[Rubric]:
        return self.session.query(Rubric).filter_by(id=id).first()

    def get_by_component_id(self, component_id: int) -> List[Rubric]:
        return self.session.query(Rubric).filter_by(component_id=component_id).all()

    def create(self, data: dict) -> Rubric:
        item = Rubric(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[Rubric]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/student_report_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.student_report_model import StudentReport

class StudentReportRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, data: dict) -> StudentReport:
        item = StudentReport(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def get_all(self) -> List[StudentReport]:
        return self.session.query(StudentReport).all()

    def update_status(self, id: int, status: str, admin_note: str = None):
        item = self.session.query(StudentReport).filter_by(id=id).first()
        if item:
            item.status = status
            if admin_note: item.admin_note = admin_note
            self.session.commit()
            self.session.refresh(item)
        return item
</file>

<file path="src/infrastructure/repositories/student_subscription_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.student_subscription_model import StudentSubscription

class StudentSubscriptionRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, user_id: int, subject_id: int):
        # Check exists
        exists = self.session.query(StudentSubscription).filter_by(student_id=user_id, subject_id=subject_id).first()
        if exists: return exists
        
        item = StudentSubscription(student_id=user_id, subject_id=subject_id)
        self.session.add(item)
        self.session.commit()
        return item

    def delete(self, user_id: int, subject_id: int):
        item = self.session.query(StudentSubscription).filter_by(student_id=user_id, subject_id=subject_id).first()
        if item:
            self.session.delete(item)
            self.session.commit()
            return True
        return False

    def get_by_student(self, user_id: int) -> List[StudentSubscription]:
        return self.session.query(StudentSubscription).filter_by(student_id=user_id).all()
</file>

<file path="src/infrastructure/repositories/subject_relationship_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.subject_relationship_model import SubjectRelationship

class SubjectRelationshipRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[SubjectRelationship]:
        return self.session.query(SubjectRelationship).filter_by(id=id).first()

    def get_by_subject(self, subject_id: int) -> List[SubjectRelationship]:
        return self.session.query(SubjectRelationship).filter_by(subject_id=subject_id).all()

    def create(self, data: dict) -> SubjectRelationship:
        item = SubjectRelationship(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/subject_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.subject_model import Subject

class SubjectRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Subject]:
        return self.session.query(Subject).all()

    def get_by_id(self, id: int) -> Optional[Subject]:
        return self.session.query(Subject).filter_by(id=id).first()

    def create(self, data: dict) -> Subject:
        subject = Subject(**data)
        self.session.add(subject)
        self.session.commit()
        self.session.refresh(subject)
        return subject

    def update(self, id: int, data: dict) -> Optional[Subject]:
        subject = self.get_by_id(id)
        if not subject:
            return None
        for key, value in data.items():
            if hasattr(subject, key):
                setattr(subject, key, value)
        self.session.commit()
        self.session.refresh(subject)
        return subject

    def delete(self, id: int) -> bool:
        subject = self.get_by_id(id)
        if not subject:
            return False
        self.session.delete(subject)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/syllabus_clo_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_clo_model import SyllabusClo

class SyllabusCloRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SyllabusClo]:
        return self.session.query(SyllabusClo).all()

    def get_by_id(self, id: int) -> Optional[SyllabusClo]:
        return self.session.query(SyllabusClo).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[SyllabusClo]:
        return self.session.query(SyllabusClo).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> SyllabusClo:
        item = SyllabusClo(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[SyllabusClo]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/syllabus_comment_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_comment_model import SyllabusComment

class SyllabusCommentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[SyllabusComment]:
        return self.session.query(SyllabusComment).filter_by(id=id).first()

    def get_by_syllabus(self, syllabus_id: int) -> List[SyllabusComment]:
        return self.session.query(SyllabusComment).filter_by(syllabus_id=syllabus_id).order_by(SyllabusComment.created_at.asc()).all()

    def create(self, data: dict) -> SyllabusComment:
        item = SyllabusComment(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[SyllabusComment]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/syllabus_material_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_material_model import SyllabusMaterial

class SyllabusMaterialRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).all()

    def get_by_id(self, id: int) -> Optional[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> SyllabusMaterial:
        item = SyllabusMaterial(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/system_setting_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.system_setting_model import SystemSetting

class SystemSettingRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SystemSetting]:
        return self.session.query(SystemSetting).all()

    def get_by_key(self, key: str) -> Optional[SystemSetting]:
        return self.session.query(SystemSetting).filter_by(key=key).first()

    def set_value(self, key: str, value: str, description: str = None, type: str = 'STRING') -> SystemSetting:
        setting = self.get_by_key(key)
        if setting:
            setting.value = value
            if description: setting.description = description
        else:
            setting = SystemSetting(key=key, value=value, type=type, description=description)
            self.session.add(setting)
        self.session.commit()
        self.session.refresh(setting)
        return setting
</file>

<file path="src/infrastructure/repositories/teaching_plan_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.teaching_plan_model import TeachingPlan

class TeachingPlanRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[TeachingPlan]:
        return self.session.query(TeachingPlan).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[TeachingPlan]:
        return self.session.query(TeachingPlan).filter_by(syllabus_id=syllabus_id).order_by(TeachingPlan.week).all()

    def create(self, data: dict) -> TeachingPlan:
        item = TeachingPlan(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[TeachingPlan]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/workflow_log_repository.py">
from typing import List
from infrastructure.models.workflow_log_model import WorkflowLog

class WorkflowLogRepository:
    def __init__(self, session):
        self.session = session

    def create(self, data: dict):
        wl = WorkflowLog(**data)
        self.session.add(wl)
        try:
            self.session.commit()
            self.session.refresh(wl)
            return wl
        except Exception:
            self.session.rollback()
            raise

    def get_by_syllabus_id(self, syllabus_id: int) -> List[WorkflowLog]:
        return self.session.query(WorkflowLog).filter_by(syllabus_id=syllabus_id).order_by(WorkflowLog.created_at.asc()).all()
</file>

<file path="src/infrastructure/services/...  # Services that use third party libraries or services (e.g. email service)">
# This file is intentionally left blank.
</file>

<file path="src/migrations">
# This directory contains database migration files.
</file>

<file path="src/README.md">
# Flask Clean Architecture

This project is structured using the Clean Architecture principles, which promotes separation of concerns and maintainability. Below is an overview of the project's structure and its components.

## Directory Structure

- **migrations/**: Contains database migration files.
- **scripts/**: Contains scripts for running and managing the application, such as `run_postgres.sh` for PostgreSQL.
- **api/**: Contains the API-related components.
  - **controllers/**: Controllers for handling API requests.
  - **schemas/**: Marshmallow schemas for data validation and serialization.
  - **middleware.py**: Middleware functions for processing requests and responses.
  - **responses.py**: Functions for handling API responses.
  - **requests.py**: Functions for handling API requests.
- **infrastructure/**: Contains components that interact with external systems.
  - **services/**: Services that use third-party libraries or services (e.g., email service).
  - **databases/**: Database adapters and initialization code.
  - **repositories/**: Repositories for interacting with the databases.
  - **models/**: Database models.
- **domain/**: Contains the core business logic.
  - **constants.py**: Constants used throughout the application.
  - **exceptions.py**: Custom exceptions for the application.
  - **models/**: Business logic models.
- **services/**: Services for interacting with the domain (business logic).
- **app.py**: The main entry point of the application, initializing the app and setting up routes.
- **config.py**: Configuration settings for the application.
- **cors.py**: Handles Cross-Origin Resource Sharing (CORS) settings.
- **create_app.py**: Factory function to create the Flask application instance.
- **dependency_container.py**: Manages dependency injection for the application.
- **error_handler.py**: Defines error handling logic for the application.
- **logging.py**: Sets up logging configurations for the application.

## Getting Started

To get started with the project, ensure you have the necessary dependencies installed and follow the setup instructions provided in the respective files. 

## Contributing

Contributions are welcome! Please follow the contribution guidelines outlined in the project documentation.
</file>

<file path="src/scripts/import_check.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src
try:
    import services.syllabus_service as ss
    import services.ai_service as ai
    import api.schemas.syllabus_schema as sch
    import services.program_outcome_service as plo_svc
    import api.controllers.program_outcome_controller as plo_ctrl
    import services.file_service as file_svc
    import api.controllers.file_controller as file_ctrl
    import services.clo_plo_mapping_service as mapping_svc
    import api.controllers.clo_plo_mapping_controller as mapping_ctrl
    import services.subject_relationship_service as rel_svc
    import api.controllers.subject_relationship_controller as rel_ctrl
    import services.syllabus_comment_service as comment_svc
    import api.controllers.syllabus_comment_controller as comment_ctrl
    import services.notification_service as notif_svc
    import api.controllers.notification_controller as notif_ctrl
    import infrastructure.repositories.ai_auditlog_repository as audit_repo
    import services.system_setting_service as ss_svc
    import api.controllers.system_setting_controller as ss_ctrl
    import services.student_service as student_svc
    import api.controllers.student_controller as student_ctrl
    print('IMPORT_OK')
except Exception as e:
    print('IMPORT_FAIL', repr(e))
    raise
</file>

<file path="src/scripts/run_postgres.sh">
#!/bin/bash

# Function to check if PostgreSQL is running
is_postgres_running() {
    pg_isready -q
    return $?
}

# Start PostgreSQL if it's not already running
if ! is_postgres_running; then
    echo "PostgreSQL is not running. Starting it now..."
    pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start
else
    echo "PostgreSQL is already running."
fi

# Create the database if it doesn't exist
if ! psql -lqt | cut -d \| -f 1 | grep -qw dbname; then
    createdb dbname
fi
</file>

<file path="src/SDM-workspace.code-workspace">
{
	"folders": [
		{
			"path": ".."
		},
		{
			"path": "../../FE_SDM"
		}
	]
}
</file>

<file path="src/services/...  # Services for interacting with the domain (business logic)">
# This file is intentionally left blank.
</file>

<file path="src/services/academic_year_service.py">
from typing import List, Optional
from infrastructure.repositories.academic_year_repository import AcademicYearRepository

class AcademicYearService:
    def __init__(self, repository: AcademicYearRepository):
        self.repository = repository

    def list_academic_years(self) -> List:
        return self.repository.get_all()

    def get_academic_year(self, id: int):
        return self.repository.get_by_id(id)

    def create_academic_year(self, data: dict):
        return self.repository.create(data)

    def update_academic_year(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_academic_year(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/ai_service.py">
import os
import json
from datetime import datetime

# Prefer the new `google-genai` package (import path: `google.genai` via `from google import genai`).
# Fall back to legacy `google.generativeai` if needed for compatibility.
try:
    # New package (preferred)
    from google import genai
    _NEW_GENAI = True
except Exception:
    try:
        # Legacy package
        import google.generativeai as genai
        _NEW_GENAI = False
    except Exception:
        genai = None
        _NEW_GENAI = False

class AiService:
    def __init__(self, api_key: str = None, audit_repository=None):
        self.api_key = api_key or os.getenv('GEMINI_API_KEY')
        self.audit_repository = audit_repository

    def _log_usage(self, syllabus_id, action, in_tok, out_tok):
        if self.audit_repository and syllabus_id:
            try:
                self.audit_repository.create(syllabus_id, action, in_tok, out_tok)
            except Exception as e:
                print(f'Failed to log AI usage: {e}')

    def generate(self, subject_name: str, syllabus_id: int = None):
        if not self.api_key:
            return {"error": "Cha cu hnh GEMINI_API_KEY"}

        if genai is None:
            return {"error": "No generative AI client installed (install google-genai)"}

        # Strict Template
        json_template = {
            "subject_name_vi": subject_name,
            "subject_name_en": "...",
            "credits": 3,
            "time_allocation": { "theory": 30, "practice": 30, "self_study": 90 },
            "description": "...",
            "clos": [
                { "code": "CLO1", "description": "..." }
            ],
            "materials": [
                { "type": "MAIN", "title": "...", "author": "...", "publisher": "...", "isbn": "..." }
            ],
            "teaching_plans": [
                { "week": 1, "topic": "...", "activity": "...", "assessment": "..." }
            ],
            "assessment_schemes": [
                { 
                    "name": "Midterm", "weight": 50, 
                    "components": [
                        { "name": "Exam 1", "weight": 100, "rubrics": [{"criteria": "...", "max_score": 10}] }
                    ] 
                }
            ]
        }

        prompt = f"""
        You are a curriculum expert. Create a syllabus for: "{subject_name}".
        OUTPUT REQUIREMENT: Return ONLY valid raw JSON. No markdown, no explanations.
        The JSON structure MUST match this template exactly:
        {json.dumps(json_template, ensure_ascii=False)}
        """

        try:
            if _NEW_GENAI:
                # New `google-genai` client APIs can vary by version. Try several common interfaces defensively.
                # Some versions provide a module-level `configure` and helpers; others provide a `Client` class.
                if hasattr(genai, "configure"):
                    try:
                        genai.configure(api_key=self.api_key)
                    except Exception:
                        # Some versions accept different config methods  ignore and continue to client creation
                        pass

                resp_text = None

                # Preferred: Client.generate_text(...) pattern
                if hasattr(genai, "Client"):
                    client = genai.Client()
                    response = client.generate_text(model="gemini-2.5-flash", input=prompt)
                    resp_text = getattr(response, "text", None)
                    if not resp_text and getattr(response, "candidates", None):
                        candidates = getattr(response, "candidates", [])
                        if candidates:
                            resp_text = getattr(candidates[0], "output", None) or getattr(candidates[0], "content", None)

                # Fallback: module-level generate_text
                if resp_text is None and hasattr(genai, "generate_text"):
                    response = genai.generate_text(model="gemini-2.5-flash", input=prompt)
                    resp_text = getattr(response, "text", None)
                    if not resp_text and getattr(response, "candidates", None):
                        candidates = getattr(response, "candidates", [])
                        if candidates:
                            resp_text = getattr(candidates[0], "output", None) or getattr(candidates[0], "content", None)

                # Last resort: string conversion
                if resp_text is None:
                    resp_text = str(response)

            else:
                # Legacy package behavior
                genai.configure(api_key=self.api_key)
                model = genai.GenerativeModel('gemini-2.5-flash')
                response = model.generate_content(prompt)
                resp_text = getattr(response, "text", "")

            clean_text = resp_text.replace("```json", "").replace("```", "").strip()
            # Simple token estimation (fallback if client does not provide usage)
            try:
                input_tokens = max(0, len(prompt.split()))
                output_tokens = max(0, len(clean_text.split()))
            except Exception:
                input_tokens = 0
                output_tokens = 0

            # Log usage if syllabus_id provided
            self._log_usage(syllabus_id, 'GENERATE', input_tokens, output_tokens)

            return json.loads(clean_text)
        except Exception as e:
            # Attempt to log error usage with zero tokens (if applicable)
            try:
                self._log_usage(syllabus_id, 'ERROR', 0, 0)
            except Exception:
                pass
            return {"error": str(e)}
</file>

<file path="src/services/assessment_component_service.py">
from typing import Optional
from infrastructure.repositories.assessment_component_repository import AssessmentComponentRepository

class AssessmentComponentService:
    def __init__(self, repository: AssessmentComponentRepository, scheme_repository=None):
        self.repository = repository
        self.scheme_repository = scheme_repository

    def get_component(self, id: int):
        return self.repository.get_by_id(id)

    def create_component(self, data: dict):
        scheme_id = data.get('scheme_id')
        if not scheme_id or not self.scheme_repository.get_by_id(scheme_id):
            raise ValueError('Invalid scheme_id')
        return self.repository.create(data)

    def update_component(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_component(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/assessment_scheme_service.py">
from typing import List, Optional
from infrastructure.repositories.assessment_scheme_repository import AssessmentSchemeRepository

class AssessmentSchemeService:
    def __init__(self, repository: AssessmentSchemeRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_schemes_for_syllabus(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus_id(syllabus_id)

    def get_scheme(self, id: int):
        return self.repository.get_by_id(id)

    def create_scheme(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_scheme(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_scheme(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/clo_plo_mapping_service.py">
from typing import List
from infrastructure.repositories.clo_plo_mapping_repository import CloPloMappingRepository

class CloPloMappingService:
    def __init__(self, repository: CloPloMappingRepository, syllabus_clo_repository=None, program_outcome_repository=None):
        self.repository = repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.program_outcome_repository = program_outcome_repository

    def get_by_clo(self, clo_id: int) -> List:
        return self.repository.get_by_syllabus_clo(clo_id)

    def create_mapping(self, data: dict):
        clo_id = data.get('syllabus_clo_id')
        plo_id = data.get('program_plo_id')
        
        if not self.syllabus_clo_repository.get_by_id(clo_id):
            raise ValueError('Invalid syllabus_clo_id')
        if not self.program_outcome_repository.get_by_id(plo_id):
            raise ValueError('Invalid program_plo_id')
            
        return self.repository.create(data)

    def delete_mapping(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/department_service.py">
from typing import List, Optional
from infrastructure.repositories.department_repository import DepartmentRepository

class DepartmentService:
    def __init__(self, repository: DepartmentRepository):
        self.repository = repository

    def list_departments(self) -> List:
        return self.repository.get_all()

    def get_department(self, id: int):
        return self.repository.get_by_id(id)

    def create_department(self, data: dict):
        return self.repository.create(data)

    def update_department(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_department(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/faculty_service.py">
from typing import List, Optional
from infrastructure.repositories.faculty_repository import FacultyRepository

class FacultyService:
    def __init__(self, repository: FacultyRepository):
        self.repository = repository

    def list_faculties(self) -> List:
        return self.repository.get_all()

    def get_faculty(self, id: int):
        return self.repository.get_by_id(id)

    def create_faculty(self, data: dict):
        return self.repository.create(data)

    def update_faculty(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_faculty(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/file_service.py">
import os
import uuid
from werkzeug.utils import secure_filename
from infrastructure.repositories.file_repository import FileRepository

UPLOAD_FOLDER = 'static/uploads'
ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx'}

class FileService:
    def __init__(self, repository: FileRepository):
        self.repository = repository
        if not os.path.exists(UPLOAD_FOLDER):
            os.makedirs(UPLOAD_FOLDER)

    def _allowed_file(self, filename):
        return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

    def upload_file(self, file_storage, uploader_id: int):
        if not file_storage or file_storage.filename == '':
            raise ValueError('No file selected')
        if not self._allowed_file(file_storage.filename):
            raise ValueError('File type not allowed')

        filename = secure_filename(file_storage.filename)
        unique_name = f"{uuid.uuid4()}_{filename}"
        file_path = os.path.join(UPLOAD_FOLDER, unique_name)
        
        # Save to disk
        file_storage.save(file_path)

        # Save to DB
        file_data = {
            'uploader_id': uploader_id,
            'file_name': filename,
            'file_path': file_path,
            'mime_type': file_storage.mimetype,
            'file_size': 0 # Optional: implement size check
        }
        return self.repository.create(file_data)
        
    def get_file(self, id: int):
        return self.repository.get_by_id(id)
</file>

<file path="src/services/notification_service.py">
from typing import List
from infrastructure.repositories.notification_repository import NotificationRepository

class NotificationService:
    def __init__(self, repository: NotificationRepository, user_repository=None):
        self.repository = repository
        self.user_repository = user_repository

    def get_user_notifications(self, user_id: int, unread_only: bool = False) -> List:
        return self.repository.get_by_user(user_id, unread_only=unread_only)

    def send_notification(self, user_id: int, title: str, message: str, link: str = None, type: str = 'SYSTEM'):
        if self.user_repository and not self.user_repository.get_by_id(user_id):
             raise ValueError('User not found')
        data = {
            'user_id': user_id,
            'title': title,
            'message': message,
            'link': link,
            'type': type,
            'is_read': False
        }
        return self.repository.create(data)

    def mark_read(self, id: int) -> bool:
        return self.repository.mark_as_read(id)

    def mark_all_read(self, user_id: int):
        return self.repository.mark_all_as_read(user_id)
</file>

<file path="src/services/program_outcome_service.py">
from typing import List
from infrastructure.repositories.program_outcome_repository import ProgramOutcomeRepository

class ProgramOutcomeService:
    def __init__(self, repository: ProgramOutcomeRepository, program_repository=None):
        self.repository = repository
        self.program_repository = program_repository

    def list_by_program(self, program_id: int) -> List:
        return self.repository.get_by_program_id(program_id)

    def create_plo(self, data: dict):
        program_id = data.get('program_id')
        if not program_id or not self.program_repository.get_by_id(program_id):
            raise ValueError('Invalid program_id')
        return self.repository.create(data)

    def update_plo(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_plo(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/program_service.py">
from typing import List, Optional
from infrastructure.repositories.program_repository import ProgramRepository

class ProgramService:
    def __init__(self, repository: ProgramRepository):
        self.repository = repository

    def list_programs(self) -> List:
        return self.repository.get_all()

    def get_program(self, id: int):
        return self.repository.get_by_id(id)

    def create_program(self, data: dict):
        return self.repository.create(data)

    def update_program(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_program(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/role_service.py">
from typing import List, Optional
from infrastructure.repositories.role_repository import RoleRepository

class RoleService:
    def __init__(self, repository: RoleRepository):
        self.repository = repository

    def list_roles(self) -> List:
        return self.repository.get_all()

    def get_role(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_name(self, name: str):
        return self.repository.get_by_name(name)

    def create_role(self, data: dict):
        return self.repository.create(data)

    def delete_role(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/rubric_service.py">
from typing import List, Optional
from infrastructure.repositories.rubric_repository import RubricRepository

class RubricService:
    def __init__(self, repository: RubricRepository, component_repository=None):
        self.repository = repository
        self.component_repository = component_repository

    def list_rubrics_for_component(self, component_id: int) -> List:
        return self.repository.get_by_component_id(component_id)

    def get_rubric(self, id: int):
        return self.repository.get_by_id(id)

    def create_rubric(self, data: dict):
        component_id = data.get('component_id')
        if not component_id or not self.component_repository.get_by_id(component_id):
            raise ValueError('Invalid component_id')
        return self.repository.create(data)

    def update_rubric(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_rubric(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/student_service.py">
from typing import List
from infrastructure.repositories.student_subscription_repository import StudentSubscriptionRepository
from infrastructure.repositories.student_report_repository import StudentReportRepository

class StudentService:
    def __init__(self, sub_repo: StudentSubscriptionRepository, report_repo: StudentReportRepository):
        self.sub_repo = sub_repo
        self.report_repo = report_repo

    def subscribe(self, user_id: int, subject_id: int):
        return self.sub_repo.create(user_id, subject_id)

    def unsubscribe(self, user_id: int, subject_id: int):
        return self.sub_repo.delete(user_id, subject_id)

    def get_subscriptions(self, user_id: int):
        return self.sub_repo.get_by_student(user_id)

    def report_syllabus(self, user_id: int, syllabus_id: int, content: str):
        return self.report_repo.create({'student_id': user_id, 'syllabus_id': syllabus_id, 'content': content})

    def list_reports(self):
        return self.report_repo.get_all()

    def resolve_report(self, id: int, status: str, note: str = None):
        return self.report_repo.update_status(id, status, note)
</file>

<file path="src/services/subject_relationship_service.py">
from typing import List
from infrastructure.repositories.subject_relationship_repository import SubjectRelationshipRepository

class SubjectRelationshipService:
    def __init__(self, repository: SubjectRelationshipRepository, subject_repository=None):
        self.repository = repository
        self.subject_repository = subject_repository

    def get_relationships(self, subject_id: int) -> List:
        return self.repository.get_by_subject(subject_id)

    def add_relationship(self, data: dict):
        subject_id = data.get('subject_id')
        related_id = data.get('related_subject_id')
        
        if subject_id == related_id:
            raise ValueError('Subject cannot be related to itself')
        
        if not self.subject_repository.get_by_id(subject_id):
            raise ValueError('Invalid subject_id')
        if not self.subject_repository.get_by_id(related_id):
            raise ValueError('Invalid related_subject_id')
            
        return self.repository.create(data)

    def remove_relationship(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/subject_service.py">
from typing import List, Optional
from infrastructure.repositories.subject_repository import SubjectRepository

class SubjectService:
    def __init__(self, repository: SubjectRepository):
        self.repository = repository

    def list_subjects(self) -> List:
        return self.repository.get_all()

    def get_subject(self, id: int):
        return self.repository.get_by_id(id)

    def create_subject(self, data: dict):
        return self.repository.create(data)

    def update_subject(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_subject(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/syllabus_clo_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_clo_repository import SyllabusCloRepository

class SyllabusCloService:
    def __init__(self, repository: SyllabusCloRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_clos(self) -> List:
        return self.repository.get_all()

    def get_clo(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_syllabus(self, syllabus_id: int):
        return self.repository.get_by_syllabus_id(syllabus_id)

    def create_clo(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_clo(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_clo(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/syllabus_comment_service.py">
from typing import List
from infrastructure.repositories.syllabus_comment_repository import SyllabusCommentRepository

class SyllabusCommentService:
    def __init__(self, repository: SyllabusCommentRepository, syllabus_repository=None, user_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository
        self.user_repository = user_repository

    def get_comments(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus(syllabus_id)

    def add_comment(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        user_id = data.get('user_id')
        
        if not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        if not self.user_repository.get_by_id(user_id):
            raise ValueError('Invalid user_id')
            
        return self.repository.create(data)

    def resolve_comment(self, id: int):
        return self.repository.update(id, {'is_resolved': True})

    def delete_comment(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/syllabus_material_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_material_repository import SyllabusMaterialRepository

class SyllabusMaterialService:
    def __init__(self, repository: SyllabusMaterialRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_materials(self) -> List:
        return self.repository.get_all()

    def get_material(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_syllabus(self, syllabus_id: int):
        return self.repository.get_by_syllabus_id(syllabus_id)

    def create_material(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def delete_material(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/services/system_setting_service.py">
from typing import List, Optional
from infrastructure.repositories.system_setting_repository import SystemSettingRepository

class SystemSettingService:
    def __init__(self, repository: SystemSettingRepository):
        self.repository = repository

    def get_all_settings(self) -> List:
        return self.repository.get_all()

    def update_setting(self, key: str, value: str, description: str = None):
        return self.repository.set_value(key, value, description)
</file>

<file path="src/services/teaching_plan_service.py">
from typing import List, Optional
from infrastructure.repositories.teaching_plan_repository import TeachingPlanRepository

class TeachingPlanService:
    def __init__(self, repository: TeachingPlanRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_plans_for_syllabus(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus_id(syllabus_id)

    def get_plan(self, id: int):
        return self.repository.get_by_id(id)

    def create_teaching_plan(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_teaching_plan(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_teaching_plan(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="src/tests/test_file_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

import os
import tempfile
from services.file_service import FileService, UPLOAD_FOLDER

class StubFileStorage:
    def __init__(self, filename, content=b"data", mimetype='application/octet-stream'):
        self.filename = filename
        self._content = content
        self.mimetype = mimetype

    def save(self, path):
        with open(path, 'wb') as f:
            f.write(self._content)


class StubRepo:
    def __init__(self):
        self.created = None
    def create(self, data):
        self.created = data
        class Item:
            def __init__(self, d):
                self.__dict__.update(d)
        return Item(data)


def test_upload_file_saves_to_disk_and_db(tmp_path, monkeypatch):
    # Use a temp upload folder
    tmp_dir = tmp_path / 'uploads'
    monkeypatch.setattr('services.file_service.UPLOAD_FOLDER', str(tmp_dir))

    repo = StubRepo()
    svc = FileService(repository=repo)

    file_storage = StubFileStorage('test.txt', b'hello', 'text/plain')
    record = svc.upload_file(file_storage, uploader_id=5)

    # Ensure file saved on disk
    assert os.path.exists(record.file_path)
    assert repo.created['uploader_id'] == 5
    assert repo.created['file_name'] == 'test.txt'


def test_upload_rejects_bad_extension():
    repo = StubRepo()
    svc = FileService(repository=repo)
    file_storage = StubFileStorage('test.exe')
    try:
        svc.upload_file(file_storage, uploader_id=1)
        assert False, 'Should raise ValueError for disallowed extension'
    except ValueError:
        pass
</file>

<file path="src/tests/test_program_outcome_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

from services.program_outcome_service import ProgramOutcomeService

class StubRepo:
    def __init__(self):
        self.created = {}
    def create(self, data):
        self.created = data
        return data
    def update(self, id, data):
        return {'id': id, **data}
    def delete(self, id):
        return True

class StubProgramRepo:
    def __init__(self, exists=True):
        self.exists = exists
    def get_by_id(self, id):
        return {'id': id} if self.exists else None


def test_create_plo_requires_valid_program():
    repo = StubRepo()
    program_repo = StubProgramRepo(exists=False)
    svc = ProgramOutcomeService(repository=repo, program_repository=program_repo)
    try:
        svc.create_plo({'program_id': 1, 'code': 'PLO1', 'description': 'd'})
        assert False, 'Should have raised ValueError'
    except ValueError:
        pass

    program_repo = StubProgramRepo(exists=True)
    svc = ProgramOutcomeService(repository=repo, program_repository=program_repo)
    item = svc.create_plo({'program_id': 1, 'code': 'PLO1', 'description': 'd'})
    assert repo.created['code'] == 'PLO1'


def test_update_and_delete_delegates_to_repo():
    repo = StubRepo()
    svc = ProgramOutcomeService(repository=repo)
    updated = svc.update_plo(1, {'code': 'X'})
    assert updated['id'] == 1
    assert svc.delete_plo(1) is True
</file>

<file path="src/tests/test_smoke_imports.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

from dependency_container import Container
from services.syllabus_service import SyllabusService
from services.program_outcome_service import ProgramOutcomeService
from services.file_service import FileService


def test_container_has_services():
    c = Container()
    assert hasattr(c, 'syllabus_service')
    assert hasattr(c, 'program_outcome_service')
    assert hasattr(c, 'file_service')


def test_service_classes_importable():
    assert callable(SyllabusService)
    assert callable(ProgramOutcomeService)
    assert callable(FileService)
</file>

<file path="src/tests/test_syllabus_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

import json
from services.syllabus_service import SyllabusService


class StubRepo:
    def __init__(self):
        self.created = []

    def create(self, data):
        # simulate DB model with id and status
        class Item:
            pass
        item = Item()
        item.id = 123
        item.status = data.get('status', 'DRAFT')
        self.created.append(data)
        return item

    def get_by_id(self, id):
        return None


class StubFKRepo:
    def __init__(self, exists=True):
        self.exists = exists

    def get_by_id(self, id):
        return {'id': id} if self.exists else None


class StubChildRepo:
    def __init__(self):
        self.items = []

    def create(self, data):
        self.items.append(data)
        class Item:
            def __init__(self, data, id):
                self.__dict__.update(data)
                self.id = id
        return Item(data, len(self.items))


def test_create_syllabus_creates_child_entities_and_serializes_time_allocation():
    repo = StubRepo()
    subj = StubFKRepo(True)
    prog = StubFKRepo(True)
    ay = StubFKRepo(True)
    user = StubFKRepo(True)
    clo_repo = StubChildRepo()
    mat_repo = StubChildRepo()
    plan_repo = StubChildRepo()
    scheme_repo = StubChildRepo()
    comp_repo = StubChildRepo()
    rubric_repo = StubChildRepo()

    svc = SyllabusService(
        repository=repo,
        subject_repository=subj,
        program_repository=prog,
        academic_year_repository=ay,
        user_repository=user,
        syllabus_clo_repository=clo_repo,
        syllabus_material_repository=mat_repo,
        teaching_plan_repository=plan_repo,
        assessment_scheme_repository=scheme_repo,
        assessment_component_repository=comp_repo,
        rubric_repository=rubric_repo
    )

    payload = {
        'subject_id': 1,
        'program_id': 1,
        'academic_year_id': 1,
        'lecturer_id': 1,
        'time_allocation': {'theory': 10, 'practice': 20},
        'clos': [{'code': 'C1', 'description': 'desc'}],
        'materials': [{'type': 'MAIN', 'title': 't'}],
        'teaching_plans': [{'week': 1, 'topic': 't'}],
        'assessment_schemes': [
            {
                'name': 'Scheme1',
                'weight': 50,
                'components': [
                    {'name': 'Comp1', 'weight': 100, 'rubrics': [{'criteria': 'r', 'max_score': 10}]}
                ]
            }
        ]
    }

    result = svc.create_syllabus(payload.copy())
    # header created
    assert result.id == 123
    # child repos created
    assert len(clo_repo.items) == 1
    assert len(mat_repo.items) == 1
    assert len(plan_repo.items) == 1
    assert len(scheme_repo.items) == 1
    assert len(comp_repo.items) == 1
    assert len(rubric_repo.items) == 1

    # ensure time_allocation was serialized as JSON in the header create payload
    header_payload = repo.created[0]
    assert isinstance(header_payload['time_allocation'], str)
    parsed = json.loads(header_payload['time_allocation'])
    assert parsed['theory'] == 10


def test_submit_syllabus_allows_returned_case_insensitive():
    class GetRepo:
        def __init__(self, status):
            class Item:
                pass
            self.item = Item()
            self.item.status = status
        def get_by_id(self, id):
            return self.item
        def update(self, id, data):
            return data

    for status in ['returned', 'RETURNED', 'Returned']:
        repo = GetRepo(status)
        svc = SyllabusService(repository=repo)
        updated = svc.submit_syllabus(1, 2)
        assert updated == {'status': 'PENDING'}
</file>

<file path="src/api/controllers/assessment_clo_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_clo_service import AssessmentCloService
from api.schemas.assessment_clo_mapping_schema import AssessmentCloMappingSchema

assessment_clo_bp = Blueprint('assessment_clo_map', __name__, url_prefix='/assessment-clos')

schema = AssessmentCloMappingSchema()

@assessment_clo_bp.route('/component/<int:component_id>', methods=['GET'])
@inject
def list_clos(component_id: int, service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    List CLOs mapped to a component
    ---
    tags:
      - Assessments
    parameters:
      - name: component_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of CLOs (id, code, description)
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: integer
                  code:
                    type: string
                  description:
                    type: string
    """
    items = service.get_clos_for_component(component_id)
    return jsonify([{'id': c.id, 'code': c.code, 'description': c.description} for c in items]), 200

@assessment_clo_bp.route('/', methods=['POST'])
@inject
def add_mapping(service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    Map a CLO to an assessment component
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentCloMapping'
    responses:
      201:
        description: Mapping created
      400:
        description: Validation or integrity error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        mapping = service.add_mapping(data['assessment_component_id'], data['syllabus_clo_id'])
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify({'assessment_component_id': mapping.assessment_component_id, 'syllabus_clo_id': mapping.syllabus_clo_id}), 201

@assessment_clo_bp.route('/', methods=['DELETE'])
@inject
def remove_mapping(service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    Remove a mapping between component and CLO
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentCloMapping'
    responses:
      204:
        description: Mapping removed
      400:
        description: Bad request
      404:
        description: Mapping not found
    """
    data = request.get_json() or {}
    if not data:
        return jsonify({'error': 'Provide JSON body with assessment_component_id and syllabus_clo_id'}), 400
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    ok = service.remove_mapping(data['assessment_component_id'], data['syllabus_clo_id'])
    if not ok:
        return jsonify({'message': 'Mapping not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/assessment_component_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_component_service import AssessmentComponentService
from api.schemas.assessment_component_schema import AssessmentComponentSchema

assessment_component_bp = Blueprint('assessment_component', __name__, url_prefix='/assessment-components')

schema = AssessmentComponentSchema()

@assessment_component_bp.route('/', methods=['POST'])
@inject
def create_component(service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Create an assessment component
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentComponent'
    responses:
      201:
        description: Component created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_component(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@assessment_component_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_component(id: int, service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Update an assessment component
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentComponent'
    responses:
      200:
        description: Component updated
      400:
        description: Validation error
      404:
        description: Component not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = service.update_component(id, data)
    if not item:
        return jsonify({'message': 'Component not found'}), 404
    return jsonify(schema.dump(item)), 200

@assessment_component_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_component(id: int, service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Delete an assessment component
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Component not found
    """
    ok = service.delete_component(id)
    if not ok:
        return jsonify({'message': 'Component not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/assessment_scheme_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_scheme_service import AssessmentSchemeService
from api.schemas.assessment_scheme_schema import AssessmentSchemeSchema

assessment_scheme_bp = Blueprint('assessment_scheme', __name__, url_prefix='/assessment-schemes')

schema = AssessmentSchemeSchema()

@assessment_scheme_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_schemes(syllabus_id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    List assessment schemes for a syllabus
    ---
    tags:
      - Assessments
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of assessment schemes
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/AssessmentScheme'
    """
    items = service.list_schemes_for_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@assessment_scheme_bp.route('/', methods=['POST'])
@inject
def create_scheme(service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Create an assessment scheme
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentScheme'
    responses:
      201:
        description: Scheme created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_scheme(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@assessment_scheme_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_scheme(id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Update an assessment scheme
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentScheme'
    responses:
      200:
        description: Scheme updated
      400:
        description: Validation error
      404:
        description: Scheme not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = service.update_scheme(id, data)
    if not item:
        return jsonify({'message': 'Scheme not found'}), 404
    return jsonify(schema.dump(item)), 200

@assessment_scheme_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_scheme(id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Delete an assessment scheme
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Scheme not found
    """
    ok = service.delete_scheme(id)
    if not ok:
        return jsonify({'message': 'Scheme not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/clo_plo_mapping_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.clo_plo_mapping_service import CloPloMappingService
from api.schemas.clo_plo_mapping_schema import CloPloMappingSchema

clo_plo_mapping_bp = Blueprint('clo_plo_mapping', __name__, url_prefix='/clo-plo-mappings')
schema = CloPloMappingSchema()

@clo_plo_mapping_bp.route('/', methods=['POST'])
@inject
def create_mapping(service: CloPloMappingService = Provide[Container.clo_plo_mapping_service]):
    """
    Create CLO-PLO Mapping
    ---
    tags:
      - Mappings (CLO-PLO)
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CloPloMapping'
    responses:
      201: {description: Created}
      400: {description: Error}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_mapping(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@clo_plo_mapping_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_mapping(id: int, service: CloPloMappingService = Provide[Container.clo_plo_mapping_service]):
    """
    Delete CLO-PLO Mapping
    ---
    tags:
      - Mappings (CLO-PLO)
    parameters:
      - name: id
        in: path
        required: true
        schema: {type: integer}
    responses:
      204: {description: Deleted}
    """
    ok = service.delete_mapping(id)
    if not ok:
        return jsonify({'message': 'Mapping not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/notification_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.notification_service import NotificationService
from api.schemas.notification_schema import NotificationSchema
from api.middleware import token_required

notification_bp = Blueprint('notification', __name__, url_prefix='/notifications')
schema = NotificationSchema()

@notification_bp.route('/', methods=['GET'])
@inject
@token_required
def get_my_notifications(service: NotificationService = Provide[Container.notification_service]):
    """
    Get current user's notifications
    ---
    tags:
      - Notifications
    parameters:
      - name: unread
        in: query
        type: boolean
        description: Filter by unread only
    responses:
      200:
        description: List of notifications
    """
    user_id = getattr(request, 'user', {}).get('user_id')
    if not user_id:
         return jsonify({'message': 'User context missing'}), 401
    unread = request.args.get('unread', 'false').lower() == 'true'
    items = service.get_user_notifications(user_id, unread_only=unread)
    return jsonify(schema.dump(items, many=True)), 200

@notification_bp.route('/<int:id>/read', methods=['PUT'])
@inject
@token_required
def mark_read(id: int, service: NotificationService = Provide[Container.notification_service]):
    """
    Mark a notification as read
    ---
    tags:
      - Notifications
    parameters:
      - name: id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200:
        description: Marked as read
    """
    ok = service.mark_read(id)
    if not ok:
        return jsonify({'message': 'Notification not found'}), 404
    return jsonify({'message': 'Marked as read'}), 200
</file>

<file path="src/api/controllers/rubric_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.rubric_service import RubricService
from api.schemas.rubric_schema import RubricSchema

rubric_bp = Blueprint('rubric', __name__, url_prefix='/rubrics')

schema = RubricSchema()

@rubric_bp.route('/component/<int:component_id>', methods=['GET'])
@inject
def list_rubrics(component_id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    List rubrics for a component
    ---
    tags:
      - Rubrics
    parameters:
      - name: component_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of rubrics
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/Rubric'
    """
    items = rubric_service.list_rubrics_for_component(component_id)
    return jsonify(schema.dump(items, many=True)), 200

@rubric_bp.route('/', methods=['POST'])
@inject
def create_rubric(rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Create a rubric
    ---
    tags:
      - Rubrics
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Rubric'
    responses:
      201:
        description: Rubric created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = rubric_service.create_rubric(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@rubric_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_rubric(id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Update a rubric
    ---
    tags:
      - Rubrics
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Rubric'
    responses:
      200:
        description: Rubric updated
      400:
        description: Validation error
      404:
        description: Rubric not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = rubric_service.update_rubric(id, data)
    if not item:
        return jsonify({'message': 'Rubric not found'}), 404
    return jsonify(schema.dump(item)), 200

@rubric_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_rubric(id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Delete a rubric
    ---
    tags:
      - Rubrics
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Rubric not found
    """
    ok = rubric_service.delete_rubric(id)
    if not ok:
        return jsonify({'message': 'Rubric not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/student_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.student_service import StudentService
from api.schemas.student_schema import StudentSubscriptionSchema, StudentReportSchema

student_bp = Blueprint('student', __name__, url_prefix='/student')
sub_schema = StudentSubscriptionSchema()
rep_schema = StudentReportSchema()

@student_bp.route('/subscribe', methods=['POST'])
@inject
def subscribe(service: StudentService = Provide[Container.student_service]):
    """
    Student subscribes to a subject
    ---
    tags:
      - Student Features
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              student_id: {type: integer}
              subject_id: {type: integer}
    responses:
      201:
        description: Subscription created
    """
    data = request.get_json() or {}
    item = service.subscribe(data.get('student_id'), data.get('subject_id'))
    return jsonify(sub_schema.dump(item)), 201

@student_bp.route('/report', methods=['POST'])
@inject
def report(service: StudentService = Provide[Container.student_service]):
    """
    Student reports an issue with a syllabus
    ---
    tags:
      - Student Features
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/StudentReport'
    responses:
      201:
        description: Report created
    """
    data = request.get_json() or {}
    item = service.report_syllabus(data.get('student_id'), data.get('syllabus_id'), data.get('content'))
    return jsonify(rep_schema.dump(item)), 201

@student_bp.route('/reports', methods=['GET'])
@inject
def list_reports(service: StudentService = Provide[Container.student_service]):
    """
    List all student reports (Admin)
    ---
    tags:
      - Student Features
    responses:
      200:
        description: List of reports
    """
    items = service.list_reports()
    return jsonify(rep_schema.dump(items, many=True)), 200
</file>

<file path="src/api/controllers/subject_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.subject_service import SubjectService
from api.schemas.subject_schema import SubjectSchema

subject_bp = Blueprint('subject', __name__, url_prefix='/subjects')

schema = SubjectSchema()

@subject_bp.route('/', methods=['GET'])
@inject
def list_subjects(subject_service: SubjectService = Provide[Container.subject_service]):
    """Get all subjects
    ---
    get:
      summary: Get all subjects
      tags:
        - Subjects
      responses:
        200:
          description: List of subjects
    """
    subjects = subject_service.list_subjects()
    return jsonify(schema.dump(subjects, many=True)), 200

@subject_bp.route('/<int:id>', methods=['GET'])
@inject
def get_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Get subject by id
    ---
    get:
      summary: Get subject by ID
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Subject object
        404:
          description: Not found
    """
    subject = subject_service.get_subject(id)
    if not subject:
        return jsonify({'message': 'Subject not found'}), 404
    return jsonify(schema.dump(subject)), 200

@subject_bp.route('/', methods=['POST'])
@inject
def create_subject(subject_service: SubjectService = Provide[Container.subject_service]):
    """Create a new subject
    ---
    post:
      summary: Create a new subject
      tags:
        - Subjects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subject'
      responses:
        201:
          description: Subject created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    subject = subject_service.create_subject(data)
    return jsonify(schema.dump(subject)), 201

@subject_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Update an existing subject
    ---
    put:
      summary: Update subject
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subject'
      responses:
        200:
          description: Subject updated
        400:
          description: Invalid input
        404:
          description: Subject not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    subject = subject_service.update_subject(id, data)
    if not subject:
        return jsonify({'message': 'Subject not found'}), 404
    return jsonify(schema.dump(subject)), 200

@subject_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Delete subject
    ---
    delete:
      summary: Delete subject
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Subject not found
    """
    ok = subject_service.delete_subject(id)
    if not ok:
        return jsonify({'message': 'Subject not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/subject_relationship_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.subject_relationship_service import SubjectRelationshipService
from api.schemas.subject_relationship_schema import SubjectRelationshipSchema

subject_rel_bp = Blueprint('subject_relationship', __name__, url_prefix='/subject-relationships')
schema = SubjectRelationshipSchema()

@subject_rel_bp.route('/subject/<int:subject_id>', methods=['GET'])
@inject
def list_relationships(subject_id: int, service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    List relationships for a subject
    ---
    tags:
      - Subject Relationships
    parameters:
      - name: subject_id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200: {description: List of relationships}
    """
    items = service.get_relationships(subject_id)
    return jsonify(schema.dump(items, many=True)), 200

@subject_rel_bp.route('/', methods=['POST'])
@inject
def create_relationship(service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    Create subject relationship
    ---
    tags:
      - Subject Relationships
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SubjectRelationship'
    responses:
      201: {description: Created}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.add_relationship(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@subject_rel_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_relationship(id: int, service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    Delete relationship
    ---
    tags:
      - Subject Relationships
    responses:
      204: {description: Deleted}
    """
    ok = service.remove_relationship(id)
    if not ok:
        return jsonify({'message': 'Relationship not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/syllabus_clo_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_clo_service import SyllabusCloService
from api.schemas.syllabus_clo_schema import SyllabusCloSchema

syllabus_clo_bp = Blueprint('syllabus_clo', __name__, url_prefix='/syllabus-clos')

schema = SyllabusCloSchema()

@syllabus_clo_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_clos(syllabus_id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    List CLOs for a syllabus
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of CLOs
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/SyllabusClo'
    """
    items = syllabus_clo_service.get_by_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_clo_bp.route('/', methods=['POST'])
@inject
def create_clo(syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Create a new CLO for a syllabus
    ---
    tags:
      - Syllabus CLOs
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusClo'
    responses:
      201:
        description: CLO created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = syllabus_clo_service.create_clo(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@syllabus_clo_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_clo(id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Update an existing CLO
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusClo'
    responses:
      200:
        description: CLO updated
      400:
        description: Validation error
      404:
        description: CLO not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = syllabus_clo_service.update_clo(id, data)
    if not item:
        return jsonify({'message': 'CLO not found'}), 404
    return jsonify(schema.dump(item)), 200

@syllabus_clo_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_clo(id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Delete a CLO by id
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: CLO not found
    """
    ok = syllabus_clo_service.delete_clo(id)
    if not ok:
        return jsonify({'message': 'CLO not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/syllabus_comment_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_comment_service import SyllabusCommentService
from api.schemas.syllabus_comment_schema import SyllabusCommentSchema

syllabus_comment_bp = Blueprint('syllabus_comment', __name__, url_prefix='/syllabus-comments')
schema = SyllabusCommentSchema()

@syllabus_comment_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_comments(syllabus_id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    List comments for syllabus
    ---
    tags:
      - Comments
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200: {description: List of comments}
    """
    items = service.get_comments(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_comment_bp.route('/', methods=['POST'])
@inject
def add_comment(service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Add a comment
    ---
    tags:
      - Comments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusComment'
    responses:
      201: {description: Created}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.add_comment(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@syllabus_comment_bp.route('/<int:id>/resolve', methods=['PUT'])
@inject
def resolve_comment(id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Mark comment as resolved
    ---
    tags:
      - Comments
    responses:
      200: {description: Resolved}
    """
    item = service.resolve_comment(id)
    if not item:
        return jsonify({'message': 'Comment not found'}), 404
    return jsonify(schema.dump(item)), 200

@syllabus_comment_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_comment(id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Delete comment
    ---
    tags:
      - Comments
    responses:
      204: {description: Deleted}
    """
    ok = service.delete_comment(id)
    if not ok:
        return jsonify({'message': 'Comment not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/syllabus_material_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_material_service import SyllabusMaterialService
from api.schemas.syllabus_material_schema import SyllabusMaterialSchema

syllabus_material_bp = Blueprint('syllabus_material', __name__, url_prefix='/syllabus-materials')

schema = SyllabusMaterialSchema()

@syllabus_material_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_materials(syllabus_id: int, syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    List materials for a syllabus
    ---
    tags:
      - Syllabus Materials
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of materials
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/SyllabusMaterial'
    """
    items = syllabus_material_service.get_by_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_material_bp.route('/', methods=['POST'])
@inject
def create_material(syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    Create a syllabus material
    ---
    tags:
      - Syllabus Materials
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusMaterial'
    responses:
      201:
        description: Material created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = syllabus_material_service.create_material(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@syllabus_material_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_material(id: int, syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    Delete a syllabus material
    ---
    tags:
      - Syllabus Materials
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Material not found
    """
    ok = syllabus_material_service.delete_material(id)
    if not ok:
        return jsonify({'message': 'Material not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/system_setting_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.system_setting_service import SystemSettingService
from api.schemas.system_setting_schema import SystemSettingSchema

system_setting_bp = Blueprint('system_setting', __name__, url_prefix='/system-settings')
schema = SystemSettingSchema()

@system_setting_bp.route('/', methods=['GET'])
@inject
def list_settings(service: SystemSettingService = Provide[Container.system_setting_service]):
    """
    List all system settings
    ---
    tags:
      - System Settings
    responses:
      200:
        description: List of settings
    """
    items = service.get_all_settings()
    return jsonify(schema.dump(items, many=True)), 200

@system_setting_bp.route('/', methods=['POST'])
@inject
def update_setting(service: SystemSettingService = Provide[Container.system_setting_service]):
    """
    Update or create a system setting
    ---
    tags:
      - System Settings
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SystemSetting'
    responses:
      200:
        description: Setting updated
      400:
        description: Validation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    item = service.update_setting(data['key'], data['value'], data.get('description'))
    return jsonify(schema.dump(item)), 200
</file>

<file path="src/api/controllers/teaching_plan_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.teaching_plan_service import TeachingPlanService
from api.schemas.teaching_plan_schema import TeachingPlanSchema

teaching_plan_bp = Blueprint('teaching_plan', __name__, url_prefix='/teaching-plans')

schema = TeachingPlanSchema()

@teaching_plan_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_plans(syllabus_id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    List teaching plans for a syllabus
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of teaching plans
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/TeachingPlan'
    """
    items = teaching_plan_service.list_plans_for_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@teaching_plan_bp.route('/', methods=['POST'])
@inject
def create_plan(teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Create a teaching plan
    ---
    tags:
      - Teaching Plans
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TeachingPlan'
    responses:
      201:
        description: Teaching plan created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = teaching_plan_service.create_teaching_plan(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@teaching_plan_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_plan(id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Update a teaching plan
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TeachingPlan'
    responses:
      200:
        description: Teaching plan updated
      400:
        description: Validation error
      404:
        description: Teaching plan not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = teaching_plan_service.update_teaching_plan(id, data)
    if not item:
        return jsonify({'message': 'Teaching plan not found'}), 404
    return jsonify(schema.dump(item)), 200

@teaching_plan_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_plan(id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Delete a teaching plan
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Teaching plan not found
    """
    ok = teaching_plan_service.delete_teaching_plan(id)
    if not ok:
        return jsonify({'message': 'Teaching plan not found'}), 404
    return '', 204
</file>

<file path="src/api/routes.py">
def register_routes(app):
    """Register API routes. No legacy route blueprints are registered for SMD."""
    return
</file>

<file path="src/api/schemas/assessment_component_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import Range

class AssessmentComponentSchema(Schema):
    id = fields.Int(dump_only=True)
    scheme_id = fields.Int(required=True)
    name = fields.Str(required=True)
    weight = fields.Float(required=True, validate=Range(min=0, max=100))
    rubrics = fields.List(fields.Nested('RubricSchema'), dump_only=True)
</file>

<file path="src/api/schemas/assessment_scheme_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import Range

class AssessmentSchemeSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    name = fields.Str(required=True)
    weight = fields.Float(required=True, validate=Range(min=0, max=100))
    components = fields.List(fields.Nested('AssessmentComponentSchema'), dump_only=True)
</file>

<file path="src/api/schemas/subject_schema.py">
# from marshmallow import Schema, fields

# class SubjectSchema(Schema):
#     id = fields.Int(dump_only=True)
#     department_id = fields.Int(required=True)
#     code = fields.Str(required=True)
#     name_vi = fields.Str(required=True)
#     name_en = fields.Str(required=True)
#     credits = fields.Int(required=True)
#     credit_theory = fields.Float(missing=0)
#     credit_practice = fields.Float(missing=0)
#     credit_self_study = fields.Float(missing=0)
from marshmallow import Schema, fields

class SubjectSchema(Schema):
    id = fields.Int(dump_only=True)
    department_id = fields.Int(required=True)
    code = fields.Str(required=True)
    name_vi = fields.Str(required=True)
    name_en = fields.Str(required=True)
    credits = fields.Int(required=True)
    # Sa missing=0 thnh load_default=0
    credit_theory = fields.Float(load_default=0)
    credit_practice = fields.Float(load_default=0)
    credit_self_study = fields.Float(load_default=0)
</file>

<file path="src/api/schemas/syllabus_detail_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class SyllabusDetailSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    program_id = fields.Int(required=True)
    academic_year_id = fields.Int(required=True)
    lecturer_id = fields.Int(required=True)

    status = fields.Str(dump_only=True)
    version = fields.Str(dump_default="1.0")
    time_allocation = fields.Str(load_default=None)
    prerequisites = fields.Str(load_default=None)
    publish_date = fields.DateTime(load_default=None)

    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)

    clos = fields.List(fields.Nested('SyllabusCloSchema'), dump_only=True)
    materials = fields.List(fields.Nested('SyllabusMaterialSchema'), dump_only=True)
    teaching_plans = fields.List(fields.Nested('TeachingPlanSchema'), dump_only=True)
    assessment_schemes = fields.List(fields.Nested('AssessmentSchemeSchema'), dump_only=True)
</file>

<file path="src/api/schemas/user_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class UserSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    username = fields.Str(required=True)
    email = fields.Email(required=True)
    full_name = fields.Str(required=True)
    department_id = fields.Int(load_default=None)
    is_active = fields.Bool(load_default=True)
    password = fields.Str(load_only=True, required=True)
</file>

<file path="src/api/swagger.py">
from apispec import APISpec
from apispec.ext.marshmallow import MarshmallowPlugin
from apispec_webframeworks.flask import FlaskPlugin

spec = APISpec(
    title="Syllabus Management API",
    version="1.0.0",
    openapi_version="3.0.2",
    plugins=[FlaskPlugin(), MarshmallowPlugin()],
)

# (No legacy Todo schemas registered  SMD module schemas are registered via controllers/schemas)
</file>

<file path="src/cors.py">
from flask_cors import CORS

def init_cors(app):
    # Restrict origins to the frontend (Next.js dev host) and allow Authorization header
    CORS(app, resources={
        r"/*": {
            "origins": ["http://localhost:3000"],
            "allow_headers": ["Authorization", "Content-Type"],
            "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
        }
    }, supports_credentials=True)
    app.config.setdefault('CORS_HEADERS', 'Content-Type')
    return app
</file>

<file path="src/infrastructure/databases/__init__.py">
from infrastructure.databases.mssql import init_mssql
from infrastructure.models import (
    academic_year_model,
    ai_auditlog_model,
    assessment_clo_model,
    assessment_component_model,
    assessment_scheme_model,
    clo_plo_mapping_model,
    department_model,
    faculty_model,
    file_model,
    notification_model,
    notification_template_model,
    program_model,
    program_outcome_model,
    role_model,
    rubric_model,
    student_report_model,
    student_subscription_model,
    subject_model,
    subject_relationship_model,
    syllabus_clo_model,
    syllabus_comment_model,
    syllabus_current_workflow,
    syllabus_material_model,
    syllabus_model,
    system_auditlog_model,
    system_setting_model,
    teaching_plan_model,
    user_model,
    user_role_model,
    workflow_log_model,
    workflow_state_model,
    workflow_transition_model
)

def init_db(app):
    init_mssql(app)

# Migration Entities -> tables
from infrastructure.databases.mssql import Base
</file>

<file path="src/infrastructure/models/academic_year_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AcademicYear(Base):
    __tablename__ = 'academic_years'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(20), unique=True)
    start_date = Column(Date)
    end_date = Column(Date)
    
    # Relationships
    syllabuses = relationship("Syllabus", back_populates="academic_year")
</file>

<file path="src/infrastructure/models/ai_auditlog_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AiAuditLog(Base):
    __tablename__ = 'ai_audit_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    action = Column(NVARCHAR(50))  # GENERATE, COMPARE_DIFF, SUMMARIZE
    input_tokens = Column(Integer)
    output_tokens = Column(Integer)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="ai_audit_logs")
</file>

<file path="src/infrastructure/models/assessment_clo_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentClo(Base):
    __tablename__ = 'assessment_clos'
    
    assessment_component_id = Column(BigInteger, ForeignKey('assessment_components.id'), primary_key=True)
    syllabus_clo_id = Column(BigInteger, ForeignKey('syllabus_clos.id'), primary_key=True)
    
    # Relationships
    component = relationship("AssessmentComponent", back_populates="clos")
    syllabus_clo = relationship("SyllabusClo", back_populates="assessment_clos")
</file>

<file path="src/infrastructure/models/assessment_component_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentComponent(Base):
    __tablename__ = 'assessment_components'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    scheme_id = Column(BigInteger, ForeignKey('assessment_schemes.id'), nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    weight = Column(DECIMAL(3, 1), nullable=False)
    
    # Relationships
    scheme = relationship("AssessmentScheme", back_populates="components")
    clos = relationship("AssessmentClo", back_populates="component")
    rubrics = relationship("Rubric", back_populates="component", cascade="all, delete-orphan")
</file>

<file path="src/infrastructure/models/assessment_scheme_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentScheme(Base):
    __tablename__ = 'assessment_schemes'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    name = Column(NVARCHAR(100))
    weight = Column(DECIMAL(3, 1))
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="assessment_schemes")
    components = relationship("AssessmentComponent", back_populates="scheme", cascade="all, delete-orphan")
</file>

<file path="src/infrastructure/models/clo_plo_mapping_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class CloPloMapping(Base):
    __tablename__ = 'clo_plo_mappings'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_clo_id = Column(BigInteger, ForeignKey('syllabus_clos.id', ondelete='CASCADE'), nullable=False)
    program_plo_id = Column(BigInteger, ForeignKey('program_outcomes.id'), nullable=False)
    level = Column(NVARCHAR(1))  # I, R, M, A
    
    __table_args__ = (
        CheckConstraint("level IN ('I', 'R', 'M', 'A')", name='check_level'),
    )
    
    # Relationships
    syllabus_clo = relationship("SyllabusClo", back_populates="plo_mappings")
    program_plo = relationship("ProgramOutcome", back_populates="clo_mappings")
</file>

<file path="src/infrastructure/models/department_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Department(Base):
    __tablename__ = 'departments'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    faculty_id = Column(BigInteger, ForeignKey('faculties.id'), nullable=False)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    
    # Relationships
    faculty = relationship("Faculty", back_populates="departments")
    users = relationship("User", back_populates="department")
    subjects = relationship("Subject", back_populates="department")
    programs = relationship("Program", back_populates="department")
</file>

<file path="src/infrastructure/models/faculty_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base


class Faculty(Base):
    __tablename__ = 'faculties'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    
    # Relationships
    departments = relationship("Department", back_populates="faculty")
</file>

<file path="src/infrastructure/models/notification_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Notification(Base):
    __tablename__ = 'notifications'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    title = Column(NVARCHAR(255), nullable=False)
    message = Column(UnicodeText)
    link = Column(NVARCHAR(500))
    is_read = Column(Boolean, default=False)
    type = Column(NVARCHAR(50))  # SYSTEM, REVIEW, REMINDER
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    user = relationship("User", back_populates="notifications")
</file>

<file path="src/infrastructure/models/notification_template_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class NotificationTemplate(Base):
    __tablename__ = 'notification_templates'
    
    code = Column(NVARCHAR(50), primary_key=True)
    title_template = Column(NVARCHAR(255), nullable=False)
    body_template = Column(UnicodeText, nullable=False)
    channel = Column(NVARCHAR(20), default='SYSTEM')  # EMAIL, SMS, SYSTEM
</file>

<file path="src/infrastructure/models/program_outcome_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class ProgramOutcome(Base):
    __tablename__ = 'program_outcomes'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    program_id = Column(BigInteger, ForeignKey('programs.id'), nullable=False)
    code = Column(NVARCHAR(20))
    description = Column(UnicodeText)
    
    # Relationships
    program = relationship("Program", back_populates="outcomes")
    clo_mappings = relationship("CloPloMapping", back_populates="program_plo")
</file>

<file path="src/infrastructure/models/role_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Role(Base):
    __tablename__ = 'roles'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    name = Column(NVARCHAR(50), unique=True, nullable=False)
    description = Column(NVARCHAR(255), nullable=True)
    
    # Relationships
    user_roles = relationship("UserRole", back_populates="role")
    workflow_transitions = relationship("WorkflowTransition", back_populates="allowed_role")
</file>

<file path="src/infrastructure/models/rubric_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Rubric(Base):
    __tablename__ = 'rubrics'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    component_id = Column(BigInteger, ForeignKey('assessment_components.id', ondelete='CASCADE'), nullable=False)
    criteria = Column(UnicodeText, nullable=False)
    max_score = Column(DECIMAL(3, 1), nullable=False)
    description_level_pass = Column(UnicodeText)
    description_level_fail = Column(UnicodeText)
    
    # Relationships
    component = relationship("AssessmentComponent", back_populates="rubrics")
</file>

<file path="src/infrastructure/models/student_report_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class StudentReport(Base):
    __tablename__ = 'student_reports'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    student_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    content = Column(UnicodeText, nullable=False)
    status = Column(NVARCHAR(20), default='PENDING')  # PENDING, RESOLVED, REJECTED
    admin_note = Column(UnicodeText)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="student_reports")
    student = relationship("User")
</file>

<file path="src/infrastructure/models/student_subscription_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class StudentSubscription(Base):
    __tablename__ = 'student_subscriptions'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    student_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    student = relationship("User")
    subject = relationship("Subject", back_populates="student_subscriptions")
</file>

<file path="src/infrastructure/models/subject_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Subject(Base):
    __tablename__ = 'subjects'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=False)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name_vi = Column(NVARCHAR(255), nullable=False)
    name_en = Column(NVARCHAR(255), nullable=False)
    credits = Column(Integer, nullable=False)
    credit_theory = Column(DECIMAL(3, 1), default=0)
    credit_practice = Column(DECIMAL(3, 1), default=0)
    credit_self_study = Column(DECIMAL(3, 1), default=0)
    
    # Relationships
    department = relationship("Department", back_populates="subjects")
    syllabuses = relationship("Syllabus", back_populates="subject")
    subject_relationships = relationship("SubjectRelationship", 
                                        foreign_keys="SubjectRelationship.subject_id",
                                        back_populates="subject")
    related_subjects = relationship("SubjectRelationship",
                                   foreign_keys="SubjectRelationship.related_subject_id",
                                   back_populates="related_subject")
    student_subscriptions = relationship("StudentSubscription", back_populates="subject")
</file>

<file path="src/infrastructure/models/subject_relationship_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SubjectRelationship(Base):
    __tablename__ = 'subject_relationships'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    related_subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    type = Column(NVARCHAR(20), nullable=False)  # PREREQUISITE, COREQUISITE, PARALLEL
    
    # Relationships
    subject = relationship("Subject", foreign_keys=[subject_id], back_populates="subject_relationships")
    related_subject = relationship("Subject", foreign_keys=[related_subject_id], back_populates="related_subjects")
</file>

<file path="src/infrastructure/models/syllabus_clo_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusClo(Base):
    __tablename__ = 'syllabus_clos'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    code = Column(NVARCHAR(20), nullable=False)
    description = Column(UnicodeText, nullable=False)
    embedding_vector = Column(UnicodeText, nullable=True)  # JSON vector
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="clos")
    plo_mappings = relationship("CloPloMapping", back_populates="syllabus_clo", cascade="all, delete-orphan")
    assessment_clos = relationship("AssessmentClo", back_populates="syllabus_clo")
</file>

<file path="src/infrastructure/models/syllabus_comment_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusComment(Base):
    __tablename__ = 'syllabus_comments'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    content = Column(UnicodeText, nullable=False)
    parent_id = Column(BigInteger, ForeignKey('syllabus_comments.id'), nullable=True)
    is_resolved = Column(Boolean, default=False)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="comments")
    user = relationship("User", back_populates="comments")
    parent = relationship("SyllabusComment", remote_side=[id], backref="replies")
</file>

<file path="src/infrastructure/models/syllabus_current_workflow.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusCurrentWorkflow(Base):
    __tablename__ = 'syllabus_current_workflows'
    
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), primary_key=True)
    current_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    assigned_to_user_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    due_date = Column(DateTime, nullable=True)
    updated_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="current_workflow")
    current_state = relationship("WorkflowState", back_populates="current_workflows")
    assigned_to_user = relationship("User")
</file>

<file path="src/infrastructure/models/syllabus_material_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusMaterial(Base):
    __tablename__ = 'syllabus_materials'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    type = Column(NVARCHAR(50), nullable=False)  # MAIN, REFERENCE
    title = Column(NVARCHAR(555), nullable=False)
    author = Column(NVARCHAR(255))
    publisher = Column(NVARCHAR(255))
    published_year = Column(Integer)
    isbn = Column(NVARCHAR(50))
    url = Column(UnicodeText, nullable=True)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="materials")
</file>

<file path="src/infrastructure/models/syllabus_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base

class Syllabus(Base):
    __tablename__ = 'syllabuses'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    program_id = Column(BigInteger, ForeignKey('programs.id'), nullable=False)
    academic_year_id = Column(BigInteger, ForeignKey('academic_years.id'), nullable=False)
    lecturer_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    status = Column(NVARCHAR(20))  # DRAFT, PENDING, APPROVED
    version = Column(NVARCHAR(10))
    time_allocation = Column(UnicodeText)  # JSON
    prerequisites = Column(UnicodeText)
    publish_date = Column(DateTime)
    is_active = Column(Boolean)
    embedding_vector = Column(UnicodeText, nullable=True)  # JSON vector
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
    
    # Relationships
    subject = relationship("Subject", back_populates="syllabuses")
    program = relationship("Program", back_populates="syllabuses")
    academic_year = relationship("AcademicYear", back_populates="syllabuses")
    lecturer = relationship("User", back_populates="syllabuses")
    clos = relationship("SyllabusClo", back_populates="syllabus", cascade="all, delete-orphan")
    materials = relationship("SyllabusMaterial", back_populates="syllabus", cascade="all, delete-orphan")
    teaching_plans = relationship("TeachingPlan", back_populates="syllabus", cascade="all, delete-orphan")
    assessment_schemes = relationship("AssessmentScheme", back_populates="syllabus", cascade="all, delete-orphan")
    comments = relationship("SyllabusComment", back_populates="syllabus")
    workflow_logs = relationship("WorkflowLog", back_populates="syllabus")
    current_workflow = relationship("SyllabusCurrentWorkflow", back_populates="syllabus", uselist=False)
    student_reports = relationship("StudentReport", back_populates="syllabus")
    ai_audit_logs = relationship("AiAuditLog", back_populates="syllabus")
</file>

<file path="src/infrastructure/models/system_auditlog_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SystemAuditLog(Base):
    __tablename__ = 'system_audit_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    action_type = Column(NVARCHAR(50), nullable=False)
    resource_target = Column(NVARCHAR(100))
    ip_address = Column(NVARCHAR(45))
    user_agent = Column(UnicodeText)
    details = Column(UnicodeText)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    user = relationship("User")
</file>

<file path="src/infrastructure/models/system_setting_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base

class SystemSetting(Base):
    __tablename__ = 'system_settings'
    
    key = Column(NVARCHAR(50), primary_key=True)
    value = Column(UnicodeText, nullable=False)
    type = Column(NVARCHAR(20), default='STRING')
    description = Column(NVARCHAR(255), nullable=True)
</file>

<file path="src/infrastructure/models/teaching_plan_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class TeachingPlan(Base):
    __tablename__ = 'teaching_plans'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    week = Column(Integer)
    topic = Column(UnicodeText)
    activity = Column(UnicodeText)
    assessment = Column(UnicodeText)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="teaching_plans")
</file>

<file path="src/infrastructure/models/user_role_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class UserRole(Base):
    __tablename__ = 'user_roles'
    
    user_id = Column(BigInteger, ForeignKey('users.id'), primary_key=True)
    role_id = Column(BigInteger, ForeignKey('roles.id'), primary_key=True)
    
    # Relationships
    user = relationship("User", back_populates="roles")
    role = relationship("Role", back_populates="user_roles")
</file>

<file path="src/infrastructure/models/workflow_log_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base


class WorkflowLog(Base):
    __tablename__ = 'workflow_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    actor_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    action = Column(NVARCHAR(50))  # SUBMIT, APPROVE, REJECT
    from_status = Column(NVARCHAR(50))
    to_status = Column(NVARCHAR(50))
    comment = Column(UnicodeText)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="workflow_logs")
    actor = relationship("User", back_populates="workflow_logs")
</file>

<file path="src/infrastructure/models/workflow_state_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class WorkflowState(Base):
    __tablename__ = 'workflow_states'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(50), unique=True, nullable=False)
    name = Column(NVARCHAR(100), nullable=False)
    color = Column(NVARCHAR(20))
    is_final = Column(Boolean, default=False)
    
    # Relationships
    transitions_from = relationship("WorkflowTransition", 
                                   foreign_keys="WorkflowTransition.from_state_id",
                                   back_populates="from_state")
    transitions_to = relationship("WorkflowTransition",
                                 foreign_keys="WorkflowTransition.to_state_id",
                                 back_populates="to_state")
    current_workflows = relationship("SyllabusCurrentWorkflow", back_populates="current_state")
</file>

<file path="src/infrastructure/models/workflow_transition_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class WorkflowTransition(Base):
    __tablename__ = 'workflow_transitions'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    from_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    to_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    allowed_role_id = Column(BigInteger, ForeignKey('roles.id'), nullable=False)
    action_name = Column(NVARCHAR(50))
    
    # Relationships
    from_state = relationship("WorkflowState", foreign_keys=[from_state_id], back_populates="transitions_from")
    to_state = relationship("WorkflowState", foreign_keys=[to_state_id], back_populates="transitions_to")
    allowed_role = relationship("Role", back_populates="workflow_transitions")
</file>

<file path="src/infrastructure/repositories/syllabus_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session, joinedload
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_model import Syllabus
from infrastructure.models.assessment_scheme_model import AssessmentScheme
from infrastructure.models.assessment_component_model import AssessmentComponent

class SyllabusRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Syllabus]:
        return self.session.query(Syllabus).all()

    def get_by_id(self, id: int) -> Optional[Syllabus]:
        return self.session.query(Syllabus).filter_by(id=id).first()

    def get_by_subject_id(self, subject_id: int) -> List[Syllabus]:
        return self.session.query(Syllabus).filter_by(subject_id=subject_id).all()

    def get_details(self, id: int) -> Optional[Syllabus]:
        # Eagerly load related collections and nested components->rubrics
        return (
            self.session.query(Syllabus)
            .options(
                joinedload(Syllabus.clos),
                joinedload(Syllabus.materials),
                joinedload(Syllabus.teaching_plans),
                joinedload(Syllabus.assessment_schemes)
                    .joinedload(AssessmentScheme.components)
                    .joinedload(AssessmentComponent.rubrics),
            )
            .filter_by(id=id)
            .first()
        )

    def create(self, data: dict) -> Syllabus:
        s = Syllabus(**data)
        self.session.add(s)
        self.session.commit()
        self.session.refresh(s)
        return s

    def update(self, id: int, data: dict) -> Optional[Syllabus]:
        s = self.get_by_id(id)
        if not s:
            return None
        for key, value in data.items():
            if hasattr(s, key):
                setattr(s, key, value)
        self.session.commit()
        self.session.refresh(s)
        return s

    def delete(self, id: int) -> bool:
        s = self.get_by_id(id)
        if not s:
            return False
        self.session.delete(s)
        self.session.commit()
        return True
</file>

<file path="src/infrastructure/repositories/user_repository.py">
from typing import List, Optional
from dotenv import load_dotenv
import os
from sqlalchemy.orm import Session
from infrastructure.databases import Base
from infrastructure.databases.mssql import session

# Import the User model
from infrastructure.models.user_model import User

load_dotenv()

class UserRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[User]:
        return self.session.query(User).all()

    def get_by_username(self, username: str) -> Optional[User]:
        return self.session.query(User).filter_by(username=username).first()

    def get_by_id(self, user_id: int) -> Optional[User]:
        return self.session.query(User).filter_by(id=user_id).first()

    def create(self, data: dict) -> User:
        user = User(**data)
        self.session.add(user)
        self.session.commit()
        self.session.refresh(user)
        return user

    def update(self, id: int, data: dict) -> Optional[User]:
        user = self.get_by_id(id)
        if not user:
            return None
        for key, value in data.items():
            if hasattr(user, key):
                setattr(user, key, value)
        self.session.commit()
        self.session.refresh(user)
        return user

    def delete(self, id: int) -> bool:
        user = self.get_by_id(id)
        if not user:
            return False
        self.session.delete(user)
        self.session.commit()
        return True
</file>

<file path="src/services/assessment_clo_service.py">
from typing import List
from infrastructure.repositories.assessment_clo_repository import AssessmentCloRepository

class AssessmentCloService:
    def __init__(self, repository: AssessmentCloRepository, component_repository=None, syllabus_clo_repository=None, assessment_scheme_repository=None):
        self.repository = repository
        self.component_repository = component_repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.assessment_scheme_repository = assessment_scheme_repository

    def get_clos_for_component(self, component_id: int) -> List:
        return self.repository.get_clos_by_component(component_id)

    def add_mapping(self, component_id: int, syllabus_clo_id: int):
        component = self.component_repository.get_by_id(component_id)
        if not component:
            raise ValueError('Invalid component_id')
        syllabus_clo = self.syllabus_clo_repository.get_by_id(syllabus_clo_id)
        if not syllabus_clo:
            raise ValueError('Invalid syllabus_clo_id')

        # Determine the syllabus id for the component (via scheme relationship or scheme repository)
        comp_syllabus_id = None
        if getattr(component, 'scheme', None):
            comp_syllabus_id = component.scheme.syllabus_id
        elif hasattr(component, 'scheme_id'):
            if not self.assessment_scheme_repository:
                raise ValueError('Cannot determine component syllabus without assessment_scheme_repository')
            scheme = self.assessment_scheme_repository.get_by_id(component.scheme_id)
            if not scheme:
                raise ValueError('Invalid component: linked scheme not found')
            comp_syllabus_id = scheme.syllabus_id
        else:
            raise ValueError('Invalid component: cannot resolve related scheme')

        # Ensure both belong to the same syllabus
        if comp_syllabus_id != syllabus_clo.syllabus_id:
            raise ValueError('Cross-reference Error: Component and CLO must belong to the same Syllabus')

        return self.repository.add_mapping(component_id, syllabus_clo_id)

    def remove_mapping(self, component_id: int, syllabus_clo_id: int) -> bool:
        return self.repository.remove_mapping(component_id, syllabus_clo_id)
</file>

<file path="src/services/user_service.py">
from typing import List, Optional
from werkzeug.security import generate_password_hash, check_password_hash
from infrastructure.repositories.user_repository import UserRepository

class UserService:
    def __init__(self, repository: UserRepository):
        self.repository = repository

    def list_users(self) -> List:
        return self.repository.get_all()

    def get_user(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_username(self, username: str):
        return self.repository.get_by_username(username)

    def create_user(self, data: dict):
        # Hash password before saving
        if 'password' in data:
            data['password_hash'] = generate_password_hash(data.pop('password'))
        return self.repository.create(data)

    def update_user(self, id: int, data: dict):
        if 'password' in data:
            data['password_hash'] = generate_password_hash(data.pop('password'))
        return self.repository.update(id, data)

    def delete_user(self, id: int) -> bool:
        return self.repository.delete(id)

    def authenticate(self, username: str, password: str):
        user = self.get_by_username(username)
        if not user:
            return None
        if not check_password_hash(user.password_hash, password):
            return None
        return user
</file>

<file path="src/swagger_config.json">
{
    "template": {
        "swagger": "2.0",
        "info": {
            "title": "Syllabus Management API",
            "description": "API for Syllabus Management (SMD)",
            "version": "1.0.0"
        },
        "basePath": "/",
        "schemes": [
            "http",
            "https"
        ],
        "consumes": [
            "application/json"
        ],
        "produces": [
            "application/json"
        ]
    },
    "swagger_config": {
        "headers": [],
        "specs": [
            {
                "endpoint": "apispec",
                "route": "/apispec.json"
            }
        ],
        "static_url_path": "/flasgger_static",
        "swagger_ui": true,
        "specs_route": "/docs"
    }
}
</file>

<file path="tests/e2e_test_flow.py">
"""End-to-end happy-path test for Syllabus Management System

Run this script directly (python tests/e2e_test_flow.py).
Requires: requests, colorama

It will stop immediately and print an error in red if any step returns an unexpected status code.
"""

import sys
import time
import uuid
from datetime import date

import requests
import json
try:
    from colorama import Fore, Style, init as colorama_init
except Exception:
    print("Please install 'colorama' (pip install colorama) to run this script.")
    sys.exit(2)

colorama_init(autoreset=True)

BASE_URL = 'http://localhost:9999'


def log(step: str, message: str, status: str = 'INFO'):
    """Nicely print a log line.

    status: INFO, OK, FAIL
    """
    status = status.upper()
    if status == 'OK':
        color = Fore.GREEN
    elif status == 'FAIL':
        color = Fore.RED
    else:
        color = Fore.CYAN
    print(f"[{color}{status}{Style.RESET_ALL}] {step} - {message}")


def fail(step: str, message: str, resp=None):
    log(step, message, 'FAIL')
    if resp is not None:
        try:
            print(Fore.RED + resp.text)
        except Exception:
            pass
    sys.exit(1)


def expect_status(step: str, resp: requests.Response, expected: int):
    if resp.status_code != expected:
        fail(step, f"Expected HTTP {expected}, got {resp.status_code}", resp)
    log(step, f"HTTP {resp.status_code}", 'OK')


def post(path: str, json: dict, token: str = None):
    headers = {'Content-Type': 'application/json'}
    if token:
        headers['Authorization'] = f'Bearer {token}'
    return requests.post(BASE_URL + path, json=json, headers=headers)


def get(path: str, token: str = None):
    headers = {}
    if token:
        headers['Authorization'] = f'Bearer {token}'
    return requests.get(BASE_URL + path, headers=headers)


def run():
    # Step 1: Login admin
    step = '1. Login Admin'
    payload = {'username': 'admin', 'password': 'password123'}
    resp = post('/auth/login', payload)
    expect_status(step, resp, 200)
    token = resp.json().get('token')
    if not token:
        fail(step, 'No token returned', resp)
    log(step, 'Obtained token', 'OK')

    # Helper to generate short unique strings
    uid = str(uuid.uuid4())[:8]

    # Step 2: Create Faculty
    step = '2. Create Faculty'
    payload = {'code': f'E2E-FAC-{uid}', 'name': 'E2E Faculty'}
    resp = post('/faculties/', payload, token=token)
    expect_status(step, resp, 201)
    faculty_id = resp.json().get('id')

    # Step 3: Create Department
    step = '3. Create Department'
    payload = {'faculty_id': faculty_id, 'code': f'E2E-DEP-{uid}', 'name': 'E2E Department'}
    resp = post('/departments/', payload, token=token)
    expect_status(step, resp, 201)
    department_id = resp.json().get('id')

    # Step 4: Create Program
    step = '4. Create Program'
    payload = {'department_id': department_id, 'name': f'E2E Program {uid}', 'total_credits': 120}
    resp = post('/programs/', payload, token=token)
    expect_status(step, resp, 201)
    program_id = resp.json().get('id')

    # Step 5: Create Academic Year
    step = '5. Create Academic Year'
    payload = {'code': f'AY-{uid}', 'start_date': date.today().isoformat(), 'end_date': (date.today().replace(year=date.today().year + 1)).isoformat()}
    resp = post('/academic-years/', payload, token=token)
    expect_status(step, resp, 201)
    academic_year_id = resp.json().get('id')

    # Step 6: Create Lecturer (User)
    step = '6. Create Lecturer User'
    username = f'e2e_user_{uid}'
    payload = {'username': username, 'email': f'{username}@example.com', 'full_name': 'E2E Lecturer', 'password': 'pass1234'}
    resp = post('/users/', payload, token=token)
    expect_status(step, resp, 201)
    lecturer_id = resp.json().get('id')

    # Step 7: Create Subject
    step = '7. Create Subject'
    payload = {'department_id': department_id, 'code': f'E2E-SUB-{uid}', 'name_vi': 'E2E Mn hc', 'name_en': 'E2E Subject', 'credits': 3}
    resp = post('/subjects/', payload, token=token)
    expect_status(step, resp, 201)
    subject_id = resp.json().get('id')

    # Step 8: Create Syllabus (Draft)
    step = '8. Create Syllabus (Draft)'
    payload = {'subject_id': subject_id, 'program_id': program_id, 'academic_year_id': academic_year_id, 'lecturer_id': lecturer_id}
    resp = post('/syllabuses/', payload, token=token)
    expect_status(step, resp, 201)
    syllabus = resp.json()
    syllabus_id = syllabus.get('id')
    if syllabus.get('status') and syllabus.get('status') != 'DRAFT':
        fail(step, f"Expected status DRAFT, got {syllabus.get('status')}")

    # Step 9: Add CLO
    step = '9. Add CLO'
    payload = {'syllabus_id': syllabus_id, 'code': 'CLO-1', 'description': 'Understand basics of E2E.'}
    resp = post('/syllabus-clos/', payload, token=token)
    expect_status(step, resp, 201)
    clo_id = resp.json().get('id')

    # Step 10: Add Assessment Scheme
    step = '10. Add Assessment Scheme'
    payload = {'syllabus_id': syllabus_id, 'name': 'Progress Test', 'weight': 50}
    resp = post('/assessment-schemes/', payload, token=token)
    expect_status(step, resp, 201)
    scheme_id = resp.json().get('id')

    # Step 11: Add Assessment Component
    step = '11. Add Assessment Component'
    payload = {'scheme_id': scheme_id, 'name': 'Quiz 1', 'weight': 10}
    resp = post('/assessment-components/', payload, token=token)
    expect_status(step, resp, 201)
    component_id = resp.json().get('id')

    # Step 12: Map CLO to Component
    step = '12. Map CLO to Component'
    payload = {'assessment_component_id': component_id, 'syllabus_clo_id': clo_id}
    resp = post('/assessment-clos/', payload, token=token)
    expect_status(step, resp, 201)

    # Step 13: Verify Details
    step = '13. Verify Details'
    resp = get(f'/syllabuses/{syllabus_id}/details', token=token)
    expect_status(step, resp, 200)
    detail = resp.json()
    # Debug: dump details
    try:
        print(Fore.CYAN + json.dumps(detail, indent=2, ensure_ascii=False))
    except Exception:
        pass
    # Check CLO presence
    clos = detail.get('clos', [])
    if not any(c.get('id') == clo_id for c in clos):
        fail(step, 'CLO not found in syllabus details')
    # Check component presence inside assessment_schemes
    # API returns camelCase via BaseSchema; support both for robustness
    schemes = detail.get('assessmentSchemes') or detail.get('assessment_schemes', [])
    found_comp = False
    for s in schemes:
        for c in s.get('components', []):
            if c.get('id') == component_id:
                found_comp = True
                break
        if found_comp:
            break
    if not found_comp:
        fail(step, 'Component not found in syllabus details')
    log(step, 'CLO and Component found in syllabus details', 'OK')

    # Step 14: Submit Syllabus
    step = '14. Submit Syllabus'
    payload = {'user_id': lecturer_id}
    resp = post(f'/syllabuses/{syllabus_id}/submit', payload, token=token)
    expect_status(step, resp, 200)
    s = resp.json()
    if s.get('status') != 'PENDING':
        fail(step, f"Expected status PENDING, got {s.get('status')}")

    # Step 15: Approve Syllabus
    step = '15. Approve Syllabus'
    payload = {'action': 'APPROVE', 'user_id': lecturer_id}
    resp = post(f'/syllabuses/{syllabus_id}/evaluate', payload, token=token)
    expect_status(step, resp, 200)
    s = resp.json()
    if s.get('status') != 'APPROVED':
        fail(step, f"Expected status APPROVED, got {s.get('status')}")

    log('E2E', f'Successfully completed happy-path for syllabus {syllabus_id}', 'OK')


if __name__ == '__main__':
    try:
        run()
    except requests.exceptions.ConnectionError as e:
        print(Fore.RED + 'Failed to connect to API at ' + BASE_URL)
        print(str(e))
        sys.exit(2)
</file>

<file path="README.md">
# Syllabus Management System (SMD) - Backend 

## Description
A RESTful API built with **Flask** following a **Clean Architecture** style for managing university course syllabuses. The backend supports creating syllabuses, defining Course Learning Outcomes (CLOs), managing teaching plans, assessment schemes, rubrics, and an approval workflow with history logging.

---

## Tech Stack 
- **Framework:** Flask
- **Database:** MS SQL Server (accessed via SQLAlchemy + pymssql)
- **Architecture:** Clean Architecture (Controller  Service  Repository  Model)
- **DI Container:** dependency-injector
- **Serialization/Validation:** Marshmallow
- **Documentation:** Swagger UI (Flasgger)

---

## Key Features 
- **Master Data Management:** Faculties, Departments, Subjects, Academic Years, Programs, Users, Roles
- **Syllabus Management:** Create / Update syllabus header and general info (time allocation, prerequisites, versioning)
- **Syllabus Components:**
  - **CLOs:** Manage Course Learning Outcomes
  - **Materials:** Manage textbooks and references
  - **Teaching Plan:** Weekly schedule and activities
- **Assessment System:**
  - Define **Schemes** (Progress, Midterm, Final)
  - Define **Components** (Quiz, Lab, Exam)
  - **Rubrics:** Detailed scoring criteria
  - **Mapping:** Map assessment components to CLOs
- **Workflow:** Submit  Approve / Reject process with **WorkflowLog** history
- **Auth (Demo):** Basic auth controller returning a demo token; token decorator available for protecting endpoints

---

## Project Structure (brief)
```
src/
 api/                # HTTP controllers, schemas, middleware, swagger
   controllers/     # Blueprints for each resource
   schemas/         # Marshmallow schemas
 services/           # Business logic (services)
 infrastructure/     # DB models, repositories, DB adapters
   models/
   repositories/
 domain/             # Domain models/constants/exceptions
 scripts/            # Helper scripts (seed data, etc.)
 dependency_container.py  # DI wiring
 app.py              # App factory + blueprint registration
```

## Setup & Installation 

Follow these steps to get the backend running locally.

1. Clone the repository

```bash
git clone https://github.com/vux311/Backend_SMD.git
cd Backend_SMD
```

2. Create a virtual environment and activate it

```bash
python -m venv .venv
# Windows (PowerShell)
.venv\Scripts\Activate.ps1
# macOS / Linux
source .venv/bin/activate
```

3. Install dependencies

```bash
pip install -r src/requirements.txt
```

4. Environment variables

Create a `.env` file inside the `src/` folder containing at least:

```env
# Flask
SECRET_KEY=your_secret_key

# Database (SQLAlchemy URL)
DATABASE_URI=mssql+pymssql://sa:YourPassword@127.0.0.1:1433/YourDatabase
```

5. Database (MS SQL Server) via Docker (example)

```bash
docker pull mcr.microsoft.com/mssql/server:2025-latest
docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=YourPassword" -p 1433:1433 --name sql1 -d mcr.microsoft.com/mssql/server:2025-latest
```

---

## Seeding Data (Important) 

A seed script creates default roles and an example syllabus (Admin, Lecturer, Subject, sample CLOs, materials).

Run from repository root:

```bash
python -m src.scripts.seed_users
```

The script is idempotent and can be re-run safely.

---

## Running the App 

Start the development server:

```bash
python src/app.py
```

- Default port: **9999**
- Swagger UI: **http://localhost:9999/docs**

---

## API Documentation

Interactive API specification is available at the Swagger UI endpoint above. Use it to explore endpoints, request/response schemas, and try sample requests.

---

## Project Notes & Next Steps 

- Authentication included in a demo form (dummy tokens). For production, integrate full JWT-based auth and role-based access control.
- Recommended: add automated tests (unit + integration) and CI checks (linting/tests) for PR validation.

---

If you'd like, I can add a CONTRIBUTING guide, CI pipeline, or a small integration test that exercises the workflow (submit  approve/reject).
</file>

<file path="seed_all_data.py">
import sys
import os
import json
from datetime import datetime, date
from werkzeug.security import generate_password_hash

# --- CU HNH NG DN IMPORT ---
current_dir = os.path.dirname(os.path.abspath(__file__))
src_path = os.path.join(current_dir, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

# --- IMPORT MODULES ---
try:
    from infrastructure.databases.mssql import session, engine, Base
    from infrastructure.models import (
        User, Role, UserRole, Faculty, Department, Program, ProgramOutcome,
        Subject, AcademicYear, Syllabus, SyllabusClo, SyllabusMaterial,
        TeachingPlan, AssessmentScheme, AssessmentComponent, Rubric,
        CloPloMapping, AssessmentClo, SubjectRelationship,
        SystemSetting, StudentSubscription, StudentReport, Notification
    )
except ImportError as e:
    print(f" Li Import: {e}")
    sys.exit(1)

# ----------------------------------------

def hash_password(password: str) -> str:
    return generate_password_hash(password)

def seed_all():
    print(" Bt u np d liu mu (Full Enterprise Version)...")
    
    # 1. Reset Database (Optional - cn thn khi dng trn Prod)
    # Base.metadata.drop_all(bind=engine)
    try:
        Base.metadata.create_all(bind=engine)
        print("  kim tra/to bng Database.")
    except Exception as e:
        print(f" Cnh bo to bng: {e}")

    try:
        # ==========================================
        # PHN 1: H THNG & CU HNH
        # ==========================================
        print(" 1. Seeding System Settings...")
        settings = [
            ("PASSING_GRADE", "4.0", "FLOAT", "im sn qua mn"),
            ("MAX_FILE_SIZE", "10", "INT", "Kch thc file ti a (MB)"),
            ("CURRENT_TERM", "HK1_2025", "STRING", "Hc k hin ti"),
            ("ALLOW_STUDENT_COMMENT", "True", "BOOLEAN", "Cho php sinh vin bnh lun"),
            ("AI_MODEL_VERSION", "gemini-2.5-flash", "STRING", "Model AI mc nh")
        ]
        for key, val, type_, desc in settings:
            if not session.query(SystemSetting).filter_by(key=key).first():
                session.add(SystemSetting(key=key, value=val, type=type_, description=desc))
        session.flush()

        # ==========================================
        # PHN 2: T CHC & NGI DNG
        # ==========================================
        print(" 2. Seeding Roles, Faculties, Departments, Users...")
        
        # Roles
        roles_data = ["Admin", "Lecturer", "Head of Dept", "Academic Affairs", "Student", "Dean"]
        role_objs = {}
        for r_name in roles_data:
            role = session.query(Role).filter_by(name=r_name).first()
            if not role:
                role = Role(name=r_name, description=f"Vai tr {r_name}")
                session.add(role)
            role_objs[r_name] = role
        session.flush()

        # Faculty
        fit = session.query(Faculty).filter_by(code="FIT").first()
        if not fit:
            fit = Faculty(code="FIT", name="Cng ngh Thng tin")
            session.add(fit)
            session.flush()

        # Departments
        depts = [
            ("SE", "K thut Phn mm"),
            ("CS", "Khoa hc My tnh"),
            ("IS", "H thng Thng tin")
        ]
        dept_objs = {}
        for code, name in depts:
            d = session.query(Department).filter_by(code=code).first()
            if not d:
                d = Department(code=code, name=name, faculty_id=fit.id)
                session.add(d)
            dept_objs[code] = d
        session.flush()

        # Users
        users_config = [
            # Username, Name, Role, Dept Code
            ("admin", "Super Admin", "Admin", None),
            ("gv_se", "Nguyn Vn A (GV)", "Lecturer", "SE"),
            ("gv_cs", "Trn Th B (GV)", "Lecturer", "CS"),
            ("hod_se", "TS. L Vn C (Trng BM)", "Head of Dept", "SE"),
            ("aa_user", "Phng o To", "Academic Affairs", None),
            ("sv_hcmut", "Nguyn Sinh Vin", "Student", "SE"),
        ]
        
        user_map = {}
        default_pass = hash_password("123456")

        for uname, fullname, rname, dcode in users_config:
            u = session.query(User).filter_by(username=uname).first()
            dept_id = dept_objs[dcode].id if dcode else None
            
            if not u:
                u = User(
                    username=uname, email=f"{uname}@hcmut.edu.vn",
                    full_name=fullname, password_hash=default_pass,
                    department_id=dept_id, is_active=True
                )
                session.add(u)
                session.flush()
                # Assign Role
                session.add(UserRole(user_id=u.id, role_id=role_objs[rname].id))
            user_map[uname] = u
        session.flush()

        # ==========================================
        # PHN 3: CU TRC O TO (MASTER DATA)
        # ==========================================
        print(" 3. Seeding Academic Master Data...")

        # Academic Year
        ay = session.query(AcademicYear).filter_by(code="2025-2026").first()
        if not ay:
            ay = AcademicYear(code="2025-2026", start_date=date(2025,9,1), end_date=date(2026,6,30))
            session.add(ay)
            session.flush()

        # Program (CTT)
        prog = session.query(Program).filter_by(name="K s PM K2025").first()
        if not prog:
            prog = Program(department_id=dept_objs["SE"].id, name="K s PM K2025", total_credits=150)
            session.add(prog)
            session.flush()

        # Program Outcomes (PLOs)
        plo_objs = []
        existing_plos = session.query(ProgramOutcome).filter_by(program_id=prog.id).count()
        if existing_plos == 0:
            plos_data = [
                ("PLO1", "p dng kin thc ton hc, khoa hc v k thut"),
                ("PLO2", "Thit k v hin thc ha gii php phn mm"),
                ("PLO3", "K nng giao tip v lm vic nhm"),
                ("PLO4", "Nhn thc v o c ngh nghip"),
                ("PLO5", "Kh nng hc tp sut i")
            ]
            for c, d in plos_data:
                p = ProgramOutcome(program_id=prog.id, code=c, description=d)
                session.add(p)
                plo_objs.append(p)
            session.flush()
        else:
            plo_objs = session.query(ProgramOutcome).filter_by(program_id=prog.id).all()

        # Subjects
        subjects_data = [
            ("IT001", "Nhp mn Lp trnh", 3),
            ("SE104", "Nhp mn CNPM", 3),
            ("SE301", "Kim th phn mm", 3),
            ("SE401", " n chuyn ngnh", 2)
        ]
        subj_map = {}
        for code, name, cr in subjects_data:
            s = session.query(Subject).filter_by(code=code).first()
            if not s:
                s = Subject(
                    department_id=dept_objs["SE"].id,
                    code=code, name_vi=name, name_en=name + " (En)",
                    credits=cr, credit_theory=cr, credit_practice=0, credit_self_study=cr*2
                )
                session.add(s)
            subj_map[code] = s
        session.flush()

        # Subject Relationships (Mn tin quyt)
        # IT001 -> SE104
        rel = session.query(SubjectRelationship).filter_by(subject_id=subj_map["SE104"].id, related_subject_id=subj_map["IT001"].id).first()
        if not rel:
            session.add(SubjectRelationship(
                subject_id=subj_map["SE104"].id, 
                related_subject_id=subj_map["IT001"].id, 
                type="PREREQUISITE"
            ))

        # ==========================================
        # PHN 4:  CNG CHI TIT (SYLLABUS FULL)
        # ==========================================
        print(" 4. Seeding Full Syllabus (Header + Children)...")
        
        # To Syllabus cho mn SE104
        target_sub = subj_map["SE104"]
        lecturer = user_map["gv_se"]
        
        syl = session.query(Syllabus).filter_by(subject_id=target_sub.id, version="2.0").first()
        if not syl:
            syl = Syllabus(
                subject_id=target_sub.id,
                program_id=prog.id,
                academic_year_id=ay.id,
                lecturer_id=lecturer.id,
                status="APPROVED", #  duyt  SV thy
                version="2.0",
                time_allocation=json.dumps({"theory": 30, "practice": 15, "self_study": 90}),
                prerequisites="IT001 - Nhp mn lp trnh",
                publish_date=datetime.now(),
                is_active=True
            )
            session.add(syl)
            session.flush()

            # 4.1 Syllabus CLOs
            clo1 = SyllabusClo(syllabus_id=syl.id, code="CLO1", description="Hiu cc quy trnh pht trin phn mm (Waterfall, Agile)")
            clo2 = SyllabusClo(syllabus_id=syl.id, code="CLO2", description="Vn dng k thut ly yu cu v phn tch")
            clo3 = SyllabusClo(syllabus_id=syl.id, code="CLO3", description="Thit k kin trc h thng c bn")
            session.add_all([clo1, clo2, clo3])
            session.flush()

            # 4.2 CLO-PLO Mapping
            # Map CLO1 -> PLO1 (I), CLO2 -> PLO2 (R), CLO3 -> PLO2 (M)
            if len(plo_objs) >= 2:
                session.add(CloPloMapping(syllabus_clo_id=clo1.id, program_plo_id=plo_objs[0].id, level="I"))
                session.add(CloPloMapping(syllabus_clo_id=clo2.id, program_plo_id=plo_objs[1].id, level="R"))
                session.add(CloPloMapping(syllabus_clo_id=clo3.id, program_plo_id=plo_objs[1].id, level="M"))

            # 4.3 Materials
            mat1 = SyllabusMaterial(syllabus_id=syl.id, type="MAIN", title="Software Engineering (10th Edition)", author="Ian Sommerville")
            mat2 = SyllabusMaterial(syllabus_id=syl.id, type="REFERENCE", title="Clean Code", author="Robert C. Martin")
            session.add_all([mat1, mat2])

            # 4.4 Teaching Plan
            plans = [
                TeachingPlan(syllabus_id=syl.id, week=1, topic="Tng quan CNPM", activity="Ging l thuyt", assessment="im danh"),
                TeachingPlan(syllabus_id=syl.id, week=2, topic="Quy trnh phn mm", activity="Tho lun nhm", assessment="Quiz 1"),
                TeachingPlan(syllabus_id=syl.id, week=3, topic="Thu thp yu cu", activity="Thc hnh Lab", assessment="Bi tp 1"),
            ]
            session.add_all(plans)

            # 4.5 Assessment Scheme -> Component -> Rubric
            # Scheme: Qu trnh (50%)
            scheme1 = AssessmentScheme(syllabus_id=syl.id, name="nh gi qu trnh", weight=50)
            session.add(scheme1)
            session.flush()

            comp1 = AssessmentComponent(scheme_id=scheme1.id, name=" n nhm", weight=30)
            comp2 = AssessmentComponent(scheme_id=scheme1.id, name="Kim tra trc nghim", weight=20)
            session.add_all([comp1, comp2])
            session.flush()

            # Mapping Assessment -> CLO
            #  n nhm nh gi CLO2 v CLO3
            session.add(AssessmentClo(assessment_component_id=comp1.id, syllabus_clo_id=clo2.id))
            session.add(AssessmentClo(assessment_component_id=comp1.id, syllabus_clo_id=clo3.id))
            
            # Rubric cho  n nhm
            rubric1 = Rubric(component_id=comp1.id, criteria="Ti liu SRS", max_score=5, description_level_pass="y  use case", description_level_fail="Thiu diagram")
            rubric2 = Rubric(component_id=comp1.id, criteria="Thit k DB", max_score=5, description_level_pass="Chun ha 3NF", description_level_fail="Sai quan h")
            session.add_all([rubric1, rubric2])

            # Scheme: Cui k (50%)
            scheme2 = AssessmentScheme(syllabus_id=syl.id, name="Thi cui k", weight=50)
            session.add(scheme2)
            session.flush()
            
            comp3 = AssessmentComponent(scheme_id=scheme2.id, name="Bi thi t lun", weight=50)
            session.add(comp3)
            session.flush()
            # Thi cui k nh gi ht
            session.add(AssessmentClo(assessment_component_id=comp3.id, syllabus_clo_id=clo1.id))
            session.add(AssessmentClo(assessment_component_id=comp3.id, syllabus_clo_id=clo2.id))
            session.add(AssessmentClo(assessment_component_id=comp3.id, syllabus_clo_id=clo3.id))

        # ==========================================
        # PHN 5: TNH NNG SINH VIN & THNG BO
        # ==========================================
        print(" 5. Seeding Student Features & Notifications...")
        
        student = user_map["sv_hcmut"]
        
        # Student Subscription (SV ng k theo di mn SE104)
        sub = session.query(StudentSubscription).filter_by(student_id=student.id, subject_id=subj_map["SE104"].id).first()
        if not sub:
            session.add(StudentSubscription(student_id=student.id, subject_id=subj_map["SE104"].id))

        # Student Report (SV bo li  cng)
        # Ch to nu syllabus  tn ti
        if syl:
            rep = session.query(StudentReport).filter_by(student_id=student.id, syllabus_id=syl.id).first()
            if not rep:
                session.add(StudentReport(
                    student_id=student.id, 
                    syllabus_id=syl.id, 
                    content="Mc ti liu tham kho link b hng .",
                    status="PENDING"
                ))

        # Notification (Thng bo cho GV)
        note = session.query(Notification).filter_by(user_id=lecturer.id, title="H thng  sn sng").first()
        if not note:
            session.add(Notification(
                user_id=lecturer.id,
                title="H thng  sn sng",
                message="Cho mng bn n vi h thng qun l  cng v2.0",
                type="SYSTEM",
                is_read=False
            ))

        session.commit()
        print("\n SEEDING HON TT THNH CNG! (ALL SYSTEMS GO) ")
        print(f" Admin: admin / 123456")
        print(f" Lecturer: gv_se / 123456")
        print(f" Student: sv_hcmut / 123456")

    except Exception as e:
        session.rollback()
        print(f"\n C LI XY RA: {e}")
        import traceback
        traceback.print_exc()
    finally:
        session.close()

if __name__ == "__main__":
    seed_all()
</file>

<file path="src/api/controllers/syllabus_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_service import SyllabusService
from api.schemas.syllabus_schema import SyllabusSchema
from api.schemas.syllabus_detail_schema import SyllabusDetailSchema
from api.middleware import token_required

syllabus_bp = Blueprint('syllabus', __name__, url_prefix='/syllabuses')

schema = SyllabusSchema()
detail_schema = SyllabusDetailSchema()

@syllabus_bp.route('/', methods=['GET'])
@inject
def list_syllabuses(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """List syllabuses
    ---
    get:
      summary: List syllabuses
      tags:
        - Syllabuses
      responses:
        200:
          description: List of syllabuses
    """
    items = syllabus_service.list_syllabuses()
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_bp.route('/<int:id>', methods=['GET'])
@inject
def get_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get syllabus
    ---
    get:
      summary: Get syllabus by id
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Syllabus object
        404:
          description: Not found
    """
    s = syllabus_service.get_syllabus(id)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200


@syllabus_bp.route('/<int:id>/details', methods=['GET'])
@inject
def get_syllabus_details(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get full syllabus details
    ---
    get:
      summary: Get syllabus details by id
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Syllabus detail object
        404:
          description: Not found
    """
    s = syllabus_service.get_syllabus_details(id)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(detail_schema.dump(s)), 200


@syllabus_bp.route('/compare', methods=['GET'])
@inject
def compare_syllabuses(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Compare two syllabuses by id
    ---
    get:
      summary: Compare two syllabuses
      tags:
        - Syllabuses
      parameters:
        - name: base_id
          in: query
          required: true
          schema:
            type: integer
        - name: target_id
          in: query
          required: true
          schema:
            type: integer
    responses:
      200:
        description: Differences between the two syllabuses
      404:
        description: Syllabus not found
    """
    try:
        base_id = int(request.args.get('baseId') or request.args.get('base_id'))
        target_id = int(request.args.get('targetId') or request.args.get('target_id'))
    except Exception:
        return jsonify({'message': 'base_id and target_id query parameters are required and must be integers'}), 400

    base = syllabus_service.get_syllabus_details(base_id)
    target = syllabus_service.get_syllabus_details(target_id)

    if not base or not target:
        return jsonify({'message': 'One or both syllabuses not found'}), 404

    # Fields to compare
    fields = ['subject_name_vi', 'credits', 'description', 'student_duties']
    diffs = []
    for f in fields:
        base_val = getattr(base, f, None)
        target_val = getattr(target, f, None)
        if base_val != target_val:
            diffs.append({'field': f, 'base': base_val, 'target': target_val})

    # Compare CLO counts
    base_clos = getattr(base, 'clos', []) or []
    target_clos = getattr(target, 'clos', []) or []
    if len(base_clos) != len(target_clos):
        diffs.append({'field': 'clos_count', 'base': len(base_clos), 'target': len(target_clos)})

    return jsonify({'diffs': diffs}), 200


@syllabus_bp.route('/<int:id>/submit', methods=['POST'])
@inject
def submit_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Submit a syllabus for evaluation
    ---
    post:
      summary: Submit syllabus
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
      responses:
        200:
          description: Submitted syllabus
        400:
          description: Invalid action
        404:
          description: Not found
    """
    data = request.get_json() or {}
    user_id = data.get('user_id')
    if not user_id:
        return jsonify({'message': 'user_id is required'}), 400
    try:
        s = syllabus_service.submit_syllabus(id, user_id)
    except ValueError as e:
        return jsonify({'message': str(e)}), 400
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200


@syllabus_bp.route('/<int:id>/evaluate', methods=['POST'])
@inject
def evaluate_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Evaluate (approve/reject) a syllabus
    ---
    post:
      summary: Evaluate syllabus
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
      responses:
        200:
          description: Evaluation result
        400:
          description: Invalid action or missing comment
        404:
          description: Not found
    """
    data = request.get_json() or {}
    action = data.get('action')
    user_id = data.get('user_id')
    comment = data.get('comment')
    if not action or not user_id:
        return jsonify({'message': 'action and user_id are required'}), 400
    try:
        s = syllabus_service.evaluate_syllabus(id, user_id, action, comment)
    except ValueError as e:
        return jsonify({'message': str(e)}), 400
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200


@syllabus_bp.route('/<int:id>/workflow-logs', methods=['GET'])
@inject
def get_workflow_logs(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get workflow logs for a syllabus
    ---
    get:
      summary: Get workflow logs
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: List of workflow logs
        404:
          description: Not found
    """
    logs = syllabus_service.get_workflow_logs(id)
    from api.schemas.workflow_log_schema import WorkflowLogSchema
    schema_w = WorkflowLogSchema()
    return jsonify(schema_w.dump(logs, many=True)), 200

@syllabus_bp.route('/', methods=['POST'])
@inject
@token_required
def create_syllabus(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Create a syllabus
    ---
    post:
      summary: Create syllabus
      tags:
        - Syllabuses
      requestBody:
        required: true
      responses:
        201:
          description: Created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        s = syllabus_service.create_syllabus(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(s)), 201

@syllabus_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    s = syllabus_service.update_syllabus(id, data)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200

@syllabus_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    ok = syllabus_service.delete_syllabus(id)
    if not ok:
        return jsonify({'message': 'Syllabus not found'}), 404
    return '', 204
</file>

<file path="src/api/controllers/user_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.user_service import UserService
from api.schemas.user_schema import UserSchema
from api.middleware import token_required

user_bp = Blueprint('user', __name__, url_prefix='/users')

schema = UserSchema()

@user_bp.route('/', methods=['GET'])
@inject
def list_users(user_service: UserService = Provide[Container.user_service]):
    """Get all users
    ---
    get:
      summary: Get all users
      tags:
        - Users
      responses:
        200:
          description: List of users
    """
    users = user_service.list_users()
    return jsonify(schema.dump(users, many=True)), 200

@user_bp.route('/<int:id>', methods=['GET'])
@inject
def get_user(id: int, user_service: UserService = Provide[Container.user_service]):
    """Get user by id
    ---
    get:
      summary: Get user by ID
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: User object
        404:
          description: Not found
    """
    user = user_service.get_user(id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    return jsonify(schema.dump(user)), 200


@user_bp.route('/me', methods=['GET'])
@inject
@token_required
def get_me(user_service: UserService = Provide[Container.user_service]):
    """Get current user from token
    """
    from flask import request
    payload = getattr(request, 'user', None)
    if not payload:
        return jsonify({'message': 'User not found in token'}), 404
    user_id = payload.get('user_id')
    if not user_id:
        return jsonify({'message': 'user_id missing in token'}), 400
    user = user_service.get_user(user_id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    return jsonify(schema.dump(user)), 200

@user_bp.route('/', methods=['POST'])
@inject
def create_user(user_service: UserService = Provide[Container.user_service]):
    """Create a new user
    ---
    post:
      summary: Create a new user
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/User'
      responses:
        201:
          description: User created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    user = user_service.create_user(data)
    return jsonify(schema.dump(user)), 201

@user_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_user(id: int, user_service: UserService = Provide[Container.user_service]):
    """Update an existing user
    ---
    put:
      summary: Update user
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/User'
      responses:
        200:
          description: User updated
        400:
          description: Invalid input
        404:
          description: User not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    user = user_service.update_user(id, data)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    return jsonify(schema.dump(user)), 200
</file>

<file path="src/api/schemas/syllabus_schema.py">
import json
from marshmallow import fields, post_dump
from marshmallow.validate import Length
from .base_schema import BaseSchema

class SyllabusSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    program_id = fields.Int(required=True)
    academic_year_id = fields.Int(required=True)
    lecturer_id = fields.Int(required=True)

    status = fields.Str(dump_only=True)
    version = fields.Str(load_default="1.0", validate=Length(max=10))
    
    # FIX: time_allocation as Dict -> Use Raw to accept DB-stored JSON string
    time_allocation = fields.Raw(allow_none=True)  # Changed from Dict to Raw to handle DB String
    prerequisites = fields.Str(load_default=None)
    publish_date = fields.DateTime(load_default=None)

    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)

    # FIX: Add nested fields for input (load_default=[])
    clos = fields.List(fields.Nested('SyllabusCloSchema'), load_default=[])
    materials = fields.List(fields.Nested('SyllabusMaterialSchema'), load_default=[])
    teaching_plans = fields.List(fields.Nested('TeachingPlanSchema'), load_default=[])
    assessment_schemes = fields.List(fields.Nested('AssessmentSchemeSchema'), load_default=[])

    @post_dump
    def parse_json(self, data, **kwargs):
        if 'timeAllocation' in data and isinstance(data['timeAllocation'], str):
            try:
                data['timeAllocation'] = json.loads(data['timeAllocation'])
            except:
                pass
        return data
</file>

<file path="src/infrastructure/databases/mssql.py">
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from config import Config
from infrastructure.databases.base import Base

# Database configuration
DATABASE_URI = Config.DATABASE_URI
engine = create_engine(DATABASE_URI)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
session = SessionLocal()
def init_mssql(app):
    Base.metadata.create_all(bind=engine)
</file>

<file path="src/infrastructure/models/__init__.py">
from .user_model import User
from .user_role_model import UserRole
from .role_model import Role
from .faculty_model import Faculty
from .department_model import Department
from .program_model import Program
from .program_outcome_model import ProgramOutcome
from .subject_model import Subject
from .academic_year_model import AcademicYear
from .syllabus_model import Syllabus
from .syllabus_clo_model import SyllabusClo
from .syllabus_material_model import SyllabusMaterial
from .teaching_plan_model import TeachingPlan
from .assessment_scheme_model import AssessmentScheme
from .assessment_component_model import AssessmentComponent
from .rubric_model import Rubric
from .clo_plo_mapping_model import CloPloMapping
from .assessment_clo_model import AssessmentClo
from .subject_relationship_model import SubjectRelationship
from .system_setting_model import SystemSetting
from .student_subscription_model import StudentSubscription
from .student_report_model import StudentReport
from .notification_model import Notification
from .syllabus_comment_model import SyllabusComment
from .workflow_log_model import WorkflowLog
from .workflow_state_model import WorkflowState
from .workflow_transition_model import WorkflowTransition
from .syllabus_current_workflow import SyllabusCurrentWorkflow
from .ai_auditlog_model import AiAuditLog

__all__ = [
    "User", "UserRole", "Role", "Faculty", "Department", "Program",
    "ProgramOutcome", "Subject", "AcademicYear", "Syllabus", "SyllabusClo",
    "SyllabusMaterial", "TeachingPlan", "AssessmentScheme", "AssessmentComponent", "Rubric",
    "CloPloMapping", "AssessmentClo", "SubjectRelationship", "SystemSetting",
    "StudentSubscription", "StudentReport", "Notification", "SyllabusComment",
    "WorkflowLog", "WorkflowState", "WorkflowTransition", "SyllabusCurrentWorkflow",
    "AiAuditLog"
]
</file>

<file path="src/infrastructure/models/file_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
# IMPORT BASE CHUNG (QUAN TRNG)
from infrastructure.databases.base import Base

class File(Base):
    __tablename__ = 'files'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    uploader_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    file_name = Column(NVARCHAR(255), nullable=False)
    file_path = Column(NVARCHAR(500), nullable=False)
    file_size = Column(BigInteger)
    mime_type = Column(NVARCHAR(100))
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    uploader = relationship("User", back_populates="uploaded_files", foreign_keys=[uploader_id])
</file>

<file path="src/infrastructure/models/program_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Program(Base):
    __tablename__ = 'programs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    total_credits = Column(Integer)
    
    # Relationships
    department = relationship("Department", back_populates="programs")
    outcomes = relationship("ProgramOutcome", back_populates="program")
    syllabuses = relationship("Syllabus", back_populates="program")
</file>

<file path="src/requirements.txt">
Flask>=2.0
Flask-Cors>=3.0
Flask-SQLAlchemy>=2.5
SQLAlchemy>=1.4
marshmallow>=3.0
pymssql>=2.2
python-dotenv>=0.21 
Flask-RESTX>=1.1.0 
flasgger
fastapi
apispec
apispec_webframeworks
flask-swagger-ui
dependency-injector>=4.0
PyJWT>=2.0
google-genai>=0.1
</file>

<file path="src/infrastructure/models/user_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
# IMPORT BASE CHUNG (QUAN TRNG)
from infrastructure.databases.base import Base

class User(Base):
    __tablename__ = 'users'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=True)
    username = Column(NVARCHAR(50), unique=True, nullable=False)
    email = Column(NVARCHAR(100), unique=True, nullable=False)
    password_hash = Column(NVARCHAR(255), nullable=False)
    full_name = Column(NVARCHAR(100), nullable=False)
    is_active = Column(Boolean, default=True)
    
    # SA LI VNG LP: Thm use_alter=True
    avatar_file_id = Column(BigInteger, ForeignKey('files.id', use_alter=True, name='fk_user_avatar_file'), nullable=True)
    
    # Relationships
    department = relationship("Department", back_populates="users")
    
    # Lu : Cp nht tn relationship nu file_model dng tn class l File
    avatar_file = relationship("File", foreign_keys=[avatar_file_id])
    uploaded_files = relationship("File", back_populates="uploader", foreign_keys="File.uploader_id")
    
    roles = relationship("UserRole", back_populates="user")
    syllabuses = relationship("Syllabus", back_populates="lecturer")
    comments = relationship("SyllabusComment", back_populates="user")
    notifications = relationship("Notification", back_populates="user")
    workflow_logs = relationship("WorkflowLog", back_populates="actor")
</file>

<file path="src/services/syllabus_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_repository import SyllabusRepository

class SyllabusService:
    def __init__(self, repository: SyllabusRepository,
                 subject_repository=None,
                 program_repository=None,
                 academic_year_repository=None,
                 user_repository=None,
                 workflow_log_repository=None,
                 syllabus_clo_repository=None,
                 syllabus_material_repository=None,
                 teaching_plan_repository=None,
                 assessment_scheme_repository=None,
                 assessment_component_repository=None,
                 rubric_repository=None,
                 assessment_clo_repository=None):
        self.repository = repository
        self.subject_repository = subject_repository
        self.program_repository = program_repository
        self.academic_year_repository = academic_year_repository
        self.user_repository = user_repository
        self.workflow_log_repository = workflow_log_repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.syllabus_material_repository = syllabus_material_repository
        self.teaching_plan_repository = teaching_plan_repository
        self.assessment_scheme_repository = assessment_scheme_repository
        self.assessment_component_repository = assessment_component_repository
        self.rubric_repository = rubric_repository
        self.assessment_clo_repository = assessment_clo_repository

    def list_syllabuses(self) -> List:
        return self.repository.get_all()

    def get_syllabus(self, id: int):
        return self.repository.get_by_id(id)

    def get_syllabus_details(self, id: int):
        return self.repository.get_details(id)

    def get_by_subject(self, subject_id: int):
        return self.repository.get_by_subject_id(subject_id)

    def create_syllabus(self, data: dict):
        import json
        
        # Extract child data
        clos_data = data.pop('clos', [])
        materials_data = data.pop('materials', [])
        plans_data = data.pop('teaching_plans', [])
        schemes_data = data.pop('assessment_schemes', [])

        # Handle time_allocation (Dict -> JSON String)
        if 'time_allocation' in data and isinstance(data['time_allocation'], dict):
            data['time_allocation'] = json.dumps(data['time_allocation'])

        # Validate Foreign Keys
        subject_id = data.get('subject_id')
        if not subject_id or not self.subject_repository.get_by_id(subject_id):
            raise ValueError('Invalid subject_id')
        program_id = data.get('program_id')
        if not program_id or not self.program_repository.get_by_id(program_id):
            raise ValueError('Invalid program_id')
        academic_year_id = data.get('academic_year_id')
        if not academic_year_id or not self.academic_year_repository.get_by_id(academic_year_id):
            raise ValueError('Invalid academic_year_id')
        lecturer_id = data.get('lecturer_id')
        if not lecturer_id or not self.user_repository.get_by_id(lecturer_id):
            raise ValueError('Invalid lecturer_id')

        # Create Header
        data.setdefault('status', 'DRAFT')
        new_syllabus = self.repository.create(data)
        sid = new_syllabus.id

        # 1. Save CLOs
        if self.syllabus_clo_repository:
            for item in clos_data:
                item['syllabus_id'] = sid
                self.syllabus_clo_repository.create(item)

        # 2. Save Materials
        if self.syllabus_material_repository:
            for item in materials_data:
                item['syllabus_id'] = sid
                self.syllabus_material_repository.create(item)

        # 3. Save Teaching Plans
        if self.teaching_plan_repository:
            for item in plans_data:
                item['syllabus_id'] = sid
                self.teaching_plan_repository.create(item)

        # 4. Save Assessment Schemes (Nested)
        if self.assessment_scheme_repository:
            for scheme in schemes_data:
                components = scheme.pop('components', [])
                scheme['syllabus_id'] = sid
                new_scheme = self.assessment_scheme_repository.create(scheme)
                if self.assessment_component_repository:
                    for comp in components:
                        rubrics = comp.pop('rubrics', [])
                        comp['scheme_id'] = new_scheme.id
                        new_comp = self.assessment_component_repository.create(comp)
                        if self.rubric_repository:
                            for rub in rubrics:
                                rub['component_id'] = new_comp.id
                                self.rubric_repository.create(rub)

        return new_syllabus

    def update_syllabus(self, id: int, data: dict):
        # Check current status before allowing update
        s = self.repository.get_by_id(id)
        if not s:
            return None
        if s.status not in ('DRAFT', 'REJECTED'):
            raise ValueError(f"Cannot update syllabus in {s.status} status")
        return self.repository.update(id, data)

    def delete_syllabus(self, id: int) -> bool:
        return self.repository.delete(id)

    # Workflow methods
    def submit_syllabus(self, id: int, user_id: int):
        s = self.repository.get_by_id(id)
        if not s:
            return None
        
        current_status = (s.status or '').upper()
        if current_status not in ('DRAFT', 'REJECTED', 'RETURNED'):
             raise ValueError(f'Syllabus cannot be submitted in current status: {s.status}')
        
        from_status = s.status
        updated = self.repository.update(id, {'status': 'PENDING'})
        if self.workflow_log_repository:
            self.workflow_log_repository.create({
                'syllabus_id': id,
                'actor_id': user_id,
                'action': 'SUBMIT',
                'from_status': from_status,
                'to_status': 'PENDING',
                'comment': None
            })
        return updated

    def evaluate_syllabus(self, id: int, user_id: int, action: str, comment: Optional[str] = None):
        s = self.repository.get_by_id(id)
        if not s:
            return None
        action = action.upper()
        if action not in ('APPROVE', 'REJECT'):
            raise ValueError('Invalid action')
        from_status = s.status
        if action == 'APPROVE':
            new_status = 'APPROVED'
        else:  # REJECT
            if not comment:
                raise ValueError('Comment is required when rejecting')
            new_status = 'DRAFT'
        updated = self.repository.update(id, {'status': new_status})
        if self.workflow_log_repository:
            self.workflow_log_repository.create({
                'syllabus_id': id,
                'actor_id': user_id,
                'action': action,
                'from_status': from_status,
                'to_status': new_status,
                'comment': comment
            })
        return updated

    def get_workflow_logs(self, syllabus_id: int):
        if not self.workflow_log_repository:
            return []
        return self.workflow_log_repository.get_by_syllabus_id(syllabus_id)
</file>

<file path="src/api/controllers/auth_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.user_service import UserService
from werkzeug.security import check_password_hash

auth_bp = Blueprint('auth', __name__, url_prefix='/auth')

@auth_bp.route('/login', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def login(user_service: UserService = Provide[Container.user_service]):
    """
    Login and obtain a token
    ---
    tags:
      - Auth
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              username:
                type: string
              password:
                type: string
            required:
              - username
              - password
    responses:
      200:
        description: Login successful, returns token and user information
      400:
        description: Missing username or password
      401:
        description: Invalid credentials
    """
    if request.method == 'OPTIONS':
      # Fast path for CORS preflight
      return jsonify({'message': 'CORS preflight OK'}), 200

    data = request.get_json() or {}
    username = data.get('username')
    password = data.get('password')
    if not username or not password:
        return jsonify({'message': 'username and password are required'}), 400
    user = user_service.get_by_username(username)
    if not user:
        return jsonify({'message': 'Invalid credentials'}), 401
    if not check_password_hash(user.password_hash, password):
        return jsonify({'message': 'Invalid credentials'}), 401

    # Get role name if available
    role_name = None
    try:
        if user.roles and len(user.roles) > 0 and getattr(user.roles[0], 'role', None):
            role_name = user.roles[0].role.name
    except Exception:
        role_name = None

    token = f"fake-jwt-token-for-{username}"
    return jsonify({'token': token, 'user_id': user.id, 'role': role_name}), 200
</file>

<file path="src/api/middleware.py">
# Middleware functions for processing requests and responses

from flask import  request, jsonify

def log_request_info(app):
    app.logger.debug('Headers: %s', request.headers)
    app.logger.debug('Body: %s', request.get_data())

def handle_options_request():
    return jsonify({'message': 'CORS preflight response'}), 200

from flask import current_app
from werkzeug.exceptions import HTTPException
import traceback

def error_handling_middleware(error):
    # Handle HTTP exceptions (e.g., BadRequest) with their status codes
    if isinstance(error, HTTPException):
        response = jsonify({'error': error.description})
        response.status_code = error.code or 400
        return response

    # Log unexpected exceptions with traceback
    try:
        current_app.logger.exception(error)
    except Exception:
        pass

    tb = None
    try:
        tb = traceback.format_exc()
    except Exception:
        tb = None

    payload = {'error': str(error)}
    if getattr(current_app, 'debug', False) and tb:
        payload['traceback'] = tb

    response = jsonify(payload)
    response.status_code = 500
    return response

def add_custom_headers(response):
    response.headers['X-Custom-Header'] = 'Value'
    return response

from functools import wraps


def middleware(app):
    @app.before_request
    def before_request():
        log_request_info(app)

    @app.after_request
    def after_request(response):
        return add_custom_headers(response)

    @app.errorhandler(Exception)
    def handle_exception(error):
        return error_handling_middleware(error)

    @app.route('/options', methods=['OPTIONS'])
    def options_route():
        return handle_options_request()


# Token decorator verifying JWT
import jwt
from config import Config

def token_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        from flask import request, make_response
        # Allow preflight CORS requests through without authentication
        if request.method == 'OPTIONS':
            return make_response('', 200)
        auth = request.headers.get('Authorization', '')
        if not auth or not auth.startswith('Bearer '):
            return jsonify({'message': 'Authorization token is missing'}), 401
        token = auth.split(' ', 1)[1]
        try:
            payload = jwt.decode(token, Config.SECRET_KEY, algorithms=['HS256'])
            # Optionally attach user info to request context
            request.user = payload
        except jwt.ExpiredSignatureError:
            return jsonify({'message': 'Token expired'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'message': 'Invalid token'}), 401
        return f(*args, **kwargs)

    return decorated
</file>

<file path="src/config.py">
# Configuration settings for the Flask application

import os
from dotenv import load_dotenv
load_dotenv()

class Config:
    """Base configuration."""
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'a_default_secret_key'
    DEBUG = os.environ.get('DEBUG', 'False').lower() in ['true', '1']
    TESTING = os.environ.get('TESTING', 'False').lower() in ['true', '1']
    
    DATABASE_URI = os.environ.get('DATABASE_URI') 
    CORS_HEADERS = 'Content-Type'

class DevelopmentConfig(Config):
    """Development configuration."""
    DEBUG = True
    DATABASE_URI = os.environ.get('DATABASE_URI') 


class TestingConfig(Config):
    """Testing configuration."""
    TESTING = True
    DATABASE_URI = os.environ.get('DATABASE_URI')


class ProductionConfig(Config):
    """Production configuration."""
    DATABASE_URI = os.environ.get('DATABASE_URI') 

    
template = {
    "swagger": "2.0",
    "info": {
        "title": "Syllabus Management API",
        "description": "API for Syllabus Management (SMD)",
        "version": "1.0.0"
    },
    "basePath": "/",
    "schemes": [
        "http",
        "https"
    ],
    "consumes": [
        "application/json"
    ],
    "produces": [
        "application/json"
    ]
}
class SwaggerConfig:
    """Swagger configuration."""
    template = {
        "swagger": "2.0",
        "info": {
            "title": "Syllabus Management API",
            "description": "API for Syllabus Management (SMD)",
            "version": "1.0.0"
        },
        "basePath": "/",
        "schemes": [
            "http",
            "https"
        ],
        "consumes": [
            "application/json"
        ],
        "produces": [
            "application/json"
        ]
    }

    swagger_config = {
        "headers": [],
        "specs": [
            {
                "endpoint": 'apispec',
                "route": '/apispec.json',
                "rule_filter": lambda rule: True,
                "model_filter": lambda tag: True,
            }
        ],
        "static_url_path": "/flasgger_static",
        "swagger_ui": True,
        "specs_route": "/docs"
    }
</file>

<file path="src/scripts/seed_users.py">
from dependency_container import Container
from datetime import date


def get_or_create(service, list_method_name, check_attr, check_value, create_method_name, create_data):
    list_method = getattr(service, list_method_name)
    for item in list_method():
        if getattr(item, check_attr) == check_value:
            return item
    create_method = getattr(service, create_method_name)
    return create_method(create_data)


def seed():
    container = Container()

    # Services
    role_service = container.role_service()
    user_service = container.user_service()
    faculty_service = container.faculty_service()
    department_service = container.department_service()
    academic_year_service = container.academic_year_service()
    program_service = container.program_service()
    subject_service = container.subject_service()
    syllabus_service = container.syllabus_service()
    syllabus_clo_service = container.syllabus_clo_service()
    syllabus_material_service = container.syllabus_material_service()

    # 1) Roles
    admin_role = role_service.get_by_name('ADMIN') or role_service.create_role({'name': 'ADMIN', 'description': 'ADMIN role'})
    print('  Role:', admin_role.name)
    lecturer_role = role_service.get_by_name('LECTURER') or role_service.create_role({'name': 'LECTURER', 'description': 'LECTURER role'})
    print('  Role:', lecturer_role.name)

    # 2) Users
    admin = user_service.get_by_username('admin')
    if not admin:
        admin = user_service.create_user({'username': 'admin', 'email': 'admin@example.com', 'full_name': 'Admin User', 'password': 'password123', 'is_active': True})
        print('  Created User: admin')
    else:
        print('  Found User: admin')

    lecturer = user_service.get_by_username('lecturer')
    if not lecturer:
        lecturer = user_service.create_user({'username': 'lecturer', 'email': 'lecturer@example.com', 'full_name': 'Lecturer User', 'password': 'password123', 'is_active': True})
        print('  Created User: lecturer')
    else:
        print('  Found User: lecturer')

    # Assign roles idempotently
    session = container.db_session()
    from infrastructure.models.user_role_model import UserRole

    def ensure_role(user, role):
        if not session.query(UserRole).filter_by(user_id=user.id, role_id=role.id).first():
            try:
                session.add(UserRole(user_id=user.id, role_id=role.id))
                session.commit()
                print(f"  Assigned role {role.name} to user {user.username}")
            except Exception:
                session.rollback()

    ensure_role(admin, admin_role)
    ensure_role(lecturer, lecturer_role)

    # 3) Faculty & Department
    faculty = get_or_create(faculty_service, 'list_faculties', 'code', 'FIT', 'create_faculty', {'code': 'FIT', 'name': 'Faculty of Information Technology'})
    print(f"  Faculty: {faculty.code} - {faculty.name}")

    department = None
    # department needs faculty_id
    for d in department_service.list_departments():
        if d.code == 'SE' and d.faculty_id == faculty.id:
            department = d
            break
    if not department:
        department = department_service.create_department({'faculty_id': faculty.id, 'code': 'SE', 'name': 'Software Engineering'})
        print('  Created Department: SE')
    else:
        print('  Found Department: SE')

    # 4) Academic Year, Program, Subject
    academic_year = get_or_create(academic_year_service, 'list_academic_years', 'code', '2025-2026', 'create_academic_year', {'code': '2025-2026', 'start_date': date(2025,9,1), 'end_date': date(2026,6,30)})
    print(f"  AcademicYear: {academic_year.code}")

    program = get_or_create(program_service, 'list_programs', 'name', 'Software Engineering K18', 'create_program', {'department_id': department.id, 'name': 'Software Engineering K18', 'total_credits': 120})
    print(f"  Program: {program.name}")

    subject = None
    for s in subject_service.list_subjects():
        if s.code == 'SWT301' and s.department_id == department.id:
            subject = s
            break
    if not subject:
        subject = subject_service.create_subject({'department_id': department.id, 'code': 'SWT301', 'name_vi': 'Gii thiu K thut Phn mm', 'name_en': 'Introduction to Software Engineering', 'credits': 3})
        print('  Created Subject: SWT301')
    else:
        print('  Found Subject: SWT301')

    # 5) Syllabus
    syllabus = None
    for sy in syllabus_service.list_syllabuses():
        if sy.subject_id == subject.id and sy.program_id == program.id and sy.academic_year_id == academic_year.id:
            syllabus = sy
            break
    if not syllabus:
        syllabus = syllabus_service.create_syllabus({'subject_id': subject.id, 'program_id': program.id, 'academic_year_id': academic_year.id, 'lecturer_id': lecturer.id, 'version': '1.0'})
        print(f"  Created Syllabus ID: {syllabus.id}")
    else:
        print(f"  Found Syllabus ID: {syllabus.id}")

    # 6) Syllabus Details - CLOs
    existing_clos = {c.code for c in syllabus_clo_service.get_by_syllabus(syllabus.id)}
    clos_to_add = [
        {'code': 'CLO1', 'description': 'Explain software lifecycle.'},
        {'code': 'CLO2', 'description': 'Apply software requirements engineering.'},
        {'code': 'CLO3', 'description': 'Design basic software architecture.'},
    ]
    for clo in clos_to_add:
        if clo['code'] not in existing_clos:
            item = syllabus_clo_service.create_clo({'syllabus_id': syllabus.id, **clo})
            print(f"  Added CLO: {item.code}")
        else:
            print(f"  CLO exists: {clo['code']}")

    # Materials
    existing_mats = {m.title for m in syllabus_material_service.get_by_syllabus(syllabus.id)}
    mats_to_add = [
        {'type': 'MAIN', 'title': 'Software Engineering (Textbook)', 'author': 'Ian Sommerville', 'publisher': 'Pearson', 'isbn': '1234567890', 'syllabus_id': syllabus.id},
        {'type': 'REFERENCE', 'title': 'Design Patterns', 'author': 'Gamma et al.', 'publisher': 'Addison-Wesley', 'isbn': '0987654321', 'syllabus_id': syllabus.id},
    ]
    for mat in mats_to_add:
        if mat['title'] not in existing_mats:
            item = syllabus_material_service.create_material(mat)
            print(f"  Added Material: {item.title}")
        else:
            print(f"  Material exists: {mat['title']}")

    # Teaching Plans
    teaching_plan_service = container.teaching_plan_service()
    existing_weeks = {p.week for p in teaching_plan_service.list_plans_for_syllabus(syllabus.id)}
    plans_to_add = [
        {'week': 1, 'topic': 'Introduction to Software Engineering', 'activity': 'Lecture', 'assessment': 'Quiz', 'syllabus_id': syllabus.id},
        {'week': 2, 'topic': 'Software Process Models', 'activity': 'Lecture', 'assessment': 'Assignment 1', 'syllabus_id': syllabus.id},
        {'week': 3, 'topic': 'Requirements Engineering', 'activity': 'Lecture', 'assessment': 'Assignment 2', 'syllabus_id': syllabus.id},
    ]
    for plan in plans_to_add:
        if plan['week'] not in existing_weeks:
            item = teaching_plan_service.create_teaching_plan(plan)
            print(f"  Added Teaching Plan Week: {item.week}")
        else:
            print(f"  Teaching Plan exists for week: {plan['week']}")

    # Assessments: Schemes, Components, Rubrics, CLO mappings
    assessment_scheme_service = container.assessment_scheme_service()
    assessment_component_service = container.assessment_component_service()
    rubric_service = container.rubric_service()
    assessment_clo_service = container.assessment_clo_service()

    existing_schemes = {s.name for s in assessment_scheme_service.list_schemes_for_syllabus(syllabus.id)}

    # Example scheme: Midterm
    if 'Midterm' not in existing_schemes:
        scheme = assessment_scheme_service.create_scheme({'syllabus_id': syllabus.id, 'name': 'Midterm', 'weight': 30.0})
        print(f"  Created Assessment Scheme: {scheme.name}")
        comp = assessment_component_service.create_component({'scheme_id': scheme.id, 'name': 'Midterm Exam', 'weight': 30.0})
        print(f"  Created Assessment Component: {comp.name}")
        rubric = rubric_service.create_rubric({'component_id': comp.id, 'criteria': 'Comprehensive exam', 'max_score': 100})
        print(f"  Created Rubric for component: {rubric.criteria}")
        # Map to CLO1 if exists
        clo1 = None
        for c in syllabus_clo_service.get_by_syllabus(syllabus.id):
            if c.code == 'CLO1':
                clo1 = c
                break
        if clo1:
            assessment_clo_service.add_mapping(comp.id, clo1.id)
            print(f"  Mapped component {comp.name} to CLO {clo1.code}")
    else:
        print('  Midterm scheme exists')

    print('\n  Seeding complete!')


if __name__ == '__main__':
    seed()
</file>

<file path="src/app.py">
from flask import Flask, jsonify
from api.swagger import spec
from api.middleware import middleware
from infrastructure.databases import init_db
from flasgger import Swagger
from flask_swagger_ui import get_swaggerui_blueprint
from cors import init_cors

# Dependency injection
from dependency_container import Container
from api.controllers.subject_controller import subject_bp
from api.controllers.faculty_controller import faculty_bp
from api.controllers.department_controller import department_bp
from api.controllers.role_controller import role_bp
from api.controllers.user_controller import user_bp
from api.controllers.academic_year_controller import academic_year_bp
from api.controllers.program_controller import program_bp
from api.controllers.syllabus_controller import syllabus_bp
from api.controllers.syllabus_clo_controller import syllabus_clo_bp
from api.controllers.syllabus_material_controller import syllabus_material_bp
from api.controllers.teaching_plan_controller import teaching_plan_bp
from api.controllers.assessment_scheme_controller import assessment_scheme_bp
from api.controllers.assessment_component_controller import assessment_component_bp
from api.controllers.rubric_controller import rubric_bp
from api.controllers.assessment_clo_controller import assessment_clo_bp
from api.controllers.auth_controller import auth_bp
from api.controllers.ai_controller import ai_bp
from api.controllers.dashboard_controller import dashboard_bp
from api.controllers.program_outcome_controller import program_outcome_bp
from api.controllers.file_controller import file_bp
from api.controllers.clo_plo_mapping_controller import clo_plo_mapping_bp
from api.controllers.subject_relationship_controller import subject_rel_bp
from api.controllers.syllabus_comment_controller import syllabus_comment_bp
from api.controllers.notification_controller import notification_bp
from api.controllers.system_setting_controller import system_setting_bp
from api.controllers.student_controller import student_bp


def create_app():
    app = Flask(__name__)

    # Initialize CORS early so Swagger and other blueprints respect it
    try:
        init_cors(app)
    except Exception:
        pass

    Swagger(app)

    # Initialize DI container and wire controllers
    container = Container()
    # Wire the container explicitly for controllers
    try:
        container.wire(modules=[
            "api.controllers.subject_controller",
            "api.controllers.faculty_controller",
            "api.controllers.department_controller",
            "api.controllers.role_controller",
            "api.controllers.user_controller",
            "api.controllers.academic_year_controller",
            "api.controllers.program_controller",
            "api.controllers.syllabus_controller",
            "api.controllers.syllabus_clo_controller",
            "api.controllers.syllabus_material_controller",
            "api.controllers.teaching_plan_controller",
            "api.controllers.assessment_scheme_controller",
            "api.controllers.assessment_component_controller",
            "api.controllers.rubric_controller",
            "api.controllers.assessment_clo_controller",
            "api.controllers.auth_controller",
            "api.controllers.ai_controller",
            "api.controllers.dashboard_controller",
            "api.controllers.program_outcome_controller",
            "api.controllers.file_controller",
            "api.controllers.clo_plo_mapping_controller",
            "api.controllers.subject_relationship_controller",
            "api.controllers.syllabus_comment_controller",
            "api.controllers.notification_controller",
            "api.controllers.system_setting_controller",
            "api.controllers.student_controller",
        ])
    except Exception:
        # best-effort wiring; if it fails here the app can still start
        pass

    # Register blueprints
    app.register_blueprint(subject_bp)
    app.register_blueprint(faculty_bp)
    app.register_blueprint(department_bp)
    app.register_blueprint(role_bp)
    app.register_blueprint(user_bp)
    app.register_blueprint(academic_year_bp)
    app.register_blueprint(program_bp)
    app.register_blueprint(syllabus_bp)
    app.register_blueprint(syllabus_clo_bp)
    app.register_blueprint(syllabus_material_bp)
    app.register_blueprint(teaching_plan_bp)
    app.register_blueprint(assessment_scheme_bp)
    app.register_blueprint(assessment_component_bp)
    app.register_blueprint(rubric_bp)
    app.register_blueprint(assessment_clo_bp)
    app.register_blueprint(auth_bp)
    app.register_blueprint(ai_bp)
    app.register_blueprint(dashboard_bp)
    app.register_blueprint(program_outcome_bp)
    app.register_blueprint(file_bp)
    app.register_blueprint(clo_plo_mapping_bp)
    app.register_blueprint(subject_rel_bp)
    app.register_blueprint(syllabus_comment_bp)
    app.register_blueprint(notification_bp)
    app.register_blueprint(system_setting_bp)
    app.register_blueprint(student_bp)

     # Thm Swagger UI blueprint
    SWAGGER_URL = '/docs'
    API_URL = '/swagger.json'
    swaggerui_blueprint = get_swaggerui_blueprint(
        SWAGGER_URL,
        API_URL,
        config={'app_name': "Syllabus Management API"}
    )
    app.register_blueprint(swaggerui_blueprint, url_prefix=SWAGGER_URL)

    try:
        init_db(app)
    except Exception as e:
        print(f"Error initializing database: {e}")

    # Register middleware
    middleware(app)

    # Initialize CORS
    try:
        init_cors(app)
    except Exception:
        pass

    # Register routes (add all non-static endpoints to Swagger where possible)
    with app.test_request_context():
        for rule in app.url_map.iter_rules():
            if rule.endpoint == 'static':
                continue
            view_func = app.view_functions.get(rule.endpoint)
            if not view_func:
                continue
            try:
                spec.path(view=view_func)
                print(f"Adding path: {rule.rule} -> {view_func}")
            except Exception:
                # some endpoints may not be compatible with flasgger, skip them
                pass

    @app.route("/swagger.json")
    def swagger_json():
        return jsonify(spec.to_dict())

    return app
# Run the application

if __name__ == '__main__':
    app = create_app()
    app.run(host='0.0.0.0', port=9999, debug=True)
</file>

<file path="src/dependency_container.py">
# Dependency Injection Container

from dependency_injector import containers, providers
from infrastructure.databases.mssql import session

from infrastructure.repositories.subject_repository import SubjectRepository
from services.subject_service import SubjectService
from infrastructure.repositories.faculty_repository import FacultyRepository
from services.faculty_service import FacultyService
from infrastructure.repositories.department_repository import DepartmentRepository
from services.department_service import DepartmentService
from infrastructure.repositories.role_repository import RoleRepository
from services.role_service import RoleService
from infrastructure.repositories.user_repository import UserRepository
from services.user_service import UserService
from infrastructure.repositories.academic_year_repository import AcademicYearRepository
from services.academic_year_service import AcademicYearService
from infrastructure.repositories.program_repository import ProgramRepository
from services.program_service import ProgramService
from infrastructure.repositories.syllabus_repository import SyllabusRepository
from services.syllabus_service import SyllabusService
from infrastructure.repositories.syllabus_clo_repository import SyllabusCloRepository
from services.syllabus_clo_service import SyllabusCloService
from infrastructure.repositories.syllabus_material_repository import SyllabusMaterialRepository
from services.syllabus_material_service import SyllabusMaterialService
from infrastructure.repositories.teaching_plan_repository import TeachingPlanRepository
from services.teaching_plan_service import TeachingPlanService
from infrastructure.repositories.assessment_scheme_repository import AssessmentSchemeRepository
from services.assessment_scheme_service import AssessmentSchemeService
from infrastructure.repositories.assessment_component_repository import AssessmentComponentRepository
from services.assessment_component_service import AssessmentComponentService
from infrastructure.repositories.rubric_repository import RubricRepository
from services.rubric_service import RubricService
from infrastructure.repositories.assessment_clo_repository import AssessmentCloRepository
from services.assessment_clo_service import AssessmentCloService
from infrastructure.repositories.workflow_log_repository import WorkflowLogRepository

# NEW: Program Outcome, File Management, Mappings, Relationships, Comments, Notifications, System Settings, AI Audit
from infrastructure.repositories.program_outcome_repository import ProgramOutcomeRepository
from services.program_outcome_service import ProgramOutcomeService
from infrastructure.repositories.file_repository import FileRepository
from services.file_service import FileService
from infrastructure.repositories.clo_plo_mapping_repository import CloPloMappingRepository
from services.clo_plo_mapping_service import CloPloMappingService
from infrastructure.repositories.subject_relationship_repository import SubjectRelationshipRepository
from services.subject_relationship_service import SubjectRelationshipService
from infrastructure.repositories.syllabus_comment_repository import SyllabusCommentRepository
from services.syllabus_comment_service import SyllabusCommentService
from infrastructure.repositories.notification_repository import NotificationRepository
from services.notification_service import NotificationService
from infrastructure.repositories.system_setting_repository import SystemSettingRepository
from infrastructure.repositories.ai_auditlog_repository import AiAuditLogRepository
from infrastructure.repositories.notification_repository import NotificationRepository
from infrastructure.repositories.student_subscription_repository import StudentSubscriptionRepository
from infrastructure.repositories.student_report_repository import StudentReportRepository
from services.system_setting_service import SystemSettingService
from services.student_service import StudentService

class Container(containers.DeclarativeContainer):
    """Dependency Injection Container for SMD services."""

    wiring_config = containers.WiringConfiguration(modules=[
        "api.controllers.subject_controller",
        "api.controllers.faculty_controller",
        "api.controllers.department_controller",
        "api.controllers.role_controller",
        "api.controllers.user_controller",
        "api.controllers.academic_year_controller",
        "api.controllers.program_controller",
        "api.controllers.syllabus_controller",
        "api.controllers.syllabus_clo_controller",
        "api.controllers.syllabus_material_controller",
        "api.controllers.teaching_plan_controller",
        "api.controllers.assessment_scheme_controller",
        "api.controllers.assessment_component_controller",
        "api.controllers.rubric_controller",
        "api.controllers.assessment_clo_controller",
        "api.controllers.auth_controller",
        "api.controllers.ai_controller",
        "api.controllers.dashboard_controller",
        "api.controllers.program_outcome_controller",
        "api.controllers.file_controller",
        "api.controllers.clo_plo_mapping_controller",
        "api.controllers.subject_relationship_controller",
        "api.controllers.syllabus_comment_controller",
        "api.controllers.notification_controller",
        "api.controllers.system_setting_controller",
        "api.controllers.student_controller",
    ])

    # Provide a session object (singleton)
    db_session = providers.Object(session)

    # Repositories
    subject_repository = providers.Factory(
        SubjectRepository,
        session=db_session
    )

    faculty_repository = providers.Factory(
        FacultyRepository,
        session=db_session
    )

    department_repository = providers.Factory(
        DepartmentRepository,
        session=db_session
    )

    academic_year_repository = providers.Factory(
        AcademicYearRepository,
        session=db_session
    )

    program_repository = providers.Factory(
        ProgramRepository,
        session=db_session
    )

    role_repository = providers.Factory(
        RoleRepository,
        session=db_session
    )

    user_repository = providers.Factory(
        UserRepository,
        session=db_session
    )
    # Services
    subject_service = providers.Factory(
        SubjectService,
        repository=subject_repository
    )

    faculty_service = providers.Factory(
        FacultyService,
        repository=faculty_repository
    )

    department_service = providers.Factory(
        DepartmentService,
        repository=department_repository
    )

    syllabus_repository = providers.Factory(
        SyllabusRepository,
        session=db_session
    )

    syllabus_clo_repository = providers.Factory(
        SyllabusCloRepository,
        session=db_session
    )

    syllabus_material_repository = providers.Factory(
        SyllabusMaterialRepository,
        session=db_session
    )

    teaching_plan_repository = providers.Factory(
        TeachingPlanRepository,
        session=db_session
    )

    assessment_scheme_repository = providers.Factory(
        AssessmentSchemeRepository,
        session=db_session
    )

    assessment_component_repository = providers.Factory(
        AssessmentComponentRepository,
        session=db_session
    )

    rubric_repository = providers.Factory(
        RubricRepository,
        session=db_session
    )

    assessment_clo_repository = providers.Factory(
        AssessmentCloRepository,
        session=db_session
    )

    workflow_log_repository = providers.Factory(
        WorkflowLogRepository,
        session=db_session
    )

    # NEW REPOSITORIES
    program_outcome_repository = providers.Factory(
        ProgramOutcomeRepository,
        session=db_session
    )
    
    file_repository = providers.Factory(
        FileRepository,
        session=db_session
    )

    clo_plo_mapping_repository = providers.Factory(
        CloPloMappingRepository,
        session=db_session
    )

    subject_relationship_repository = providers.Factory(
        SubjectRelationshipRepository,
        session=db_session
    )

    syllabus_comment_repository = providers.Factory(
        SyllabusCommentRepository,
        session=db_session
    )

    notification_repository = providers.Factory(
        NotificationRepository,
        session=db_session
    )

    system_setting_repository = providers.Factory(
        SystemSettingRepository,
        session=db_session
    )

    student_subscription_repository = providers.Factory(
        StudentSubscriptionRepository,
        session=db_session
    )

    student_report_repository = providers.Factory(
        StudentReportRepository,
        session=db_session
    )

    ai_auditlog_repository = providers.Factory(
        AiAuditLogRepository,
        session=db_session
    )

    academic_year_service = providers.Factory(
        AcademicYearService,
        repository=academic_year_repository
    )

    program_service = providers.Factory(
        ProgramService,
        repository=program_repository
    )

    syllabus_service = providers.Factory(
        SyllabusService,
        repository=syllabus_repository,
        subject_repository=subject_repository,
        program_repository=program_repository,
        academic_year_repository=academic_year_repository,
        user_repository=user_repository,
        workflow_log_repository=workflow_log_repository,
        # NEW INJECTIONS:
        syllabus_clo_repository=syllabus_clo_repository,
        syllabus_material_repository=syllabus_material_repository,
        teaching_plan_repository=teaching_plan_repository,
        assessment_scheme_repository=assessment_scheme_repository,
        assessment_component_repository=assessment_component_repository,
        rubric_repository=rubric_repository,
        assessment_clo_repository=assessment_clo_repository
    )

    syllabus_clo_service = providers.Factory(
        SyllabusCloService,
        repository=syllabus_clo_repository,
        syllabus_repository=syllabus_repository
    )

    syllabus_material_service = providers.Factory(
        SyllabusMaterialService,
        repository=syllabus_material_repository,
        syllabus_repository=syllabus_repository
    )

    teaching_plan_service = providers.Factory(
        TeachingPlanService,
        repository=teaching_plan_repository,
        syllabus_repository=syllabus_repository
    )

    assessment_scheme_service = providers.Factory(
        AssessmentSchemeService,
        repository=assessment_scheme_repository,
        syllabus_repository=syllabus_repository
    )

    assessment_component_service = providers.Factory(
        AssessmentComponentService,
        repository=assessment_component_repository,
        scheme_repository=assessment_scheme_repository
    )

    rubric_service = providers.Factory(
        RubricService,
        repository=rubric_repository,
        component_repository=assessment_component_repository
    )

    assessment_clo_service = providers.Factory(
        AssessmentCloService,
        repository=assessment_clo_repository,
        component_repository=assessment_component_repository,
        syllabus_clo_repository=syllabus_clo_repository,
        assessment_scheme_repository=assessment_scheme_repository
    )
  

    # NEW SERVICES
    program_outcome_service = providers.Factory(
        ProgramOutcomeService,
        repository=program_outcome_repository,
        program_repository=program_repository
    )

    file_service = providers.Factory(
        FileService,
        repository=file_repository
    )

    clo_plo_mapping_service = providers.Factory(
        CloPloMappingService,
        repository=clo_plo_mapping_repository,
        syllabus_clo_repository=syllabus_clo_repository,
        program_outcome_repository=program_outcome_repository
    )

    subject_relationship_service = providers.Factory(
        SubjectRelationshipService,
        repository=subject_relationship_repository,
        subject_repository=subject_repository
    )

    syllabus_comment_service = providers.Factory(
        SyllabusCommentService,
        repository=syllabus_comment_repository,
        syllabus_repository=syllabus_repository,
        user_repository=user_repository
    )

    notification_service = providers.Factory(
        NotificationService,
        repository=notification_repository,
        user_repository=user_repository
    )

    system_setting_service = providers.Factory(
        SystemSettingService,
        repository=system_setting_repository
    )

    student_service = providers.Factory(
        StudentService, 
        sub_repo=student_subscription_repository,
        report_repo=student_report_repository
    )

    # AI Service (inject audit repository)
    from services.ai_service import AiService
    ai_service = providers.Factory(
        AiService,
        audit_repository=ai_auditlog_repository
    )

    role_service = providers.Factory(
        RoleService,
        repository=role_repository
    )

    user_service = providers.Factory(
        UserService,
        repository=user_repository
    )

    # AI Service
    from services.ai_service import AiService
    ai_service = providers.Factory(
        AiService
    )
</file>

</files>
</file>

<file path="apps/api/scripts/check_imports.py">
import importlib
modules = [
    'src.infrastructure.databases',
    'src.api.routes',
    'src.create_app'
]

for m in modules:
    try:
        importlib.import_module(m)
        print(f'{m}: OK')
    except Exception as e:
        print(f'{m}: {type(e).__name__}: {e}')
</file>

<file path="apps/api/scripts/run_postgres.sh">
#!/bin/bash

# Function to check if PostgreSQL is running
is_postgres_running() {
    pg_isready -q
    return $?
}

# Start PostgreSQL if it's not already running
if ! is_postgres_running; then
    echo "PostgreSQL is not running. Starting it now..."
    pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start
else
    echo "PostgreSQL is already running."
fi

# Create the database if it doesn't exist
if ! psql -lqt | cut -d \| -f 1 | grep -qw dbname; then
    createdb dbname
fi
</file>

<file path="apps/api/scripts/seed_users.py">
from dependency_container import Container
from datetime import date


def get_or_create(service, list_method_name, check_attr, check_value, create_method_name, create_data):
    list_method = getattr(service, list_method_name)
    for item in list_method():
        if getattr(item, check_attr) == check_value:
            return item
    create_method = getattr(service, create_method_name)
    return create_method(create_data)


def seed():
    container = Container()

    # Services
    role_service = container.role_service()
    user_service = container.user_service()
    faculty_service = container.faculty_service()
    department_service = container.department_service()
    academic_year_service = container.academic_year_service()
    program_service = container.program_service()
    subject_service = container.subject_service()
    syllabus_service = container.syllabus_service()
    syllabus_clo_service = container.syllabus_clo_service()
    syllabus_material_service = container.syllabus_material_service()

    # 1) Roles
    admin_role = role_service.get_by_name('ADMIN') or role_service.create_role({'name': 'ADMIN', 'description': 'ADMIN role'})
    print('  Role:', admin_role.name)
    lecturer_role = role_service.get_by_name('LECTURER') or role_service.create_role({'name': 'LECTURER', 'description': 'LECTURER role'})
    print('  Role:', lecturer_role.name)

    # 2) Users
    admin = user_service.get_by_username('admin')
    if not admin:
        admin = user_service.create_user({'username': 'admin', 'email': 'admin@example.com', 'full_name': 'Admin User', 'password': 'password123', 'is_active': True})
        print('  Created User: admin')
    else:
        print('  Found User: admin')

    lecturer = user_service.get_by_username('lecturer')
    if not lecturer:
        lecturer = user_service.create_user({'username': 'lecturer', 'email': 'lecturer@example.com', 'full_name': 'Lecturer User', 'password': 'password123', 'is_active': True})
        print('  Created User: lecturer')
    else:
        print('  Found User: lecturer')

    # Assign roles idempotently
    session = container.db_session()
    from infrastructure.models.user_role_model import UserRole

    def ensure_role(user, role):
        if not session.query(UserRole).filter_by(user_id=user.id, role_id=role.id).first():
            try:
                session.add(UserRole(user_id=user.id, role_id=role.id))
                session.commit()
                print(f"  Assigned role {role.name} to user {user.username}")
            except Exception:
                session.rollback()

    ensure_role(admin, admin_role)
    ensure_role(lecturer, lecturer_role)

    # 3) Faculty & Department
    faculty = get_or_create(faculty_service, 'list_faculties', 'code', 'FIT', 'create_faculty', {'code': 'FIT', 'name': 'Faculty of Information Technology'})
    print(f"  Faculty: {faculty.code} - {faculty.name}")

    department = None
    # department needs faculty_id
    for d in department_service.list_departments():
        if d.code == 'SE' and d.faculty_id == faculty.id:
            department = d
            break
    if not department:
        department = department_service.create_department({'faculty_id': faculty.id, 'code': 'SE', 'name': 'Software Engineering'})
        print('  Created Department: SE')
    else:
        print('  Found Department: SE')

    # 4) Academic Year, Program, Subject
    academic_year = get_or_create(academic_year_service, 'list_academic_years', 'code', '2025-2026', 'create_academic_year', {'code': '2025-2026', 'start_date': date(2025,9,1), 'end_date': date(2026,6,30)})
    print(f"  AcademicYear: {academic_year.code}")

    program = get_or_create(program_service, 'list_programs', 'name', 'Software Engineering K18', 'create_program', {'department_id': department.id, 'name': 'Software Engineering K18', 'total_credits': 120})
    print(f"  Program: {program.name}")

    subject = None
    for s in subject_service.list_subjects():
        if s.code == 'SWT301' and s.department_id == department.id:
            subject = s
            break
    if not subject:
        subject = subject_service.create_subject({'department_id': department.id, 'code': 'SWT301', 'name_vi': 'Gii thiu K thut Phn mm', 'name_en': 'Introduction to Software Engineering', 'credits': 3})
        print('  Created Subject: SWT301')
    else:
        print('  Found Subject: SWT301')

    # 5) Syllabus
    syllabus = None
    for sy in syllabus_service.list_syllabuses():
        if sy.subject_id == subject.id and sy.program_id == program.id and sy.academic_year_id == academic_year.id:
            syllabus = sy
            break
    if not syllabus:
        syllabus = syllabus_service.create_syllabus({'subject_id': subject.id, 'program_id': program.id, 'academic_year_id': academic_year.id, 'lecturer_id': lecturer.id, 'version': '1.0'})
        print(f"  Created Syllabus ID: {syllabus.id}")
    else:
        print(f"  Found Syllabus ID: {syllabus.id}")

    # 6) Syllabus Details - CLOs
    existing_clos = {c.code for c in syllabus_clo_service.get_by_syllabus(syllabus.id)}
    clos_to_add = [
        {'code': 'CLO1', 'description': 'Explain software lifecycle.'},
        {'code': 'CLO2', 'description': 'Apply software requirements engineering.'},
        {'code': 'CLO3', 'description': 'Design basic software architecture.'},
    ]
    for clo in clos_to_add:
        if clo['code'] not in existing_clos:
            item = syllabus_clo_service.create_clo({'syllabus_id': syllabus.id, **clo})
            print(f"  Added CLO: {item.code}")
        else:
            print(f"  CLO exists: {clo['code']}")

    # Materials
    existing_mats = {m.title for m in syllabus_material_service.get_by_syllabus(syllabus.id)}
    mats_to_add = [
        {'type': 'MAIN', 'title': 'Software Engineering (Textbook)', 'author': 'Ian Sommerville', 'publisher': 'Pearson', 'isbn': '1234567890', 'syllabus_id': syllabus.id},
        {'type': 'REFERENCE', 'title': 'Design Patterns', 'author': 'Gamma et al.', 'publisher': 'Addison-Wesley', 'isbn': '0987654321', 'syllabus_id': syllabus.id},
    ]
    for mat in mats_to_add:
        if mat['title'] not in existing_mats:
            item = syllabus_material_service.create_material(mat)
            print(f"  Added Material: {item.title}")
        else:
            print(f"  Material exists: {mat['title']}")

    # Teaching Plans
    teaching_plan_service = container.teaching_plan_service()
    existing_weeks = {p.week for p in teaching_plan_service.list_plans_for_syllabus(syllabus.id)}
    plans_to_add = [
        {'week': 1, 'topic': 'Introduction to Software Engineering', 'activity': 'Lecture', 'assessment': 'Quiz', 'syllabus_id': syllabus.id},
        {'week': 2, 'topic': 'Software Process Models', 'activity': 'Lecture', 'assessment': 'Assignment 1', 'syllabus_id': syllabus.id},
        {'week': 3, 'topic': 'Requirements Engineering', 'activity': 'Lecture', 'assessment': 'Assignment 2', 'syllabus_id': syllabus.id},
    ]
    for plan in plans_to_add:
        if plan['week'] not in existing_weeks:
            item = teaching_plan_service.create_teaching_plan(plan)
            print(f"  Added Teaching Plan Week: {item.week}")
        else:
            print(f"  Teaching Plan exists for week: {plan['week']}")

    # Assessments: Schemes, Components, Rubrics, CLO mappings
    assessment_scheme_service = container.assessment_scheme_service()
    assessment_component_service = container.assessment_component_service()
    rubric_service = container.rubric_service()
    assessment_clo_service = container.assessment_clo_service()

    existing_schemes = {s.name for s in assessment_scheme_service.list_schemes_for_syllabus(syllabus.id)}

    # Example scheme: Midterm
    if 'Midterm' not in existing_schemes:
        scheme = assessment_scheme_service.create_scheme({'syllabus_id': syllabus.id, 'name': 'Midterm', 'weight': 30.0})
        print(f"  Created Assessment Scheme: {scheme.name}")
        comp = assessment_component_service.create_component({'scheme_id': scheme.id, 'name': 'Midterm Exam', 'weight': 30.0})
        print(f"  Created Assessment Component: {comp.name}")
        rubric = rubric_service.create_rubric({'component_id': comp.id, 'criteria': 'Comprehensive exam', 'max_score': 100})
        print(f"  Created Rubric for component: {rubric.criteria}")
        # Map to CLO1 if exists
        clo1 = None
        for c in syllabus_clo_service.get_by_syllabus(syllabus.id):
            if c.code == 'CLO1':
                clo1 = c
                break
        if clo1:
            assessment_clo_service.add_mapping(comp.id, clo1.id)
            print(f"  Mapped component {comp.name} to CLO {clo1.code}")
    else:
        print('  Midterm scheme exists')

    print('\n  Seeding complete!')


if __name__ == '__main__':
    seed()
</file>

<file path="apps/api/scripts/test_login.js">
const axios = require('axios');

axios.post('http://localhost:9999/auth/login', { username: 'gv1', password: '123456' })
  .then(res => {
    console.log('status', res.status);
    console.log('data', res.data);
  })
  .catch(err => {
    if (err.response) {
      console.error('status', err.response.status);
      console.error(err.response.data);
    } else {
      console.error('error', err.message);
    }
    process.exit(1);
  });
</file>

<file path="apps/api/scripts/test_login.py">
import requests

r = requests.post('http://localhost:9999/auth/login', json={'username':'gv1','password':'123456'})
print('status:', r.status_code)
print('headers:', r.headers)
print('body:', r.text)
</file>

<file path="apps/api/seed_all_data.py">
import sys
import os
import json
from datetime import datetime, date
from werkzeug.security import generate_password_hash

# --- CU HNH NG DN IMPORT ---
current_dir = os.path.dirname(os.path.abspath(__file__))
src_path = os.path.join(current_dir, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

# --- IMPORT MODULES ---
try:
    from infrastructure.databases.mssql import session, engine, Base
    from infrastructure.models import (
        User, Role, UserRole, Faculty, Department, Program, ProgramOutcome,
        Subject, AcademicYear, Syllabus, SyllabusClo, SyllabusMaterial,
        TeachingPlan, AssessmentScheme, AssessmentComponent, Rubric,
        CloPloMapping, AssessmentClo, SubjectRelationship,
        SystemSetting, StudentSubscription, StudentReport, Notification
    )
except ImportError as e:
    print(f" Li Import: {e}")
    sys.exit(1)

# ----------------------------------------

def hash_password(password: str) -> str:
    return generate_password_hash(password)

def seed_all():
    print(" Bt u np d liu mu (Full Enterprise Version)...")
    
    # 1. Reset Database (Optional - cn thn khi dng trn Prod)
    # Base.metadata.drop_all(bind=engine)
    try:
        Base.metadata.create_all(bind=engine)
        print("  kim tra/to bng Database.")
    except Exception as e:
        print(f" Cnh bo to bng: {e}")

    try:
        # ==========================================
        # PHN 1: H THNG & CU HNH
        # ==========================================
        print(" 1. Seeding System Settings...")
        settings = [
            ("PASSING_GRADE", "4.0", "FLOAT", "im sn qua mn"),
            ("MAX_FILE_SIZE", "10", "INT", "Kch thc file ti a (MB)"),
            ("CURRENT_TERM", "HK1_2025", "STRING", "Hc k hin ti"),
            ("ALLOW_STUDENT_COMMENT", "True", "BOOLEAN", "Cho php sinh vin bnh lun"),
            ("AI_MODEL_VERSION", "gemini-2.5-flash", "STRING", "Model AI mc nh")
        ]
        for key, val, type_, desc in settings:
            if not session.query(SystemSetting).filter_by(key=key).first():
                session.add(SystemSetting(key=key, value=val, type=type_, description=desc))
        session.flush()

        # ==========================================
        # PHN 2: T CHC & NGI DNG
        # ==========================================
        print(" 2. Seeding Roles, Faculties, Departments, Users...")
        
        # Roles
        roles_data = ["Admin", "Lecturer", "Head of Dept", "Academic Affairs", "Student", "Dean"]
        role_objs = {}
        for r_name in roles_data:
            role = session.query(Role).filter_by(name=r_name).first()
            if not role:
                role = Role(name=r_name, description=f"Vai tr {r_name}")
                session.add(role)
            role_objs[r_name] = role
        session.flush()

        # Faculty
        fit = session.query(Faculty).filter_by(code="FIT").first()
        if not fit:
            fit = Faculty(code="FIT", name="Cng ngh Thng tin")
            session.add(fit)
            session.flush()

        # Departments
        depts = [
            ("SE", "K thut Phn mm"),
            ("CS", "Khoa hc My tnh"),
            ("IS", "H thng Thng tin")
        ]
        dept_objs = {}
        for code, name in depts:
            d = session.query(Department).filter_by(code=code).first()
            if not d:
                d = Department(code=code, name=name, faculty_id=fit.id)
                session.add(d)
            dept_objs[code] = d
        session.flush()

        # Users
        users_config = [
            # Username, Name, Role, Dept Code
            ("admin", "Super Admin", "Admin", None),
            ("gv_se", "Nguyn Vn A (GV)", "Lecturer", "SE"),
            ("gv_cs", "Trn Th B (GV)", "Lecturer", "CS"),
            ("hod_se", "TS. L Vn C (Trng BM)", "Head of Dept", "SE"),
            ("aa_user", "Phng o To", "Academic Affairs", None),
            ("sv_hcmut", "Nguyn Sinh Vin", "Student", "SE"),
        ]
        
        user_map = {}
        default_pass = hash_password("123456")

        for uname, fullname, rname, dcode in users_config:
            u = session.query(User).filter_by(username=uname).first()
            dept_id = dept_objs[dcode].id if dcode else None
            
            if not u:
                u = User(
                    username=uname, email=f"{uname}@hcmut.edu.vn",
                    full_name=fullname, password_hash=default_pass,
                    department_id=dept_id, is_active=True
                )
                session.add(u)
                session.flush()
                # Assign Role
                session.add(UserRole(user_id=u.id, role_id=role_objs[rname].id))
            user_map[uname] = u
        session.flush()

        # ==========================================
        # PHN 3: CU TRC O TO (MASTER DATA)
        # ==========================================
        print(" 3. Seeding Academic Master Data...")

        # Academic Year
        ay = session.query(AcademicYear).filter_by(code="2025-2026").first()
        if not ay:
            ay = AcademicYear(code="2025-2026", start_date=date(2025,9,1), end_date=date(2026,6,30))
            session.add(ay)
            session.flush()

        # Program (CTT)
        prog = session.query(Program).filter_by(name="K s PM K2025").first()
        if not prog:
            prog = Program(department_id=dept_objs["SE"].id, name="K s PM K2025", total_credits=150)
            session.add(prog)
            session.flush()

        # Program Outcomes (PLOs)
        plo_objs = []
        existing_plos = session.query(ProgramOutcome).filter_by(program_id=prog.id).count()
        if existing_plos == 0:
            plos_data = [
                ("PLO1", "p dng kin thc ton hc, khoa hc v k thut"),
                ("PLO2", "Thit k v hin thc ha gii php phn mm"),
                ("PLO3", "K nng giao tip v lm vic nhm"),
                ("PLO4", "Nhn thc v o c ngh nghip"),
                ("PLO5", "Kh nng hc tp sut i")
            ]
            for c, d in plos_data:
                p = ProgramOutcome(program_id=prog.id, code=c, description=d)
                session.add(p)
                plo_objs.append(p)
            session.flush()
        else:
            plo_objs = session.query(ProgramOutcome).filter_by(program_id=prog.id).all()

        # Subjects
        subjects_data = [
            ("IT001", "Nhp mn Lp trnh", 3),
            ("SE104", "Nhp mn CNPM", 3),
            ("SE301", "Kim th phn mm", 3),
            ("SE401", " n chuyn ngnh", 2)
        ]
        subj_map = {}
        for code, name, cr in subjects_data:
            s = session.query(Subject).filter_by(code=code).first()
            if not s:
                s = Subject(
                    department_id=dept_objs["SE"].id,
                    code=code, name_vi=name, name_en=name + " (En)",
                    credits=cr, credit_theory=cr, credit_practice=0, credit_self_study=cr*2
                )
                session.add(s)
            subj_map[code] = s
        session.flush()

        # Subject Relationships (Mn tin quyt)
        # IT001 -> SE104
        rel = session.query(SubjectRelationship).filter_by(subject_id=subj_map["SE104"].id, related_subject_id=subj_map["IT001"].id).first()
        if not rel:
            session.add(SubjectRelationship(
                subject_id=subj_map["SE104"].id, 
                related_subject_id=subj_map["IT001"].id, 
                type="PREREQUISITE"
            ))

        # ==========================================
        # PHN 4:  CNG CHI TIT (SYLLABUS FULL)
        # ==========================================
        print(" 4. Seeding Full Syllabus (Header + Children)...")
        
        # To Syllabus cho mn SE104
        target_sub = subj_map["SE104"]
        lecturer = user_map["gv_se"]
        
        syl = session.query(Syllabus).filter_by(subject_id=target_sub.id, version="2.0").first()
        if not syl:
            syl = Syllabus(
                subject_id=target_sub.id,
                program_id=prog.id,
                academic_year_id=ay.id,
                lecturer_id=lecturer.id,
                status="APPROVED", #  duyt  SV thy
                version="2.0",
                time_allocation=json.dumps({"theory": 30, "practice": 15, "self_study": 90}),
                prerequisites="IT001 - Nhp mn lp trnh",
                publish_date=datetime.now(),
                is_active=True
            )
            session.add(syl)
            session.flush()

            # 4.1 Syllabus CLOs
            clo1 = SyllabusClo(syllabus_id=syl.id, code="CLO1", description="Hiu cc quy trnh pht trin phn mm (Waterfall, Agile)")
            clo2 = SyllabusClo(syllabus_id=syl.id, code="CLO2", description="Vn dng k thut ly yu cu v phn tch")
            clo3 = SyllabusClo(syllabus_id=syl.id, code="CLO3", description="Thit k kin trc h thng c bn")
            session.add_all([clo1, clo2, clo3])
            session.flush()

            # 4.2 CLO-PLO Mapping
            # Map CLO1 -> PLO1 (I), CLO2 -> PLO2 (R), CLO3 -> PLO2 (M)
            if len(plo_objs) >= 2:
                session.add(CloPloMapping(syllabus_clo_id=clo1.id, program_plo_id=plo_objs[0].id, level="I"))
                session.add(CloPloMapping(syllabus_clo_id=clo2.id, program_plo_id=plo_objs[1].id, level="R"))
                session.add(CloPloMapping(syllabus_clo_id=clo3.id, program_plo_id=plo_objs[1].id, level="M"))

            # 4.3 Materials
            mat1 = SyllabusMaterial(syllabus_id=syl.id, type="MAIN", title="Software Engineering (10th Edition)", author="Ian Sommerville")
            mat2 = SyllabusMaterial(syllabus_id=syl.id, type="REFERENCE", title="Clean Code", author="Robert C. Martin")
            session.add_all([mat1, mat2])

            # 4.4 Teaching Plan
            plans = [
                TeachingPlan(syllabus_id=syl.id, week=1, topic="Tng quan CNPM", activity="Ging l thuyt", assessment="im danh"),
                TeachingPlan(syllabus_id=syl.id, week=2, topic="Quy trnh phn mm", activity="Tho lun nhm", assessment="Quiz 1"),
                TeachingPlan(syllabus_id=syl.id, week=3, topic="Thu thp yu cu", activity="Thc hnh Lab", assessment="Bi tp 1"),
            ]
            session.add_all(plans)

            # 4.5 Assessment Scheme -> Component -> Rubric
            # Scheme: Qu trnh (50%)
            scheme1 = AssessmentScheme(syllabus_id=syl.id, name="nh gi qu trnh", weight=50)
            session.add(scheme1)
            session.flush()

            comp1 = AssessmentComponent(scheme_id=scheme1.id, name=" n nhm", weight=30)
            comp2 = AssessmentComponent(scheme_id=scheme1.id, name="Kim tra trc nghim", weight=20)
            session.add_all([comp1, comp2])
            session.flush()

            # Mapping Assessment -> CLO
            #  n nhm nh gi CLO2 v CLO3
            session.add(AssessmentClo(assessment_component_id=comp1.id, syllabus_clo_id=clo2.id))
            session.add(AssessmentClo(assessment_component_id=comp1.id, syllabus_clo_id=clo3.id))
            
            # Rubric cho  n nhm
            rubric1 = Rubric(component_id=comp1.id, criteria="Ti liu SRS", max_score=5, description_level_pass="y  use case", description_level_fail="Thiu diagram")
            rubric2 = Rubric(component_id=comp1.id, criteria="Thit k DB", max_score=5, description_level_pass="Chun ha 3NF", description_level_fail="Sai quan h")
            session.add_all([rubric1, rubric2])

            # Scheme: Cui k (50%)
            scheme2 = AssessmentScheme(syllabus_id=syl.id, name="Thi cui k", weight=50)
            session.add(scheme2)
            session.flush()
            
            comp3 = AssessmentComponent(scheme_id=scheme2.id, name="Bi thi t lun", weight=50)
            session.add(comp3)
            session.flush()
            # Thi cui k nh gi ht
            session.add(AssessmentClo(assessment_component_id=comp3.id, syllabus_clo_id=clo1.id))
            session.add(AssessmentClo(assessment_component_id=comp3.id, syllabus_clo_id=clo2.id))
            session.add(AssessmentClo(assessment_component_id=comp3.id, syllabus_clo_id=clo3.id))

        # ==========================================
        # PHN 5: TNH NNG SINH VIN & THNG BO
        # ==========================================
        print(" 5. Seeding Student Features & Notifications...")
        
        student = user_map["sv_hcmut"]
        
        # Student Subscription (SV ng k theo di mn SE104)
        sub = session.query(StudentSubscription).filter_by(student_id=student.id, subject_id=subj_map["SE104"].id).first()
        if not sub:
            session.add(StudentSubscription(student_id=student.id, subject_id=subj_map["SE104"].id))

        # Student Report (SV bo li  cng)
        # Ch to nu syllabus  tn ti
        if syl:
            rep = session.query(StudentReport).filter_by(student_id=student.id, syllabus_id=syl.id).first()
            if not rep:
                session.add(StudentReport(
                    student_id=student.id, 
                    syllabus_id=syl.id, 
                    content="Mc ti liu tham kho link b hng .",
                    status="PENDING"
                ))

        # Notification (Thng bo cho GV)
        note = session.query(Notification).filter_by(user_id=lecturer.id, title="H thng  sn sng").first()
        if not note:
            session.add(Notification(
                user_id=lecturer.id,
                title="H thng  sn sng",
                message="Cho mng bn n vi h thng qun l  cng v2.0",
                type="SYSTEM",
                is_read=False
            ))

        session.commit()
        print("\n SEEDING HON TT THNH CNG! (ALL SYSTEMS GO) ")
        print(f" Admin: admin / 123456")
        print(f" Lecturer: gv_se / 123456")
        print(f" Student: sv_hcmut / 123456")

    except Exception as e:
        session.rollback()
        print(f"\n C LI XY RA: {e}")
        import traceback
        traceback.print_exc()
    finally:
        session.close()

if __name__ == "__main__":
    seed_all()
</file>

<file path="apps/api/src/api/controllers/academic_year_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.academic_year_service import AcademicYearService
from api.schemas.academic_year_schema import AcademicYearSchema

academic_year_bp = Blueprint('academic_year', __name__, url_prefix='/academic-years')

schema = AcademicYearSchema()

@academic_year_bp.route('/', methods=['GET'])
@inject
def list_academic_years(academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    """Get all academic years
    ---
    get:
      summary: Get all academic years
      tags:
        - AcademicYears
      responses:
        200:
          description: List of academic years
    """
    items = academic_year_service.list_academic_years()
    return jsonify(schema.dump(items, many=True)), 200

@academic_year_bp.route('/', methods=['POST'])
@inject
def create_academic_year(academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    """Create a new academic year
    ---
    post:
      summary: Create an academic year
      tags:
        - AcademicYears
      requestBody:
        required: true
      responses:
        201:
          description: Created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    ay = academic_year_service.create_academic_year(data)
    return jsonify(schema.dump(ay)), 201

@academic_year_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_academic_year(id: int, academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    ay = academic_year_service.update_academic_year(id, data)
    if not ay:
        return jsonify({'message': 'AcademicYear not found'}), 404
    return jsonify(schema.dump(ay)), 200

@academic_year_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_academic_year(id: int, academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    ok = academic_year_service.delete_academic_year(id)
    if not ok:
        return jsonify({'message': 'AcademicYear not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/ai_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.ai_service import AiService

ai_bp = Blueprint('ai', __name__, url_prefix='/ai')

@ai_bp.route('/generate', methods=['POST'])
@inject
def generate(ai_service: AiService = Provide[Container.ai_service]):
    data = request.get_json() or {}
    subject_name = data.get('subject_name')
    if not subject_name:
        return jsonify({'message': 'subject_name is required'}), 400

    res = ai_service.generate(subject_name)
    if isinstance(res, dict) and res.get('error'):
        return jsonify({'message': res.get('error')}), 500

    return jsonify(res), 200
</file>

<file path="apps/api/src/api/controllers/assessment_clo_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_clo_service import AssessmentCloService
from api.schemas.assessment_clo_mapping_schema import AssessmentCloMappingSchema

assessment_clo_bp = Blueprint('assessment_clo_map', __name__, url_prefix='/assessment-clos')

schema = AssessmentCloMappingSchema()

@assessment_clo_bp.route('/component/<int:component_id>', methods=['GET'])
@inject
def list_clos(component_id: int, service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    List CLOs mapped to a component
    ---
    tags:
      - Assessments
    parameters:
      - name: component_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of CLOs (id, code, description)
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: integer
                  code:
                    type: string
                  description:
                    type: string
    """
    items = service.get_clos_for_component(component_id)
    return jsonify([{'id': c.id, 'code': c.code, 'description': c.description} for c in items]), 200

@assessment_clo_bp.route('/', methods=['POST'])
@inject
def add_mapping(service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    Map a CLO to an assessment component
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentCloMapping'
    responses:
      201:
        description: Mapping created
      400:
        description: Validation or integrity error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        mapping = service.add_mapping(data['assessment_component_id'], data['syllabus_clo_id'])
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify({'assessment_component_id': mapping.assessment_component_id, 'syllabus_clo_id': mapping.syllabus_clo_id}), 201

@assessment_clo_bp.route('/', methods=['DELETE'])
@inject
def remove_mapping(service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    Remove a mapping between component and CLO
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentCloMapping'
    responses:
      204:
        description: Mapping removed
      400:
        description: Bad request
      404:
        description: Mapping not found
    """
    data = request.get_json() or {}
    if not data:
        return jsonify({'error': 'Provide JSON body with assessment_component_id and syllabus_clo_id'}), 400
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    ok = service.remove_mapping(data['assessment_component_id'], data['syllabus_clo_id'])
    if not ok:
        return jsonify({'message': 'Mapping not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/assessment_component_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_component_service import AssessmentComponentService
from api.schemas.assessment_component_schema import AssessmentComponentSchema

assessment_component_bp = Blueprint('assessment_component', __name__, url_prefix='/assessment-components')

schema = AssessmentComponentSchema()

@assessment_component_bp.route('/', methods=['POST'])
@inject
def create_component(service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Create an assessment component
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentComponent'
    responses:
      201:
        description: Component created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_component(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@assessment_component_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_component(id: int, service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Update an assessment component
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentComponent'
    responses:
      200:
        description: Component updated
      400:
        description: Validation error
      404:
        description: Component not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = service.update_component(id, data)
    if not item:
        return jsonify({'message': 'Component not found'}), 404
    return jsonify(schema.dump(item)), 200

@assessment_component_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_component(id: int, service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Delete an assessment component
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Component not found
    """
    ok = service.delete_component(id)
    if not ok:
        return jsonify({'message': 'Component not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/assessment_scheme_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_scheme_service import AssessmentSchemeService
from api.schemas.assessment_scheme_schema import AssessmentSchemeSchema

assessment_scheme_bp = Blueprint('assessment_scheme', __name__, url_prefix='/assessment-schemes')

schema = AssessmentSchemeSchema()

@assessment_scheme_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_schemes(syllabus_id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    List assessment schemes for a syllabus
    ---
    tags:
      - Assessments
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of assessment schemes
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/AssessmentScheme'
    """
    items = service.list_schemes_for_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@assessment_scheme_bp.route('/', methods=['POST'])
@inject
def create_scheme(service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Create an assessment scheme
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentScheme'
    responses:
      201:
        description: Scheme created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_scheme(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@assessment_scheme_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_scheme(id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Update an assessment scheme
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentScheme'
    responses:
      200:
        description: Scheme updated
      400:
        description: Validation error
      404:
        description: Scheme not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = service.update_scheme(id, data)
    if not item:
        return jsonify({'message': 'Scheme not found'}), 404
    return jsonify(schema.dump(item)), 200

@assessment_scheme_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_scheme(id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Delete an assessment scheme
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Scheme not found
    """
    ok = service.delete_scheme(id)
    if not ok:
        return jsonify({'message': 'Scheme not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/auth_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.user_service import UserService
from werkzeug.security import check_password_hash

auth_bp = Blueprint('auth', __name__, url_prefix='/auth')

@auth_bp.route('/login', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def login(user_service: UserService = Provide[Container.user_service]):
    """
    Login and obtain a token
    ---
    tags:
      - Auth
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              username:
                type: string
              password:
                type: string
            required:
              - username
              - password
    responses:
      200:
        description: Login successful, returns token and user information
      400:
        description: Missing username or password
      401:
        description: Invalid credentials
    """
    if request.method == 'OPTIONS':
      # Fast path for CORS preflight
      return jsonify({'message': 'CORS preflight OK'}), 200

    data = request.get_json() or {}
    username = data.get('username')
    password = data.get('password')
    if not username or not password:
        return jsonify({'message': 'username and password are required'}), 400
    user = user_service.get_by_username(username)
    if not user:
        return jsonify({'message': 'Invalid credentials'}), 401
    if not check_password_hash(user.password_hash, password):
        return jsonify({'message': 'Invalid credentials'}), 401

    # Get role name if available
    role_name = None
    try:
        if user.roles and len(user.roles) > 0 and getattr(user.roles[0], 'role', None):
            role_name = user.roles[0].role.name
    except Exception:
        role_name = None

    token = f"fake-jwt-token-for-{username}"
    return jsonify({'token': token, 'user_id': user.id, 'role': role_name}), 200
</file>

<file path="apps/api/src/api/controllers/clo_plo_mapping_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.clo_plo_mapping_service import CloPloMappingService
from api.schemas.clo_plo_mapping_schema import CloPloMappingSchema

clo_plo_mapping_bp = Blueprint('clo_plo_mapping', __name__, url_prefix='/clo-plo-mappings')
schema = CloPloMappingSchema()

@clo_plo_mapping_bp.route('/', methods=['POST'])
@inject
def create_mapping(service: CloPloMappingService = Provide[Container.clo_plo_mapping_service]):
    """
    Create CLO-PLO Mapping
    ---
    tags:
      - Mappings (CLO-PLO)
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CloPloMapping'
    responses:
      201: {description: Created}
      400: {description: Error}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_mapping(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@clo_plo_mapping_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_mapping(id: int, service: CloPloMappingService = Provide[Container.clo_plo_mapping_service]):
    """
    Delete CLO-PLO Mapping
    ---
    tags:
      - Mappings (CLO-PLO)
    parameters:
      - name: id
        in: path
        required: true
        schema: {type: integer}
    responses:
      204: {description: Deleted}
    """
    ok = service.delete_mapping(id)
    if not ok:
        return jsonify({'message': 'Mapping not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/dashboard_controller.py">
from flask import Blueprint, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_service import SyllabusService
from services.user_service import UserService

dashboard_bp = Blueprint('dashboard', __name__, url_prefix='/stats')

@dashboard_bp.route('/', methods=['GET'])
@inject
def get_stats(syllabus_service: SyllabusService = Provide[Container.syllabus_service], user_service: UserService = Provide[Container.user_service]):
    syllabuses = syllabus_service.list_syllabuses() or []
    users = user_service.list_users() or []

    total_syllabuses = len(syllabuses)
    total_users = len(users)

    # Group by status
    stats_by_status = {
        'Approved': 0,
        'Pending': 0,
        'Draft': 0,
        'Returned': 0
    }
    for s in syllabuses:
        status = getattr(s, 'status', None) or getattr(s, 'state', None) or 'Draft'
        # Normalize
        if status.upper() in ('APPROVED',):
            stats_by_status['Approved'] += 1
        elif 'PENDING' in status.upper():
            stats_by_status['Pending'] += 1
        elif status.upper() in ('RETURNED', 'REJECTED'):
            stats_by_status['Returned'] += 1
        else:
            stats_by_status['Draft'] += 1

    return jsonify({
        'total_syllabuses': total_syllabuses,
        'total_users': total_users,
        'by_status': stats_by_status
    }), 200
</file>

<file path="apps/api/src/api/controllers/department_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.department_service import DepartmentService
from api.schemas.department_schema import DepartmentSchema

department_bp = Blueprint('department', __name__, url_prefix='/departments')

schema = DepartmentSchema()

@department_bp.route('/', methods=['GET'])
@inject
def list_departments(department_service: DepartmentService = Provide[Container.department_service]):
    """Get all departments
    ---
    get:
      summary: Get all departments
      tags:
        - Departments
      responses:
        200:
          description: List of departments
    """
    departments = department_service.list_departments()
    return jsonify(schema.dump(departments, many=True)), 200

@department_bp.route('/<int:id>', methods=['GET'])
@inject
def get_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Get department by id
    ---
    get:
      summary: Get department by ID
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Department object
        404:
          description: Not found
    """
    department = department_service.get_department(id)
    if not department:
        return jsonify({'message': 'Department not found'}), 404
    return jsonify(schema.dump(department)), 200

@department_bp.route('/', methods=['POST'])
@inject
def create_department(department_service: DepartmentService = Provide[Container.department_service]):
    """Create a new department
    ---
    post:
      summary: Create a new department
      tags:
        - Departments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Department'
      responses:
        201:
          description: Department created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    department = department_service.create_department(data)
    return jsonify(schema.dump(department)), 201

@department_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Update an existing department
    ---
    put:
      summary: Update department
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Department'
      responses:
        200:
          description: Department updated
        400:
          description: Invalid input
        404:
          description: Department not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    department = department_service.update_department(id, data)
    if not department:
        return jsonify({'message': 'Department not found'}), 404
    return jsonify(schema.dump(department)), 200

@department_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Delete department
    ---
    delete:
      summary: Delete department
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Department not found
    """
    ok = department_service.delete_department(id)
    if not ok:
        return jsonify({'message': 'Department not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/faculty_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.faculty_service import FacultyService
from api.schemas.faculty_schema import FacultySchema

faculty_bp = Blueprint('faculty', __name__, url_prefix='/faculties')

schema = FacultySchema()

@faculty_bp.route('/', methods=['GET'])
@inject
def list_faculties(faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Get all faculties
    ---
    get:
      summary: Get all faculties
      tags:
        - Faculties
      responses:
        200:
          description: List of faculties
    """
    faculties = faculty_service.list_faculties()
    return jsonify(schema.dump(faculties, many=True)), 200

@faculty_bp.route('/<int:id>', methods=['GET'])
@inject
def get_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Get faculty by id
    ---
    get:
      summary: Get faculty by ID
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Faculty object
        404:
          description: Not found
    """
    faculty = faculty_service.get_faculty(id)
    if not faculty:
        return jsonify({'message': 'Faculty not found'}), 404
    return jsonify(schema.dump(faculty)), 200

@faculty_bp.route('/', methods=['POST'])
@inject
def create_faculty(faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Create a new faculty
    ---
    post:
      summary: Create a new faculty
      tags:
        - Faculties
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Faculty'
      responses:
        201:
          description: Faculty created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    faculty = faculty_service.create_faculty(data)
    return jsonify(schema.dump(faculty)), 201

@faculty_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Update an existing faculty
    ---
    put:
      summary: Update faculty
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Faculty'
      responses:
        200:
          description: Faculty updated
        400:
          description: Invalid input
        404:
          description: Faculty not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    faculty = faculty_service.update_faculty(id, data)
    if not faculty:
        return jsonify({'message': 'Faculty not found'}), 404
    return jsonify(schema.dump(faculty)), 200

@faculty_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Delete faculty
    ---
    delete:
      summary: Delete faculty
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Faculty not found
    """
    ok = faculty_service.delete_faculty(id)
    if not ok:
        return jsonify({'message': 'Faculty not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/file_controller.py">
from flask import Blueprint, request, jsonify, send_file
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.file_service import FileService
from api.schemas.file_schema import FileSchema
import os

file_bp = Blueprint('file', __name__, url_prefix='/files')
schema = FileSchema()

@file_bp.route('/upload', methods=['POST'])
@inject
def upload_file(service: FileService = Provide[Container.file_service]):
    if 'file' not in request.files:
        return jsonify({'error': 'No file part'}), 400
    file = request.files['file']
    # Demo: assume user_id=1 if no auth (In production, get from token)
    user_id = request.form.get('user_id', 1) 
    try:
        record = service.upload_file(file, int(user_id))
        return jsonify(schema.dump(record)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@file_bp.route('/<int:id>', methods=['GET'])
@inject
def download_file(id: int, service: FileService = Provide[Container.file_service]):
    record = service.get_file(id)
    if not record:
        return jsonify({'message': 'File not found'}), 404
    try:
        return send_file(os.path.abspath(record.file_path), as_attachment=True, download_name=record.file_name)
    except Exception:
        return jsonify({'message': 'File not found on disk'}), 404
</file>

<file path="apps/api/src/api/controllers/notification_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.notification_service import NotificationService
from api.schemas.notification_schema import NotificationSchema
from api.middleware import token_required

notification_bp = Blueprint('notification', __name__, url_prefix='/notifications')
schema = NotificationSchema()

@notification_bp.route('/', methods=['GET'])
@inject
@token_required
def get_my_notifications(service: NotificationService = Provide[Container.notification_service]):
    """
    Get current user's notifications
    ---
    tags:
      - Notifications
    parameters:
      - name: unread
        in: query
        type: boolean
        description: Filter by unread only
    responses:
      200:
        description: List of notifications
    """
    user_id = getattr(request, 'user', {}).get('user_id')
    if not user_id:
         return jsonify({'message': 'User context missing'}), 401
    unread = request.args.get('unread', 'false').lower() == 'true'
    items = service.get_user_notifications(user_id, unread_only=unread)
    return jsonify(schema.dump(items, many=True)), 200

@notification_bp.route('/<int:id>/read', methods=['PUT'])
@inject
@token_required
def mark_read(id: int, service: NotificationService = Provide[Container.notification_service]):
    """
    Mark a notification as read
    ---
    tags:
      - Notifications
    parameters:
      - name: id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200:
        description: Marked as read
    """
    ok = service.mark_read(id)
    if not ok:
        return jsonify({'message': 'Notification not found'}), 404
    return jsonify({'message': 'Marked as read'}), 200
</file>

<file path="apps/api/src/api/controllers/program_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.program_service import ProgramService
from api.schemas.program_schema import ProgramSchema

program_bp = Blueprint('program', __name__, url_prefix='/programs')

schema = ProgramSchema()

@program_bp.route('/', methods=['GET'])
@inject
def list_programs(program_service: ProgramService = Provide[Container.program_service]):
    """Get all programs
    ---
    get:
      summary: Get all programs
      tags:
        - Programs
      responses:
        200:
          description: List of programs
    """
    items = program_service.list_programs()
    return jsonify(schema.dump(items, many=True)), 200

@program_bp.route('/', methods=['POST'])
@inject
def create_program(program_service: ProgramService = Provide[Container.program_service]):
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    p = program_service.create_program(data)
    return jsonify(schema.dump(p)), 201

@program_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_program(id: int, program_service: ProgramService = Provide[Container.program_service]):
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    p = program_service.update_program(id, data)
    if not p:
        return jsonify({'message': 'Program not found'}), 404
    return jsonify(schema.dump(p)), 200

@program_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_program(id: int, program_service: ProgramService = Provide[Container.program_service]):
    ok = program_service.delete_program(id)
    if not ok:
        return jsonify({'message': 'Program not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/program_outcome_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.program_outcome_service import ProgramOutcomeService
from api.schemas.program_outcome_schema import ProgramOutcomeSchema

program_outcome_bp = Blueprint('program_outcome', __name__, url_prefix='/program-outcomes')
schema = ProgramOutcomeSchema()

@program_outcome_bp.route('/program/<int:program_id>', methods=['GET'])
@inject
def list_plos(program_id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    items = service.list_by_program(program_id)
    return jsonify(schema.dump(items, many=True)), 200

@program_outcome_bp.route('/', methods=['POST'])
@inject
def create_plo(service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_plo(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@program_outcome_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_plo(id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    data = request.get_json() or {}
    item = service.update_plo(id, data)
    if not item:
        return jsonify({'message': 'PLO not found'}), 404
    return jsonify(schema.dump(item)), 200

@program_outcome_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_plo(id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    ok = service.delete_plo(id)
    if not ok:
        return jsonify({'message': 'PLO not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/role_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.role_service import RoleService
from api.schemas.role_schema import RoleSchema

role_bp = Blueprint('role', __name__, url_prefix='/roles')

schema = RoleSchema()

@role_bp.route('/', methods=['GET'])
@inject
def list_roles(role_service: RoleService = Provide[Container.role_service]):
    """Get all roles
    ---
    get:
      summary: Get all roles
      tags:
        - Roles
      responses:
        200:
          description: List of roles
    """
    roles = role_service.list_roles()
    return jsonify(schema.dump(roles, many=True)), 200

@role_bp.route('/', methods=['POST'])
@inject
def create_role(role_service: RoleService = Provide[Container.role_service]):
    """Create a new role
    ---
    post:
      summary: Create a new role
      tags:
        - Roles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        201:
          description: Role created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    role = role_service.create_role(data)
    return jsonify(schema.dump(role)), 201
</file>

<file path="apps/api/src/api/controllers/rubric_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.rubric_service import RubricService
from api.schemas.rubric_schema import RubricSchema

rubric_bp = Blueprint('rubric', __name__, url_prefix='/rubrics')

schema = RubricSchema()

@rubric_bp.route('/component/<int:component_id>', methods=['GET'])
@inject
def list_rubrics(component_id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    List rubrics for a component
    ---
    tags:
      - Rubrics
    parameters:
      - name: component_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of rubrics
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/Rubric'
    """
    items = rubric_service.list_rubrics_for_component(component_id)
    return jsonify(schema.dump(items, many=True)), 200

@rubric_bp.route('/', methods=['POST'])
@inject
def create_rubric(rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Create a rubric
    ---
    tags:
      - Rubrics
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Rubric'
    responses:
      201:
        description: Rubric created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = rubric_service.create_rubric(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@rubric_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_rubric(id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Update a rubric
    ---
    tags:
      - Rubrics
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Rubric'
    responses:
      200:
        description: Rubric updated
      400:
        description: Validation error
      404:
        description: Rubric not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = rubric_service.update_rubric(id, data)
    if not item:
        return jsonify({'message': 'Rubric not found'}), 404
    return jsonify(schema.dump(item)), 200

@rubric_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_rubric(id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Delete a rubric
    ---
    tags:
      - Rubrics
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Rubric not found
    """
    ok = rubric_service.delete_rubric(id)
    if not ok:
        return jsonify({'message': 'Rubric not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/student_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.student_service import StudentService
from api.schemas.student_schema import StudentSubscriptionSchema, StudentReportSchema

student_bp = Blueprint('student', __name__, url_prefix='/student')
sub_schema = StudentSubscriptionSchema()
rep_schema = StudentReportSchema()

@student_bp.route('/subscribe', methods=['POST'])
@inject
def subscribe(service: StudentService = Provide[Container.student_service]):
    """
    Student subscribes to a subject
    ---
    tags:
      - Student Features
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              student_id: {type: integer}
              subject_id: {type: integer}
    responses:
      201:
        description: Subscription created
    """
    data = request.get_json() or {}
    item = service.subscribe(data.get('student_id'), data.get('subject_id'))
    return jsonify(sub_schema.dump(item)), 201

@student_bp.route('/report', methods=['POST'])
@inject
def report(service: StudentService = Provide[Container.student_service]):
    """
    Student reports an issue with a syllabus
    ---
    tags:
      - Student Features
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/StudentReport'
    responses:
      201:
        description: Report created
    """
    data = request.get_json() or {}
    item = service.report_syllabus(data.get('student_id'), data.get('syllabus_id'), data.get('content'))
    return jsonify(rep_schema.dump(item)), 201

@student_bp.route('/reports', methods=['GET'])
@inject
def list_reports(service: StudentService = Provide[Container.student_service]):
    """
    List all student reports (Admin)
    ---
    tags:
      - Student Features
    responses:
      200:
        description: List of reports
    """
    items = service.list_reports()
    return jsonify(rep_schema.dump(items, many=True)), 200
</file>

<file path="apps/api/src/api/controllers/subject_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.subject_service import SubjectService
from api.schemas.subject_schema import SubjectSchema

subject_bp = Blueprint('subject', __name__, url_prefix='/subjects')

schema = SubjectSchema()

@subject_bp.route('/', methods=['GET'])
@inject
def list_subjects(subject_service: SubjectService = Provide[Container.subject_service]):
    """Get all subjects
    ---
    get:
      summary: Get all subjects
      tags:
        - Subjects
      responses:
        200:
          description: List of subjects
    """
    subjects = subject_service.list_subjects()
    return jsonify(schema.dump(subjects, many=True)), 200

@subject_bp.route('/<int:id>', methods=['GET'])
@inject
def get_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Get subject by id
    ---
    get:
      summary: Get subject by ID
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Subject object
        404:
          description: Not found
    """
    subject = subject_service.get_subject(id)
    if not subject:
        return jsonify({'message': 'Subject not found'}), 404
    return jsonify(schema.dump(subject)), 200

@subject_bp.route('/', methods=['POST'])
@inject
def create_subject(subject_service: SubjectService = Provide[Container.subject_service]):
    """Create a new subject
    ---
    post:
      summary: Create a new subject
      tags:
        - Subjects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subject'
      responses:
        201:
          description: Subject created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    subject = subject_service.create_subject(data)
    return jsonify(schema.dump(subject)), 201

@subject_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Update an existing subject
    ---
    put:
      summary: Update subject
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subject'
      responses:
        200:
          description: Subject updated
        400:
          description: Invalid input
        404:
          description: Subject not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    subject = subject_service.update_subject(id, data)
    if not subject:
        return jsonify({'message': 'Subject not found'}), 404
    return jsonify(schema.dump(subject)), 200

@subject_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Delete subject
    ---
    delete:
      summary: Delete subject
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Subject not found
    """
    ok = subject_service.delete_subject(id)
    if not ok:
        return jsonify({'message': 'Subject not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/subject_relationship_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.subject_relationship_service import SubjectRelationshipService
from api.schemas.subject_relationship_schema import SubjectRelationshipSchema

subject_rel_bp = Blueprint('subject_relationship', __name__, url_prefix='/subject-relationships')
schema = SubjectRelationshipSchema()

@subject_rel_bp.route('/subject/<int:subject_id>', methods=['GET'])
@inject
def list_relationships(subject_id: int, service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    List relationships for a subject
    ---
    tags:
      - Subject Relationships
    parameters:
      - name: subject_id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200: {description: List of relationships}
    """
    items = service.get_relationships(subject_id)
    return jsonify(schema.dump(items, many=True)), 200

@subject_rel_bp.route('/', methods=['POST'])
@inject
def create_relationship(service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    Create subject relationship
    ---
    tags:
      - Subject Relationships
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SubjectRelationship'
    responses:
      201: {description: Created}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.add_relationship(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@subject_rel_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_relationship(id: int, service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    Delete relationship
    ---
    tags:
      - Subject Relationships
    responses:
      204: {description: Deleted}
    """
    ok = service.remove_relationship(id)
    if not ok:
        return jsonify({'message': 'Relationship not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/syllabus_clo_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_clo_service import SyllabusCloService
from api.schemas.syllabus_clo_schema import SyllabusCloSchema

syllabus_clo_bp = Blueprint('syllabus_clo', __name__, url_prefix='/syllabus-clos')

schema = SyllabusCloSchema()

@syllabus_clo_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_clos(syllabus_id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    List CLOs for a syllabus
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of CLOs
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/SyllabusClo'
    """
    items = syllabus_clo_service.get_by_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_clo_bp.route('/', methods=['POST'])
@inject
def create_clo(syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Create a new CLO for a syllabus
    ---
    tags:
      - Syllabus CLOs
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusClo'
    responses:
      201:
        description: CLO created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = syllabus_clo_service.create_clo(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@syllabus_clo_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_clo(id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Update an existing CLO
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusClo'
    responses:
      200:
        description: CLO updated
      400:
        description: Validation error
      404:
        description: CLO not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = syllabus_clo_service.update_clo(id, data)
    if not item:
        return jsonify({'message': 'CLO not found'}), 404
    return jsonify(schema.dump(item)), 200

@syllabus_clo_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_clo(id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Delete a CLO by id
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: CLO not found
    """
    ok = syllabus_clo_service.delete_clo(id)
    if not ok:
        return jsonify({'message': 'CLO not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/syllabus_comment_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_comment_service import SyllabusCommentService
from api.schemas.syllabus_comment_schema import SyllabusCommentSchema

syllabus_comment_bp = Blueprint('syllabus_comment', __name__, url_prefix='/syllabus-comments')
schema = SyllabusCommentSchema()

@syllabus_comment_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_comments(syllabus_id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    List comments for syllabus
    ---
    tags:
      - Comments
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200: {description: List of comments}
    """
    items = service.get_comments(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_comment_bp.route('/', methods=['POST'])
@inject
def add_comment(service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Add a comment
    ---
    tags:
      - Comments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusComment'
    responses:
      201: {description: Created}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.add_comment(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@syllabus_comment_bp.route('/<int:id>/resolve', methods=['PUT'])
@inject
def resolve_comment(id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Mark comment as resolved
    ---
    tags:
      - Comments
    responses:
      200: {description: Resolved}
    """
    item = service.resolve_comment(id)
    if not item:
        return jsonify({'message': 'Comment not found'}), 404
    return jsonify(schema.dump(item)), 200

@syllabus_comment_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_comment(id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Delete comment
    ---
    tags:
      - Comments
    responses:
      204: {description: Deleted}
    """
    ok = service.delete_comment(id)
    if not ok:
        return jsonify({'message': 'Comment not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/syllabus_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_service import SyllabusService
from api.schemas.syllabus_schema import SyllabusSchema
from api.schemas.syllabus_detail_schema import SyllabusDetailSchema
from api.middleware import token_required

syllabus_bp = Blueprint('syllabus', __name__, url_prefix='/syllabuses')

schema = SyllabusSchema()
detail_schema = SyllabusDetailSchema()

@syllabus_bp.route('/', methods=['GET'])
@inject
def list_syllabuses(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """List syllabuses
    ---
    get:
      summary: List syllabuses
      tags:
        - Syllabuses
      responses:
        200:
          description: List of syllabuses
    """
    items = syllabus_service.list_syllabuses()
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_bp.route('/<int:id>', methods=['GET'])
@inject
def get_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get syllabus
    ---
    get:
      summary: Get syllabus by id
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Syllabus object
        404:
          description: Not found
    """
    s = syllabus_service.get_syllabus(id)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200


@syllabus_bp.route('/<int:id>/details', methods=['GET'])
@inject
def get_syllabus_details(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get full syllabus details
    ---
    get:
      summary: Get syllabus details by id
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Syllabus detail object
        404:
          description: Not found
    """
    s = syllabus_service.get_syllabus_details(id)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(detail_schema.dump(s)), 200


@syllabus_bp.route('/compare', methods=['GET'])
@inject
def compare_syllabuses(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Compare two syllabuses by id
    ---
    get:
      summary: Compare two syllabuses
      tags:
        - Syllabuses
      parameters:
        - name: base_id
          in: query
          required: true
          schema:
            type: integer
        - name: target_id
          in: query
          required: true
          schema:
            type: integer
    responses:
      200:
        description: Differences between the two syllabuses
      404:
        description: Syllabus not found
    """
    try:
        base_id = int(request.args.get('baseId') or request.args.get('base_id'))
        target_id = int(request.args.get('targetId') or request.args.get('target_id'))
    except Exception:
        return jsonify({'message': 'base_id and target_id query parameters are required and must be integers'}), 400

    base = syllabus_service.get_syllabus_details(base_id)
    target = syllabus_service.get_syllabus_details(target_id)

    if not base or not target:
        return jsonify({'message': 'One or both syllabuses not found'}), 404

    # Fields to compare
    fields = ['subject_name_vi', 'credits', 'description', 'student_duties']
    diffs = []
    for f in fields:
        base_val = getattr(base, f, None)
        target_val = getattr(target, f, None)
        if base_val != target_val:
            diffs.append({'field': f, 'base': base_val, 'target': target_val})

    # Compare CLO counts
    base_clos = getattr(base, 'clos', []) or []
    target_clos = getattr(target, 'clos', []) or []
    if len(base_clos) != len(target_clos):
        diffs.append({'field': 'clos_count', 'base': len(base_clos), 'target': len(target_clos)})

    return jsonify({'diffs': diffs}), 200


@syllabus_bp.route('/<int:id>/submit', methods=['POST'])
@inject
def submit_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Submit a syllabus for evaluation
    ---
    post:
      summary: Submit syllabus
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
      responses:
        200:
          description: Submitted syllabus
        400:
          description: Invalid action
        404:
          description: Not found
    """
    data = request.get_json() or {}
    user_id = data.get('user_id')
    if not user_id:
        return jsonify({'message': 'user_id is required'}), 400
    try:
        s = syllabus_service.submit_syllabus(id, user_id)
    except ValueError as e:
        return jsonify({'message': str(e)}), 400
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200


@syllabus_bp.route('/<int:id>/evaluate', methods=['POST'])
@inject
def evaluate_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Evaluate (approve/reject) a syllabus
    ---
    post:
      summary: Evaluate syllabus
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
      responses:
        200:
          description: Evaluation result
        400:
          description: Invalid action or missing comment
        404:
          description: Not found
    """
    data = request.get_json() or {}
    action = data.get('action')
    user_id = data.get('user_id')
    comment = data.get('comment')
    if not action or not user_id:
        return jsonify({'message': 'action and user_id are required'}), 400
    try:
        s = syllabus_service.evaluate_syllabus(id, user_id, action, comment)
    except ValueError as e:
        return jsonify({'message': str(e)}), 400
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200


@syllabus_bp.route('/<int:id>/workflow-logs', methods=['GET'])
@inject
def get_workflow_logs(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get workflow logs for a syllabus
    ---
    get:
      summary: Get workflow logs
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: List of workflow logs
        404:
          description: Not found
    """
    logs = syllabus_service.get_workflow_logs(id)
    from api.schemas.workflow_log_schema import WorkflowLogSchema
    schema_w = WorkflowLogSchema()
    return jsonify(schema_w.dump(logs, many=True)), 200

@syllabus_bp.route('/', methods=['POST'])
@inject
@token_required
def create_syllabus(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Create a syllabus
    ---
    post:
      summary: Create syllabus
      tags:
        - Syllabuses
      requestBody:
        required: true
      responses:
        201:
          description: Created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        s = syllabus_service.create_syllabus(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(s)), 201

@syllabus_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    s = syllabus_service.update_syllabus(id, data)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200

@syllabus_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    ok = syllabus_service.delete_syllabus(id)
    if not ok:
        return jsonify({'message': 'Syllabus not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/syllabus_material_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_material_service import SyllabusMaterialService
from api.schemas.syllabus_material_schema import SyllabusMaterialSchema

syllabus_material_bp = Blueprint('syllabus_material', __name__, url_prefix='/syllabus-materials')

schema = SyllabusMaterialSchema()

@syllabus_material_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_materials(syllabus_id: int, syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    List materials for a syllabus
    ---
    tags:
      - Syllabus Materials
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of materials
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/SyllabusMaterial'
    """
    items = syllabus_material_service.get_by_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_material_bp.route('/', methods=['POST'])
@inject
def create_material(syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    Create a syllabus material
    ---
    tags:
      - Syllabus Materials
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusMaterial'
    responses:
      201:
        description: Material created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = syllabus_material_service.create_material(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@syllabus_material_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_material(id: int, syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    Delete a syllabus material
    ---
    tags:
      - Syllabus Materials
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Material not found
    """
    ok = syllabus_material_service.delete_material(id)
    if not ok:
        return jsonify({'message': 'Material not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/system_setting_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.system_setting_service import SystemSettingService
from api.schemas.system_setting_schema import SystemSettingSchema

system_setting_bp = Blueprint('system_setting', __name__, url_prefix='/system-settings')
schema = SystemSettingSchema()

@system_setting_bp.route('/', methods=['GET'])
@inject
def list_settings(service: SystemSettingService = Provide[Container.system_setting_service]):
    """
    List all system settings
    ---
    tags:
      - System Settings
    responses:
      200:
        description: List of settings
    """
    items = service.get_all_settings()
    return jsonify(schema.dump(items, many=True)), 200

@system_setting_bp.route('/', methods=['POST'])
@inject
def update_setting(service: SystemSettingService = Provide[Container.system_setting_service]):
    """
    Update or create a system setting
    ---
    tags:
      - System Settings
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SystemSetting'
    responses:
      200:
        description: Setting updated
      400:
        description: Validation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    item = service.update_setting(data['key'], data['value'], data.get('description'))
    return jsonify(schema.dump(item)), 200
</file>

<file path="apps/api/src/api/controllers/teaching_plan_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.teaching_plan_service import TeachingPlanService
from api.schemas.teaching_plan_schema import TeachingPlanSchema

teaching_plan_bp = Blueprint('teaching_plan', __name__, url_prefix='/teaching-plans')

schema = TeachingPlanSchema()

@teaching_plan_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_plans(syllabus_id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    List teaching plans for a syllabus
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of teaching plans
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/TeachingPlan'
    """
    items = teaching_plan_service.list_plans_for_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@teaching_plan_bp.route('/', methods=['POST'])
@inject
def create_plan(teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Create a teaching plan
    ---
    tags:
      - Teaching Plans
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TeachingPlan'
    responses:
      201:
        description: Teaching plan created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = teaching_plan_service.create_teaching_plan(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@teaching_plan_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_plan(id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Update a teaching plan
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TeachingPlan'
    responses:
      200:
        description: Teaching plan updated
      400:
        description: Validation error
      404:
        description: Teaching plan not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = teaching_plan_service.update_teaching_plan(id, data)
    if not item:
        return jsonify({'message': 'Teaching plan not found'}), 404
    return jsonify(schema.dump(item)), 200

@teaching_plan_bp.route('/<int:id>', methods=['DELETE'])
@inject
def delete_plan(id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Delete a teaching plan
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Teaching plan not found
    """
    ok = teaching_plan_service.delete_teaching_plan(id)
    if not ok:
        return jsonify({'message': 'Teaching plan not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/user_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.user_service import UserService
from api.schemas.user_schema import UserSchema
from api.middleware import token_required

user_bp = Blueprint('user', __name__, url_prefix='/users')

schema = UserSchema()

@user_bp.route('/', methods=['GET'])
@inject
def list_users(user_service: UserService = Provide[Container.user_service]):
    """Get all users
    ---
    get:
      summary: Get all users
      tags:
        - Users
      responses:
        200:
          description: List of users
    """
    users = user_service.list_users()
    return jsonify(schema.dump(users, many=True)), 200

@user_bp.route('/<int:id>', methods=['GET'])
@inject
def get_user(id: int, user_service: UserService = Provide[Container.user_service]):
    """Get user by id
    ---
    get:
      summary: Get user by ID
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: User object
        404:
          description: Not found
    """
    user = user_service.get_user(id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    return jsonify(schema.dump(user)), 200


@user_bp.route('/me', methods=['GET'])
@inject
@token_required
def get_me(user_service: UserService = Provide[Container.user_service]):
    """Get current user from token
    """
    from flask import request
    payload = getattr(request, 'user', None)
    if not payload:
        return jsonify({'message': 'User not found in token'}), 404
    user_id = payload.get('user_id')
    if not user_id:
        return jsonify({'message': 'user_id missing in token'}), 400
    user = user_service.get_user(user_id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    return jsonify(schema.dump(user)), 200

@user_bp.route('/', methods=['POST'])
@inject
def create_user(user_service: UserService = Provide[Container.user_service]):
    """Create a new user
    ---
    post:
      summary: Create a new user
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/User'
      responses:
        201:
          description: User created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    user = user_service.create_user(data)
    return jsonify(schema.dump(user)), 201

@user_bp.route('/<int:id>', methods=['PUT'])
@inject
def update_user(id: int, user_service: UserService = Provide[Container.user_service]):
    """Update an existing user
    ---
    put:
      summary: Update user
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/User'
      responses:
        200:
          description: User updated
        400:
          description: Invalid input
        404:
          description: User not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    user = user_service.update_user(id, data)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    return jsonify(schema.dump(user)), 200
</file>

<file path="apps/api/src/api/middleware.py">
# Middleware functions for processing requests and responses

from flask import  request, jsonify

def log_request_info(app):
    app.logger.debug('Headers: %s', request.headers)
    app.logger.debug('Body: %s', request.get_data())

def handle_options_request():
    return jsonify({'message': 'CORS preflight response'}), 200

from flask import current_app
from werkzeug.exceptions import HTTPException
import traceback

def error_handling_middleware(error):
    # Handle HTTP exceptions (e.g., BadRequest) with their status codes
    if isinstance(error, HTTPException):
        response = jsonify({'error': error.description})
        response.status_code = error.code or 400
        return response

    # Log unexpected exceptions with traceback
    try:
        current_app.logger.exception(error)
    except Exception:
        pass

    tb = None
    try:
        tb = traceback.format_exc()
    except Exception:
        tb = None

    payload = {'error': str(error)}
    if getattr(current_app, 'debug', False) and tb:
        payload['traceback'] = tb

    response = jsonify(payload)
    response.status_code = 500
    return response

def add_custom_headers(response):
    response.headers['X-Custom-Header'] = 'Value'
    return response

from functools import wraps


def middleware(app):
    @app.before_request
    def before_request():
        log_request_info(app)

    @app.after_request
    def after_request(response):
        return add_custom_headers(response)

    @app.errorhandler(Exception)
    def handle_exception(error):
        return error_handling_middleware(error)

    @app.route('/options', methods=['OPTIONS'])
    def options_route():
        return handle_options_request()


# Token decorator verifying JWT
import jwt
from config import Config

def token_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        from flask import request, make_response
        # Allow preflight CORS requests through without authentication
        if request.method == 'OPTIONS':
            return make_response('', 200)
        auth = request.headers.get('Authorization', '')
        if not auth or not auth.startswith('Bearer '):
            return jsonify({'message': 'Authorization token is missing'}), 401
        token = auth.split(' ', 1)[1]
        try:
            payload = jwt.decode(token, Config.SECRET_KEY, algorithms=['HS256'])
            # Optionally attach user info to request context
            request.user = payload
        except jwt.ExpiredSignatureError:
            return jsonify({'message': 'Token expired'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'message': 'Invalid token'}), 401
        return f(*args, **kwargs)

    return decorated
</file>

<file path="apps/api/src/api/requests.py">
# requests.py

from flask import request, jsonify

def get_request_data():
    """Extracts and returns JSON data from the request."""
    data = request.get_json()
    if not data:
        return jsonify({"error": "No data provided"}), 400
    return data

def validate_request_schema(schema):
    """Validates the incoming request data against the provided schema."""
    data = get_request_data()
    errors = schema.validate(data)
    if errors:
        return jsonify({"errors": errors}), 400
    return data

def handle_get_request():
    """Handles GET requests."""
    # Logic for handling GET requests goes here
    pass

def handle_post_request():
    """Handles POST requests."""
    # Logic for handling POST requests goes here
    pass

def handle_put_request():
    """Handles PUT requests."""
    # Logic for handling PUT requests goes here
    pass

def handle_delete_request():
    """Handles DELETE requests."""
    # Logic for handling DELETE requests goes here
    pass
</file>

<file path="apps/api/src/api/responses.py">
# src/api/responses.py

from flask import jsonify

def success_response(data, message="Success"):
    return jsonify({"message": message, "data": data}), 200

def error_response(message="An error occurred", status_code=400):
    return jsonify({"message": message}), status_code

def not_found_response(message="Resource not found"):
    return jsonify({"message": message}), 404

def validation_error_response(errors):
    return jsonify({"message": "Validation errors", "errors": errors}), 422
</file>

<file path="apps/api/src/api/routes.py">
def register_routes(app):
    """Register API routes. No legacy route blueprints are registered for SMD."""
    return
</file>

<file path="apps/api/src/api/schemas/...  # Marshmallow schemas">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/api/schemas/academic_year_schema.py">
from marshmallow import Schema, fields

class AcademicYearSchema(Schema):
    id = fields.Int(dump_only=True)
    code = fields.Str(required=True)
    start_date = fields.Date(required=True)
    end_date = fields.Date(required=True)
</file>

<file path="apps/api/src/api/schemas/assessment_clo_mapping_schema.py">
from marshmallow import Schema, fields

class AssessmentCloMappingSchema(Schema):
    assessment_component_id = fields.Int(required=True)
    syllabus_clo_id = fields.Int(required=True)
</file>

<file path="apps/api/src/api/schemas/assessment_component_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import Range

class AssessmentComponentSchema(Schema):
    id = fields.Int(dump_only=True)
    scheme_id = fields.Int(required=True)
    name = fields.Str(required=True)
    weight = fields.Float(required=True, validate=Range(min=0, max=100))
    rubrics = fields.List(fields.Nested('RubricSchema'), dump_only=True)
</file>

<file path="apps/api/src/api/schemas/assessment_scheme_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import Range

class AssessmentSchemeSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    name = fields.Str(required=True)
    weight = fields.Float(required=True, validate=Range(min=0, max=100))
    components = fields.List(fields.Nested('AssessmentComponentSchema'), dump_only=True)
</file>

<file path="apps/api/src/api/schemas/base_schema.py">
from marshmallow import Schema, post_dump
import re

def snake_to_camel(s: str) -> str:
    parts = s.split('_')
    return parts[0] + ''.join(p.capitalize() for p in parts[1:])

def _convert(obj):
    if isinstance(obj, dict):
        new = {}
        for k, v in obj.items():
            nk = snake_to_camel(k)
            new[nk] = _convert(v)
        return new
    elif isinstance(obj, list):
        return [_convert(x) for x in obj]
    else:
        return obj

class BaseSchema(Schema):
    @post_dump
    def to_camel(self, data, many=False, **kwargs):
        # marshmallow may or may not pass `many`; accept it optionally
        if many and isinstance(data, list):
            return [_convert(x) for x in data]
        return _convert(data)
</file>

<file path="apps/api/src/api/schemas/clo_plo_mapping_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import OneOf

class CloPloMappingSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_clo_id = fields.Int(required=True)
    program_plo_id = fields.Int(required=True)
    level = fields.Str(required=True, validate=OneOf(['I', 'R', 'M', 'A']))
</file>

<file path="apps/api/src/api/schemas/department_schema.py">
from marshmallow import Schema, fields

class DepartmentSchema(Schema):
    id = fields.Int(dump_only=True)
    faculty_id = fields.Int(required=True)
    code = fields.Str(required=True)
    name = fields.Str(required=True)
</file>

<file path="apps/api/src/api/schemas/faculty_schema.py">
from marshmallow import Schema, fields

class FacultySchema(Schema):
    id = fields.Int(dump_only=True)
    code = fields.Str(required=True)
    name = fields.Str(required=True)
    # Optional fields example: use load_default for Marshmallow
    description = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/file_schema.py">
from marshmallow import Schema, fields

class FileSchema(Schema):
    id = fields.Int(dump_only=True)
    uploader_id = fields.Int(dump_only=True)
    file_name = fields.Str(dump_only=True)
    file_path = fields.Str(dump_only=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/notification_schema.py">
from marshmallow import Schema, fields

class NotificationSchema(Schema):
    id = fields.Int(dump_only=True)
    user_id = fields.Int(required=True)
    title = fields.Str(required=True)
    message = fields.Str(load_default=None)
    link = fields.Str(load_default=None)
    is_read = fields.Bool(dump_only=True)
    type = fields.Str(load_default='SYSTEM')
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/program_outcome_schema.py">
from marshmallow import Schema, fields

class ProgramOutcomeSchema(Schema):
    id = fields.Int(dump_only=True)
    program_id = fields.Int(required=True)
    code = fields.Str(required=True)
    description = fields.Str(required=True)
</file>

<file path="apps/api/src/api/schemas/program_schema.py">
from marshmallow import Schema, fields

class ProgramSchema(Schema):
    id = fields.Int(dump_only=True)
    department_id = fields.Int(required=True)
    name = fields.Str(required=True)
    total_credits = fields.Int(load_default=0)
</file>

<file path="apps/api/src/api/schemas/role_schema.py">
from marshmallow import Schema, fields

class RoleSchema(Schema):
    id = fields.Int(dump_only=True)
    name = fields.Str(required=True)
    description = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/rubric_schema.py">
from marshmallow import Schema, fields

class RubricSchema(Schema):
    id = fields.Int(dump_only=True)
    component_id = fields.Int(required=True)
    criteria = fields.Str(required=True)
    max_score = fields.Float(required=True)
    description_level_pass = fields.Str(load_default=None)
    description_level_fail = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/student_schema.py">
from marshmallow import Schema, fields

class StudentSubscriptionSchema(Schema):
    id = fields.Int(dump_only=True)
    student_id = fields.Int(required=True)
    subject_id = fields.Int(required=True)
    created_at = fields.DateTime(dump_only=True)

class StudentReportSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    student_id = fields.Int(required=True)
    content = fields.Str(required=True)
    status = fields.Str(dump_only=True)
    admin_note = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/subject_relationship_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import OneOf

class SubjectRelationshipSchema(Schema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    related_subject_id = fields.Int(required=True)
    type = fields.Str(required=True, validate=OneOf(['PREREQUISITE', 'COREQUISITE', 'PARALLEL']))
</file>

<file path="apps/api/src/api/schemas/subject_schema.py">
# from marshmallow import Schema, fields

# class SubjectSchema(Schema):
#     id = fields.Int(dump_only=True)
#     department_id = fields.Int(required=True)
#     code = fields.Str(required=True)
#     name_vi = fields.Str(required=True)
#     name_en = fields.Str(required=True)
#     credits = fields.Int(required=True)
#     credit_theory = fields.Float(missing=0)
#     credit_practice = fields.Float(missing=0)
#     credit_self_study = fields.Float(missing=0)
from marshmallow import Schema, fields

class SubjectSchema(Schema):
    id = fields.Int(dump_only=True)
    department_id = fields.Int(required=True)
    code = fields.Str(required=True)
    name_vi = fields.Str(required=True)
    name_en = fields.Str(required=True)
    credits = fields.Int(required=True)
    # Sa missing=0 thnh load_default=0
    credit_theory = fields.Float(load_default=0)
    credit_practice = fields.Float(load_default=0)
    credit_self_study = fields.Float(load_default=0)
</file>

<file path="apps/api/src/api/schemas/syllabus_clo_schema.py">
from marshmallow import Schema, fields

class SyllabusCloSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    code = fields.Str(required=True)
    description = fields.Str(required=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/syllabus_comment_schema.py">
from marshmallow import Schema, fields

class SyllabusCommentSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    user_id = fields.Int(required=True)
    content = fields.Str(required=True)
    parent_id = fields.Int(load_default=None)
    is_resolved = fields.Bool(dump_only=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/syllabus_detail_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class SyllabusDetailSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    program_id = fields.Int(required=True)
    academic_year_id = fields.Int(required=True)
    lecturer_id = fields.Int(required=True)

    status = fields.Str(dump_only=True)
    version = fields.Str(dump_default="1.0")
    time_allocation = fields.Str(load_default=None)
    prerequisites = fields.Str(load_default=None)
    publish_date = fields.DateTime(load_default=None)

    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)

    clos = fields.List(fields.Nested('SyllabusCloSchema'), dump_only=True)
    materials = fields.List(fields.Nested('SyllabusMaterialSchema'), dump_only=True)
    teaching_plans = fields.List(fields.Nested('TeachingPlanSchema'), dump_only=True)
    assessment_schemes = fields.List(fields.Nested('AssessmentSchemeSchema'), dump_only=True)
</file>

<file path="apps/api/src/api/schemas/syllabus_material_schema.py">
from marshmallow import Schema, fields

class SyllabusMaterialSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    type = fields.Str(required=True)
    title = fields.Str(required=True)
    author = fields.Str(load_default=None)
    publisher = fields.Str(load_default=None)
    isbn = fields.Str(load_default=None)
    url = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/syllabus_schema.py">
import json
from marshmallow import fields, post_dump
from marshmallow.validate import Length
from .base_schema import BaseSchema

class SyllabusSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    program_id = fields.Int(required=True)
    academic_year_id = fields.Int(required=True)
    lecturer_id = fields.Int(required=True)

    status = fields.Str(dump_only=True)
    version = fields.Str(load_default="1.0", validate=Length(max=10))
    
    # FIX: time_allocation as Dict -> Use Raw to accept DB-stored JSON string
    time_allocation = fields.Raw(allow_none=True)  # Changed from Dict to Raw to handle DB String
    prerequisites = fields.Str(load_default=None)
    publish_date = fields.DateTime(load_default=None)

    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)

    # FIX: Add nested fields for input (load_default=[])
    clos = fields.List(fields.Nested('SyllabusCloSchema'), load_default=[])
    materials = fields.List(fields.Nested('SyllabusMaterialSchema'), load_default=[])
    teaching_plans = fields.List(fields.Nested('TeachingPlanSchema'), load_default=[])
    assessment_schemes = fields.List(fields.Nested('AssessmentSchemeSchema'), load_default=[])

    @post_dump
    def parse_json(self, data, **kwargs):
        if 'timeAllocation' in data and isinstance(data['timeAllocation'], str):
            try:
                data['timeAllocation'] = json.loads(data['timeAllocation'])
            except:
                pass
        return data
</file>

<file path="apps/api/src/api/schemas/system_setting_schema.py">
from marshmallow import Schema, fields

class SystemSettingSchema(Schema):
    key = fields.Str(required=True)
    value = fields.Str(required=True)
    type = fields.Str(dump_only=True)
    description = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/teaching_plan_schema.py">
from marshmallow import Schema, fields

class TeachingPlanSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    week = fields.Int(required=True)
    topic = fields.Str(load_default=None)
    activity = fields.Str(load_default=None)
    assessment = fields.Str(load_default=None)
    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/user_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class UserSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    username = fields.Str(required=True)
    email = fields.Email(required=True)
    full_name = fields.Str(required=True)
    department_id = fields.Int(load_default=None)
    is_active = fields.Bool(load_default=True)
    password = fields.Str(load_only=True, required=True)
</file>

<file path="apps/api/src/api/schemas/user.py">

</file>

<file path="apps/api/src/api/schemas/workflow_log_schema.py">
from marshmallow import Schema, fields

class WorkflowLogSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    actor_id = fields.Int(required=True)
    action = fields.Str(required=True)
    from_status = fields.Str(load_default=None)
    to_status = fields.Str(load_default=None)
    comment = fields.Str(load_default=None)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/swagger.py">
from apispec import APISpec
from apispec.ext.marshmallow import MarshmallowPlugin
from apispec_webframeworks.flask import FlaskPlugin

spec = APISpec(
    title="Syllabus Management API",
    version="1.0.0",
    openapi_version="3.0.2",
    plugins=[FlaskPlugin(), MarshmallowPlugin()],
)

# (No legacy Todo schemas registered  SMD module schemas are registered via controllers/schemas)
</file>

<file path="apps/api/src/app_logging.py">
import logging

def setup_logging():
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler("app.log"),
            logging.StreamHandler()
        ]
    )

setup_logging()
</file>

<file path="apps/api/src/app.py">
from flask import Flask, jsonify
from api.swagger import spec
from api.middleware import middleware
from infrastructure.databases import init_db
from flasgger import Swagger
from flask_swagger_ui import get_swaggerui_blueprint
from cors import init_cors

# Dependency injection
from dependency_container import Container
from api.controllers.subject_controller import subject_bp
from api.controllers.faculty_controller import faculty_bp
from api.controllers.department_controller import department_bp
from api.controllers.role_controller import role_bp
from api.controllers.user_controller import user_bp
from api.controllers.academic_year_controller import academic_year_bp
from api.controllers.program_controller import program_bp
from api.controllers.syllabus_controller import syllabus_bp
from api.controllers.syllabus_clo_controller import syllabus_clo_bp
from api.controllers.syllabus_material_controller import syllabus_material_bp
from api.controllers.teaching_plan_controller import teaching_plan_bp
from api.controllers.assessment_scheme_controller import assessment_scheme_bp
from api.controllers.assessment_component_controller import assessment_component_bp
from api.controllers.rubric_controller import rubric_bp
from api.controllers.assessment_clo_controller import assessment_clo_bp
from api.controllers.auth_controller import auth_bp
from api.controllers.ai_controller import ai_bp
from api.controllers.dashboard_controller import dashboard_bp
from api.controllers.program_outcome_controller import program_outcome_bp
from api.controllers.file_controller import file_bp
from api.controllers.clo_plo_mapping_controller import clo_plo_mapping_bp
from api.controllers.subject_relationship_controller import subject_rel_bp
from api.controllers.syllabus_comment_controller import syllabus_comment_bp
from api.controllers.notification_controller import notification_bp
from api.controllers.system_setting_controller import system_setting_bp
from api.controllers.student_controller import student_bp


def create_app():
    app = Flask(__name__)

    # Initialize CORS early so Swagger and other blueprints respect it
    try:
        init_cors(app)
    except Exception:
        pass

    Swagger(app)

    # Initialize DI container and wire controllers
    container = Container()
    # Wire the container explicitly for controllers
    try:
        container.wire(modules=[
            "api.controllers.subject_controller",
            "api.controllers.faculty_controller",
            "api.controllers.department_controller",
            "api.controllers.role_controller",
            "api.controllers.user_controller",
            "api.controllers.academic_year_controller",
            "api.controllers.program_controller",
            "api.controllers.syllabus_controller",
            "api.controllers.syllabus_clo_controller",
            "api.controllers.syllabus_material_controller",
            "api.controllers.teaching_plan_controller",
            "api.controllers.assessment_scheme_controller",
            "api.controllers.assessment_component_controller",
            "api.controllers.rubric_controller",
            "api.controllers.assessment_clo_controller",
            "api.controllers.auth_controller",
            "api.controllers.ai_controller",
            "api.controllers.dashboard_controller",
            "api.controllers.program_outcome_controller",
            "api.controllers.file_controller",
            "api.controllers.clo_plo_mapping_controller",
            "api.controllers.subject_relationship_controller",
            "api.controllers.syllabus_comment_controller",
            "api.controllers.notification_controller",
            "api.controllers.system_setting_controller",
            "api.controllers.student_controller",
        ])
    except Exception:
        # best-effort wiring; if it fails here the app can still start
        pass

    # Register blueprints
    app.register_blueprint(subject_bp)
    app.register_blueprint(faculty_bp)
    app.register_blueprint(department_bp)
    app.register_blueprint(role_bp)
    app.register_blueprint(user_bp)
    app.register_blueprint(academic_year_bp)
    app.register_blueprint(program_bp)
    app.register_blueprint(syllabus_bp)
    app.register_blueprint(syllabus_clo_bp)
    app.register_blueprint(syllabus_material_bp)
    app.register_blueprint(teaching_plan_bp)
    app.register_blueprint(assessment_scheme_bp)
    app.register_blueprint(assessment_component_bp)
    app.register_blueprint(rubric_bp)
    app.register_blueprint(assessment_clo_bp)
    app.register_blueprint(auth_bp)
    app.register_blueprint(ai_bp)
    app.register_blueprint(dashboard_bp)
    app.register_blueprint(program_outcome_bp)
    app.register_blueprint(file_bp)
    app.register_blueprint(clo_plo_mapping_bp)
    app.register_blueprint(subject_rel_bp)
    app.register_blueprint(syllabus_comment_bp)
    app.register_blueprint(notification_bp)
    app.register_blueprint(system_setting_bp)
    app.register_blueprint(student_bp)

     # Thm Swagger UI blueprint
    SWAGGER_URL = '/docs'
    API_URL = '/swagger.json'
    swaggerui_blueprint = get_swaggerui_blueprint(
        SWAGGER_URL,
        API_URL,
        config={'app_name': "Syllabus Management API"}
    )
    app.register_blueprint(swaggerui_blueprint, url_prefix=SWAGGER_URL)

    try:
        init_db(app)
    except Exception as e:
        print(f"Error initializing database: {e}")

    # Register middleware
    middleware(app)

    # Initialize CORS
    try:
        init_cors(app)
    except Exception:
        pass

    # Register routes (add all non-static endpoints to Swagger where possible)
    with app.test_request_context():
        for rule in app.url_map.iter_rules():
            if rule.endpoint == 'static':
                continue
            view_func = app.view_functions.get(rule.endpoint)
            if not view_func:
                continue
            try:
                spec.path(view=view_func)
                print(f"Adding path: {rule.rule} -> {view_func}")
            except Exception:
                # some endpoints may not be compatible with flasgger, skip them
                pass

    @app.route("/swagger.json")
    def swagger_json():
        return jsonify(spec.to_dict())

    return app
# Run the application

if __name__ == '__main__':
    app = create_app()
    app.run(host='0.0.0.0', port=9999, debug=True)
</file>

<file path="apps/api/src/config.py">
# Configuration settings for the Flask application

import os
from dotenv import load_dotenv
load_dotenv()

class Config:
    """Base configuration."""
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'a_default_secret_key'
    DEBUG = os.environ.get('DEBUG', 'False').lower() in ['true', '1']
    TESTING = os.environ.get('TESTING', 'False').lower() in ['true', '1']
    
    DATABASE_URI = os.environ.get('DATABASE_URI') 
    CORS_HEADERS = 'Content-Type'

class DevelopmentConfig(Config):
    """Development configuration."""
    DEBUG = True
    DATABASE_URI = os.environ.get('DATABASE_URI') 


class TestingConfig(Config):
    """Testing configuration."""
    TESTING = True
    DATABASE_URI = os.environ.get('DATABASE_URI')


class ProductionConfig(Config):
    """Production configuration."""
    DATABASE_URI = os.environ.get('DATABASE_URI') 

    
template = {
    "swagger": "2.0",
    "info": {
        "title": "Syllabus Management API",
        "description": "API for Syllabus Management (SMD)",
        "version": "1.0.0"
    },
    "basePath": "/",
    "schemes": [
        "http",
        "https"
    ],
    "consumes": [
        "application/json"
    ],
    "produces": [
        "application/json"
    ]
}
class SwaggerConfig:
    """Swagger configuration."""
    template = {
        "swagger": "2.0",
        "info": {
            "title": "Syllabus Management API",
            "description": "API for Syllabus Management (SMD)",
            "version": "1.0.0"
        },
        "basePath": "/",
        "schemes": [
            "http",
            "https"
        ],
        "consumes": [
            "application/json"
        ],
        "produces": [
            "application/json"
        ]
    }

    swagger_config = {
        "headers": [],
        "specs": [
            {
                "endpoint": 'apispec',
                "route": '/apispec.json',
                "rule_filter": lambda rule: True,
                "model_filter": lambda tag: True,
            }
        ],
        "static_url_path": "/flasgger_static",
        "swagger_ui": True,
        "specs_route": "/docs"
    }
</file>

<file path="apps/api/src/cors.py">
from flask_cors import CORS

def init_cors(app):
    # Restrict origins to the frontend (Next.js dev host) and allow Authorization header
    CORS(app, resources={
        r"/*": {
            "origins": ["http://localhost:3000"],
            "allow_headers": ["Authorization", "Content-Type"],
            "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
        }
    }, supports_credentials=True)
    app.config.setdefault('CORS_HEADERS', 'Content-Type')
    return app
</file>

<file path="apps/api/src/create_app.py">
from flask import Flask
from .config import Config
from .api.middleware import setup_middleware
from .api.routes import register_routes
from .infrastructure.databases import init_db
from .app_logging import setup_logging

def create_app():
    app = Flask(__name__)
    app.config.from_object(Config)

    setup_logging(app)
    init_db(app)
    setup_middleware(app)
    register_routes(app)

    return app
</file>

<file path="apps/api/src/dependency_container.py">
# Dependency Injection Container

from dependency_injector import containers, providers
from infrastructure.databases.mssql import session

from infrastructure.repositories.subject_repository import SubjectRepository
from services.subject_service import SubjectService
from infrastructure.repositories.faculty_repository import FacultyRepository
from services.faculty_service import FacultyService
from infrastructure.repositories.department_repository import DepartmentRepository
from services.department_service import DepartmentService
from infrastructure.repositories.role_repository import RoleRepository
from services.role_service import RoleService
from infrastructure.repositories.user_repository import UserRepository
from services.user_service import UserService
from infrastructure.repositories.academic_year_repository import AcademicYearRepository
from services.academic_year_service import AcademicYearService
from infrastructure.repositories.program_repository import ProgramRepository
from services.program_service import ProgramService
from infrastructure.repositories.syllabus_repository import SyllabusRepository
from services.syllabus_service import SyllabusService
from infrastructure.repositories.syllabus_clo_repository import SyllabusCloRepository
from services.syllabus_clo_service import SyllabusCloService
from infrastructure.repositories.syllabus_material_repository import SyllabusMaterialRepository
from services.syllabus_material_service import SyllabusMaterialService
from infrastructure.repositories.teaching_plan_repository import TeachingPlanRepository
from services.teaching_plan_service import TeachingPlanService
from infrastructure.repositories.assessment_scheme_repository import AssessmentSchemeRepository
from services.assessment_scheme_service import AssessmentSchemeService
from infrastructure.repositories.assessment_component_repository import AssessmentComponentRepository
from services.assessment_component_service import AssessmentComponentService
from infrastructure.repositories.rubric_repository import RubricRepository
from services.rubric_service import RubricService
from infrastructure.repositories.assessment_clo_repository import AssessmentCloRepository
from services.assessment_clo_service import AssessmentCloService
from infrastructure.repositories.workflow_log_repository import WorkflowLogRepository

# NEW: Program Outcome, File Management, Mappings, Relationships, Comments, Notifications, System Settings, AI Audit
from infrastructure.repositories.program_outcome_repository import ProgramOutcomeRepository
from services.program_outcome_service import ProgramOutcomeService
from infrastructure.repositories.file_repository import FileRepository
from services.file_service import FileService
from infrastructure.repositories.clo_plo_mapping_repository import CloPloMappingRepository
from services.clo_plo_mapping_service import CloPloMappingService
from infrastructure.repositories.subject_relationship_repository import SubjectRelationshipRepository
from services.subject_relationship_service import SubjectRelationshipService
from infrastructure.repositories.syllabus_comment_repository import SyllabusCommentRepository
from services.syllabus_comment_service import SyllabusCommentService
from infrastructure.repositories.notification_repository import NotificationRepository
from services.notification_service import NotificationService
from infrastructure.repositories.system_setting_repository import SystemSettingRepository
from infrastructure.repositories.ai_auditlog_repository import AiAuditLogRepository
from infrastructure.repositories.notification_repository import NotificationRepository
from infrastructure.repositories.student_subscription_repository import StudentSubscriptionRepository
from infrastructure.repositories.student_report_repository import StudentReportRepository
from services.system_setting_service import SystemSettingService
from services.student_service import StudentService

class Container(containers.DeclarativeContainer):
    """Dependency Injection Container for SMD services."""

    wiring_config = containers.WiringConfiguration(modules=[
        "api.controllers.subject_controller",
        "api.controllers.faculty_controller",
        "api.controllers.department_controller",
        "api.controllers.role_controller",
        "api.controllers.user_controller",
        "api.controllers.academic_year_controller",
        "api.controllers.program_controller",
        "api.controllers.syllabus_controller",
        "api.controllers.syllabus_clo_controller",
        "api.controllers.syllabus_material_controller",
        "api.controllers.teaching_plan_controller",
        "api.controllers.assessment_scheme_controller",
        "api.controllers.assessment_component_controller",
        "api.controllers.rubric_controller",
        "api.controllers.assessment_clo_controller",
        "api.controllers.auth_controller",
        "api.controllers.ai_controller",
        "api.controllers.dashboard_controller",
        "api.controllers.program_outcome_controller",
        "api.controllers.file_controller",
        "api.controllers.clo_plo_mapping_controller",
        "api.controllers.subject_relationship_controller",
        "api.controllers.syllabus_comment_controller",
        "api.controllers.notification_controller",
        "api.controllers.system_setting_controller",
        "api.controllers.student_controller",
    ])

    # Provide a session object (singleton)
    db_session = providers.Object(session)

    # Repositories
    subject_repository = providers.Factory(
        SubjectRepository,
        session=db_session
    )

    faculty_repository = providers.Factory(
        FacultyRepository,
        session=db_session
    )

    department_repository = providers.Factory(
        DepartmentRepository,
        session=db_session
    )

    academic_year_repository = providers.Factory(
        AcademicYearRepository,
        session=db_session
    )

    program_repository = providers.Factory(
        ProgramRepository,
        session=db_session
    )

    role_repository = providers.Factory(
        RoleRepository,
        session=db_session
    )

    user_repository = providers.Factory(
        UserRepository,
        session=db_session
    )
    # Services
    subject_service = providers.Factory(
        SubjectService,
        repository=subject_repository
    )

    faculty_service = providers.Factory(
        FacultyService,
        repository=faculty_repository
    )

    department_service = providers.Factory(
        DepartmentService,
        repository=department_repository
    )

    syllabus_repository = providers.Factory(
        SyllabusRepository,
        session=db_session
    )

    syllabus_clo_repository = providers.Factory(
        SyllabusCloRepository,
        session=db_session
    )

    syllabus_material_repository = providers.Factory(
        SyllabusMaterialRepository,
        session=db_session
    )

    teaching_plan_repository = providers.Factory(
        TeachingPlanRepository,
        session=db_session
    )

    assessment_scheme_repository = providers.Factory(
        AssessmentSchemeRepository,
        session=db_session
    )

    assessment_component_repository = providers.Factory(
        AssessmentComponentRepository,
        session=db_session
    )

    rubric_repository = providers.Factory(
        RubricRepository,
        session=db_session
    )

    assessment_clo_repository = providers.Factory(
        AssessmentCloRepository,
        session=db_session
    )

    workflow_log_repository = providers.Factory(
        WorkflowLogRepository,
        session=db_session
    )

    # NEW REPOSITORIES
    program_outcome_repository = providers.Factory(
        ProgramOutcomeRepository,
        session=db_session
    )
    
    file_repository = providers.Factory(
        FileRepository,
        session=db_session
    )

    clo_plo_mapping_repository = providers.Factory(
        CloPloMappingRepository,
        session=db_session
    )

    subject_relationship_repository = providers.Factory(
        SubjectRelationshipRepository,
        session=db_session
    )

    syllabus_comment_repository = providers.Factory(
        SyllabusCommentRepository,
        session=db_session
    )

    notification_repository = providers.Factory(
        NotificationRepository,
        session=db_session
    )

    system_setting_repository = providers.Factory(
        SystemSettingRepository,
        session=db_session
    )

    student_subscription_repository = providers.Factory(
        StudentSubscriptionRepository,
        session=db_session
    )

    student_report_repository = providers.Factory(
        StudentReportRepository,
        session=db_session
    )

    ai_auditlog_repository = providers.Factory(
        AiAuditLogRepository,
        session=db_session
    )

    academic_year_service = providers.Factory(
        AcademicYearService,
        repository=academic_year_repository
    )

    program_service = providers.Factory(
        ProgramService,
        repository=program_repository
    )

    syllabus_service = providers.Factory(
        SyllabusService,
        repository=syllabus_repository,
        subject_repository=subject_repository,
        program_repository=program_repository,
        academic_year_repository=academic_year_repository,
        user_repository=user_repository,
        workflow_log_repository=workflow_log_repository,
        # NEW INJECTIONS:
        syllabus_clo_repository=syllabus_clo_repository,
        syllabus_material_repository=syllabus_material_repository,
        teaching_plan_repository=teaching_plan_repository,
        assessment_scheme_repository=assessment_scheme_repository,
        assessment_component_repository=assessment_component_repository,
        rubric_repository=rubric_repository,
        assessment_clo_repository=assessment_clo_repository
    )

    syllabus_clo_service = providers.Factory(
        SyllabusCloService,
        repository=syllabus_clo_repository,
        syllabus_repository=syllabus_repository
    )

    syllabus_material_service = providers.Factory(
        SyllabusMaterialService,
        repository=syllabus_material_repository,
        syllabus_repository=syllabus_repository
    )

    teaching_plan_service = providers.Factory(
        TeachingPlanService,
        repository=teaching_plan_repository,
        syllabus_repository=syllabus_repository
    )

    assessment_scheme_service = providers.Factory(
        AssessmentSchemeService,
        repository=assessment_scheme_repository,
        syllabus_repository=syllabus_repository
    )

    assessment_component_service = providers.Factory(
        AssessmentComponentService,
        repository=assessment_component_repository,
        scheme_repository=assessment_scheme_repository
    )

    rubric_service = providers.Factory(
        RubricService,
        repository=rubric_repository,
        component_repository=assessment_component_repository
    )

    assessment_clo_service = providers.Factory(
        AssessmentCloService,
        repository=assessment_clo_repository,
        component_repository=assessment_component_repository,
        syllabus_clo_repository=syllabus_clo_repository,
        assessment_scheme_repository=assessment_scheme_repository
    )
  

    # NEW SERVICES
    program_outcome_service = providers.Factory(
        ProgramOutcomeService,
        repository=program_outcome_repository,
        program_repository=program_repository
    )

    file_service = providers.Factory(
        FileService,
        repository=file_repository
    )

    clo_plo_mapping_service = providers.Factory(
        CloPloMappingService,
        repository=clo_plo_mapping_repository,
        syllabus_clo_repository=syllabus_clo_repository,
        program_outcome_repository=program_outcome_repository
    )

    subject_relationship_service = providers.Factory(
        SubjectRelationshipService,
        repository=subject_relationship_repository,
        subject_repository=subject_repository
    )

    syllabus_comment_service = providers.Factory(
        SyllabusCommentService,
        repository=syllabus_comment_repository,
        syllabus_repository=syllabus_repository,
        user_repository=user_repository
    )

    notification_service = providers.Factory(
        NotificationService,
        repository=notification_repository,
        user_repository=user_repository
    )

    system_setting_service = providers.Factory(
        SystemSettingService,
        repository=system_setting_repository
    )

    student_service = providers.Factory(
        StudentService, 
        sub_repo=student_subscription_repository,
        report_repo=student_report_repository
    )

    # AI Service (inject audit repository)
    from services.ai_service import AiService
    ai_service = providers.Factory(
        AiService,
        audit_repository=ai_auditlog_repository
    )

    role_service = providers.Factory(
        RoleService,
        repository=role_repository
    )

    user_service = providers.Factory(
        UserService,
        repository=user_repository
    )

    # AI Service
    from services.ai_service import AiService
    ai_service = providers.Factory(
        AiService
    )
</file>

<file path="apps/api/src/domain/constants.py">
# Constants

# Define any constants used throughout the application here. 
# For example, you might define API version, error messages, or configuration keys.

API_VERSION = "v1"
DEFAULT_PAGE_SIZE = 20
MAX_PAGE_SIZE = 100

# Add more constants as needed for your application.
</file>

<file path="apps/api/src/domain/exceptions.py">
class CustomException(Exception):
    """Base class for all custom exceptions in the application."""
    pass

class NotFoundException(CustomException):
    """Exception raised when a resource is not found."""
    def __init__(self, message="Resource not found"):
        self.message = message
        super().__init__(self.message)

class ValidationException(CustomException):
    """Exception raised for validation errors."""
    def __init__(self, message="Validation error"):
        self.message = message
        super().__init__(self.message)

class UnauthorizedException(CustomException):
    """Exception raised for unauthorized access."""
    def __init__(self, message="Unauthorized access"):
        self.message = message
        super().__init__(self.message)

class ConflictException(CustomException):
    """Exception raised for conflicts in the application."""
    def __init__(self, message="Conflict occurred"):
        self.message = message
        super().__init__(self.message)
</file>

<file path="apps/api/src/domain/models/...  # Business logic models">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/domain/models/user.py">
from sqlalchemy import Column, Integer, String, DateTime, Boolean
from infrastructure.databases.base import Base

class User:
    
    def __innit__(self, user_name: str, password: str, description: str = None, status: bool = True):
        self.user_name = user_name
        self.password = password
        self.description = description
        self.status = status
        self.created_at = None
        self.updated_at = None
</file>

<file path="apps/api/src/error_handler.py">
# Error handling logic for the Flask application

from flask import jsonify

class CustomError(Exception):
    status_code = 400

    def __init__(self, message, status_code=None):
        super().__init__(message)
        if status_code is not None:
            self.status_code = status_code
        self.message = message

    def to_dict(self):
        return {'message': self.message}

def handle_error(error):
    if isinstance(error, CustomError):
        response = jsonify(error.to_dict())
        response.status_code = error.status_code
        return response

    response = jsonify({'message': 'An unexpected error occurred.'})
    response.status_code = 500
    return response

def register_error_handlers(app):
    app.register_error_handler(Exception, handle_error)
</file>

<file path="apps/api/src/infrastructure/databases/__init__.py">
from infrastructure.databases.mssql import init_mssql
from infrastructure.models import (
    academic_year_model,
    ai_auditlog_model,
    assessment_clo_model,
    assessment_component_model,
    assessment_scheme_model,
    clo_plo_mapping_model,
    department_model,
    faculty_model,
    file_model,
    notification_model,
    notification_template_model,
    program_model,
    program_outcome_model,
    role_model,
    rubric_model,
    student_report_model,
    student_subscription_model,
    subject_model,
    subject_relationship_model,
    syllabus_clo_model,
    syllabus_comment_model,
    syllabus_current_workflow,
    syllabus_material_model,
    syllabus_model,
    system_auditlog_model,
    system_setting_model,
    teaching_plan_model,
    user_model,
    user_role_model,
    workflow_log_model,
    workflow_state_model,
    workflow_transition_model
)

def init_db(app):
    init_mssql(app)

# Migration Entities -> tables
from infrastructure.databases.mssql import Base
</file>

<file path="apps/api/src/infrastructure/databases/base.py">
from sqlalchemy.orm import declarative_base

Base = declarative_base()


# ORM: object relational mapping base class
# OOP : object oriented programming

# ERD --> class relational
# Lp trinhf hng i tng (logic) mapping class -> table (database)
</file>

<file path="apps/api/src/infrastructure/databases/mssql.py">
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from config import Config
from infrastructure.databases.base import Base

# Database configuration
DATABASE_URI = Config.DATABASE_URI
engine = create_engine(DATABASE_URI)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
session = SessionLocal()
def init_mssql(app):
    Base.metadata.create_all(bind=engine)
</file>

<file path="apps/api/src/infrastructure/databases/mysql.py">

</file>

<file path="apps/api/src/infrastructure/models/__init__.py">
from .user_model import User
from .user_role_model import UserRole
from .role_model import Role
from .faculty_model import Faculty
from .department_model import Department
from .program_model import Program
from .program_outcome_model import ProgramOutcome
from .subject_model import Subject
from .academic_year_model import AcademicYear
from .syllabus_model import Syllabus
from .syllabus_clo_model import SyllabusClo
from .syllabus_material_model import SyllabusMaterial
from .teaching_plan_model import TeachingPlan
from .assessment_scheme_model import AssessmentScheme
from .assessment_component_model import AssessmentComponent
from .rubric_model import Rubric
from .clo_plo_mapping_model import CloPloMapping
from .assessment_clo_model import AssessmentClo
from .subject_relationship_model import SubjectRelationship
from .system_setting_model import SystemSetting
from .student_subscription_model import StudentSubscription
from .student_report_model import StudentReport
from .notification_model import Notification
from .syllabus_comment_model import SyllabusComment
from .workflow_log_model import WorkflowLog
from .workflow_state_model import WorkflowState
from .workflow_transition_model import WorkflowTransition
from .syllabus_current_workflow import SyllabusCurrentWorkflow
from .ai_auditlog_model import AiAuditLog

__all__ = [
    "User", "UserRole", "Role", "Faculty", "Department", "Program",
    "ProgramOutcome", "Subject", "AcademicYear", "Syllabus", "SyllabusClo",
    "SyllabusMaterial", "TeachingPlan", "AssessmentScheme", "AssessmentComponent", "Rubric",
    "CloPloMapping", "AssessmentClo", "SubjectRelationship", "SystemSetting",
    "StudentSubscription", "StudentReport", "Notification", "SyllabusComment",
    "WorkflowLog", "WorkflowState", "WorkflowTransition", "SyllabusCurrentWorkflow",
    "AiAuditLog"
]
</file>

<file path="apps/api/src/infrastructure/models/academic_year_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AcademicYear(Base):
    __tablename__ = 'academic_years'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(20), unique=True)
    start_date = Column(Date)
    end_date = Column(Date)
    
    # Relationships
    syllabuses = relationship("Syllabus", back_populates="academic_year")
</file>

<file path="apps/api/src/infrastructure/models/ai_auditlog_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AiAuditLog(Base):
    __tablename__ = 'ai_audit_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    action = Column(NVARCHAR(50))  # GENERATE, COMPARE_DIFF, SUMMARIZE
    input_tokens = Column(Integer)
    output_tokens = Column(Integer)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="ai_audit_logs")
</file>

<file path="apps/api/src/infrastructure/models/assessment_clo_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentClo(Base):
    __tablename__ = 'assessment_clos'
    
    assessment_component_id = Column(BigInteger, ForeignKey('assessment_components.id'), primary_key=True)
    syllabus_clo_id = Column(BigInteger, ForeignKey('syllabus_clos.id'), primary_key=True)
    
    # Relationships
    component = relationship("AssessmentComponent", back_populates="clos")
    syllabus_clo = relationship("SyllabusClo", back_populates="assessment_clos")
</file>

<file path="apps/api/src/infrastructure/models/assessment_component_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentComponent(Base):
    __tablename__ = 'assessment_components'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    scheme_id = Column(BigInteger, ForeignKey('assessment_schemes.id'), nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    weight = Column(DECIMAL(3, 1), nullable=False)
    
    # Relationships
    scheme = relationship("AssessmentScheme", back_populates="components")
    clos = relationship("AssessmentClo", back_populates="component")
    rubrics = relationship("Rubric", back_populates="component", cascade="all, delete-orphan")
</file>

<file path="apps/api/src/infrastructure/models/assessment_scheme_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentScheme(Base):
    __tablename__ = 'assessment_schemes'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    name = Column(NVARCHAR(100))
    weight = Column(DECIMAL(3, 1))
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="assessment_schemes")
    components = relationship("AssessmentComponent", back_populates="scheme", cascade="all, delete-orphan")
</file>

<file path="apps/api/src/infrastructure/models/clo_plo_mapping_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class CloPloMapping(Base):
    __tablename__ = 'clo_plo_mappings'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_clo_id = Column(BigInteger, ForeignKey('syllabus_clos.id', ondelete='CASCADE'), nullable=False)
    program_plo_id = Column(BigInteger, ForeignKey('program_outcomes.id'), nullable=False)
    level = Column(NVARCHAR(1))  # I, R, M, A
    
    __table_args__ = (
        CheckConstraint("level IN ('I', 'R', 'M', 'A')", name='check_level'),
    )
    
    # Relationships
    syllabus_clo = relationship("SyllabusClo", back_populates="plo_mappings")
    program_plo = relationship("ProgramOutcome", back_populates="clo_mappings")
</file>

<file path="apps/api/src/infrastructure/models/department_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Department(Base):
    __tablename__ = 'departments'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    faculty_id = Column(BigInteger, ForeignKey('faculties.id'), nullable=False)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    
    # Relationships
    faculty = relationship("Faculty", back_populates="departments")
    users = relationship("User", back_populates="department")
    subjects = relationship("Subject", back_populates="department")
    programs = relationship("Program", back_populates="department")
</file>

<file path="apps/api/src/infrastructure/models/faculty_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base


class Faculty(Base):
    __tablename__ = 'faculties'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    
    # Relationships
    departments = relationship("Department", back_populates="faculty")
</file>

<file path="apps/api/src/infrastructure/models/file_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
# IMPORT BASE CHUNG (QUAN TRNG)
from infrastructure.databases.base import Base

class File(Base):
    __tablename__ = 'files'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    uploader_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    file_name = Column(NVARCHAR(255), nullable=False)
    file_path = Column(NVARCHAR(500), nullable=False)
    file_size = Column(BigInteger)
    mime_type = Column(NVARCHAR(100))
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    uploader = relationship("User", back_populates="uploaded_files", foreign_keys=[uploader_id])
</file>

<file path="apps/api/src/infrastructure/models/notification_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Notification(Base):
    __tablename__ = 'notifications'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    title = Column(NVARCHAR(255), nullable=False)
    message = Column(UnicodeText)
    link = Column(NVARCHAR(500))
    is_read = Column(Boolean, default=False)
    type = Column(NVARCHAR(50))  # SYSTEM, REVIEW, REMINDER
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    user = relationship("User", back_populates="notifications")
</file>

<file path="apps/api/src/infrastructure/models/notification_template_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class NotificationTemplate(Base):
    __tablename__ = 'notification_templates'
    
    code = Column(NVARCHAR(50), primary_key=True)
    title_template = Column(NVARCHAR(255), nullable=False)
    body_template = Column(UnicodeText, nullable=False)
    channel = Column(NVARCHAR(20), default='SYSTEM')  # EMAIL, SMS, SYSTEM
</file>

<file path="apps/api/src/infrastructure/models/program_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Program(Base):
    __tablename__ = 'programs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    total_credits = Column(Integer)
    
    # Relationships
    department = relationship("Department", back_populates="programs")
    outcomes = relationship("ProgramOutcome", back_populates="program")
    syllabuses = relationship("Syllabus", back_populates="program")
</file>

<file path="apps/api/src/infrastructure/models/program_outcome_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class ProgramOutcome(Base):
    __tablename__ = 'program_outcomes'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    program_id = Column(BigInteger, ForeignKey('programs.id'), nullable=False)
    code = Column(NVARCHAR(20))
    description = Column(UnicodeText)
    
    # Relationships
    program = relationship("Program", back_populates="outcomes")
    clo_mappings = relationship("CloPloMapping", back_populates="program_plo")
</file>

<file path="apps/api/src/infrastructure/models/role_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Role(Base):
    __tablename__ = 'roles'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    name = Column(NVARCHAR(50), unique=True, nullable=False)
    description = Column(NVARCHAR(255), nullable=True)
    
    # Relationships
    user_roles = relationship("UserRole", back_populates="role")
    workflow_transitions = relationship("WorkflowTransition", back_populates="allowed_role")
</file>

<file path="apps/api/src/infrastructure/models/rubric_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Rubric(Base):
    __tablename__ = 'rubrics'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    component_id = Column(BigInteger, ForeignKey('assessment_components.id', ondelete='CASCADE'), nullable=False)
    criteria = Column(UnicodeText, nullable=False)
    max_score = Column(DECIMAL(3, 1), nullable=False)
    description_level_pass = Column(UnicodeText)
    description_level_fail = Column(UnicodeText)
    
    # Relationships
    component = relationship("AssessmentComponent", back_populates="rubrics")
</file>

<file path="apps/api/src/infrastructure/models/student_report_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class StudentReport(Base):
    __tablename__ = 'student_reports'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    student_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    content = Column(UnicodeText, nullable=False)
    status = Column(NVARCHAR(20), default='PENDING')  # PENDING, RESOLVED, REJECTED
    admin_note = Column(UnicodeText)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="student_reports")
    student = relationship("User")
</file>

<file path="apps/api/src/infrastructure/models/student_subscription_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class StudentSubscription(Base):
    __tablename__ = 'student_subscriptions'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    student_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    student = relationship("User")
    subject = relationship("Subject", back_populates="student_subscriptions")
</file>

<file path="apps/api/src/infrastructure/models/subject_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Subject(Base):
    __tablename__ = 'subjects'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=False)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name_vi = Column(NVARCHAR(255), nullable=False)
    name_en = Column(NVARCHAR(255), nullable=False)
    credits = Column(Integer, nullable=False)
    credit_theory = Column(DECIMAL(3, 1), default=0)
    credit_practice = Column(DECIMAL(3, 1), default=0)
    credit_self_study = Column(DECIMAL(3, 1), default=0)
    
    # Relationships
    department = relationship("Department", back_populates="subjects")
    syllabuses = relationship("Syllabus", back_populates="subject")
    subject_relationships = relationship("SubjectRelationship", 
                                        foreign_keys="SubjectRelationship.subject_id",
                                        back_populates="subject")
    related_subjects = relationship("SubjectRelationship",
                                   foreign_keys="SubjectRelationship.related_subject_id",
                                   back_populates="related_subject")
    student_subscriptions = relationship("StudentSubscription", back_populates="subject")
</file>

<file path="apps/api/src/infrastructure/models/subject_relationship_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SubjectRelationship(Base):
    __tablename__ = 'subject_relationships'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    related_subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    type = Column(NVARCHAR(20), nullable=False)  # PREREQUISITE, COREQUISITE, PARALLEL
    
    # Relationships
    subject = relationship("Subject", foreign_keys=[subject_id], back_populates="subject_relationships")
    related_subject = relationship("Subject", foreign_keys=[related_subject_id], back_populates="related_subjects")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_clo_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusClo(Base):
    __tablename__ = 'syllabus_clos'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    code = Column(NVARCHAR(20), nullable=False)
    description = Column(UnicodeText, nullable=False)
    embedding_vector = Column(UnicodeText, nullable=True)  # JSON vector
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="clos")
    plo_mappings = relationship("CloPloMapping", back_populates="syllabus_clo", cascade="all, delete-orphan")
    assessment_clos = relationship("AssessmentClo", back_populates="syllabus_clo")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_comment_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusComment(Base):
    __tablename__ = 'syllabus_comments'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    content = Column(UnicodeText, nullable=False)
    parent_id = Column(BigInteger, ForeignKey('syllabus_comments.id'), nullable=True)
    is_resolved = Column(Boolean, default=False)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="comments")
    user = relationship("User", back_populates="comments")
    parent = relationship("SyllabusComment", remote_side=[id], backref="replies")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_current_workflow.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusCurrentWorkflow(Base):
    __tablename__ = 'syllabus_current_workflows'
    
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), primary_key=True)
    current_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    assigned_to_user_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    due_date = Column(DateTime, nullable=True)
    updated_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="current_workflow")
    current_state = relationship("WorkflowState", back_populates="current_workflows")
    assigned_to_user = relationship("User")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_material_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusMaterial(Base):
    __tablename__ = 'syllabus_materials'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    type = Column(NVARCHAR(50), nullable=False)  # MAIN, REFERENCE
    title = Column(NVARCHAR(555), nullable=False)
    author = Column(NVARCHAR(255))
    publisher = Column(NVARCHAR(255))
    published_year = Column(Integer)
    isbn = Column(NVARCHAR(50))
    url = Column(UnicodeText, nullable=True)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="materials")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base

class Syllabus(Base):
    __tablename__ = 'syllabuses'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    program_id = Column(BigInteger, ForeignKey('programs.id'), nullable=False)
    academic_year_id = Column(BigInteger, ForeignKey('academic_years.id'), nullable=False)
    lecturer_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    status = Column(NVARCHAR(20))  # DRAFT, PENDING, APPROVED
    version = Column(NVARCHAR(10))
    time_allocation = Column(UnicodeText)  # JSON
    prerequisites = Column(UnicodeText)
    publish_date = Column(DateTime)
    is_active = Column(Boolean)
    embedding_vector = Column(UnicodeText, nullable=True)  # JSON vector
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
    
    # Relationships
    subject = relationship("Subject", back_populates="syllabuses")
    program = relationship("Program", back_populates="syllabuses")
    academic_year = relationship("AcademicYear", back_populates="syllabuses")
    lecturer = relationship("User", back_populates="syllabuses")
    clos = relationship("SyllabusClo", back_populates="syllabus", cascade="all, delete-orphan")
    materials = relationship("SyllabusMaterial", back_populates="syllabus", cascade="all, delete-orphan")
    teaching_plans = relationship("TeachingPlan", back_populates="syllabus", cascade="all, delete-orphan")
    assessment_schemes = relationship("AssessmentScheme", back_populates="syllabus", cascade="all, delete-orphan")
    comments = relationship("SyllabusComment", back_populates="syllabus")
    workflow_logs = relationship("WorkflowLog", back_populates="syllabus")
    current_workflow = relationship("SyllabusCurrentWorkflow", back_populates="syllabus", uselist=False)
    student_reports = relationship("StudentReport", back_populates="syllabus")
    ai_audit_logs = relationship("AiAuditLog", back_populates="syllabus")
</file>

<file path="apps/api/src/infrastructure/models/system_auditlog_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SystemAuditLog(Base):
    __tablename__ = 'system_audit_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    action_type = Column(NVARCHAR(50), nullable=False)
    resource_target = Column(NVARCHAR(100))
    ip_address = Column(NVARCHAR(45))
    user_agent = Column(UnicodeText)
    details = Column(UnicodeText)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    user = relationship("User")
</file>

<file path="apps/api/src/infrastructure/models/system_setting_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base

class SystemSetting(Base):
    __tablename__ = 'system_settings'
    
    key = Column(NVARCHAR(50), primary_key=True)
    value = Column(UnicodeText, nullable=False)
    type = Column(NVARCHAR(20), default='STRING')
    description = Column(NVARCHAR(255), nullable=True)
</file>

<file path="apps/api/src/infrastructure/models/teaching_plan_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class TeachingPlan(Base):
    __tablename__ = 'teaching_plans'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    week = Column(Integer)
    topic = Column(UnicodeText)
    activity = Column(UnicodeText)
    assessment = Column(UnicodeText)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="teaching_plans")
</file>

<file path="apps/api/src/infrastructure/models/user_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
# IMPORT BASE CHUNG (QUAN TRNG)
from infrastructure.databases.base import Base

class User(Base):
    __tablename__ = 'users'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=True)
    username = Column(NVARCHAR(50), unique=True, nullable=False)
    email = Column(NVARCHAR(100), unique=True, nullable=False)
    password_hash = Column(NVARCHAR(255), nullable=False)
    full_name = Column(NVARCHAR(100), nullable=False)
    is_active = Column(Boolean, default=True)
    
    # SA LI VNG LP: Thm use_alter=True
    avatar_file_id = Column(BigInteger, ForeignKey('files.id', use_alter=True, name='fk_user_avatar_file'), nullable=True)
    
    # Relationships
    department = relationship("Department", back_populates="users")
    
    # Lu : Cp nht tn relationship nu file_model dng tn class l File
    avatar_file = relationship("File", foreign_keys=[avatar_file_id])
    uploaded_files = relationship("File", back_populates="uploader", foreign_keys="File.uploader_id")
    
    roles = relationship("UserRole", back_populates="user")
    syllabuses = relationship("Syllabus", back_populates="lecturer")
    comments = relationship("SyllabusComment", back_populates="user")
    notifications = relationship("Notification", back_populates="user")
    workflow_logs = relationship("WorkflowLog", back_populates="actor")
</file>

<file path="apps/api/src/infrastructure/models/user_role_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class UserRole(Base):
    __tablename__ = 'user_roles'
    
    user_id = Column(BigInteger, ForeignKey('users.id'), primary_key=True)
    role_id = Column(BigInteger, ForeignKey('roles.id'), primary_key=True)
    
    # Relationships
    user = relationship("User", back_populates="roles")
    role = relationship("Role", back_populates="user_roles")
</file>

<file path="apps/api/src/infrastructure/models/workflow_log_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base


class WorkflowLog(Base):
    __tablename__ = 'workflow_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    actor_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    action = Column(NVARCHAR(50))  # SUBMIT, APPROVE, REJECT
    from_status = Column(NVARCHAR(50))
    to_status = Column(NVARCHAR(50))
    comment = Column(UnicodeText)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="workflow_logs")
    actor = relationship("User", back_populates="workflow_logs")
</file>

<file path="apps/api/src/infrastructure/models/workflow_state_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class WorkflowState(Base):
    __tablename__ = 'workflow_states'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(50), unique=True, nullable=False)
    name = Column(NVARCHAR(100), nullable=False)
    color = Column(NVARCHAR(20))
    is_final = Column(Boolean, default=False)
    
    # Relationships
    transitions_from = relationship("WorkflowTransition", 
                                   foreign_keys="WorkflowTransition.from_state_id",
                                   back_populates="from_state")
    transitions_to = relationship("WorkflowTransition",
                                 foreign_keys="WorkflowTransition.to_state_id",
                                 back_populates="to_state")
    current_workflows = relationship("SyllabusCurrentWorkflow", back_populates="current_state")
</file>

<file path="apps/api/src/infrastructure/models/workflow_transition_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class WorkflowTransition(Base):
    __tablename__ = 'workflow_transitions'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    from_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    to_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    allowed_role_id = Column(BigInteger, ForeignKey('roles.id'), nullable=False)
    action_name = Column(NVARCHAR(50))
    
    # Relationships
    from_state = relationship("WorkflowState", foreign_keys=[from_state_id], back_populates="transitions_from")
    to_state = relationship("WorkflowState", foreign_keys=[to_state_id], back_populates="transitions_to")
    allowed_role = relationship("Role", back_populates="workflow_transitions")
</file>

<file path="apps/api/src/infrastructure/repositories/academic_year_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.academic_year_model import AcademicYear

class AcademicYearRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[AcademicYear]:
        return self.session.query(AcademicYear).all()

    def get_by_id(self, id: int) -> Optional[AcademicYear]:
        return self.session.query(AcademicYear).filter_by(id=id).first()

    def create(self, data: dict) -> AcademicYear:
        ay = AcademicYear(**data)
        self.session.add(ay)
        self.session.commit()
        self.session.refresh(ay)
        return ay

    def update(self, id: int, data: dict) -> Optional[AcademicYear]:
        ay = self.get_by_id(id)
        if not ay:
            return None
        for key, value in data.items():
            if hasattr(ay, key):
                setattr(ay, key, value)
        self.session.commit()
        self.session.refresh(ay)
        return ay

    def delete(self, id: int) -> bool:
        ay = self.get_by_id(id)
        if not ay:
            return False
        self.session.delete(ay)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/ai_auditlog_repository.py">
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.ai_auditlog_model import AiAuditLog

class AiAuditLogRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, syllabus_id: int, action: str, input_tokens: int, output_tokens: int):
        log = AiAuditLog(syllabus_id=syllabus_id, action=action, input_tokens=input_tokens, output_tokens=output_tokens)
        self.session.add(log)
        self.session.commit()
        return log
</file>

<file path="apps/api/src/infrastructure/repositories/assessment_clo_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_clo_model import AssessmentClo
from infrastructure.models.syllabus_clo_model import SyllabusClo

class AssessmentCloRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def add_mapping(self, component_id: int, syllabus_clo_id: int) -> AssessmentClo:
        mapping = AssessmentClo(assessment_component_id=component_id, syllabus_clo_id=syllabus_clo_id)
        self.session.add(mapping)
        self.session.commit()
        return mapping

    def remove_mapping(self, component_id: int, syllabus_clo_id: int) -> bool:
        mapping = self.session.query(AssessmentClo).filter_by(assessment_component_id=component_id, syllabus_clo_id=syllabus_clo_id).first()
        if not mapping:
            return False
        self.session.delete(mapping)
        self.session.commit()
        return True

    def get_clos_by_component(self, component_id: int) -> List[SyllabusClo]:
        mappings = self.session.query(AssessmentClo).filter_by(assessment_component_id=component_id).all()
        return [m.syllabus_clo for m in mappings]
</file>

<file path="apps/api/src/infrastructure/repositories/assessment_component_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_component_model import AssessmentComponent

class AssessmentComponentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[AssessmentComponent]:
        return self.session.query(AssessmentComponent).filter_by(id=id).first()

    def create(self, data: dict) -> AssessmentComponent:
        item = AssessmentComponent(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[AssessmentComponent]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/assessment_scheme_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session, joinedload
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_scheme_model import AssessmentScheme

class AssessmentSchemeRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[AssessmentScheme]:
        return self.session.query(AssessmentScheme).all()

    def get_by_id(self, id: int) -> Optional[AssessmentScheme]:
        return self.session.query(AssessmentScheme).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[AssessmentScheme]:
        # Load components eagerly
        return self.session.query(AssessmentScheme).options(joinedload(AssessmentScheme.components)).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> AssessmentScheme:
        s = AssessmentScheme(**data)
        self.session.add(s)
        self.session.commit()
        self.session.refresh(s)
        return s

    def update(self, id: int, data: dict) -> Optional[AssessmentScheme]:
        s = self.get_by_id(id)
        if not s:
            return None
        for k, v in data.items():
            if hasattr(s, k):
                setattr(s, k, v)
        self.session.commit()
        self.session.refresh(s)
        return s

    def delete(self, id: int) -> bool:
        s = self.get_by_id(id)
        if not s:
            return False
        self.session.delete(s)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/clo_plo_mapping_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.clo_plo_mapping_model import CloPloMapping

class CloPloMappingRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[CloPloMapping]:
        return self.session.query(CloPloMapping).filter_by(id=id).first()

    def get_by_syllabus_clo(self, syllabus_clo_id: int) -> List[CloPloMapping]:
        return self.session.query(CloPloMapping).filter_by(syllabus_clo_id=syllabus_clo_id).all()

    def create(self, data: dict) -> CloPloMapping:
        item = CloPloMapping(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/department_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.department_model import Department

class DepartmentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Department]:
        return self.session.query(Department).all()

    def get_by_id(self, id: int) -> Optional[Department]:
        return self.session.query(Department).filter_by(id=id).first()

    def create(self, data: dict) -> Department:
        department = Department(**data)
        self.session.add(department)
        self.session.commit()
        self.session.refresh(department)
        return department

    def update(self, id: int, data: dict) -> Optional[Department]:
        department = self.get_by_id(id)
        if not department:
            return None
        for key, value in data.items():
            if hasattr(department, key):
                setattr(department, key, value)
        self.session.commit()
        self.session.refresh(department)
        return department

    def delete(self, id: int) -> bool:
        department = self.get_by_id(id)
        if not department:
            return False
        self.session.delete(department)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/faculty_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.faculty_model import Faculty

class FacultyRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Faculty]:
        return self.session.query(Faculty).all()

    def get_by_id(self, id: int) -> Optional[Faculty]:
        return self.session.query(Faculty).filter_by(id=id).first()

    def create(self, data: dict) -> Faculty:
        faculty = Faculty(**data)
        self.session.add(faculty)
        self.session.commit()
        self.session.refresh(faculty)
        return faculty

    def update(self, id: int, data: dict) -> Optional[Faculty]:
        faculty = self.get_by_id(id)
        if not faculty:
            return None
        for key, value in data.items():
            if hasattr(faculty, key):
                setattr(faculty, key, value)
        self.session.commit()
        self.session.refresh(faculty)
        return faculty

    def delete(self, id: int) -> bool:
        faculty = self.get_by_id(id)
        if not faculty:
            return False
        self.session.delete(faculty)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/file_repository.py">
from typing import Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.file_model import File

class FileRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[File]:
        return self.session.query(File).filter_by(id=id).first()

    def create(self, data: dict) -> File:
        file_record = File(**data)
        self.session.add(file_record)
        self.session.commit()
        self.session.refresh(file_record)
        return file_record

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/notification_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.notification_model import Notification

class NotificationRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_user(self, user_id: int, limit: int = 20, unread_only: bool = False) -> List[Notification]:
        query = self.session.query(Notification).filter_by(user_id=user_id)
        if unread_only:
            query = query.filter_by(is_read=False)
        return query.order_by(Notification.created_at.desc()).limit(limit).all()

    def create(self, data: dict) -> Notification:
        item = Notification(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def mark_as_read(self, id: int) -> bool:
        item = self.session.query(Notification).filter_by(id=id).first()
        if not item:
            return False
        item.is_read = True
        self.session.commit()
        return True

    def mark_all_as_read(self, user_id: int):
        self.session.query(Notification).filter_by(user_id=user_id, is_read=False).update({'is_read': True})
        self.session.commit()
</file>

<file path="apps/api/src/infrastructure/repositories/program_outcome_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.program_outcome_model import ProgramOutcome

class ProgramOutcomeRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[ProgramOutcome]:
        return self.session.query(ProgramOutcome).filter_by(id=id).first()

    def get_by_program_id(self, program_id: int) -> List[ProgramOutcome]:
        return self.session.query(ProgramOutcome).filter_by(program_id=program_id).all()

    def create(self, data: dict) -> ProgramOutcome:
        item = ProgramOutcome(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[ProgramOutcome]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/program_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.program_model import Program

class ProgramRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Program]:
        return self.session.query(Program).all()

    def get_by_id(self, id: int) -> Optional[Program]:
        return self.session.query(Program).filter_by(id=id).first()

    def create(self, data: dict) -> Program:
        p = Program(**data)
        self.session.add(p)
        self.session.commit()
        self.session.refresh(p)
        return p

    def update(self, id: int, data: dict) -> Optional[Program]:
        p = self.get_by_id(id)
        if not p:
            return None
        for key, value in data.items():
            if hasattr(p, key):
                setattr(p, key, value)
        self.session.commit()
        self.session.refresh(p)
        return p

    def delete(self, id: int) -> bool:
        p = self.get_by_id(id)
        if not p:
            return False
        self.session.delete(p)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/role_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.role_model import Role

class RoleRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Role]:
        return self.session.query(Role).all()

    def get_by_id(self, id: int) -> Optional[Role]:
        return self.session.query(Role).filter_by(id=id).first()

    def get_by_name(self, name: str) -> Optional[Role]:
        return self.session.query(Role).filter_by(name=name).first()

    def create(self, data: dict) -> Role:
        role = Role(**data)
        self.session.add(role)
        self.session.commit()
        self.session.refresh(role)
        return role

    def delete(self, id: int) -> bool:
        role = self.get_by_id(id)
        if not role:
            return False
        self.session.delete(role)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/rubric_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.rubric_model import Rubric

class RubricRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[Rubric]:
        return self.session.query(Rubric).filter_by(id=id).first()

    def get_by_component_id(self, component_id: int) -> List[Rubric]:
        return self.session.query(Rubric).filter_by(component_id=component_id).all()

    def create(self, data: dict) -> Rubric:
        item = Rubric(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[Rubric]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/student_report_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.student_report_model import StudentReport

class StudentReportRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, data: dict) -> StudentReport:
        item = StudentReport(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def get_all(self) -> List[StudentReport]:
        return self.session.query(StudentReport).all()

    def update_status(self, id: int, status: str, admin_note: str = None):
        item = self.session.query(StudentReport).filter_by(id=id).first()
        if item:
            item.status = status
            if admin_note: item.admin_note = admin_note
            self.session.commit()
            self.session.refresh(item)
        return item
</file>

<file path="apps/api/src/infrastructure/repositories/student_subscription_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.student_subscription_model import StudentSubscription

class StudentSubscriptionRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, user_id: int, subject_id: int):
        # Check exists
        exists = self.session.query(StudentSubscription).filter_by(student_id=user_id, subject_id=subject_id).first()
        if exists: return exists
        
        item = StudentSubscription(student_id=user_id, subject_id=subject_id)
        self.session.add(item)
        self.session.commit()
        return item

    def delete(self, user_id: int, subject_id: int):
        item = self.session.query(StudentSubscription).filter_by(student_id=user_id, subject_id=subject_id).first()
        if item:
            self.session.delete(item)
            self.session.commit()
            return True
        return False

    def get_by_student(self, user_id: int) -> List[StudentSubscription]:
        return self.session.query(StudentSubscription).filter_by(student_id=user_id).all()
</file>

<file path="apps/api/src/infrastructure/repositories/subject_relationship_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.subject_relationship_model import SubjectRelationship

class SubjectRelationshipRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[SubjectRelationship]:
        return self.session.query(SubjectRelationship).filter_by(id=id).first()

    def get_by_subject(self, subject_id: int) -> List[SubjectRelationship]:
        return self.session.query(SubjectRelationship).filter_by(subject_id=subject_id).all()

    def create(self, data: dict) -> SubjectRelationship:
        item = SubjectRelationship(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/subject_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.subject_model import Subject

class SubjectRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Subject]:
        return self.session.query(Subject).all()

    def get_by_id(self, id: int) -> Optional[Subject]:
        return self.session.query(Subject).filter_by(id=id).first()

    def create(self, data: dict) -> Subject:
        subject = Subject(**data)
        self.session.add(subject)
        self.session.commit()
        self.session.refresh(subject)
        return subject

    def update(self, id: int, data: dict) -> Optional[Subject]:
        subject = self.get_by_id(id)
        if not subject:
            return None
        for key, value in data.items():
            if hasattr(subject, key):
                setattr(subject, key, value)
        self.session.commit()
        self.session.refresh(subject)
        return subject

    def delete(self, id: int) -> bool:
        subject = self.get_by_id(id)
        if not subject:
            return False
        self.session.delete(subject)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_clo_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_clo_model import SyllabusClo

class SyllabusCloRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SyllabusClo]:
        return self.session.query(SyllabusClo).all()

    def get_by_id(self, id: int) -> Optional[SyllabusClo]:
        return self.session.query(SyllabusClo).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[SyllabusClo]:
        return self.session.query(SyllabusClo).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> SyllabusClo:
        item = SyllabusClo(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[SyllabusClo]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_comment_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_comment_model import SyllabusComment

class SyllabusCommentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[SyllabusComment]:
        return self.session.query(SyllabusComment).filter_by(id=id).first()

    def get_by_syllabus(self, syllabus_id: int) -> List[SyllabusComment]:
        return self.session.query(SyllabusComment).filter_by(syllabus_id=syllabus_id).order_by(SyllabusComment.created_at.asc()).all()

    def create(self, data: dict) -> SyllabusComment:
        item = SyllabusComment(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[SyllabusComment]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_material_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_material_model import SyllabusMaterial

class SyllabusMaterialRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).all()

    def get_by_id(self, id: int) -> Optional[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> SyllabusMaterial:
        item = SyllabusMaterial(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session, joinedload
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_model import Syllabus
from infrastructure.models.assessment_scheme_model import AssessmentScheme
from infrastructure.models.assessment_component_model import AssessmentComponent

class SyllabusRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Syllabus]:
        return self.session.query(Syllabus).all()

    def get_by_id(self, id: int) -> Optional[Syllabus]:
        return self.session.query(Syllabus).filter_by(id=id).first()

    def get_by_subject_id(self, subject_id: int) -> List[Syllabus]:
        return self.session.query(Syllabus).filter_by(subject_id=subject_id).all()

    def get_details(self, id: int) -> Optional[Syllabus]:
        # Eagerly load related collections and nested components->rubrics
        return (
            self.session.query(Syllabus)
            .options(
                joinedload(Syllabus.clos),
                joinedload(Syllabus.materials),
                joinedload(Syllabus.teaching_plans),
                joinedload(Syllabus.assessment_schemes)
                    .joinedload(AssessmentScheme.components)
                    .joinedload(AssessmentComponent.rubrics),
            )
            .filter_by(id=id)
            .first()
        )

    def create(self, data: dict) -> Syllabus:
        s = Syllabus(**data)
        self.session.add(s)
        self.session.commit()
        self.session.refresh(s)
        return s

    def update(self, id: int, data: dict) -> Optional[Syllabus]:
        s = self.get_by_id(id)
        if not s:
            return None
        for key, value in data.items():
            if hasattr(s, key):
                setattr(s, key, value)
        self.session.commit()
        self.session.refresh(s)
        return s

    def delete(self, id: int) -> bool:
        s = self.get_by_id(id)
        if not s:
            return False
        self.session.delete(s)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/system_setting_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.system_setting_model import SystemSetting

class SystemSettingRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SystemSetting]:
        return self.session.query(SystemSetting).all()

    def get_by_key(self, key: str) -> Optional[SystemSetting]:
        return self.session.query(SystemSetting).filter_by(key=key).first()

    def set_value(self, key: str, value: str, description: str = None, type: str = 'STRING') -> SystemSetting:
        setting = self.get_by_key(key)
        if setting:
            setting.value = value
            if description: setting.description = description
        else:
            setting = SystemSetting(key=key, value=value, type=type, description=description)
            self.session.add(setting)
        self.session.commit()
        self.session.refresh(setting)
        return setting
</file>

<file path="apps/api/src/infrastructure/repositories/teaching_plan_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.teaching_plan_model import TeachingPlan

class TeachingPlanRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[TeachingPlan]:
        return self.session.query(TeachingPlan).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[TeachingPlan]:
        return self.session.query(TeachingPlan).filter_by(syllabus_id=syllabus_id).order_by(TeachingPlan.week).all()

    def create(self, data: dict) -> TeachingPlan:
        item = TeachingPlan(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[TeachingPlan]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/user_repository.py">
from typing import List, Optional
from dotenv import load_dotenv
import os
from sqlalchemy.orm import Session
from infrastructure.databases import Base
from infrastructure.databases.mssql import session

# Import the User model
from infrastructure.models.user_model import User

load_dotenv()

class UserRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[User]:
        return self.session.query(User).all()

    def get_by_username(self, username: str) -> Optional[User]:
        return self.session.query(User).filter_by(username=username).first()

    def get_by_id(self, user_id: int) -> Optional[User]:
        return self.session.query(User).filter_by(id=user_id).first()

    def create(self, data: dict) -> User:
        user = User(**data)
        self.session.add(user)
        self.session.commit()
        self.session.refresh(user)
        return user

    def update(self, id: int, data: dict) -> Optional[User]:
        user = self.get_by_id(id)
        if not user:
            return None
        for key, value in data.items():
            if hasattr(user, key):
                setattr(user, key, value)
        self.session.commit()
        self.session.refresh(user)
        return user

    def delete(self, id: int) -> bool:
        user = self.get_by_id(id)
        if not user:
            return False
        self.session.delete(user)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/workflow_log_repository.py">
from typing import List
from infrastructure.models.workflow_log_model import WorkflowLog

class WorkflowLogRepository:
    def __init__(self, session):
        self.session = session

    def create(self, data: dict):
        wl = WorkflowLog(**data)
        self.session.add(wl)
        try:
            self.session.commit()
            self.session.refresh(wl)
            return wl
        except Exception:
            self.session.rollback()
            raise

    def get_by_syllabus_id(self, syllabus_id: int) -> List[WorkflowLog]:
        return self.session.query(WorkflowLog).filter_by(syllabus_id=syllabus_id).order_by(WorkflowLog.created_at.asc()).all()
</file>

<file path="apps/api/src/infrastructure/services/...  # Services that use third party libraries or services (e.g. email service)">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/migrations">
# This directory contains database migration files.
</file>

<file path="apps/api/src/README.md">
# Flask Clean Architecture

This project is structured using the Clean Architecture principles, which promotes separation of concerns and maintainability. Below is an overview of the project's structure and its components.

## Directory Structure

- **migrations/**: Contains database migration files.
- **scripts/**: Contains scripts for running and managing the application, such as `run_postgres.sh` for PostgreSQL.
- **api/**: Contains the API-related components.
  - **controllers/**: Controllers for handling API requests.
  - **schemas/**: Marshmallow schemas for data validation and serialization.
  - **middleware.py**: Middleware functions for processing requests and responses.
  - **responses.py**: Functions for handling API responses.
  - **requests.py**: Functions for handling API requests.
- **infrastructure/**: Contains components that interact with external systems.
  - **services/**: Services that use third-party libraries or services (e.g., email service).
  - **databases/**: Database adapters and initialization code.
  - **repositories/**: Repositories for interacting with the databases.
  - **models/**: Database models.
- **domain/**: Contains the core business logic.
  - **constants.py**: Constants used throughout the application.
  - **exceptions.py**: Custom exceptions for the application.
  - **models/**: Business logic models.
- **services/**: Services for interacting with the domain (business logic).
- **app.py**: The main entry point of the application, initializing the app and setting up routes.
- **config.py**: Configuration settings for the application.
- **cors.py**: Handles Cross-Origin Resource Sharing (CORS) settings.
- **create_app.py**: Factory function to create the Flask application instance.
- **dependency_container.py**: Manages dependency injection for the application.
- **error_handler.py**: Defines error handling logic for the application.
- **logging.py**: Sets up logging configurations for the application.

## Getting Started

To get started with the project, ensure you have the necessary dependencies installed and follow the setup instructions provided in the respective files. 

## Contributing

Contributions are welcome! Please follow the contribution guidelines outlined in the project documentation.
</file>

<file path="apps/api/src/requirements.txt">
Flask>=2.0
Flask-Cors>=3.0
Flask-SQLAlchemy>=2.5
SQLAlchemy>=1.4
marshmallow>=3.0
pymssql>=2.2
python-dotenv>=0.21 
Flask-RESTX>=1.1.0 
flasgger
fastapi
apispec
apispec_webframeworks
flask-swagger-ui
dependency-injector>=4.0
PyJWT>=2.0
google-genai>=0.1
</file>

<file path="apps/api/src/scripts/import_check.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src
try:
    import services.syllabus_service as ss
    import services.ai_service as ai
    import api.schemas.syllabus_schema as sch
    import services.program_outcome_service as plo_svc
    import api.controllers.program_outcome_controller as plo_ctrl
    import services.file_service as file_svc
    import api.controllers.file_controller as file_ctrl
    import services.clo_plo_mapping_service as mapping_svc
    import api.controllers.clo_plo_mapping_controller as mapping_ctrl
    import services.subject_relationship_service as rel_svc
    import api.controllers.subject_relationship_controller as rel_ctrl
    import services.syllabus_comment_service as comment_svc
    import api.controllers.syllabus_comment_controller as comment_ctrl
    import services.notification_service as notif_svc
    import api.controllers.notification_controller as notif_ctrl
    import infrastructure.repositories.ai_auditlog_repository as audit_repo
    import services.system_setting_service as ss_svc
    import api.controllers.system_setting_controller as ss_ctrl
    import services.student_service as student_svc
    import api.controllers.student_controller as student_ctrl
    print('IMPORT_OK')
except Exception as e:
    print('IMPORT_FAIL', repr(e))
    raise
</file>

<file path="apps/api/src/scripts/run_postgres.sh">
#!/bin/bash

# Function to check if PostgreSQL is running
is_postgres_running() {
    pg_isready -q
    return $?
}

# Start PostgreSQL if it's not already running
if ! is_postgres_running; then
    echo "PostgreSQL is not running. Starting it now..."
    pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start
else
    echo "PostgreSQL is already running."
fi

# Create the database if it doesn't exist
if ! psql -lqt | cut -d \| -f 1 | grep -qw dbname; then
    createdb dbname
fi
</file>

<file path="apps/api/src/scripts/seed_users.py">
from dependency_container import Container
from datetime import date


def get_or_create(service, list_method_name, check_attr, check_value, create_method_name, create_data):
    list_method = getattr(service, list_method_name)
    for item in list_method():
        if getattr(item, check_attr) == check_value:
            return item
    create_method = getattr(service, create_method_name)
    return create_method(create_data)


def seed():
    container = Container()

    # Services
    role_service = container.role_service()
    user_service = container.user_service()
    faculty_service = container.faculty_service()
    department_service = container.department_service()
    academic_year_service = container.academic_year_service()
    program_service = container.program_service()
    subject_service = container.subject_service()
    syllabus_service = container.syllabus_service()
    syllabus_clo_service = container.syllabus_clo_service()
    syllabus_material_service = container.syllabus_material_service()

    # 1) Roles
    admin_role = role_service.get_by_name('ADMIN') or role_service.create_role({'name': 'ADMIN', 'description': 'ADMIN role'})
    print('  Role:', admin_role.name)
    lecturer_role = role_service.get_by_name('LECTURER') or role_service.create_role({'name': 'LECTURER', 'description': 'LECTURER role'})
    print('  Role:', lecturer_role.name)

    # 2) Users
    admin = user_service.get_by_username('admin')
    if not admin:
        admin = user_service.create_user({'username': 'admin', 'email': 'admin@example.com', 'full_name': 'Admin User', 'password': 'password123', 'is_active': True})
        print('  Created User: admin')
    else:
        print('  Found User: admin')

    lecturer = user_service.get_by_username('lecturer')
    if not lecturer:
        lecturer = user_service.create_user({'username': 'lecturer', 'email': 'lecturer@example.com', 'full_name': 'Lecturer User', 'password': 'password123', 'is_active': True})
        print('  Created User: lecturer')
    else:
        print('  Found User: lecturer')

    # Assign roles idempotently
    session = container.db_session()
    from infrastructure.models.user_role_model import UserRole

    def ensure_role(user, role):
        if not session.query(UserRole).filter_by(user_id=user.id, role_id=role.id).first():
            try:
                session.add(UserRole(user_id=user.id, role_id=role.id))
                session.commit()
                print(f"  Assigned role {role.name} to user {user.username}")
            except Exception:
                session.rollback()

    ensure_role(admin, admin_role)
    ensure_role(lecturer, lecturer_role)

    # 3) Faculty & Department
    faculty = get_or_create(faculty_service, 'list_faculties', 'code', 'FIT', 'create_faculty', {'code': 'FIT', 'name': 'Faculty of Information Technology'})
    print(f"  Faculty: {faculty.code} - {faculty.name}")

    department = None
    # department needs faculty_id
    for d in department_service.list_departments():
        if d.code == 'SE' and d.faculty_id == faculty.id:
            department = d
            break
    if not department:
        department = department_service.create_department({'faculty_id': faculty.id, 'code': 'SE', 'name': 'Software Engineering'})
        print('  Created Department: SE')
    else:
        print('  Found Department: SE')

    # 4) Academic Year, Program, Subject
    academic_year = get_or_create(academic_year_service, 'list_academic_years', 'code', '2025-2026', 'create_academic_year', {'code': '2025-2026', 'start_date': date(2025,9,1), 'end_date': date(2026,6,30)})
    print(f"  AcademicYear: {academic_year.code}")

    program = get_or_create(program_service, 'list_programs', 'name', 'Software Engineering K18', 'create_program', {'department_id': department.id, 'name': 'Software Engineering K18', 'total_credits': 120})
    print(f"  Program: {program.name}")

    subject = None
    for s in subject_service.list_subjects():
        if s.code == 'SWT301' and s.department_id == department.id:
            subject = s
            break
    if not subject:
        subject = subject_service.create_subject({'department_id': department.id, 'code': 'SWT301', 'name_vi': 'Gii thiu K thut Phn mm', 'name_en': 'Introduction to Software Engineering', 'credits': 3})
        print('  Created Subject: SWT301')
    else:
        print('  Found Subject: SWT301')

    # 5) Syllabus
    syllabus = None
    for sy in syllabus_service.list_syllabuses():
        if sy.subject_id == subject.id and sy.program_id == program.id and sy.academic_year_id == academic_year.id:
            syllabus = sy
            break
    if not syllabus:
        syllabus = syllabus_service.create_syllabus({'subject_id': subject.id, 'program_id': program.id, 'academic_year_id': academic_year.id, 'lecturer_id': lecturer.id, 'version': '1.0'})
        print(f"  Created Syllabus ID: {syllabus.id}")
    else:
        print(f"  Found Syllabus ID: {syllabus.id}")

    # 6) Syllabus Details - CLOs
    existing_clos = {c.code for c in syllabus_clo_service.get_by_syllabus(syllabus.id)}
    clos_to_add = [
        {'code': 'CLO1', 'description': 'Explain software lifecycle.'},
        {'code': 'CLO2', 'description': 'Apply software requirements engineering.'},
        {'code': 'CLO3', 'description': 'Design basic software architecture.'},
    ]
    for clo in clos_to_add:
        if clo['code'] not in existing_clos:
            item = syllabus_clo_service.create_clo({'syllabus_id': syllabus.id, **clo})
            print(f"  Added CLO: {item.code}")
        else:
            print(f"  CLO exists: {clo['code']}")

    # Materials
    existing_mats = {m.title for m in syllabus_material_service.get_by_syllabus(syllabus.id)}
    mats_to_add = [
        {'type': 'MAIN', 'title': 'Software Engineering (Textbook)', 'author': 'Ian Sommerville', 'publisher': 'Pearson', 'isbn': '1234567890', 'syllabus_id': syllabus.id},
        {'type': 'REFERENCE', 'title': 'Design Patterns', 'author': 'Gamma et al.', 'publisher': 'Addison-Wesley', 'isbn': '0987654321', 'syllabus_id': syllabus.id},
    ]
    for mat in mats_to_add:
        if mat['title'] not in existing_mats:
            item = syllabus_material_service.create_material(mat)
            print(f"  Added Material: {item.title}")
        else:
            print(f"  Material exists: {mat['title']}")

    # Teaching Plans
    teaching_plan_service = container.teaching_plan_service()
    existing_weeks = {p.week for p in teaching_plan_service.list_plans_for_syllabus(syllabus.id)}
    plans_to_add = [
        {'week': 1, 'topic': 'Introduction to Software Engineering', 'activity': 'Lecture', 'assessment': 'Quiz', 'syllabus_id': syllabus.id},
        {'week': 2, 'topic': 'Software Process Models', 'activity': 'Lecture', 'assessment': 'Assignment 1', 'syllabus_id': syllabus.id},
        {'week': 3, 'topic': 'Requirements Engineering', 'activity': 'Lecture', 'assessment': 'Assignment 2', 'syllabus_id': syllabus.id},
    ]
    for plan in plans_to_add:
        if plan['week'] not in existing_weeks:
            item = teaching_plan_service.create_teaching_plan(plan)
            print(f"  Added Teaching Plan Week: {item.week}")
        else:
            print(f"  Teaching Plan exists for week: {plan['week']}")

    # Assessments: Schemes, Components, Rubrics, CLO mappings
    assessment_scheme_service = container.assessment_scheme_service()
    assessment_component_service = container.assessment_component_service()
    rubric_service = container.rubric_service()
    assessment_clo_service = container.assessment_clo_service()

    existing_schemes = {s.name for s in assessment_scheme_service.list_schemes_for_syllabus(syllabus.id)}

    # Example scheme: Midterm
    if 'Midterm' not in existing_schemes:
        scheme = assessment_scheme_service.create_scheme({'syllabus_id': syllabus.id, 'name': 'Midterm', 'weight': 30.0})
        print(f"  Created Assessment Scheme: {scheme.name}")
        comp = assessment_component_service.create_component({'scheme_id': scheme.id, 'name': 'Midterm Exam', 'weight': 30.0})
        print(f"  Created Assessment Component: {comp.name}")
        rubric = rubric_service.create_rubric({'component_id': comp.id, 'criteria': 'Comprehensive exam', 'max_score': 100})
        print(f"  Created Rubric for component: {rubric.criteria}")
        # Map to CLO1 if exists
        clo1 = None
        for c in syllabus_clo_service.get_by_syllabus(syllabus.id):
            if c.code == 'CLO1':
                clo1 = c
                break
        if clo1:
            assessment_clo_service.add_mapping(comp.id, clo1.id)
            print(f"  Mapped component {comp.name} to CLO {clo1.code}")
    else:
        print('  Midterm scheme exists')

    print('\n  Seeding complete!')


if __name__ == '__main__':
    seed()
</file>

<file path="apps/api/src/SDM-workspace.code-workspace">
{
	"folders": [
		{
			"path": ".."
		},
		{
			"path": "../../FE_SDM"
		}
	]
}
</file>

<file path="apps/api/src/services/...  # Services for interacting with the domain (business logic)">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/services/academic_year_service.py">
from typing import List, Optional
from infrastructure.repositories.academic_year_repository import AcademicYearRepository

class AcademicYearService:
    def __init__(self, repository: AcademicYearRepository):
        self.repository = repository

    def list_academic_years(self) -> List:
        return self.repository.get_all()

    def get_academic_year(self, id: int):
        return self.repository.get_by_id(id)

    def create_academic_year(self, data: dict):
        return self.repository.create(data)

    def update_academic_year(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_academic_year(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/ai_service.py">
import os
import json
from datetime import datetime

# Prefer the new `google-genai` package (import path: `google.genai` via `from google import genai`).
# Fall back to legacy `google.generativeai` if needed for compatibility.
try:
    # New package (preferred)
    from google import genai
    _NEW_GENAI = True
except Exception:
    try:
        # Legacy package
        import google.generativeai as genai
        _NEW_GENAI = False
    except Exception:
        genai = None
        _NEW_GENAI = False

class AiService:
    def __init__(self, api_key: str = None, audit_repository=None):
        self.api_key = api_key or os.getenv('GEMINI_API_KEY')
        self.audit_repository = audit_repository

    def _log_usage(self, syllabus_id, action, in_tok, out_tok):
        if self.audit_repository and syllabus_id:
            try:
                self.audit_repository.create(syllabus_id, action, in_tok, out_tok)
            except Exception as e:
                print(f'Failed to log AI usage: {e}')

    def generate(self, subject_name: str, syllabus_id: int = None):
        if not self.api_key:
            return {"error": "Cha cu hnh GEMINI_API_KEY"}

        if genai is None:
            return {"error": "No generative AI client installed (install google-genai)"}

        # Strict Template
        json_template = {
            "subject_name_vi": subject_name,
            "subject_name_en": "...",
            "credits": 3,
            "time_allocation": { "theory": 30, "practice": 30, "self_study": 90 },
            "description": "...",
            "clos": [
                { "code": "CLO1", "description": "..." }
            ],
            "materials": [
                { "type": "MAIN", "title": "...", "author": "...", "publisher": "...", "isbn": "..." }
            ],
            "teaching_plans": [
                { "week": 1, "topic": "...", "activity": "...", "assessment": "..." }
            ],
            "assessment_schemes": [
                { 
                    "name": "Midterm", "weight": 50, 
                    "components": [
                        { "name": "Exam 1", "weight": 100, "rubrics": [{"criteria": "...", "max_score": 10}] }
                    ] 
                }
            ]
        }

        prompt = f"""
        You are a curriculum expert. Create a syllabus for: "{subject_name}".
        OUTPUT REQUIREMENT: Return ONLY valid raw JSON. No markdown, no explanations.
        The JSON structure MUST match this template exactly:
        {json.dumps(json_template, ensure_ascii=False)}
        """

        try:
            if _NEW_GENAI:
                # New `google-genai` client APIs can vary by version. Try several common interfaces defensively.
                # Some versions provide a module-level `configure` and helpers; others provide a `Client` class.
                if hasattr(genai, "configure"):
                    try:
                        genai.configure(api_key=self.api_key)
                    except Exception:
                        # Some versions accept different config methods  ignore and continue to client creation
                        pass

                resp_text = None

                # Preferred: Client.generate_text(...) pattern
                if hasattr(genai, "Client"):
                    client = genai.Client()
                    response = client.generate_text(model="gemini-2.5-flash", input=prompt)
                    resp_text = getattr(response, "text", None)
                    if not resp_text and getattr(response, "candidates", None):
                        candidates = getattr(response, "candidates", [])
                        if candidates:
                            resp_text = getattr(candidates[0], "output", None) or getattr(candidates[0], "content", None)

                # Fallback: module-level generate_text
                if resp_text is None and hasattr(genai, "generate_text"):
                    response = genai.generate_text(model="gemini-2.5-flash", input=prompt)
                    resp_text = getattr(response, "text", None)
                    if not resp_text and getattr(response, "candidates", None):
                        candidates = getattr(response, "candidates", [])
                        if candidates:
                            resp_text = getattr(candidates[0], "output", None) or getattr(candidates[0], "content", None)

                # Last resort: string conversion
                if resp_text is None:
                    resp_text = str(response)

            else:
                # Legacy package behavior
                genai.configure(api_key=self.api_key)
                model = genai.GenerativeModel('gemini-2.5-flash')
                response = model.generate_content(prompt)
                resp_text = getattr(response, "text", "")

            clean_text = resp_text.replace("```json", "").replace("```", "").strip()
            # Simple token estimation (fallback if client does not provide usage)
            try:
                input_tokens = max(0, len(prompt.split()))
                output_tokens = max(0, len(clean_text.split()))
            except Exception:
                input_tokens = 0
                output_tokens = 0

            # Log usage if syllabus_id provided
            self._log_usage(syllabus_id, 'GENERATE', input_tokens, output_tokens)

            return json.loads(clean_text)
        except Exception as e:
            # Attempt to log error usage with zero tokens (if applicable)
            try:
                self._log_usage(syllabus_id, 'ERROR', 0, 0)
            except Exception:
                pass
            return {"error": str(e)}
</file>

<file path="apps/api/src/services/assessment_clo_service.py">
from typing import List
from infrastructure.repositories.assessment_clo_repository import AssessmentCloRepository

class AssessmentCloService:
    def __init__(self, repository: AssessmentCloRepository, component_repository=None, syllabus_clo_repository=None, assessment_scheme_repository=None):
        self.repository = repository
        self.component_repository = component_repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.assessment_scheme_repository = assessment_scheme_repository

    def get_clos_for_component(self, component_id: int) -> List:
        return self.repository.get_clos_by_component(component_id)

    def add_mapping(self, component_id: int, syllabus_clo_id: int):
        component = self.component_repository.get_by_id(component_id)
        if not component:
            raise ValueError('Invalid component_id')
        syllabus_clo = self.syllabus_clo_repository.get_by_id(syllabus_clo_id)
        if not syllabus_clo:
            raise ValueError('Invalid syllabus_clo_id')

        # Determine the syllabus id for the component (via scheme relationship or scheme repository)
        comp_syllabus_id = None
        if getattr(component, 'scheme', None):
            comp_syllabus_id = component.scheme.syllabus_id
        elif hasattr(component, 'scheme_id'):
            if not self.assessment_scheme_repository:
                raise ValueError('Cannot determine component syllabus without assessment_scheme_repository')
            scheme = self.assessment_scheme_repository.get_by_id(component.scheme_id)
            if not scheme:
                raise ValueError('Invalid component: linked scheme not found')
            comp_syllabus_id = scheme.syllabus_id
        else:
            raise ValueError('Invalid component: cannot resolve related scheme')

        # Ensure both belong to the same syllabus
        if comp_syllabus_id != syllabus_clo.syllabus_id:
            raise ValueError('Cross-reference Error: Component and CLO must belong to the same Syllabus')

        return self.repository.add_mapping(component_id, syllabus_clo_id)

    def remove_mapping(self, component_id: int, syllabus_clo_id: int) -> bool:
        return self.repository.remove_mapping(component_id, syllabus_clo_id)
</file>

<file path="apps/api/src/services/assessment_component_service.py">
from typing import Optional
from infrastructure.repositories.assessment_component_repository import AssessmentComponentRepository

class AssessmentComponentService:
    def __init__(self, repository: AssessmentComponentRepository, scheme_repository=None):
        self.repository = repository
        self.scheme_repository = scheme_repository

    def get_component(self, id: int):
        return self.repository.get_by_id(id)

    def create_component(self, data: dict):
        scheme_id = data.get('scheme_id')
        if not scheme_id or not self.scheme_repository.get_by_id(scheme_id):
            raise ValueError('Invalid scheme_id')
        return self.repository.create(data)

    def update_component(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_component(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/assessment_scheme_service.py">
from typing import List, Optional
from infrastructure.repositories.assessment_scheme_repository import AssessmentSchemeRepository

class AssessmentSchemeService:
    def __init__(self, repository: AssessmentSchemeRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_schemes_for_syllabus(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus_id(syllabus_id)

    def get_scheme(self, id: int):
        return self.repository.get_by_id(id)

    def create_scheme(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_scheme(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_scheme(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/clo_plo_mapping_service.py">
from typing import List
from infrastructure.repositories.clo_plo_mapping_repository import CloPloMappingRepository

class CloPloMappingService:
    def __init__(self, repository: CloPloMappingRepository, syllabus_clo_repository=None, program_outcome_repository=None):
        self.repository = repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.program_outcome_repository = program_outcome_repository

    def get_by_clo(self, clo_id: int) -> List:
        return self.repository.get_by_syllabus_clo(clo_id)

    def create_mapping(self, data: dict):
        clo_id = data.get('syllabus_clo_id')
        plo_id = data.get('program_plo_id')
        
        if not self.syllabus_clo_repository.get_by_id(clo_id):
            raise ValueError('Invalid syllabus_clo_id')
        if not self.program_outcome_repository.get_by_id(plo_id):
            raise ValueError('Invalid program_plo_id')
            
        return self.repository.create(data)

    def delete_mapping(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/department_service.py">
from typing import List, Optional
from infrastructure.repositories.department_repository import DepartmentRepository

class DepartmentService:
    def __init__(self, repository: DepartmentRepository):
        self.repository = repository

    def list_departments(self) -> List:
        return self.repository.get_all()

    def get_department(self, id: int):
        return self.repository.get_by_id(id)

    def create_department(self, data: dict):
        return self.repository.create(data)

    def update_department(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_department(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/faculty_service.py">
from typing import List, Optional
from infrastructure.repositories.faculty_repository import FacultyRepository

class FacultyService:
    def __init__(self, repository: FacultyRepository):
        self.repository = repository

    def list_faculties(self) -> List:
        return self.repository.get_all()

    def get_faculty(self, id: int):
        return self.repository.get_by_id(id)

    def create_faculty(self, data: dict):
        return self.repository.create(data)

    def update_faculty(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_faculty(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/file_service.py">
import os
import uuid
from werkzeug.utils import secure_filename
from infrastructure.repositories.file_repository import FileRepository

UPLOAD_FOLDER = 'static/uploads'
ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx'}

class FileService:
    def __init__(self, repository: FileRepository):
        self.repository = repository
        if not os.path.exists(UPLOAD_FOLDER):
            os.makedirs(UPLOAD_FOLDER)

    def _allowed_file(self, filename):
        return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

    def upload_file(self, file_storage, uploader_id: int):
        if not file_storage or file_storage.filename == '':
            raise ValueError('No file selected')
        if not self._allowed_file(file_storage.filename):
            raise ValueError('File type not allowed')

        filename = secure_filename(file_storage.filename)
        unique_name = f"{uuid.uuid4()}_{filename}"
        file_path = os.path.join(UPLOAD_FOLDER, unique_name)
        
        # Save to disk
        file_storage.save(file_path)

        # Save to DB
        file_data = {
            'uploader_id': uploader_id,
            'file_name': filename,
            'file_path': file_path,
            'mime_type': file_storage.mimetype,
            'file_size': 0 # Optional: implement size check
        }
        return self.repository.create(file_data)
        
    def get_file(self, id: int):
        return self.repository.get_by_id(id)
</file>

<file path="apps/api/src/services/notification_service.py">
from typing import List
from infrastructure.repositories.notification_repository import NotificationRepository

class NotificationService:
    def __init__(self, repository: NotificationRepository, user_repository=None):
        self.repository = repository
        self.user_repository = user_repository

    def get_user_notifications(self, user_id: int, unread_only: bool = False) -> List:
        return self.repository.get_by_user(user_id, unread_only=unread_only)

    def send_notification(self, user_id: int, title: str, message: str, link: str = None, type: str = 'SYSTEM'):
        if self.user_repository and not self.user_repository.get_by_id(user_id):
             raise ValueError('User not found')
        data = {
            'user_id': user_id,
            'title': title,
            'message': message,
            'link': link,
            'type': type,
            'is_read': False
        }
        return self.repository.create(data)

    def mark_read(self, id: int) -> bool:
        return self.repository.mark_as_read(id)

    def mark_all_read(self, user_id: int):
        return self.repository.mark_all_as_read(user_id)
</file>

<file path="apps/api/src/services/program_outcome_service.py">
from typing import List
from infrastructure.repositories.program_outcome_repository import ProgramOutcomeRepository

class ProgramOutcomeService:
    def __init__(self, repository: ProgramOutcomeRepository, program_repository=None):
        self.repository = repository
        self.program_repository = program_repository

    def list_by_program(self, program_id: int) -> List:
        return self.repository.get_by_program_id(program_id)

    def create_plo(self, data: dict):
        program_id = data.get('program_id')
        if not program_id or not self.program_repository.get_by_id(program_id):
            raise ValueError('Invalid program_id')
        return self.repository.create(data)

    def update_plo(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_plo(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/program_service.py">
from typing import List, Optional
from infrastructure.repositories.program_repository import ProgramRepository

class ProgramService:
    def __init__(self, repository: ProgramRepository):
        self.repository = repository

    def list_programs(self) -> List:
        return self.repository.get_all()

    def get_program(self, id: int):
        return self.repository.get_by_id(id)

    def create_program(self, data: dict):
        return self.repository.create(data)

    def update_program(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_program(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/role_service.py">
from typing import List, Optional
from infrastructure.repositories.role_repository import RoleRepository

class RoleService:
    def __init__(self, repository: RoleRepository):
        self.repository = repository

    def list_roles(self) -> List:
        return self.repository.get_all()

    def get_role(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_name(self, name: str):
        return self.repository.get_by_name(name)

    def create_role(self, data: dict):
        return self.repository.create(data)

    def delete_role(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/rubric_service.py">
from typing import List, Optional
from infrastructure.repositories.rubric_repository import RubricRepository

class RubricService:
    def __init__(self, repository: RubricRepository, component_repository=None):
        self.repository = repository
        self.component_repository = component_repository

    def list_rubrics_for_component(self, component_id: int) -> List:
        return self.repository.get_by_component_id(component_id)

    def get_rubric(self, id: int):
        return self.repository.get_by_id(id)

    def create_rubric(self, data: dict):
        component_id = data.get('component_id')
        if not component_id or not self.component_repository.get_by_id(component_id):
            raise ValueError('Invalid component_id')
        return self.repository.create(data)

    def update_rubric(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_rubric(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/student_service.py">
from typing import List
from infrastructure.repositories.student_subscription_repository import StudentSubscriptionRepository
from infrastructure.repositories.student_report_repository import StudentReportRepository

class StudentService:
    def __init__(self, sub_repo: StudentSubscriptionRepository, report_repo: StudentReportRepository):
        self.sub_repo = sub_repo
        self.report_repo = report_repo

    def subscribe(self, user_id: int, subject_id: int):
        return self.sub_repo.create(user_id, subject_id)

    def unsubscribe(self, user_id: int, subject_id: int):
        return self.sub_repo.delete(user_id, subject_id)

    def get_subscriptions(self, user_id: int):
        return self.sub_repo.get_by_student(user_id)

    def report_syllabus(self, user_id: int, syllabus_id: int, content: str):
        return self.report_repo.create({'student_id': user_id, 'syllabus_id': syllabus_id, 'content': content})

    def list_reports(self):
        return self.report_repo.get_all()

    def resolve_report(self, id: int, status: str, note: str = None):
        return self.report_repo.update_status(id, status, note)
</file>

<file path="apps/api/src/services/subject_relationship_service.py">
from typing import List
from infrastructure.repositories.subject_relationship_repository import SubjectRelationshipRepository

class SubjectRelationshipService:
    def __init__(self, repository: SubjectRelationshipRepository, subject_repository=None):
        self.repository = repository
        self.subject_repository = subject_repository

    def get_relationships(self, subject_id: int) -> List:
        return self.repository.get_by_subject(subject_id)

    def add_relationship(self, data: dict):
        subject_id = data.get('subject_id')
        related_id = data.get('related_subject_id')
        
        if subject_id == related_id:
            raise ValueError('Subject cannot be related to itself')
        
        if not self.subject_repository.get_by_id(subject_id):
            raise ValueError('Invalid subject_id')
        if not self.subject_repository.get_by_id(related_id):
            raise ValueError('Invalid related_subject_id')
            
        return self.repository.create(data)

    def remove_relationship(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/subject_service.py">
from typing import List, Optional
from infrastructure.repositories.subject_repository import SubjectRepository

class SubjectService:
    def __init__(self, repository: SubjectRepository):
        self.repository = repository

    def list_subjects(self) -> List:
        return self.repository.get_all()

    def get_subject(self, id: int):
        return self.repository.get_by_id(id)

    def create_subject(self, data: dict):
        return self.repository.create(data)

    def update_subject(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_subject(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_clo_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_clo_repository import SyllabusCloRepository

class SyllabusCloService:
    def __init__(self, repository: SyllabusCloRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_clos(self) -> List:
        return self.repository.get_all()

    def get_clo(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_syllabus(self, syllabus_id: int):
        return self.repository.get_by_syllabus_id(syllabus_id)

    def create_clo(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_clo(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_clo(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_comment_service.py">
from typing import List
from infrastructure.repositories.syllabus_comment_repository import SyllabusCommentRepository

class SyllabusCommentService:
    def __init__(self, repository: SyllabusCommentRepository, syllabus_repository=None, user_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository
        self.user_repository = user_repository

    def get_comments(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus(syllabus_id)

    def add_comment(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        user_id = data.get('user_id')
        
        if not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        if not self.user_repository.get_by_id(user_id):
            raise ValueError('Invalid user_id')
            
        return self.repository.create(data)

    def resolve_comment(self, id: int):
        return self.repository.update(id, {'is_resolved': True})

    def delete_comment(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_material_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_material_repository import SyllabusMaterialRepository

class SyllabusMaterialService:
    def __init__(self, repository: SyllabusMaterialRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_materials(self) -> List:
        return self.repository.get_all()

    def get_material(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_syllabus(self, syllabus_id: int):
        return self.repository.get_by_syllabus_id(syllabus_id)

    def create_material(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def delete_material(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_repository import SyllabusRepository

class SyllabusService:
    def __init__(self, repository: SyllabusRepository,
                 subject_repository=None,
                 program_repository=None,
                 academic_year_repository=None,
                 user_repository=None,
                 workflow_log_repository=None,
                 syllabus_clo_repository=None,
                 syllabus_material_repository=None,
                 teaching_plan_repository=None,
                 assessment_scheme_repository=None,
                 assessment_component_repository=None,
                 rubric_repository=None,
                 assessment_clo_repository=None):
        self.repository = repository
        self.subject_repository = subject_repository
        self.program_repository = program_repository
        self.academic_year_repository = academic_year_repository
        self.user_repository = user_repository
        self.workflow_log_repository = workflow_log_repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.syllabus_material_repository = syllabus_material_repository
        self.teaching_plan_repository = teaching_plan_repository
        self.assessment_scheme_repository = assessment_scheme_repository
        self.assessment_component_repository = assessment_component_repository
        self.rubric_repository = rubric_repository
        self.assessment_clo_repository = assessment_clo_repository

    def list_syllabuses(self) -> List:
        return self.repository.get_all()

    def get_syllabus(self, id: int):
        return self.repository.get_by_id(id)

    def get_syllabus_details(self, id: int):
        return self.repository.get_details(id)

    def get_by_subject(self, subject_id: int):
        return self.repository.get_by_subject_id(subject_id)

    def create_syllabus(self, data: dict):
        import json
        
        # Extract child data
        clos_data = data.pop('clos', [])
        materials_data = data.pop('materials', [])
        plans_data = data.pop('teaching_plans', [])
        schemes_data = data.pop('assessment_schemes', [])

        # Handle time_allocation (Dict -> JSON String)
        if 'time_allocation' in data and isinstance(data['time_allocation'], dict):
            data['time_allocation'] = json.dumps(data['time_allocation'])

        # Validate Foreign Keys
        subject_id = data.get('subject_id')
        if not subject_id or not self.subject_repository.get_by_id(subject_id):
            raise ValueError('Invalid subject_id')
        program_id = data.get('program_id')
        if not program_id or not self.program_repository.get_by_id(program_id):
            raise ValueError('Invalid program_id')
        academic_year_id = data.get('academic_year_id')
        if not academic_year_id or not self.academic_year_repository.get_by_id(academic_year_id):
            raise ValueError('Invalid academic_year_id')
        lecturer_id = data.get('lecturer_id')
        if not lecturer_id or not self.user_repository.get_by_id(lecturer_id):
            raise ValueError('Invalid lecturer_id')

        # Create Header
        data.setdefault('status', 'DRAFT')
        new_syllabus = self.repository.create(data)
        sid = new_syllabus.id

        # 1. Save CLOs
        if self.syllabus_clo_repository:
            for item in clos_data:
                item['syllabus_id'] = sid
                self.syllabus_clo_repository.create(item)

        # 2. Save Materials
        if self.syllabus_material_repository:
            for item in materials_data:
                item['syllabus_id'] = sid
                self.syllabus_material_repository.create(item)

        # 3. Save Teaching Plans
        if self.teaching_plan_repository:
            for item in plans_data:
                item['syllabus_id'] = sid
                self.teaching_plan_repository.create(item)

        # 4. Save Assessment Schemes (Nested)
        if self.assessment_scheme_repository:
            for scheme in schemes_data:
                components = scheme.pop('components', [])
                scheme['syllabus_id'] = sid
                new_scheme = self.assessment_scheme_repository.create(scheme)
                if self.assessment_component_repository:
                    for comp in components:
                        rubrics = comp.pop('rubrics', [])
                        comp['scheme_id'] = new_scheme.id
                        new_comp = self.assessment_component_repository.create(comp)
                        if self.rubric_repository:
                            for rub in rubrics:
                                rub['component_id'] = new_comp.id
                                self.rubric_repository.create(rub)

        return new_syllabus

    def update_syllabus(self, id: int, data: dict):
        # Check current status before allowing update
        s = self.repository.get_by_id(id)
        if not s:
            return None
        if s.status not in ('DRAFT', 'REJECTED'):
            raise ValueError(f"Cannot update syllabus in {s.status} status")
        return self.repository.update(id, data)

    def delete_syllabus(self, id: int) -> bool:
        return self.repository.delete(id)

    # Workflow methods
    def submit_syllabus(self, id: int, user_id: int):
        s = self.repository.get_by_id(id)
        if not s:
            return None
        
        current_status = (s.status or '').upper()
        if current_status not in ('DRAFT', 'REJECTED', 'RETURNED'):
             raise ValueError(f'Syllabus cannot be submitted in current status: {s.status}')
        
        from_status = s.status
        updated = self.repository.update(id, {'status': 'PENDING'})
        if self.workflow_log_repository:
            self.workflow_log_repository.create({
                'syllabus_id': id,
                'actor_id': user_id,
                'action': 'SUBMIT',
                'from_status': from_status,
                'to_status': 'PENDING',
                'comment': None
            })
        return updated

    def evaluate_syllabus(self, id: int, user_id: int, action: str, comment: Optional[str] = None):
        s = self.repository.get_by_id(id)
        if not s:
            return None
        action = action.upper()
        if action not in ('APPROVE', 'REJECT'):
            raise ValueError('Invalid action')
        from_status = s.status
        if action == 'APPROVE':
            new_status = 'APPROVED'
        else:  # REJECT
            if not comment:
                raise ValueError('Comment is required when rejecting')
            new_status = 'DRAFT'
        updated = self.repository.update(id, {'status': new_status})
        if self.workflow_log_repository:
            self.workflow_log_repository.create({
                'syllabus_id': id,
                'actor_id': user_id,
                'action': action,
                'from_status': from_status,
                'to_status': new_status,
                'comment': comment
            })
        return updated

    def get_workflow_logs(self, syllabus_id: int):
        if not self.workflow_log_repository:
            return []
        return self.workflow_log_repository.get_by_syllabus_id(syllabus_id)
</file>

<file path="apps/api/src/services/system_setting_service.py">
from typing import List, Optional
from infrastructure.repositories.system_setting_repository import SystemSettingRepository

class SystemSettingService:
    def __init__(self, repository: SystemSettingRepository):
        self.repository = repository

    def get_all_settings(self) -> List:
        return self.repository.get_all()

    def update_setting(self, key: str, value: str, description: str = None):
        return self.repository.set_value(key, value, description)
</file>

<file path="apps/api/src/services/teaching_plan_service.py">
from typing import List, Optional
from infrastructure.repositories.teaching_plan_repository import TeachingPlanRepository

class TeachingPlanService:
    def __init__(self, repository: TeachingPlanRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_plans_for_syllabus(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus_id(syllabus_id)

    def get_plan(self, id: int):
        return self.repository.get_by_id(id)

    def create_teaching_plan(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_teaching_plan(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_teaching_plan(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/user_service.py">
from typing import List, Optional
from werkzeug.security import generate_password_hash, check_password_hash
from infrastructure.repositories.user_repository import UserRepository

class UserService:
    def __init__(self, repository: UserRepository):
        self.repository = repository

    def list_users(self) -> List:
        return self.repository.get_all()

    def get_user(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_username(self, username: str):
        return self.repository.get_by_username(username)

    def create_user(self, data: dict):
        # Hash password before saving
        if 'password' in data:
            data['password_hash'] = generate_password_hash(data.pop('password'))
        return self.repository.create(data)

    def update_user(self, id: int, data: dict):
        if 'password' in data:
            data['password_hash'] = generate_password_hash(data.pop('password'))
        return self.repository.update(id, data)

    def delete_user(self, id: int) -> bool:
        return self.repository.delete(id)

    def authenticate(self, username: str, password: str):
        user = self.get_by_username(username)
        if not user:
            return None
        if not check_password_hash(user.password_hash, password):
            return None
        return user
</file>

<file path="apps/api/src/swagger_config.json">
{
    "template": {
        "swagger": "2.0",
        "info": {
            "title": "Syllabus Management API",
            "description": "API for Syllabus Management (SMD)",
            "version": "1.0.0"
        },
        "basePath": "/",
        "schemes": [
            "http",
            "https"
        ],
        "consumes": [
            "application/json"
        ],
        "produces": [
            "application/json"
        ]
    },
    "swagger_config": {
        "headers": [],
        "specs": [
            {
                "endpoint": "apispec",
                "route": "/apispec.json"
            }
        ],
        "static_url_path": "/flasgger_static",
        "swagger_ui": true,
        "specs_route": "/docs"
    }
}
</file>

<file path="apps/api/src/tests/test_file_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

import os
import tempfile
from services.file_service import FileService, UPLOAD_FOLDER

class StubFileStorage:
    def __init__(self, filename, content=b"data", mimetype='application/octet-stream'):
        self.filename = filename
        self._content = content
        self.mimetype = mimetype

    def save(self, path):
        with open(path, 'wb') as f:
            f.write(self._content)


class StubRepo:
    def __init__(self):
        self.created = None
    def create(self, data):
        self.created = data
        class Item:
            def __init__(self, d):
                self.__dict__.update(d)
        return Item(data)


def test_upload_file_saves_to_disk_and_db(tmp_path, monkeypatch):
    # Use a temp upload folder
    tmp_dir = tmp_path / 'uploads'
    monkeypatch.setattr('services.file_service.UPLOAD_FOLDER', str(tmp_dir))

    repo = StubRepo()
    svc = FileService(repository=repo)

    file_storage = StubFileStorage('test.txt', b'hello', 'text/plain')
    record = svc.upload_file(file_storage, uploader_id=5)

    # Ensure file saved on disk
    assert os.path.exists(record.file_path)
    assert repo.created['uploader_id'] == 5
    assert repo.created['file_name'] == 'test.txt'


def test_upload_rejects_bad_extension():
    repo = StubRepo()
    svc = FileService(repository=repo)
    file_storage = StubFileStorage('test.exe')
    try:
        svc.upload_file(file_storage, uploader_id=1)
        assert False, 'Should raise ValueError for disallowed extension'
    except ValueError:
        pass
</file>

<file path="apps/api/src/tests/test_program_outcome_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

from services.program_outcome_service import ProgramOutcomeService

class StubRepo:
    def __init__(self):
        self.created = {}
    def create(self, data):
        self.created = data
        return data
    def update(self, id, data):
        return {'id': id, **data}
    def delete(self, id):
        return True

class StubProgramRepo:
    def __init__(self, exists=True):
        self.exists = exists
    def get_by_id(self, id):
        return {'id': id} if self.exists else None


def test_create_plo_requires_valid_program():
    repo = StubRepo()
    program_repo = StubProgramRepo(exists=False)
    svc = ProgramOutcomeService(repository=repo, program_repository=program_repo)
    try:
        svc.create_plo({'program_id': 1, 'code': 'PLO1', 'description': 'd'})
        assert False, 'Should have raised ValueError'
    except ValueError:
        pass

    program_repo = StubProgramRepo(exists=True)
    svc = ProgramOutcomeService(repository=repo, program_repository=program_repo)
    item = svc.create_plo({'program_id': 1, 'code': 'PLO1', 'description': 'd'})
    assert repo.created['code'] == 'PLO1'


def test_update_and_delete_delegates_to_repo():
    repo = StubRepo()
    svc = ProgramOutcomeService(repository=repo)
    updated = svc.update_plo(1, {'code': 'X'})
    assert updated['id'] == 1
    assert svc.delete_plo(1) is True
</file>

<file path="apps/api/src/tests/test_smoke_imports.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

from dependency_container import Container
from services.syllabus_service import SyllabusService
from services.program_outcome_service import ProgramOutcomeService
from services.file_service import FileService


def test_container_has_services():
    c = Container()
    assert hasattr(c, 'syllabus_service')
    assert hasattr(c, 'program_outcome_service')
    assert hasattr(c, 'file_service')


def test_service_classes_importable():
    assert callable(SyllabusService)
    assert callable(ProgramOutcomeService)
    assert callable(FileService)
</file>

<file path="apps/api/src/tests/test_syllabus_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

import json
from services.syllabus_service import SyllabusService


class StubRepo:
    def __init__(self):
        self.created = []

    def create(self, data):
        # simulate DB model with id and status
        class Item:
            pass
        item = Item()
        item.id = 123
        item.status = data.get('status', 'DRAFT')
        self.created.append(data)
        return item

    def get_by_id(self, id):
        return None


class StubFKRepo:
    def __init__(self, exists=True):
        self.exists = exists

    def get_by_id(self, id):
        return {'id': id} if self.exists else None


class StubChildRepo:
    def __init__(self):
        self.items = []

    def create(self, data):
        self.items.append(data)
        class Item:
            def __init__(self, data, id):
                self.__dict__.update(data)
                self.id = id
        return Item(data, len(self.items))


def test_create_syllabus_creates_child_entities_and_serializes_time_allocation():
    repo = StubRepo()
    subj = StubFKRepo(True)
    prog = StubFKRepo(True)
    ay = StubFKRepo(True)
    user = StubFKRepo(True)
    clo_repo = StubChildRepo()
    mat_repo = StubChildRepo()
    plan_repo = StubChildRepo()
    scheme_repo = StubChildRepo()
    comp_repo = StubChildRepo()
    rubric_repo = StubChildRepo()

    svc = SyllabusService(
        repository=repo,
        subject_repository=subj,
        program_repository=prog,
        academic_year_repository=ay,
        user_repository=user,
        syllabus_clo_repository=clo_repo,
        syllabus_material_repository=mat_repo,
        teaching_plan_repository=plan_repo,
        assessment_scheme_repository=scheme_repo,
        assessment_component_repository=comp_repo,
        rubric_repository=rubric_repo
    )

    payload = {
        'subject_id': 1,
        'program_id': 1,
        'academic_year_id': 1,
        'lecturer_id': 1,
        'time_allocation': {'theory': 10, 'practice': 20},
        'clos': [{'code': 'C1', 'description': 'desc'}],
        'materials': [{'type': 'MAIN', 'title': 't'}],
        'teaching_plans': [{'week': 1, 'topic': 't'}],
        'assessment_schemes': [
            {
                'name': 'Scheme1',
                'weight': 50,
                'components': [
                    {'name': 'Comp1', 'weight': 100, 'rubrics': [{'criteria': 'r', 'max_score': 10}]}
                ]
            }
        ]
    }

    result = svc.create_syllabus(payload.copy())
    # header created
    assert result.id == 123
    # child repos created
    assert len(clo_repo.items) == 1
    assert len(mat_repo.items) == 1
    assert len(plan_repo.items) == 1
    assert len(scheme_repo.items) == 1
    assert len(comp_repo.items) == 1
    assert len(rubric_repo.items) == 1

    # ensure time_allocation was serialized as JSON in the header create payload
    header_payload = repo.created[0]
    assert isinstance(header_payload['time_allocation'], str)
    parsed = json.loads(header_payload['time_allocation'])
    assert parsed['theory'] == 10


def test_submit_syllabus_allows_returned_case_insensitive():
    class GetRepo:
        def __init__(self, status):
            class Item:
                pass
            self.item = Item()
            self.item.status = status
        def get_by_id(self, id):
            return self.item
        def update(self, id, data):
            return data

    for status in ['returned', 'RETURNED', 'Returned']:
        repo = GetRepo(status)
        svc = SyllabusService(repository=repo)
        updated = svc.submit_syllabus(1, 2)
        assert updated == {'status': 'PENDING'}
</file>

<file path="apps/api/tests/e2e_test_flow.py">
"""End-to-end happy-path test for Syllabus Management System

Run this script directly (python tests/e2e_test_flow.py).
Requires: requests, colorama

It will stop immediately and print an error in red if any step returns an unexpected status code.
"""

import sys
import time
import uuid
from datetime import date

import requests
import json
try:
    from colorama import Fore, Style, init as colorama_init
except Exception:
    print("Please install 'colorama' (pip install colorama) to run this script.")
    sys.exit(2)

colorama_init(autoreset=True)

BASE_URL = 'http://localhost:9999'


def log(step: str, message: str, status: str = 'INFO'):
    """Nicely print a log line.

    status: INFO, OK, FAIL
    """
    status = status.upper()
    if status == 'OK':
        color = Fore.GREEN
    elif status == 'FAIL':
        color = Fore.RED
    else:
        color = Fore.CYAN
    print(f"[{color}{status}{Style.RESET_ALL}] {step} - {message}")


def fail(step: str, message: str, resp=None):
    log(step, message, 'FAIL')
    if resp is not None:
        try:
            print(Fore.RED + resp.text)
        except Exception:
            pass
    sys.exit(1)


def expect_status(step: str, resp: requests.Response, expected: int):
    if resp.status_code != expected:
        fail(step, f"Expected HTTP {expected}, got {resp.status_code}", resp)
    log(step, f"HTTP {resp.status_code}", 'OK')


def post(path: str, json: dict, token: str = None):
    headers = {'Content-Type': 'application/json'}
    if token:
        headers['Authorization'] = f'Bearer {token}'
    return requests.post(BASE_URL + path, json=json, headers=headers)


def get(path: str, token: str = None):
    headers = {}
    if token:
        headers['Authorization'] = f'Bearer {token}'
    return requests.get(BASE_URL + path, headers=headers)


def run():
    # Step 1: Login admin
    step = '1. Login Admin'
    payload = {'username': 'admin', 'password': 'password123'}
    resp = post('/auth/login', payload)
    expect_status(step, resp, 200)
    token = resp.json().get('token')
    if not token:
        fail(step, 'No token returned', resp)
    log(step, 'Obtained token', 'OK')

    # Helper to generate short unique strings
    uid = str(uuid.uuid4())[:8]

    # Step 2: Create Faculty
    step = '2. Create Faculty'
    payload = {'code': f'E2E-FAC-{uid}', 'name': 'E2E Faculty'}
    resp = post('/faculties/', payload, token=token)
    expect_status(step, resp, 201)
    faculty_id = resp.json().get('id')

    # Step 3: Create Department
    step = '3. Create Department'
    payload = {'faculty_id': faculty_id, 'code': f'E2E-DEP-{uid}', 'name': 'E2E Department'}
    resp = post('/departments/', payload, token=token)
    expect_status(step, resp, 201)
    department_id = resp.json().get('id')

    # Step 4: Create Program
    step = '4. Create Program'
    payload = {'department_id': department_id, 'name': f'E2E Program {uid}', 'total_credits': 120}
    resp = post('/programs/', payload, token=token)
    expect_status(step, resp, 201)
    program_id = resp.json().get('id')

    # Step 5: Create Academic Year
    step = '5. Create Academic Year'
    payload = {'code': f'AY-{uid}', 'start_date': date.today().isoformat(), 'end_date': (date.today().replace(year=date.today().year + 1)).isoformat()}
    resp = post('/academic-years/', payload, token=token)
    expect_status(step, resp, 201)
    academic_year_id = resp.json().get('id')

    # Step 6: Create Lecturer (User)
    step = '6. Create Lecturer User'
    username = f'e2e_user_{uid}'
    payload = {'username': username, 'email': f'{username}@example.com', 'full_name': 'E2E Lecturer', 'password': 'pass1234'}
    resp = post('/users/', payload, token=token)
    expect_status(step, resp, 201)
    lecturer_id = resp.json().get('id')

    # Step 7: Create Subject
    step = '7. Create Subject'
    payload = {'department_id': department_id, 'code': f'E2E-SUB-{uid}', 'name_vi': 'E2E Mn hc', 'name_en': 'E2E Subject', 'credits': 3}
    resp = post('/subjects/', payload, token=token)
    expect_status(step, resp, 201)
    subject_id = resp.json().get('id')

    # Step 8: Create Syllabus (Draft)
    step = '8. Create Syllabus (Draft)'
    payload = {'subject_id': subject_id, 'program_id': program_id, 'academic_year_id': academic_year_id, 'lecturer_id': lecturer_id}
    resp = post('/syllabuses/', payload, token=token)
    expect_status(step, resp, 201)
    syllabus = resp.json()
    syllabus_id = syllabus.get('id')
    if syllabus.get('status') and syllabus.get('status') != 'DRAFT':
        fail(step, f"Expected status DRAFT, got {syllabus.get('status')}")

    # Step 9: Add CLO
    step = '9. Add CLO'
    payload = {'syllabus_id': syllabus_id, 'code': 'CLO-1', 'description': 'Understand basics of E2E.'}
    resp = post('/syllabus-clos/', payload, token=token)
    expect_status(step, resp, 201)
    clo_id = resp.json().get('id')

    # Step 10: Add Assessment Scheme
    step = '10. Add Assessment Scheme'
    payload = {'syllabus_id': syllabus_id, 'name': 'Progress Test', 'weight': 50}
    resp = post('/assessment-schemes/', payload, token=token)
    expect_status(step, resp, 201)
    scheme_id = resp.json().get('id')

    # Step 11: Add Assessment Component
    step = '11. Add Assessment Component'
    payload = {'scheme_id': scheme_id, 'name': 'Quiz 1', 'weight': 10}
    resp = post('/assessment-components/', payload, token=token)
    expect_status(step, resp, 201)
    component_id = resp.json().get('id')

    # Step 12: Map CLO to Component
    step = '12. Map CLO to Component'
    payload = {'assessment_component_id': component_id, 'syllabus_clo_id': clo_id}
    resp = post('/assessment-clos/', payload, token=token)
    expect_status(step, resp, 201)

    # Step 13: Verify Details
    step = '13. Verify Details'
    resp = get(f'/syllabuses/{syllabus_id}/details', token=token)
    expect_status(step, resp, 200)
    detail = resp.json()
    # Debug: dump details
    try:
        print(Fore.CYAN + json.dumps(detail, indent=2, ensure_ascii=False))
    except Exception:
        pass
    # Check CLO presence
    clos = detail.get('clos', [])
    if not any(c.get('id') == clo_id for c in clos):
        fail(step, 'CLO not found in syllabus details')
    # Check component presence inside assessment_schemes
    # API returns camelCase via BaseSchema; support both for robustness
    schemes = detail.get('assessmentSchemes') or detail.get('assessment_schemes', [])
    found_comp = False
    for s in schemes:
        for c in s.get('components', []):
            if c.get('id') == component_id:
                found_comp = True
                break
        if found_comp:
            break
    if not found_comp:
        fail(step, 'Component not found in syllabus details')
    log(step, 'CLO and Component found in syllabus details', 'OK')

    # Step 14: Submit Syllabus
    step = '14. Submit Syllabus'
    payload = {'user_id': lecturer_id}
    resp = post(f'/syllabuses/{syllabus_id}/submit', payload, token=token)
    expect_status(step, resp, 200)
    s = resp.json()
    if s.get('status') != 'PENDING':
        fail(step, f"Expected status PENDING, got {s.get('status')}")

    # Step 15: Approve Syllabus
    step = '15. Approve Syllabus'
    payload = {'action': 'APPROVE', 'user_id': lecturer_id}
    resp = post(f'/syllabuses/{syllabus_id}/evaluate', payload, token=token)
    expect_status(step, resp, 200)
    s = resp.json()
    if s.get('status') != 'APPROVED':
        fail(step, f"Expected status APPROVED, got {s.get('status')}")

    log('E2E', f'Successfully completed happy-path for syllabus {syllabus_id}', 'OK')


if __name__ == '__main__':
    try:
        run()
    except requests.exceptions.ConnectionError as e:
        print(Fore.RED + 'Failed to connect to API at ' + BASE_URL)
        print(str(e))
        sys.exit(2)
</file>

<file path="apps/web/lib/apiClient.ts">
export const API_BASE = process.env.NEXT_PUBLIC_API_URL || "http://localhost:9999";

function isPlainObject(value: any) {
  return Object.prototype.toString.call(value) === "[object Object]";
}

function toSnakeCase(str: string) {
  return str.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);
}

function convertKeysToSnake(obj: any): any {
  if (Array.isArray(obj)) return obj.map(convertKeysToSnake);
  if (!isPlainObject(obj)) return obj;
  const out: any = {};
  for (const key of Object.keys(obj)) {
    const snakeKey = toSnakeCase(key);
    out[snakeKey] = convertKeysToSnake((obj as any)[key]);
  }
  return out;
}

export async function apiFetch(path: string, opts: {
  method?: string;
  body?: any;
  headers?: Record<string, string>;
  snake?: boolean; // convert body keys to snake_case when true (default for POST/PUT/PATCH)
} = {}) {
  const url = path.startsWith("http") ? path : `${API_BASE}${path.startsWith("/") ? path : `/${path}`}`;
  const token = (typeof window !== "undefined") ? localStorage.getItem("access_token") : null;

  const method = (opts.method || "GET").toUpperCase();
  const headers: Record<string, string> = {
    "Accept": "application/json",
    ...(opts.headers || {}),
  };

  if (token) headers["Authorization"] = `Bearer ${token}`;

  let body: any = undefined;
  if (opts.body !== undefined) {
    // If body is already a string, assume caller serialized it intentionally
    if (typeof opts.body === "string") {
      body = opts.body;
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    } else {
      const shouldSnake = opts.snake !== undefined ? opts.snake : (method === "POST" || method === "PUT" || method === "PATCH");
      const payload = shouldSnake ? convertKeysToSnake(opts.body) : opts.body;
      body = JSON.stringify(payload);
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    }
  }

  const res = await fetch(url, { method, headers, body });
  // If possible, parse JSON, else throw
  const text = await res.text();
  let json: any = null;
  try { json = text ? JSON.parse(text) : null; } catch (e) { /* not json */ }

  if (!res.ok) {
    const err: any = new Error(json?.detail || `Request failed: ${res.status}`);
    (err as any).status = res.status;
    (err as any).data = json;
    throw err;
  }

  return json;
}
</file>

<file path="apps/web/lib/axios.ts">
import axios, { AxiosRequestConfig, InternalAxiosRequestConfig } from "axios";

export const API_BASE = process.env.NEXT_PUBLIC_API_URL || "http://localhost:9999";

function isPlainObject(value: any) {
  return Object.prototype.toString.call(value) === "[object Object]";
}

function toSnakeCase(str: string) {
  return str.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);
}

function convertKeysToSnake(obj: any): any {
  if (Array.isArray(obj)) return obj.map(convertKeysToSnake);
  if (!isPlainObject(obj)) return obj;
  const out: any = {};
  for (const key of Object.keys(obj)) {
    const snakeKey = toSnakeCase(key);
    out[snakeKey] = convertKeysToSnake((obj as any)[key]);
  }
  return out;
}

// Extend InternalAxiosRequestConfig to support skipSnake option
export interface CustomAxiosRequestConfig extends InternalAxiosRequestConfig<any> {
  skipSnake?: boolean;
}

const instance = axios.create({
  baseURL: API_BASE,
  headers: { Accept: "application/json" },
});

// Request interceptor: attach Authorization and convert body keys to snake_case
instance.interceptors.request.use((config: CustomAxiosRequestConfig) => {
  try {
    // Attach token if in browser
    if (typeof window !== "undefined") {
      const token = localStorage.getItem("access_token");
      if (token) (config.headers as any)["Authorization"] = `Bearer ${token}`;
    }

    const method = (config.method || "get").toLowerCase();
    const shouldSnake = config.skipSnake === true ? false : (method === "post" || method === "put" || method === "patch");

    if (shouldSnake && config.data && isPlainObject(config.data)) {
      config.data = convertKeysToSnake(config.data);
    }
  } catch (e) {
    // ignore
    console.error("axios request interceptor error", e);
  }
  return config;
});

// Response interceptor: pass through (backend returns camelCase per contract)
instance.interceptors.response.use(
  (res) => res,
  (err) => {
    return Promise.reject(err);
  }
);

export default instance;
</file>

<file path="apps/web/scripts/test_api.js">
(async () => {
  const base = process.env.API_BASE || 'http://localhost:9999';
  console.log('Testing API at', base);
  try {
    const loginRes = await fetch(`${base}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: 'admin', password: '123456' }),
    });

    let loginBody = null;
    try { loginBody = await loginRes.json(); } catch (e) { /* ignore */ }
    console.log('LOGIN status=', loginRes.status);
    console.log('LOGIN body=', loginBody);

    if (loginBody && loginBody.access_token) {
      const token = loginBody.access_token;
      const meRes = await fetch(`${base}/users/me`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      let meBody = null;
      try { meBody = await meRes.json(); } catch (e) { /* ignore */ }
      console.log('/users/me status=', meRes.status);
      console.log('/users/me body=', meBody);
    } else {
      console.log('No access_token returned from login. Cannot test /users/me.');
    }
  } catch (err) {
    console.error('Error during API test:', err);
  }
})();
</file>

<file path=".gitignore">
# # See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# # dependencies
# /node_modules
# /.pnp
# .pnp.*
# .yarn/*
# !.yarn/patches
# !.yarn/plugins
# !.yarn/releases
# !.yarn/versions

# # testing
# /coverage

# # next.js
# /.next/
# /out/

# # production
# /build

# # misc
# .DS_Store
# *.pem

# # debug
# npm-debug.log*
# yarn-debug.log*
# yarn-error.log*
# .pnpm-debug.log*

# # env files (can opt-in for committing if needed)
# .env

# # vercel
# .vercel

# # typescript
# *.tsbuildinfo
# next-env.d.ts


# --- General ---
.DS_Store
.vscode/
.idea/

# --- Python / Backend ---
__pycache__/
*.py[cod]
*$py.class
venv/
.venv/
env/
*.db
*.sqlite3
.env
.env.local

# --- Node.js / Frontend ---
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*
.next/
out/
build/
dist/
.vercel/

# --- Docker ---
*.log
</file>

<file path="apps/web/app/(auth)/login/page.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { AlertCircle } from "lucide-react";
import axios from "@/lib/axios";

export default function LoginPage() {
  const router = useRouter();
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    try {
      // Use API client and backend contract: POST /auth/login with JSON
      const res = await axios.post("/auth/login", { username, password }, { skipSnake: true } as any);
      const data = res.data;

      // Save tokens as specified by contract
      if (data.access_token) localStorage.setItem("access_token", data.access_token);
      if (data.refresh_token) localStorage.setItem("refresh_token", data.refresh_token);

      // Fetch user info to get role
      try {
        const userRes = await axios.get("/users/me");
        const user = userRes.data;
        if (user?.role) localStorage.setItem("role", user.role);
        if (user?.role === "Student") router.push("/portal");
        else router.push("/");
      } catch (e) {
        // If user info not available, fallback to homepage
        router.push("/");
      }
    
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-slate-50">
      {/* I BORDER TOP COLOR */}
      <Card className="w-full max-w-md shadow-xl border-t-4 border-t-teal-600">
        <CardHeader className="text-center pb-2">
          {/* I MU ICON NN */}
          <div className="mx-auto w-12 h-12 bg-teal-50 rounded-lg flex items-center justify-center mb-4">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-teal-600"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
          </div>
          <CardTitle className="text-2xl font-bold text-slate-800">ng nhp H thng</CardTitle>
          <p className="text-sm text-slate-500">Syllabus Management System</p>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleLogin} className="space-y-4">
            {error && (
                <div className="flex items-center gap-2 text-red-600 bg-red-50 p-3 rounded-md text-sm border border-red-100">
                    <AlertCircle className="w-4 h-4" /> {error}
                </div>
            )}
            
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">Tn ng nhp</label>
              <Input 
                value={username} 
                onChange={(e) => setUsername(e.target.value)} 
                placeholder="V d: gv1, hod1, sv1..." 
                required 
                className="h-10"
              />
            </div>
            
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">Mt khu</label>
              <Input 
                type="password" 
                value={password} 
                onChange={(e) => setPassword(e.target.value)} 
                placeholder="" 
                required 
                className="h-10"
              />
            </div>

            {/* I MU NT SUBMIT */}
            <Button type="submit" className="w-full bg-teal-600 hover:bg-teal-700 h-10 text-base" disabled={loading}>
              {loading ? "ang x l..." : "ng nhp"}
            </Button>

            <div className="text-xs text-center text-slate-400 mt-6 pt-4 border-t">
                <p className="mb-1 font-semibold">Ti khon mc nh:</p>
                Admin: <b>admin</b> | Trng b mn: <b>hod1</b><br/>
                Ging vin: <b>gv1</b> | Sinh vin: <b>sv1</b> <br/>
                Phng o to: <b>aa1</b> <br/>
                (Mt khu chung: 123456)
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/logs/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card } from "@/components/ui/card";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { FileClock, Loader2, RefreshCcw } from "lucide-react";
import { Button } from "@/components/ui/button";

interface Log {
  id: number;
  timestamp: string;
  username: string;
  action: string;
  details: string;
}

export default function SystemLogsPage() {
  const [logs, setLogs] = useState<Log[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchLogs = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/admin/logs?limit=50');
      const data = res.data;
      setLogs(data || []);
    } catch (e: any) {
      const status = e?.response?.status || e?.status;
      if (status === 403) alert("Bn khng c quyn truy cp!");
      else console.error(e);
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchLogs(); }, []);

  const getActionColor = (action: string) => {
      if (action === "LOGIN") return "bg-blue-100 text-blue-700 border-blue-200";
      if (action.includes("DELETE")) return "bg-red-100 text-red-700 border-red-200";
      if (action.includes("APPROVE")) return "bg-green-100 text-green-700 border-green-200";
      if (action.includes("CREATE")) return "bg-purple-100 text-purple-700 border-purple-200";
      return "bg-gray-100 text-gray-700";
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                <FileClock className="w-6 h-6 text-orange-600"/> Nht k H thng
            </h2>
            <p className="text-sm text-muted-foreground mt-1">Theo di hot ng ca ngi dng (50 bn ghi gn nht)</p>
        </div>
        <Button variant="outline" onClick={fetchLogs}><RefreshCcw className="w-4 h-4 mr-2"/> Lm mi</Button>
      </div>

      <Card>
        <Table>
            <TableHeader>
                <TableRow>
                    <TableHead className="w-[180px]">Thi gian</TableHead>
                    <TableHead>Ngi thc hin</TableHead>
                    <TableHead>Hnh ng</TableHead>
                    <TableHead>Chi tit</TableHead>
                </TableRow>
            </TableHeader>
            <TableBody>
                {loading ? (
                    <TableRow><TableCell colSpan={4} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ang ti d liu...</TableCell></TableRow>
                ) : logs.length === 0 ? (
                    <TableRow><TableCell colSpan={4} className="text-center h-24 text-muted-foreground">Cha c nht k no.</TableCell></TableRow>
                ) : (
                    logs.map(log => (
                        <TableRow key={log.id}>
                            <TableCell className="text-xs text-gray-500 font-mono">
                                {new Date(log.timestamp).toLocaleString('vi-VN')}
                            </TableCell>
                            <TableCell className="font-bold text-sm">{log.username}</TableCell>
                            <TableCell>
                                <Badge variant="outline" className={getActionColor(log.action)}>
                                    {log.action}
                                </Badge>
                            </TableCell>
                            <TableCell className="text-sm text-gray-600">{log.details}</TableCell>
                        </TableRow>
                    ))
                )}
            </TableBody>
        </Table>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/settings/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { CheckCircle, Settings, Plus, Loader2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface AcademicYear {
  id: number;
  code: string;
  name: string;
  is_active: boolean;
}

export default function SettingsPage() {
  const [years, setYears] = useState<AcademicYear[]>([]);
  const [loading, setLoading] = useState(true);
  const [newYear, setNewYear] = useState({ code: "", name: "" });

  const fetchYears = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/admin/academic-years');
      const data = res.data;
      setYears(data || []);
    } catch (e) { console.error(e); } 
    finally { setLoading(false); }
  };

  useEffect(() => { fetchYears(); }, []);

  const handleCreate = async () => {
    if (!newYear.code || !newYear.name) return alert("Vui lng nhp  thng tin");
    try {
      await axios.post('/admin/academic-years', { code: newYear.code, name: newYear.name });
      alert("Thm thnh cng!");
      setNewYear({ code: "", name: "" });
      fetchYears();
    } catch (e: any) { const message = e?.response?.data?.detail || e?.message || "Li kt ni"; alert("Li: " + message); }
  };

  const handleActivate = async (id: number) => {
      try {
          await axios.post(`/admin/academic-years/${id}/activate`);
          alert(" kch hot nm hc mi!");
          fetchYears();
          // Reload trang  Header cp nht li
          window.location.reload();
      } catch(e: any) { const message = e?.response?.data?.detail || e?.message || "Li kt ni"; alert("Li: " + message); }
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
            <Settings className="w-6 h-6 text-slate-700"/> Cu hnh H thng
        </h2>
        <p className="text-sm text-muted-foreground mt-1">Qun l nm hc v cc tham s h thng.</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* FORM THM MI */}
        <Card className="md:col-span-1 h-fit">
            <CardHeader><CardTitle>Thm Nm hc mi</CardTitle></CardHeader>
            <CardContent className="space-y-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">M Nm hc (Code)</label>
                    <Input placeholder="2026-2027" value={newYear.code} onChange={e => setNewYear({...newYear, code: e.target.value})} />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Tn hin th</label>
                    <Input placeholder="Nm hc 2026 - 2027" value={newYear.name} onChange={e => setNewYear({...newYear, name: e.target.value})} />
                </div>
                <Button className="w-full mt-2" onClick={handleCreate}>
                    <Plus className="w-4 h-4 mr-2"/> Thm mi
                </Button>
            </CardContent>
        </Card>

        {/* DANH SCH */}
        <Card className="md:col-span-2">
            <CardHeader><CardTitle>Danh sch Nm hc</CardTitle></CardHeader>
            <CardContent>
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>Code</TableHead>
                            <TableHead>Tn hin th</TableHead>
                            <TableHead>Trng thi</TableHead>
                            <TableHead className="text-right">Hnh ng</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {loading ? (
                            <TableRow><TableCell colSpan={4} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ang ti...</TableCell></TableRow>
                        ) : years.map(y => (
                            <TableRow key={y.id} className={y.is_active ? "bg-green-50" : ""}>
                                <TableCell className="font-mono font-bold">{y.code}</TableCell>
                                <TableCell>{y.name}</TableCell>
                                <TableCell>
                                    {y.is_active ? (
                                        <Badge className="bg-green-600 hover:bg-green-700">ang kch hot</Badge>
                                    ) : (
                                        <Badge variant="outline">Khng hot ng</Badge>
                                    )}
                                </TableCell>
                                <TableCell className="text-right">
                                    {!y.is_active && (
                                        <Button size="sm" variant="outline" onClick={() => handleActivate(y.id)}>
                                            <CheckCircle className="w-4 h-4 mr-2 text-green-600"/> Kch hot
                                        </Button>
                                    )}
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/users/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Trash2, Plus, Users, Loader2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface User {
  id: number;
  username: string;
  full_name: string;
  role: string;
}

export default function UserManagementPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  const [open, setOpen] = useState(false); // Modal state

  // Form state
  const [formData, setFormData] = useState({ username: "", password: "", full_name: "", role: "Lecturer" });

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/admin/users');
      const data = res.data;
      setUsers(data || []);
    } catch (e: any) {
      const status = e?.response?.status || e?.status;
      if (status === 403) alert("Bn khng c quyn truy cp trang ny!");
      else console.error(e);
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchUsers(); }, []);

  const handleCreate = async () => {
    if (!formData.username || !formData.password) return alert("Vui lng nhp  thng tin!");
    try {
        await axios.post('/admin/users', { username: formData.username, password: formData.password, fullName: formData.full_name, role: formData.role });
        alert("To ti khon thnh cng!");
        setOpen(false);
        setFormData({ username: "", password: "", full_name: "", role: "Lecturer" });
        fetchUsers();
    } catch (e: any) { const message = e?.response?.data?.detail || e?.message || "Li kt ni server"; alert("Li: " + message); }
  };

  const handleDelete = async (id: number) => {
      if (!confirm("Hnh ng ny khng th hon tc. Bn chc chn mun xa user ny?")) return;
      try {
          await axios.delete(`/admin/users/${id}`);
          alert(" xa thnh cng!");
          fetchUsers();
      } catch (e: any) { const message = e?.response?.data?.detail || e?.message; alert("Li: " + message); }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                <Users className="w-6 h-6 text-blue-600"/> Qun tr Ngi dng
            </h2>
            <p className="text-sm text-muted-foreground mt-1">Qun l danh sch ti khon truy cp h thng</p>
        </div>
        
        {/* MODAL THM USER */}
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button className="bg-blue-600 hover:bg-blue-700">
                    <Plus className="w-4 h-4 mr-2"/> Thm ti khon
                </Button>
            </DialogTrigger>
            <DialogContent>
                <DialogHeader><DialogTitle>To ti khon mi</DialogTitle></DialogHeader>
                <div className="space-y-4 py-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">H v tn</label>
                        <Input value={formData.full_name} onChange={e => setFormData({...formData, full_name: e.target.value})} placeholder="VD: Nguyn Vn A" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Username</label>
                            <Input value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} placeholder="VD: gv_moi" />
                        </div>
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Password</label>
                            <Input value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="******" />
                        </div>
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Vai tr</label>
                        <select 
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background"
                            value={formData.role} 
                            onChange={e => setFormData({...formData, role: e.target.value})}
                        >
                            <option value="Lecturer">Ging vin (Lecturer)</option>
                            <option value="Head of Dept">Trng b mn (Head of Dept)</option>
                            <option value="Student">Sinh vin (Student)</option>
                            <option value="Admin">Qun tr vin (Admin)</option>
                        </select>
                    </div>
                    <Button className="w-full mt-4 bg-blue-600 hover:bg-blue-700" onClick={handleCreate}>Xc nhn to</Button>
                </div>
            </DialogContent>
        </Dialog>
      </div>

      <Card>
        <Table>
            <TableHeader>
                <TableRow>
                    <TableHead className="w-[80px]">ID</TableHead>
                    <TableHead>Ti khon</TableHead>
                    <TableHead>H tn hin th</TableHead>
                    <TableHead>Vai tr</TableHead>
                    <TableHead className="text-right">Hnh ng</TableHead>
                </TableRow>
            </TableHeader>
            <TableBody>
                {loading ? (
                    <TableRow><TableCell colSpan={5} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ang ti danh sch...</TableCell></TableRow>
                ) : users.length === 0 ? (
                    <TableRow><TableCell colSpan={5} className="text-center h-24 text-muted-foreground">Cha c ngi dng no.</TableCell></TableRow>
                ) : (
                    users.map(u => (
                        <TableRow key={u.id}>
                            <TableCell className="font-mono text-xs text-gray-500">#{u.id}</TableCell>
                            <TableCell className="font-bold">{u.username}</TableCell>
                            <TableCell>{u.full_name}</TableCell>
                            <TableCell>
                                <Badge variant="outline" className={
                                    u.role === 'Admin' ? 'border-red-200 bg-red-50 text-red-700' :
                                    u.role === 'Student' ? 'border-green-200 bg-green-50 text-green-700' : 
                                    'border-blue-200 bg-blue-50 text-blue-700'
                                }>
                                    {u.role}
                                </Badge>
                            </TableCell>
                            <TableCell className="text-right">
                                <Button variant="ghost" size="icon" onClick={() => handleDelete(u.id)} className="text-gray-400 hover:text-red-600 hover:bg-red-50" title="Xa ngi dng">
                                    <Trash2 className="w-4 h-4"/>
                                </Button>
                            </TableCell>
                        </TableRow>
                    ))
                )}
            </TableBody>
        </Table>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/layout.tsx">
// apps/web/app/(main)/layout.tsx
import Sidebar from "@/components/Sidebar";
import Header from "@/components/Header";

export default function MainLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <div className="min-h-screen">
      {/* Sidebar c nh */}
      <div>
        <Sidebar />
      </div>

      {/* Khu vc ni dung chnh */}
      <div className="md:pl-64 min-h-screen flex flex-col">
        <Header />
        <main className="p-6 flex-1 bg-gray-50/50">
          {children}
        </main>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/page.tsx">
"use client";

import React, { useEffect, useState, useCallback } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "@/components/ui/table";
import { Edit, Eye, GitCompare, Loader2, RefreshCcw } from "lucide-react";
import SyllabusDeleteButton from "@/components/SyllabusDeleteButton"; 
import DashboardCharts from "@/components/DashboardCharts";
import axios from "@/lib/axios";

interface Syllabus {
  id: number;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  status: string;
  version: string;
  lecturer: string;
  dateEdited: string;
}

export default function Dashboard() {
  const router = useRouter();
  
  const [syllabuses, setSyllabuses] = useState<Syllabus[]>([]);
  const [total, setTotal] = useState(0);
  const [totalPages, setTotalPages] = useState(1);
  const [loading, setLoading] = useState(true);
  const [statsData, setStatsData] = useState(null);
  
  const [currentPage, setCurrentPage] = useState(1);
  const [searchTerm, setSearchTerm] = useState("");

  const fetchData = useCallback(async (page: number, keyword: string) => {
    setLoading(true);

    try {
      const query = new URLSearchParams({ page: page.toString(), limit: "10", search: keyword });
      const listRes = await axios.get(`/syllabuses?${query.toString()}`);
      const list = listRes.data;
      setSyllabuses(list.data || []);
      setTotal(list.total || 0);
      setTotalPages(list.total_pages || 1);

      try {
        const statsRes = await axios.get(`/stats`);
        const stats = statsRes.data;
        setStatsData(stats);
      } catch (e) {
        // ignore stats error
      }

    } catch (err: any) {
      console.error(err);
      if (err?.response?.status === 401 || err?.status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("role");
        router.push("/login");
        return;
      }
    } finally { setLoading(false); }
  }, [router]);

  useEffect(() => {
    const timer = setTimeout(() => fetchData(currentPage, searchTerm), 500);
    return () => clearTimeout(timer);
  }, [searchTerm, currentPage, fetchData]);

  const renderStatusBadge = (status: string) => {
    let color = "bg-gray-500";
    let label = status;
    
    switch (status) {
        case "Approved": color = "bg-green-600"; break;
        case "Pending": color = "bg-yellow-500"; label = "Pending Review"; break;
        case "Pending Approval": color = "bg-orange-500"; label = "Pending AA"; break; 
        case "Returned": color = "bg-red-500"; break;
        case "Draft": color = "bg-slate-500"; break;
    }
    return <Badge className={color}>{label}</Badge>;
  };

  return (
    <div className="space-y-8">
      
      <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-2xl font-bold tracking-tight">Dashboard Overview</h2>
            <p className="text-sm text-muted-foreground">Tng quan h thng thi gian thc</p>
          </div>
          <DashboardCharts data={statsData} />
      </section>

      <section className="space-y-4">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t pt-8">
            <div>
                <h3 className="text-xl font-bold tracking-tight">Qun l  cng</h3>
                <p className="text-sm text-muted-foreground">Danh sch chi tit cc hc phn</p>
            </div>
            <div className="w-full md:w-1/3 flex gap-2">
              <Input
                placeholder="Tm kim theo tn hoc m HP..."
                value={searchTerm}
                onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                className="bg-white"
              />
              <Button variant="outline" size="icon" onClick={() => fetchData(currentPage, searchTerm)} title="Lm mi">
                  <RefreshCcw className="w-4 h-4"/>
              </Button>
            </div>
          </div>

          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-[100px]">M HP</TableHead>
                  <TableHead>Tn Hc Phn</TableHead>
                  <TableHead>Phin bn</TableHead>
                  <TableHead>Tn ch</TableHead>
                  <TableHead>Ging vin</TableHead>
                  <TableHead>Trng thi</TableHead>
                  <TableHead className="text-right">Hnh ng</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {loading && syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center">
                      <div className="flex justify-center items-center gap-2">
                        <Loader2 className="animate-spin w-4 h-4" /> ang ti d liu...
                      </div>
                    </TableCell>
                  </TableRow>
                ) : syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center text-muted-foreground">
                      Khng tm thy  cng no.
                    </TableCell>
                  </TableRow>
                ) : (
                  syllabuses.map((s) => (
                    <TableRow key={s.id}>
                      <TableCell className="font-bold">{s.subjectCode}</TableCell>
                      <TableCell>
                        <div className="font-medium">{s.subjectNameVi || "(Cha c tn)"}</div>
                        <div className="text-xs text-muted-foreground truncate max-w-[200px]">{s.subjectNameEn}</div>
                      </TableCell>
                      <TableCell><Badge variant="outline" className="bg-slate-50">v{s.version || "1.0"}</Badge></TableCell>
                      <TableCell>{s.credits}</TableCell>
                      <TableCell className="text-sm text-gray-600">{s.lecturer}</TableCell>
                      <TableCell>{renderStatusBadge(s.status)}</TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2 items-center">
                            <Link href={`/syllabus/compare?baseId=${s.id - 1}&targetId=${s.id}`}>
                                <Button variant="outline" size="icon" title="So snh bn c"><GitCompare className="w-4 h-4 text-orange-600" /></Button>
                            </Link>
                            <Link href={`/syllabus/${s.id}`}>
                                <Button variant="ghost" size="icon" title="Xem chi tit"><Eye className="w-4 h-4" /></Button>
                            </Link>
                            {(s.status === "Draft" || s.status === "Returned") && (
                                <Link href={`/syllabus/${s.id}/edit`}>
                                    {/* SA: text-blue-600 -> text-teal-600 */}
                                    <Button variant="ghost" size="icon" title="Chnh sa"><Edit className="w-4 h-4 text-teal-600" /></Button>
                                </Link>
                            )}
                            {s.status === "Draft" && (
                                <div className="scale-90"><SyllabusDeleteButton id={s.id} /></div>
                            )}
                        </div>
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
            
            <div className="flex items-center justify-between px-4 py-4 border-t">
              <div className="text-sm text-muted-foreground">Trang {currentPage} / {totalPages}</div>
              <div className="flex gap-2">
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage <= 1}>Trc</Button>
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage >= totalPages}>Sau</Button>
              </div>
            </div>
          </Card>
      </section>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/profile/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { User, Shield, Key, Save } from "lucide-react";

interface UserProfile {
  id: number;
  username: string;
  full_name: string;
  role: string;
}

export default function ProfilePage() {
  const [user, setUser] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);

  // State cho form i mt khu
  const [passData, setPassData] = useState({ current: "", new: "", confirm: "" });
  const [passLoading, setPassLoading] = useState(false);

  useEffect(() => {
    const fetchProfile = async () => {
        try {
            const userRes = await axios.get('/users/me');
            const userData = userRes.data;
            setUser(userData);
        } catch (e) { console.error(e); }
        finally { setLoading(false); }
    };
    fetchProfile();
  }, []);

  const handleChangePassword = async () => {
      // Validate c bn
      if (!passData.current || !passData.new) return alert("Vui lng nhp y  thng tin");
      if (passData.new !== passData.confirm) return alert("Mt khu mi khng khp");
      if (passData.new.length < 6) return alert("Mt khu mi phi t 6 k t tr ln");

      setPassLoading(true);
      try {
          await axios.post('/users/change-password', { currentPassword: passData.current, newPassword: passData.new });
          alert("Thnh cng! Mt khu  c thay i.");
          setPassData({ current: "", new: "", confirm: "" }); // Reset form
      } catch (err: any) {
          console.error(err);
          const message = err?.response?.data?.detail || err?.message || "Li kt ni server";
          alert("Li: " + message);
      } finally {
          setPassLoading(false);
      }
  };

  if (loading) return <div className="p-8 text-center">ang ti thng tin...</div>;
  if (!user) return <div className="p-8 text-center">Khng tm thy thng tin ngi dng.</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
        <h2 className="text-2xl font-bold tracking-tight">H s c nhn</h2>
        
        <div className="grid gap-6 md:grid-cols-3">
            {/* Ct tri: Avatar */}
            <Card className="md:col-span-1">
                <CardContent className="pt-6 flex flex-col items-center text-center">
                    <Avatar className="w-24 h-24 mb-4 border-4 border-slate-50">
                        <AvatarImage src={`https://ui-avatars.com/api/?name=${user.full_name}&background=0D8ABC&color=fff`} />
                        <AvatarFallback>User</AvatarFallback>
                    </Avatar>
                    <h3 className="font-bold text-xl">{user.full_name}</h3>
                    <div className="text-sm text-muted-foreground mb-4">@{user.username}</div>
                    <div className="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium border border-blue-200">
                        <Shield className="w-3 h-3 mr-1"/> {user.role}
                    </div>
                </CardContent>
            </Card>

            {/* Ct phi: Thng tin & i Pass */}
            <div className="md:col-span-2 space-y-6">
                {/* Thng tin chung */}
                <Card>
                    <CardHeader>
                        <CardTitle>Thng tin ti khon</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <label className="text-sm font-medium flex items-center gap-2 text-slate-600"><User className="w-4 h-4"/> H v tn</label>
                            <Input value={user.full_name} readOnly className="bg-slate-50"/>
                        </div>
                        <div className="space-y-2">
                            <label className="text-sm font-medium flex items-center gap-2 text-slate-600"><Key className="w-4 h-4"/> Tn ng nhp</label>
                            <Input value={user.username} readOnly className="bg-slate-50"/>
                        </div>
                    </CardContent>
                </Card>

                {/* Form i mt khu */}
                <Card>
                    <CardHeader>
                        <CardTitle>i mt khu</CardTitle>
                        <CardDescription> bo mt, vui lng khng chia s mt khu cho ngi khc.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Mt khu hin ti</label>
                            <Input 
                                type="password" 
                                value={passData.current}
                                onChange={e => setPassData({...passData, current: e.target.value})}
                                placeholder=""
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <label className="text-sm font-medium">Mt khu mi</label>
                                <Input 
                                    type="password"
                                    value={passData.new}
                                    onChange={e => setPassData({...passData, new: e.target.value})}
                                    placeholder=""
                                />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-medium">Nhp li mi</label>
                                <Input 
                                    type="password"
                                    value={passData.confirm}
                                    onChange={e => setPassData({...passData, confirm: e.target.value})}
                                    placeholder=""
                                />
                            </div>
                        </div>
                        <div className="flex justify-end pt-2">
                            <Button onClick={handleChangePassword} disabled={passLoading}>
                                {passLoading ? "ang x l..." : <><Save className="w-4 h-4 mr-2" /> Lu thay i</>}
                            </Button>
                        </div>
                    </CardContent>
                </Card>
            </div>
        </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/reviews/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Loader2, FileSignature, CheckCircle, XCircle, ArrowRight } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import axios from "@/lib/axios";

interface Syllabus {
  id: number;
  subjectNameVi: string;
  subjectCode: string;
  lecturer: string;
  dateEdited: string;
  status: string;
  version: string;
  headDepartment?: string; // Tn trng b mn  duyt
}

export default function ReviewPage() {
  const [reviews, setReviews] = useState<Syllabus[]>([]);
  const [loading, setLoading] = useState(true);
  const [userRole, setUserRole] = useState("");
  
  // State cho Modal t chi
  const [rejectId, setRejectId] = useState<number | null>(null);
  const [rejectReason, setRejectReason] = useState("");
  const [processing, setProcessing] = useState(false);

  const fetchReviews = async () => {
    setLoading(true);
    const role = localStorage.getItem("role") || "";
    setUserRole(role);

    // Determine status to fetch based on role
    let statusToFetch = "Pending";
    if (role === "Academic Affairs") statusToFetch = "Pending Approval";
    else if (role === "Admin") statusToFetch = "";

    try {
      const url = statusToFetch ? `/syllabuses?status=${encodeURIComponent(statusToFetch)}&limit=100` : `/syllabuses?limit=100`;
      const res = await axios.get(url);
      const data = res.data;
      setReviews(data.data || []);
    } catch (err: any) {
      console.error(err);
      const status = err?.response?.status || err?.status;
      if (status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("role");
        window.location.href = "/login";
      }
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchReviews(); }, []);

  const handleApprove = async (id: number) => {
      // i thng bo ty theo role
      const msg = userRole === "Head of Dept" 
        ? "Xc nhn duyt v chuyn ln Phng o to?" 
        : "Xc nhn PH DUYT CUI CNG v cng b?";

      if(!confirm(msg)) return;
      
      try {
          await axios.post(`/syllabuses/${id}/approve`);
          alert("Thnh cng!");
          fetchReviews();
      } catch(e: any) {
          const status = e?.response?.status || e?.status;
          if (status === 401) { alert("Phin ng nhp ht hn."); window.location.href = "/login"; return; }
          const message = e?.response?.data?.detail || e?.message;
          alert(message || "Li kt ni");
      }
  };

  const handleRejectSubmit = async () => {
      if (!rejectId || !rejectReason.trim()) return alert("Vui lng nhp l do t chi!");
      
      setProcessing(true);
      try {
          await axios.post(`/syllabuses/${rejectId}/reject`, { reason: rejectReason });
          alert(" tr v yu cu sa!");
          setRejectId(null);
          setRejectReason("");
          fetchReviews();
      } catch(e: any) {
          const message = e?.response?.data?.detail || e?.message;
          alert(message || "Li kt ni");
      } finally { setProcessing(false); }
  };

  // Xc nh tiu  trang da trn Role
  const pageTitle = userRole === "Academic Affairs" 
    ? "Ph duyt cp Trng (Phng o to)" 
    : "Ph duyt cp B mn";

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
            <h2 className="text-2xl font-bold tracking-tight">{pageTitle}</h2>
            <p className="text-sm text-muted-foreground">
                {userRole === "Academic Affairs" 
                    ? "Danh sch cc  cng  c Trng b mn thng qua." 
                    : "Danh sch cc  cng ang ch duyt."}
            </p>
        </div>
        <Badge variant="secondary" className="text-base px-4 py-2 bg-yellow-100 text-yellow-800 hover:bg-yellow-200">
          Ch x l: {reviews.length}
        </Badge>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileSignature className="w-5 h-5"/> Danh sch ch duyt
          </CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>M HP</TableHead>
                <TableHead>Tn Hc Phn</TableHead>
                <TableHead>Phin bn</TableHead>
                <TableHead>Ngi gi</TableHead>
                {userRole === "Academic Affairs" && <TableHead>Trng BM duyt</TableHead>}
                <TableHead>Ngy cp nht</TableHead>
                <TableHead className="text-right">Hnh ng</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow><TableCell colSpan={7} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ang ti...</TableCell></TableRow>
              ) : reviews.length === 0 ? (
                <TableRow><TableCell colSpan={7} className="text-center h-24 text-muted-foreground">Hin ti khng c yu cu no cn duyt.</TableCell></TableRow>
              ) : (
                reviews.map((s) => (
                  <TableRow key={s.id}>
                    <TableCell className="font-bold">{s.subjectCode}</TableCell>
                    <TableCell>
                        <div className="font-medium">{s.subjectNameVi}</div>
                        {s.status === "Pending Approval" && <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 border-blue-200 mt-1"> qua BM</Badge>}
                    </TableCell>
                    <TableCell><Badge variant="outline">v{s.version}</Badge></TableCell>
                    <TableCell className="text-gray-600">{s.lecturer}</TableCell>
                    
                    {userRole === "Academic Affairs" && (
                        <TableCell className="text-green-600 font-medium">
                            <div className="flex items-center gap-1">
                                <CheckCircle className="w-3 h-3"/> {s.headDepartment || "BM Approved"}
                            </div>
                        </TableCell>
                    )}
                    
                    <TableCell>{s.dateEdited}</TableCell>
                    <TableCell className="text-right">
                      <div className="flex justify-end gap-2">
                        <Link href={`/syllabus/${s.id}/edit`}>
                             <Button variant="outline" size="sm">Xem chi tit</Button>
                        </Link>
                        
                        <Button size="sm" className="bg-green-600 hover:bg-green-700" onClick={() => handleApprove(s.id)} title="Duyt">
                            {userRole === "Head of Dept" ? <ArrowRight className="w-4 h-4"/> : <CheckCircle className="w-4 h-4"/>}
                        </Button>
                        
                        <Button size="sm" variant="destructive" onClick={() => setRejectId(s.id)} title="Tr v">
                            <XCircle className="w-4 h-4"/>
                        </Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* MODAL NHP L DO T CHI */}
      <Dialog open={!!rejectId} onOpenChange={(open) => !open && setRejectId(null)}>
        <DialogContent>
            <DialogHeader>
                <DialogTitle>Tr v yu cu sa i</DialogTitle>
                <DialogDescription>
                    {userRole === "Academic Affairs" 
                        ? " cng s b tr v trng thi 'Returned' cho Ging vin (v thng bo cho Trng BM)." 
                        : "Vui lng nhp l do  Ging vin chnh sa li."}
                </DialogDescription>
            </DialogHeader>
            <div className="py-4">
                <Textarea 
                    placeholder="Nhp l do c th..." 
                    rows={4}
                    value={rejectReason}
                    onChange={(e) => setRejectReason(e.target.value)}
                />
            </div>
            <DialogFooter>
                <Button variant="outline" onClick={() => setRejectId(null)}>Hy b</Button>
                <Button variant="destructive" onClick={handleRejectSubmit} disabled={processing}>
                    {processing ? "ang gi..." : "Xc nhn Tr v"}
                </Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/syllabus/[id]/edit/page.tsx">
import React from "react";
import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import SyllabusEditForm from "@/components/SyllabusEditForm";
import { SyllabusData, defaultSyllabus } from "@/components/Types";

export default async function Page(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  if (!id) return renderNotFound();

  try {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

    if (res.status === 404) return renderNotFound();
    
    if (!res.ok) {
      console.error("Failed to fetch syllabus", res.status);
      return renderError();
    }

    const rawData = await res.json();

    // Merge d liu API vi d liu mc nh  trnh li undefined
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: Array.isArray(rawData.objectives) ? rawData.objectives : [],
        clos: Array.isArray(rawData.clos) ? rawData.clos : [],
        ploMapping: Array.isArray(rawData.ploMapping) ? rawData.ploMapping : [],
        assessmentScheme: Array.isArray(rawData.assessmentScheme) ? rawData.assessmentScheme : [],
        teachingPlan: Array.isArray(rawData.teachingPlan) ? rawData.teachingPlan : [],
        materials: Array.isArray(rawData.materials) ? rawData.materials : [],
        timeAllocation: rawData.timeAllocation || defaultSyllabus.timeAllocation
    };

    return <SyllabusEditForm initial={syllabus} />;

  } catch (err) {
    console.error("Error fetching syllabus:", err);
    return renderError();
  }
}

function renderNotFound() {
    return (
        <div className="flex items-center justify-center min-h-[50vh]">
            <Card className="w-full max-w-md text-center p-6">
                <CardHeader>
                    <CardTitle className="text-xl">Khng tm thy  cng</CardTitle>
                </CardHeader>
                <CardContent>
                    <p className="text-muted-foreground mb-4"> cng ny khng tn ti hoc  b xa.</p>
                    <Link href="/" className="text-blue-600 hover:underline">Quay v trang ch</Link>
                </CardContent>
            </Card>
        </div>
    );
}

function renderError() {
    return (
        <div className="flex items-center justify-center min-h-[50vh]">
            <Card className="w-full max-w-md text-center p-6 border-red-200 bg-red-50">
                <CardHeader>
                    <CardTitle className="text-xl text-red-600">Li kt ni</CardTitle>
                </CardHeader>
                <CardContent>
                    <p className="text-red-500 mb-4">Khng th ti d liu t Backend. Vui lng kim tra li server API.</p>
                    <Link href="/" className="text-red-700 font-bold hover:underline">Quay v trang ch</Link>
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="apps/web/app/(main)/syllabus/[id]/page.tsx">
// import Link from "next/link";
// import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
// import SyllabusDetailView from "@/components/SyllabusDetailView"; // Import component va to

// interface Syllabus {
//   id: number;
//   subject_name: string;
//   subject_code: string;
//   credits: number;
//   description?: string;
//   clos?: Array<{ code: string; description: string }>;
// }

// export default async function Page(props: { params: Promise<{ id: string }> }) {
//   const { id } = await props.params;

//   if (!id) return renderNotFound();

//   try {
//     // Server-side example using environment variable:
//     // const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

//     if (res.status === 404) return renderNotFound();
    
//     if (!res.ok) {
//       console.error("Failed to fetch syllabus", res.status);
//       return renderError();
//     }

//     const syllabus: Syllabus = await res.json();

//     // Render component giao din (Client Component)
//     return <SyllabusDetailView syllabus={syllabus} />;

//   } catch (err) {
//     console.error("Error fetching syllabus:", err);
//     return renderError();
//   }
// }

// // --- Cc hm render li gi nguyn ---

// function renderNotFound() {
//   return (
//     <div className="flex items-center justify-center p-12">
//       <Card className="w-full max-w-md text-center">
//         <CardHeader>
//           <CardTitle className="text-xl">Syllabus not found</CardTitle>
//         </CardHeader>
//         <CardContent>
//           <p className="text-sm text-muted-foreground mb-4">The requested syllabus does not exist or has been removed.</p>
//           <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
//         </CardContent>
//       </Card>
//     </div>
//   );
// }

// function renderError() {
//   return (
//     <div className="flex items-center justify-center p-12">
//       <Card className="w-full max-w-md text-center border-destructive/50">
//         <CardHeader>
//           <CardTitle className="text-xl text-destructive">Unable to load</CardTitle>
//         </CardHeader>
//         <CardContent>
//           <p className="text-sm text-muted-foreground mb-4">There was an error loading the details. Please ensure the backend server is running.</p>
//           <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
//         </CardContent>
//       </Card>
//     </div>
//   );
// }

import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import SyllabusDetailView from "@/components/SyllabusDetailView";
// Import Type t file types (nu anh  to) hoc nh ngha trc tip  y  nhanh gn
import { SyllabusData, defaultSyllabus } from "@/components/Types"; 

// Nu anh cha to file types.ts, hy uncomment on di y  dng tm:
/*
interface SyllabusData {
  id?: number;
  subject_name_vi: string;
  subject_name_en: string;
  subject_code: string;
  credits: number;
  time_allocation: { theory: number; exercises: number; practice: number; self_study: number; };
  prerequisites: string; pre_courses: string; co_courses: string;
  course_type: string; component_type: string;
  description: string;
  objectives: string[];
  clos: { code: string; description: string }[];
  plo_mapping: { clo_code: string; plos: { [key: string]: string } }[];
  student_duties: string;
  assessment_scheme: { component: string; method: string; clos: string; criteria: string; weight: number; }[];
  teaching_plan: { week: string; content: string; clos: string; activity: string; assessment: string; }[];
  materials: { type: "Main" | "Ref"; content: string; }[];
  date_prepared: string; date_edited: string; lecturer: string; head_department: string; dean: string;
}
*/

export default async function Page(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  if (!id) return renderNotFound();

  try {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

    if (res.status === 404) return renderNotFound();
    
    if (!res.ok) {
      console.error("Failed to fetch syllabus", res.status);
      return renderError();
    }

    const rawData = await res.json();

    // MERGE d liu t API vi d liu mc nh  trnh li "undefined" khi render
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: rawData.objectives || [],
        clos: rawData.clos || [],
        ploMapping: rawData.ploMapping || [],
        assessmentScheme: rawData.assessmentScheme || [],
        teachingPlan: rawData.teachingPlan || [],
        materials: rawData.materials || [],
        timeAllocation: rawData.timeAllocation || { theory: 0, exercises: 0, practice: 0, selfStudy: 0 }
    };

    return <SyllabusDetailView syllabus={syllabus} />;

  } catch (err) {
    console.error("Error fetching syllabus:", err);
    return renderError();
  }
}

function renderNotFound() {
  return (
    <div className="flex items-center justify-center p-12">
      <Card className="w-full max-w-md text-center">
        <CardHeader>
          <CardTitle className="text-xl">Syllabus not found</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground mb-4">The requested syllabus does not exist or has been removed.</p>
          <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
        </CardContent>
      </Card>
    </div>
  );
}

function renderError() {
  return (
    <div className="flex items-center justify-center p-12">
      <Card className="w-full max-w-md text-center border-destructive/50">
        <CardHeader>
          <CardTitle className="text-xl text-destructive">Unable to load</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground mb-4">There was an error loading the details. Please ensure the backend server is running.</p>
          <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/syllabus/compare/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { useSearchParams, useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";

interface DiffItem {
  field: string;
  old_value: string;
  new_value: string;
  type: string;
}

export default function ComparePage() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const baseId = searchParams.get("baseId");
  const targetId = searchParams.get("targetId");

  const [data, setData] = useState<{ base_version: string; target_version: string; diffs: DiffItem[] } | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchDiff = async () => {
      if (!baseId || !targetId) return;

      try {
        const query = new URLSearchParams({ base_id: baseId, target_id: targetId }).toString();
        const res = await axios.get(`/syllabus/compare?${query}`);
        const data = res.data;
        setData(data);
      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    };
    fetchDiff();
  }, [baseId, targetId]);

  if (!baseId || !targetId) return <div className="p-8 text-center">Missing IDs to compare</div>;
  if (loading) return <div className="p-8 text-center">Analyzing changes...</div>;

  return (
    <div className="max-w-5xl mx-auto space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" onClick={() => router.back()}><ArrowLeft className="w-4 h-4 mr-2"/> Back</Button>
        <h1 className="text-2xl font-bold">So snh Phin bn</h1>
      </div>

      <div className="grid grid-cols-2 gap-4">
         <Card className="bg-slate-50 border-slate-200">
            <CardHeader><CardTitle className="text-lg text-slate-500">Phin bn gc (v{data?.base_version})</CardTitle></CardHeader>
         </Card>
         <Card className="bg-blue-50 border-blue-200">
            <CardHeader><CardTitle className="text-lg text-blue-600">Phin bn mi (v{data?.target_version})</CardTitle></CardHeader>
         </Card>
      </div>

      <div className="space-y-4">
        {data?.diffs.length === 0 ? (
            <Card className="p-8 text-center text-green-600 font-bold border-green-200 bg-green-50">
                 Khng c s thay i no gia 2 phin bn ny.
            </Card>
        ) : (
            data?.diffs.map((diff, idx) => (
                <Card key={idx} className="overflow-hidden">
                    <div className="bg-gray-100 px-4 py-2 font-mono text-sm font-bold border-b uppercase text-gray-600">
                        Field: {diff.field}
                    </div>
                    <div className="grid grid-cols-2">
                        <div className="p-4 bg-red-50 text-red-700 border-r break-words">
                            <div className="text-xs font-bold text-red-400 mb-1">OLD</div>
                            {diff.old_value}
                        </div>
                        <div className="p-4 bg-green-50 text-green-700 break-words">
                            <div className="text-xs font-bold text-green-400 mb-1">NEW</div>
                            {diff.new_value}
                        </div>
                    </div>
                </Card>
            ))
        )}
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/syllabus/create/page.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";

// --- Types ---
type CLO = { id: string; code: string; description: string };
type Assessment = { id: string; component: string; weight: number; description: string };
type Material = { id: string; type: "Main" | "Ref"; author: string; title: string; publisher: string; year: string };

export default function CreateSyllabusPage() {
  const router = useRouter();
  const [tab, setTab] = useState("general");

  // --- State ---
  const [title, setTitle] = useState("");
  const [code, setCode] = useState("");
  const [credits, setCredits] = useState<number | "">(3);
  const [description, setDescription] = useState("");
  
  const [prerequisites, setPrerequisites] = useState("");
  const [preCourses, setPreCourses] = useState("");
  const [courseType, setCourseType] = useState("Bt buc");
  const [studentTasks, setStudentTasks] = useState("");

  // MI: State cho Time Allocation
  const [timeAllocation, setTimeAllocation] = useState({ theory: 0, exercises: 0, practice: 0, self_study: 0 });

  const [clos, setClos] = useState<CLO[]>([{ id: crypto.randomUUID(), code: "G1", description: "" }]);
  const [assessments, setAssessments] = useState<Assessment[]>([
    { id: crypto.randomUUID(), component: "Qu trnh", weight: 50, description: "" },
    { id: crypto.randomUUID(), component: "Cui k", weight: 50, description: "" },
  ]);
  const [materials, setMaterials] = useState<Material[]>([]);

  const [submitting, setSubmitting] = useState(false);

  // --- Helpers ---
  function addCLO() { setClos(s => [...s, { id: crypto.randomUUID(), code: `G${s.length + 1}`, description: "" }]); }
  function updateCLO(id: string, f: Partial<CLO>) { setClos(s => s.map(c => c.id === id ? { ...c, ...f } : c)); }
  function removeCLO(id: string) { setClos(s => s.filter(c => c.id !== id)); }

  function addAssessment() { setAssessments(s => [...s, { id: crypto.randomUUID(), component: "", weight: 0, description: "" }]); }
  function updateAssessment(id: string, f: Partial<Assessment>) { setAssessments(s => s.map(a => a.id === id ? { ...a, ...f } : a)); }
  function removeAssessment(id: string) { setAssessments(s => s.filter(a => a.id !== id)); }

  function addMaterial() { setMaterials(s => [...s, { id: crypto.randomUUID(), type: "Main", author: "", title: "", publisher: "", year: "" }]); }
  function updateMaterial(id: string, f: Partial<Material>) { setMaterials(s => s.map(m => m.id === id ? { ...m, ...f } : m)); }
  function removeMaterial(id: string) { setMaterials(s => s.filter(m => m.id !== id)); }

  const totalWeight = assessments.reduce((sum, item) => sum + (Number(item.weight) || 0), 0);

  // --- Submit ---
  async function handleSubmit() {
    const payload = {
      subject_name: title,
      subject_code: code,
      credits: credits === "" ? 0 : credits,
      description,
      prerequisites,
      pre_courses: preCourses,
      course_type: courseType,
      student_tasks: studentTasks,
      time_allocation: timeAllocation, // Thm vo payload
      clos: clos.map(c => ({ code: c.code, description: c.description })),
      assessment_scheme: assessments.map(a => ({ component: a.component, weight: Number(a.weight), description: a.description })),
      materials: materials.map(m => ({ type: m.type, title: m.title, author: m.author, publisher: m.publisher, year: m.year })),
    };

    setSubmitting(true);
    try {
      // Use the centralized client so base URL, Authorization header and snake_case conversion are handled automatically
      // Example usage (client-side):
      // const resJson = await (await import("@/lib/apiClient")).apiFetch("/syllabuses", { method: "POST", body: payload });
      // router.push("/");

      // (Legacy direct fetch removed from source; keep example above for reference)
    } catch (err) { alert("Li: " + err); } 
    finally { setSubmitting(false); }
  }

  const selectClass = "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50";

  return (
    <div className="flex justify-center py-12 px-4">
      <Card className="w-full max-w-4xl">
        <CardHeader><CardTitle>Thm  Cng Mi</CardTitle></CardHeader>
        <CardContent>
          <Tabs value={tab} onValueChange={setTab}>
            <TabsList className="w-full grid grid-cols-4">
              <TabsTrigger value="general">Thng tin chung</TabsTrigger>
              <TabsTrigger value="clos">CR (CLOs)</TabsTrigger>
              <TabsTrigger value="materials">Ti liu</TabsTrigger>
              <TabsTrigger value="assessments">nh gi</TabsTrigger>
            </TabsList>

            <TabsContent value="general" className="space-y-4 mt-4">
              <div className="grid grid-cols-2 gap-4">
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">Tn hc phn</span><Input value={title} onChange={e => setTitle(e.target.value)} /></label>
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">M hc phn</span><Input value={code} onChange={e => setCode(e.target.value)} /></label>
              </div>
              <div className="grid grid-cols-2 gap-4">
                 <label className="flex flex-col gap-1"><span className="text-sm font-medium">S tn ch</span><Input type="number" value={credits} onChange={e => setCredits(e.target.value === "" ? "" : Number(e.target.value))} /></label>
                 <label className="flex flex-col gap-1"><span className="text-sm font-medium">Loi hc phn</span>
                    <select className={selectClass} value={courseType} onChange={e => setCourseType(e.target.value)}>
                        <option value="Bt buc">Bt buc</option>
                        <option value="T chn">T chn</option>
                    </select>
                 </label>
              </div>

              {/* KHUNG NHP PHN B THI GIAN */}
              <div className="border p-4 rounded-md bg-gray-50">
                <span className="text-sm font-bold mb-2 block">Phn b thi gian (Tit)</span>
                <div className="grid grid-cols-4 gap-2">
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">L thuyt</span>
                        <Input type="number" value={timeAllocation.theory} onChange={e => setTimeAllocation({...timeAllocation, theory: Number(e.target.value)})} />
                    </label>
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">Bi tp/D n</span>
                        <Input type="number" value={timeAllocation.exercises} onChange={e => setTimeAllocation({...timeAllocation, exercises: Number(e.target.value)})} />
                    </label>
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">Thc hnh</span>
                        <Input type="number" value={timeAllocation.practice} onChange={e => setTimeAllocation({...timeAllocation, practice: Number(e.target.value)})} />
                    </label>
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">T hc</span>
                        <Input type="number" value={timeAllocation.self_study} onChange={e => setTimeAllocation({...timeAllocation, self_study: Number(e.target.value)})} />
                    </label>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">HP Tin quyt</span><Input value={prerequisites} onChange={e => setPrerequisites(e.target.value)} /></label>
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">HP Hc trc</span><Input value={preCourses} onChange={e => setPreCourses(e.target.value)} /></label>
              </div>
              <label className="flex flex-col gap-1"><span className="text-sm font-medium">M t tm tt</span><Textarea value={description} onChange={e => setDescription(e.target.value)} /></label>
              <label className="flex flex-col gap-1"><span className="text-sm font-medium">Nhim v SV</span><Textarea value={studentTasks} onChange={e => setStudentTasks(e.target.value)} /></label>
            </TabsContent>

            {/* Cc Tab khc gi nguyn logic c */}
            <TabsContent value="clos" className="mt-4 space-y-4">
                {clos.map((c, idx) => (
                    <div key={c.id} className="flex gap-2"><Input className="w-24" value={c.code} onChange={e => updateCLO(c.id, {code: e.target.value})} /><Input value={c.description} onChange={e => updateCLO(c.id, {description: e.target.value})} /><Button variant="ghost" onClick={() => removeCLO(c.id)}></Button></div>
                ))}
                <Button variant="outline" onClick={addCLO} className="w-full border-dashed">+ Thm CLO</Button>
            </TabsContent>
            <TabsContent value="materials" className="space-y-4 mt-4">
                {materials.map((m, idx) => (
                    <div key={m.id} className="border p-3 rounded-md space-y-2 relative bg-gray-50">
                        <Button variant="ghost" size="sm" className="absolute top-2 right-2 text-red-500" onClick={() => removeMaterial(m.id)}></Button>
                        <div className="flex gap-4">
                             <div className="w-1/4">
                                <span className="text-xs text-muted-foreground">Loi</span>
                                <select className={`${selectClass} h-9 mt-1`} value={m.type} onChange={e => updateMaterial(m.id, { type: e.target.value as any })}><option value="Main">Gio trnh</option><option value="Ref">Tham kho</option></select>
                             </div>
                             <div className="w-3/4"><span className="text-xs text-muted-foreground">Tn ti liu</span><Input className="h-9 mt-1" value={m.title} onChange={e => updateMaterial(m.id, { title: e.target.value })} /></div>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                             <Input className="h-8 text-sm" value={m.author} onChange={e => updateMaterial(m.id, { author: e.target.value })} placeholder="Tc gi" />
                             <Input className="h-8 text-sm" value={m.publisher} onChange={e => updateMaterial(m.id, { publisher: e.target.value })} placeholder="NXB" />
                             <Input className="h-8 text-sm" value={m.year} onChange={e => updateMaterial(m.id, { year: e.target.value })} placeholder="Nm" />
                        </div>
                    </div>
                ))}
                <Button variant="outline" onClick={addMaterial} className="w-full border-dashed">+ Thm Ti liu</Button>
            </TabsContent>
            <TabsContent value="assessments" className="mt-4 space-y-4">
                <div className="flex justify-between"><h3 className="font-medium">im s</h3><Badge variant={totalWeight===100?"default":"destructive"}>{totalWeight}%</Badge></div>
                {assessments.map(a => (
                    <div key={a.id} className="flex gap-2"><Input className="w-1/3" value={a.component} onChange={e=>updateAssessment(a.id, {component:e.target.value})} /><Input className="w-20" type="number" value={a.weight} onChange={e=>updateAssessment(a.id, {weight:Number(e.target.value)})} /><Input className="flex-1" value={a.description} onChange={e=>updateAssessment(a.id, {description:e.target.value})} /><Button variant="ghost" onClick={()=>removeAssessment(a.id)}></Button></div>
                ))}
                <Button variant="outline" onClick={addAssessment} className="w-full border-dashed">+ Thm im</Button>
                <div className="pt-4 mt-4 border-t"><Button className="w-full" onClick={handleSubmit} disabled={submitting || totalWeight !== 100}>Lu  Cng</Button></div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(public)/layout.tsx">
"use client";

import React from "react";
import { useRouter } from "next/navigation";
import { BookOpen, LogOut } from "lucide-react";
import { Button } from "@/components/ui/button";

export default function PublicLayout({ children }: { children: React.ReactNode }) {
  const router = useRouter();

  const handleLogout = () => {
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      localStorage.removeItem("role");
      router.push("/login");
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col">
      <header className="bg-white border-b sticky top-0 z-10 shadow-sm">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            {/* SA: bg-blue-600 -> bg-teal-600 */}
            <div className="bg-teal-600 p-2 rounded-lg">
                <BookOpen className="w-6 h-6 text-white" />
            </div>
            {/* SA: text-blue-900 -> text-teal-900 */}
            <span className="font-bold text-xl text-teal-900">SMD Portal</span>
          </div>
          <div className="flex gap-4 items-center">
             <Button variant="ghost" onClick={handleLogout} className="text-red-600 hover:text-red-700 hover:bg-red-50 text-sm">
                <LogOut className="w-4 h-4 mr-2" /> ng xut
             </Button>
          </div>
        </div>
      </header>

      <main className="flex-1 w-full max-w-6xl mx-auto p-4 md:py-8">
        {children}
      </main>

      <footer className="bg-white border-t py-6 text-center text-sm text-gray-500">
         2025 University Syllabus Management System. All rights reserved.
      </footer>
    </div>
  );
}
</file>

<file path="apps/web/app/(public)/portal/[id]/page.tsx">
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import SyllabusDetailView from "@/components/SyllabusDetailView";
import { SyllabusData, defaultSyllabus } from "@/components/Types";

export default async function StudentViewPage(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  try {
    // Gi API ly chi tit  cng (use public env var and plural resource)
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

    if (!res.ok) {
        return (
            <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
                <div className="text-xl font-bold text-gray-500">Khng tm thy  cng ny.</div>
                <Link href="/portal"><Button>Quay li trang ch</Button></Link>
            </div>
        );
    }

    const rawData = await res.json();
    
    // Merge d liu an ton (convert backend camelCase to frontend camelCase model)
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: rawData.objectives || [],
        clos: rawData.clos || [],
        ploMapping: rawData.ploMapping || [],
        assessmentScheme: rawData.assessmentScheme || [],
        teachingPlan: rawData.teachingPlan || [],
        materials: rawData.materials || [],
        timeAllocation: rawData.timeAllocation || { theory: 0, exercises: 0, practice: 0, selfStudy: 0 }
    };

    return (
        <div className="container mx-auto pb-10">
            {/* Nt quay li */}
            <div className="mb-6">
                <Link href="/portal">
                    <Button variant="outline" className="gap-2 bg-white hover:bg-slate-100">
                        <ArrowLeft className="w-4 h-4" /> Quay li tm kim
                    </Button>
                </Link>
            </div>

            {/* Hin th ni dung  cng */}
            <div className="bg-white shadow-sm rounded-lg border overflow-hidden">
                <SyllabusDetailView syllabus={syllabus} />
            </div>
        </div>
    );

  } catch (err) {
    return <div className="p-12 text-center text-red-500">Li kt ni server. Vui lng th li sau.</div>;
  }
}
</file>

<file path="apps/web/app/(public)/portal/page.tsx">
"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Search, BookOpen, User, Clock, GraduationCap, Loader2 } from "lucide-react";

interface SyllabusPublic {
  id: number;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  lecturer: string;
  version: string;
  description: string;
  dateEdited: string;
}

export default function StudentHomePage() {
  const [searchTerm, setSearchTerm] = useState("");
  const [results, setResults] = useState<SyllabusPublic[]>([]);
  const [loading, setLoading] = useState(false);
  const [debouncedTerm, setDebouncedTerm] = useState(searchTerm);

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedTerm(searchTerm), 500);
    return () => clearTimeout(timer);
  }, [searchTerm]);

  useEffect(() => {
    const fetchData = async () => {
        setLoading(true);
        try {
            const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/public/syllabus?search=${encodeURIComponent(debouncedTerm)}`);
            const data = await res.json();
            setResults(data.data || []);
        } catch(e) { console.error(e); } 
        finally { setLoading(false); }
    };
    fetchData();
  }, [debouncedTerm]);

  return (
    <div className="space-y-12 pb-20">
      {/* I GRADIENT BACKGROUND */}
      <div className="text-center space-y-6 py-16 bg-gradient-to-b from-teal-50 to-white rounded-3xl border border-teal-100 px-4">
        <div className="inline-flex items-center px-3 py-1 rounded-full bg-teal-100 text-teal-700 text-xs font-bold mb-2">
            <GraduationCap className="w-4 h-4 mr-2"/> Cng thng tin o to
        </div>
        <h1 className="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight">Tra cu  cng Hc phn</h1>
        <p className="text-lg text-slate-600 max-w-2xl mx-auto">H thng d liu s ha chnh thc. Tm kim thng tin chi tit, chun u ra v ti liu hc tp mi nht.</p>
        
        <div className="max-w-xl mx-auto relative mt-8">
            <Search className="absolute left-4 top-3.5 h-5 w-5 text-teal-500" />
            <Input 
                className="pl-12 h-12 text-lg shadow-xl border-teal-100 focus-visible:ring-teal-500 rounded-full transition-all" 
                placeholder="Nhp m mn (VD: IT001) hoc tn mn hc..." 
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
            />
            {loading && <div className="absolute right-4 top-4"><Loader2 className="w-4 h-4 animate-spin text-gray-400"/></div>}
        </div>
      </div>

      <div className="max-w-6xl mx-auto">
        <div className="flex items-center justify-between mb-6 px-2">
            <h2 className="text-xl font-bold text-slate-800">{searchTerm ? `Kt qu tm kim cho "${searchTerm}"` : " cng mi cp nht"}</h2>
            <span className="text-sm text-slate-500">{results.length} kt qu</span>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {loading && results.length === 0 ? ([1,2,3].map(i => <div key={i} className="h-64 bg-gray-100 rounded-xl animate-pulse"></div>)) : results.length === 0 ? (
                <div className="col-span-full text-center py-16 text-gray-400 italic bg-slate-50 rounded-xl border border-dashed">Khng tm thy  cng no ph hp.</div>
            ) : (
                results.map((item) => (
                    /* I BORDER TOP CARD */
                    <Card key={item.id} className="group hover:shadow-lg transition-all duration-300 border-t-4 border-t-teal-500 flex flex-col h-full">
                        <CardHeader className="pb-3">
                            <div className="flex justify-between items-start mb-2">
                                <Badge variant="secondary" className="bg-teal-50 text-teal-700 hover:bg-teal-100 border-teal-200 font-mono">{item.subjectCode}</Badge>
                                <span className="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-0.5 rounded-full border border-green-200">v{item.version}</span>
                            </div>
                            <CardTitle className="text-lg leading-snug group-hover:text-teal-700 transition-colors min-h-[3.5rem] line-clamp-2">{item.subjectNameVi}</CardTitle>
                            <p className="text-xs text-muted-foreground line-clamp-1 italic">{item.subjectNameEn}</p>
                        </CardHeader>
                        <CardContent className="flex-1 pb-4">
                            <p className="text-sm text-gray-600 line-clamp-3 mb-4 h-[4.5em]">{item.description || "Cha c m t tm tt cho hc phn ny."}</p>
                            <div className="space-y-2 pt-4 border-t border-dashed">
                                <div className="flex items-center gap-2 text-xs text-gray-500"><BookOpen className="w-3.5 h-3.5 text-teal-500" /> <span className="font-medium">{item.credits} tn ch</span></div>
                                <div className="flex items-center gap-2 text-xs text-gray-500"><User className="w-3.5 h-3.5 text-purple-500" /> <span>GV: {item.lecturer}</span></div>
                                <div className="flex items-center gap-2 text-xs text-gray-500"><Clock className="w-3.5 h-3.5 text-orange-500" /> <span>Cp nht: {item.dateEdited}</span></div>
                            </div>
                        </CardContent>
                        <CardFooter className="pt-0 pb-6 px-6">
                            <Link href={`/portal/${item.id}`} className="w-full">
                                {/* I NT ACTION */}
                                <Button className="w-full bg-teal-700 hover:bg-teal-800 text-white transition-colors shadow-lg shadow-teal-100">Xem chi tit</Button>
                            </Link>
                        </CardFooter>
                    </Card>
                ))
            )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="apps/web/app/layout.tsx">
// apps/web/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "SMD System",
  description: "Syllabus Management System",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
        {children}
      </body>
    </html>
  );
}
</file>

<file path="apps/web/components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="apps/web/components/DashboardCharts.tsx">
"use client";

import React from "react";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend, BarChart, Bar, XAxis, YAxis, CartesianGrid } from "recharts";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { FileText, Users, CheckCircle, Clock } from "lucide-react";

interface StatsData {
  total_syllabus: number;
  total_users: number;
  status_breakdown: { name: string; value: number; fill: string }[];
}

export default function DashboardCharts({ data }: { data: StatsData | null }) {
  if (!data) return <div className="h-48 flex items-center justify-center text-gray-400">ang ti thng k...</div>;

  const approvedCount = data.status_breakdown.find(i => i.name === " duyt")?.value || 0;
  const pendingCount = data.status_breakdown.find(i => i.name === "Ch duyt")?.value || 0;

  return (
    <div className="space-y-6 mb-8 animate-in fade-in-50 slide-in-from-top-5 duration-500">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {/* SA: Card ny i t Blue -> Teal */}
        <Card className="bg-teal-50 border-teal-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-teal-100 rounded-full text-teal-600"><FileText className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">Tng  cng</p>
                    <h3 className="text-2xl font-bold text-teal-700">{data.total_syllabus}</h3>
                </div>
            </CardContent>
        </Card>

        {/* Cc Card khc gi nguyn mu  phn bit trng thi (Xanh l, Vng, Tm) */}
        <Card className="bg-green-50 border-green-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-green-100 rounded-full text-green-600"><CheckCircle className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium"> cng b</p>
                    <h3 className="text-2xl font-bold text-green-700">{approvedCount}</h3>
                </div>
            </CardContent>
        </Card>

        <Card className="bg-yellow-50 border-yellow-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-yellow-100 rounded-full text-yellow-600"><Clock className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">ang ch duyt</p>
                    <h3 className="text-2xl font-bold text-yellow-700">{pendingCount}</h3>
                </div>
            </CardContent>
        </Card>

        <Card className="bg-purple-50 border-purple-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-purple-100 rounded-full text-purple-600"><Users className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">Ngi dng</p>
                    <h3 className="text-2xl font-bold text-purple-700">{data.total_users}</h3>
                </div>
            </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Card className="shadow-sm">
            <CardHeader><CardTitle className="text-lg">T l trng thi  cng</CardTitle></CardHeader>
            <CardContent className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                        <Pie
                            data={data.status_breakdown}
                            cx="50%" cy="50%"
                            innerRadius={60} outerRadius={100}
                            paddingAngle={5}
                            dataKey="value"
                        >
                            {data.status_breakdown.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.fill} stroke="none"/>
                            ))}
                        </Pie>
                        <Tooltip />
                        <Legend verticalAlign="bottom" height={36}/>
                    </PieChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>

        <Card className="shadow-sm">
            <CardHeader><CardTitle className="text-lg">Thng k s lng</CardTitle></CardHeader>
            <CardContent className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={data.status_breakdown} margin={{top: 20, right: 30, left: 0, bottom: 5}}>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                        <XAxis dataKey="name" tick={{fontSize: 12}} />
                        <YAxis allowDecimals={false} />
                        <Tooltip cursor={{fill: 'transparent'}} />
                        <Bar dataKey="value" radius={[4, 4, 0, 0]}>
                            {data.status_breakdown.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.fill} />
                            ))}
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/components/Header.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { LogOut, Bell } from "lucide-react";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import axios from "@/lib/axios";

export default function Header() {
  const router = useRouter();
  const [user, setUser] = useState<{ full_name: string; role: string } | null>(null);
  const [academicYear, setAcademicYear] = useState("Loading...");
  
  // State cho thng bo
  const [notifications, setNotifications] = useState<any[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);

  // Hm fetch user & info
  useEffect(() => {
    const fetchData = async () => {
      const token = localStorage.getItem("access_token");
      if (!token) { router.push("/login"); return; }

      try {
        // Ly User Info
        const userRes = await axios.get("/users/me");
        const userData = userRes.data;
        setUser(userData);
        if (userData?.role) localStorage.setItem("role", userData.role);

        // Ly Nm hc
        try {
          const sysRes = await axios.get("/system/info");
          const sys = sysRes.data;
          setAcademicYear(sys?.activeYearName || "Cha cu hnh");
        } catch (e) { /* ignore */ }
      } catch (err: any) {
        console.error(err);
        localStorage.removeItem("access_token");
        router.push("/login");
      }
    };
    fetchData();
  }, [router]);

  // Hm fetch thng bo (Polling)
  const fetchNotifications = async () => {
      try {
          const dataRes = await axios.get("/notifications");
          const data = dataRes.data;
          setNotifications(data.data || []);
          setUnreadCount(data.unread || 0);
      } catch(e) { console.error(e); }
  };

  useEffect(() => {
      fetchNotifications();
      const interval = setInterval(fetchNotifications, 15000); // T ng check mi 15s
      return () => clearInterval(interval);
  }, []);

  const handleRead = async (notif: any) => {
      if(!notif.is_read) {
          try {
            await axios.post(`/notifications/${notif.id}/read`);
            setUnreadCount(prev => Math.max(0, prev - 1));
            setNotifications(prev => prev.map(n => n.id === notif.id ? {...n, is_read: true} : n));
          } catch(e) { console.error(e); }
      }
      if(notif.link) router.push(notif.link);
  };

  const handleLogout = () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    localStorage.removeItem("role");
    router.push("/login");
  };

  return (
    <header className="flex items-center justify-between gap-4 py-4 px-6 border-b border-border bg-background sticky top-0 z-10 shadow-sm">
      <div className="flex items-center gap-3">
        <div className="text-sm font-medium text-teal-800 bg-teal-50 px-3 py-1 rounded-full border border-teal-100">
             {academicYear}
        </div>
      </div>

      <div className="flex items-center gap-4">
        {user ? (
            <>
                {/* --- CHUNG THNG BO --- */}
                <Popover>
                    <PopoverTrigger asChild>
                        <Button variant="ghost" size="icon" className="relative">
                            <Bell className="w-5 h-5 text-gray-600" />
                            {unreadCount > 0 && (
                                <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                            )}
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent className="w-80 p-0" align="end">
                        <div className="p-3 border-b font-semibold text-sm bg-slate-50 rounded-t-md flex justify-between">
                            <span>Thng bo</span>
                            <span className="text-xs text-gray-500 font-normal">{unreadCount} cha c</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto">
                            {notifications.length === 0 ? (
                                <div className="p-8 text-center text-xs text-gray-400">Khng c thng bo mi</div>
                            ) : (
                                notifications.map((n: any) => (
                                    <div 
                                        key={n.id} 
                                        onClick={() => handleRead(n)}
                                        className={`p-3 border-b cursor-pointer hover:bg-slate-50 transition-colors ${!n.is_read ? 'bg-blue-50/60' : ''}`}
                                    >
                                        <div className="text-sm font-semibold text-slate-800 mb-0.5">{n.title}</div>
                                        <div className="text-xs text-slate-600 line-clamp-2">{n.message}</div>
                                        <div className="text-[10px] text-slate-400 mt-2 text-right">
                                            {new Date(n.created_at).toLocaleString('vi-VN')}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </PopoverContent>
                </Popover>

                {/* --- USER INFO --- */}
                <div className="text-right hidden md:block">
                    <div className="text-sm font-bold">{user.full_name}</div>
                    <div className="text-xs text-muted-foreground">{user.role}</div>
                </div>
                <Avatar>
                    <AvatarFallback className={user.role === "Lecturer" ? "bg-teal-100 text-teal-600" : "bg-purple-100 text-purple-600"}>
                        {user.role === "Lecturer" ? "GV" : "NV"}
                    </AvatarFallback>
                </Avatar>
                <Button variant="ghost" size="icon" onClick={handleLogout} title="Logout">
                    <LogOut className="w-5 h-5 text-gray-500" />
                </Button>
            </>
        ) : (
            <div className="text-sm text-muted-foreground">Loading...</div>
        )}
      </div>
    </header>
  );
}
</file>

<file path="apps/web/components/Sidebar.tsx">
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { 
    LayoutDashboard, 
    FilePlus2, 
    FileCheck, 
    UserCircle, 
    BookOpen,
    Menu,
    UserCog,
    FileClock,
    Settings
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger, SheetTitle } from "@/components/ui/sheet";

export default function Sidebar() {
  const pathname = usePathname();
  const [role, setRole] = useState("");

  useEffect(() => {
    setRole(localStorage.getItem("role") || "");
  }, []);

  const menuItems = [
    { 
        name: "Dashboard", 
        href: "/", 
        icon: LayoutDashboard,
        roles: ["ALL"] 
    },
    { 
        name: "Bin son  cng", 
        href: "/syllabus/create", 
        icon: FilePlus2,
        roles: ["Lecturer", "Head of Dept", "Admin"] 
    },
    { 
        name: "Yu cu ph duyt", 
        href: "/reviews", 
        icon: FileCheck,
        roles: ["Head of Dept", "Academic Affairs", "Admin"] 
    },
    { 
        name: "Qun tr User", 
        href: "/admin/users", 
        icon: UserCog,
        roles: ["Admin"] 
    },
    { 
        name: "Cu hnh h thng",
        href: "/admin/settings", 
        icon: Settings,
        roles: ["Admin"] 
    },
    { 
        name: "Nht k h thng", 
        href: "/admin/logs", 
        icon: FileClock,
        roles: ["Admin"] 
    },
    { 
        name: "Cng sinh vin", 
        href: "/portal", 
        icon: BookOpen,
        roles: ["ALL"] 
    },
    { 
        name: "H s c nhn", 
        href: "/profile", 
        icon: UserCircle,
        roles: ["ALL"] 
    },
  ];

  const filteredMenu = menuItems.filter(item => 
    item.roles.includes("ALL") || item.roles.includes(role)
  );

  const NavContent = () => (
    <div className="flex flex-col h-full">
        <div className="mb-8 px-2">
          {/* I MU LOGO */}
          <h1 className="text-xl font-extrabold text-teal-700 tracking-tight flex items-center gap-2">
            <BookOpen className="w-6 h-6"/> SMD System
          </h1>
          <p className="text-xs text-slate-500 mt-1 ml-8">Syllabus Management</p>
        </div>
        
        <nav className="flex-1 space-y-1">
          {filteredMenu.map((m) => {
            const isActive = pathname === m.href;
            return (
                <Link
                  key={m.href}
                  href={m.href}
                  className={`flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200
                    ${isActive 
                        /* I MU ACTIVE: Blue -> Teal */
                        ? "bg-teal-50 text-teal-800 shadow-sm border border-teal-100 font-bold" 
                        : "text-slate-600 hover:bg-teal-50 hover:text-teal-700"
                    }`}
                >
                  <m.icon className={`w-5 h-5 ${isActive ? "text-teal-700" : "text-slate-400"}`} />
                  <span>{m.name}</span>
                </Link>
            );
          })}
        </nav>

        <div className="mt-auto border-t pt-4">
             <div className="text-xs text-center text-slate-400">
                v1.2.0-config
             </div>
        </div>
    </div>
  );

  return (
    <>
      <aside className="hidden md:flex md:flex-col md:w-64 md:h-screen md:fixed md:inset-y-0 md:overflow-y-auto md:bg-white md:border-r md:border-slate-200 md:p-4 z-50">
        <NavContent />
      </aside>

      <div className="md:hidden">
        <Sheet>
          <SheetTrigger asChild>
            <Button variant="ghost" size="icon" className="fixed top-3 left-4 z-50 bg-white shadow-sm border">
              <Menu className="w-5 h-5 text-slate-700" />
            </Button>
          </SheetTrigger>
          <SheetContent side="left" className="w-72 p-4">
            <SheetTitle className="sr-only">Menu</SheetTitle>
            <NavContent />
          </SheetContent>
        </Sheet>
      </div>
    </>
  );
}
</file>

<file path="apps/web/components/syllabus-form/MaterialsTab.tsx">
// apps/web/components/syllabus-form/MaterialsTab.tsx
"use client";

import React from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { SyllabusData } from "../Types";

interface MaterialsTabProps {
  data: SyllabusData;
  readOnly: boolean;
  onUpdate: (index: number, val: string) => void;
  onAdd: (type: "Main" | "Ref") => void;
  onRemove: (index: number) => void;
}

export default function MaterialsTab({ data, readOnly, onUpdate, onAdd, onRemove }: MaterialsTabProps) {
  
  const renderSection = (type: "Main" | "Ref", label: string) => (
    <div className="bg-slate-50 p-4 rounded-md mb-4 border border-slate-200">
      <h3 className="font-bold mb-3 text-slate-700">{label}</h3>
      <div className="space-y-3">
        {data.materials.map((m, originalIndex) => ({ m, originalIndex }))
          .filter(item => item.m.type === type)
          .map(({ m, originalIndex }, i) => (
            <div key={originalIndex} className="flex gap-2 items-center">
              <span className="text-sm font-bold w-8 text-gray-500">[{i + 1}]</span>
              <Input 
                value={m.content} 
                onChange={(e) => onUpdate(originalIndex, e.target.value)} 
                placeholder="V d: Tn tc gi, Nm xut bn, Tn sch, Nh xut bn..." 
                disabled={readOnly}
                className="bg-white flex-1"
              />
              {!readOnly && (
                <Button variant="ghost" size="icon" onClick={() => onRemove(originalIndex)} className="text-red-500 hover:text-red-700 hover:bg-red-50"></Button>
              )}
            </div>
        ))}
        {/* Hin th thng bo nu cha c ti liu no */}
        {data.materials.filter(m => m.type === type).length === 0 && (
            <div className="text-sm text-gray-400 italic pl-8">Cha c ti liu no.</div>
        )}
      </div>
      {!readOnly && (
        <Button variant="outline" size="sm" className="mt-3 ml-8 border-dashed bg-white" onClick={() => onAdd(type)}>
          + Thm ti liu
        </Button>
      )}
    </div>
  );

  return (
    <div className="animate-in fade-in-50 space-y-4">
      {renderSection("Main", "8.1. Ti liu chnh")}
      {renderSection("Ref", "8.2. Ti liu tham kho")}
    </div>
  );
}
</file>

<file path="apps/web/components/SyllabusDeleteButton.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogAction,
  AlertDialogCancel,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import axios from "@/lib/axios";

export default function SyllabusDeleteButton({ id }: { id: number }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  async function handleDelete() {
    setLoading(true);
    try {
      await axios.delete(`/syllabuses/${id}`);
      alert("Xa thnh cng!");
      router.push("/");
    } catch (err: any) {
      console.error("Network error deleting syllabus:", err);
      const status = err?.response?.status || err?.status;
      const message = err?.response?.data?.detail || err?.message;
      if (status === 401) {
        alert("Phin ng nhp ht hn.");
        router.push("/login");
        return;
      }
      alert(message || "Delete failed");
    } finally {
      setLoading(false);
    }
  }

  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button variant="destructive">Delete</Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Are you sure?</AlertDialogTitle>
          <AlertDialogDescription>
            This action cannot be undone. The syllabus will be permanently deleted.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>Cancel</AlertDialogCancel>
          <AlertDialogAction asChild>
            <Button variant="destructive" onClick={handleDelete} disabled={loading}>
              {loading ? "Deleting..." : "Confirm"}
            </Button>
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
</file>

<file path="apps/web/components/SyllabusDetailView.tsx">
"use client";

import React, { useRef } from "react";
import Link from "next/link";
import { useReactToPrint } from "react-to-print";
import { Printer, ArrowLeft, Pencil } from "lucide-react";
import { Button } from "@/components/ui/button";
// QUAN TRNG: Import ng ng dn
import { SyllabusData } from "./Types"; 

export default function SyllabusDetailView({ syllabus }: { syllabus: SyllabusData }) {
  const contentRef = useRef<HTMLDivElement>(null);
  
  const handlePrint = useReactToPrint({
    contentRef: contentRef,
    documentTitle: `${syllabus.subjectCode}_Syllabus`,
  });

  const printStyle = `
    @page { size: A4; margin: 20mm 20mm 20mm 20mm; } 
    @media print { 
        body { -webkit-print-color-adjust: exact; } 
        .print-break-avoid { break-inside: avoid; }
    }
    .word-table { width: 100%; border-collapse: collapse; font-size: 11pt; }
    .word-table td, .word-table th { border: 1px solid black; padding: 4px; vertical-align: top; }
    .word-header { font-family: "Times New Roman", serif; text-align: center; }
  `;

  return (
    <div className="p-6 bg-gray-100 min-h-screen font-sans">
      <style>{printStyle}</style>
      
      <div className="max-w-[210mm] mx-auto mb-4 flex justify-between print:hidden">
         <Link href="/"><Button variant="ghost"><ArrowLeft className="mr-2 h-4 w-4" /> Quay li</Button></Link>
         <div className="flex gap-2">
            <Link href={`/syllabus/${syllabus.id}/edit`}><Button variant="outline"><Pencil className="mr-2 h-4 w-4" /> Chnh sa</Button></Link>
            <Button onClick={() => handlePrint()}><Printer className="mr-2 h-4 w-4" /> Xut PDF / In</Button>
         </div>
      </div>

      <div className="flex justify-center">
        <div ref={contentRef} className="bg-white w-[210mm] min-h-[297mm] px-[15mm] py-[15mm] shadow-lg print:shadow-none text-black leading-snug" style={{ fontFamily: '"Times New Roman", Times, serif', fontSize: '12pt' }}>
            
            <div className="text-center font-bold mb-4">
                <div className="uppercase text-[11pt]">TRNG H GIAO THNG VN TI TP. H CH MINH</div>
                <div className="uppercase text-[14pt] mt-2"> CNG CHI TIT HC PHN</div>
                <div className="italic font-normal text-[12pt]">(COURSE SYLLABUS)</div>
            </div>

            {/* 1. THNG TIN CHUNG */}
            <div className="mb-4">
                <h3 className="font-bold mb-2">1. Tng qut v hc phn (General course information)</h3>
                <table className="word-table">
                    <tbody>
                        <tr>
                            <td className="w-[140px]">Tn hc phn</td>
                            <td colSpan={5}>
                                <div>Ting Vit: <b>{syllabus.subjectNameVi}</b></div>
                                <div>Ting Anh: <b>{syllabus.subjectNameEn}</b></div>
                                <div>M HP: <b>{syllabus.subjectCode}</b></div>
                            </td>
                        </tr>
                        <tr>
                            <td>S tn ch</td>
                            <td colSpan={5} className="font-bold">{syllabus.credits} ({syllabus.credits}, 0, {syllabus.credits})</td>
                        </tr>
                        <tr className="text-center font-semibold">
                            <td>Phn b thi gian</td><td>L thuyt</td><td>Bi tp/D n</td><td>Thc hnh</td><td>Tng</td><td>T hc</td>
                        </tr>
                        <tr className="text-center">
                            <td></td>
                            <td>{syllabus.timeAllocation.theory}</td>
                            <td>{syllabus.timeAllocation.exercises}</td>
                            <td>{syllabus.timeAllocation.practice}</td>
                            <td className="font-bold">{(syllabus.timeAllocation.theory + syllabus.timeAllocation.exercises + syllabus.timeAllocation.practice)}</td>
                            <td>{syllabus.timeAllocation.selfStudy}</td>
                        </tr>
                        <tr><td>Thang im</td><td colSpan={5}>10</td></tr>
                        <tr><td>HP tin quyt</td><td colSpan={5}>{syllabus.prerequisites}</td></tr>
                        <tr><td>HP hc trc</td><td colSpan={5}>{syllabus.preCourses}</td></tr>
                        <tr><td>HP song hnh</td><td colSpan={5}>{syllabus.coCourses}</td></tr>
                        <tr>
                            <td>Loi hc phn</td>
                            <td colSpan={5}>
                                <span className="mr-8">{syllabus.courseType === 'Bt buc' ? '' : ''} Bt buc</span>
                                <span className="mr-8">{syllabus.courseType === 'T chn bt buc' ? '' : ''} T chn bt buc</span>
                                <span>{syllabus.courseType === 'T chn t do' ? '' : ''} T chn t do</span>
                            </td>
                        </tr>
                        <tr><td>Thuc thnh phn</td><td colSpan={5}>{syllabus.componentType}</td></tr>
                    </tbody>
                </table>
            </div>

            {/* 2. M T */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">2. M t tm tt hc phn (Course description)</h3>
                <p className="text-justify whitespace-pre-line">{syllabus.description}</p>
            </div>

            {/* 3. MC TIU */}
            <div className="mb-4">
                 <h3 className="font-bold mb-1">3. Mc tiu hc phn (Course Objectives)</h3>
                 <p className="mb-1">Hc phn ny trang b cho sinh vin:</p>
                 <ul className="list-none pl-0">
                    {syllabus.objectives.map((obj, i) => <li key={i}>{obj}</li>)}
                 </ul>
            </div>

            {/* 4. CLOs & PLO Mapping */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">4. Chun u ra hc phn (Course Learning Outcomes - CLO)</h3>
                <p className="mb-2">Sau khi hc xong hc phn ny sinh vin c kh nng:</p>
                {syllabus.clos.map((c, i) => (
                    <div key={i} className="mb-1 text-justify flex">
                        <span className="font-bold min-w-[60px]">{c.code} :</span>
                        <span>{c.description}</span>
                    </div>
                ))}
                
                <p className="mt-2 mb-1 italic">Lin h gia CR hc phn (CLOs) v CR CTT (PLOs):</p>
                <table className="word-table text-center">
                    <thead>
                        <tr className="bg-gray-100">
                            <th>PLO/CLO</th>{[1,2,3,4,5,6,7].map(n => <th key={n}>PLO{n}</th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {syllabus.clos.map((clo, i) => {
                             const map = syllabus.ploMapping.find(m => m.cloCode === clo.code)?.plos || {};
                             return (
                                <tr key={i}>
                                    <td className="font-bold">{clo.code}</td>
                                    {[1,2,3,4,5,6,7].map(n => <td key={n}>{map[`PLO${n}`] || ""}</td>)}
                                </tr>
                             )
                        })}
                    </tbody>
                </table>
            </div>

            {/* 5. NHIM V */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">5. Nhim v ca sinh vin (Students duties)</h3>
                <div className="whitespace-pre-line pl-4">{syllabus.studentDuties}</div>
            </div>

            {/* 6. NH GI */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-1">6. Phng php kim tra, nh gi (Assessment methods):</h3>
                <p className="mb-2">Phng php kim tra nh gi ca HP m bo ngi hc t c CR mong i</p>
                <table className="word-table">
                    <thead>
                        <tr className="bg-gray-100 font-bold text-center">
                            <td>Thnh phn nh gi</td><td>Phng php/ Hnh thc nh gi</td><td>CR HP (CLOs)</td><td>Tiu ch nh gi</td><td>Trng s (%)</td>
                        </tr>
                    </thead>
                    <tbody>
                        {syllabus.assessmentScheme.map((item, i) => (
                             <tr key={i} className="text-center">
                                 <td className="text-left">{item.component}</td><td className="text-left">{item.method}</td><td>{item.clos}</td><td>{item.criteria}</td><td>{item.weight}</td>
                             </tr>
                        ))}
                        <tr className="font-bold text-center"><td colSpan={4}>Tng cng</td><td>100</td></tr>
                    </tbody>
                </table>
            </div>

            {/* 7. K HOCH */}
            <div className="mb-4">
                <h3 className="font-bold mb-2">7. K hoch ging dy v hc tp (Teaching and learning plan/outline)</h3>
                <table className="word-table">
                    <thead>
                        <tr className="bg-gray-100 font-bold text-center">
                            <td className="w-[10%]">Tun / Chng</td><td className="w-[40%]">Ni dung</td><td className="w-[10%]">CLOs</td><td className="w-[25%]">Hot ng dy v hc</td><td className="w-[15%]">Dng bi nh gi</td>
                        </tr>
                    </thead>
                    <tbody>
                         <tr className="font-bold bg-gray-50"><td colSpan={5}>PHN L THUYT</td></tr>
                        {syllabus.teachingPlan.map((row, i) => (
                            <tr key={i}>
                                <td className="text-center">{row.week}</td><td className="whitespace-pre-line">{row.content}</td><td className="text-center">{row.clos}</td><td className="text-center whitespace-pre-line">{row.activity}</td><td className="text-center">{row.assessment}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* 8. TI LIU */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-1">8. Ti liu hc tp (Course materials)</h3>
                <div className="font-bold pl-0">8.1. Ti liu chnh (Main materials)</div>
                <div className="pl-4 mb-2">
                    {syllabus.materials.filter(m => m.type === 'Main').map((m, i) => <div key={i}>[{i+1}] {m.content}</div>)}
                </div>
                <div className="font-bold pl-0">8.2. Ti liu tham kho (References materials)</div>
                <div className="pl-4">
                    {syllabus.materials.filter(m => m.type === 'Ref').map((m, i) => <div key={i}>[{i+1}] {m.content}</div>)}
                </div>
            </div>

            {/* 9. YU CU KHC ( C) */}
            <div className="mb-4">
                 <h3 className="font-bold mb-1">9. Yu cu khc v hc phn (Other course requirements and expectations)</h3>
                 <div className="pl-4 whitespace-pre-line">{syllabus.otherRequirements || "Khng"}</div>
            </div>

            {/* 10. CH K */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-2">10. Bin son v cp nht  cng</h3>
                <div className="pl-4">
                    <div>- Ngy bin son ln u: {syllabus.datePrepared}</div>
                    <div>- Ngy chnh sa: {syllabus.dateEdited}</div>
                </div>
                
                <table className="w-full mt-6 text-center font-bold border-none uppercase">
                    <tbody>
                        <tr><td className="w-1/3 align-top pb-24">PHNG O TO</td><td className="w-1/3 align-top pb-24">QUN L CTT</td><td className="w-1/3 align-top pb-24">GV LP  CNG</td></tr>
                        <tr><td></td><td>( k)</td><td>( k)</td></tr>
                        <tr><td></td><td>{syllabus.dean}</td><td>{syllabus.lecturer}</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/components/SyllabusEditForm.tsx">
"use client";

import React, { useState, useEffect, useMemo } from "react";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { 
    Save, 
    Send, 
    FileDiff, 
    ArrowLeft, 
    MessageSquareWarning, 
    Sparkles, 
    Loader2   
} from "lucide-react";
import { SyllabusData } from "./Types";
import MaterialsTab from "./syllabus-form/MaterialsTab";
import axios from "@/lib/axios";

interface ExtendedSyllabusData extends SyllabusData {
    feedback?: string | null;
}

export default function SyllabusEditForm({ initial }: { initial: SyllabusData }) {
  const router = useRouter();
  
  const [data, setData] = useState<ExtendedSyllabusData>(initial);
  const [lastSavedString, setLastSavedString] = useState(JSON.stringify(initial));
  const [submitting, setSubmitting] = useState(false);
  const [userRole, setUserRole] = useState<string>("");
  const [aiLoading, setAiLoading] = useState(false);

  useEffect(() => {
    const role = localStorage.getItem("role") || "";
    setUserRole(role);
  }, []);

  const hasUnsavedChanges = useMemo(() => {
    return JSON.stringify(data) !== lastSavedString;
  }, [data, lastSavedString]);

  const isEditable = !data.id || data.status === "Draft" || data.status === "Returned";


  const updateField = (field: keyof SyllabusData, value: any) => {
    if (isEditable) setData((prev) => ({ ...prev, [field]: value }));
  };

  const updateTime = (key: keyof SyllabusData["timeAllocation"], val: number) => {
    if (isEditable) setData((prev) => ({
      ...prev,
      timeAllocation: { ...prev.timeAllocation, [key]: val },
    }));
  }; 

  const addArrayItem = <T,>(field: keyof SyllabusData, newItem: T) => {
    if (isEditable) setData((prev) => ({
      ...prev,
      [field]: [...(prev[field] as T[]), newItem],
    }));
  };

  const removeArrayItem = (field: keyof SyllabusData, index: number) => {
    if (isEditable) setData((prev) => ({
      ...prev,
      [field]: (prev[field] as any[]).filter((_, i) => i !== index),
    }));
  };

  const updateArrayItem = <T,>(field: keyof SyllabusData, index: number, newItem: Partial<T>) => {
    if (isEditable) {
      const arr = [...(data[field] as T[])];
      arr[index] = { ...arr[index], ...newItem };
      setData((prev) => ({ ...prev, [field]: arr }));
    }
  };

  const handleAIGenerate = async () => {
    if (!data.subjectNameVi) return alert("Vui lng nhp Tn mn hc (Ting Vit)  AI hiu  bn!");

    if (!confirm(`AI s t ng son tho ni dung cho mn "${data.subjectNameVi}". D liu hin ti s b ghi . Bn c chc khng?`)) return; 

    setAiLoading(true);
    try {
        const res = await axios.post("/ai/generate", { subject_name: data.subjectNameVi }, { skipSnake: true } as any);
        const aiData = res.data;
        setData(prev => ({
            ...prev,
            ...aiData,
            id: prev.id,
            status: prev.status,
            version: prev.version
        }));
        alert("AI  son tho xong! Vui lng kim tra li cc Tab.");
    } catch (e: any) {
        console.error(e);
        const msg = e?.response?.data?.detail || e?.message || "Li kt ni n AI Server.";
        alert(msg);
    } finally {
        setAiLoading(false);
    }
  };

  const handleSave = async () => {
    setSubmitting(true);
    try {
      const isEdit = !!data.id;

      if (!isEdit) {
        // Create parent syllabus first (axios will convert camelCase -> snake_case on POST)
        const parentPayload: any = { ...data };
        delete parentPayload.clos;
        delete parentPayload.teachingPlan;
        delete parentPayload.materials;

        const res = await axios.post("/syllabuses", parentPayload);
        const resJson = res.data;
        if (!resJson?.id) throw new Error("No id returned from server");

        const syllabusId = resJson.id;

        // Create children (CLOs, Teaching Plans, Materials) using Promise.all
        const closPromises = (data.clos || []).map((clo) => axios.post("/syllabus-clos", { syllabus_id: syllabusId, ...clo }));
        const planPromises = (data.teachingPlan || []).map((p) => axios.post("/teaching-plans", { syllabus_id: syllabusId, ...p }));
        const matPromises = (data.materials || []).map((m) => axios.post("/syllabus-materials", { syllabus_id: syllabusId, ...m }));

        await Promise.all([...closPromises, ...planPromises, ...matPromises]);

        const newData = { ...data, id: syllabusId };
        setData(newData);
        setLastSavedString(JSON.stringify(newData));
        router.push(`/syllabus/${syllabusId}/edit`);
        alert("To mi thnh cng!");
        return;
      }

      // Edit existing syllabus
      await axios.patch(`/syllabuses/${data.id}`, data);
      setLastSavedString(JSON.stringify(data));
      router.refresh();
      alert(" lu bn nhp!");

    } catch (error: any) {
      console.error("Save Error:", error);
      if (error?.status === 401) {
        alert("Phin ng nhp ht hn.");
        router.push("/login");
        return;
      }
      alert(error?.message || "Li khi lu d liu.");
    } finally {
      setSubmitting(false);
    }
  };

  const handleWorkflow = async (action: "submit" | "approve" | "revise") => {
    if (!data.id) return;

    let confirmMsg = "";
    if (action === "submit") confirmMsg = "Gi  cng i ph duyt? Bn s khng th chnh sa trong lc ch.";
    if (action === "approve") confirmMsg = "Xc nhn PH DUYT  cng ny?";
    if (action === "revise") confirmMsg = "H thng s to phin bn MI (Draft) t bn ny  bn chnh sa. Tip tc?";

    if (!confirm(confirmMsg)) return;

    setSubmitting(true);
    try {
      const res = await axios.post(`/syllabuses/${data.id}/${action}`);
      const resData = res.data;

      if (action === "revise") {
        alert(` to phin bn mi: ${resData.version}`);
        router.push(`/syllabus/${resData.id}/edit`);
        return;
      }
      alert("Thao tc thnh cng!");
      router.refresh();
    } catch (e: any) {
      console.error(e);
      const msg = e?.response?.data?.detail || e?.message || "Li kt ni server.";
      alert(msg);
    } finally {
      setSubmitting(false);
    }
  };

  const totalPeriods = (data.timeAllocation.theory || 0) + (data.timeAllocation.exercises || 0) + (data.timeAllocation.practice || 0);

  const renderStatusBadge = () => {
    const status = data.status || "Draft";
    let colorClass = "bg-gray-500";
    let label = "Bn nhp";

    if (status === "Pending") { colorClass = "bg-yellow-500"; label = "Ch duyt (BM)"; }
    else if (status === "Pending Approval") { colorClass = "bg-orange-500"; label = "Ch duyt (PT)"; }
    else if (status === "Approved") { colorClass = "bg-green-600"; label = " cng b"; }
    else if (status === "Returned") { colorClass = "bg-red-500"; label = "Yu cu sa"; }

    return <Badge className={`${colorClass} hover:${colorClass} ml-3 text-sm px-3 py-1`}>{label}</Badge>;
  };

  return (
    <div className="w-full max-w-6xl mx-auto py-6 px-4">
      {data.status === "Returned" && data.feedback && (
          <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex gap-3 items-start shadow-sm animate-in slide-in-from-top-2">
             <MessageSquareWarning className="w-6 h-6 text-red-600 mt-0.5 shrink-0" />
             <div>
                <h3 className="font-bold text-red-700 text-lg">Yu cu chnh sa</h3>
                <p className="text-red-600 mt-1 whitespace-pre-wrap">{data.feedback}</p>
             </div>
          </div>
      )}

      <Card className="shadow-lg border-t-4 border-t-primary">
        <CardHeader className="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 mb-4 bg-slate-50/50 rounded-t-lg gap-4">
          <div>
            <div className="flex items-center gap-2">
              <CardTitle className="text-xl">
                {data.id ? `Bin son: ${data.subjectCode}` : "To  Cng Mi"}
              </CardTitle>
              {data.version && <Badge variant="outline" className="border-primary text-primary font-bold">v{data.version}</Badge>}
              {renderStatusBadge()}
            </div>
            <p className="text-sm text-gray-500 mt-1">
              {isEditable ? "Bn ang  ch  chnh sa" : "Ch  xem (Read-only)"}
            </p>
          </div>

          <div className="flex flex-wrap gap-2 items-center">
            <Button variant="outline" onClick={() => router.back()} size="sm">
                <ArrowLeft className="w-4 h-4 mr-2"/> Thot
            </Button>

            {isEditable && (
              <Button onClick={handleSave} disabled={submitting || aiLoading} variant="secondary" className="border border-slate-300 relative" size="sm">
                <Save className="w-4 h-4 mr-2" /> Lu Nhp
                {hasUnsavedChanges && (
                    <span className="absolute -top-1 -right-1 flex h-3 w-3">
                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                      <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                )}
              </Button>
            )}

            {data.id && (
              <>
                {(data.status === "Draft" || data.status === "Returned") && (
                  <div className="flex flex-col items-end">
                      {/* SA: bg-blue-600 -> bg-teal-600 */}
                      <Button 
                        className="bg-teal-600 hover:bg-teal-700 text-white disabled:opacity-50 disabled:cursor-not-allowed" 
                        size="sm" 
                        onClick={() => handleWorkflow("submit")}
                        disabled={hasUnsavedChanges || submitting || aiLoading}
                        title={hasUnsavedChanges ? "Bn cn lu nhp trc khi gi duyt" : "Gi i ph duyt"}
                      >
                        <Send className="w-4 h-4 mr-2" /> Gi Duyt
                      </Button>
                  </div>
                )}

                {(data.status === "Pending" || data.status === "Pending Approval") && (userRole === "Head of Dept" || userRole === "Academic Affairs" || userRole === "Admin") && (
                  <div className="flex gap-2">
                    <Button variant="outline" size="sm" onClick={() => router.push("/reviews")}>
                         X l yu cu ny (Duyt/Tr v)
                    </Button>
                  </div>
                )}

                {data.status === "Approved" && (
                    <Button className="bg-purple-600 hover:bg-purple-700 text-white border-purple-800" size="sm" onClick={() => handleWorkflow("revise")}>
                        <FileDiff className="w-4 h-4 mr-2" /> To phin bn mi
                    </Button>
                )}
              </>
            )}
          </div>
        </CardHeader>

        <CardContent className={!isEditable ? "opacity-95 pointer-events-none" : ""}>
          <Tabs defaultValue="general" className="w-full">
            <TabsList className="grid w-full grid-cols-7 mb-6 h-auto p-1 bg-slate-100">
              <TabsTrigger value="general">1. Thng tin chung</TabsTrigger>
              <TabsTrigger value="clos">2-4. Mc tiu & CR</TabsTrigger>
              <TabsTrigger value="plo">PLO Map</TabsTrigger>
              <TabsTrigger value="assessment">5-6. nh gi</TabsTrigger>
              <TabsTrigger value="plan">7. K hoch</TabsTrigger>
              <TabsTrigger value="materials">8. Ti liu</TabsTrigger>
              <TabsTrigger value="others">9. Khc</TabsTrigger>
            </TabsList>

            <TabsContent value="general" className="space-y-6 animate-in fade-in-50">
              <div className="grid grid-cols-2 gap-6">
                <div className="space-y-2">
                    <label className="text-sm font-semibold flex justify-between items-center">
                        Tn HP (Ting Vit)
                        {isEditable && (
                            <button 
                                onClick={handleAIGenerate} 
                                disabled={aiLoading}
                                className="text-xs flex items-center gap-1 text-purple-600 hover:text-purple-800 font-bold transition-all hover:scale-105 border border-purple-200 px-2 py-1 rounded-full bg-purple-50"
                                title="T ng in ni dung bng AI"
                            >
                                {aiLoading ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>}
                                {aiLoading ? "AI ang vit..." : "AI Son tho"}
                            </button>
                        )}
                    </label>
                    <Input value={data.subjectNameVi} onChange={(e) => updateField("subjectNameVi", e.target.value)} placeholder="VD: Nhp mn Tr tu Nhn to"/>
                </div>
                <div className="space-y-2"><label className="text-sm font-semibold">Tn HP (Ting Anh)</label><Input value={data.subjectNameEn} onChange={(e) => updateField("subjectNameEn", e.target.value)} /></div>
                <div className="space-y-2"><label className="text-sm font-semibold">M Hc Phn</label><Input value={data.subjectCode} onChange={(e) => updateField("subjectCode", e.target.value)} /></div>
                <div className="space-y-2"><label className="text-sm font-semibold">S tn ch</label><Input type="number" value={data.credits} onChange={(e) => updateField("credits", Number(e.target.value))} /></div>
              </div>
              <div className="border p-4 rounded-md bg-slate-50">
                <h3 className="font-bold mb-4 text-sm uppercase text-slate-600">Phn b thi gian (Tit)</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                  <label className="text-sm">L thuyt <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.theory} onChange={(e) => updateTime("theory", Number(e.target.value))} /></label>
                  <label className="text-sm">Bi tp/D n <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.exercises} onChange={(e) => updateTime("exercises", Number(e.target.value))} /></label>
                  <label className="text-sm">Thc hnh <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.practice} onChange={(e) => updateTime("practice", Number(e.target.value))} /></label>
                  <label className="text-sm">T hc <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.selfStudy} onChange={(e) => updateTime("selfStudy", Number(e.target.value))} /></label>
                  <div className="text-sm font-bold pb-2 text-right md:text-left">Tng trn lp: <span className="text-lg text-primary ml-2">{totalPeriods}</span></div>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <label className="text-sm font-semibold">HP Tin quyt <Input className="mt-1" value={data.prerequisites} onChange={(e) => updateField("prerequisites", e.target.value)} /></label>
                <label className="text-sm font-semibold">HP Hc trc <Input className="mt-1" value={data.preCourses} onChange={(e) => updateField("preCourses", e.target.value)} /></label>
                <label className="text-sm font-semibold">HP Song hnh <Input className="mt-1" value={data.coCourses} onChange={(e) => updateField("coCourses", e.target.value)} /></label>
              </div>
               <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <label className="text-sm font-semibold">Loi hc phn <select className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background mt-1" value={data.courseType} onChange={(e) => updateField("courseType", e.target.value)}><option value="Bt buc">Bt buc</option><option value="T chn bt buc">T chn bt buc</option><option value="T chn t do">T chn t do</option></select></label>
                <label className="text-sm font-semibold">Thuc thnh phn <Input className="mt-1" value={data.componentType} onChange={(e) => updateField("componentType", e.target.value)} /></label>
              </div>
              <div className="border-t pt-4 grid grid-cols-1 md:grid-cols-4 gap-6">
                <label className="text-sm font-semibold">Ngy bin son <Input type="date" className="mt-1" value={data.datePrepared} onChange={(e) => updateField("datePrepared", e.target.value)} /></label>
                <label className="text-sm font-semibold">Ngy chnh sa <Input type="date" className="mt-1" value={data.dateEdited} onChange={(e) => updateField("dateEdited", e.target.value)} /></label>
                <label className="text-sm font-semibold">Trng khoa/QL CTT <Input className="mt-1" value={data.dean} onChange={(e) => updateField("dean", e.target.value)} /></label>
                <label className="text-sm font-semibold">GV Bin son <Input className="mt-1 bg-gray-100" value={data.lecturer} disabled /></label>
              </div>
            </TabsContent>

            {/* Cc TabsContent khc (clos, plo, assessment, plan, materials, others) gi nguyn code c v khng c mu cng, n s t n theo mu Primary mi */}
            <TabsContent value="clos" className="space-y-6 animate-in fade-in-50">
              <div><label className="font-bold block mb-2">2. M t tm tt hc phn</label><Textarea rows={4} value={data.description} onChange={(e) => updateField("description", e.target.value)} /></div>
              <div className="bg-slate-50 p-4 rounded-md">
                <label className="font-bold block mb-2">3. Mc tiu hc phn (Course Objectives)</label>
                {data.objectives.map((obj, i) => (
                  <div key={i} className="flex gap-2 mb-2"><Input value={obj} onChange={(e) => { const newObj = [...data.objectives]; newObj[i] = e.target.value; updateField("objectives", newObj); }} /><Button variant="ghost" onClick={() => { const newObj = data.objectives.filter((_, idx) => idx !== i); updateField("objectives", newObj); }}></Button></div>
                ))}
                <Button variant="outline" size="sm" className="mt-2 border-dashed" onClick={() => updateField("objectives", [...data.objectives, `CO${data.objectives.length + 1}: `])}>+ Thm Mc Tiu (CO)</Button>
              </div>
              <div>
                <label className="font-bold block mb-2">4. Chun u ra hc phn (CLOs)</label>
                <Table>
                  <TableHeader><TableRow><TableHead className="w-24">M CR</TableHead><TableHead>M t chun u ra</TableHead><TableHead className="w-12"></TableHead></TableRow></TableHeader>
                  <TableBody>{data.clos.map((clo, i) => (
                    <TableRow key={i}><TableCell><Input className="font-bold" value={clo.code} onChange={(e) => updateArrayItem("clos", i, { code: e.target.value })} /></TableCell><TableCell><Input value={clo.description} onChange={(e) => updateArrayItem("clos", i, { description: e.target.value })} /></TableCell><TableCell><Button variant="ghost" size="icon" onClick={() => removeArrayItem("clos", i)}></Button></TableCell></TableRow>
                  ))}</TableBody>
                </Table>
                <Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("clos", { code: `CLO${data.clos.length + 1}`, description: "" })}>+ Thm CLO Mi</Button>
              </div>
            </TabsContent>

            <TabsContent value="plo" className="animate-in fade-in-50">
               {/* SA: Alert bg-blue-50 -> bg-teal-50 */}
               <div className="alert bg-teal-50 text-teal-700 p-3 mb-4 text-sm rounded-md border border-teal-100"><strong>Hng dn:</strong> in cc k t (I, R, M, A) vo cc  tng ng.</div>
               <div className="border rounded-md overflow-x-auto"><Table><TableHeader><TableRow><TableHead className="w-24 bg-gray-100">CLO \ PLO</TableHead>{[1, 2, 3, 4, 5, 6, 7].map((p) => (<TableHead key={p} className="text-center w-16 bg-gray-50">PLO{p}</TableHead>))}</TableRow></TableHeader><TableBody>{data.clos.map((clo, i) => { const rowMap = data.ploMapping.find((p) => p.cloCode === clo.code) || { cloCode: clo.code, plos: {} }; return (<TableRow key={i}><TableCell className="font-bold bg-gray-50">{clo.code}</TableCell>{[1, 2, 3, 4, 5, 6, 7].map((p) => (<TableCell key={p} className="p-1"><Input className="h-9 text-center uppercase" value={rowMap.plos[`PLO${p}`] || ""} onChange={(e) => { const val = e.target.value; const newMapping = [...data.ploMapping]; const existIdx = newMapping.findIndex((m) => m.cloCode === clo.code); if (existIdx >= 0) { newMapping[existIdx] = { ...newMapping[existIdx], plos: { ...newMapping[existIdx].plos, [`PLO${p}`]: val } } } else { newMapping.push({ cloCode: clo.code, plos: { [`PLO${p}`]: val } }); } updateField("ploMapping", newMapping); }} /></TableCell>))}</TableRow>); })}</TableBody></Table></div>
            </TabsContent>

            <TabsContent value="assessment" className="space-y-6 animate-in fade-in-50">
               <div><label className="font-bold block mb-2">5. Nhim v ca sinh vin</label><Textarea rows={4} value={data.studentDuties} onChange={(e) => updateField("studentDuties", e.target.value)} /></div>
               <div><div className="flex justify-between items-center mb-2"><label className="font-bold block">6. Phng php kim tra, nh gi</label><div className="text-sm">Tng trng s: <span className={`font-bold ml-2 ${data.assessmentScheme.reduce((sum, item) => sum + (item.weight || 0), 0) === 100 ? 'text-green-600' : 'text-red-600'}`}>{data.assessmentScheme.reduce((sum, item) => sum + (item.weight || 0), 0)}%</span></div></div><div className="border rounded-md"><Table><TableHeader><TableRow><TableHead>Thnh phn</TableHead><TableHead>Phng php / Hnh thc</TableHead><TableHead className="w-24">CR HP</TableHead><TableHead className="w-20">Tiu ch</TableHead><TableHead className="w-20">Trng s (%)</TableHead><TableHead className="w-10"></TableHead></TableRow></TableHeader><TableBody>{data.assessmentScheme.map((item, i) => (<TableRow key={i}><TableCell><Input value={item.component} onChange={(e) => updateArrayItem("assessmentScheme", i, { component: e.target.value })} /></TableCell><TableCell><Input value={item.method} onChange={(e) => updateArrayItem("assessmentScheme", i, { method: e.target.value })} /></TableCell><TableCell><Input value={item.clos} onChange={(e) => updateArrayItem("assessmentScheme", i, { clos: e.target.value })} /></TableCell><TableCell><Input value={item.criteria} onChange={(e) => updateArrayItem("assessmentScheme", i, { criteria: e.target.value })} /></TableCell><TableCell><Input type="number" value={item.weight} onChange={(e) => updateArrayItem("assessmentScheme", i, { weight: Number(e.target.value) })} /></TableCell><TableCell><Button variant="ghost" size="icon" onClick={() => removeArrayItem("assessmentScheme", i)}></Button></TableCell></TableRow>))}</TableBody></Table></div><Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("assessmentScheme", { component: "", method: "", clos: "", criteria: "", weight: 0 })}>+ Thm thnh phn nh gi</Button></div>
            </TabsContent>

            <TabsContent value="plan" className="animate-in fade-in-50">
               <div className="mb-2"><label className="font-bold">7. K hoch ging dy v hc tp</label></div><div className="border rounded-md overflow-hidden"><Table><TableHeader><TableRow><TableHead className="w-20">Tun</TableHead><TableHead className="w-1/3">Ni dung</TableHead><TableHead className="w-24">CLOs</TableHead><TableHead>Hot ng Dy/Hc</TableHead><TableHead className="w-32">nh gi</TableHead><TableHead className="w-10"></TableHead></TableRow></TableHeader><TableBody>{data.teachingPlan.map((row, i) => (<TableRow key={i}><TableCell className="align-top"><Input value={row.week} onChange={(e) => updateArrayItem("teachingPlan", i, { week: e.target.value })} /></TableCell><TableCell className="align-top"><Textarea className="min-h-[80px]" value={row.content} onChange={(e) => updateArrayItem("teachingPlan", i, { content: e.target.value })} /></TableCell><TableCell className="align-top"><Input value={row.clos} onChange={(e) => updateArrayItem("teachingPlan", i, { clos: e.target.value })} /></TableCell><TableCell className="align-top"><Textarea className="min-h-[80px]" value={row.activity} onChange={(e) => updateArrayItem("teachingPlan", i, { activity: e.target.value })} /></TableCell><TableCell className="align-top"><Input value={row.assessment} onChange={(e) => updateArrayItem("teachingPlan", i, { assessment: e.target.value })} /></TableCell><TableCell className="align-top"><Button variant="ghost" size="icon" onClick={() => removeArrayItem("teachingPlan", i)}></Button></TableCell></TableRow>))}</TableBody></Table></div><Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("teachingPlan", { week: "", content: "", clos: "", activity: "", assessment: "" })}>+ Thm Tun / Chng</Button>
            </TabsContent>

            <TabsContent value="materials">
                <MaterialsTab data={data} readOnly={!isEditable} onUpdate={(idx, val) => updateArrayItem("materials", idx, { content: val })} onAdd={(type) => addArrayItem("materials", { type: type, content: "" })} onRemove={(idx) => removeArrayItem("materials", idx)}/>
            </TabsContent>

            <TabsContent value="others" className="space-y-6 animate-in fade-in-50">
              <div className="bg-white p-6 rounded-md border shadow-sm"><label className="font-bold block mb-3 text-lg">9. Yu cu khc v hc phn</label><Textarea rows={8} className="resize-y" value={data.otherRequirements} onChange={(e) => updateField("otherRequirements", e.target.value)} placeholder="V d: Sinh vin phi chun b Laptop c nhn..." /></div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/components/Types.ts">
export type SyllabusStatus = "Draft" | "Pending" | "Approved" | "Returned" | "Pending Approval";

export interface SyllabusData {
  id?: number;
  status: SyllabusStatus;
  version?: string;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  timeAllocation: {
    theory: number;
    exercises: number;
    practice: number;
    selfStudy: number;
  };
  prerequisites: string;
  preCourses: string;
  coCourses: string;
  courseType: string;
  componentType: string;
  description: string;
  objectives: string[];
  clos: { code: string; description: string }[];
  ploMapping: {
    cloCode: string;
    plos: { [key: string]: string };
  }[];
  studentDuties: string;
  assessmentScheme: {
    component: string;
    method: string;
    clos: string;
    criteria: string;
    weight: number;
  }[];
  teachingPlan: {
    week: string;
    content: string;
    clos: string;
    activity: string;
    assessment: string;
  }[];
  materials: {
    type: "Main" | "Ref";
    content: string;
  }[];
  otherRequirements: string;
  datePrepared: string;
  dateEdited: string;
  lecturer: string;
  headDepartment: string;
  dean: string;
}

export const defaultSyllabus: SyllabusData = {
  status: "Draft",
  subjectNameVi: "",
  subjectNameEn: "",
  subjectCode: "",
  credits: 3,
  timeAllocation: { theory: 0, exercises: 0, practice: 0, selfStudy: 0 },
  prerequisites: "",
  preCourses: "",
  coCourses: "",
  courseType: "Bt buc",
  componentType: "C s ngnh",
  description: "",
  objectives: [],
  clos: [],
  ploMapping: [],
  studentDuties: "",
  assessmentScheme: [],
  teachingPlan: [],
  materials: [],
  otherRequirements: "Khng",
  datePrepared: new Date().toISOString().split('T')[0],
  dateEdited: new Date().toISOString().split('T')[0],
  lecturer: "",
  headDepartment: "",
  dean: ""
};
</file>

<file path="apps/web/components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="apps/web/components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="apps/web/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="apps/web/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="apps/web/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="apps/web/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="apps/web/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="apps/web/components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="apps/web/components/ui/sheet.tsx">
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="apps/web/components/ui/table.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="apps/web/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="apps/web/components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<
  HTMLTextAreaElement,
  React.ComponentProps<"textarea">
>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }
</file>

<file path="apps/web/Dockerfile">
# apps/web/Dockerfile
FROM node:20-alpine

WORKDIR /app

# Copy file package  ci th vin trc
COPY package*.json ./

# Tt strict-ssl  trnh li mng ECONNRESET nu mng yu
RUN npm config set strict-ssl false

# Ci t th vin (thm --legacy-peer-deps cho an ton)
RUN npm install --legacy-peer-deps

# Copy ton b code vo
COPY . .

# M port 3000
EXPOSE 3000

# Chy ch  Dev
CMD ["npm", "run", "dev"]
</file>

<file path="apps/web/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="apps/web/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="apps/web/next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
</file>

<file path="apps/web/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="apps/web/package.json">
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-tabs": "^1.1.13",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.561.0",
    "next": "16.0.10",
    "react": "19.2.1",
    "react-dom": "19.2.1",
    "react-to-print": "^3.2.0",
    "recharts": "^3.6.0",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="apps/web/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="apps/web/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="apps/web/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="apps/web/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="apps/web/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="apps/web/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="apps/web/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="apps/web/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

</files>
