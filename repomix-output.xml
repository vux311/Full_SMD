This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
apps/api/.gitignore
apps/api/Dockerfile
apps/api/src/api/controllers/academic_year_controller.py
apps/api/src/api/controllers/admin_controller.py
apps/api/src/api/controllers/ai_controller.py
apps/api/src/api/controllers/assessment_clo_controller.py
apps/api/src/api/controllers/assessment_component_controller.py
apps/api/src/api/controllers/assessment_scheme_controller.py
apps/api/src/api/controllers/auth_controller.py
apps/api/src/api/controllers/clo_plo_mapping_controller.py
apps/api/src/api/controllers/dashboard_controller.py
apps/api/src/api/controllers/department_controller.py
apps/api/src/api/controllers/faculty_controller.py
apps/api/src/api/controllers/file_controller.py
apps/api/src/api/controllers/notification_controller.py
apps/api/src/api/controllers/program_controller.py
apps/api/src/api/controllers/program_outcome_controller.py
apps/api/src/api/controllers/public_controller.py
apps/api/src/api/controllers/role_controller.py
apps/api/src/api/controllers/rubric_controller.py
apps/api/src/api/controllers/search_controller.py
apps/api/src/api/controllers/student_controller.py
apps/api/src/api/controllers/subject_controller.py
apps/api/src/api/controllers/subject_relationship_controller.py
apps/api/src/api/controllers/syllabus_clo_controller.py
apps/api/src/api/controllers/syllabus_comment_controller.py
apps/api/src/api/controllers/syllabus_controller.py
apps/api/src/api/controllers/syllabus_material_controller.py
apps/api/src/api/controllers/system_setting_controller.py
apps/api/src/api/controllers/teaching_plan_controller.py
apps/api/src/api/controllers/user_controller.py
apps/api/src/api/middleware.py
apps/api/src/api/requests.py
apps/api/src/api/responses.py
apps/api/src/api/routes.py
apps/api/src/api/schemas/...  # Marshmallow schemas
apps/api/src/api/schemas/academic_year_schema.py
apps/api/src/api/schemas/assessment_clo_mapping_schema.py
apps/api/src/api/schemas/assessment_component_schema.py
apps/api/src/api/schemas/assessment_scheme_schema.py
apps/api/src/api/schemas/base_schema.py
apps/api/src/api/schemas/clo_plo_mapping_schema.py
apps/api/src/api/schemas/department_schema.py
apps/api/src/api/schemas/faculty_schema.py
apps/api/src/api/schemas/file_schema.py
apps/api/src/api/schemas/notification_schema.py
apps/api/src/api/schemas/program_outcome_schema.py
apps/api/src/api/schemas/program_schema.py
apps/api/src/api/schemas/role_schema.py
apps/api/src/api/schemas/rubric_schema.py
apps/api/src/api/schemas/student_schema.py
apps/api/src/api/schemas/subject_relationship_schema.py
apps/api/src/api/schemas/subject_schema.py
apps/api/src/api/schemas/syllabus_clo_schema.py
apps/api/src/api/schemas/syllabus_comment_schema.py
apps/api/src/api/schemas/syllabus_detail_schema.py
apps/api/src/api/schemas/syllabus_material_schema.py
apps/api/src/api/schemas/syllabus_schema.py
apps/api/src/api/schemas/system_auditlog_schema.py
apps/api/src/api/schemas/system_setting_schema.py
apps/api/src/api/schemas/teaching_plan_schema.py
apps/api/src/api/schemas/user_schema.py
apps/api/src/api/schemas/user.py
apps/api/src/api/schemas/workflow_log_schema.py
apps/api/src/api/swagger.py
apps/api/src/app_logging.py
apps/api/src/app.py
apps/api/src/celery_utils.py
apps/api/src/config.py
apps/api/src/cors.py
apps/api/src/create_app.py
apps/api/src/dependency_container.py
apps/api/src/domain/constants.py
apps/api/src/domain/exceptions.py
apps/api/src/domain/models/...  # Business logic models
apps/api/src/domain/models/user.py
apps/api/src/error_handler.py
apps/api/src/infrastructure/databases/__init__.py
apps/api/src/infrastructure/databases/base.py
apps/api/src/infrastructure/databases/mssql.py
apps/api/src/infrastructure/databases/mysql.py
apps/api/src/infrastructure/models/__init__.py
apps/api/src/infrastructure/models/academic_year_model.py
apps/api/src/infrastructure/models/ai_auditlog_model.py
apps/api/src/infrastructure/models/assessment_clo_model.py
apps/api/src/infrastructure/models/assessment_component_model.py
apps/api/src/infrastructure/models/assessment_scheme_model.py
apps/api/src/infrastructure/models/clo_plo_mapping_model.py
apps/api/src/infrastructure/models/department_model.py
apps/api/src/infrastructure/models/faculty_model.py
apps/api/src/infrastructure/models/file_model.py
apps/api/src/infrastructure/models/notification_model.py
apps/api/src/infrastructure/models/notification_template_model.py
apps/api/src/infrastructure/models/program_model.py
apps/api/src/infrastructure/models/program_outcome_model.py
apps/api/src/infrastructure/models/role_model.py
apps/api/src/infrastructure/models/rubric_model.py
apps/api/src/infrastructure/models/student_report_model.py
apps/api/src/infrastructure/models/student_subscription_model.py
apps/api/src/infrastructure/models/subject_model.py
apps/api/src/infrastructure/models/subject_relationship_model.py
apps/api/src/infrastructure/models/syllabus_clo_model.py
apps/api/src/infrastructure/models/syllabus_comment_model.py
apps/api/src/infrastructure/models/syllabus_current_workflow.py
apps/api/src/infrastructure/models/syllabus_material_model.py
apps/api/src/infrastructure/models/syllabus_model.py
apps/api/src/infrastructure/models/syllabus_snapshot_model.py
apps/api/src/infrastructure/models/system_auditlog_model.py
apps/api/src/infrastructure/models/system_setting_model.py
apps/api/src/infrastructure/models/teaching_plan_model.py
apps/api/src/infrastructure/models/user_model.py
apps/api/src/infrastructure/models/user_role_model.py
apps/api/src/infrastructure/models/workflow_log_model.py
apps/api/src/infrastructure/models/workflow_state_model.py
apps/api/src/infrastructure/models/workflow_transition_model.py
apps/api/src/infrastructure/repositories/academic_year_repository.py
apps/api/src/infrastructure/repositories/ai_auditlog_repository.py
apps/api/src/infrastructure/repositories/assessment_clo_repository.py
apps/api/src/infrastructure/repositories/assessment_component_repository.py
apps/api/src/infrastructure/repositories/assessment_scheme_repository.py
apps/api/src/infrastructure/repositories/clo_plo_mapping_repository.py
apps/api/src/infrastructure/repositories/department_repository.py
apps/api/src/infrastructure/repositories/faculty_repository.py
apps/api/src/infrastructure/repositories/file_repository.py
apps/api/src/infrastructure/repositories/notification_repository.py
apps/api/src/infrastructure/repositories/program_outcome_repository.py
apps/api/src/infrastructure/repositories/program_repository.py
apps/api/src/infrastructure/repositories/role_repository.py
apps/api/src/infrastructure/repositories/rubric_repository.py
apps/api/src/infrastructure/repositories/student_report_repository.py
apps/api/src/infrastructure/repositories/student_subscription_repository.py
apps/api/src/infrastructure/repositories/subject_relationship_repository.py
apps/api/src/infrastructure/repositories/subject_repository.py
apps/api/src/infrastructure/repositories/syllabus_clo_repository.py
apps/api/src/infrastructure/repositories/syllabus_comment_repository.py
apps/api/src/infrastructure/repositories/syllabus_current_workflow_repository.py
apps/api/src/infrastructure/repositories/syllabus_material_repository.py
apps/api/src/infrastructure/repositories/syllabus_repository.py
apps/api/src/infrastructure/repositories/syllabus_snapshot_repository.py
apps/api/src/infrastructure/repositories/system_auditlog_repository.py
apps/api/src/infrastructure/repositories/system_setting_repository.py
apps/api/src/infrastructure/repositories/teaching_plan_repository.py
apps/api/src/infrastructure/repositories/user_repository.py
apps/api/src/infrastructure/repositories/workflow_log_repository.py
apps/api/src/infrastructure/services/...  # Services that use third party libraries or services (e.g. email service)
apps/api/src/make_celery.py
apps/api/src/migrations
apps/api/src/requirements_additional.txt
apps/api/src/requirements.txt
apps/api/src/scripts/add_syllabus_content_columns.py
apps/api/src/scripts/add_syllabus_id_columns.py
apps/api/src/scripts/check_deadlines.py
apps/api/src/scripts/import_check.py
apps/api/src/scripts/list_models.py
apps/api/src/scripts/reset_and_seed.py
apps/api/src/scripts/run_postgres.sh
apps/api/src/scripts/seed_users.py
apps/api/src/SDM-workspace.code-workspace
apps/api/src/services/...  # Services for interacting with the domain (business logic)
apps/api/src/services/academic_year_service.py
apps/api/src/services/ai_service.py
apps/api/src/services/analysis_service.py
apps/api/src/services/assessment_clo_service.py
apps/api/src/services/assessment_component_service.py
apps/api/src/services/assessment_scheme_service.py
apps/api/src/services/clo_plo_mapping_service.py
apps/api/src/services/department_service.py
apps/api/src/services/email_service.py
apps/api/src/services/faculty_service.py
apps/api/src/services/file_service.py
apps/api/src/services/notification_service.py
apps/api/src/services/ocr_service.py
apps/api/src/services/program_outcome_service.py
apps/api/src/services/program_service.py
apps/api/src/services/role_service.py
apps/api/src/services/rubric_service.py
apps/api/src/services/search_service.py
apps/api/src/services/student_service.py
apps/api/src/services/subject_relationship_service.py
apps/api/src/services/subject_service.py
apps/api/src/services/syllabus_clo_service.py
apps/api/src/services/syllabus_comment_service.py
apps/api/src/services/syllabus_material_service.py
apps/api/src/services/syllabus_service.py
apps/api/src/services/syllabus_snapshot_service.py
apps/api/src/services/system_auditlog_service.py
apps/api/src/services/system_setting_service.py
apps/api/src/services/teaching_plan_service.py
apps/api/src/services/user_service.py
apps/api/src/swagger_config.json
apps/api/src/tasks.py
apps/api/src/tests/test_file_service.py
apps/api/src/tests/test_program_outcome_service.py
apps/api/src/tests/test_smoke_imports.py
apps/api/src/tests/test_syllabus_service.py
apps/api/src/utils/caching.py
apps/api/src/utils/logging_config.py
apps/api/src/utils/mail.py
apps/api/src/utils/pagination.py
apps/api/src/utils/performance.py
apps/api/src/utils/socket_io.py
apps/api/tests/add_is_active_column.py
apps/api/tests/e2e_test_flow.py
apps/api/tests/load_test.py
apps/api/tests/test_integration.py
apps/api/tests/test_rbac_quick.py
apps/api/tests/test_rbac.py
apps/api/tests/test_send_notification.py
apps/web/app/(auth)/login/page.tsx
apps/web/app/(main)/admin/departments/page.tsx
apps/web/app/(main)/admin/logs/page.tsx
apps/web/app/(main)/admin/programs/page.tsx
apps/web/app/(main)/admin/reports/page.tsx
apps/web/app/(main)/admin/search/page.tsx
apps/web/app/(main)/admin/settings/page.tsx
apps/web/app/(main)/admin/subjects/page.tsx
apps/web/app/(main)/admin/users/page.tsx
apps/web/app/(main)/dashboard/page.tsx
apps/web/app/(main)/layout.tsx
apps/web/app/(main)/page.tsx
apps/web/app/(main)/profile/page.tsx
apps/web/app/(main)/reviews/page.tsx
apps/web/app/(main)/syllabus/[id]/edit/page.tsx
apps/web/app/(main)/syllabus/[id]/page.tsx
apps/web/app/(main)/syllabus/compare/page.tsx
apps/web/app/(main)/syllabus/create/page.tsx
apps/web/app/(public)/layout.tsx
apps/web/app/(public)/portal/[id]/page.tsx
apps/web/app/(public)/portal/page.tsx
apps/web/app/favicon.ico
apps/web/app/globals.css
apps/web/app/layout.tsx
apps/web/app/page.tsx
apps/web/components.json
apps/web/components/DashboardCharts.tsx
apps/web/components/Header.tsx
apps/web/components/Sidebar.tsx
apps/web/components/StudentActionButtons.tsx
apps/web/components/syllabus-form/MaterialsTab.tsx
apps/web/components/SyllabusDeleteButton.tsx
apps/web/components/SyllabusDetailView.tsx
apps/web/components/SyllabusEditForm.tsx
apps/web/components/SyllabusHistory.tsx
apps/web/components/Types.ts
apps/web/components/ui/alert-dialog.tsx
apps/web/components/ui/avatar.tsx
apps/web/components/ui/badge.tsx
apps/web/components/ui/button.tsx
apps/web/components/ui/card.tsx
apps/web/components/ui/dialog.tsx
apps/web/components/ui/input.tsx
apps/web/components/ui/label.tsx
apps/web/components/ui/popover.tsx
apps/web/components/ui/select.tsx
apps/web/components/ui/separator.tsx
apps/web/components/ui/sheet.tsx
apps/web/components/ui/table.tsx
apps/web/components/ui/tabs.tsx
apps/web/components/ui/textarea.tsx
apps/web/components/VisualSubjectTree.tsx
apps/web/contexts/AuthContext.tsx
apps/web/contexts/NotificationContext.tsx
apps/web/Dockerfile
apps/web/eslint.config.mjs
apps/web/lib/apiClient.ts
apps/web/lib/axios.ts
apps/web/lib/utils.ts
apps/web/next-env.d.ts
apps/web/next.config.ts
apps/web/package.json
apps/web/postcss.config.mjs
apps/web/public/file.svg
apps/web/public/globe.svg
apps/web/public/next.svg
apps/web/public/vercel.svg
apps/web/public/window.svg
apps/web/scripts/test_api.js
apps/web/tsconfig.json
docker-compose.yml
TODO.md
YEUCAU.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="apps/api/Dockerfile">
# apps/api/Dockerfile
FROM python:3.9-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements and install
COPY src/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install gunicorn celery redis

# Copy the rest of the application
COPY src/ .

# Expose port
EXPOSE 5000

# Start script
CMD ["python", "app.py"]
</file>

<file path="apps/api/src/api/controllers/admin_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.system_auditlog_service import SystemAuditLogService
from api.schemas.system_auditlog_schema import SystemAuditLogSchema
from api.middleware import token_required, role_required

admin_bp = Blueprint('admin', __name__, url_prefix='/admin')
schema = SystemAuditLogSchema()

@admin_bp.route('/logs', methods=['GET', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin'])
@inject
def list_logs(service: SystemAuditLogService = Provide[Container.system_auditlog_service]):
    """Get system audit logs
    ---
    get:
      summary: Get system audit logs (Admin only)
      tags:
        - Admin
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
          description: Maximum number of logs to return
      responses:
        200:
          description: List of audit logs
    """
    # Handle OPTIONS preflight
    if request.method == 'OPTIONS':
        response = jsonify({'message': 'OK'})
        response.headers['Access-Control-Allow-Origin'] = request.headers.get('Origin', '*')
        response.headers['Access-Control-Allow-Methods'] = 'GET, OPTIONS'
        response.headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
        response.headers['Access-Control-Max-Age'] = '3600'
        return response, 200
    
    # Get query parameters
    limit = request.args.get('limit', default=50, type=int)
    
    # Fetch logs
    logs = service.list_logs(limit)
    return jsonify(schema.dump(logs, many=True)), 200
</file>

<file path="apps/api/src/api/controllers/search_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.search_service import SearchService
from services.ocr_service import OCRService
import os
import logging

logger = logging.getLogger(__name__)
search_bp = Blueprint('search', __name__, url_prefix='/search')

@search_bp.route('/syllabuses', methods=['GET'])
@inject
def search_syllabuses(search_service: SearchService = Provide[Container.search_service]):
    """
    Search syllabuses using full-text search.
    """
    query = request.args.get('q', '')
    if not query:
        return jsonify([])
    
    results = search_service.search_syllabuses(query)
    return jsonify(results), 200

@search_bp.route('/ocr', methods=['POST'])
@inject
def process_ocr(ocr_service: OCRService = Provide[Container.ocr_service]):
    """
    Process an uploaded file with OCR and return text.
    """
    if 'file' not in request.files:
        return jsonify({'message': 'No file part'}), 400
        
    file = request.files['file']
    if file.filename == '':
        return jsonify({'message': 'No selected file'}), 400
        
    # Temporary save
    temp_dir = "temp_ocr"
    os.makedirs(temp_dir, exist_ok=True)
    file_path = os.path.join(temp_dir, file.filename)
    file.save(file_path)
    
    try:
        text = ocr_service.process_file(file_path)
        # Clean up
        os.remove(file_path)
        return jsonify({'text': text}), 200
    except Exception as e:
        if os.path.exists(file_path):
            os.remove(file_path)
        return jsonify({'message': str(e)}), 500

@search_bp.route('/reindex', methods=['POST'])
@inject
def reindex_all(search_service: SearchService = Provide[Container.search_service],
                syllabus_service = Provide[Container.syllabus_service]):
    """
    Manually trigger reindexing of all syllabuses into Elasticsearch.
    """
    syllabuses = syllabus_service.list_syllabuses()
    count = 0
    for s in syllabuses:
        content = {
            "subject_code": s.subject.code if s.subject else "",
            "subject_name_vi": s.subject.name_vi if s.subject else "",
            "description": s.description or "",
            "version": s.version,
            "status": s.status
        }
        if search_service.index_syllabus(s.id, content):
            count += 1
            
    return jsonify({'message': f'Reindexed {count} syllabuses'}), 200
</file>

<file path="apps/api/src/api/schemas/system_auditlog_schema.py">
from marshmallow import fields, post_dump
from api.schemas.base_schema import BaseSchema

class SystemAuditLogSchema(BaseSchema):
    """Schema for system audit log serialization"""
    id = fields.Int(dump_only=True)
    user_id = fields.Int()
    action_type = fields.Str()
    resource_target = fields.Str(allow_none=True)
    ip_address = fields.Str(allow_none=True)
    user_agent = fields.Str(allow_none=True)
    details = fields.Str(allow_none=True)
    created_at = fields.DateTime(dump_only=True)
    
    # Nested user information
    user = fields.Nested('UserSchema', only=('id', 'username', 'full_name'), dump_only=True)
    
    @post_dump
    def transform_for_frontend(self, data, **kwargs):
        """Transform to match frontend expected format"""
        # Map createdAt (from BaseSchema camelCase) to timestamp
        if 'createdAt' in data:
            data['timestamp'] = data['createdAt']
        
        # Map actionType (from BaseSchema camelCase) to action
        if 'actionType' in data:
            data['action'] = data['actionType']
        
        # Extract username from nested user object
        if 'user' in data and data['user']:
            data['username'] = data['user'].get('username', 'Unknown')
        else:
            data['username'] = 'System'
        
        return data
</file>

<file path="apps/api/src/celery_utils.py">
from celery import Celery, Task
from flask import Flask

def celery_init_app(app: Flask) -> Celery:
    class FlaskTask(Task):
        def __call__(self, *args: object, **kwargs: object) -> object:
            with app.app_context():
                return self.run(*args, **kwargs)

    celery_app = Celery(app.name, task_cls=FlaskTask)
    celery_app.config_from_object(app.config["CELERY"])
    celery_app.set_default()
    app.extensions["celery"] = celery_app
    return celery_app
</file>

<file path="apps/api/src/infrastructure/models/syllabus_snapshot_model.py">
from sqlalchemy import Column, Integer, BigInteger, String, DateTime, ForeignKey, Text, JSON
from sqlalchemy.orm import relationship
from infrastructure.databases.mssql import Base
import datetime

class SyllabusSnapshot(Base):
    __tablename__ = 'syllabus_snapshots'

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    version = Column(String(50), nullable=False)
    snapshot_data = Column(JSON, nullable=False)  # Stores full syllabus details as JSON
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    created_by = Column(BigInteger, ForeignKey('users.id'), nullable=True)

    syllabus = relationship("Syllabus")
    creator = relationship("User")

    def __repr__(self):
        return f"<SyllabusSnapshot(syllabus_id={self.syllabus_id}, version='{self.version}')>"
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_current_workflow_repository.py">
from typing import Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_current_workflow import SyllabusCurrentWorkflow

class SyllabusCurrentWorkflowRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_syllabus_id(self, syllabus_id: int) -> Optional[SyllabusCurrentWorkflow]:
        return self.session.query(SyllabusCurrentWorkflow).filter_by(syllabus_id=syllabus_id).first()

    def update_or_create(self, syllabus_id: int, data: dict) -> SyllabusCurrentWorkflow:
        cw = self.get_by_syllabus_id(syllabus_id)
        if cw:
            for key, value in data.items():
                if hasattr(cw, key):
                    setattr(cw, key, value)
        else:
            cw = SyllabusCurrentWorkflow(syllabus_id=syllabus_id, **data)
            self.session.add(cw)
        
        self.session.commit()
        self.session.refresh(cw)
        return cw

    def delete(self, syllabus_id: int) -> bool:
        cw = self.get_by_syllabus_id(syllabus_id)
        if not cw:
            return False
        self.session.delete(cw)
        self.session.commit()
        return True

    def get_overdue(self):
        from datetime import datetime
        return self.session.query(SyllabusCurrentWorkflow).filter(
            SyllabusCurrentWorkflow.due_date < datetime.now()
        ).all()
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_snapshot_repository.py">
from infrastructure.models.syllabus_snapshot_model import SyllabusSnapshot
from sqlalchemy.orm import Session

class SyllabusSnapshotRepository:
    def __init__(self, session: Session):
        self.session = session

    def create(self, data: dict) -> SyllabusSnapshot:
        snapshot = SyllabusSnapshot(**data)
        self.session.add(snapshot)
        self.session.commit()
        return snapshot

    def get_by_syllabus(self, syllabus_id: int):
        return self.session.query(SyllabusSnapshot).filter_by(syllabus_id=syllabus_id).order_by(SyllabusSnapshot.created_at.desc()).all()

    def get_by_id(self, id: int):
        return self.session.query(SyllabusSnapshot).get(id)
</file>

<file path="apps/api/src/infrastructure/repositories/system_auditlog_repository.py">
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.system_auditlog_model import SystemAuditLog

class SystemAuditLogRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, user_id: int, action_type: str, resource_target: str = None, 
               ip_address: str = None, user_agent: str = None, details: str = None):
        """Create a new system audit log entry"""
        log = SystemAuditLog(
            user_id=user_id,
            action_type=action_type,
            resource_target=resource_target,
            ip_address=ip_address,
            user_agent=user_agent,
            details=details
        )
        self.session.add(log)
        self.session.commit()
        return log

    def list_logs(self, limit: int = 100):
        """Get recent audit logs with user information"""
        return self.session.query(SystemAuditLog)\
            .order_by(SystemAuditLog.created_at.desc())\
            .limit(limit)\
            .all()

    def get_by_user(self, user_id: int, limit: int = 50):
        """Get audit logs for a specific user"""
        return self.session.query(SystemAuditLog)\
            .filter(SystemAuditLog.user_id == user_id)\
            .order_by(SystemAuditLog.created_at.desc())\
            .limit(limit)\
            .all()
</file>

<file path="apps/api/src/make_celery.py">
from create_app import create_app

flask_app = create_app()
celery_app = flask_app.extensions["celery"]
</file>

<file path="apps/api/src/scripts/add_syllabus_content_columns.py">
"""
Migration script: Add content columns to syllabuses table
Adds: description, objectives, student_duties, other_requirements, 
      pre_courses, co_courses, course_type, component_type,
      date_prepared, date_edited, dean, head_department
"""

import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy import text, create_engine
from sqlalchemy.orm import sessionmaker
from config import Config

def add_columns():
    # Create engine and session
    engine = create_engine(Config.DATABASE_URI, echo=False)
    Session = sessionmaker(bind=engine)
    session = Session()
    
    try:
        print("üîÑ Adding content columns to syllabuses table...")
        
        # Check if columns already exist
        check_query = text("""
            SELECT COLUMN_NAME 
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_NAME = 'syllabuses' 
            AND COLUMN_NAME IN ('description', 'objectives', 'student_duties')
        """)
        
        existing = session.execute(check_query).fetchall()
        if existing:
            print(f"‚ö†Ô∏è  Some columns already exist: {[row[0] for row in existing]}")
            print("Skipping migration...")
            return
        
        # Add new columns
        alter_queries = [
            "ALTER TABLE syllabuses ADD description NVARCHAR(MAX) NULL",
            "ALTER TABLE syllabuses ADD objectives NVARCHAR(MAX) NULL",
            "ALTER TABLE syllabuses ADD student_duties NVARCHAR(MAX) NULL",
            "ALTER TABLE syllabuses ADD other_requirements NVARCHAR(MAX) NULL",
            "ALTER TABLE syllabuses ADD pre_courses NVARCHAR(MAX) NULL",
            "ALTER TABLE syllabuses ADD co_courses NVARCHAR(MAX) NULL",
            "ALTER TABLE syllabuses ADD course_type NVARCHAR(50) NULL",
            "ALTER TABLE syllabuses ADD component_type NVARCHAR(100) NULL",
            "ALTER TABLE syllabuses ADD date_prepared NVARCHAR(20) NULL",
            "ALTER TABLE syllabuses ADD date_edited NVARCHAR(20) NULL",
            "ALTER TABLE syllabuses ADD dean NVARCHAR(255) NULL",
            "ALTER TABLE syllabuses ADD head_department NVARCHAR(255) NULL",
        ]
        
        for query in alter_queries:
            print(f"   Executing: {query}")
            session.execute(text(query))
        
        session.commit()
        print("‚úÖ Successfully added all columns!")
        
        # Verify
        verify_query = text("""
            SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_NAME = 'syllabuses' 
            AND COLUMN_NAME IN ('description', 'objectives', 'student_duties', 
                                'other_requirements', 'pre_courses', 'co_courses',
                                'course_type', 'component_type', 'date_prepared',
                                'date_edited', 'dean', 'head_department')
            ORDER BY COLUMN_NAME
        """)
        
        results = session.execute(verify_query).fetchall()
        print("\nüìã Verified columns:")
        for row in results:
            print(f"   - {row[0]}: {row[1]} (nullable={row[2]})")
        
    except Exception as e:
        session.rollback()
        print(f"‚ùå Error: {e}")
        raise
    finally:
        session.close()

if __name__ == '__main__':
    add_columns()
</file>

<file path="apps/api/src/scripts/add_syllabus_id_columns.py">
"""
Migration script: Add dean_id and head_department_id to syllabuses table
"""

import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy import text, create_engine
from sqlalchemy.orm import sessionmaker
from config import Config

def add_columns():
    # Create engine and session
    engine = create_engine(Config.DATABASE_URI, echo=False)
    Session = sessionmaker(bind=engine)
    session = Session()
    
    try:
        print("üîÑ Adding ID columns to syllabuses table...")
        
        # Check if columns already exist
        check_query = text("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name = 'syllabuses'
        """)
        
        result = session.execute(check_query)
        existing_columns = [row[0] for row in result]
        
        columns_to_add = [
            ("dean_id", "BIGINT REFERENCES users(id)"),
            ("head_department_id", "BIGINT REFERENCES users(id)")
        ]
        
        for col_name, col_type in columns_to_add:
            if col_name not in existing_columns:
                print(f"‚ûï Adding column: {col_name}")
                # SQL Server syntax: ALTER TABLE table ADD col_name type
                session.execute(text(f"ALTER TABLE syllabuses ADD {col_name} {col_type}"))
            else:
                print(f"‚úÖ Column {col_name} already exists")
        
        session.commit()
        print("üéâ Migration completed successfully!")
        
    except Exception as e:
        session.rollback()
        print(f"‚ùå Error during migration: {e}")
    finally:
        session.close()

if __name__ == "__main__":
    add_columns()
</file>

<file path="apps/api/src/scripts/check_deadlines.py">
import sys
import os

# Add src to python path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from create_app import create_app
from dependency_container import Container

def run_deadline_check():
    """Script to be run by CRON daily to check for overdue syllabuses"""
    print("Starting Syllabus Deadline Check...")
    
    # Initialize the app and container
    app = create_app()
    with app.app_context():
        container = Container()
        # We need to get the syllabus_service
        syllabus_service = container.syllabus_service()
        
        count = syllabus_service.check_workflow_deadlines()
        print(f"Finished. Sent {count} overdue notifications.")

if __name__ == "__main__":
    run_deadline_check()
</file>

<file path="apps/api/src/scripts/list_models.py">
import os
import google.generativeai as genai
from dotenv import load_dotenv

load_dotenv('.env')
api_key = os.getenv('GEMINI_API_KEY')
print(f"API Key found: {api_key[:5]}...{api_key[-5:] if api_key else 'None'}")
genai.configure(api_key=api_key)

print("Listing models...")
try:
    for m in genai.list_models():
        if 'generateContent' in m.supported_generation_methods:
            print(m.name)
except Exception as e:
    print(f"Error: {e}")
</file>

<file path="apps/api/src/scripts/reset_and_seed.py">
"""
Script to reset database and seed comprehensive test data
Usage: python reset_and_seed.py
"""

import sys
import os
from datetime import datetime, timedelta
import json

# Add parent directory to path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from infrastructure.databases.mssql import engine, SessionLocal
from infrastructure.models.user_model import User
from infrastructure.models.role_model import Role
from infrastructure.models.user_role_model import UserRole
from infrastructure.models.department_model import Department
from infrastructure.models.subject_model import Subject
from infrastructure.models.subject_relationship_model import SubjectRelationship
from infrastructure.models.program_model import Program
from infrastructure.models.academic_year_model import AcademicYear
from infrastructure.models.syllabus_model import Syllabus
from infrastructure.models.syllabus_clo_model import SyllabusClo
from infrastructure.models.syllabus_material_model import SyllabusMaterial
from infrastructure.models.teaching_plan_model import TeachingPlan
from infrastructure.models.assessment_scheme_model import AssessmentScheme
from infrastructure.models.assessment_component_model import AssessmentComponent
from infrastructure.models.rubric_model import Rubric
from infrastructure.models.notification_model import Notification
from infrastructure.models.syllabus_snapshot_model import SyllabusSnapshot
from infrastructure.models.system_setting_model import SystemSetting
from infrastructure.models.workflow_log_model import WorkflowLog
from infrastructure.databases.base import Base
from werkzeug.security import generate_password_hash

def reset_database(session):
    """Drop and recreate all tables"""
    print("üóëÔ∏è  Resetting database...")
    
    # Drop all tables
    Base.metadata.drop_all(bind=engine)
    print("   ‚úì Dropped all tables")
    
    # Recreate all tables
    Base.metadata.create_all(bind=engine)
    print("   ‚úì Created all tables")

def seed_roles(session):
    """Create roles"""
    print("\nüë• Seeding roles...")
    
    roles_data = [
        {"name": "Admin", "description": "System Administrator"},
        {"name": "Lecturer", "description": "University Lecturer"},
        {"name": "Student", "description": "University Student"},
        {"name": "Head of Dept", "description": "Head of Department"},
        {"name": "Academic Affairs", "description": "Academic Affairs Office"},
        {"name": "Principal", "description": "University Principal / Final Approver"},
    ]
    
    roles = []
    for r in roles_data:
        role = Role(**r)
        session.add(role)
        roles.append(role)
    
    session.commit()
    print(f"   ‚úì Created {len(roles)} roles")
    return {r.name: r for r in roles}

def seed_users(session, roles_dict):
    """Create users with various roles

    Returns:
        users_by_username: dict username -> User
        users_by_role: dict role_name -> list[User]
    """
    print("\nüë§ Seeding users...")
    
    users_data = [
        # Admin
        {"username": "admin", "email": "admin@university.edu", "full_name": "System Admin", "role": "Admin"},
        
        # Principal
        {"username": "principal1", "email": "principal@university.edu", "full_name": "GS.TS. Hi·ªáu Tr∆∞·ªüng", "role": "Principal"},
        
        # Lecturers
        {"username": "lecturer1", "email": "nguyen.van.a@university.edu", "full_name": "Nguy·ªÖn VƒÉn A", "role": "Lecturer"},
        {"username": "lecturer2", "email": "tran.thi.b@university.edu", "full_name": "Tr·∫ßn Th·ªã B", "role": "Lecturer"},
        {"username": "lecturer3", "email": "le.van.c@university.edu", "full_name": "L√™ VƒÉn C", "role": "Lecturer"},
        {"username": "lecturer4", "email": "pham.thi.d@university.edu", "full_name": "Ph·∫°m Th·ªã D", "role": "Lecturer"},
        {"username": "lecturer5", "email": "hoang.van.e@university.edu", "full_name": "Ho√†ng VƒÉn E", "role": "Lecturer"},
        
        # Head of Department
        {"username": "hod1", "email": "hod.cs@university.edu", "full_name": "V√µ VƒÉn Tr∆∞·ªüng", "role": "Head of Dept"},
        {"username": "hod2", "email": "hod.se@university.edu", "full_name": "ƒê·ªó Th·ªã Ph√≥", "role": "Head of Dept"},
        
        # Academic Affairs
        {"username": "aa1", "email": "aa1@university.edu", "full_name": "B√πi VƒÉn H·ªçc V·ª•", "role": "Academic Affairs"},
        {"username": "aa2", "email": "aa2@university.edu", "full_name": "ƒêinh Th·ªã ƒê√†o T·∫°o", "role": "Academic Affairs"},
        
        # Students
        {"username": "student1", "email": "sv001@student.edu", "full_name": "Nguy·ªÖn Minh Tu·∫•n", "role": "Student"},
        {"username": "student2", "email": "sv002@student.edu", "full_name": "L√™ Th·ªã Hoa", "role": "Student"},
        {"username": "student3", "email": "sv003@student.edu", "full_name": "Tr·∫ßn VƒÉn Nam", "role": "Student"},
    ]
    
    users = []
    users_by_username = {}
    users_by_role = {}

    for u in users_data:
        role_name = u.pop("role")
        user = User(
            **u,
            password_hash=generate_password_hash("123456"),
            is_active=True
        )
        session.add(user)
        session.flush()
        
        # Assign role
        user_role = UserRole(user_id=user.id, role_id=roles_dict[role_name].id)
        session.add(user_role)
        users.append((user, role_name))

        users_by_username[user.username] = user
        users_by_role.setdefault(role_name, []).append(user)
    
    session.commit()
    print(f"   ‚úì Created {len(users)} users (password: 123456)")
    return users_by_username, users_by_role

from infrastructure.models.faculty_model import Faculty

def seed_faculties(session):
    """Create faculties"""
    print("\nüèõÔ∏è Seeding faculties...")
    faculties_data = [
        {"code": "ENG", "name": "Faculty of Engineering", "description": "Engineering and Technology"},
        {"code": "SCI", "name": "Faculty of Science", "description": "Natural Sciences"},
        {"code": "BUS", "name": "Faculty of Business", "description": "Business Administration"},
    ]
    faculties = []
    for f in faculties_data:
        fac = Faculty(**f)
        session.add(fac)
        faculties.append(fac)
    session.commit()
    print(f"   ‚úì Created {len(faculties)} faculties")
    return faculties


def seed_departments(session, faculties):
    """Create departments"""
    print("\nüè¢ Seeding departments...")
    
    departments_data = [
        {"code": "CS", "name": "Khoa Khoa h·ªçc M√°y t√≠nh", "faculty_idx": 0},
        {"code": "SE", "name": "Khoa C√¥ng ngh·ªá Ph·∫ßn m·ªÅm", "faculty_idx": 0},
        {"code": "IS", "name": "Khoa H·ªá th·ªëng Th√¥ng tin", "faculty_idx": 0},
        {"code": "IT", "name": "Khoa C√¥ng ngh·ªá Th√¥ng tin", "faculty_idx": 0},
    ]
    
    departments = []
    for d in departments_data:
        faculty_idx = d.pop("faculty_idx")
        # In current DB schema Faculty model may not be implemented; set faculty_id to NULL if none
        faculty_id = faculties[faculty_idx].id if faculties and len(faculties) > faculty_idx else None
        dept = Department(
            faculty_id=faculty_id if faculty_id else None,
            **d
        )
        session.add(dept)
        departments.append(dept)
    
    session.commit()
    print(f"   ‚úì Created {len(departments)} departments")
    return departments

def seed_subjects(session, departments):
    """Create subjects"""
    print("\nüìö Seeding subjects...")
    
    subjects_data = [
        # Computer Science
        {"code": "CS101", "name_vi": "Nh·∫≠p m√¥n L·∫≠p tr√¨nh", "name_en": "Introduction to Programming", "credits": 3, "dept_idx": 0},
        {"code": "CS102", "name_vi": "C·∫•u tr√∫c D·ªØ li·ªáu v√† Gi·∫£i thu·∫≠t", "name_en": "Data Structures and Algorithms", "credits": 4, "dept_idx": 0},
        {"code": "CS201", "name_vi": "C∆° s·ªü D·ªØ li·ªáu", "name_en": "Database Systems", "credits": 3, "dept_idx": 0},
        {"code": "CS202", "name_vi": "H·ªá ƒëi·ªÅu h√†nh", "name_en": "Operating Systems", "credits": 3, "dept_idx": 0},
        {"code": "CS301", "name_vi": "Tr√≠ tu·ªá Nh√¢n t·∫°o", "name_en": "Artificial Intelligence", "credits": 4, "dept_idx": 0},
        {"code": "CS302", "name_vi": "H·ªçc M√°y", "name_en": "Machine Learning", "credits": 4, "dept_idx": 0},
        
        # Software Engineering
        {"code": "SE101", "name_vi": "Nh·∫≠p m√¥n C√¥ng ngh·ªá Ph·∫ßn m·ªÅm", "name_en": "Introduction to Software Engineering", "credits": 3, "dept_idx": 1},
        {"code": "SE201", "name_vi": "Ph√¢n t√≠ch v√† Thi·∫øt k·∫ø H·ªá th·ªëng", "name_en": "System Analysis and Design", "credits": 4, "dept_idx": 1},
        {"code": "SE202", "name_vi": "Ki·ªÉm th·ª≠ Ph·∫ßn m·ªÅm", "name_en": "Software Testing", "credits": 3, "dept_idx": 1},
        {"code": "SE301", "name_vi": "Qu·∫£n l√Ω D·ª± √°n Ph·∫ßn m·ªÅm", "name_en": "Software Project Management", "credits": 3, "dept_idx": 1},
        
        # Web & Mobile
        {"code": "WEB201", "name_vi": "L·∫≠p tr√¨nh Web", "name_en": "Web Programming", "credits": 4, "dept_idx": 1},
        {"code": "WEB301", "name_vi": "Ph√°t tri·ªÉn ·ª®ng d·ª•ng Di ƒë·ªông", "name_en": "Mobile Application Development", "credits": 4, "dept_idx": 1},
        
        # Information Systems
        {"code": "IS201", "name_vi": "H·ªá th·ªëng Th√¥ng tin Qu·∫£n l√Ω", "name_en": "Management Information Systems", "credits": 3, "dept_idx": 2},
        {"code": "IS301", "name_vi": "Ph√¢n t√≠ch D·ªØ li·ªáu", "name_en": "Data Analytics", "credits": 4, "dept_idx": 2},
        
        # IT Infrastructure
        {"code": "IT201", "name_vi": "M·∫°ng M√°y t√≠nh", "name_en": "Computer Networks", "credits": 3, "dept_idx": 3},
        {"code": "IT301", "name_vi": "An to√†n v√† B·∫£o m·∫≠t", "name_en": "Security and Network Security", "credits": 4, "dept_idx": 3},
    ]
    
    subjects = []
    for s in subjects_data:
        dept_idx = s.pop("dept_idx")
        subject = Subject(
            department_id=departments[dept_idx].id,
            credit_theory=s["credits"] * 0.6,
            credit_practice=s["credits"] * 0.4,
            **s
        )
        session.add(subject)
        subjects.append(subject)
    
    session.commit()
    print(f"   ‚úì Created {len(subjects)} subjects")
    return subjects

def seed_programs(session, departments):
    """Create programs"""
    print("\nüéì Seeding programs...")
    
    programs_data = [
        {"name": "Computer Science 2020", "dept_idx": 0},
        {"name": "Software Engineering 2021", "dept_idx": 1},
        {"name": "Information Systems 2021", "dept_idx": 2},
        {"name": "Information Technology 2022", "dept_idx": 3},
    ]
    
    programs = []
    for p in programs_data:
        dept_idx = p.pop("dept_idx")
        program = Program(
            department_id=departments[dept_idx].id,
            total_credits=120,
            name=p.get("name")
        )
        session.add(program)
        programs.append(program)
    
    session.commit()
    print(f"   ‚úì Created {len(programs)} programs")
    return programs

def seed_academic_years(session):
    """Create academic years"""
    print("\nüìÖ Seeding academic years...")
    
    current_year = datetime.now().year
    years_data = [
        {"code": f"{current_year-2}-{current_year-1}", "is_active": False},
        {"code": f"{current_year-1}-{current_year}", "is_active": False},
        {"code": f"{current_year}-{current_year+1}", "is_active": True},
        {"code": f"{current_year+1}-{current_year+2}", "is_active": False},
    ]
    
    years = []
    for y in years_data:
        year = AcademicYear(**y)
        session.add(year)
        years.append(year)
    
    session.commit()
    print(f"   ‚úì Created {len(years)} academic years")
    return years
def seed_subject_relationships(session, subjects):
    """Create relationship between subjects"""
    print("\nüîó Seeding subject relationships...")
    
    # Example: MATH101 is prerequisite for IT101
    math101 = next((s for s in subjects if s.code == 'MATH101'), None)
    it101 = next((s for s in subjects if s.code == 'IT101'), None)
    
    # IT101 is prerequisite for IT102
    it102 = next((s for s in subjects if s.code == 'IT102'), None)
    
    # ENG101 is parallel for IT101
    eng101 = next((s for s in subjects if s.code == 'ENG101'), None)
    
    rels = []
    if math101 and it101:
        rels.append(SubjectRelationship(subject_id=it101.id, related_subject_id=math101.id, type='PREREQUISITE'))
    if it101 and it102:
        rels.append(SubjectRelationship(subject_id=it102.id, related_subject_id=it101.id, type='PREREQUISITE'))
    if eng101 and it101:
        rels.append(SubjectRelationship(subject_id=it101.id, related_subject_id=eng101.id, type='PARALLEL'))
        
    for r in rels:
        session.add(r)
    
    session.commit()
    print(f"   ‚úì Seeded {len(rels)} subject relationships")
    return rels
def seed_syllabuses(session, subjects, programs, years, users_by_username, users_by_role):
    """Create syllabuses with full children"""
    print("\nüìù Seeding syllabuses...")
    
    lecturers = users_by_role.get("Lecturer", [])
    # Fallback to any user if no lecturers exist
    if not lecturers:
        print("   ‚ö†Ô∏è No lecturers found in seed data, falling back to first available user.")
        all_users = list(users_by_username.values())
        if not all_users:
            raise RuntimeError("No users available to assign as lecturers.")
        lecturers = [all_users[0]]

    statuses = ["Draft", "Draft", "Pending", "Approved", "Approved", "Returned"]  # More approved for testing
    
    syllabuses_created = 0
    clos_created = 0
    materials_created = 0
    plans_created = 0
    assessment_schemes_created = 0
    components_created = 0
    snapshots_created = 0
    
    # Create syllabuses for each subject (some have multiple versions)
    for idx, subject in enumerate(subjects[:12]):  # First 12 subjects
        # Determine how many versions for this subject
        num_versions = 1 if idx < 6 else 2  # Some subjects have 2 versions
        
        for version_idx in range(num_versions):
            version = f"1.{version_idx}"
            status = statuses[syllabuses_created % len(statuses)]
            lecturer_user = lecturers[syllabuses_created % len(lecturers)]
            program = programs[syllabuses_created % len(programs)]
            year = years[1 if version_idx == 0 else 2]  # Old version vs new version
            
            # Create syllabus
            syllabus = Syllabus(
                subject_id=subject.id,
                program_id=program.id,
                academic_year_id=year.id,
                lecturer_id=lecturer_user.id,
                status=status,
                version=version,
                time_allocation=json.dumps({"theory": 30, "exercises": 10, "practice": 20, "selfStudy": 15}),
                prerequisites=f"ƒêi·ªÅu ki·ªán: Ho√†n th√†nh {subject.credits} t√≠n ch·ªâ" if idx > 3 else "Kh√¥ng c√≥ ƒëi·ªÅu ki·ªán ti√™n quy·∫øt",
                description=f"H·ªçc ph·∫ßn {subject.name_vi} cung c·∫•p ki·∫øn th·ª©c n·ªÅn t·∫£ng v·ªÅ {subject.name_en.lower()}. "
                           f"Sinh vi√™n s·∫Ω ƒë∆∞·ª£c trang b·ªã k·ªπ nƒÉng th·ª±c h√†nh qua c√°c b√†i t·∫≠p v√† d·ª± √°n th·ª±c t·∫ø. "
                           f"M√¥n h·ªçc g·ªìm {subject.credits} t√≠n ch·ªâ v·ªõi ph∆∞∆°ng ph√°p gi·∫£ng d·∫°y k·∫øt h·ª£p l√Ω thuy·∫øt v√† th·ª±c h√†nh.",
                objectives=json.dumps([
                    f"Hi·ªÉu r√µ c√°c kh√°i ni·ªám c∆° b·∫£n v·ªÅ {subject.name_vi}",
                    f"√Åp d·ª•ng ki·∫øn th·ª©c v√†o gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ th·ª±c t·∫ø",
                    f"Ph√°t tri·ªÉn k·ªπ nƒÉng l√†m vi·ªác nh√≥m v√† thuy·∫øt tr√¨nh",
                ]),
                student_duties="Tham gia ƒë·∫ßy ƒë·ªß c√°c bu·ªïi h·ªçc, ho√†n th√†nh b√†i t·∫≠p v√† d·ª± √°n ƒë√∫ng h·∫°n, ch·ªß ƒë·ªông t√¨m ki·∫øm t√†i li·ªáu h·ªçc t·∫≠p.",
                other_requirements="Sinh vi√™n c·∫ßn c√≥ laptop c√° nh√¢n v√† c√†i ƒë·∫∑t c√°c c√¥ng c·ª• l·∫≠p tr√¨nh c·∫ßn thi·∫øt.",
                pre_courses=subjects[max(0, idx-2)].code if idx > 1 else "",
                co_courses=subjects[min(len(subjects)-1, idx+1)].code if idx < len(subjects)-1 else "",
                course_type="B·∫Øt bu·ªôc" if idx < 8 else "T·ª± ch·ªçn",
                component_type="C∆° s·ªü ng√†nh" if idx < 5 else "Chuy√™n ng√†nh",
                date_prepared=(datetime.now() - timedelta(days=90)).strftime("%Y-%m-%d"),
                date_edited=datetime.now().strftime("%Y-%m-%d"),
                dean="PGS.TS. Nguy·ªÖn VƒÉn Tr∆∞·ªüng",
                head_department="TS. Tr·∫ßn Th·ªã Ph√≥",
                is_active=True,
                created_at=datetime.now() - timedelta(days=60),
                updated_at=datetime.now()
            )
            session.add(syllabus)
            session.flush()
            syllabuses_created += 1
            
            # Add CLOs (3-5 CLOs per syllabus)
            num_clos = 3 + (syllabuses_created % 3)
            current_clos = []
            for i in range(num_clos):
                clo = SyllabusClo(
                    syllabus_id=syllabus.id,
                    code=f"CLO{i+1}",
                    description=f"Sinh vi√™n c√≥ kh·∫£ nƒÉng {['ph√¢n t√≠ch', 'thi·∫øt k·∫ø', 'tri·ªÉn khai', 'ƒë√°nh gi√°', 't·ªïng h·ª£p'][i % 5]} "
                               f"c√°c v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn {subject.name_vi.lower()}."
                )
                session.add(clo)
                current_clos.append(clo)
                clos_created += 1
            session.flush()

            # Add Assessment Schemes
            scheme = AssessmentScheme(
                syllabus_id=syllabus.id,
                name="Ma tr·∫≠n ƒë√°nh gi√° chu·∫©n",
                weight=100.0
            )
            session.add(scheme)
            session.flush()
            assessment_schemes_created += 1

            # Assessment Components (Total weight must be 100)
            components_data = [
                {"name": "ƒêi·ªÉm chuy√™n c·∫ßn", "weight": 10},
                {"name": "B√†i t·∫≠p l·ªõn / D·ª± √°n", "weight": 30},
                {"name": "Thi gi·ªØa k·ª≥", "weight": 20},
                {"name": "Thi cu·ªëi k·ª≥", "weight": 40}
            ]
            for comp_data in components_data:
                comp = AssessmentComponent(
                    scheme_id=scheme.id,
                    name=comp_data["name"],
                    weight=comp_data["weight"]
                )
                session.add(comp)
                components_created += 1
            
            # Add Materials (4-6 materials per syllabus)
            materials = [
                {"type": "Main", "title": f"{subject.name_en} - Textbook Edition {version_idx + 3}, Publisher XYZ"},
                {"type": "Main", "title": f"Lecture Slides - {subject.code} by {lecturer_user.username.upper()}"},
                {"type": "Ref", "title": f"Advanced {subject.name_en} - Reference Guide"},
                {"type": "Ref", "title": f"Online Resources: Coursera, edX, Udemy courses on {subject.name_en}"},
                {"type": "Ref", "title": f"IEEE/ACM Papers on {subject.name_en.split()[0]} Research"},
            ]
            for mat in materials[:4 + (syllabuses_created % 3)]:
                material = SyllabusMaterial(
                    syllabus_id=syllabus.id,
                    type=mat["type"],
                    title=mat["title"]
                )
                session.add(material)
                materials_created += 1
            
            # Add Teaching Plans (12-15 weeks)
            num_weeks = 13 + (syllabuses_created % 3)
            for week in range(1, num_weeks + 1):
                clo_ref = f"CLO{((week-1) % num_clos) + 1}"
                plan = TeachingPlan(
                    syllabus_id=syllabus.id,
                    week=week,
                    topic=f"Tu·∫ßn {week}: {['Gi·ªõi thi·ªáu', 'C∆° b·∫£n', 'N√¢ng cao', 'Th·ª±c h√†nh', '√în t·∫≠p'][(week-1) % 5]} - "
                          f"{'Ch∆∞∆°ng ' + str((week-1)//3 + 1) if week <= 12 else 'Thi cu·ªëi k·ª≥'} ({clo_ref})",
                    activity=f"Gi·∫£ng l√Ω thuy·∫øt {2 if week <= 10 else 0} ti·∫øt, Th·ª±c h√†nh {2 if week <= 10 else 0} ti·∫øt, "
                            f"{'Thi gi·ªØa k·ª≥' if week == 7 else 'Thi cu·ªëi k·ª≥' if week == num_weeks else 'B√†i t·∫≠p nh√≥m'}",
                    assessment="ƒêi·ªÉm chuy√™n c·∫ßn, B√†i t·∫≠p" if week < num_weeks else "Thi cu·ªëi k·ª≥"
                )
                session.add(plan)
                plans_created += 1

            # Seed Workflow Logs and Snapshots for non-DRAFT
            if status != "Draft":
                # Create a SUBMIT log
                session.add(WorkflowLog(
                    syllabus_id=syllabus.id,
                    actor_id=lecturer_user.id,
                    action="SUBMIT",
                    from_status="Draft",
                    to_status="Pending",
                    comment="ƒê√£ ho√†n thi·ªán n·ªôi dung v√† g·ª≠i duy·ªát."
                ))
            
            if status in ["Approved", "Published"]:
                # Create Snapshot for approved versions
                snapshot = SyllabusSnapshot(
                    syllabus_id=syllabus.id,
                    version=version,
                    snapshot_data={"info": "Seeded snapshot for testing immutable history"},
                    created_by=users_by_role["Admin"][0].id if users_by_role.get("Admin") else lecturer_user.id
                )
                session.add(snapshot)
                snapshots_created += 1

    session.commit()
    print(f"   ‚úì Created {syllabuses_created} syllabuses")
    print(f"   ‚úì Created {clos_created} CLOs")
    print(f"   ‚úì Created {materials_created} materials")
    print(f"   ‚úì Created {plans_created} teaching plans")
    print(f"   ‚úì Created {assessment_schemes_created} assessment schemes")
    print(f"   ‚úì Created {snapshots_created} snapshots")

def seed_system_settings(session):
    """Seed initial system settings"""
    print("\n‚öôÔ∏è Seeding system settings...")
    settings = [
        {"key": "UNIVERSITY_NAME", "value": "ƒê·∫°i h·ªçc C√¥ng ngh·ªá Qu·ªëc gia", "description": "T√™n tr∆∞·ªùng hi·ªÉn th·ªã tr√™n ƒë·ªÅ c∆∞∆°ng"},
        {"key": "ACADEMIC_YEAR_CURRENT", "value": "2025-2026", "description": "NƒÉm h·ªçc hi·ªán t·∫°i m·∫∑c ƒë·ªãnh"},
        {"key": "APPROVAL_LEVELS", "value": "3", "description": "S·ªë c·∫•p ph√™ duy·ªát b·∫Øt bu·ªôc"},
        {"key": "AI_FEATURES_ENABLED", "value": "true", "description": "B·∫≠t/T·∫Øt c√°c t√≠nh nƒÉng AI h·ªó tr·ª£"},
    ]
    for s in settings:
        session.add(SystemSetting(**s))
    session.commit()
    print(f"   ‚úì Created {len(settings)} system settings")

def main():
    """Main execution"""
    print("="*60)
    print("üöÄ SYLLABUS MANAGEMENT SYSTEM - DATA RESET & SEED")
    print("="*60)
    
    session = SessionLocal()
    
    try:
        # Reset database
        reset_database(session)
        
        # Seed data
        roles_dict = seed_roles(session)
        users_by_username, users_by_role = seed_users(session, roles_dict)
        faculties = seed_faculties(session)
        departments = seed_departments(session, faculties)
        subjects = seed_subjects(session, departments)
        seed_subject_relationships(session, subjects)
        programs = seed_programs(session, departments)
        years = seed_academic_years(session)
        seed_system_settings(session)
        seed_syllabuses(session, subjects, programs, years, users_by_username, users_by_role)
        
        print("\n" + "="*60)
        print("‚úÖ DATABASE RESET AND SEED COMPLETED SUCCESSFULLY!")
        print("="*60)
        print("\nüìä Summary:")
        print(f"   ‚Ä¢ Roles: {len(roles_dict)}")
        print(f"   ‚Ä¢ Users: {len(users_by_username)} (Admin: 1, Principal: 1, Lecturers: 5, HOD: 2, AA: 2, Students: 3)")
        print(f"   ‚Ä¢ Departments: {len(departments)}")
        print(f"   ‚Ä¢ Subjects: {len(subjects)}")
        print(f"   ‚Ä¢ Programs: {len(programs)}")
        print(f"   ‚Ä¢ Academic Years: {len(years)}")
        print(f"   ‚Ä¢ Syllabuses: {session.query(Syllabus).count()}")
        print(f"   ‚Ä¢ CLOs, Materials, Teaching Plans: ~500+")
        print("\nüîë Login credentials:")
        print("   ‚Ä¢ Admin: admin / 123456")
        print("   ‚Ä¢ Principal: principal1 / 123456")
        print("   ‚Ä¢ Lecturer: lecturer1 / 123456")
        print("   ‚Ä¢ HOD: hod1 / 123456")
        print("   ‚Ä¢ Academic Affairs: aa1 / 123456")
        print("   ‚Ä¢ Student: student1 / 123456")
        print("\n" + "="*60)
        
    except Exception as e:
        print(f"\n‚ùå Error: {str(e)}")
        session.rollback()
        raise
    finally:
        session.close()

if __name__ == "__main__":
    main()
</file>

<file path="apps/api/src/services/analysis_service.py">
from typing import List, Dict
from infrastructure.repositories.syllabus_repository import SyllabusRepository
from infrastructure.repositories.subject_relationship_repository import SubjectRelationshipRepository
from domain.constants import WorkflowStatus

class AnalysisService:
    def __init__(self, syllabus_repository: SyllabusRepository, 
                 rel_repository: SubjectRelationshipRepository):
        self.syllabus_repo = syllabus_repository
        self.rel_repo = rel_repository

    def get_impact_analysis(self, syllabus_id: int) -> Dict:
        """
        Analyze what other syllabuses are impacted if this syllabus changes.
        Principal/Strategic view.
        """
        syllabus = self.syllabus_repo.get_by_id(syllabus_id)
        if not syllabus:
            return None
            
        subject_id = syllabus.subject_id
        
        # 1. Find direct successors (Subjects that have THIS subject as a prerequisite)
        successors = self.rel_repo.get_successors(subject_id)
        
        impacted_subjects = []
        for rel in successors:
            # For each successor subject, find its active/published syllabus
            active_syllabus = self.syllabus_repo.get_active_by_subject(rel.subject_id)
            impacted_subjects.append({
                "subject_id": rel.subject_id,
                "subject_code": rel.subject.code if rel.subject else "N/A",
                "subject_name": rel.subject.name_vi if rel.subject else "N/A",
                "type": rel.type,
                "syllabus_status": active_syllabus.status if active_syllabus else "No Active Syllabus",
                "syllabus_id": active_syllabus.id if active_syllabus else None
            })
            
        return {
            "root_syllabus": {
                "id": syllabus.id,
                "subject_name": syllabus.subject.name_vi if syllabus.subject else "N/A",
                "version": syllabus.version
            },
            "impacted_count": len(impacted_subjects),
            "impact_level": "High" if len(impacted_subjects) > 3 else "Medium" if len(impacted_subjects) > 0 else "Low",
            "details": impacted_subjects
        }
</file>

<file path="apps/api/src/services/email_service.py">
from flask_mail import Message
from utils.mail import mail
from flask import current_app
import logging

logger = logging.getLogger(__name__)

class EmailService:
    def send_email(self, recipient: str, subject: str, body: str, html: str = None):
        """Send an email to a single recipient."""
        try:
            msg = Message(
                subject=subject,
                recipients=[recipient],
                body=body,
                html=html,
                sender=current_app.config.get('MAIL_DEFAULT_SENDER')
            )
            mail.send(msg)
            logger.info(f"Email sent successfully to {recipient}")
            return True
        except Exception as e:
            logger.error(f"Failed to send email to {recipient}: {str(e)}")
            # In development, we don't want to fail the whole process if email fails
            if current_app.config.get('DEBUG'):
                print(f"DEBUG EMAIL ERROR: {str(e)}")
            return False

    def notify_user(self, user, subject: str, message: str):
        """Helper to send email if user has email address."""
        if hasattr(user, 'email') and user.email:
            return self.send_email(user.email, subject, message)
        return False
</file>

<file path="apps/api/src/services/ocr_service.py">
import pytesseract
from pdf2image import convert_from_path
import cv2
import numpy as np
from PIL import Image
import os
import logging

logger = logging.getLogger(__name__)

class OCRService:
    """
    Service for digitizing legacy syllabus documents (PDF/Images) using Tesseract OCR.
    """
    def __init__(self, tesseract_cmd=None):
        if tesseract_cmd:
            pytesseract.pytesseract.tesseract_cmd = tesseract_cmd
        
    def extract_text_from_image(self, image_path):
        """Extract text from a single image file."""
        try:
            # Preprocess image for better OCR
            img = cv2.imread(image_path)
            gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
            # Apply thresholding
            thresh = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY | cv2.THRESH_OTSU)[1]
            
            # Convert back to PIL for pytesseract
            pil_img = Image.fromarray(thresh)
            text = pytesseract.image_to_string(pil_img, lang='vie+eng')
            return text
        except Exception as e:
            logger.error(f"OCR selection error: {e}")
            return f"Error: {str(e)}"

    def extract_text_from_pdf(self, pdf_path):
        """Convert PDF pages to images and extract text from each."""
        try:
            pages = convert_from_path(pdf_path, 300) # 300 DPI
            full_text = ""
            for i, page in enumerate(pages):
                logger.info(f"Processing page {i+1}...")
                text = pytesseract.image_to_string(page, lang='vie+eng')
                full_text += f"\n--- Page {i+1} ---\n" + text
            return full_text
        except Exception as e:
            logger.error(f"PDF OCR error: {e}")
            return f"Error: {str(e)}"

    def process_file(self, file_path):
        """Main entry point to process different file types."""
        ext = os.path.splitext(file_path)[1].lower()
        if ext == '.pdf':
            return self.extract_text_from_pdf(file_path)
        elif ext in ['.png', '.jpg', '.jpeg', '.tiff', '.bmp']:
            return self.extract_text_from_image(file_path)
        else:
            return f"Unsupported file extension: {ext}"
</file>

<file path="apps/api/src/services/search_service.py">
from elasticsearch import Elasticsearch
import os
import logging

logger = logging.getLogger(__name__)

class SearchService:
    """
    Search service using Elasticsearch for high-performance syllabus indexing and searching.
    """
    def __init__(self, es_url=None):
        self.es_url = es_url or os.environ.get("ELASTICSEARCH_URL", "http://localhost:9200")
        try:
            self.es = Elasticsearch([self.es_url])
            # Check connection
            if not self.es.ping():
                logger.warning("Elasticsearch is not reachable. Search will be limited.")
                self.es = None
        except Exception as e:
            logger.error(f"Search Service init error: {e}")
            self.es = None

    def index_syllabus(self, syllabus_id, content_dict):
        """Index a syllabus into Elasticsearch."""
        if not self.es:
            return False
        try:
            res = self.es.index(index="syllabuses", id=syllabus_id, document=content_dict)
            return res['result'] in ['created', 'updated']
        except Exception as e:
            logger.error(f"Indexing error for syllabus {syllabus_id}: {e}")
            return False

    def search_syllabuses(self, query_text):
        """Perform a full-text search across syllabuses."""
        if not self.es:
            # Fallback to a placeholder or simple logic if ES is down
            return []
            
        try:
            body = {
                "query": {
                    "multi_match": {
                        "query": query_text,
                        "fields": ["subject_name_vi^3", "subject_code^5", "description", "content"],
                        "fuzziness": "AUTO"
                    }
                },
                "highlight": {
                    "fields": {
                        "description": {},
                        "content": {}
                    }
                }
            }
            res = self.es.search(index="syllabuses", body=body)
            hits = res['hits']['hits']
            return [
                {
                    "id": hit["_id"],
                    "score": hit["_score"],
                    "source": hit["_source"],
                    "highlight": hit.get("highlight", {})
                }
                for hit in hits
            ]
        except Exception as e:
            logger.error(f"Search error for query '{query_text}': {e}")
            return []

    def delete_index(self, syllabus_id):
        """Remove a syllabus from the search index."""
        if not self.es:
            return False
        try:
            self.es.delete(index="syllabuses", id=syllabus_id)
            return True
        except Exception as e:
            logger.error(f"Delete index error: {e}")
            return False
</file>

<file path="apps/api/src/services/syllabus_snapshot_service.py">
from infrastructure.repositories.syllabus_snapshot_repository import SyllabusSnapshotRepository
from typing import Dict, Any, Optional

class SyllabusSnapshotService:
    def __init__(self, repository: SyllabusSnapshotRepository, ai_service=None, syllabus_repository=None):
        self.repository = repository
        self.ai_service = ai_service
        self.syllabus_repository = syllabus_repository

    def create_snapshot(self, syllabus_id: int, version: str, data: Dict[str, Any], created_by: int = None):
        """
        Creates a new snapshot of the syllabus.
        data: dictionary containing all syllabus details (CLOs, Materials, etc.)
        """
        snapshot_data = {
            'syllabus_id': syllabus_id,
            'version': version,
            'snapshot_data': data,
            'created_by': created_by
        }
        return self.repository.create(snapshot_data)

    def get_syllabus_history(self, syllabus_id: int):
        return self.repository.get_by_syllabus(syllabus_id)

    def get_snapshot(self, snapshot_id: int):
        return self.repository.get_by_id(snapshot_id)

    def compare_snapshots(self, snapshot_id_1: int, snapshot_id_2: int):
        """Compare two historical snapshots using AI"""
        s1 = self.get_snapshot(snapshot_id_1)
        s2 = self.get_snapshot(snapshot_id_2)
        
        if not s1 or not s2:
            raise ValueError("Snapshot not found")
            
        if not self.ai_service:
            return {"error": "AI Service not available"}
            
        return self.ai_service.compare_syllabuses(s1.snapshot_data, s2.snapshot_data)

    def compare_with_current(self, snapshot_id: int, current_syllabus_id: int):
        """Compare a historical snapshot with the current active syllabus"""
        snapshot = self.get_snapshot(snapshot_id)
        if not snapshot:
            raise ValueError("Snapshot not found")
            
        if not self.syllabus_repository or not self.ai_service:
            return {"error": "Syllabus repository or AI service not available"}
            
        # We need a schema to dump the current syllabus to dict
        from api.schemas.syllabus_schema import SyllabusSchema
        current_syllabus = self.syllabus_repository.get_details(current_syllabus_id)
        if not current_syllabus:
            raise ValueError("Current syllabus not found")
            
        schema = SyllabusSchema()
        current_data = schema.dump(current_syllabus)
        
        return self.ai_service.compare_syllabuses(snapshot.snapshot_data, current_data)
</file>

<file path="apps/api/src/services/system_auditlog_service.py">
from infrastructure.repositories.system_auditlog_repository import SystemAuditLogRepository

class SystemAuditLogService:
    def __init__(self, repository: SystemAuditLogRepository):
        self.repository = repository

    def create_log(self, user_id: int, action_type: str, resource_target: str = None,
                   ip_address: str = None, user_agent: str = None, details: str = None):
        """Create a new audit log entry"""
        return self.repository.create(
            user_id=user_id,
            action_type=action_type,
            resource_target=resource_target,
            ip_address=ip_address,
            user_agent=user_agent,
            details=details
        )

    def list_logs(self, limit: int = 100):
        """Get recent audit logs"""
        return self.repository.list_logs(limit)

    def get_user_logs(self, user_id: int, limit: int = 50):
        """Get audit logs for a specific user"""
        return self.repository.get_by_user(user_id, limit)
</file>

<file path="apps/api/src/tasks.py">
from celery import shared_task
import time
from services.ai_service import AIService
from dependency_container import Container

@shared_task(ignore_result=False)
def analyze_clo_plo_task(clo_list, plo_list):
    """
    Background task to analyze CLO-PLO mapping using Gemini AI.
    """
    container = Container()
    ai_service = container.ai_service()
    
    # In a real scenario, this might take 10-20 seconds
    result = ai_service.analyze_clo_plo_mapping(clo_list, plo_list)
    return result

@shared_task(ignore_result=False)
def generate_syllabus_summary_task(content):
    """
    Background task to generate a summary for a syllabus.
    """
    container = Container()
    ai_service = container.ai_service()
    
    result = ai_service.summarize_syllabus(content)
    return result

@shared_task(ignore_result=False)
def compare_syllabuses_task(content_old, content_new):
    """
    Background task to compare two syllabus versions.
    """
    container = Container()
    ai_service = container.ai_service()
    
    result = ai_service.compare_versions(content_old, content_new)
    return result

@shared_task(ignore_result=True)
def check_deadlines_periodic_task():
    """
    Periodic task to check for overdue syllabus deadlines and send notifications.
    """
    container = Container()
    syllabus_service = container.syllabus_service()
    
    logger.info("Starting periodic deadline check...")
    count = syllabus_service.check_workflow_deadlines()
    logger.info(f"Deadline check completed. {count} notifications sent.")
    return count
</file>

<file path="apps/api/src/utils/mail.py">
from flask_mail import Mail

mail = Mail()

def init_mail(app):
    mail.init_app(app)
</file>

<file path="apps/api/src/utils/socket_io.py">
from flask_socketio import SocketIO
from utils.logging_config import get_logger

logger = get_logger(__name__)

socketio = SocketIO(cors_allowed_origins="*")

def init_socketio(app):
    """Initialize SocketIO with the Flask app"""
    logger.info("Initializing SocketIO...")
    socketio.init_app(app)

def notify_user(user_id, event, data):
    """Send a notification to a specific user via SocketIO"""
    room = f"user_{user_id}"
    logger.info(f"Emitting {event} to room {room}")
    socketio.emit(event, data, room=room)

def broadcast_notification(event, data):
    """Broadcast a notification to all connected users"""
    logger.info(f"Broadcasting {event}")
    socketio.emit(event, data)
</file>

<file path="apps/api/tests/add_is_active_column.py">
"""
Migration script to add is_active column to academic_years table
"""
import os
from sqlalchemy import create_engine, text
from dotenv import load_dotenv
import sys

load_dotenv()

def add_is_active_column():
    try:
        # Use the same DATABASE_URI from .env
        database_uri = os.getenv('DATABASE_URI')
        if not database_uri:
            print("‚úó DATABASE_URI not found in .env")
            return False
        
        # Connect to database
        engine = create_engine(database_uri)
        conn = engine.connect()
        
        # Check if column exists
        result = conn.execute(text("""
            SELECT COUNT(*) as cnt
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_NAME = 'academic_years' 
            AND COLUMN_NAME = 'is_active'
        """))
        
        exists = result.fetchone()[0]
        
        if exists:
            print("‚úì Column 'is_active' already exists in academic_years table")
        else:
            # Add the column
            conn.execute(text("""
                ALTER TABLE academic_years
                ADD is_active BIT NOT NULL DEFAULT 0
            """))
            conn.commit()
            print("‚úì Successfully added 'is_active' column to academic_years table")
        
        conn.close()
        return True
        
    except Exception as e:
        print(f"‚úó Error: {e}")
        return False

if __name__ == "__main__":
    success = add_is_active_column()
    sys.exit(0 if success else 1)
</file>

<file path="apps/api/tests/test_rbac_quick.py">
"""
RBAC Quick Test - Ch·ªâ test permissions, kh√¥ng test workflow
"""

import requests
import json

BASE_URL = "http://localhost:5000"

TEST_USERS = {
    'admin': {'username': 'admin', 'password': '123456'},
    'lecturer': {'username': 'gv_se', 'password': '123456'},
    'hod': {'username': 'hod_se', 'password': '123456'},
    'aa': {'username': 'aa_user', 'password': '123456'},
    'student': {'username': 'sv_hcmut', 'password': '123456'},
}

class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    END = '\033[0m'

def login(username, password):
    try:
        response = requests.post(
            f"{BASE_URL}/auth/login",
            json={'username': username, 'password': password}
        )
        if response.status_code == 200:
            data = response.json()
            return data.get('access_token'), data.get('role')
        return None, None
    except Exception as e:
        print(f"{Colors.RED}Login error: {e}{Colors.END}")
        return None, None

def test_permission(method, endpoint, token, should_pass, description):
    headers = {'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'}
    
    try:
        if method == 'GET':
            response = requests.get(f"{BASE_URL}{endpoint}", headers=headers)
        elif method == 'POST':
            response = requests.post(f"{BASE_URL}{endpoint}", json={}, headers=headers)
        
        status = response.status_code
        
        # Check permission (403 = no permission, anything else = has permission to try)
        has_permission = (status != 403)
        
        if should_pass and has_permission:
            print(f"  {Colors.GREEN}‚úì{Colors.END} {description}: Has permission (status {status})")
            return True
        elif not should_pass and not has_permission:
            print(f"  {Colors.GREEN}‚úì{Colors.END} {description}: Correctly blocked (403)")
            return True
        else:
            print(f"  {Colors.RED}‚úó{Colors.END} {description}: Expected {'access' if should_pass else 'block'}, got status {status}")
            return False
    except Exception as e:
        print(f"  {Colors.RED}‚úó{Colors.END} {description}: Error - {e}")
        return False

def run_tests():
    print(f"\n{Colors.BLUE}{'='*70}{Colors.END}")
    print(f"{Colors.BLUE}RBAC PERMISSION TEST (Quick){Colors.END}")
    print(f"{Colors.BLUE}{'='*70}{Colors.END}\n")
    
    tokens = {}
    
    print(f"{Colors.YELLOW}>>> Login Test Users{Colors.END}")
    for key, creds in TEST_USERS.items():
        token, role = login(creds['username'], creds['password'])
        if token:
            tokens[key] = token
            print(f"{Colors.GREEN}‚úì{Colors.END} {key}: {role}")
    
    if len(tokens) < 5:
        print(f"\n{Colors.RED}Not all users logged in. Check credentials.{Colors.END}")
        return
    
    passed = 0
    total = 0
    
    # Test 1: User List (Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 1: User List (GET /users/) - Admin Only{Colors.END}")
    tests = [
        ('admin', True, "Admin should access"),
        ('lecturer', False, "Lecturer should be blocked"),
        ('hod', False, "HOD should be blocked"),
        ('aa', False, "AA should be blocked"),
        ('student', False, "Student should be blocked"),
    ]
    for role_key, should_pass, desc in tests:
        if role_key in tokens:
            total += 1
            if test_permission('GET', '/users/', tokens[role_key], should_pass, desc):
                passed += 1
    
    # Test 2: Syllabus Submit (Lecturer, Admin)
    print(f"\n{Colors.YELLOW}>>> Test 2: Syllabus Submit (POST /syllabuses/1/submit) - Lecturer, Admin{Colors.END}")
    tests = [
        ('admin', True, "Admin should access"),
        ('lecturer', True, "Lecturer should access"),
        ('hod', False, "HOD should be blocked"),
        ('aa', False, "AA should be blocked"),
        ('student', False, "Student should be blocked"),
    ]
    for role_key, should_pass, desc in tests:
        if role_key in tokens:
            total += 1
            if test_permission('POST', '/syllabuses/1/submit', tokens[role_key], should_pass, desc):
                passed += 1
    
    # Test 3: Syllabus Evaluate (HOD, AA, Admin)
    print(f"\n{Colors.YELLOW}>>> Test 3: Syllabus Evaluate (POST /syllabuses/1/evaluate) - HOD, AA, Admin{Colors.END}")
    tests = [
        ('admin', True, "Admin should access"),
        ('hod', True, "HOD should access"),
        ('aa', True, "AA should access"),
        ('lecturer', False, "Lecturer should be blocked"),
        ('student', False, "Student should be blocked"),
    ]
    for role_key, should_pass, desc in tests:
        if role_key in tokens:
            total += 1
            if test_permission('POST', '/syllabuses/1/evaluate', tokens[role_key], should_pass, desc):
                passed += 1
    
    # Test 4: Student Subscribe (Student, Admin)
    print(f"\n{Colors.YELLOW}>>> Test 4: Student Subscribe (POST /student/subscribe) - Student, Admin{Colors.END}")
    tests = [
        ('admin', True, "Admin should access"),
        ('student', True, "Student should access"),
        ('lecturer', False, "Lecturer should be blocked"),
        ('hod', False, "HOD should be blocked"),
        ('aa', False, "AA should be blocked"),
    ]
    for role_key, should_pass, desc in tests:
        if role_key in tokens:
            total += 1
            if test_permission('POST', '/student/subscribe', tokens[role_key], should_pass, desc):
                passed += 1
    
    # Test 5: Admin Logs (Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 5: Admin Logs (GET /admin/logs) - Admin Only{Colors.END}")
    tests = [
        ('admin', True, "Admin should access"),
        ('lecturer', False, "Lecturer should be blocked"),
        ('hod', False, "HOD should be blocked"),
        ('aa', False, "AA should be blocked"),
        ('student', False, "Student should be blocked"),
    ]
    for role_key, should_pass, desc in tests:
        if role_key in tokens:
            total += 1
            if test_permission('GET', '/admin/logs', tokens[role_key], should_pass, desc):
                passed += 1
    
    # Test 6: Program Outcome Create (AA, Admin)
    print(f"\n{Colors.YELLOW}>>> Test 6: Program Outcome Create (POST /program-outcomes/) - AA, Admin{Colors.END}")
    tests = [
        ('admin', True, "Admin should access"),
        ('aa', True, "AA should access"),
        ('lecturer', False, "Lecturer should be blocked"),
        ('hod', False, "HOD should be blocked"),
        ('student', False, "Student should be blocked"),
    ]
    for role_key, should_pass, desc in tests:
        if role_key in tokens:
            total += 1
            if test_permission('POST', '/program-outcomes/', tokens[role_key], should_pass, desc):
                passed += 1
    
    print(f"\n{Colors.BLUE}{'='*70}{Colors.END}")
    print(f"{Colors.BLUE}RBAC PERMISSION TEST RESULTS{Colors.END}")
    print(f"{Colors.BLUE}{'='*70}{Colors.END}")
    print(f"\n{Colors.GREEN if passed == total else Colors.YELLOW}Passed: {passed}/{total} tests{Colors.END}")
    
    if passed == total:
        print(f"\n{Colors.GREEN}{'üéâ ' * 10}{Colors.END}")
        print(f"{Colors.GREEN}ALL RBAC TESTS PASSED! System is secure! üîí{Colors.END}")
        print(f"{Colors.GREEN}{'üéâ ' * 10}{Colors.END}\n")
    else:
        print(f"\n{Colors.YELLOW}‚ö†Ô∏è  Some tests failed. Review permissions.{Colors.END}\n")

if __name__ == '__main__':
    print("\n‚ö†Ô∏è  Make sure the API server is running on http://localhost:5000")
    input("\nPress Enter to start RBAC permission tests...")
    run_tests()
</file>

<file path="apps/api/tests/test_rbac.py">
"""
RBAC Implementation Test Script
Test role-based access control for different roles
"""

import requests
import json

BASE_URL = "http://localhost:5000"

# Test credentials (from seed_all_data.py)
TEST_USERS = {
    'admin': {'username': 'admin', 'password': '123456', 'expected_role': 'Admin'},
    'lecturer': {'username': 'gv_se', 'password': '123456', 'expected_role': 'Lecturer'},
    'hod': {'username': 'hod_se', 'password': '123456', 'expected_role': 'Head of Dept'},
    'aa': {'username': 'aa_user', 'password': '123456', 'expected_role': 'Academic Affairs'},
    'student': {'username': 'sv_hcmut', 'password': '123456', 'expected_role': 'Student'},
}

class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    END = '\033[0m'

def login(username, password):
    """Login and return access token"""
    try:
        response = requests.post(
            f"{BASE_URL}/auth/login",
            json={'username': username, 'password': password},
            headers={'Content-Type': 'application/json'}
        )
        if response.status_code == 200:
            data = response.json()
            token = data.get('access_token')
            role = data.get('role')
            print(f"{Colors.GREEN}‚úì{Colors.END} Login successful: {username} ({role})")
            return token, role
        else:
            print(f"{Colors.RED}‚úó{Colors.END} Login failed: {response.json()}")
            return None, None
    except Exception as e:
        print(f"{Colors.RED}‚úó{Colors.END} Login error: {e}")
        return None, None

def test_endpoint(method, endpoint, token, expected_status, description, data=None):
    """Test an endpoint with given token and expected status"""
    headers = {
        'Authorization': f'Bearer {token}',
        'Content-Type': 'application/json'
    }
    
    try:
        if method == 'GET':
            response = requests.get(f"{BASE_URL}{endpoint}", headers=headers)
        elif method == 'POST':
            response = requests.post(f"{BASE_URL}{endpoint}", json=data, headers=headers)
        elif method == 'PUT':
            response = requests.put(f"{BASE_URL}{endpoint}", json=data, headers=headers)
        elif method == 'DELETE':
            response = requests.delete(f"{BASE_URL}{endpoint}", headers=headers)
        
        status = response.status_code
        success = (status == expected_status)
        
        if success:
            print(f"  {Colors.GREEN}‚úì{Colors.END} {description}: {status} (expected {expected_status})")
        else:
            msg = response.json().get('message', '') if response.text else ''
            print(f"  {Colors.RED}‚úó{Colors.END} {description}: {status} (expected {expected_status}) - {msg}")
        
        return success
    except Exception as e:
        print(f"  {Colors.RED}‚úó{Colors.END} {description}: Error - {e}")
        return False

def create_test_syllabus(token, status='DRAFT'):
    """Create a test syllabus for testing"""
    try:
        data = {
            'subject_id': 1,
            'academic_year_id': 1,
            'lecturer_id': 2,  # gv_se
            'status': status,
            'version': '1.0-TEST',
            'description': 'Test syllabus for RBAC'
        }
        response = requests.post(
            f"{BASE_URL}/syllabuses/",
            json=data,
            headers={'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'}
        )
        if response.status_code == 201:
            syllabus = response.json()
            return syllabus.get('id')
        return None
    except Exception as e:
        print(f"  {Colors.YELLOW}‚ö†{Colors.END} Could not create test syllabus: {e}")
        return None

def update_syllabus_status(syllabus_id, token, status):
    """Update syllabus status for testing"""
    try:
        response = requests.put(
            f"{BASE_URL}/syllabuses/{syllabus_id}",
            json={'status': status},
            headers={'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'}
        )
        return response.status_code == 200
    except:
        return False

def run_tests():
    """Run comprehensive RBAC tests"""
    print(f"\n{Colors.BLUE}{'='*70}{Colors.END}")
    print(f"{Colors.BLUE}RBAC IMPLEMENTATION TEST{Colors.END}")
    print(f"{Colors.BLUE}{'='*70}{Colors.END}\n")
    
    tokens = {}
    
    # Login all test users
    print(f"\n{Colors.YELLOW}>>> Phase 1: Login Test Users{Colors.END}")
    for key, creds in TEST_USERS.items():
        token, role = login(creds['username'], creds['password'])
        if token:
            tokens[key] = token
    
    if not tokens:
        print(f"\n{Colors.RED}No users logged in. Cannot proceed with tests.{Colors.END}")
        return
    
    # Create test syllabuses with appropriate statuses
    print(f"\n{Colors.YELLOW}>>> Phase 2: Create Test Data{Colors.END}")
    draft_syllabus_id = None
    pending_syllabus_id = None
    
    if 'admin' in tokens:
        # Create DRAFT syllabus for submit test
        draft_syllabus_id = create_test_syllabus(tokens['admin'], 'DRAFT')
        if draft_syllabus_id:
            print(f"{Colors.GREEN}‚úì{Colors.END} Created DRAFT syllabus (ID: {draft_syllabus_id})")
        
        # Create PENDING syllabus for evaluate test
        pending_syllabus_id = create_test_syllabus(tokens['admin'], 'PENDING')
        if pending_syllabus_id:
            print(f"{Colors.GREEN}‚úì{Colors.END} Created PENDING syllabus (ID: {pending_syllabus_id})")
    
    if not draft_syllabus_id:
        draft_syllabus_id = 1  # Fallback
        print(f"{Colors.YELLOW}‚ö†{Colors.END} Using existing syllabus ID: {draft_syllabus_id}")
    
    if not pending_syllabus_id:
        pending_syllabus_id = 1  # Fallback
        print(f"{Colors.YELLOW}‚ö†{Colors.END} Using existing syllabus ID: {pending_syllabus_id}")
    
    # Test 1: Syllabus Submit (Lecturer/Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 1: Syllabus Submit (POST /syllabuses/{draft_syllabus_id}/submit){Colors.END}")
    print(f"Expected: Lecturer ‚úì, Admin ‚úì, Others ‚úó")
    
    # Reset to DRAFT if needed
    if 'admin' in tokens:
        update_syllabus_status(draft_syllabus_id, tokens['admin'], 'DRAFT')
    
    if 'lecturer' in tokens:
        test_endpoint('POST', f'/syllabuses/{draft_syllabus_id}/submit', tokens['lecturer'], 200, 
                      "Lecturer submit", {})
    
    # Reset to DRAFT for admin test
    if 'admin' in tokens:
        update_syllabus_status(draft_syllabus_id, tokens['admin'], 'DRAFT')
        test_endpoint('POST', f'/syllabuses/{draft_syllabus_id}/submit', tokens['admin'], 200, 
                      "Admin submit", {})
    
    if 'student' in tokens:
        test_endpoint('POST', f'/syllabuses/{draft_syllabus_id}/submit', tokens['student'], 403, 
                      "Student submit (should fail)", {})
    if 'hod' in tokens:
        test_endpoint('POST', f'/syllabuses/{draft_syllabus_id}/submit', tokens['hod'], 403, 
                      "HOD submit (should fail)", {})
    
    # Test 2: Syllabus Evaluate (HOD/AA/Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 2: Syllabus Evaluate (POST /syllabuses/{pending_syllabus_id}/evaluate){Colors.END}")
    print(f"Expected: HOD ‚úì, AA ‚úì, Admin ‚úì, Others ‚úó")
    
    # Reset to PENDING if needed
    if 'admin' in tokens:
        update_syllabus_status(pending_syllabus_id, tokens['admin'], 'PENDING')
    
    if 'hod' in tokens:
        test_endpoint('POST', f'/syllabuses/{pending_syllabus_id}/evaluate', tokens['hod'], 200, 
                      "HOD evaluate", {'action': 'approve'})
    
    # Reset to PENDING for AA test
    if 'admin' in tokens:
        update_syllabus_status(pending_syllabus_id, tokens['admin'], 'PENDING')
    
    if 'aa' in tokens:
        test_endpoint('POST', f'/syllabuses/{pending_syllabus_id}/evaluate', tokens['aa'], 200, 
                      "AA evaluate", {'action': 'approve'})
    
    # Reset to PENDING for Admin test
    if 'admin' in tokens:
        update_syllabus_status(pending_syllabus_id, tokens['admin'], 'PENDING')
        test_endpoint('POST', f'/syllabuses/{pending_syllabus_id}/evaluate', tokens['admin'], 200, 
                      "Admin evaluate", {'action': 'approve'})
    
    if 'lecturer' in tokens:
        test_endpoint('POST', f'/syllabuses/{pending_syllabus_id}/evaluate', tokens['lecturer'], 403, 
                      "Lecturer evaluate (should fail)", {'action': 'approve'})
    if 'student' in tokens:
        test_endpoint('POST', f'/syllabuses/{pending_syllabus_id}/evaluate', tokens['student'], 403, 
                      "Student evaluate (should fail)", {'action': 'approve'})
    
    # Test 3: User Management (Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 3: User List (GET /users/){Colors.END}")
    print(f"Expected: Admin ‚úì, Others ‚úó")
    
    if 'admin' in tokens:
        test_endpoint('GET', '/users/', tokens['admin'], 200, "Admin list users")
    if 'lecturer' in tokens:
        test_endpoint('GET', '/users/', tokens['lecturer'], 403, "Lecturer list users (should fail)")
    if 'student' in tokens:
        test_endpoint('GET', '/users/', tokens['student'], 403, "Student list users (should fail)")
    
    # Test 4: Student Subscribe (Student/Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 4: Student Subscribe (POST /student/subscribe){Colors.END}")
    print(f"Expected: Student ‚úì, Admin ‚úì, Others ‚úó")
    
    if 'student' in tokens:
        test_endpoint('POST', '/student/subscribe', tokens['student'], 201, 
                      "Student subscribe", {'student_id': 1, 'subject_id': 1})
    if 'admin' in tokens:
        test_endpoint('POST', '/student/subscribe', tokens['admin'], 201, 
                      "Admin subscribe", {'student_id': 1, 'subject_id': 1})
    if 'lecturer' in tokens:
        test_endpoint('POST', '/student/subscribe', tokens['lecturer'], 403, 
                      "Lecturer subscribe (should fail)", {'student_id': 1, 'subject_id': 1})
    
    # Test 5: Admin Logs (Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 5: Admin Logs (GET /admin/logs){Colors.END}")
    print(f"Expected: Admin ‚úì, Others ‚úó")
    
    if 'admin' in tokens:
        test_endpoint('GET', '/admin/logs', tokens['admin'], 200, "Admin view logs")
    if 'hod' in tokens:
        test_endpoint('GET', '/admin/logs', tokens['hod'], 403, "HOD view logs (should fail)")
    if 'student' in tokens:
        test_endpoint('GET', '/admin/logs', tokens['student'], 403, "Student view logs (should fail)")
    
    # Test 6: Program Outcome Create (AA/Admin only)
    print(f"\n{Colors.YELLOW}>>> Test 6: Program Outcome Create (POST /program-outcomes/){Colors.END}")
    print(f"Expected: AA ‚úì, Admin ‚úì, Others ‚úó")
    
    plo_data = {'program_id': 1, 'code': 'PLO_TEST', 'description': 'Test PLO'}
    
    if 'aa' in tokens:
        test_endpoint('POST', '/program-outcomes/', tokens['aa'], 201, 
                      "AA create PLO", plo_data)
    if 'admin' in tokens:
        test_endpoint('POST', '/program-outcomes/', tokens['admin'], 201, 
                      "Admin create PLO", plo_data)
    if 'lecturer' in tokens:
        test_endpoint('POST', '/program-outcomes/', tokens['lecturer'], 403, 
                      "Lecturer create PLO (should fail)", plo_data)
    
    print(f"\n{Colors.BLUE}{'='*70}{Colors.END}")
    print(f"{Colors.GREEN}RBAC Test Completed!{Colors.END}")
    print(f"{Colors.BLUE}{'='*70}{Colors.END}\n")

if __name__ == '__main__':
    print("\n‚ö†Ô∏è  Make sure the API server is running on http://localhost:5000")
    print("‚ö†Ô∏è  Make sure you have seeded the database with test users")
    input("\nPress Enter to start tests...")
    run_tests()
</file>

<file path="apps/api/tests/test_send_notification.py">
"""Script to send test notification to admin users"""
import sys
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker
import os
from dotenv import load_dotenv
from datetime import datetime

# Load environment variables
load_dotenv()

DATABASE_URI = os.getenv('DATABASE_URI')
if not DATABASE_URI:
    print("‚ùå DATABASE_URI not found in .env")
    sys.exit(1)

# Create engine
engine = create_engine(DATABASE_URI)
Session = sessionmaker(bind=engine)
session = Session()

try:
    # Find admin users (role_id = 1 typically is Admin)
    result = session.execute(text("""
        SELECT u.id, u.username, u.full_name, r.name as role_name
        FROM users u
        JOIN user_roles ur ON u.id = ur.user_id
        JOIN roles r ON ur.role_id = r.id
        WHERE r.name = 'Admin'
    """))
    
    admin_users = result.fetchall()
    
    if not admin_users:
        print("‚ùå No admin users found")
        sys.exit(1)
    
    print(f"üìã Found {len(admin_users)} admin user(s):")
    for user in admin_users:
        print(f"   - {user.full_name} (@{user.username}) - Role: {user.role_name}")
    
    # Create test notifications for each admin
    for user in admin_users:
        session.execute(text("""
            INSERT INTO notifications (user_id, title, message, type, link, is_read, created_at)
            VALUES (:user_id, :title, :message, :type, :link, 0, :created_at)
        """), {
            'user_id': user.id,
            'title': 'Alo V≈© √† em',
            'message': 'ƒê√¢y l√† th√¥ng b√°o test ƒë∆∞·ª£c g·ª≠i l√∫c ' + datetime.now().strftime('%H:%M:%S %d/%m/%Y'),
            'type': 'INFO',
            'link': '/profile',
            'created_at': datetime.now()
        })
    
    session.commit()
    print(f"‚úÖ Successfully sent test notification to {len(admin_users)} admin(s)")
    
except Exception as e:
    print(f"‚ùå Error: {e}")
    session.rollback()
finally:
    session.close()
</file>

<file path="apps/web/app/(main)/admin/departments/page.tsx">
"use client";

import React, { useEffect, useState, useCallback } from "react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { 
  Plus, 
  Search, 
  Edit2, 
  Trash2, 
  Loader2, 
  Building,
  School,
  Building2
} from "lucide-react";
import { 
  Dialog, 
  DialogContent, 
  DialogHeader, 
  DialogTitle, 
  DialogFooter,
  DialogDescription
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import axios from "@/lib/axios";
import { useAuth } from "@/contexts/AuthContext";

interface Faculty {
  id: number;
  code: string;
  name: string;
  description?: string;
}

interface Department {
  id: number;
  facultyId: number;
  code: string;
  name: string;
  faculty?: {
    id: number;
    name: string;
    code: string;
  };
}

export default function DepartmentsPage() {
  const { role } = useAuth();
  const [faculties, setFaculties] = useState<Faculty[]>([]);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState("faculties");
  const [searchTerm, setSearchTerm] = useState("");

  // Dialog states
  const [dialogOpen, setDialogOpen] = useState(false);
  const [editingItem, setEditingItem] = useState<any>(null);
  const [itemType, setItemType] = useState<"faculty" | "department">("faculty");
  const [submitting, setSubmitting] = useState(false);

  // Form states
  const [facultyFormData, setFacultyFormData] = useState({ code: "", name: "", description: "" });
  const [deptFormData, setDeptFormData] = useState({ code: "", name: "", facultyId: "" });

  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      const [facRes, deptRes] = await Promise.all([
        axios.get("/faculties"),
        axios.get("/departments")
      ]);
      setFaculties(facRes.data || []);
      setDepartments(deptRes.data || []);
    } catch (err) {
      console.error("Failed to fetch data:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  const handleOpenDialog = (type: "faculty" | "department", item?: any) => {
    setItemType(type);
    if (item) {
      setEditingItem(item);
      if (type === "faculty") {
        setFacultyFormData({ 
          code: item.code, 
          name: item.name, 
          description: item.description || "" 
        });
      } else {
        setDeptFormData({ 
          code: item.code, 
          name: item.name, 
          facultyId: String(item.facultyId) 
        });
      }
    } else {
      setEditingItem(null);
      if (type === "faculty") {
        setFacultyFormData({ code: "", name: "", description: "" });
      } else {
        setDeptFormData({ code: "", name: "", facultyId: "" });
      }
    }
    setDialogOpen(true);
  };

  const handleSubmit = async () => {
    if (itemType === "faculty") {
      if (!facultyFormData.code || !facultyFormData.name) {
        alert("Vui l√≤ng nh·∫≠p m√£ v√† t√™n khoa");
        return;
      }
    } else {
      if (!deptFormData.code || !deptFormData.name || !deptFormData.facultyId) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·ªô m√¥n");
        return;
      }
    }

    setSubmitting(true);
    try {
      if (itemType === "faculty") {
        if (editingItem) {
          await axios.put(`/faculties/${editingItem.id}`, facultyFormData);
        } else {
          await axios.post("/faculties", facultyFormData);
        }
      } else {
        const payload = { 
          code: deptFormData.code,
          name: deptFormData.name,
          facultyId: Number(deptFormData.facultyId) 
        };
        if (editingItem) {
          await axios.put(`/departments/${editingItem.id}`, payload);
        } else {
          await axios.post("/departments", payload);
        }
      }
      setDialogOpen(false);
      fetchData();
      alert("Thao t√°c th√†nh c√¥ng!");
    } catch (err: any) {
      console.error("Submit error:", err);
      alert(err.response?.data?.message || "C√≥ l·ªói x·∫£y ra");
    } finally {
      setSubmitting(false);
    }
  };

  const handleDelete = async (type: "faculty" | "department", id: number) => {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${type === 'faculty' ? 'khoa' : 'b·ªô m√¥n'} n√†y?`)) return;
    try {
      const endpoint = type === "faculty" ? "/faculties" : "/departments";
      await axios.delete(`${endpoint}/${id}`);
      fetchData();
      alert("X√≥a th√†nh c√¥ng!");
    } catch (err: any) {
      console.error("Delete error:", err);
      alert(err.response?.data?.message || "C√≥ l·ªói x·∫£y ra khi x√≥a");
    }
  };

  const filteredFaculties = faculties.filter(f => 
    f.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    f.code.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const filteredDepartments = departments.filter(d => 
    d.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    d.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
    d.faculty?.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="p-6 space-y-6 bg-slate-50 min-h-screen">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Qu·∫£n l√Ω Khoa & B·ªô m√¥n</h1>
          <p className="text-slate-500">Qu·∫£n l√Ω c∆° c·∫•u t·ªï ch·ª©c c·ªßa tr∆∞·ªùng</p>
        </div>
        <Button 
          className="bg-teal-600 hover:bg-teal-700 text-white"
          onClick={() => handleOpenDialog(activeTab === "faculties" ? "faculty" : "department")}
        >
          <Plus className="w-4 h-4 mr-2" />
          Th√™m {activeTab === "faculties" ? "Khoa" : "B·ªô m√¥n"}
        </Button>
      </div>

      <Card className="border-none shadow-sm overflow-hidden">
        <CardContent className="p-0">
          <Tabs defaultValue="faculties" value={activeTab} onValueChange={setActiveTab} className="w-full">
            <div className="px-6 pt-4 border-b bg-white flex justify-between items-center">
              <TabsList className="bg-slate-100 p-1 mb-2">
                <TabsTrigger value="faculties" className="data-[state=active]:bg-white data-[state=active]:text-teal-700 flex items-center gap-2">
                  <School className="w-4 h-4" /> Khoa
                </TabsTrigger>
                <TabsTrigger value="departments" className="data-[state=active]:bg-white data-[state=active]:text-teal-700 flex items-center gap-2">
                  <Building2 className="w-4 h-4" /> B·ªô m√¥n
                </TabsTrigger>
              </TabsList>
              <div className="relative w-64 mb-2">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                <Input 
                  placeholder="T√¨m ki·∫øm..." 
                  className="pl-9 bg-slate-50 border-slate-200 focus:bg-white transition-all"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>
            </div>

            <TabsContent value="faculties" className="m-0">
              <Table>
                <TableHeader>
                  <TableRow className="bg-slate-50/50">
                    <TableHead className="w-[100px]">ID</TableHead>
                    <TableHead>M√£ Khoa</TableHead>
                    <TableHead>T√™n Khoa</TableHead>
                    <TableHead>M√¥ t·∫£</TableHead>
                    <TableHead className="text-right">Thao t√°c</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {loading ? (
                    <TableRow>
                      <TableCell colSpan={5} className="h-32 text-center text-slate-500">
                        <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2" />
                        ƒêang t·∫£i d·ªØ li·ªáu...
                      </TableCell>
                    </TableRow>
                  ) : filteredFaculties.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={5} className="h-32 text-center text-slate-500">
                        Kh√¥ng t√¨m th·∫•y khoa n√†o
                      </TableCell>
                    </TableRow>
                  ) : filteredFaculties.map((f) => (
                    <TableRow key={f.id} className="hover:bg-slate-50/50 transition-colors">
                      <TableCell className="font-medium text-slate-500">{f.id}</TableCell>
                      <TableCell>
                        <Badge variant="outline" className="font-mono text-teal-700 border-teal-100 bg-teal-50/30">
                          {f.code}
                        </Badge>
                      </TableCell>
                      <TableCell className="font-semibold text-slate-700">{f.name}</TableCell>
                      <TableCell className="text-slate-500 italic max-w-xs truncate">{f.description || "-"}</TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2">
                          <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-8 w-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50"
                            onClick={() => handleOpenDialog("faculty", f)}
                          >
                            <Edit2 className="w-4 h-4" />
                          </Button>
                          <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-8 w-8 text-red-500 hover:text-red-700 hover:bg-red-50"
                            onClick={() => handleDelete("faculty", f.id)}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TabsContent>

            <TabsContent value="departments" className="m-0">
              <Table>
                <TableHeader>
                  <TableRow className="bg-slate-50/50">
                    <TableHead className="w-[100px]">ID</TableHead>
                    <TableHead>M√£ B·ªô m√¥n</TableHead>
                    <TableHead>T√™n B·ªô m√¥n</TableHead>
                    <TableHead>Thu·ªôc Khoa</TableHead>
                    <TableHead className="text-right">Thao t√°c</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {loading ? (
                    <TableRow>
                      <TableCell colSpan={5} className="h-32 text-center text-slate-500">
                        <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2" />
                        ƒêang t·∫£i d·ªØ li·ªáu...
                      </TableCell>
                    </TableRow>
                  ) : filteredDepartments.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={5} className="h-32 text-center text-slate-500">
                        Kh√¥ng t√¨m th·∫•y b·ªô m√¥n n√†o
                      </TableCell>
                    </TableRow>
                  ) : filteredDepartments.map((d) => (
                    <TableRow key={d.id} className="hover:bg-slate-50/50 transition-colors">
                      <TableCell className="font-medium text-slate-500">{d.id}</TableCell>
                      <TableCell>
                        <Badge variant="outline" className="font-mono text-blue-700 border-blue-100 bg-blue-50/30">
                          {d.code}
                        </Badge>
                      </TableCell>
                      <TableCell className="font-semibold text-slate-700">{d.name}</TableCell>
                      <TableCell>
                        <Badge variant="secondary" className="bg-slate-100 text-slate-600">
                          {d.faculty?.name || "N/A"}
                        </Badge>
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2">
                          <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-8 w-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50"
                            onClick={() => handleOpenDialog("department", d)}
                          >
                            <Edit2 className="w-4 h-4" />
                          </Button>
                          <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-8 w-8 text-red-500 hover:text-red-700 hover:bg-red-50"
                            onClick={() => handleDelete("department", d.id)}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>

      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <DialogTitle>{editingItem ? "C·∫≠p nh·∫≠t" : "Th√™m m·ªõi"} {itemType === "faculty" ? "Khoa" : "B·ªô m√¥n"}</DialogTitle>
            <DialogDescription>Nh·∫≠p th√¥ng tin chi ti·∫øt d∆∞·ªõi ƒë√¢y.</DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4 py-4">
            {itemType === "faculty" ? (
              <>
                <div className="space-y-2">
                  <Label htmlFor="fac-code">M√£ Khoa</Label>
                  <Input 
                    id="fac-code" 
                    value={facultyFormData.code} 
                    onChange={(e) => setFacultyFormData({...facultyFormData, code: e.target.value})}
                    placeholder="VD: CNTT, KTVT..."
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="fac-name">T√™n Khoa</Label>
                  <Input 
                    id="fac-name" 
                    value={facultyFormData.name} 
                    onChange={(e) => setFacultyFormData({...facultyFormData, name: e.target.value})}
                    placeholder="VD: Khoa C√¥ng ngh·ªá th√¥ng tin..."
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="fac-desc">M√¥ t·∫£</Label>
                  <Input 
                    id="fac-desc" 
                    value={facultyFormData.description} 
                    onChange={(e) => setFacultyFormData({...facultyFormData, description: e.target.value})}
                  />
                </div>
              </>
            ) : (
              <>
                <div className="space-y-2">
                  <Label htmlFor="dept-faculty">Thu·ªôc Khoa</Label>
                  <select 
                    id="dept-faculty"
                    className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    value={deptFormData.facultyId}
                    onChange={(e) => setDeptFormData({...deptFormData, facultyId: e.target.value})}
                  >
                    <option value="">-- Ch·ªçn Khoa --</option>
                    {faculties.map(f => (
                      <option key={f.id} value={f.id}>{f.name}</option>
                    ))}
                  </select>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="dept-code">M√£ B·ªô m√¥n</Label>
                  <Input 
                    id="dept-code" 
                    value={deptFormData.code} 
                    onChange={(e) => setDeptFormData({...deptFormData, code: e.target.value})}
                    placeholder="VD: KHMT, HTTT..."
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="dept-name">T√™n B·ªô m√¥n</Label>
                  <Input 
                    id="dept-name" 
                    value={deptFormData.name} 
                    onChange={(e) => setDeptFormData({...deptFormData, name: e.target.value})}
                    placeholder="VD: H·ªá th·ªëng th√¥ng tin..."
                  />
                </div>
              </>
            )}
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setDialogOpen(false)} disabled={submitting}>H·ªßy</Button>
            <Button 
                onClick={handleSubmit} 
                disabled={submitting}
                className="bg-teal-600 hover:bg-teal-700 text-white"
            >
              {submitting && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
              L∆∞u thay ƒë·ªïi
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/programs/page.tsx">
"use client";

import React, { useEffect, useState, useCallback } from "react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { 
  Plus, 
  Search, 
  Edit2, 
  Trash2, 
  Loader2, 
  GraduationCap, 
  Building2,
  BookOpen
} from "lucide-react";
import { 
  Dialog, 
  DialogContent, 
  DialogHeader, 
  DialogTitle, 
  DialogFooter,
  DialogDescription
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import axios from "@/lib/axios";
import { useAuth } from "@/contexts/AuthContext";

interface Program {
  id: number;
  name: string;
  departmentId: number;
  totalCredits: number;
  department?: {
    id: number;
    name: string;
    code: string;
  };
}

interface Department {
  id: number;
  name: string;
  code: string;
}

export default function ProgramsPage() {
  const { role } = useAuth();
  const [programs, setPrograms] = useState<Program[]>([]);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  
  // States for Create/Edit Dialog
  const [dialogOpen, setDialogOpen] = useState(false);
  const [editingProgram, setEditingProgram] = useState<Program | null>(null);
  const [formData, setFormData] = useState({
    name: "",
    departmentId: "",
    totalCredits: 0
  });
  const [submitting, setSubmitting] = useState(false);

  const fetchPrograms = useCallback(async () => {
    setLoading(true);
    try {
      const [programsRes, departmentsRes] = await Promise.all([
        axios.get("/programs"),
        axios.get("/departments")
      ]);
      setPrograms(programsRes.data || []);
      setDepartments(departmentsRes.data || []);
    } catch (err) {
      console.error("Failed to fetch programs:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPrograms();
  }, [fetchPrograms]);

  const filteredPrograms = programs.filter(p => 
    p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    p.department?.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleOpenDialog = (program?: Program) => {
    if (program) {
      setEditingProgram(program);
      setFormData({
        name: program.name,
        departmentId: String(program.departmentId),
        totalCredits: program.totalCredits || 0
      });
    } else {
      setEditingProgram(null);
      setFormData({
        name: "",
        departmentId: "",
        totalCredits: 0
      });
    }
    setDialogOpen(true);
  };

  const handleSubmit = async () => {
    if (!formData.name || !formData.departmentId) {
      alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t√™n v√† b·ªô m√¥n");
      return;
    }

    setSubmitting(true);
    try {
      const payload = {
        name: formData.name,
        departmentId: Number(formData.departmentId),
        totalCredits: Number(formData.totalCredits)
      };

      if (editingProgram) {
        await axios.put(`/programs/${editingProgram.id}`, payload);
        alert("C·∫≠p nh·∫≠t ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o th√†nh c√¥ng!");
      } else {
        await axios.post("/programs", payload);
        alert("Th√™m ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o th√†nh c√¥ng!");
      }
      setDialogOpen(false);
      fetchPrograms();
    } catch (err: any) {
      console.error("Submit error:", err);
      alert(err.response?.data?.message || "C√≥ l·ªói x·∫£y ra khi l∆∞u");
    } finally {
      setSubmitting(false);
    }
  };

  const handleDelete = async (id: number) => {
    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o n√†y kh√¥ng?")) return;
    
    try {
      await axios.delete(`/programs/${id}`);
      alert("ƒê√£ x√≥a th√†nh c√¥ng");
      fetchPrograms();
    } catch (err: any) {
      console.error("Delete error:", err);
      alert(err.response?.data?.message || "C√≥ l·ªói x·∫£y ra khi x√≥a");
    }
  };

  const isAdmin = role === "Admin" || role === "Academic Affairs" || role === "AA";

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold tracking-tight">Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o</h1>
          <p className="text-sm text-muted-foreground">
            Qu·∫£n l√Ω c√°c ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o, chuy√™n ng√†nh v√† c·∫•u tr√∫c t√≠n ch·ªâ c·ªßa nh√† tr∆∞·ªùng.
          </p>
        </div>
        {isAdmin && (
          <Button className="bg-teal-600 hover:bg-teal-700" onClick={() => handleOpenDialog()}>
            <Plus className="w-4 h-4 mr-2" /> Th√™m ch∆∞∆°ng tr√¨nh
          </Button>
        )}
      </div>

      <Card>
        <CardHeader className="pb-3">
          <div className="relative">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="T√¨m ki·∫øm ch∆∞∆°ng tr√¨nh ho·∫∑c b·ªô m√¥n..."
              className="pl-8 max-w-sm"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
        </CardHeader>
        <CardContent>
          {loading ? (
            <div className="flex items-center justify-center h-64">
              <Loader2 className="h-8 w-8 animate-spin text-teal-600" />
            </div>
          ) : (
            <div className="border rounded-md">
              <Table>
                <TableHeader>
                  <TableRow className="bg-slate-50">
                    <TableHead className="w-12">ID</TableHead>
                    <TableHead>T√™n Ch∆∞∆°ng tr√¨nh</TableHead>
                    <TableHead>B·ªô m√¥n / Khoa</TableHead>
                    <TableHead className="text-center">S·ªë t√≠n ch·ªâ</TableHead>
                    {isAdmin && <TableHead className="w-24 text-right">Thao t√°c</TableHead>}
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredPrograms.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={isAdmin ? 5 : 4} className="text-center py-10 text-muted-foreground">
                        Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng tr√¨nh n√†o ph√π h·ª£p.
                      </TableCell>
                    </TableRow>
                  ) : (
                    filteredPrograms.map((p) => (
                      <TableRow key={p.id} className="hover:bg-slate-50/50">
                        <TableCell className="font-medium text-slate-500">{p.id}</TableCell>
                        <TableCell>
                          <div className="flex items-center gap-2">
                            <div className="p-1.5 bg-teal-50 rounded text-teal-600">
                                <GraduationCap className="w-4 h-4" />
                            </div>
                            <span className="font-semibold text-slate-900">{p.name}</span>
                          </div>
                        </TableCell>
                        <TableCell>
                           <div className="flex items-center gap-1.5 text-slate-600">
                              <Building2 className="w-4 h-4 text-slate-400" />
                              <span>{p.department?.name || "N/A"}</span>
                           </div>
                        </TableCell>
                        <TableCell className="text-center">
                           <Badge variant="outline" className="font-mono bg-blue-50 text-blue-700 border-blue-200">
                              {p.totalCredits} TC
                           </Badge>
                        </TableCell>
                        {isAdmin && (
                          <TableCell className="text-right">
                            <div className="flex justify-end gap-2">
                              <Button 
                                variant="ghost" 
                                size="sm" 
                                className="h-8 w-8 p-0 text-teal-600 hover:text-teal-700 hover:bg-teal-50"
                                onClick={() => handleOpenDialog(p)}
                                title="Ch·ªânh s·ª≠a"
                              >
                                <Edit2 className="h-4 w-4" />
                              </Button>
                              <Button 
                                variant="ghost" 
                                size="sm" 
                                className="h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50"
                                onClick={() => handleDelete(p.id)}
                                title="X√≥a"
                              >
                                <Trash2 className="h-4 w-4" />
                              </Button>
                            </div>
                          </TableCell>
                        )}
                      </TableRow>
                    ))
                  )}
                </TableBody>
              </Table>
            </div>
          )}
        </CardContent>
      </Card>

      {/* CREATE/EDIT DIALOG */}
      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>
              {editingProgram ? "Ch·ªânh s·ª≠a ch∆∞∆°ng tr√¨nh" : "Th√™m ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o m·ªõi"}
            </DialogTitle>
            <DialogDescription>
              Nh·∫≠p th√¥ng tin chi ti·∫øt cho ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o. Nh·∫•n l∆∞u khi ho√†n t·∫•t.
            </DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-4">
            <div className="grid gap-2">
              <Label htmlFor="name">T√™n ch∆∞∆°ng tr√¨nh <span className="text-red-600">*</span></Label>
              <Input
                id="name"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="V√≠ d·ª•: C√¥ng ngh·ªá th√¥ng tin"
              />
            </div>
            <div className="grid gap-2">
              <Label htmlFor="department">B·ªô m√¥n tr·ª±c thu·ªôc <span className="text-red-600">*</span></Label>
              <select
                id="department"
                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                value={formData.departmentId}
                onChange={(e) => setFormData({ ...formData, departmentId: e.target.value })}
              >
                <option value="">-- Ch·ªçn b·ªô m√¥n --</option>
                {departments.map(dept => (
                  <option key={dept.id} value={dept.id}>{dept.name} ({dept.code})</option>
                ))}
              </select>
            </div>
            <div className="grid gap-2">
              <Label htmlFor="credits">T·ªïng s·ªë t√≠n ch·ªâ</Label>
              <Input
                id="credits"
                type="number"
                value={formData.totalCredits}
                onChange={(e) => setFormData({ ...formData, totalCredits: Number(e.target.value) })}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDialogOpen(false)} disabled={submitting}>H·ªßy</Button>
            <Button 
                onClick={handleSubmit} 
                disabled={submitting}
                className="bg-teal-600 hover:bg-teal-700"
            >
              {submitting ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : null}
              {editingProgram ? "C·∫≠p nh·∫≠t" : "L∆∞u thay ƒë·ªïi"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/reports/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { 
  MessageSquareWarning, 
  Loader2, 
  User, 
  FileText, 
  Calendar,
  CheckCircle2,
  Clock
} from "lucide-react";
import { Button } from "@/components/ui/button";
import axios from "@/lib/axios";
import { useAuth } from "@/contexts/AuthContext";
import Link from "next/link";

interface Report {
  id: number;
  syllabusId: number;
  userId: number;
  content: string;
  createdAt: string;
  status: string;
  user?: {
    full_name: string;
    username: string;
  };
  syllabus?: {
    subject_code: string;
    subject_name_vi: string;
    version: string;
  };
}

export default function ReportsPage() {
  const { role } = useAuth();
  const [reports, setReports] = useState<Report[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchReports = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/student/reports');
      setReports(res.data || []);
    } catch (e: any) {
      console.error(e);
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchReports(); }, []);

  const getStatusBadge = (status: string) => {
    if (status === "RESOLVED") return <Badge className="bg-green-100 text-green-700 border-green-200 gap-1"><CheckCircle2 className="w-3 h-3" /> ƒê√£ x·ª≠ l√Ω</Badge>;
    return <Badge variant="outline" className="bg-amber-50 text-amber-700 border-amber-200 gap-1"><Clock className="w-3 h-3" /> Ch·ªù x·ª≠ l√Ω</Badge>;
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                <MessageSquareWarning className="w-6 h-6 text-rose-500" /> Ph·∫£n h·ªìi & B√°o l·ªói t·ª´ Sinh vi√™n
            </h2>
            <p className="text-muted-foreground">Theo d√µi v√† x·ª≠ l√Ω c√°c ph·∫£n h·ªìi c·ªßa sinh vi√™n v·ªÅ n·ªôi dung ƒë·ªÅ c∆∞∆°ng.</p>
        </div>
        <Button variant="outline" size="sm" onClick={fetchReports} className="gap-2">
            L√†m m·ªõi
        </Button>
      </div>

      <Card>
        <CardContent className="p-0">
          {loading ? (
            <div className="flex items-center justify-center p-20">
              <Loader2 className="w-8 h-8 animate-spin text-teal-600" />
            </div>
          ) : (
            <div className="border rounded-md">
              <Table>
                <TableHeader>
                  <TableRow className="bg-slate-50">
                    <TableHead className="w-[180px]">Sinh vi√™n</TableHead>
                    <TableHead className="w-[250px]">H·ªçc ph·∫ßn / ƒê·ªÅ c∆∞∆°ng</TableHead>
                    <TableHead>N·ªôi dung ph·∫£n h·ªìi</TableHead>
                    <TableHead className="w-[150px]">Ng√†y g·ª≠i</TableHead>
                    <TableHead className="text-right">Tr·∫°ng th√°i</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {reports.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={5} className="text-center py-20 text-muted-foreground italic text-lg">
                        Hi·ªán ch∆∞a c√≥ ph·∫£n h·ªìi n√†o t·ª´ sinh vi√™n.
                      </TableCell>
                    </TableRow>
                  ) : (
                    reports.map((r) => (
                      <TableRow key={r.id} className="hover:bg-slate-50 transition-colors">
                        <TableCell>
                          <div className="flex items-center gap-2">
                            <div className="p-2 bg-slate-100 rounded-full text-slate-500"><User className="w-4 h-4" /></div>
                            <div>
                                <div className="font-semibold text-sm">{r.user?.full_name || "Sinh vi√™n"}</div>
                                <div className="text-[10px] text-muted-foreground">@{r.user?.username || "unknown"}</div>
                            </div>
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="space-y-1">
                            <div className="flex items-center gap-1.5 font-bold text-teal-700 text-xs">
                                <FileText className="w-3 h-3" />
                                <Link href={`/syllabus/${r.syllabusId}`} className="hover:underline">
                                    {r.syllabus?.subject_code} - v{r.syllabus?.version}
                                </Link>
                            </div>
                            <div className="text-[11px] text-slate-500 truncate max-w-[220px]">
                                {r.syllabus?.subject_name_vi}
                            </div>
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="max-w-[400px] text-sm text-slate-700 line-clamp-2 italic">
                            "{r.content}"
                          </div>
                        </TableCell>
                        <TableCell>
                           <div className="flex items-center gap-1.5 text-xs text-slate-500">
                              <Calendar className="w-3.5 h-3.5" />
                              {new Date(r.createdAt).toLocaleDateString('vi-VN')}
                           </div>
                        </TableCell>
                        <TableCell className="text-right">
                           {getStatusBadge(r.status)}
                        </TableCell>
                      </TableRow>
                    ))
                  )}
                </TableBody>
              </Table>
            </div>
          )}
        </CardContent>
      </Card>
      
      <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg flex gap-3">
          <div className="p-2 bg-blue-100 rounded-full text-blue-600 h-fit"><Clock className="w-4 h-4" /></div>
          <div>
              <h4 className="font-bold text-blue-800 text-sm">Ghi ch√∫ cho Qu·∫£n tr·ªã vi√™n</h4>
              <p className="text-xs text-blue-700 leading-relaxed max-w-2xl">
                  Khi sinh vi√™n b√°o l·ªói, th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Gi·∫£ng vi√™n bi√™n so·∫°n v√† Tr∆∞·ªüng b·ªô m√¥n. 
                  B·∫°n c√≥ th·ªÉ li√™n h·ªá tr·ª±c ti·∫øp v·ªõi sinh vi√™n ƒë·ªÉ l√†m r√µ v·∫•n ƒë·ªÅ ho·∫∑c y√™u c·∫ßu gi·∫£ng vi√™n c·∫≠p nh·∫≠t n·ªôi dung ƒë·ªÅ c∆∞∆°ng.
              </p>
          </div>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/search/page.tsx">
"use client";

import React, { useState } from "react";
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  Search, 
  FileSearch, 
  Cpu, 
  Upload, 
  FileText, 
  Loader2,
  CheckCircle2,
  AlertTriangle,
  History
} from "lucide-react";
import axios from "@/lib/axios";
import { Badge } from "@/components/ui/badge";

export default function AdvancedSearchPage() {
  const [searchQuery, setSearchQuery] = useState("");
  const [searchResults, setSearchResults] = useState<any[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  
  const [isUploading, setIsUploading] = useState(false);
  const [ocrText, setOcrText] = useState("");
  const [isReindexing, setIsReindexing] = useState(false);

  const handleSearch = async () => {
    if (!searchQuery) return;
    setIsSearching(true);
    try {
      const res = await axios.get(`/search/syllabuses?q=${encodeURIComponent(searchQuery)}`);
      setSearchResults(res.data || []);
    } catch (e) {
      console.error(e);
    } finally { setIsSearching(false); }
  };

  const handleOCR = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setIsUploading(true);
    setOcrText("");
    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await axios.post("/search/ocr", formData, {
        headers: { "Content-Type": "multipart/form-data" }
      });
      setOcrText(res.data.text);
    } catch (e: any) {
      setOcrText("L·ªói: " + (e.response?.data?.message || e.message));
    } finally { setIsUploading(false); }
  };

  const handleReindex = async () => {
    setIsReindexing(true);
    try {
      await axios.post("/search/reindex");
      alert("ƒê√£ b·∫Øt ƒë·∫ßu l·∫≠p l·∫°i ch·ªâ m·ª•c th√†nh c√¥ng!");
    } catch (e) {
      alert("L·ªói reindex.");
    } finally { setIsReindexing(false); }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-3xl font-bold tracking-tight flex items-center gap-3">
             <Cpu className="w-8 h-8 text-indigo-600" /> C√¥ng ngh·ªá S·ªë h√≥a & T√¨m ki·∫øm AI
          </h2>
          <p className="text-muted-foreground">S·ª≠ d·ª•ng Tesseract OCR v√† Elasticsearch ƒë·ªÉ qu·∫£n l√Ω d·ªØ li·ªáu ƒë·ªÅ c∆∞∆°ng c≈©.</p>
        </div>
        <Button variant="outline" size="sm" onClick={handleReindex} disabled={isReindexing} className="gap-2 border-indigo-200 text-indigo-700 hover:bg-indigo-50">
          {isReindexing ? <Loader2 className="w-4 h-4 animate-spin" /> : <History className="w-4 h-4" />}
          L·∫≠p l·∫°i ch·ªâ m·ª•c (Reindex)
        </Button>
      </div>

      <Tabs defaultValue="search" className="w-full">
        <TabsList className="grid w-full grid-cols-2 mb-8 h-12">
          <TabsTrigger value="search" className="gap-2 text-lg"><Search className="w-5 h-5"/> T√¨m ki·∫øm th√¥ng minh (Elasticsearch)</TabsTrigger>
          <TabsTrigger value="ocr" className="gap-2 text-lg"><FileText className="w-5 h-5"/> S·ªë h√≥a t√†i li·ªáu c≈© (OCR)</TabsTrigger>
        </TabsList>

        <TabsContent value="search">
          <Card className="border-indigo-100 shadow-sm">
            <CardHeader className="pb-4">
               <div className="flex gap-2">
                 <Input 
                   placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm (V√≠ d·ª•: L·∫≠p tr√¨nh C#, C∆° s·ªü d·ªØ li·ªáu...)" 
                   className="h-12 text-lg" 
                   value={searchQuery}
                   onChange={(e) => setSearchQuery(e.target.value)}
                   onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                 />
                 <Button className="h-12 px-8 bg-indigo-600 hover:bg-indigo-700 gap-2" onClick={handleSearch} disabled={isSearching}>
                    {isSearching ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}
                    T√¨m ki·∫øm
                 </Button>
               </div>
            </CardHeader>
            <CardContent>
              {searchResults.length > 0 ? (
                <div className="space-y-4">
                  {searchResults.map((hit, idx) => (
                    <div key={idx} className="p-4 border rounded-lg hover:bg-slate-50 transition-colors border-slate-200">
                       <div className="flex justify-between items-start mb-2">
                         <h4 className="font-bold text-indigo-800 text-lg">
                           [{hit.source.subject_code}] {hit.source.subject_name_vi}
                         </h4>
                         <Badge variant="secondary">ƒê·ªô kh·ªõp: {(hit.score * 10).toFixed(1)}%</Badge>
                       </div>
                       <div className="text-sm text-slate-600 line-clamp-3 italic bg-white p-2 border-l-4 border-indigo-300 rounded">
                         ...{hit.highlight?.description || hit.source.description}...
                       </div>
                       <div className="mt-3 flex items-center gap-4 text-xs text-slate-400">
                          <span className="flex items-center gap-1"><CheckCircle2 className="w-3.5 h-3.5 text-green-500" /> Version: {hit.source.version}</span>
                          <span className="flex items-center gap-1"><FileSearch className="w-3.5 h-3.5 text-blue-500" /> Tr·∫°ng th√°i: {hit.source.status}</span>
                       </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-20 bg-slate-50 rounded-lg border-2 border-dashed border-slate-200">
                   <Search className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                   <p className="text-slate-500 font-medium">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm trong kho d·ªØ li·ªáu ƒë·ªÅ c∆∞∆°ng.</p>
                   <p className="text-xs text-slate-400 mt-1">H·ªá th·ªëng h·ªó tr·ª£ t√¨m ki·∫øm m·ªù (fuzzy) v√† ƒë√°nh tr·ªçng s·ªë theo m√£ m√¥n h·ªçc.</p>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="ocr">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             <Card>
               <CardHeader>
                 <CardTitle className="flex items-center gap-2"><Upload className="w-5 h-5 text-indigo-600" /> T·∫£i t√†i li·ªáu l√™n</CardTitle>
                 <CardDescription>H·ªó tr·ª£ file PDF, PNG, JPG t·ª´ c√°c ƒë·ªÅ c∆∞∆°ng c≈© b·∫£n c·ª©ng.</CardDescription>
               </CardHeader>
               <CardContent>
                 <div className="border-2 border-dashed border-indigo-200 rounded-xl p-10 text-center bg-indigo-50/30">
                    <input type="file" id="ocr-upload" hidden onChange={handleOCR} accept=".pdf,image/*" />
                    <label htmlFor="ocr-upload" className="cursor-pointer">
                       <div className="bg-white w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-indigo-100 group-hover:scale-110 transition-transform">
                          {isUploading ? <Loader2 className="w-8 h-8 animate-spin text-indigo-600" /> : <Upload className="w-8 h-8 text-indigo-600" />}
                       </div>
                       <p className="font-bold text-indigo-900">Click ƒë·ªÉ ch·ªçn file ho·∫∑c k√©o th·∫£</p>
                       <p className="text-xs text-indigo-600 mt-2">Dung l∆∞·ª£ng t·ªëi ƒëa 10MB</p>
                    </label>
                 </div>

                 <div className="mt-6 space-y-3">
                   <div className="flex items-start gap-2 text-xs text-amber-700 bg-amber-50 p-3 rounded-lg border border-amber-100">
                      <AlertTriangle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                      <div>
                        <strong>Ghi ch√∫:</strong> ƒê·ªô ch√≠nh x√°c c·ªßa OCR ph·ª• thu·ªôc v√†o ch·∫•t l∆∞·ª£ng ·∫£nh qu√©t.
                        H·ªá th·ªëng ∆∞u ti√™n h·ªó tr·ª£ ng√¥n ng·ªØ Vi·ªát/Anh.
                      </div>
                   </div>
                 </div>
               </CardContent>
             </Card>

             <Card className="flex flex-col">
               <CardHeader className="flex flex-row items-center justify-between space-y-0">
                 <div>
                   <CardTitle className="flex items-center gap-2"><FileText className="w-5 h-5 text-indigo-600" /> K·∫øt qu·∫£ tr√≠ch xu·∫•t</CardTitle>
                   <CardDescription>N·ªôi dung s·ªë ƒë∆∞·ª£c chuy·ªÉn ƒë·ªïi t·ª´ ·∫£nh qu√©t.</CardDescription>
                 </div>
                 {ocrText && <Button variant="ghost" size="sm" onClick={() => { navigator.clipboard.writeText(ocrText); alert("ƒê√£ copy!"); }}>Sao ch√©p</Button>}
               </CardHeader>
               <CardContent className="flex-1">
                 <div className="h-full min-h-[300px] w-full bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-auto max-h-[500px]">
                    {ocrText ? (
                      <pre className="whitespace-pre-wrap">{ocrText}</pre>
                    ) : (
                      <div className="h-full flex flex-col items-center justify-center text-slate-500 italic opacity-50">
                        <Loader2 className={`w-8 h-8 mb-2 ${isUploading ? 'animate-spin' : 'hidden'}`} />
                        {isUploading ? "ƒêang x·ª≠ l√Ω OCR..." : "K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y..."}
                      </div>
                    )}
                 </div>
               </CardContent>
             </Card>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/subjects/page.tsx">
"use client";

import React, { useEffect, useState, useCallback } from "react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { 
  Plus, 
  Search, 
  Edit2, 
  Trash2, 
  Loader2, 
  BookOpen,
  Link2,
  GitBranch,
  X
} from "lucide-react";
import { 
  Dialog, 
  DialogContent, 
  DialogHeader, 
  DialogTitle, 
  DialogFooter,
  DialogDescription
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import axios from "@/lib/axios";
import { useAuth } from "@/contexts/AuthContext";

interface Subject {
  id: number;
  code: string;
  nameVi: string;
  nameEn: string;
  credits: number;
  departmentId: number;
  department?: {
    name: string;
  };
}

interface Relationship {
  id: number;
  subjectId: number;
  relatedSubjectId: number;
  type: string;
  relatedSubject?: Subject;
}

export default function SubjectsPage() {
  const { role } = useAuth();
  const [subjects, setSubjects] = useState<Subject[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  
  // States for Subject Dialog
  const [dialogOpen, setDialogOpen] = useState(false);
  const [editingSubject, setEditingSubject] = useState<Subject | null>(null);
  const [formData, setFormData] = useState({
    code: "",
    nameVi: "",
    nameEn: "",
    credits: 0,
    departmentId: ""
  });
  const [departments, setDepartments] = useState<any[]>([]);
  const [submitting, setSubmitting] = useState(false);

  // States for Relationships
  const [relDialogOpen, setRelDialogOpen] = useState(false);
  const [targetSubject, setTargetSubject] = useState<Subject | null>(null);
  const [relationships, setRelationships] = useState<Relationship[]>([]);
  const [newRel, setNewRel] = useState({ relatedSubjectId: "", type: "PREREQUISITE" });

  const fetchData = useCallback(async () => {
    setLoading(true);
    try {
      const [subjectsRes, deptsRes] = await Promise.all([
        axios.get("/subjects"),
        axios.get("/departments")
      ]);
      setSubjects(subjectsRes.data || []);
      setDepartments(deptsRes.data || []);
    } catch (err) {
      console.error("Failed to fetch subjects:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  const filteredSubjects = subjects.filter(s => 
    s.nameVi.toLowerCase().includes(searchTerm.toLowerCase()) ||
    s.code.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleOpenDialog = (subject?: Subject) => {
    if (subject) {
      setEditingSubject(subject);
      setFormData({
        code: subject.code,
        nameVi: subject.nameVi,
        nameEn: subject.nameEn,
        credits: subject.credits,
        departmentId: String(subject.departmentId)
      });
    } else {
      setEditingSubject(null);
      setFormData({
        code: "",
        nameVi: "",
        nameEn: "",
        credits: 0,
        departmentId: ""
      });
    }
    setDialogOpen(true);
  };

  const handleSubmit = async () => {
    if (!formData.code || !formData.nameVi || !formData.departmentId) {
      alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc");
      return;
    }

    setSubmitting(true);
    try {
      if (editingSubject) {
        await axios.put(`/subjects/${editingSubject.id}`, formData);
      } else {
        await axios.post("/subjects", formData);
      }
      setDialogOpen(false);
      fetchData();
    } catch (err) {
      console.error(err);
    } finally {
      setSubmitting(false);
    }
  };

  const handleDelete = async (id: number) => {
    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªçc ph·∫ßn n√†y?")) return;
    try {
      await axios.delete(`/subjects/${id}`);
      fetchData();
    } catch (err: any) {
      alert(err.response?.data?.message || "L·ªói khi x√≥a h·ªçc ph·∫ßn");
    }
  };

  const openRelDialog = async (subject: Subject) => {
    setTargetSubject(subject);
    try {
      const res = await axios.get(`/subject-relationships/subject/${subject.id}`);
      setRelationships(res.data || []);
      setRelDialogOpen(true);
    } catch (err) {
      console.error(err);
    }
  };

  const handleAddRel = async () => {
    if (!newRel.relatedSubjectId || !targetSubject) return;
    try {
      await axios.post("/subject-relationships", {
        subjectId: targetSubject.id,
        relatedSubjectId: Number(newRel.relatedSubjectId),
        type: newRel.type
      });
      // Refresh
      const res = await axios.get(`/subject-relationships/subject/${targetSubject.id}`);
      setRelationships(res.data || []);
      setNewRel({ ...newRel, relatedSubjectId: "" });
    } catch (err: any) {
      alert(err.response?.data?.error || "L·ªói khi th√™m quan h·ªá");
    }
  };

  const handleRemoveRel = async (id: number) => {
    try {
      await axios.delete(`/subject-relationships/${id}`);
      const res = await axios.get(`/subject-relationships/subject/${targetSubject?.id}`);
      setRelationships(res.data || []);
    } catch (err) {
      console.error(err);
    }
  };

  const isAdmin = role === "Admin" || role === "Academic Affairs" || role === "AA";

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold tracking-tight">Qu·∫£n l√Ω H·ªçc ph·∫ßn (Subjects)</h1>
          <p className="text-sm text-muted-foreground">
            Qu·∫£n l√Ω danh m·ª•c h·ªçc ph·∫ßn v√† c√°c m·ªëi quan h·ªá ti√™n quy·∫øt/song h√†nh.
          </p>
        </div>
        {isAdmin && (
          <Button className="bg-teal-600 hover:bg-teal-700" onClick={() => handleOpenDialog()}>
            <Plus className="w-4 h-4 mr-2" /> Th√™m h·ªçc ph·∫ßn
          </Button>
        )}
      </div>

      <Card>
        <CardHeader className="pb-3">
          <div className="relative">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="T√¨m theo t√™n ho·∫∑c m√£ h·ªçc ph·∫ßn..."
              className="pl-8 max-w-sm"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
        </CardHeader>
        <CardContent>
          {loading ? (
            <div className="flex items-center justify-center h-64">
              <Loader2 className="h-8 w-8 animate-spin text-teal-600" />
            </div>
          ) : (
            <div className="border rounded-md">
              <Table>
                <TableHeader>
                  <TableRow className="bg-slate-50">
                    <TableHead className="w-24">M√£ HP</TableHead>
                    <TableHead>T√™n H·ªçc Ph·∫ßn</TableHead>
                    <TableHead>S·ªë TC</TableHead>
                    <TableHead>B·ªô m√¥n</TableHead>
                    <TableHead className="text-right">Thao t√°c</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredSubjects.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={5} className="text-center py-10 text-muted-foreground">
                        Kh√¥ng t√¨m th·∫•y h·ªçc ph·∫ßn n√†o.
                      </TableCell>
                    </TableRow>
                  ) : (
                    filteredSubjects.map((s) => (
                      <TableRow key={s.id} className="hover:bg-slate-50/50">
                        <TableCell className="font-mono font-bold text-teal-700">{s.code}</TableCell>
                        <TableCell>
                          <div>
                            <div className="font-semibold text-slate-900">{s.nameVi}</div>
                            <div className="text-xs text-slate-500 italic">{s.nameEn}</div>
                          </div>
                        </TableCell>
                        <TableCell>
                          <Badge variant="secondary">{s.credits} TC</Badge>
                        </TableCell>
                        <TableCell className="text-sm text-slate-600">
                          {s.department?.name || "N/A"}
                        </TableCell>
                        <TableCell className="text-right">
                          <div className="flex justify-end gap-2">
                            <Button 
                              variant="ghost" 
                              size="sm" 
                              className="text-blue-600 hover:bg-blue-50"
                              onClick={() => openRelDialog(s)}
                              title="Qu·∫£n l√Ω quan h·ªá (Ti√™n quy·∫øt/Song h√†nh)"
                            >
                              <GitBranch className="h-4 w-4" />
                            </Button>
                            {isAdmin && (
                              <>
                                <Button 
                                  variant="ghost" 
                                  size="sm" 
                                  className="text-teal-600 hover:bg-teal-50"
                                  onClick={() => handleOpenDialog(s)}
                                >
                                  <Edit2 className="h-4 w-4" />
                                </Button>
                                <Button 
                                  variant="ghost" 
                                  size="sm" 
                                  className="text-red-600 hover:bg-red-50"
                                  onClick={() => handleDelete(s.id)}
                                >
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              </>
                            )}
                          </div>
                        </TableCell>
                      </TableRow>
                    ))
                  )}
                </TableBody>
              </Table>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Subject Create/Edit Dialog */}
      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <DialogTitle>{editingSubject ? "Ch·ªânh s·ª≠a h·ªçc ph·∫ßn" : "Th√™m h·ªçc ph·∫ßn m·ªõi"}</DialogTitle>
            <DialogDescription>
              Nh·∫≠p c√°c th√¥ng tin c∆° b·∫£n cho h·ªçc ph·∫ßn trong h·ªá th·ªëng.
            </DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-4">
            <div className="grid grid-cols-4 items-center gap-4">
              <Label className="text-right">M√£ HP</Label>
              <Input 
                className="col-span-3" 
                value={formData.code} 
                onChange={(e) => setFormData({ ...formData, code: e.target.value })}
              />
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label className="text-right">T√™n (Vi)</Label>
              <Input 
                className="col-span-3" 
                value={formData.nameVi} 
                onChange={(e) => setFormData({ ...formData, nameVi: e.target.value })}
              />
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label className="text-right">T√™n (En)</Label>
              <Input 
                className="col-span-3" 
                value={formData.nameEn} 
                onChange={(e) => setFormData({ ...formData, nameEn: e.target.value })}
              />
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label className="text-right">S·ªë TC</Label>
              <Input 
                type="number"
                className="col-span-3" 
                value={formData.credits} 
                onChange={(e) => setFormData({ ...formData, credits: Number(e.target.value) })}
              />
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label className="text-right">B·ªô m√¥n</Label>
              <Select 
                value={formData.departmentId} 
                onValueChange={(val: string) => setFormData({ ...formData, departmentId: val })}
              >
                <SelectTrigger className="col-span-3">
                  <SelectValue placeholder="Ch·ªçn b·ªô m√¥n" />
                </SelectTrigger>
                <SelectContent>
                  {departments.map((d) => (
                    <SelectItem key={d.id} value={String(d.id)}>{d.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDialogOpen(false)}>H·ªßy</Button>
            <Button onClick={handleSubmit} disabled={submitting} className="bg-teal-600 hover:bg-teal-700 text-white">
              {submitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              L∆∞u thay ƒë·ªïi
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Relationships Dialog */}
      <Dialog open={relDialogOpen} onOpenChange={setRelDialogOpen}>
        <DialogContent className="sm:max-w-[600px]">
          <DialogHeader>
            <DialogTitle>M·ªëi quan h·ªá: {targetSubject?.nameVi}</DialogTitle>
            <DialogDescription>
              Thi·∫øt l·∫≠p c√°c h·ªçc ph·∫ßn ti√™n quy·∫øt (Prerequisite) ho·∫∑c h·ªçc tr∆∞·ªõc (Co-requisite).
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4 py-4">
            <div className="flex gap-2 items-end border p-3 rounded-md bg-slate-50">
              <div className="flex-1 space-y-1">
                <Label className="text-xs">H·ªçc ph·∫ßn li√™n quan</Label>
                <Select value={newRel.relatedSubjectId} onValueChange={(val: string) => setNewRel({...newRel, relatedSubjectId: val})}>
                  <SelectTrigger><SelectValue placeholder="Ch·ªçn m√¥n..." /></SelectTrigger>
                  <SelectContent>
                    {subjects.filter(s => s.id !== targetSubject?.id).map(s => (
                      <SelectItem key={s.id} value={String(s.id)}>{s.code} - {s.nameVi}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="w-32 space-y-1">
                <Label className="text-xs">Lo·∫°i quan h·ªá</Label>
                <Select value={newRel.type} onValueChange={(val: string) => setNewRel({...newRel, type: val})}>
                  <SelectTrigger><SelectValue /></SelectTrigger>
                  <SelectContent>
                    <SelectItem value="PREREQUISITE">Ti√™n quy·∫øt</SelectItem>
                    <SelectItem value="CO_REQUISITE">H·ªçc tr∆∞·ªõc</SelectItem>
                    <SelectItem value="EQUIVALENT">T∆∞∆°ng ƒë∆∞∆°ng</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <Button onClick={handleAddRel} className="bg-blue-600 text-white">Th√™m</Button>
            </div>

            <div className="border rounded-md max-h-[300px] overflow-y-auto">
              <Table>
                <TableHeader><TableRow><TableHead>M√£ HP</TableHead><TableHead>T√™n H·ªçc Ph·∫ßn</TableHead><TableHead>Lo·∫°i</TableHead><TableHead className="w-10"></TableHead></TableRow></TableHeader>
                <TableBody>
                  {relationships.length === 0 ? (
                    <TableRow><TableCell colSpan={4} className="text-center py-4 text-xs text-slate-400 italic">Ch∆∞a c√≥ quan h·ªá n√†o ƒë∆∞·ª£c khai b√°o.</TableCell></TableRow>
                  ) : (
                    relationships.map((r: any) => (
                      <TableRow key={r.id}>
                        <TableCell className="font-mono text-xs">{r.relatedSubject?.code}</TableCell>
                        <TableCell className="text-xs">{r.relatedSubject?.name_vi || r.relatedSubject?.nameVi}</TableCell>
                        <TableCell><Badge className="text-[10px] scale-90" variant="outline">{r.type}</Badge></TableCell>
                        <TableCell><Button variant="ghost" size="icon" className="h-6 w-6 text-red-400" onClick={() => handleRemoveRel(r.id)}><X className="h-3 w-3"/></Button></TableCell>
                      </TableRow>
                    ))
                  )}
                </TableBody>
              </Table>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/dashboard/page.tsx">
"use client";

import React, { useEffect, useState, useCallback } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "@/components/ui/table";
import { Edit, Eye, GitCompare, Loader2, RefreshCcw } from "lucide-react";
import SyllabusDeleteButton from "@/components/SyllabusDeleteButton"; 
import DashboardCharts from "@/components/DashboardCharts";
import axios from "@/lib/axios";

interface Syllabus {
  id: number;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  status: string;
  version: string;
  lecturer: string;
  dateEdited: string;
}

export default function Dashboard() {
  const router = useRouter();
  
  const [syllabuses, setSyllabuses] = useState<Syllabus[]>([]);
  const [total, setTotal] = useState(0);
  const [totalPages, setTotalPages] = useState(1);
  const [loading, setLoading] = useState(true);
  const [statsData, setStatsData] = useState(null);
  
  const [currentPage, setCurrentPage] = useState(1);
  const [searchTerm, setSearchTerm] = useState("");

  const fetchData = useCallback(async (page: number, keyword: string) => {
    setLoading(true);

    try {
      const query = new URLSearchParams({ page: page.toString(), limit: "10", search: keyword });
      const listRes = await axios.get(`/syllabuses?${query.toString()}`);
      const list = listRes.data;
      setSyllabuses(list.data || []);
      setTotal(list.total || 0);
      setTotalPages(list.totalPages || list.total_pages || 1);

      try {
        const statsRes = await axios.get(`/stats`);
        const stats = statsRes.data;
        setStatsData(stats);
      } catch (e) {
        // ignore stats error
      }

    } catch (err: any) {
      console.error(err);
      if (err?.response?.status === 401 || err?.status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("role");
        router.push("/login");
        return;
      }
    } finally { setLoading(false); }
  }, [router]);

  useEffect(() => {
    const timer = setTimeout(() => fetchData(currentPage, searchTerm), 500);
    return () => clearTimeout(timer);
  }, [searchTerm, currentPage, fetchData]);

  const renderStatusBadge = (status: string) => {
    let color = "bg-gray-500";
    let label = status;
    
    switch (status) {
        case "Approved": color = "bg-green-600"; break;
        case "Pending": color = "bg-yellow-500"; label = "Pending Review"; break;
        case "Pending Approval": color = "bg-orange-500"; label = "Pending AA"; break; 
        case "Returned": color = "bg-red-500"; break;
        case "Draft": color = "bg-slate-500"; break;
    }
    return <Badge className={color}>{label}</Badge>;
  };

  return (
    <div className="space-y-8">
      
      <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-2xl font-bold tracking-tight">Dashboard Overview</h2>
            <p className="text-sm text-muted-foreground">T·ªïng quan h·ªá th·ªëng th·ªùi gian th·ª±c</p>
          </div>
          <DashboardCharts data={statsData} />
      </section>

      <section className="space-y-4">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t pt-8">
            <div>
                <h3 className="text-xl font-bold tracking-tight">Qu·∫£n l√Ω ƒê·ªÅ c∆∞∆°ng</h3>
                <p className="text-sm text-muted-foreground">Danh s√°ch chi ti·∫øt c√°c h·ªçc ph·∫ßn</p>
            </div>
            <div className="w-full md:w-1/3 flex gap-2">
              <Input
                placeholder="T√¨m ki·∫øm theo t√™n ho·∫∑c m√£ HP..."
                value={searchTerm}
                onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                className="bg-white"
              />
              <Button variant="outline" size="icon" onClick={() => fetchData(currentPage, searchTerm)} title="L√†m m·ªõi">
                  <RefreshCcw className="w-4 h-4"/>
              </Button>
            </div>
          </div>

          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-[100px]">M√£ HP</TableHead>
                  <TableHead>T√™n H·ªçc Ph·∫ßn</TableHead>
                  <TableHead>Phi√™n b·∫£n</TableHead>
                  <TableHead>T√≠n ch·ªâ</TableHead>
                  <TableHead>Gi·∫£ng vi√™n</TableHead>
                  <TableHead>Tr·∫°ng th√°i</TableHead>
                  <TableHead className="text-right">H√†nh ƒë·ªông</TableHead> 
                </TableRow>
              </TableHeader>
              <TableBody>
                {loading && syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center">
                      <div className="flex justify-center items-center gap-2">
                        <Loader2 className="animate-spin w-4 h-4" /> ƒêang t·∫£i d·ªØ li·ªáu...
                      </div>
                    </TableCell>
                  </TableRow>
                ) : syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center text-muted-foreground">
                      Kh√¥ng t√¨m th·∫•y ƒë·ªÅ c∆∞∆°ng n√†o.
                    </TableCell>
                  </TableRow>
                ) : (
                  syllabuses.map((s) => (
                    <TableRow key={s.id}>
                      <TableCell className="font-bold">{s.subjectCode}</TableCell>
                      <TableCell>
                        <div className="font-medium">{s.subjectNameVi || "(Ch∆∞a c√≥ t√™n)"}</div>
                        <div className="text-xs text-muted-foreground truncate max-w-[200px]">{s.subjectNameEn}</div>
                      </TableCell>
                      <TableCell><Badge variant="outline" className="bg-slate-50">v{s.version || "1.0"}</Badge></TableCell>
                      <TableCell>{s.credits}</TableCell>
                      <TableCell className="text-sm text-gray-600">{s.lecturer}</TableCell>
                      <TableCell>{renderStatusBadge(s.status)}</TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2 items-center">
                            <Link href={`/syllabus/compare?baseId=${s.id - 1}&targetId=${s.id}`}>
                                <Button variant="outline" size="icon" title="So s√°nh v·ªõi phi√™n b·∫£n tr∆∞·ªõc"><GitCompare className="w-4 h-4 text-orange-600" /></Button>
                            </Link>
                            
                            {/* Always show Edit/View button, but change behavior based on status */}
                            <Link href={`/syllabus/${s.id}/edit`}>
                                <Button 
                                    variant="ghost" 
                                    size="icon" 
                                    title={
                                        (s.status === "Draft" || s.status === "Returned") 
                                        ? "Ch·ªânh s·ª≠a ƒë·ªÅ c∆∞∆°ng" 
                                        : "Xem ƒë·ªÅ c∆∞∆°ng (Ch·ªâ c√≥ th·ªÉ s·ª≠a Draft/Returned)"
                                    }
                                >
                                    {(s.status === "Draft" || s.status === "Returned") ? (
                                        <Edit className="w-4 h-4 text-teal-600" />
                                    ) : (
                                        <Eye className="w-4 h-4 text-gray-500" />
                                    )}
                                </Button>
                            </Link>
                            
                            {s.status === "Draft" && (
                                <div className="scale-90"><SyllabusDeleteButton id={s.id} /></div>
                            )}
                        </div>
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
            
            <div className="flex items-center justify-between px-4 py-4 border-t">
              <div className="text-sm text-muted-foreground">Trang {currentPage} / {totalPages}</div>
              <div className="flex gap-2">
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage <= 1}>Tr∆∞·ªõc</Button>
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage >= totalPages}>Sau</Button>
              </div>
            </div>
          </Card>
      </section>
    </div>
  );
}
</file>

<file path="apps/web/app/page.tsx">
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";

export default function RootPage() {
  const router = useRouter();

  useEffect(() => {
    const token = localStorage.getItem("access_token");
    if (token) {
      router.push("/dashboard");
    } else {
      router.push("/login");
    }
  }, [router]);

  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
    </div>
  );
}
</file>

<file path="apps/web/components/StudentActionButtons.tsx">
"use client";

import React, { useState } from "react";
import { Button } from "@/components/ui/button";
import { Bell, Flag, Sparkles, Loader2, CheckCircle2 } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import axios from "@/lib/axios";
import { useAuth } from "@/contexts/AuthContext";

interface StudentActionButtonsProps {
  syllabusId: number;
  subjectId: number;
  subjectCode: string;
}

export default function StudentActionButtons({ syllabusId, subjectId, subjectCode }: StudentActionButtonsProps) {
  const { role } = useAuth();
  const [showReportDialog, setShowReportDialog] = useState(false);
  const [reportContent, setReportContent] = useState("");
  const [loading, setLoading] = useState<string | null>(null);
  const [aiSummary, setAiSummary] = useState<string | null>(null);
  const [subscribed, setSubscribed] = useState(false);

  const isStudent = role === "Student" || role === "Admin";

  const handleSubscribe = async () => {
    if (!isStudent) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p v·ªõi vai tr√≤ Sinh vi√™n ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.");
    setLoading("sub");
    try {
      // Gi·∫£ s·ª≠ API l·∫•y student_id t·ª´ token ho·∫∑c g.user_id ·ªü backend
      // ·ªû ƒë√¢y controller ƒëang y√™u c·∫ßu student_id trong body, c·∫ßn check l·∫°i backend
      await axios.post("/student/subscribe", { subject_id: subjectId });
      setSubscribed(true);
      alert("‚úÖ ƒêƒÉng k√Ω theo d√µi m√¥n h·ªçc th√†nh c√¥ng!");
    } catch (err) {
      console.error(err);
      alert("‚ùå C√≥ l·ªói x·∫£y ra khi ƒëƒÉng k√Ω theo d√µi.");
    } finally { setLoading(null); }
  };

  const handleReport = async () => {
    if (!reportContent.trim()) return;
    setLoading("report");
    try {
      await axios.post("/student/report", { syllabus_id: syllabusId, content: reportContent });
      alert("‚úÖ C·∫£m ∆°n b·∫°n ƒë√£ ph·∫£n h·ªìi! Ch√∫ng t√¥i s·∫Ω ki·ªÉm tra s·ªõm nh·∫•t.");
      setShowReportDialog(false);
      setReportContent("");
    } catch (err) {
      console.error(err);
      alert("‚ùå L·ªói khi g·ª≠i ph·∫£n h·ªìi.");
    } finally { setLoading(null); }
  };

  const handleAiSummary = async () => {
    setLoading("ai");
    try {
        // G·ªçi AI Summary - C·∫ßn tri·ªÉn khai endpoint n√†y ·ªü backend
        const res = await axios.post(`/ai/summary`, { syllabus_id: syllabusId });
        setAiSummary(res.data.summary);
    } catch (err) {
        console.error(err);
        setAiSummary("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o t√≥m t·∫Øt AI. Vui l√≤ng th·ª≠ l·∫°i sau.");
    } finally { setLoading(null); }
  };

  return (
    <div className="flex flex-col gap-4">
      <div className="flex flex-wrap gap-2">
        <Button 
          variant={subscribed ? "secondary" : "outline"} 
          className={`flex-1 gap-2 ${subscribed ? "text-green-600 bg-green-50" : "text-teal-600 border-teal-200"}`}
          onClick={handleSubscribe}
          disabled={loading === "sub"}
        >
          {loading === "sub" ? <Loader2 className="w-4 h-4 animate-spin" /> : subscribed ? <CheckCircle2 className="w-4 h-4" /> : <Bell className="w-4 h-4" />}
          {subscribed ? "ƒêang theo d√µi" : "Theo d√µi m√¥n n√†y"}
        </Button>

        <Button 
          variant="outline" 
          className="flex-1 gap-2 text-rose-600 border-rose-200 hover:bg-rose-50"
          onClick={() => isStudent ? setShowReportDialog(true) : alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i ph·∫£n h·ªìi.")}
        >
          <Flag className="w-4 h-4" /> B√°o l·ªói/Ph·∫£n h·ªìi
        </Button>

        <Button 
          className="flex-1 gap-2 bg-gradient-to-r from-teal-600 to-blue-600 hover:from-teal-700 hover:to-blue-700 text-white shadow-md shadow-teal-100"
          onClick={handleAiSummary}
          disabled={loading === "ai"}
        >
          {loading === "ai" ? <Loader2 className="w-4 h-4 animate-spin" /> : <Sparkles className="w-4 h-4" />}
          T√≥m t·∫Øt AI
        </Button>
      </div>

      {aiSummary && (
        <div className="bg-teal-50 border border-teal-100 rounded-lg p-4 animate-in fade-in slide-in-from-top-2">
            <h4 className="font-bold text-teal-800 mb-2 flex items-center gap-2">
                <Sparkles className="w-4 h-4" /> T√≥m t·∫Øt AI (S∆° l∆∞·ª£c m√¥n h·ªçc)
            </h4>
            <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-line">{aiSummary}</p>
        </div>
      )}

      <Dialog open={showReportDialog} onOpenChange={setShowReportDialog}>
        <DialogContent>
            <DialogHeader>
                <DialogTitle>G·ª≠i ph·∫£n h·ªìi v·ªÅ ƒë·ªÅ c∆∞∆°ng</DialogTitle>
                <DialogDescription>Gi√∫p ch√∫ng t√¥i c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng d·ªØ li·ªáu. H√£y m√¥ t·∫£ l·ªói b·∫°n ph√°t hi·ªán (M√£ m√¥n: {subjectCode})</DialogDescription>
            </DialogHeader>
            <Textarea 
                placeholder="Nh·∫≠p n·ªôi dung ph·∫£n h·ªìi c·ªßa b·∫°n..." 
                className="min-h-[120px]"
                value={reportContent}
                onChange={(e) => setReportContent(e.target.value)}
            />
            <DialogFooter>
                <Button variant="outline" onClick={() => setShowReportDialog(false)}>H·ªßy</Button>
                <Button 
                    variant="destructive" 
                    onClick={handleReport}
                    disabled={loading === "report" || !reportContent.trim()}
                >
                    {loading === "report" && <Loader2 className="w-4 h-4 animate-spin mr-2" />}
                    G·ª≠i ph·∫£n h·ªìi
                </Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="apps/web/components/SyllabusHistory.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { 
    Sheet, 
    SheetContent, 
    SheetHeader, 
    SheetTitle, 
    SheetTrigger,
    SheetDescription
} from "@/components/ui/sheet";
import { Button } from "@/components/ui/button";
import { History, Diff, Loader2, Calendar, User, ChevronRight, CheckCircle2, AlertCircle } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface SnapshotItem {
    id: number;
    version: string;
    created_at: string;
    created_by: string;
}

interface DiffAnalysis {
    summary: string;
    detailed_analysis: {
        category: string;
        change_type: string;
        description: string;
    }[];
    impact_assessment: string;
    is_significant_change: boolean;
}

export default function SyllabusHistory({ syllabusId }: { syllabusId: number }) {
    const [history, setHistory] = useState<SnapshotItem[]>([]);
    const [loading, setLoading] = useState(false);
    const [comparing, setComparing] = useState(false);
    const [diffResult, setDiffResult] = useState<DiffAnalysis | null>(null);
    const [selectedId, setSelectedId] = useState<number | null>(null);

    const fetchHistory = async () => {
        setLoading(true);
        try {
            const res = await axios.get(`/syllabuses/${syllabusId}/history`);
            setHistory(res.data);
        } catch (err) {
            console.error("Failed to fetch history:", err);
        } finally {
            setLoading(false);
        }
    };

    const compareWithCurrent = async (snapshotId: number) => {
        setComparing(true);
        setDiffResult(null);
        setSelectedId(snapshotId);
        try {
            const res = await axios.get(`/syllabuses/compare-versions`, {
                params: {
                    s1: snapshotId,
                    s2: 'current',
                    syllabus_id: syllabusId
                }
            });
            setDiffResult(res.data);
        } catch (err) {
            console.error("Comparison failed:", err);
            alert("L·ªói khi so s√°nh phi√™n b·∫£n");
        } finally {
            setComparing(false);
        }
    };

    return (
        <Sheet>
            <SheetTrigger asChild>
                <Button variant="outline" size="sm" onClick={fetchHistory}>
                    <History className="w-4 h-4 mr-2" /> L·ªãch s·ª≠ & So s√°nh
                </Button>
            </SheetTrigger>
            <SheetContent className="w-[400px] sm:w-[540px] md:w-[650px]">
                <SheetHeader>
                    <SheetTitle className="flex items-center gap-2">
                        <History className="w-5 h-5 text-blue-600" />
                        L·ªãch s·ª≠ phi√™n b·∫£n ƒë·ªÅ c∆∞∆°ng
                    </SheetTitle>
                    <SheetDescription>
                        Xem l·∫°i c√°c b·∫£n copy b·∫•t bi·∫øn (Snapshot) v√† so s√°nh s·ª± thay ƒë·ªïi b·∫±ng AI.
                    </SheetDescription>
                </SheetHeader>

                <div className="grid grid-cols-2 gap-4 mt-6 h-[calc(100vh-150px)]">
                    {/* Left side: History list */}
                    <div className="border-r pr-4">
                        <h4 className="font-bold text-sm mb-4 uppercase text-slate-500">Danh s√°ch Snapshots</h4>
                        {loading ? (
                            <div className="flex justify-center p-8"><Loader2 className="animate-spin text-blue-600" /></div>
                        ) : history.length === 0 ? (
                            <div className="text-center p-8 text-slate-400 italic text-sm">Ch∆∞a c√≥ b·∫£n l∆∞u l·ªãch s·ª≠ n√†o.</div>
                        ) : (
                            <div className="h-full overflow-y-auto pr-2 custom-scrollbar">
                                <div className="space-y-3">
                                    {history.map((s) => (
                                        <div 
                                            key={s.id} 
                                            className={`p-3 border rounded-lg cursor-pointer transition-colors ${selectedId === s.id ? 'bg-blue-50 border-blue-200' : 'hover:bg-slate-50'}`}
                                            onClick={() => compareWithCurrent(s.id)}
                                        >
                                            <div className="flex justify-between items-start mb-1">
                                                <Badge variant="outline">v{s.version}</Badge>
                                                <div className="text-[10px] text-slate-400 flex items-center gap-1">
                                                    <Calendar className="w-3 h-3" /> {new Date(s.created_at).toLocaleDateString()}
                                                </div>
                                            </div>
                                            <div className="text-xs text-slate-600 flex items-center gap-1 mt-2">
                                                <User className="w-3 h-3" /> {s.created_by}
                                            </div>
                                            <div className="mt-2 text-[11px] text-blue-600 font-medium flex items-center gap-1">
                                                So s√°nh v·ªõi hi·ªán t·∫°i <ChevronRight className="w-3 h-3" />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Right side: Diff result */}
                    <div className="pl-2 overflow-y-auto">
                        <h4 className="font-bold text-sm mb-4 uppercase text-slate-500">So s√°nh (AI Analysis)</h4>
                        {comparing ? (
                            <div className="flex flex-col items-center justify-center h-48 gap-3">
                                <Loader2 className="animate-spin text-blue-600" />
                                <span className="text-xs text-slate-400 animate-pulse">AI ƒëang ph√¢n t√≠ch s·ª± thay ƒë·ªïi...</span>
                            </div>
                        ) : diffResult ? (
                            <div className="space-y-4">
                                <div className="bg-slate-100 p-3 rounded-lg text-sm border-l-4 border-blue-500 italic">
                                    "{diffResult.summary}"
                                </div>

                                {diffResult.is_significant_change && (
                                    <Badge className="bg-amber-100 text-amber-700 hover:bg-amber-100 border-amber-200 gap-1">
                                        <AlertCircle className="w-3 h-3" /> Thay ƒë·ªïi ƒë√°ng k·ªÉ
                                    </Badge>
                                )}

                                <div className="space-y-3">
                                    {diffResult.detailed_analysis.map((item, i) => (
                                        <div key={i} className="p-3 border rounded-md bg-white shadow-sm">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="font-bold text-xs text-slate-800">{item.category}</span>
                                                <Badge variant={
                                                    item.change_type === 'Added' ? 'default' : 
                                                    item.change_type === 'Removed' ? 'destructive' : 
                                                    item.change_type === 'Modified' ? 'secondary' : 'outline'
                                                } className="text-[9px] px-1 h-4">
                                                    {item.change_type}
                                                </Badge>
                                            </div>
                                            <p className="text-[11px] text-slate-600 leading-relaxed">{item.description}</p>
                                        </div>
                                    ))}
                                </div>

                                <div className="p-3 bg-blue-50 rounded-lg border border-blue-100">
                                    <h5 className="text-xs font-bold text-blue-800 flex items-center gap-1 mb-1">
                                        <CheckCircle2 className="w-3 h-3" /> ƒê√°nh gi√° t√°c ƒë·ªông:
                                    </h5>
                                    <p className="text-xs text-blue-700 leading-relaxed">{diffResult.impact_assessment}</p>
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-64 text-slate-300 gap-2">
                                <Diff className="w-12 h-12 opacity-20" />
                                <span className="text-xs italic">Ch·ªçn m·ªôt phi√™n b·∫£n ƒë·ªÉ so s√°nh</span>
                            </div>
                        )}
                    </div>
                </div>
            </SheetContent>
        </Sheet>
    );
}
</file>

<file path="apps/web/components/ui/label.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
</file>

<file path="apps/web/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-content-available-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}
</file>

<file path="apps/web/components/ui/separator.tsx">
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }
</file>

<file path="apps/web/components/VisualSubjectTree.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ArrowDown, ArrowUp, Link2, Loader2, BookOpen } from "lucide-react";

interface TreeNode {
  relatedSubjectId?: number;
  subjectId?: number;
  relatedSubjectCode?: string;
  subjectCode?: string;
  relatedSubjectName?: string;
  subjectName?: string;
  type: string;
}

export default function VisualSubjectTree({ subjectId, currentSubjectName }: { subjectId: number, currentSubjectName: string }) {
  const [data, setData] = useState<{ prerequisites: TreeNode[], successors: TreeNode[] } | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchTree = async () => {
      try {
        const res = await axios.get(`/subject-relationships/tree/${subjectId}`);
        setData(res.data);
      } catch (err) {
        console.error("Error fetching subject tree:", err);
      } finally {
        setLoading(false);
      }
    };
    fetchTree();
  }, [subjectId]);

  if (loading) return <div className="flex justify-center p-8"><Loader2 className="animate-spin text-teal-600" /></div>;
  if (!data || (data.prerequisites.length === 0 && data.successors.length === 0)) {
    return (
        <div className="text-center p-8 text-slate-400 italic bg-slate-50 rounded-xl border border-dashed">
            M√¥n h·ªçc n√†y kh√¥ng c√≥ h·ªçc ph·∫ßn li√™n quan (ti√™n quy·∫øt/song h√†nh) ƒë∆∞·ª£c khai b√°o.
        </div>
    );
  }

  return (
    <div className="space-y-4 py-4">
      <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
        <Link2 className="w-5 h-5 text-teal-600" /> B·∫£n ƒë·ªì m√¥n h·ªçc (Subject Pathway)
      </h3>

      <div className="flex flex-col items-center gap-6">
        {/* Prerequisites */}
        {data.prerequisites.length > 0 && (
          <div className="w-full">
            <div className="flex flex-wrap justify-center gap-3">
              {data.prerequisites.map((item, i) => (
                <div key={i} className="flex flex-col items-center">
                    <Card className="bg-amber-50 border-amber-200 min-w-[150px] shadow-sm">
                        <CardContent className="p-3 text-center">
                            <div className="text-[10px] font-bold text-amber-600 uppercase mb-1">{item.type}</div>
                            <div className="font-bold text-sm">{item.relatedSubjectCode}</div>
                            <div className="text-[11px] text-slate-600 line-clamp-1">{item.relatedSubjectName}</div>
                        </CardContent>
                    </Card>
                    <ArrowDown className="text-amber-400 w-4 h-4 mt-2" />
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Current Subject */}
        <div className="relative">
            <Card className="bg-teal-600 text-white border-teal-700 w-[220px] shadow-lg ring-4 ring-teal-100">
                <CardContent className="p-4 text-center">
                    <BookOpen className="w-6 h-6 mx-auto mb-2 opacity-80" />
                    <div className="font-bold">{currentSubjectName}</div>
                    <div className="text-xs opacity-80 mt-1">(ƒêang xem)</div>
                </CardContent>
            </Card>
        </div>

        {/* Successors */}
        {data.successors.length > 0 && (
          <div className="w-full">
            <div className="flex flex-wrap justify-center gap-3">
              {data.successors.map((item, i) => (
                <div key={i} className="flex flex-col items-center">
                    <ArrowDown className="text-blue-400 w-4 h-4 mb-2" />
                    <Card className="bg-blue-50 border-blue-200 min-w-[150px] shadow-sm">
                        <CardContent className="p-3 text-center">
                            <div className="text-[10px] font-bold text-blue-600 uppercase mb-1">M√îN TI·∫æP THEO</div>
                            <div className="font-bold text-sm">{item.subjectCode}</div>
                            <div className="text-[11px] text-slate-600 line-clamp-1">{item.subjectName}</div>
                        </CardContent>
                    </Card>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="apps/web/contexts/AuthContext.tsx">
"use client";

import { createContext, useContext, useState, useEffect, ReactNode } from "react";
import { useRouter } from "next/navigation";

interface AuthContextType {
  userId: string | null;
  role: string | null;
  isLoading: boolean;
  setRole: (role: string) => void;
  setUserId: (id: string) => void;
  logout: () => void;
}

const AuthContext = createContext<AuthContextType>({
  userId: null,
  role: null,
  isLoading: true,
  setRole: () => {},
  setUserId: () => {},
  logout: () => {},
});

export function AuthProvider({ children }: { children: ReactNode }) {
  const [role, setRoleState] = useState<string | null>(null);
  const [userId, setUserIdState] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();

  useEffect(() => {
    // Load from localStorage on mount
    const storedRole = localStorage.getItem("role");
    const storedUserId = localStorage.getItem("user_id");
    setRoleState(storedRole);
    setUserIdState(storedUserId);
    setIsLoading(false);
  }, []);

  const setRole = (newRole: string) => {
    localStorage.setItem("role", newRole);
    setRoleState(newRole);
  };

  const setUserId = (id: string) => {
    localStorage.setItem("user_id", id);
    setUserIdState(id);
  };

  const logout = () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    localStorage.removeItem("role");
    localStorage.removeItem("user_id");
    localStorage.removeItem("full_name");
    localStorage.removeItem("username");
    setRoleState(null);
    setUserIdState(null);
    router.push("/login");
  };

  return (
    <AuthContext.Provider value={{ userId, role, isLoading, setRole, setUserId, logout }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);
</file>

<file path="apps/web/contexts/NotificationContext.tsx">
"use client";

import React, { createContext, useContext, useEffect, useState, useCallback } from "react";
import { io, Socket } from "socket.io-client";
import { useAuth } from "./AuthContext";
import axios from "@/lib/axios";

interface Notification {
  id: string | number;
  title: string;
  message: string;
  type?: "info" | "success" | "warning" | "error";
  is_read: boolean;
  created_at: string;
  link?: string;
}

interface NotificationContextType {
  notifications: Notification[];
  unreadCount: number;
  markAsRead: (id: string | number) => Promise<void>;
  clearAll: () => void;
  refresh: () => Promise<void>;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export function NotificationProvider({ children }: { children: React.ReactNode }) {
  const { userId, role } = useAuth();
  const [socket, setSocket] = useState<Socket | null>(null);
  const [notifications, setNotifications] = useState<Notification[]>([]);

  const fetchNotifications = useCallback(async () => {
    if (!userId) return;
    try {
      const res = await axios.get("/notifications");
      setNotifications(Array.isArray(res.data) ? res.data : []);
    } catch (e) {
      console.error("Failed to fetch notifications:", e);
    }
  }, [userId]);

  const refresh = useCallback(async () => {
    await fetchNotifications();
  }, [fetchNotifications]);

  useEffect(() => {
    if (!userId) return;

    fetchNotifications();

    const newSocket = io(process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000", {
        transports: ["websocket"],
        query: { userId: userId }
    });

    newSocket.on("connect", () => {
      console.log("[Socket] Connected to server");
      newSocket.emit("join", { room: `user_${userId}` });
    });

    // Listen for syllabus evaluation (for Lecturers)
    newSocket.on("syllabus_evaluated", (data: any) => {
      refresh(); // Reload from DB to get the official record
      
      // Also show a browser notification
      if ("Notification" in window && window.Notification.permission === "granted") {
        new window.Notification(
            data.action === "APPROVE" ? "ƒê·ªÅ c∆∞∆°ng ƒë∆∞·ª£c duy·ªát" : "Y√™u c·∫ßu ch·ªânh s·ª≠a",
            { body: `M√¥n ${data.subject_code} ƒë√£ ƒë∆∞·ª£c ${data.action === "APPROVE" ? "duy·ªát" : "tr·∫£ l·∫°i"}.` }
        );
      }
    });

    // Listen for new submissions (for HoDs, AA, etc.)
    newSocket.on("syllabus_submitted", (data: any) => {
      const relevantRoles = ["Head of Dept", "HoD", "Academic Affairs", "AA", "Admin"];
      if (relevantRoles.includes(role || "")) {
        refresh();
      }
    });

    setSocket(newSocket);

    return () => {
      newSocket.close();
    };
  }, [userId, role, fetchNotifications, refresh]);

  const markAsRead = async (id: string | number) => {
    try {
      await axios.put(`/notifications/${id}/read`);
      setNotifications(prev => prev.map(n => n.id === id ? { ...n, is_read: true } : n));
    } catch (e) {
      console.error("Failed to mark notification as read:", e);
    }
  };

  const clearAll = () => {
    setNotifications([]);
  };

  const unreadCount = notifications.filter(n => !n.is_read).length;

  return (
    <NotificationContext.Provider value={{ 
        notifications, 
        unreadCount, 
        markAsRead, 
        clearAll,
        refresh
    }}>
      {children}
    </NotificationContext.Provider>
  );
}

export function useNotifications() {
  const context = useContext(NotificationContext);
  if (context === undefined) {
    throw new Error("useNotifications must be used within a NotificationProvider");
  }
  return context;
}
</file>

<file path="docker-compose.yml">
version: '3.8'

services:
  # Database - PostgreSQL (used in the project instead of MS SQL based on sh scripts)
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-smd_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Redis for Caching and Celery
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"

  # Backend API
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    environment:
      DATABASE_URI: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@db:5432/${POSTGRES_DB:-smd_db}
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    ports:
      - "5000:5000"
    depends_on:
      - db
      - redis

  # Celery Worker
  worker:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    command: celery -A make_celery.celery_app worker --loglevel=info
    environment:
      DATABASE_URI: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@db:5432/${POSTGRES_DB:-smd_db}
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    depends_on:
      - db
      - redis

  # Frontend Web
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:5000
    ports:
      - "3000:3000"
    depends_on:
      - api

volumes:
  postgres_data:
</file>

<file path="TODO.md">
# TODO LIST - SDM Project (Syllabus Design & Management)

## 1. H·ªá th·ªëng l√µi (Core System)
- [x] ƒê·∫£m b·∫£o t√≠nh nh·∫•t qu√°n d·ªØ li·ªáu Assessment Scheme (T·ªïng tr·ªçng s·ªë 100%).
- [x] S·ª≠a l·ªói ki·ªÉu d·ªØ li·ªáu BigInteger cho Foreign Keys tr√™n SQL Server.
- [x] C·∫≠p nh·∫≠t script seeding h·ªó tr·ª£ ƒë·∫ßy ƒë·ªß c√°c th·ª±c th·ªÉ m·ªõi (Snapshots, Workflow logs, Assessments).
- [x] Kh·∫Øc ph·ª•c l·ªói l∆∞u tr·ªØ l·ªìng nhau cho PLO Mapping v√† CLO References.

## 2. Th√¥ng b√°o & T∆∞∆°ng t√°c (Notifications & Interaction)
- [x] T√≠ch h·ª£p Flask-Mail g·ª≠i th√¥ng b√°o qua Email khi c√≥ s·ª± ki·ªán quan tr·ªçng.
- [x] T√≠ch h·ª£p real-time notifications qua WebSockets (Flask-SocketIO).
- [x] X√¢y d·ª±ng h·ªá th·ªëng Template th√¥ng b√°o linh ho·∫°t (Notification Templates).

## 3. Qu·∫£n l√Ω phi√™n b·∫£n & Audit Trail (Version Control & Audit)
- [x] Tri·ªÉn khai Syllabus Snapshots (l∆∞u tr·ªØ b·∫£n ghi b·∫•t bi·∫øn sau khi ph√™ duy·ªát).
- [x] Ghi ch√©p l·ªãch s·ª≠ Workflow chi ti·∫øt (Workflow Logs).
- [x] X√¢y d·ª±ng API So s√°nh phi√™n b·∫£n (Version Comparison/Diff API).
- [x] Giao di·ªán Front-end: Xem l·∫°i c√°c phi√™n b·∫£n l·ªãch s·ª≠ (History View).
- [x] Giao di·ªán Front-end: So s√°nh hai phi√™n b·∫£n ƒë·ªÅ c∆∞∆°ng (Diff View - AI Powered).

## 4. Tr√≠ tu·ªá nh√¢n t·∫°o (AI Integration)
- [x] Ph√¢n t√≠ch s·ª± ph√π h·ª£p CLO - PLO b·∫±ng Gemini AI.
- [x] G·ª£i √Ω ma tr·∫≠n ƒë√°nh gi√° (Assessment Schemes) t·ª´ CLO.
- [x] C·∫≠p nh·∫≠t AI Service h·ªó tr·ª£ SDK m·ªõi nh·∫•t v√† Model Gemini 3 Flash.
- [x] Tri·ªÉn khai x·ª≠ l√Ω h·∫≠u tr∆∞·ªùng (Background Tasks) b·∫±ng Celery cho c√°c t√°c v·ª• AI n·∫∑ng.
- [ ] T·ªëi ∆∞u h√≥a m√¥ h√¨nh nh√∫ng (Embedding) ƒë·ªÉ t√¨m ki·∫øm ƒë·ªÅ c∆∞∆°ng t∆∞∆°ng t·ª±.

## 5. Quy tr√¨nh & Ph√™ duy·ªát (Workflow & Approval)
- [x] Ho√†n thi·ªán Logic chuy·ªÉn tr·∫°ng th√°i Workflow (Draft -> Pending -> Approved/Returned).
- [x] Qu·∫£n l√Ω th·ªùi h·∫°n ph√™ duy·ªát (Review Deadlines) v√† Banner c·∫£nh b√°o.
- [x] T·ª± ƒë·ªông h√≥a ki·ªÉm tra deadline h√†ng ng√†y (Script check_deadlines.py).
- [x] Nh·∫Øc nh·ªü qua Email cho c√°c task s·∫Øp ƒë·∫øn h·∫°n.

## 6. Front-end (UI/UX)
- [x] Hi·ªÉn th·ªã Banner tr·∫°ng th√°i v√† Deadline tr√™n giao di·ªán chi ti·∫øt.
- [x] Dashboard cho Admin: T√≠ch h·ª£p KPIs (Th·ªùi gian duy·ªát TB, t·ª∑ l·ªá ho√†n th√†nh).
- [x] C√¢y quan h·ªá h·ªçc ph·∫ßn tr·ª±c quan (Subject Relationship Tree).
- [x] Form nh·∫≠p li·ªáu ƒë·ªông cho Assessment Components.

## 8. D·ªØ li·ªáu & T√¨m ki·∫øm (Data & Search)
- [x] B√°o c√°o Ph√¢n t√≠ch T√°c ƒë·ªông (Impact Analysis) cho Hi·ªáu tr∆∞·ªüng.
- [x] T√≠ch h·ª£p Elasticsearch cho t√¨m ki·∫øm ƒë·ªÅ c∆∞∆°ng (Subject Code/Name).
- [x] X√¢y d·ª±ng Module OCR ƒë·ªÉ s·ªë h√≥a d·ªØ li·ªáu t·ª´ PDF/Word c≈©.

## 7. Kh√°c (Others)
- [ ] Tri·ªÉn khai Unit Tests cho Service layer.
- [x] X√¢y d·ª±ng t√†i li·ªáu API (Swagger/OpenAPI) c∆° b·∫£n cho c√°c endpoint ch√≠nh.
- [x] Dockerize to√†n b·ªô h·ªá th·ªëng (Web + API + DB + Redis + Celery).
</file>

<file path="YEUCAU.md">
Context:
‚óã Syllabus Management and Digitalization System of the University (SMD) project was developed to address the current challenges in managing textbooks across university courses and programs.
‚óã In traditional textbook management, universities often face problems such as decentralized textbook file storage (PDF/Word), inconsistent formatting, difficulty tracking version updates, and lack of transparent workflows for review and approval. Students and lecturers also face difficulties in accessing, comparing, or analyzing textbooks effectively across courses and academic years.
‚óã To overcome these challenges, the SMD system integrates a web platform that centralizes version control and workflow management. A key innovation of the project is the automated textbook management features, including AI-powered change detection, CLO‚ÄìPLO mapping, and content summarization. These tools help standardize course content, track changes over time, and facilitate easy comparison between versions and courses.
‚óã The project aims to improve efficiency, accuracy, and transparency in course management, providing instructors, departments, and students with a streamlined system for accessing, reviewing, and analyzing course content, while supporting future expansion and potential integration with learning management systems.


‚óè Proposed Solutions: The project ‚ÄúSyllabus Management and Digitization System (SMD)‚Äù aims to build a centralized platform to serve the management, lookup and analysis of syllabus for faculties, lecturers and students in the university. Currently, syllabuses are stored separately in PDF/Word files in many different sources, difficult to update and lack system connectivity. SMD aims to:
o Centralized Syllabus Digitization and Management: Allowing lecturers and departments to enter, edit and standardize syllabus content on a unified Web App. The system supports attaching standard metadata such as CLO (Input Standards), PLO (Output Standards), assessment weights, prerequisite knowledge, teaching content and learning materials. In addition, syllabuses can establish relationships with each other such as: ‚Äúreplace‚Äù, ‚Äúupdate‚Äù, ‚Äúnew version‚Äù, supporting scientific management by school year.
o Flexible review workflow: Provides a syllabus review process in the following steps: Draft ‚Üí Pending Review‚Üí Pending Approval ‚Üí Approved ‚Üí Published, with the Reviewer/Approver role ensuring the quality of academic content and clear version history. The system stores the entire edit history to help the auditing or accreditation department easily look up.

3 Syllabus Management View, search, filter, and compare syllabus versions; access CLO‚ÄìPLO mapping and module relationship tree; follow syllabus to receive update notifications.
4 Collaborative Review syllabus during the collaboration period, add comments, edit or delete your feedback, and report detected errors quickly.
5 Notification Receive real-time alerts about syllabus submissions, review deadlines, feedback, or rejection from higher authorities.authorities (for prompt action).



Student

No. Function Description
1 Search Search syllabus by Subject Name, Subject Code or Filter by Major/Semester.
2 View Detail View the entire syllabus content. Supports visual tools: AI Summary, Subject Tree (Which subject is studied first/last), and Output Standard Map.
3 Subscribe Click the "Follow" button to receive emails/notifications when the syllabus changes.
4 Feedback Send a quick report if you detect errors in the syllabus content.





Head of Department - HoD

No. Function Description
1 Syllabus
Review/ Approval Official Level 1 Approval. Verifies academic content, CLOs, and Syllabus compliance. Uses AI Change Detection for quick revision tracking. Decides to Approve (forward to Academic Affairs) or Reject/Require Edit (return to Lecturer with mandatory reason).
2 Collaborative
Review Management Manages the collaborative consultation among Department Lecturers. Monitor feedback within the set timeframe. Compiles input, finalizes the draft, and officially moves the Syllabus into the HOD's review pipeline.
3 Lookup &
Analysis Searches, filters, and looks up all Syllabus within the Department. Includes the Syllabus Version Comparison feature across years/courses to ensure consistency.
4 Notification Receives real-time notifications for critical events: Syllabus submission, end of Collaborative Review period, or Syllabus rejection by higher authorities (for prompt action).


Academic Affairs - AA

No. Function Description
1 Academic Approval Level 2 Official Approval. Verifies Syllabus alignment with Program Learning Outcomes (PLO Mapping) and overall institutional standards (Credit, Rubrics). Decides to Approve (send to Final Approver/Publish) or Reject (return to HOD/Lecturer).
2 Course/Program Management Manages high-level academic standards and structural data. Includes managing PLO standards, Program structure, and prerequisite/corequisite rules (Module Relationships) for the entire Faculty/Program.
3 Lookup &
Analysis Searches, filters, and looks up all Syllabus within the Department. Includes the Syllabus Version Comparison feature across years/courses to ensure consistency.
4 Notification Receives real-time notifications for critical events: Syllabus submission, end of Collaborative Review period, or Syllabus rejection by higher authorities (for prompt action).


Principal - Final Approver/Strategic Flow

No. Function Description

1 Final Strategic Approval Final approval of important academic documents/proposals.
2 System Oversight View system overview, reports and operational status.






‚óè Non-functional requirement:
‚óè Performance:
+ Response Time:
‚óè The system ensures smooth response to basic user tasks (login, page change, list view) under stable network conditions.
‚óè The Syllabus search function returns results within an acceptable time for the current database.
+ AI Processing:
‚óè Tasks that require high computing resources (such as text comparison, CLO-PLO checking, content summarization) are designed to run in the background (background processing/asynchronous) so as not to interrupt the user experience.
‚óè The system will send notifications to users after the AI processing is completed.
+ Concurrency:
‚óè The system operates stably with the expected concurrent access volume serving the Faculty/School level (about 50-100 concurrent users).
‚óè Reliability / Availability:
+ Data Safety:
‚óè The system has a periodic database backup mechanism to prevent the risk of data loss.
‚óè Ensure data integrity during the approval process status transition (Workflow).
+ Error Handling:
‚óè The system has a mechanism to catch errors and display friendly, clear notifications to users when an incident occurs, avoiding sudden application crashes.
‚óè System error logs are recorded to serve maintenance and error correction.
‚óè Security:
+ Access Control:
‚óè The system requires authentication for all users accessing management functions.
‚óè Role-based authorization (RBAC): Ensures users can only access authorized resources and functions (e.g., Students cannot access Lecturer functions).
+ Data security:
‚óè User passwords are one-way encrypted (Hashing) before being stored in the database.
‚óè The system complies with basic Web security principles to prevent common errors such as SQL Injection and XSS.
‚óè Usability:
+ User Interface:
‚óè The interface is designed to be intuitive, consistent, and easy to use for non-technical users.
‚óè Supports good display on popular browsers today (Chrome, Edge, Firefox).
+ Mobile Experience:
‚óè The Student subsystem supports a Responsive or Mobile App interface, optimized for searching and reading information on mobile devices.
‚óè Maintainability & Scalability
+ System architecture:
‚óè The system is built according to the basic Service-oriented or Microservices architecture, clearly separating the Web application (Web App) and the intelligent processing module (AI Service).
‚óè Allows upgrading or replacing AI models without significantly affecting the core structure of the management application.
+ Source code organization:
‚óè The source code complies with programming conventions, is clearly organized to facilitate future development and maintenance.

(*) 3.2. Main proposal content (including result and product)
a. Theory and practice (document):

‚óè Students should apply the software development process and UML 2.0 in the modeling system.
‚óè The documents include User Requirements, Software Requirement Specifications, Architecture Design, Detail Design, System Implementation, Testing Document, Installation Guide, source code, and deployable software packages.
‚óè Server-side technologies:
‚óã Server: Python
‚óã Database Design: MySQL + Redis
‚óè Client-side technologies:
‚óã Web Client: ReactJS/NextJs
‚óã Mobile App: React native.
‚óè AI & Crawler Module:
‚óã Architecture: Python Microservice (FastAPI + Celery) following Event-driven model (Redis/RabbitMQ).
‚óã AI Core & NLP:
‚ñ† Orchestration: LangChain.
‚ñ† Models: Hugging Face (PhoBERT/ViBERT), SentenceTransformers (Semantic check), KeyBERT & VnCoreNLP (Keyword/Relation).
‚ñ† GenAI: Llama 3 (Ollama) ho·∫∑c OpenAI/Gemini API (Summarization).
‚óã Data Processing:
‚ñ† Crawler: Selenium, BeautifulSoup.
‚ñ† OCR: VietOCR/Tesseract (x·ª≠ l√Ω PDF/Image)
‚óã Storage & Search:
‚ñ† DB: PostgreSQL + pgvector (Vector & Relational Data).
‚ñ† Search: Elasticsearch (Full-text).
‚ñ† Cache: Redis.
b. Products:
‚óã Web App for System Admin: ‚Äì User Management, Workflow Config, System Parameters and Final Publishing.
‚óã Web App for Lecturer: ‚Äì Create, edit and update Syllabus, Submit for Review, track feedback status and search for reference resources.
‚óã Web App for Reviewer & Approver (HOD & Academic Affairs): ‚Äì Collaborative Review, use AI to detect changes, CLO-PLO Mapping and manage curriculum framework.
‚óã Web App for Strategic Approver (Rector): ‚Äì Approve high-level strategic decisions, view Impact Analysis reports and monitor system performance indicators (Audit/KPIs).
</file>

<file path=".gitignore">
# # See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# # dependencies
# /node_modules
# /.pnp
# .pnp.*
# .yarn/*
# !.yarn/patches
# !.yarn/plugins
# !.yarn/releases
# !.yarn/versions

# # testing
# /coverage

# # next.js
# /.next/
# /out/

# # production
# /build

# # misc
# .DS_Store
# *.pem

# # debug
# npm-debug.log*
# yarn-debug.log*
# yarn-error.log*
# .pnpm-debug.log*

# # env files (can opt-in for committing if needed)
# .env

# # vercel
# .vercel

# # typescript
# *.tsbuildinfo
# next-env.d.ts


# --- General ---
.DS_Store
.vscode/
.idea/

# --- Python / Backend ---
__pycache__/
*.py[cod]
*$py.class
venv/
.venv/
env/
*.db
*.sqlite3
.env
.env.local

# --- Node.js / Frontend ---
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*
.next/
out/
build/
dist/
.vercel/

# --- Docker ---
*.log
# --- SMD Project Specifics ---
repomix-output.xml
**/logs/*.txt
**/logs/*.log
**/temp_ocr/
**/static/uploads/*
!**/static/uploads/.gitkeep
postgres_data/
.env*
!*.env.example
</file>

<file path="apps/api/.gitignore">
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[codz]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py.cover
.hypothesis/
.pytest_cache/
cover/

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/

# PyBuilder
.pybuilder/
target/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
#   For a library or package, you might want to ignore these files since the code is
#   intended to run in multiple environments; otherwise, check them in:
# .python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# UV
#   Similar to Pipfile.lock, it is generally recommended to include uv.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#uv.lock

# poetry
#   Similar to Pipfile.lock, it is generally recommended to include poetry.lock in version control.
#   This is especially recommended for binary packages to ensure reproducibility, and is more
#   commonly ignored for libraries.
#   https://python-poetry.org/docs/basic-usage/#commit-your-poetrylock-file-to-version-control
#poetry.lock
#poetry.toml

# pdm
#   Similar to Pipfile.lock, it is generally recommended to include pdm.lock in version control.
#   pdm recommends including project-wide configuration in pdm.toml, but excluding .pdm-python.
#   https://pdm-project.org/en/latest/usage/project/#working-with-version-control
#pdm.lock
#pdm.toml
.pdm-python
.pdm-build/

# pixi
#   Similar to Pipfile.lock, it is generally recommended to include pixi.lock in version control.
#pixi.lock
#   Pixi creates a virtual environment in the .pixi directory, just like venv module creates one
#   in the .venv directory. It is recommended not to include this directory in version control.
.pixi

# PEP 582; used by e.g. github.com/David-OConnor/pyflow and github.com/pdm-project/pdm
__pypackages__/

# Celery stuff
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
.env
.envrc
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# pytype static type analyzer
.pytype/

# Cython debug symbols
cython_debug/

# PyCharm
#  JetBrains specific template is maintained in a separate JetBrains.gitignore that can
#  be found at https://github.com/github/gitignore/blob/main/Global/JetBrains.gitignore
#  and can be added to the global gitignore or merged into this file.  For a more nuclear
#  option (not recommended) you can uncomment the following to ignore the entire idea folder.
#.idea/

# Abstra
# Abstra is an AI-powered process automation framework.
# Ignore directories containing user credentials, local state, and settings.
# Learn more at https://abstra.io/docs
.abstra/

# Visual Studio Code
#  Visual Studio Code specific template is maintained in a separate VisualStudioCode.gitignore 
#  that can be found at https://github.com/github/gitignore/blob/main/Global/VisualStudioCode.gitignore
#  and can be added to the global gitignore or merged into this file. However, if you prefer, 
#  you could uncomment the following to ignore the entire vscode folder
# .vscode/

# Ruff stuff:
.ruff_cache/

# PyPI configuration file
.pypirc

# Cursor
#  Cursor is an AI-powered code editor. `.cursorignore` specifies files/directories to
#  exclude from AI features like autocomplete and code analysis. Recommended for sensitive data
#  refer to https://docs.cursor.com/context/ignore-files
.cursorignore
.cursorindexingignore

# Marimo
marimo/_static/
marimo/_lsp/
__marimo__/
</file>

<file path="apps/api/src/api/controllers/academic_year_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.academic_year_service import AcademicYearService
from api.schemas.academic_year_schema import AcademicYearSchema

academic_year_bp = Blueprint('academic_year', __name__, url_prefix='/academic-years')

schema = AcademicYearSchema()

@academic_year_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def list_academic_years(academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    """Get all academic years
    ---
    get:
      summary: Get all academic years
      tags:
        - AcademicYears
      responses:
        200:
          description: List of academic years
    """
    items = academic_year_service.list_academic_years()
    return jsonify(schema.dump(items, many=True)), 200

@academic_year_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_academic_year(academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    """Create a new academic year
    ---
    post:
      summary: Create an academic year
      tags:
        - AcademicYears
      requestBody:
        required: true
      responses:
        201:
          description: Created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    ay = academic_year_service.create_academic_year(data)
    return jsonify(schema.dump(ay)), 201

@academic_year_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_academic_year(id: int, academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    if request.method == 'OPTIONS':
        return '', 200
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    ay = academic_year_service.update_academic_year(id, data)
    if not ay:
        return jsonify({'message': 'AcademicYear not found'}), 404
    return jsonify(schema.dump(ay)), 200

@academic_year_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_academic_year(id: int, academic_year_service: AcademicYearService = Provide[Container.academic_year_service]):
    if request.method == 'OPTIONS':
        return '', 200
    ok = academic_year_service.delete_academic_year(id)
    if not ok:
        return jsonify({'message': 'AcademicYear not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/ai_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.ai_service import AiService
import logging
import re
from tasks import generate_syllabus_summary_task, analyze_clo_plo_task
from celery.result import AsyncResult

logger = logging.getLogger(__name__)
ai_bp = Blueprint('ai', __name__, url_prefix='/ai')

def to_camel_case(snake_str):
    """Convert snake_case to camelCase"""
    components = snake_str.split('_')
    return components[0] + ''.join(x.title() for x in components[1:])

def convert_keys_to_camel(data):
    """Recursively convert all keys in dict/list from snake_case to camelCase"""
    if isinstance(data, dict):
        return {to_camel_case(k): convert_keys_to_camel(v) for k, v in data.items()}
    elif isinstance(data, list):
        return [convert_keys_to_camel(item) for item in data]
    else:
        return data

@ai_bp.route('/generate', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def generate(ai_service: AiService = Provide[Container.ai_service]):
    """Generate syllabus using AI with comprehensive error handling."""
    
    # Handle OPTIONS preflight request
    if request.method == 'OPTIONS':
        return '', 204
    
    try:
        data = request.get_json() or {}
        subject_name = data.get('subject_name', '').strip()
        
        if not subject_name:
            return jsonify({'message': 'subject_name is required and cannot be empty'}), 400

        logger.info(f"AI generation request for: {subject_name}")
        
        # Call service with error handling
        try:
            res = ai_service.generate(subject_name)
        except Exception as e:
            logger.error(f"AI service error: {e}", exc_info=True)
            return jsonify({'message': f'AI service error: {str(e)}'}), 500
        
        # Validate response type
        if not isinstance(res, dict):
            logger.error(f"Invalid response type from AI service: {type(res)}")
            return jsonify({'message': 'Invalid response from AI service'}), 500
        
        # Handle error response from AI service
        if res.get('error'):
            error_msg = res.get('error')
            logger.warning(f"AI generation error: {error_msg}")
            return jsonify({'message': error_msg}), 400
        
        # Convert snake_case to camelCase for frontend
        res = convert_keys_to_camel(res)
        
        logger.info(f"AI generation successful for: {subject_name}")
        return jsonify(res), 200
    
    except ValueError as e:
        logger.error(f"Validation error: {e}")
        return jsonify({'message': str(e)}), 422
    except Exception as e:
        logger.error(f"Unexpected error in /ai/generate: {e}", exc_info=True)
        return jsonify({'message': 'Unexpected error occurred'}), 500

@ai_bp.route('/summary/async', methods=['POST'], strict_slashes=False)
@inject
def summary_async(syllabus_service = Provide[Container.syllabus_service]):
    """Trigger background task for syllabus summary"""
    data = request.get_json() or {}
    sid = data.get('syllabus_id')
    if not sid:
        return jsonify({'message': 'syllabus_id is required'}), 400
        
    s = syllabus_service.get_syllabus_details(sid)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
        
    from api.schemas.syllabus_schema import SyllabusSchema
    schema = SyllabusSchema()
    s_data = schema.dump(s)
    
    # Trigger task
    task = generate_syllabus_summary_task.delay(s_data)
    return jsonify({
        'task_id': task.id,
        'status': 'PENDING',
        'message': 'Summary task started in background'
    }), 202

@ai_bp.route('/task-status/<task_id>', methods=['GET'])
def get_task_status(task_id):
    """Check background task status"""
    res = AsyncResult(task_id)
    if res.ready():
        if res.failed():
            return jsonify({
                'status': 'FAILURE',
                'error': str(res.result)
            })
        return jsonify({
            'status': 'SUCCESS',
            'result': res.result
        })
    return jsonify({'status': res.status})

@ai_bp.route('/summary', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def summary(ai_service: AiService = Provide[Container.ai_service], 
            syllabus_service = Provide[Container.syllabus_service]):
    """Summarize syllabus using AI"""
    data = request.get_json() or {}
    sid = data.get('syllabus_id')
    if not sid:
        return jsonify({'message': 'syllabus_id is required'}), 400
        
    s = syllabus_service.get_syllabus_details(sid)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
        
    from api.schemas.syllabus_schema import SyllabusSchema
    schema = SyllabusSchema()
    s_data = schema.dump(s)
    
    res = ai_service.summarize_syllabus(s_data, sid)
    if 'error' in res:
        return jsonify({'message': res['error']}), 500
        
    return jsonify(res), 200

@ai_bp.route('/analyze-alignment', methods=['POST'], strict_slashes=False)
@inject
def analyze_alignment(ai_service: AiService = Provide[Container.ai_service],
                     syllabus_service = Provide[Container.syllabus_service]):
    """Analyze CLO-PLO alignment using AI"""
    data = request.get_json() or {}
    sid = data.get('syllabus_id')
    if not sid:
        return jsonify({'message': 'syllabus_id is required'}), 400
        
    s = syllabus_service.get_syllabus_details(sid)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    
    # Prepare data for AI
    clos = [{'code': c.code, 'description': c.description} for c in (s.clos or [])]
    
    # Get PLOs from program
    plos = []
    program = s.program
    if program and hasattr(program, 'outcomes'):
        plos = [{'code': p.code, 'description': p.description} for p in (program.outcomes or [])]
    
    # Get current mappings
    mappings = []
    for c in (s.clos or []):
        if hasattr(c, 'plo_mappings'):
            for m in (c.plo_mappings or []):
                mappings.append({
                    'clo': c.code,
                    'plo': m.program_plo.code if m.program_plo else 'N/A',
                    'level': m.level
                })
            
    res = ai_service.analyze_clo_plo_alignment(clos, plos, mappings)
    if 'error' in res:
        return jsonify({'message': res['error']}), 500
        
    return jsonify(res), 200
</file>

<file path="apps/api/src/api/controllers/assessment_clo_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_clo_service import AssessmentCloService
from api.schemas.assessment_clo_mapping_schema import AssessmentCloMappingSchema

assessment_clo_bp = Blueprint('assessment_clo_map', __name__, url_prefix='/assessment-clos')

schema = AssessmentCloMappingSchema()

@assessment_clo_bp.route('/component/<int:component_id>', methods=['GET'])
@inject
def list_clos(component_id: int, service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    List CLOs mapped to a component
    ---
    tags:
      - Assessments
    parameters:
      - name: component_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of CLOs (id, code, description)
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: integer
                  code:
                    type: string
                  description:
                    type: string
    """
    items = service.get_clos_for_component(component_id)
    return jsonify([{'id': c.id, 'code': c.code, 'description': c.description} for c in items]), 200

@assessment_clo_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def add_mapping(service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    Map a CLO to an assessment component
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentCloMapping'
    responses:
      201:
        description: Mapping created
      400:
        description: Validation or integrity error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        mapping = service.add_mapping(data['assessment_component_id'], data['syllabus_clo_id'])
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify({'assessment_component_id': mapping.assessment_component_id, 'syllabus_clo_id': mapping.syllabus_clo_id}), 201

@assessment_clo_bp.route('/', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def remove_mapping(service: AssessmentCloService = Provide[Container.assessment_clo_service]):
    """
    Remove a mapping between component and CLO
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentCloMapping'
    responses:
      204:
        description: Mapping removed
      400:
        description: Bad request
      404:
        description: Mapping not found
    """
    data = request.get_json() or {}
    if not data:
        return jsonify({'error': 'Provide JSON body with assessment_component_id and syllabus_clo_id'}), 400
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    ok = service.remove_mapping(data['assessment_component_id'], data['syllabus_clo_id'])
    if not ok:
        return jsonify({'message': 'Mapping not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/assessment_component_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_component_service import AssessmentComponentService
from api.schemas.assessment_component_schema import AssessmentComponentSchema

assessment_component_bp = Blueprint('assessment_component', __name__, url_prefix='/assessment-components')

schema = AssessmentComponentSchema()

@assessment_component_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_component(service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Create an assessment component
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentComponent'
    responses:
      201:
        description: Component created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_component(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@assessment_component_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_component(id: int, service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Update an assessment component
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentComponent'
    responses:
      200:
        description: Component updated
      400:
        description: Validation error
      404:
        description: Component not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = service.update_component(id, data)
    if not item:
        return jsonify({'message': 'Component not found'}), 404
    return jsonify(schema.dump(item)), 200

@assessment_component_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_component(id: int, service: AssessmentComponentService = Provide[Container.assessment_component_service]):
    """
    Delete an assessment component
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Component not found
    """
    ok = service.delete_component(id)
    if not ok:
        return jsonify({'message': 'Component not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/assessment_scheme_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.assessment_scheme_service import AssessmentSchemeService
from api.schemas.assessment_scheme_schema import AssessmentSchemeSchema

assessment_scheme_bp = Blueprint('assessment_scheme', __name__, url_prefix='/assessment-schemes')

schema = AssessmentSchemeSchema()

@assessment_scheme_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_schemes(syllabus_id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    List assessment schemes for a syllabus
    ---
    tags:
      - Assessments
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of assessment schemes
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/AssessmentScheme'
    """
    items = service.list_schemes_for_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@assessment_scheme_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_scheme(service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Create an assessment scheme
    ---
    tags:
      - Assessments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentScheme'
    responses:
      201:
        description: Scheme created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_scheme(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@assessment_scheme_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_scheme(id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Update an assessment scheme
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AssessmentScheme'
    responses:
      200:
        description: Scheme updated
      400:
        description: Validation error
      404:
        description: Scheme not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = service.update_scheme(id, data)
    if not item:
        return jsonify({'message': 'Scheme not found'}), 404
    return jsonify(schema.dump(item)), 200

@assessment_scheme_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_scheme(id: int, service: AssessmentSchemeService = Provide[Container.assessment_scheme_service]):
    """
    Delete an assessment scheme
    ---
    tags:
      - Assessments
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Scheme not found
    """
    ok = service.delete_scheme(id)
    if not ok:
        return jsonify({'message': 'Scheme not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/auth_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.user_service import UserService
from services.system_auditlog_service import SystemAuditLogService
from werkzeug.security import check_password_hash
import jwt
from datetime import datetime, timedelta
from config import Config

auth_bp = Blueprint('auth', __name__, url_prefix='/auth')

@auth_bp.route('/login', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def login(user_service: UserService = Provide[Container.user_service],
          audit_service: SystemAuditLogService = Provide[Container.system_auditlog_service]):
    """
    Login and obtain a token
    ---
    tags:
      - Auth
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              username:
                type: string
              password:
                type: string
            required:
              - username
              - password
    responses:
      200:
        description: Login successful, returns token and user information
      400:
        description: Missing username or password
      401:
        description: Invalid credentials
    """
    if request.method == 'OPTIONS':
      # Fast path for CORS preflight
      return jsonify({'message': 'CORS preflight OK'}), 200

    data = request.get_json() or {}
    username = data.get('username')
    password = data.get('password')
    if not username or not password:
        return jsonify({'message': 'username and password are required'}), 400
    user = user_service.get_by_username(username)
    if not user:
        return jsonify({'message': 'Invalid credentials'}), 401
    if not check_password_hash(user.password_hash, password):
        return jsonify({'message': 'Invalid credentials'}), 401

    # Get role name if available
    role_name = None
    try:
        if user.roles and len(user.roles) > 0 and getattr(user.roles[0], 'role', None):
            role_name = user.roles[0].role.name
    except Exception:
        role_name = None

    # Generate real JWT token
    payload = {
        'user_id': user.id,
        'username': user.username,
        'role': role_name,
        'exp': datetime.utcnow() + timedelta(hours=24),  # Token expires in 24 hours
        'iat': datetime.utcnow()
    }
    
    token = jwt.encode(payload, Config.SECRET_KEY, algorithm='HS256')
    
    # Log successful login
    try:
        audit_service.create_log(
            user_id=user.id,
            action_type='LOGIN',
            resource_target=f'User #{user.id} ({user.username})',
            ip_address=request.remote_addr,
            user_agent=request.headers.get('User-Agent'),
            details=f'User logged in: {user.full_name} ({user.username})'
        )
    except Exception as e:
        print(f"Failed to log audit: {e}")
    
    return jsonify({
        'access_token': token,
        'token': token,  # Keep for backward compatibility
        'user_id': user.id, 
        'role': role_name
    }), 200
</file>

<file path="apps/api/src/api/controllers/clo_plo_mapping_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.clo_plo_mapping_service import CloPloMappingService
from api.schemas.clo_plo_mapping_schema import CloPloMappingSchema

clo_plo_mapping_bp = Blueprint('clo_plo_mapping', __name__, url_prefix='/clo-plo-mappings')
schema = CloPloMappingSchema()

@clo_plo_mapping_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_mapping(service: CloPloMappingService = Provide[Container.clo_plo_mapping_service]):
    """
    Create CLO-PLO Mapping
    ---
    tags:
      - Mappings (CLO-PLO)
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CloPloMapping'
    responses:
      201: {description: Created}
      400: {description: Error}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_mapping(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@clo_plo_mapping_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_mapping(id: int, service: CloPloMappingService = Provide[Container.clo_plo_mapping_service]):
    """
    Delete CLO-PLO Mapping
    ---
    tags:
      - Mappings (CLO-PLO)
    parameters:
      - name: id
        in: path
        required: true
        schema: {type: integer}
    responses:
      204: {description: Deleted}
    """
    ok = service.delete_mapping(id)
    if not ok:
        return jsonify({'message': 'Mapping not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/dashboard_controller.py">
from flask import Blueprint, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_service import SyllabusService
from services.user_service import UserService
from services.analysis_service import AnalysisService
from domain.constants import WorkflowStatus

dashboard_bp = Blueprint('dashboard', __name__, url_prefix='/stats')

@dashboard_bp.route('/impact-analysis/<int:syllabus_id>', methods=['GET'])
@inject
def impact_analysis(syllabus_id: int, analysis_service: AnalysisService = Provide[Container.analysis_service]):
    """Analyze impact of changing a syllabus"""
    result = analysis_service.get_impact_analysis(syllabus_id)
    if not result:
        return jsonify({"message": "Syllabus not found"}), 404
    return jsonify(result), 200

@dashboard_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_stats(syllabus_service: SyllabusService = Provide[Container.syllabus_service], user_service: UserService = Provide[Container.user_service]):
    syllabuses = syllabus_service.list_syllabuses() or []
    users = user_service.list_users() or []

    total_syllabuses = len(syllabuses)
    total_users = len(users)

    # Group by status using WorkflowStatus constants
    stats_by_status = {
        WorkflowStatus.PUBLISHED: 0,
        WorkflowStatus.APPROVED: 0,
        'Pending': 0,
        WorkflowStatus.DRAFT: 0,
        WorkflowStatus.RETURNED: 0
    }
    for s in syllabuses:
        status_raw = getattr(s, 'status', None) or getattr(s, 'state', None) or WorkflowStatus.DRAFT
        status = status_raw.upper()
        # Normalize
        if status == WorkflowStatus.PUBLISHED:
            stats_by_status[WorkflowStatus.PUBLISHED] += 1
        elif status == WorkflowStatus.APPROVED:
            stats_by_status[WorkflowStatus.APPROVED] += 1
        elif 'PENDING' in status:
            stats_by_status['Pending'] += 1
        elif status in (WorkflowStatus.RETURNED, WorkflowStatus.REJECTED):
            stats_by_status[WorkflowStatus.RETURNED] += 1
        else:
            stats_by_status[WorkflowStatus.DRAFT] += 1

    # Convert to array format for frontend charts
    status_breakdown = [
        {"name": "ƒê√£ xu·∫•t b·∫£n", "value": stats_by_status[WorkflowStatus.PUBLISHED] + stats_by_status[WorkflowStatus.APPROVED], "fill": "#10b981"},
        {"name": "Ch·ªù duy·ªát", "value": stats_by_status['Pending'], "fill": "#f59e0b"},
        {"name": "Nh√°p", "value": stats_by_status[WorkflowStatus.DRAFT], "fill": "#6b7280"},
        {"name": "Tr·∫£ l·∫°i", "value": stats_by_status[WorkflowStatus.RETURNED], "fill": "#ef4444"}
    ]

    # Get operational KPIs
    kpis = syllabus_service.get_kpis()

    return jsonify({
        'total_syllabuses': total_syllabuses,
        'total_syllabus': total_syllabuses,  # Alias for frontend
        'total_users': total_users,
        'by_status': stats_by_status,  # Keep for backward compatibility
        'status_breakdown': status_breakdown,  # Array format for charts
        'kpis': kpis
    }), 200

@dashboard_bp.route('/kpis', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_kpis(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Strategic KPIs for Principal/Admin"""
    try:
        kpis = syllabus_service.get_kpis()
        return jsonify(kpis), 200
    except Exception as e:
        return jsonify({'message': str(e)}), 500
</file>

<file path="apps/api/src/api/controllers/department_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.department_service import DepartmentService
from api.schemas.department_schema import DepartmentSchema
from api.middleware import token_required, role_required

department_bp = Blueprint('department', __name__, url_prefix='/departments')

schema = DepartmentSchema()

@department_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def list_departments(department_service: DepartmentService = Provide[Container.department_service]):
    """Get all departments
    ---
    get:
      summary: Get all departments
      tags:
        - Departments
      responses:
        200:
          description: List of departments
    """
    departments = department_service.list_departments()
    return jsonify(schema.dump(departments, many=True)), 200

@department_bp.route('/<int:id>', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Get department by id
    ---
    get:
      summary: Get department by ID
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Department object
        404:
          description: Not found
    """
    department = department_service.get_department(id)
    if not department:
        return jsonify({'message': 'Department not found'}), 404
    return jsonify(schema.dump(department)), 200

@department_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def create_department(department_service: DepartmentService = Provide[Container.department_service]):
    """Create a new department
    ---
    post:
      summary: Create a new department
      tags:
        - Departments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Department'
      responses:
        201:
          description: Department created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data)
    except Exception as e:
        return jsonify(getattr(e, 'messages', str(e))), 400
    department = department_service.create_department(loaded_data)
    return jsonify(schema.dump(department)), 201

@department_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def update_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Update an existing department
    ---
    put:
      summary: Update department
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Department'
      responses:
        200:
          description: Department updated
        400:
          description: Invalid input
        404:
          description: Department not found
    """
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data, partial=True)
    except Exception as e:
        return jsonify(getattr(e, 'messages', str(e))), 400
    
    department = department_service.update_department(id, loaded_data)
    if not department:
        return jsonify({'message': 'Department not found'}), 404
    return jsonify(schema.dump(department)), 200

@department_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_department(id: int, department_service: DepartmentService = Provide[Container.department_service]):
    """Delete department
    ---
    delete:
      summary: Delete department
      tags:
        - Departments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Department not found
    """
    ok = department_service.delete_department(id)
    if not ok:
        return jsonify({'message': 'Department not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/faculty_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.faculty_service import FacultyService
from api.schemas.faculty_schema import FacultySchema
from api.middleware import token_required, role_required

faculty_bp = Blueprint('faculty', __name__, url_prefix='/faculties')

schema = FacultySchema()

@faculty_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def list_faculties(faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Get all faculties
    ---
    get:
      summary: Get all faculties
      tags:
        - Faculties
      responses:
        200:
          description: List of faculties
    """
    faculties = faculty_service.list_faculties()
    return jsonify(schema.dump(faculties, many=True)), 200

@faculty_bp.route('/<int:id>', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Get faculty by id
    ---
    get:
      summary: Get faculty by ID
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Faculty object
        404:
          description: Not found
    """
    faculty = faculty_service.get_faculty(id)
    if not faculty:
        return jsonify({'message': 'Faculty not found'}), 404
    return jsonify(schema.dump(faculty)), 200

@faculty_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def create_faculty(faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Create a new faculty
    ---
    post:
      summary: Create a new faculty
      tags:
        - Faculties
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Faculty'
      responses:
        201:
          description: Faculty created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data)
    except Exception as e:
        return jsonify(getattr(e, 'messages', str(e))), 400
    faculty = faculty_service.create_faculty(loaded_data)
    return jsonify(schema.dump(faculty)), 201

@faculty_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def update_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Update an existing faculty
    ---
    put:
      summary: Update faculty
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Faculty'
      responses:
        200:
          description: Faculty updated
        400:
          description: Invalid input
        404:
          description: Faculty not found
    """
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data, partial=True)
    except Exception as e:
        return jsonify(getattr(e, 'messages', str(e))), 400
    
    faculty = faculty_service.update_faculty(id, loaded_data)
    if not faculty:
        return jsonify({'message': 'Faculty not found'}), 404
    return jsonify(schema.dump(faculty)), 200

@faculty_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_faculty(id: int, faculty_service: FacultyService = Provide[Container.faculty_service]):
    """Delete faculty
    ---
    delete:
      summary: Delete faculty
      tags:
        - Faculties
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Faculty not found
    """
    ok = faculty_service.delete_faculty(id)
    if not ok:
        return jsonify({'message': 'Faculty not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/file_controller.py">
from flask import Blueprint, request, jsonify, send_file
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.file_service import FileService
from api.schemas.file_schema import FileSchema
import os

file_bp = Blueprint('file', __name__, url_prefix='/files')
schema = FileSchema()

@file_bp.route('/upload', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def upload_file(service: FileService = Provide[Container.file_service]):
    # Handle CORS preflight
    if request.method == 'OPTIONS':
        response = jsonify({'message': 'OK'})
        response.headers.add('Access-Control-Allow-Origin', request.headers.get('Origin', '*'))
        response.headers.add('Access-Control-Allow-Headers', 'Authorization, Content-Type')
        response.headers.add('Access-Control-Allow-Methods', 'POST, OPTIONS')
        return response, 200
    
    if 'file' not in request.files:
        return jsonify({'error': 'No file part'}), 400
    file = request.files['file']
    # Demo: assume user_id=1 if no auth (In production, get from token)
    user_id = request.form.get('user_id', 1) 
    try:
        record = service.upload_file(file, int(user_id))
        return jsonify(schema.dump(record)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@file_bp.route('/<int:id>', methods=['GET'])
@inject
def download_file(id: int, service: FileService = Provide[Container.file_service]):
    record = service.get_file(id)
    if not record:
        return jsonify({'message': 'File not found'}), 404
    try:
        return send_file(os.path.abspath(record.file_path), as_attachment=True, download_name=record.file_name)
    except Exception:
        return jsonify({'message': 'File not found on disk'}), 404
</file>

<file path="apps/api/src/api/controllers/notification_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.notification_service import NotificationService
from api.schemas.notification_schema import NotificationSchema
from api.middleware import token_required

notification_bp = Blueprint('notification', __name__, url_prefix='/notifications')
schema = NotificationSchema()

@notification_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
@token_required
def get_my_notifications(service: NotificationService = Provide[Container.notification_service]):
    """
    Get current user's notifications
    ---
    tags:
      - Notifications
    parameters:
      - name: unread
        in: query
        type: boolean
        description: Filter by unread only
    responses:
      200:
        description: List of notifications
    """
    from flask import g
    user_id = getattr(g, 'user_id', None)
    if not user_id:
         return jsonify({'message': 'User context missing'}), 401
    unread = request.args.get('unread', 'false').lower() == 'true'
    items = service.get_user_notifications(user_id, unread_only=unread)
    return jsonify(schema.dump(items, many=True)), 200

@notification_bp.route('/<int:id>/read', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
@token_required
def mark_read(id: int, service: NotificationService = Provide[Container.notification_service]):
    """
    Mark a notification as read
    ---
    tags:
      - Notifications
    parameters:
      - name: id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200:
        description: Marked as read
    """
    ok = service.mark_read(id)
    if not ok:
        return jsonify({'message': 'Notification not found'}), 404
    return jsonify({'message': 'Marked as read'}), 200
</file>

<file path="apps/api/src/api/controllers/program_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.program_service import ProgramService
from api.schemas.program_schema import ProgramSchema
from api.middleware import token_required, role_required
from marshmallow import ValidationError

program_bp = Blueprint('program', __name__, url_prefix='/programs')

schema = ProgramSchema()

@program_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def list_programs(program_service: ProgramService = Provide[Container.program_service]):
    """Get all programs
    ---
    get:
      summary: Get all programs
      tags:
        - Programs
      responses:
        200:
          description: List of programs
    """
    items = program_service.list_programs()
    return jsonify(schema.dump(items, many=True)), 200

@program_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def create_program(program_service: ProgramService = Provide[Container.program_service]):
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data)
    except ValidationError as err:
        return jsonify(err.messages), 400
    except Exception as e:
        return jsonify({'message': str(e)}), 400
    p = program_service.create_program(loaded_data)
    return jsonify(schema.dump(p)), 201

@program_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_program(id: int, program_service: ProgramService = Provide[Container.program_service]):
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data, partial=True)
    except ValidationError as err:
        return jsonify(err.messages), 400
    except Exception as e:
        return jsonify({'message': str(e)}), 400
    p = program_service.update_program(id, loaded_data)
    if not p:
        return jsonify({'message': 'Program not found'}), 404
    return jsonify(schema.dump(p)), 200

@program_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_program(id: int, program_service: ProgramService = Provide[Container.program_service]):
    ok = program_service.delete_program(id)
    if not ok:
        return jsonify({'message': 'Program not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/program_outcome_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.program_outcome_service import ProgramOutcomeService
from api.schemas.program_outcome_schema import ProgramOutcomeSchema
from api.middleware import token_required, role_required

program_outcome_bp = Blueprint('program_outcome', __name__, url_prefix='/program-outcomes')
schema = ProgramOutcomeSchema()

@program_outcome_bp.route('/program/<int:program_id>', methods=['GET'])
@inject
def list_plos(program_id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    items = service.list_by_program(program_id)
    return jsonify(schema.dump(items, many=True)), 200

@program_outcome_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def create_plo(service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.create_plo(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@program_outcome_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_plo(id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    data = request.get_json() or {}
    item = service.update_plo(id, data)
    if not item:
        return jsonify({'message': 'PLO not found'}), 404
    return jsonify(schema.dump(item)), 200

@program_outcome_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_plo(id: int, service: ProgramOutcomeService = Provide[Container.program_outcome_service]):
    ok = service.delete_plo(id)
    if not ok:
        return jsonify({'message': 'PLO not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/public_controller.py">
"""
Public API endpoints (no authentication required)
For student portal and public access
"""
from flask import Blueprint, jsonify, request
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_service import SyllabusService
from api.schemas.syllabus_schema import SyllabusSchema
from domain.constants import WorkflowStatus

public_bp = Blueprint('public', __name__, url_prefix='/public')
schema = SyllabusSchema()

@public_bp.route('/syllabus', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def search_public_syllabuses(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """
    Public search for syllabuses (no authentication required)
    Only returns approved/published syllabuses
    """
    search = request.args.get('search', '').strip()
    subject_id = request.args.get('subject_id', type=int)
    program_id = request.args.get('program_id', type=int)
    academic_year_id = request.args.get('academic_year_id', type=int)
    
    # Get syllabuses. For better performance and correctness, we use a single query 
    # but filter for multiple allowed statuses.
    all_syllabuses = syllabus_service.list_syllabuses() or []
    
    # Filter for public access: only Approved/Published and active
    public_syllabuses = [
        s for s in all_syllabuses
        if getattr(s, 'is_active', True) and 
           getattr(s, 'status', '').upper() in WorkflowStatus.PUBLIC_STATUSES
    ]
    
    # Apply search filter
    if search:
        search_lower = search.lower()
        public_syllabuses = [
            s for s in public_syllabuses
            if (s.subject and search_lower in str(s.subject.name_vi or '').lower()) or
               (s.subject and search_lower in str(s.subject.name_en or '').lower()) or
               (s.subject and search_lower in str(s.subject.code or '').lower())
        ]
    
    # Apply subject filter
    if subject_id:
        public_syllabuses = [s for s in public_syllabuses if s.subject_id == subject_id]
    
    # Apply program filter
    if program_id:
        public_syllabuses = [s for s in public_syllabuses if s.program_id == program_id]

    # Apply academic year filter
    if academic_year_id:
        public_syllabuses = [s for s in public_syllabuses if s.academic_year_id == academic_year_id]
    
    return jsonify({
        'data': schema.dump(public_syllabuses, many=True),
        'total': len(public_syllabuses)
    }), 200


@public_bp.route('/syllabus/<int:id>', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_public_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """
    Get public syllabus details by ID
    Only returns if approved/published
    """
    # CRITICAL FIX: Use get_syllabus_details to load CLOS, Materials, etc.
    syllabus = syllabus_service.get_syllabus_details(id)
    
    if not syllabus:
        return jsonify({'message': 'Syllabus not found'}), 404
    
    # Check if public
    if not (getattr(syllabus, 'is_active', True) and 
            getattr(syllabus, 'status', '').upper() in WorkflowStatus.PUBLIC_STATUSES):
        return jsonify({'message': 'Syllabus not available'}), 404
    
    return jsonify(schema.dump(syllabus)), 200
</file>

<file path="apps/api/src/api/controllers/role_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.role_service import RoleService
from api.schemas.role_schema import RoleSchema

role_bp = Blueprint('role', __name__, url_prefix='/roles')

schema = RoleSchema()

@role_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def list_roles(role_service: RoleService = Provide[Container.role_service]):
    """Get all roles
    ---
    get:
      summary: Get all roles
      tags:
        - Roles
      responses:
        200:
          description: List of roles
    """
    roles = role_service.list_roles()
    return jsonify(schema.dump(roles, many=True)), 200

@role_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_role(role_service: RoleService = Provide[Container.role_service]):
    """Create a new role
    ---
    post:
      summary: Create a new role
      tags:
        - Roles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        201:
          description: Role created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    role = role_service.create_role(data)
    return jsonify(schema.dump(role)), 201
</file>

<file path="apps/api/src/api/controllers/rubric_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.rubric_service import RubricService
from api.schemas.rubric_schema import RubricSchema

rubric_bp = Blueprint('rubric', __name__, url_prefix='/rubrics')

schema = RubricSchema()

@rubric_bp.route('/component/<int:component_id>', methods=['GET'])
@inject
def list_rubrics(component_id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    List rubrics for a component
    ---
    tags:
      - Rubrics
    parameters:
      - name: component_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of rubrics
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/Rubric'
    """
    items = rubric_service.list_rubrics_for_component(component_id)
    return jsonify(schema.dump(items, many=True)), 200

@rubric_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_rubric(rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Create a rubric
    ---
    tags:
      - Rubrics
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Rubric'
    responses:
      201:
        description: Rubric created
      400:
        description: Validation or creation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = rubric_service.create_rubric(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@rubric_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_rubric(id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Update a rubric
    ---
    tags:
      - Rubrics
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Rubric'
    responses:
      200:
        description: Rubric updated
      400:
        description: Validation error
      404:
        description: Rubric not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = rubric_service.update_rubric(id, data)
    if not item:
        return jsonify({'message': 'Rubric not found'}), 404
    return jsonify(schema.dump(item)), 200

@rubric_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_rubric(id: int, rubric_service: RubricService = Provide[Container.rubric_service]):
    """
    Delete a rubric
    ---
    tags:
      - Rubrics
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Rubric not found
    """
    ok = rubric_service.delete_rubric(id)
    if not ok:
        return jsonify({'message': 'Rubric not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/student_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.student_service import StudentService
from api.schemas.student_schema import StudentSubscriptionSchema, StudentReportSchema
from api.middleware import token_required, role_required

student_bp = Blueprint('student', __name__, url_prefix='/student')
sub_schema = StudentSubscriptionSchema()
rep_schema = StudentReportSchema()

@student_bp.route('/subscribe', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Student', 'Admin'])
@inject
def subscribe(service: StudentService = Provide[Container.student_service]):
    """
    Student subscribes to a subject
    """
    from flask import g
    user_id = getattr(g, 'user_id', None)
    if not user_id:
        return jsonify({'message': 'User not authenticated'}), 401
        
    data = request.get_json() or {}
    subject_id = data.get('subject_id')
    if not subject_id:
        return jsonify({'message': 'subject_id is required'}), 400
        
    item = service.subscribe(user_id, subject_id)
    return jsonify(sub_schema.dump(item)), 201

@student_bp.route('/report', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Student', 'Admin'])
@inject
def report(service: StudentService = Provide[Container.student_service]):
    """
    Student reports an issue with a syllabus
    """
    from flask import g
    user_id = getattr(g, 'user_id', None)
    if not user_id:
        return jsonify({'message': 'User not authenticated'}), 401
        
    data = request.get_json() or {}
    sid = data.get('syllabus_id')
    content = data.get('content')
    if not sid or not content:
        return jsonify({'message': 'syllabus_id and content are required'}), 400
        
    item = service.report_syllabus(user_id, sid, content)
    return jsonify(rep_schema.dump(item)), 201

@student_bp.route('/reports', methods=['GET', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Head of Dept', 'Academic Affairs'])
@inject
def list_reports(service: StudentService = Provide[Container.student_service]):
    """
    List all student reports (Admin)
    ---
    tags:
      - Student Features
    responses:
      200:
        description: List of reports
    """
    items = service.list_reports()
    return jsonify(rep_schema.dump(items, many=True)), 200
</file>

<file path="apps/api/src/api/controllers/subject_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.subject_service import SubjectService
from api.schemas.subject_schema import SubjectSchema
from api.middleware import token_required, role_required

subject_bp = Blueprint('subject', __name__, url_prefix='/subjects')

schema = SubjectSchema()

@subject_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def list_subjects(subject_service: SubjectService = Provide[Container.subject_service]):
    """Get all subjects
    ---
    get:
      summary: Get all subjects
      tags:
        - Subjects
      responses:
        200:
          description: List of subjects
    """
    subjects = subject_service.list_subjects()
    return jsonify(schema.dump(subjects, many=True)), 200

@subject_bp.route('/<int:id>', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Get subject by id
    ---
    get:
      summary: Get subject by ID
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Subject object
        404:
          description: Not found
    """
    subject = subject_service.get_subject(id)
    if not subject:
        return jsonify({'message': 'Subject not found'}), 404
    return jsonify(schema.dump(subject)), 200

@subject_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def create_subject(subject_service: SubjectService = Provide[Container.subject_service]):
    """Create a new subject
    ---
    post:
      summary: Create a new subject
      tags:
        - Subjects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subject'
      responses:
        201:
          description: Subject created
        400:
          description: Invalid input
    """
    if request.method == 'OPTIONS':
        return '', 200
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data)
    except Exception as e:
        return jsonify(getattr(e, 'messages', str(e))), 400
    subject = subject_service.create_subject(loaded_data)
    return jsonify(schema.dump(subject)), 201

@subject_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin', 'Academic Affairs'])
@inject
def update_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Update an existing subject
    ---
    put:
      summary: Update subject
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subject'
      responses:
        200:
          description: Subject updated
        400:
          description: Invalid input
        404:
          description: Subject not found
    """
    if request.method == 'OPTIONS':
        return '', 200
    data = request.get_json() or {}
    try:
        loaded_data = schema.load(data, partial=True)
    except Exception as e:
        return jsonify(getattr(e, 'messages', str(e))), 400
    
    subject = subject_service.update_subject(id, loaded_data)
    if not subject:
        return jsonify({'message': 'Subject not found'}), 404
    return jsonify(schema.dump(subject)), 200

@subject_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_subject(id: int, subject_service: SubjectService = Provide[Container.subject_service]):
    """Delete subject
    ---
    delete:
      summary: Delete subject
      tags:
        - Subjects
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        204:
          description: Deleted
        404:
          description: Subject not found
    """
    if request.method == 'OPTIONS':
        return '', 200
    ok = subject_service.delete_subject(id)
    if not ok:
        return jsonify({'message': 'Subject not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/subject_relationship_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.subject_relationship_service import SubjectRelationshipService
from api.schemas.subject_relationship_schema import SubjectRelationshipSchema

subject_rel_bp = Blueprint('subject_relationship', __name__, url_prefix='/subject-relationships')
schema = SubjectRelationshipSchema()

@subject_rel_bp.route('/subject/<int:subject_id>', methods=['GET'])
@inject
def list_relationships(subject_id: int, service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    List relationships for a subject
    ---
    tags:
      - Subject Relationships
    parameters:
      - name: subject_id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200: {description: List of relationships}
    """
    items = service.get_relationships(subject_id)
    return jsonify(schema.dump(items, many=True)), 200

@subject_rel_bp.route('/tree/<int:subject_id>', methods=['GET'])
@inject
def get_tree(subject_id: int, service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """Get subject tree data (pre-reqs and successors) with recursive logic"""
    tree_data = service.get_tree(subject_id)
    
    # Use schema to dump prerequisites (already returns camelCase)
    prereqs_dump = schema.dump(tree_data["prerequisites"], many=True)
    
    # Manually format successors and ensure camelCase to match Frontend expectation
    successors_dump = [
        {
            "id": s.id,
            "type": s.type,
            "subjectId": s.subject_id,
            "relatedSubjectId": s.related_subject_id,
            "subjectCode": s.subject.code if s.subject else "N/A",
            "subjectName": s.subject.name_vi if s.subject else "N/A"
        } for s in tree_data["successors"]
    ]
    
    return jsonify({
        "prerequisites": prereqs_dump,
        "successors": successors_dump
    }), 200

@subject_rel_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_relationship(service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    Create subject relationship
    ---
    tags:
      - Subject Relationships
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SubjectRelationship'
    responses:
      201: {description: Created}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.add_relationship(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@subject_rel_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_relationship(id: int, service: SubjectRelationshipService = Provide[Container.subject_relationship_service]):
    """
    Delete relationship
    ---
    tags:
      - Subject Relationships
    responses:
      204: {description: Deleted}
    """
    ok = service.remove_relationship(id)
    if not ok:
        return jsonify({'message': 'Relationship not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/syllabus_clo_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_clo_service import SyllabusCloService
from api.schemas.syllabus_clo_schema import SyllabusCloSchema

syllabus_clo_bp = Blueprint('syllabus_clo', __name__, url_prefix='/syllabus-clos')

schema = SyllabusCloSchema()

@syllabus_clo_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_clos(syllabus_id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    List CLOs for a syllabus
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of CLOs
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/SyllabusClo'
    """
    items = syllabus_clo_service.get_by_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_clo_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_clo(syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Create a new CLO for a syllabus
    ---
    tags:
      - Syllabus CLOs
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusClo'
    responses:
      201:
        description: CLO created
      400:
        description: Validation or creation error
    """
    if request.method == 'OPTIONS':
        return '', 200
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = syllabus_clo_service.create_clo(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@syllabus_clo_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_clo(id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Update an existing CLO
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusClo'
    responses:
      200:
        description: CLO updated
      400:
        description: Validation error
      404:
        description: CLO not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = syllabus_clo_service.update_clo(id, data)
    if not item:
        return jsonify({'message': 'CLO not found'}), 404
    return jsonify(schema.dump(item)), 200

@syllabus_clo_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_clo(id: int, syllabus_clo_service: SyllabusCloService = Provide[Container.syllabus_clo_service]):
    """
    Delete a CLO by id
    ---
    tags:
      - Syllabus CLOs
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: CLO not found
    """
    ok = syllabus_clo_service.delete_clo(id)
    if not ok:
        return jsonify({'message': 'CLO not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/syllabus_comment_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_comment_service import SyllabusCommentService
from api.schemas.syllabus_comment_schema import SyllabusCommentSchema

syllabus_comment_bp = Blueprint('syllabus_comment', __name__, url_prefix='/syllabus-comments')
schema = SyllabusCommentSchema()

@syllabus_comment_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_comments(syllabus_id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    List comments for syllabus
    ---
    tags:
      - Comments
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema: {type: integer}
    responses:
      200: {description: List of comments}
    """
    items = service.get_comments(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_comment_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def add_comment(service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Add a comment
    ---
    tags:
      - Comments
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusComment'
    responses:
      201: {description: Created}
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = service.add_comment(data)
        return jsonify(schema.dump(item)), 201
    except ValueError as e:
        return jsonify({'error': str(e)}), 400

@syllabus_comment_bp.route('/<int:id>/resolve', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def resolve_comment(id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Mark comment as resolved
    ---
    tags:
      - Comments
    responses:
      200: {description: Resolved}
    """
    item = service.resolve_comment(id)
    if not item:
        return jsonify({'message': 'Comment not found'}), 404
    return jsonify(schema.dump(item)), 200

@syllabus_comment_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_comment(id: int, service: SyllabusCommentService = Provide[Container.syllabus_comment_service]):
    """
    Delete comment
    ---
    tags:
      - Comments
    responses:
      204: {description: Deleted}
    """
    ok = service.delete_comment(id)
    if not ok:
        return jsonify({'message': 'Comment not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/syllabus_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_service import SyllabusService
from services.ai_service import AiService
from services.syllabus_snapshot_service import SyllabusSnapshotService
from api.schemas.syllabus_schema import SyllabusSchema, SyllabusListSchema
from api.schemas.syllabus_detail_schema import SyllabusDetailSchema
from api.middleware import token_required, role_required
from utils.pagination import get_pagination_params, Pagination
from utils.performance import log_api_request

syllabus_bp = Blueprint('syllabus', __name__, url_prefix='/syllabuses')

schema = SyllabusSchema()
list_schema = SyllabusListSchema()
detail_schema = SyllabusDetailSchema()

@syllabus_bp.route('/check-deadlines', methods=['POST'])
@inject
@role_required('Admin') # Only admin can trigger global deadline check for now
def check_deadlines(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Check all active workflows for overdue deadlines
    ---
    post:
      summary: Check for overdue syllabus reviews
      tags:
        - Syllabuses
      responses:
        200:
          description: Number of notifications sent
    """
    notification_count = syllabus_service.check_workflow_deadlines()
    return jsonify({
        "status": "success",
        "notifications_sent": notification_count
    })

@syllabus_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
@log_api_request
def list_syllabuses(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """List syllabuses with pagination
    ---
    get:
      summary: List syllabuses (supports pagination)
      tags:
        - Syllabuses
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        200:
          description: Paginated list of syllabuses
    """
    # Get pagination params
    page, page_size, _ = get_pagination_params(default_page_size=20, max_page_size=100)
    
    # Extract filters
    filters = {}
    if 'status' in request.args:
        filters['status'] = request.args.get('status')

    # Check if pagination requested
    if 'page' in request.args or 'page_size' in request.args:
        items, total = syllabus_service.list_syllabuses_paginated(page, page_size, filters=filters)
        # Transform data for list view
        transformed_items = []
        for item in items:
            transformed_items.append({
                'id': item.id,
                'subject_code': item.subject.code if item.subject else '',
                'subject_name_vi': item.subject.name_vi if item.subject else '',
                'subject_name_en': item.subject.name_en if item.subject else '',
                'credits': item.subject.credits if item.subject else 0,
                'lecturer': item.lecturer.full_name if item.lecturer else '',
                'status': item.status,
                'version': item.version,
                'date_edited': item.updated_at
            })
        pagination = Pagination(list_schema.dump(transformed_items, many=True), page, page_size, total)
        return jsonify(pagination.to_dict()), 200
    else:
        # Legacy support: return all items (apply filters if any)
        items = syllabus_service.list_syllabuses(filters=filters)
        transformed_items = []
        for item in items:
            transformed_items.append({
                'id': item.id,
                'subject_code': item.subject.code if item.subject else '',
                'subject_name_vi': item.subject.name_vi if item.subject else '',
                'subject_name_en': item.subject.name_en if item.subject else '',
                'credits': item.subject.credits if item.subject else 0,
                'lecturer': item.lecturer.full_name if item.lecturer else '',
                'status': item.status,
                'version': item.version,
                'date_edited': item.updated_at
            })
        # Wrap in 'data' key for frontend consistency
        return jsonify({
            'data': list_schema.dump(transformed_items, many=True),
            'total': len(transformed_items)
        }), 200

@syllabus_bp.route('/<int:id>', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get syllabus
    ---
    get:
      summary: Get syllabus by id
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Syllabus object
        404:
          description: Not found
    """
    s = syllabus_service.get_syllabus(id)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200


@syllabus_bp.route('/<int:id>/details', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_syllabus_details(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get full syllabus details
    ---
    get:
      summary: Get syllabus details by id
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Syllabus detail object
        404:
          description: Not found
    """
    s = syllabus_service.get_syllabus_details(id)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(detail_schema.dump(s)), 200


@syllabus_bp.route('/compare', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def compare_syllabuses(syllabus_service: SyllabusService = Provide[Container.syllabus_service], ai_service: AiService = Provide[Container.ai_service]):
    """Compare two syllabuses by id with AI Change Detection
    ---
    get:
      summary: Compare two syllabuses
      tags:
        - Syllabuses
    """
    try:
        base_id = int(request.args.get('baseId') or request.args.get('base_id'))
        target_id = int(request.args.get('targetId') or request.args.get('target_id'))
    except Exception:
        return jsonify({'message': 'base_id and target_id are required integers'}), 400

    base = syllabus_service.get_syllabus_details(base_id)
    target = syllabus_service.get_syllabus_details(target_id)

    if not base or not target:
        return jsonify({'message': 'One or both syllabuses not found'}), 404

    # Basic Comparison
    fields = ['subject_name_vi', 'credits', 'description', 'student_duties', 'course_type', 'component_type']
    diffs = []
    for f in fields:
        base_val = getattr(base, f, None)
        target_val = getattr(target, f, None)
        if base_val != target_val:
            diffs.append({
                'field': f, 
                'old_value': str(base_val or 'N/A'), 
                'new_value': str(target_val or 'N/A'),
                'type': 'Modified'
            })

    # AI Analysis (if requested or by default)
    # We pass serialized versions of both syllabuses to AI
    base_dict = schema.dump(base)
    target_dict = schema.dump(target)
    
    ai_report = ai_service.compare_syllabuses(base_dict, target_dict)

    return jsonify({
        'base_version': base.version or '1.0',
        'target_version': target.version or '2.0',
        'diffs': diffs,
        'ai_report': ai_report
    }), 200


@syllabus_bp.route('/<int:id>/submit', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Lecturer', 'Admin'])
@inject
def submit_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Submit a syllabus for evaluation (requires authentication)
    ---
    post:
      summary: Submit syllabus
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
      responses:
        200:
          description: Submitted syllabus
        400:
          description: Invalid action
        401:
          description: Unauthorized
        404:
          description: Not found
    """
    from flask import g
    user_id = getattr(g, 'user_id', None)
    
    if not user_id:
        return jsonify({'message': 'User not authenticated'}), 401
    
    try:
        s = syllabus_service.submit_syllabus(id, user_id)
    except ValueError as e:
        return jsonify({'message': str(e)}), 422
    except Exception as e:
        return jsonify({'message': f'Error submitting syllabus: {str(e)}'}), 500
    
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    
    return jsonify({'message': 'Syllabus submitted successfully', 'data': schema.dump(s)}), 200


@syllabus_bp.route('/<int:id>/evaluate', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Head of Dept', 'Academic Affairs', 'Principal', 'Admin'])
@inject
def evaluate_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Evaluate (approve/reject) a syllabus (requires authentication)
    ---
    post:
      summary: Evaluate syllabus
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
      responses:
        200:
          description: Evaluation result
        400:
          description: Invalid action or missing comment
        401:
          description: Unauthorized
        404:
          description: Not found
    """
    from flask import g
    user_id = getattr(g, 'user_id', None)
    
    if not user_id:
        return jsonify({'message': 'User not authenticated'}), 401
    
    data = request.get_json() or {}
    action = data.get('action')
    comment = data.get('comment')
    
    if not action:
        return jsonify({'message': 'action is required'}), 422
    
    try:
        s = syllabus_service.evaluate_syllabus(id, user_id, action, comment)
    except ValueError as e:
        return jsonify({'message': str(e)}), 422
    except Exception as e:
        return jsonify({'message': f'Error evaluating syllabus: {str(e)}'}), 500
    
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    
    return jsonify({'message': 'Evaluation completed', 'data': schema.dump(s)}), 200


@syllabus_bp.route('/<int:id>/workflow-logs', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_workflow_logs(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Get workflow logs for a syllabus
    ---
    get:
      summary: Get workflow logs
      tags:
        - Syllabuses
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: List of workflow logs
        404:
          description: Not found
    """
    logs = syllabus_service.get_workflow_logs(id)
    from api.schemas.workflow_log_schema import WorkflowLogSchema
    schema_w = WorkflowLogSchema()
    return jsonify(schema_w.dump(logs, many=True)), 200

@syllabus_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Lecturer', 'Admin'])
@inject
def create_syllabus(syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    """Create a syllabus
    ---
    post:
      summary: Create syllabus
      tags:
        - Syllabuses
      requestBody:
        required: true
      responses:
        201:
          description: Created
        400:
          description: Invalid input
    """
    from marshmallow import ValidationError
    raw_data = request.get_json() or {}
    try:
        # Load data using schema to handle transformation and filtering
        data = schema.load(raw_data)
    except ValidationError as err:
        return jsonify(err.messages), 400
        
    try:
        s = syllabus_service.create_syllabus(data)
    except ValueError as e:
        return jsonify({'message': str(e)}), 400
    except Exception as e:
        return jsonify({'message': f'Error creating syllabus: {str(e)}'}), 400
    return jsonify(schema.dump(s)), 201

@syllabus_bp.route('/<int:id>', methods=['PUT', 'PATCH', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Lecturer', 'Admin'])
@inject
def update_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    from marshmallow import ValidationError
    raw_data = request.get_json() or {}
    try:
        # load(partial=True) handles PATCH correctly by only validating provided fields
        data = schema.load(raw_data, partial=True)
    except ValidationError as err:
        return jsonify(err.messages), 400
        
    s = syllabus_service.update_syllabus(id, data)
    if not s:
        return jsonify({'message': 'Syllabus not found'}), 404
    return jsonify(schema.dump(s)), 200

@syllabus_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin'])
@inject
def delete_syllabus(id: int, syllabus_service: SyllabusService = Provide[Container.syllabus_service]):
    ok = syllabus_service.delete_syllabus(id)
    if not ok:
        return jsonify({'message': 'Syllabus not found'}), 404
    return '', 204

@syllabus_bp.route('/<int:id>/history', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
@token_required
def get_syllabus_history(id: int, current_user, snapshot_service: SyllabusSnapshotService = Provide[Container.syllabus_snapshot_service]):
    """Get history of snapshots for a syllabus"""
    history = snapshot_service.get_syllabus_history(id)
    return jsonify([{
        'id': s.id,
        'version': s.version,
        'created_at': s.created_at.isoformat(),
        'created_by': s.creator.full_name if s.creator else "System"
    } for s in history])

@syllabus_bp.route('/compare-versions', methods=['GET', 'OPTIONS'])
@inject
@token_required
def compare_versions(current_user, snapshot_service: SyllabusSnapshotService = Provide[Container.syllabus_snapshot_service]):
    """Compare two snapshots or a snapshot with current version"""
    s1_id = request.args.get('s1', type=int)
    s2_id_raw = request.args.get('s2')
    syllabus_id = request.args.get('syllabus_id', type=int)

    if not s1_id or not s2_id_raw:
        return jsonify({'message': 'Missing comparison IDs'}), 400

    try:
        if s2_id_raw == 'current':
            if not syllabus_id:
                return jsonify({'message': 'syllabus_id required for current comparison'}), 400
            diff = snapshot_service.compare_with_current(s1_id, syllabus_id)
        else:
            diff = snapshot_service.compare_snapshots(s1_id, int(s2_id_raw))
        return jsonify(diff)
    except Exception as e:
        return jsonify({'message': str(e)}), 400

@syllabus_bp.route('/snapshots/<int:snapshot_id>', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
@token_required
def get_snapshot_details(snapshot_id: int, current_user, snapshot_service: SyllabusSnapshotService = Provide[Container.syllabus_snapshot_service]):
    """Get full data of a specific snapshot"""
    snapshot = snapshot_service.get_snapshot(snapshot_id)
    if not snapshot:
        return jsonify({'message': 'Snapshot not found'}), 404
    return jsonify(snapshot.snapshot_data)
</file>

<file path="apps/api/src/api/controllers/syllabus_material_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.syllabus_material_service import SyllabusMaterialService
from api.schemas.syllabus_material_schema import SyllabusMaterialSchema

syllabus_material_bp = Blueprint('syllabus_material', __name__, url_prefix='/syllabus-materials')

schema = SyllabusMaterialSchema()

@syllabus_material_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_materials(syllabus_id: int, syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    List materials for a syllabus
    ---
    tags:
      - Syllabus Materials
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of materials
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/SyllabusMaterial'
    """
    items = syllabus_material_service.get_by_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@syllabus_material_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_material(syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    Create a syllabus material
    ---
    tags:
      - Syllabus Materials
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SyllabusMaterial'
    responses:
      201:
        description: Material created
      400:
        description: Validation or creation error
    """
    if request.method == 'OPTIONS':
        return '', 200
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = syllabus_material_service.create_material(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@syllabus_material_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_material(id: int, syllabus_material_service: SyllabusMaterialService = Provide[Container.syllabus_material_service]):
    """
    Delete a syllabus material
    ---
    tags:
      - Syllabus Materials
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Material not found
    """
    ok = syllabus_material_service.delete_material(id)
    if not ok:
        return jsonify({'message': 'Material not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/system_setting_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.system_setting_service import SystemSettingService
from api.schemas.system_setting_schema import SystemSettingSchema

system_setting_bp = Blueprint('system_setting', __name__, url_prefix='/system-settings')
schema = SystemSettingSchema()

@system_setting_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def list_settings(service: SystemSettingService = Provide[Container.system_setting_service]):
    """
    List all system settings
    ---
    tags:
      - System Settings
    responses:
      200:
        description: List of settings
    """
    items = service.get_all_settings()
    return jsonify(schema.dump(items, many=True)), 200

@system_setting_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def update_setting(service: SystemSettingService = Provide[Container.system_setting_service]):
    """
    Update or create a system setting
    ---
    tags:
      - System Settings
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SystemSetting'
    responses:
      200:
        description: Setting updated
      400:
        description: Validation error
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    item = service.update_setting(data['key'], data['value'], data.get('description'))
    return jsonify(schema.dump(item)), 200
</file>

<file path="apps/api/src/api/controllers/teaching_plan_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.teaching_plan_service import TeachingPlanService
from api.schemas.teaching_plan_schema import TeachingPlanSchema

teaching_plan_bp = Blueprint('teaching_plan', __name__, url_prefix='/teaching-plans')

schema = TeachingPlanSchema()

@teaching_plan_bp.route('/syllabus/<int:syllabus_id>', methods=['GET'])
@inject
def list_plans(syllabus_id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    List teaching plans for a syllabus
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: syllabus_id
        in: path
        required: true
        schema:
          type: integer
    responses:
      200:
        description: List of teaching plans
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/TeachingPlan'
    """
    items = teaching_plan_service.list_plans_for_syllabus(syllabus_id)
    return jsonify(schema.dump(items, many=True)), 200

@teaching_plan_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def create_plan(teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Create a teaching plan
    ---
    tags:
      - Teaching Plans
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TeachingPlan'
    responses:
      201:
        description: Teaching plan created
      400:
        description: Validation or creation error
    """
    if request.method == 'OPTIONS':
        return '', 200
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    try:
        item = teaching_plan_service.create_teaching_plan(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    return jsonify(schema.dump(item)), 201

@teaching_plan_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@inject
def update_plan(id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Update a teaching plan
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TeachingPlan'
    responses:
      200:
        description: Teaching plan updated
      400:
        description: Validation error
      404:
        description: Teaching plan not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    item = teaching_plan_service.update_teaching_plan(id, data)
    if not item:
        return jsonify({'message': 'Teaching plan not found'}), 404
    return jsonify(schema.dump(item)), 200

@teaching_plan_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@inject
def delete_plan(id: int, teaching_plan_service: TeachingPlanService = Provide[Container.teaching_plan_service]):
    """
    Delete a teaching plan
    ---
    tags:
      - Teaching Plans
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    responses:
      204:
        description: Deleted
      404:
        description: Teaching plan not found
    """
    ok = teaching_plan_service.delete_teaching_plan(id)
    if not ok:
        return jsonify({'message': 'Teaching plan not found'}), 404
    return '', 204
</file>

<file path="apps/api/src/api/controllers/user_controller.py">
from flask import Blueprint, request, jsonify
from dependency_injector.wiring import inject, Provide
from dependency_container import Container
from services.user_service import UserService
from services.system_auditlog_service import SystemAuditLogService
from api.schemas.user_schema import UserSchema
from api.middleware import token_required, role_required

user_bp = Blueprint('user', __name__, url_prefix='/users')

schema = UserSchema()

@user_bp.route('/', methods=['GET', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin'])
@inject
def list_users(user_service: UserService = Provide[Container.user_service]):
    """Get all users
    ---
    get:
      summary: Get all users
      tags:
        - Users
      responses:
        200:
          description: List of users
    """
    users = user_service.list_users()
    return jsonify(schema.dump(users, many=True)), 200

@user_bp.route('/<int:id>', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
def get_user(id: int, user_service: UserService = Provide[Container.user_service]):
    """Get user by id
    ---
    get:
      summary: Get user by ID
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: User object
        404:
          description: Not found
    """
    user = user_service.get_user(id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    return jsonify(schema.dump(user)), 200


@user_bp.route('/<int:id>', methods=['DELETE', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin'])
@inject
def delete_user(id: int, 
                user_service: UserService = Provide[Container.user_service],
                audit_service: SystemAuditLogService = Provide[Container.system_auditlog_service]):
    """
    Delete a user
    ---
    delete:
      summary: Delete user by ID
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: User deleted successfully
        404:
          description: User not found
    """
    # Get user info before deleting for logging
    user = user_service.get_user_by_id(id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    
    # Delete the user
    success = user_service.delete_user(id)
    if not success:
        return jsonify({'message': 'Failed to delete user'}), 500
    
    # Log the action
    try:
        # Get current user from token if available
        current_user_id = getattr(request, 'user_id', None)
        audit_service.create_log(
            user_id=current_user_id,
            action_type='DELETE_USER',
            resource_target=f'User #{id} ({user.username})',
            ip_address=request.remote_addr,
            user_agent=request.headers.get('User-Agent'),
            details=f'Deleted user: {user.full_name} (Username: {user.username}, Email: {user.email})'
        )
    except Exception as e:
        print(f"Failed to log audit: {e}")
    
    return jsonify({'message': 'User deleted successfully'}), 200


@user_bp.route('/me', methods=['GET', 'OPTIONS'], strict_slashes=False)
@inject
@token_required
def get_me(user_service: UserService = Provide[Container.user_service]):
    """
    Get current user from token
    """
    from flask import g
    user_id = getattr(g, 'user_id', None)
    if not user_id:
        return jsonify({'message': 'User not found in token'}), 401
    user = user_service.get_user(user_id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    
    # Get role name from user
    role_name = None
    try:
        if user.roles and len(user.roles) > 0 and getattr(user.roles[0], 'role', None):
            role_name = user.roles[0].role.name
    except Exception:
        role_name = None
    
    # Build response with role
    user_data = schema.dump(user)
    user_data['role'] = role_name
    
    return jsonify(user_data), 200

@user_bp.route('/', methods=['POST', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin'])
@inject
def create_user(user_service: UserService = Provide[Container.user_service],
                audit_service: SystemAuditLogService = Provide[Container.system_auditlog_service]):
    """Create a new user
    ---
    post:
      summary: Create a new user
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/User'
      responses:
        201:
          description: User created
        400:
          description: Invalid input
    """
    data = request.get_json() or {}
    errors = schema.validate(data)
    if errors:
        return jsonify(errors), 400
    user = user_service.create_user(data)
    
    # Log the action
    try:
        current_user_id = getattr(request, 'user_id', None)
        audit_service.create_log(
            user_id=current_user_id,
            action_type='CREATE_USER',
            resource_target=f'User #{user.id} ({user.username})',
            ip_address=request.remote_addr,
            user_agent=request.headers.get('User-Agent'),
            details=f'Created new user: {user.full_name} (Username: {user.username}, Email: {user.email})'
        )
    except Exception as e:
        print(f"Failed to log audit: {e}")
    
    return jsonify(schema.dump(user)), 201

@user_bp.route('/<int:id>', methods=['PUT', 'OPTIONS'], strict_slashes=False)
@token_required
@role_required(['Admin'])
@inject
def update_user(id: int, 
                user_service: UserService = Provide[Container.user_service],
                audit_service: SystemAuditLogService = Provide[Container.system_auditlog_service]):
    """Update an existing user
    ---
    put:
      summary: Update user
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/User'
      responses:
        200:
          description: User updated
        400:
          description: Invalid input
        404:
          description: User not found
    """
    data = request.get_json() or {}
    errors = schema.validate(data, partial=True)
    if errors:
        return jsonify(errors), 400
    user = user_service.update_user(id, data)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    
    # Log the action
    try:
        current_user_id = getattr(request, 'user_id', None)
        # Build details of what was updated
        updated_fields = ', '.join([f"{k}={v}" for k, v in data.items() if k not in ['password', 'password_hash']])
        audit_service.create_log(
            user_id=current_user_id,
            action_type='UPDATE_USER',
            resource_target=f'User #{user.id} ({user.username})',
            ip_address=request.remote_addr,
            user_agent=request.headers.get('User-Agent'),
            details=f'Updated user: {user.full_name} - Changes: {updated_fields}'
        )
    except Exception as e:
        print(f"Failed to log audit: {e}")
    
    return jsonify(schema.dump(user)), 200


@user_bp.route('/<int:user_id>/roles', methods=['POST', 'OPTIONS'], strict_slashes=False)
@inject
def assign_roles_to_user(user_id: int, user_service: UserService = Provide[Container.user_service]):
    """
    Assign roles to a user
    ---
    post:
      summary: Assign roles to user
      tags:
        - Users
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role_ids:
                  type: array
                  items:
                    type: integer
      responses:
        200:
          description: Roles assigned successfully
        404:
          description: User not found
    """
    # Handle OPTIONS request for CORS preflight
    if request.method == 'OPTIONS':
        response = jsonify({'message': 'OK'})
        response.headers['Access-Control-Allow-Origin'] = request.headers.get('Origin', '*')
        response.headers['Access-Control-Allow-Methods'] = 'POST, OPTIONS'
        response.headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
        response.headers['Access-Control-Max-Age'] = '3600'
        return response, 200
    
    from infrastructure.models.user_role_model import UserRole
    from infrastructure.databases.mssql import session as db_session
    
    data = request.get_json() or {}
    role_ids = data.get('role_ids', [])
    
    if not role_ids:
        return jsonify({'message': 'No role_ids provided'}), 400
    
    # Check if user exists
    user = user_service.get_user(user_id)
    if not user:
        return jsonify({'message': 'User not found'}), 404
    
    try:
        # Remove existing roles for this user
        deleted_count = db_session.query(UserRole).filter_by(user_id=user_id).delete(synchronize_session='fetch')
        print(f"Deleted {deleted_count} existing roles for user {user_id}")
        
        # Add new roles
        for role_id in role_ids:
            user_role = UserRole(user_id=user_id, role_id=role_id)
            db_session.add(user_role)
            print(f"Added role {role_id} to user {user_id}")
        
        # Flush to get any errors before commit
        db_session.flush()
        
        # Commit the transaction
        db_session.commit()
        
        print(f"Successfully committed roles for user {user_id}")
        return jsonify({
            'message': 'Roles assigned successfully', 
            'user_id': user_id,
            'role_ids': role_ids
        }), 200
    except Exception as e:
        db_session.rollback()
        print(f"Error assigning roles: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'message': f'Error assigning roles: {str(e)}'}), 500
</file>

<file path="apps/api/src/api/middleware.py">
# Middleware functions for processing requests and responses

from flask import  request, jsonify

def log_request_info(app):
    app.logger.debug('Headers: %s', request.headers)
    app.logger.debug('Body: %s', request.get_data())

def handle_options_request():
    return jsonify({'message': 'CORS preflight response'}), 200

from flask import current_app
from werkzeug.exceptions import HTTPException
import traceback

def error_handling_middleware(error):
    # Handle HTTP exceptions (e.g., BadRequest) with their status codes
    if isinstance(error, HTTPException):
        response = jsonify({'error': error.description})
        response.status_code = error.code or 400
        return response

    # Log unexpected exceptions with traceback
    try:
        current_app.logger.exception(error)
    except Exception:
        pass

    tb = None
    try:
        tb = traceback.format_exc()
    except Exception:
        tb = None

    payload = {'error': str(error)}
    if getattr(current_app, 'debug', False) and tb:
        payload['traceback'] = tb

    response = jsonify(payload)
    response.status_code = 500
    return response

def add_custom_headers(response):
    response.headers['X-Custom-Header'] = 'Value'
    return response

from functools import wraps


def middleware(app):
    @app.before_request
    def before_request():
        log_request_info(app)

    @app.after_request
    def after_request(response):
        return add_custom_headers(response)

    @app.errorhandler(Exception)
    def handle_exception(error):
        return error_handling_middleware(error)

    @app.route('/options', methods=['OPTIONS'])
    def options_route():
        return handle_options_request()


# Token decorator verifying JWT
import jwt
from config import Config

def token_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        from flask import request, make_response, g
        # Allow preflight CORS requests through without authentication
        if request.method == 'OPTIONS':
            return make_response('', 200)
        auth = request.headers.get('Authorization', '')
        if not auth or not auth.startswith('Bearer '):
            return jsonify({'message': 'Authorization token is missing'}), 401
        token = auth.split(' ', 1)[1]
        try:
            payload = jwt.decode(token, Config.SECRET_KEY, algorithms=['HS256'])
            # Attach user info to Flask g context
            g.user_id = payload.get('user_id')
            g.username = payload.get('username')
            g.role = payload.get('role')
        except jwt.ExpiredSignatureError:
            return jsonify({'message': 'Token expired'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'message': 'Invalid token'}), 401
        return f(*args, **kwargs)

    return decorated


# Role-based access control decorator
def role_required(allowed_roles):
    """
    Decorator to restrict access to specific roles.
    Usage: @role_required(['Admin', 'Head of Dept'])
    
    Args:
        allowed_roles: List of role names that are allowed to access the endpoint
    """
    def decorator(f):
        @wraps(f)
        def decorated(*args, **kwargs):
            from flask import g, jsonify, request, make_response
            
            # Allow preflight CORS requests through
            if request.method == 'OPTIONS':
                return make_response('', 200)
            
            # Get role from Flask g context (set by @token_required)
            user_role = getattr(g, 'role', None)
            
            if not user_role:
                return jsonify({
                    'message': 'Role information not found. Please login again.'
                }), 403
            
            # Check if user's role is in allowed roles
            if user_role not in allowed_roles:
                return jsonify({
                    'message': f'Access denied. Required roles: {", ".join(allowed_roles)}',
                    'your_role': user_role
                }), 403
            
            return f(*args, **kwargs)
        return decorated
    return decorator
</file>

<file path="apps/api/src/api/requests.py">
# requests.py

from flask import request, jsonify

def get_request_data():
    """Extracts and returns JSON data from the request."""
    data = request.get_json()
    if not data:
        return jsonify({"error": "No data provided"}), 400
    return data

def validate_request_schema(schema):
    """Validates the incoming request data against the provided schema."""
    data = get_request_data()
    errors = schema.validate(data)
    if errors:
        return jsonify({"errors": errors}), 400
    return data

def handle_get_request():
    """Handles GET requests."""
    # Logic for handling GET requests goes here
    pass

def handle_post_request():
    """Handles POST requests."""
    # Logic for handling POST requests goes here
    pass

def handle_put_request():
    """Handles PUT requests."""
    # Logic for handling PUT requests goes here
    pass

def handle_delete_request():
    """Handles DELETE requests."""
    # Logic for handling DELETE requests goes here
    pass
</file>

<file path="apps/api/src/api/responses.py">
# src/api/responses.py

from flask import jsonify

def success_response(data, message="Success"):
    return jsonify({"message": message, "data": data}), 200

def error_response(message="An error occurred", status_code=400):
    return jsonify({"message": message}), status_code

def not_found_response(message="Resource not found"):
    return jsonify({"message": message}), 404

def validation_error_response(errors):
    return jsonify({"message": "Validation errors", "errors": errors}), 422
</file>

<file path="apps/api/src/api/routes.py">
def register_routes(app):
    """Register API routes. No legacy route blueprints are registered for SMD."""
    return
</file>

<file path="apps/api/src/api/schemas/...  # Marshmallow schemas">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/api/schemas/academic_year_schema.py">
from marshmallow import fields
from api.schemas.base_schema import BaseSchema

class AcademicYearSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    code = fields.Str(required=True)
    start_date = fields.Date(required=False, allow_none=True)  # Optional
    end_date = fields.Date(required=False, allow_none=True)    # Optional
    is_active = fields.Bool(required=False)                    # Optional
</file>

<file path="apps/api/src/api/schemas/assessment_clo_mapping_schema.py">
from marshmallow import Schema, fields

class AssessmentCloMappingSchema(Schema):
    assessment_component_id = fields.Int(required=True)
    syllabus_clo_id = fields.Int(required=True)
</file>

<file path="apps/api/src/api/schemas/assessment_component_schema.py">
from marshmallow import fields
from marshmallow.validate import Range
from .rubric_schema import RubricSchema
from .base_schema import BaseSchema

class AssessmentComponentSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    scheme_id = fields.Int(allow_none=True)
    name = fields.Str(required=True)
    weight = fields.Float(required=True, validate=Range(min=0, max=100))
    criteria = fields.Str(allow_none=True)
    # Flexible field to accept either a list of IDs or a string of CLO codes
    clo_ids = fields.Raw(allow_none=True)
    rubrics = fields.List(fields.Nested('RubricSchema'), load_default=[])
</file>

<file path="apps/api/src/api/schemas/assessment_scheme_schema.py">
from marshmallow import fields
from marshmallow.validate import Range
from .assessment_component_schema import AssessmentComponentSchema
from .base_schema import BaseSchema

class AssessmentSchemeSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(allow_none=True)
    name = fields.Str(required=True)
    weight = fields.Float(load_default=100.0, validate=Range(min=0, max=100))
    components = fields.List(fields.Nested('AssessmentComponentSchema'), load_default=[])
</file>

<file path="apps/api/src/api/schemas/base_schema.py">
from marshmallow import Schema, post_dump, EXCLUDE
import re

def snake_to_camel(s: str) -> str:
    parts = s.split('_')
    return parts[0] + ''.join(p.capitalize() for p in parts[1:])

def _convert(obj):
    if isinstance(obj, dict):
        new = {}
        for k, v in obj.items():
            nk = snake_to_camel(k)
            new[nk] = _convert(v)
        return new
    elif isinstance(obj, list):
        return [_convert(x) for x in obj]
    else:
        return obj

class BaseSchema(Schema):
    class Meta:
        unknown = EXCLUDE

    @post_dump
    def to_camel(self, data, many=False, **kwargs):
        # marshmallow may or may not pass `many`; accept it optionally
        if many and isinstance(data, list):
            return [_convert(x) for x in data]
        return _convert(data)
</file>

<file path="apps/api/src/api/schemas/clo_plo_mapping_schema.py">
from marshmallow import Schema, fields
from marshmallow.validate import OneOf

class CloPloMappingSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_clo_id = fields.Int(required=True)
    program_plo_id = fields.Int(required=True)
    program_plo_code = fields.String(attribute="program_plo.code", dump_only=True)
    level = fields.Str(required=True, validate=OneOf(['I', 'R', 'M', 'A']))
</file>

<file path="apps/api/src/api/schemas/department_schema.py">
from marshmallow import Schema, fields

class DepartmentSchema(Schema):
    id = fields.Int(dump_only=True)
    faculty_id = fields.Int(required=True)
    code = fields.Str(required=True)
    name = fields.Str(required=True)
    
    # Nested faculty info
    faculty = fields.Nested('FacultySchema', only=('id', 'name', 'code'), dump_only=True)
</file>

<file path="apps/api/src/api/schemas/faculty_schema.py">
from marshmallow import Schema, fields

class FacultySchema(Schema):
    id = fields.Int(dump_only=True)
    code = fields.Str(required=True)
    name = fields.Str(required=True)
    # Optional fields example: use load_default for Marshmallow
    description = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/file_schema.py">
from marshmallow import Schema, fields

class FileSchema(Schema):
    id = fields.Int(dump_only=True)
    uploader_id = fields.Int(dump_only=True)
    file_name = fields.Str(dump_only=True)
    file_path = fields.Str(dump_only=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/notification_schema.py">
from marshmallow import Schema, fields

class NotificationSchema(Schema):
    id = fields.Int(dump_only=True)
    user_id = fields.Int(required=True)
    title = fields.Str(required=True)
    message = fields.Str(load_default=None)
    link = fields.Str(load_default=None)
    is_read = fields.Bool(dump_only=True)
    type = fields.Str(load_default='SYSTEM')
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/program_outcome_schema.py">
from marshmallow import Schema, fields

class ProgramOutcomeSchema(Schema):
    id = fields.Int(dump_only=True)
    program_id = fields.Int(required=True)
    code = fields.Str(required=True)
    description = fields.Str(required=True)
</file>

<file path="apps/api/src/api/schemas/program_schema.py">
from marshmallow import Schema, fields

class ProgramSchema(Schema):
    id = fields.Int(dump_only=True)
    department_id = fields.Int(required=True)
    name = fields.Str(required=True)
    total_credits = fields.Int(load_default=0)
    
    # Nested department info
    department = fields.Nested('DepartmentSchema', only=('id', 'name', 'code'), dump_only=True)
</file>

<file path="apps/api/src/api/schemas/role_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class RoleSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    name = fields.Str(required=True)
    description = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/rubric_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class RubricSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    component_id = fields.Int(allow_none=True)
    criteria = fields.Str(required=True)
    max_score = fields.Float(required=True)
    description_level_pass = fields.Str(load_default=None)
    description_level_fail = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/student_schema.py">
from marshmallow import Schema, fields

class StudentSubscriptionSchema(Schema):
    id = fields.Int(dump_only=True)
    student_id = fields.Int(required=True)
    subject_id = fields.Int(required=True)
    created_at = fields.DateTime(dump_only=True)

class StudentReportSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    student_id = fields.Int(required=True)
    content = fields.Str(required=True)
    status = fields.Str(dump_only=True)
    admin_note = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/subject_relationship_schema.py">
from marshmallow import Schema, fields, post_dump
from marshmallow.validate import OneOf

class SubjectRelationshipSchema(Schema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    related_subject_id = fields.Int(required=True)
    type = fields.Str(required=True, validate=OneOf(['PREREQUISITE', 'COREQUISITE', 'PARALLEL']))

    # Denormalized fields for UI
    related_subject_code = fields.Str(dump_only=True, attribute='related_subject.code')
    related_subject_name = fields.Str(dump_only=True, attribute='related_subject.name_vi')

    @post_dump
    def to_camel(self, data, **kwargs):
        # simple camelCase converter for this schema
        return {
            "id": data.get("id"),
            "subjectId": data.get("subject_id"),
            "relatedSubjectId": data.get("related_subject_id"),
            "type": data.get("type"),
            "relatedSubjectCode": data.get("related_subject_code"),
            "relatedSubjectName": data.get("related_subject_name")
        }
</file>

<file path="apps/api/src/api/schemas/subject_schema.py">
# from marshmallow import Schema, fields

# class SubjectSchema(Schema):
#     id = fields.Int(dump_only=True)
#     department_id = fields.Int(required=True)
#     code = fields.Str(required=True)
#     name_vi = fields.Str(required=True)
#     name_en = fields.Str(required=True)
#     credits = fields.Int(required=True)
#     credit_theory = fields.Float(missing=0)
#     credit_practice = fields.Float(missing=0)
#     credit_self_study = fields.Float(missing=0)
from marshmallow import Schema, fields

class SubjectSchema(Schema):
    id = fields.Int(dump_only=True)
    department_id = fields.Int(required=True)
    code = fields.Str(required=True)
    name_vi = fields.Str(required=True)
    name_en = fields.Str(required=True)
    credits = fields.Int(required=True)
    # S·ª≠a missing=0 th√†nh load_default=0
    credit_theory = fields.Float(load_default=0)
    credit_practice = fields.Float(load_default=0)
    credit_self_study = fields.Float(load_default=0)
</file>

<file path="apps/api/src/api/schemas/syllabus_clo_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class SyllabusCloSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(allow_none=True)
    code = fields.Str(required=True)
    description = fields.Str(required=True)
    plo_mappings = fields.List(fields.Nested('CloPloMappingSchema'), dump_only=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/syllabus_comment_schema.py">
from marshmallow import Schema, fields

class SyllabusCommentSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    user_id = fields.Int(required=True)
    content = fields.Str(required=True)
    parent_id = fields.Int(load_default=None)
    is_resolved = fields.Bool(dump_only=True)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/syllabus_detail_schema.py">
from .syllabus_schema import SyllabusSchema

class SyllabusDetailSchema(SyllabusSchema):
    """Full detail schema inheriting from SyllabusSchema"""
    pass
</file>

<file path="apps/api/src/api/schemas/syllabus_material_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class SyllabusMaterialSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(allow_none=True)
    type = fields.Str(required=True)
    title = fields.Str(required=True)
    author = fields.Str(load_default=None)
    publisher = fields.Str(load_default=None)
    isbn = fields.Str(load_default=None)
    url = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/syllabus_schema.py">
import json
from marshmallow import fields, post_dump
from marshmallow.validate import Length
from .base_schema import BaseSchema
from .syllabus_clo_schema import SyllabusCloSchema
from .syllabus_material_schema import SyllabusMaterialSchema
from .teaching_plan_schema import TeachingPlanSchema
from .assessment_scheme_schema import AssessmentSchemeSchema
from .subject_schema import SubjectSchema
from .user_schema import UserSchema
from .program_schema import ProgramSchema
from .academic_year_schema import AcademicYearSchema

class SyllabusListSchema(BaseSchema):
    """Schema for syllabus list view with denormalized data"""
    id = fields.Int(dump_only=True)
    subject_code = fields.Str(dump_only=True)
    subject_name_vi = fields.Str(dump_only=True)
    subject_name_en = fields.Str(dump_only=True)
    credits = fields.Int(dump_only=True)
    lecturer = fields.Str(dump_only=True)
    status = fields.Str(dump_only=True)
    version = fields.Str(dump_only=True)
    date_edited = fields.DateTime(dump_only=True, attribute='updated_at')
    due_date = fields.DateTime(dump_only=True, attribute='current_workflow.due_date')

class SyllabusSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    subject_id = fields.Int(required=True)
    program_id = fields.Int(required=True)
    academic_year_id = fields.Int(required=True)
    lecturer_id = fields.Int(required=True)
    head_department_id = fields.Int(allow_none=True)
    dean_id = fields.Int(allow_none=True)

    status = fields.Str(dump_only=True)
    version = fields.Str(load_default="1.0", validate=Length(max=10))

    # Basic info for frontend display (read-only)
    subject_code = fields.Nested('SubjectSchema', only=('code',), dump_only=True, attribute='subject')
    subject_name_vi = fields.Nested('SubjectSchema', only=('name_vi',), dump_only=True, attribute='subject')
    subject_name_en = fields.Nested('SubjectSchema', only=('name_en',), dump_only=True, attribute='subject')
    credits = fields.Nested('SubjectSchema', only=('credits',), dump_only=True, attribute='subject')
    lecturer = fields.Nested('UserSchema', only=('full_name',), dump_only=True, attribute='lecturer')
    program_name = fields.Nested('ProgramSchema', only=('name',), dump_only=True, attribute='program')
    academic_year_name = fields.Nested('AcademicYearSchema', only=('code',), dump_only=True, attribute='academic_year')

    # Workflow deadline info
    due_date = fields.DateTime(dump_only=True, attribute='current_workflow.due_date')
    assigned_to = fields.Nested('UserSchema', only=('full_name',), dump_only=True, attribute='current_workflow.assigned_to_user')

    @post_dump
    def flatten_subject_info(self, data, **kwargs):
        # Flatten nested subject/lecturer fields into top-level strings
        # Note: Hooks in BaseSchema (to_camel) may run BEFORE or AFTER this 
        # depending on Marshmallow version and configuration. We check both keys.
        
        # subjectCode / subject_code
        sc = data.get('subjectCode') or data.get('subject_code')
        if isinstance(sc, dict):
            val = sc.get('code')
            if 'subjectCode' in data: data['subjectCode'] = val
            if 'subject_code' in data: data['subject_code'] = val
            
        # subjectNameVi / subject_name_vi
        snv = data.get('subjectNameVi') or data.get('subject_name_vi')
        if isinstance(snv, dict):
            val = snv.get('name_vi') or snv.get('nameVi')
            if 'subjectNameVi' in data: data['subjectNameVi'] = val
            if 'subject_name_vi' in data: data['subject_name_vi'] = val
            
        # subjectNameEn / subject_name_en
        sne = data.get('subjectNameEn') or data.get('subject_name_en')
        if isinstance(sne, dict):
            val = sne.get('name_en') or sne.get('nameEn')
            if 'subjectNameEn' in data: data['subjectNameEn'] = val
            if 'subject_name_en' in data: data['subject_name_en'] = val
            
        # credits
        cre = data.get('credits')
        if isinstance(cre, dict):
            val = cre.get('credits')
            data['credits'] = val
            
        # lecturer
        lec = data.get('lecturer')
        if isinstance(lec, dict):
            val = lec.get('full_name') or lec.get('fullName')
            data['lecturer'] = val

        # program_name
        prog = data.get('programName') or data.get('program_name')
        if isinstance(prog, dict):
            val = prog.get('name')
            if 'programName' in data: data['programName'] = val
            if 'program_name' in data: data['program_name'] = val

        # academic_year_name
        ay = data.get('academicYearName') or data.get('academic_year_name')
        if isinstance(ay, dict):
            val = ay.get('code')
            if 'academicYearName' in data: data['academicYearName'] = val
            if 'academic_year_name' in data: data['academic_year_name'] = val

        # assigned_to
        ast = data.get('assignedTo') or data.get('assigned_to')
        if isinstance(ast, dict):
            val = ast.get('full_name') or ast.get('fullName')
            if 'assignedTo' in data: data['assignedTo'] = val
            if 'assigned_to' in data: data['assigned_to'] = val
            
        return data

    # FIX: time_allocation as Dict -> Use Raw to accept DB-stored JSON string
    time_allocation = fields.Raw(allow_none=True)  # Changed from Dict to Raw to handle DB String
    prerequisites = fields.Str(load_default=None)
    
    # Content fields
    description = fields.Str(allow_none=True)
    objectives = fields.Raw(allow_none=True)  # JSON array
    student_duties = fields.Str(allow_none=True)
    other_requirements = fields.Str(allow_none=True)
    
    # Additional metadata
    pre_courses = fields.Str(allow_none=True)
    co_courses = fields.Str(allow_none=True)
    course_type = fields.Str(allow_none=True)
    component_type = fields.Str(allow_none=True)
    date_prepared = fields.Str(allow_none=True)
    date_edited = fields.Str(allow_none=True)
    dean = fields.Str(allow_none=True)
    dean_id = fields.Int(allow_none=True)
    head_department = fields.Str(allow_none=True)
    head_department_id = fields.Int(allow_none=True)
    
    publish_date = fields.DateTime(load_default=None)

    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)

    # FIX: Add nested fields for input (load_default=[])
    clos = fields.List(fields.Nested('SyllabusCloSchema'), load_default=[])
    materials = fields.List(fields.Nested('SyllabusMaterialSchema'), load_default=[])
    teaching_plans = fields.List(fields.Nested('TeachingPlanSchema'), load_default=[])
    assessment_schemes = fields.List(fields.Nested('AssessmentSchemeSchema'), load_default=[])

    @post_dump
    def parse_json(self, data, **kwargs):
        # Parse time_allocation JSON (checks both formats)
        ta = data.get('timeAllocation') or data.get('time_allocation')
        if isinstance(ta, str):
            try:
                val = json.loads(ta)
                if 'timeAllocation' in data: data['timeAllocation'] = val
                if 'time_allocation' in data: data['time_allocation'] = val
            except:
                pass
        
        # Parse objectives JSON array
        obj = data.get('objectives')
        if isinstance(obj, str):
            try:
                data['objectives'] = json.loads(obj)
            except:
                pass
        
        return data
</file>

<file path="apps/api/src/api/schemas/system_setting_schema.py">
from marshmallow import Schema, fields

class SystemSettingSchema(Schema):
    key = fields.Str(required=True)
    value = fields.Str(required=True)
    type = fields.Str(dump_only=True)
    description = fields.Str(load_default=None)
</file>

<file path="apps/api/src/api/schemas/teaching_plan_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema

class TeachingPlanSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(allow_none=True)
    week = fields.Int(required=True)
    topic = fields.Str(load_default=None)
    clos = fields.Str(load_default=None)
    activity = fields.Str(load_default=None)
    assessment = fields.Str(load_default=None)
    created_at = fields.DateTime(dump_only=True)
    updated_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/schemas/user_schema.py">
from marshmallow import fields
from .base_schema import BaseSchema
from .role_schema import RoleSchema

class UserRoleSchema(BaseSchema):
    """Nested schema for user_role relationship"""
    role_id = fields.Int()
    role = fields.Nested(RoleSchema, only=['id', 'name', 'description'])

class UserSchema(BaseSchema):
    id = fields.Int(dump_only=True)
    username = fields.Str(required=True)
    email = fields.Email(required=True)
    full_name = fields.Str(required=True)
    department_id = fields.Int(load_default=None)
    avatar_file_id = fields.Int(load_default=None, allow_none=True)
    is_active = fields.Bool(load_default=True)
    password = fields.Str(load_only=True, required=True)
    roles = fields.Nested(UserRoleSchema, many=True, dump_only=True)
</file>

<file path="apps/api/src/api/schemas/user.py">

</file>

<file path="apps/api/src/api/schemas/workflow_log_schema.py">
from marshmallow import Schema, fields

class WorkflowLogSchema(Schema):
    id = fields.Int(dump_only=True)
    syllabus_id = fields.Int(required=True)
    actor_id = fields.Int(required=True)
    action = fields.Str(required=True)
    from_status = fields.Str(load_default=None)
    to_status = fields.Str(load_default=None)
    comment = fields.Str(load_default=None)
    created_at = fields.DateTime(dump_only=True)
</file>

<file path="apps/api/src/api/swagger.py">
from apispec import APISpec
from apispec.ext.marshmallow import MarshmallowPlugin
from apispec_webframeworks.flask import FlaskPlugin

spec = APISpec(
    title="Syllabus Management API",
    version="1.0.0",
    openapi_version="3.0.2",
    plugins=[FlaskPlugin(), MarshmallowPlugin()],
)

# (No legacy Todo schemas registered ‚Äî SMD module schemas are registered via controllers/schemas)
</file>

<file path="apps/api/src/app_logging.py">
import logging

def setup_logging():
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler("app.log"),
            logging.StreamHandler()
        ]
    )

setup_logging()
</file>

<file path="apps/api/src/app.py">
from flask import Flask, jsonify
from api.swagger import spec
from api.middleware import middleware
from infrastructure.databases import init_db
from flasgger import Swagger
from flask_swagger_ui import get_swaggerui_blueprint
from cors import init_cors

# Dependency injection
from dependency_container import Container
from api.controllers.subject_controller import subject_bp
from api.controllers.faculty_controller import faculty_bp
from api.controllers.department_controller import department_bp
from api.controllers.role_controller import role_bp
from api.controllers.user_controller import user_bp
from api.controllers.academic_year_controller import academic_year_bp
from api.controllers.program_controller import program_bp
from api.controllers.syllabus_controller import syllabus_bp
from api.controllers.syllabus_clo_controller import syllabus_clo_bp
from api.controllers.syllabus_material_controller import syllabus_material_bp
from api.controllers.teaching_plan_controller import teaching_plan_bp
from api.controllers.assessment_scheme_controller import assessment_scheme_bp
from api.controllers.assessment_component_controller import assessment_component_bp
from api.controllers.rubric_controller import rubric_bp
from api.controllers.assessment_clo_controller import assessment_clo_bp
from api.controllers.auth_controller import auth_bp
from api.controllers.ai_controller import ai_bp
from api.controllers.dashboard_controller import dashboard_bp
from api.controllers.program_outcome_controller import program_outcome_bp
from api.controllers.file_controller import file_bp
from api.controllers.clo_plo_mapping_controller import clo_plo_mapping_bp
from api.controllers.subject_relationship_controller import subject_rel_bp
from api.controllers.syllabus_comment_controller import syllabus_comment_bp
from api.controllers.notification_controller import notification_bp
from api.controllers.system_setting_controller import system_setting_bp
from api.controllers.student_controller import student_bp
from api.controllers.search_controller import search_bp
from api.controllers.public_controller import public_bp
from api.controllers.admin_controller import admin_bp
from utils.socket_io import socketio, init_socketio


def create_app():
    app = Flask(__name__)

    # Initialize CORS early so Swagger and other blueprints respect it
    try:
        init_cors(app)
    except Exception:
        pass

    Swagger(app)
    init_socketio(app)

    # Initialize DI container and wire controllers
    container = Container()
    # Wire the container explicitly for controllers
    try:
        container.wire(modules=[
            "api.controllers.subject_controller",
            "api.controllers.faculty_controller",
            "api.controllers.department_controller",
            "api.controllers.role_controller",
            "api.controllers.user_controller",
            "api.controllers.academic_year_controller",
            "api.controllers.program_controller",
            "api.controllers.syllabus_controller",
            "api.controllers.syllabus_clo_controller",
            "api.controllers.syllabus_material_controller",
            "api.controllers.teaching_plan_controller",
            "api.controllers.assessment_scheme_controller",
            "api.controllers.assessment_component_controller",
            "api.controllers.rubric_controller",
            "api.controllers.assessment_clo_controller",
            "api.controllers.auth_controller",
            "api.controllers.ai_controller",
            "api.controllers.dashboard_controller",
            "api.controllers.program_outcome_controller",
            "api.controllers.file_controller",
            "api.controllers.clo_plo_mapping_controller",
            "api.controllers.subject_relationship_controller",
            "api.controllers.syllabus_comment_controller",
            "api.controllers.notification_controller",
            "api.controllers.system_setting_controller",
            "api.controllers.student_controller",
            "api.controllers.search_controller",
            "api.controllers.public_controller",
            "api.controllers.admin_controller",
        ])
        print("[OK] Dependency injection wiring successful")
    except Exception as e:
        error_msg = f"Failed to wire dependency container: {e}"
        print(f"[ERROR] {error_msg}")
        import os
        # In production, fail fast; in development, allow partial wiring
        if os.getenv('ENVIRONMENT', 'development') == 'production':
            raise RuntimeError(error_msg)
        else:
            print("[WARNING] Continuing with incomplete DI wiring in development mode")

    # Register blueprints
    app.register_blueprint(subject_bp)
    app.register_blueprint(faculty_bp)
    app.register_blueprint(department_bp)
    app.register_blueprint(role_bp)
    app.register_blueprint(user_bp)
    app.register_blueprint(academic_year_bp)
    app.register_blueprint(program_bp)
    app.register_blueprint(syllabus_bp)
    app.register_blueprint(syllabus_clo_bp)
    app.register_blueprint(syllabus_material_bp)
    app.register_blueprint(teaching_plan_bp)
    app.register_blueprint(assessment_scheme_bp)
    app.register_blueprint(assessment_component_bp)
    app.register_blueprint(rubric_bp)
    app.register_blueprint(assessment_clo_bp)
    app.register_blueprint(auth_bp)
    app.register_blueprint(ai_bp)
    app.register_blueprint(dashboard_bp)
    app.register_blueprint(program_outcome_bp)
    app.register_blueprint(file_bp)
    app.register_blueprint(clo_plo_mapping_bp)
    app.register_blueprint(subject_rel_bp)
    app.register_blueprint(syllabus_comment_bp)
    app.register_blueprint(notification_bp)
    app.register_blueprint(system_setting_bp)
    app.register_blueprint(student_bp)
    app.register_blueprint(search_bp)
    app.register_blueprint(public_bp)
    app.register_blueprint(admin_bp)

     # Th√™m Swagger UI blueprint
    SWAGGER_URL = '/docs'
    API_URL = '/swagger.json'
    swaggerui_blueprint = get_swaggerui_blueprint(
        SWAGGER_URL,
        API_URL,
        config={'app_name': "Syllabus Management API"}
    )
    app.register_blueprint(swaggerui_blueprint, url_prefix=SWAGGER_URL)

    # Database initialization with proper error handling
    try:
        init_db(app)
        print("[OK] Database initialized successfully")
    except Exception as e:
        print(f"[ERROR] Error initializing database: {e}")
        import os
        if os.getenv('ENVIRONMENT', 'development') == 'production':
            raise

    # Register middleware
    middleware(app)
    print("[OK] Middleware registered")

    # Initialize CORS
    try:
        init_cors(app)
    except Exception:
        pass

    # Register routes (add all non-static endpoints to Swagger where possible)
    with app.test_request_context():
        for rule in app.url_map.iter_rules():
            if rule.endpoint == 'static':
                continue
            view_func = app.view_functions.get(rule.endpoint)
            if not view_func:
                continue
            try:
                spec.path(view=view_func)
                print(f"Adding path: {rule.rule} -> {view_func}")
            except Exception:
                # some endpoints may not be compatible with flasgger, skip them
                pass

    @app.route("/swagger.json")
    def swagger_json():
        return jsonify(spec.to_dict())

    return app
# Run the application

if __name__ == '__main__':
    app = create_app()
    # Use socketio.run instead of app.run
    socketio.run(app, host='0.0.0.0', port=5000, debug=True)
</file>

<file path="apps/api/src/config.py">
# Configuration settings for the Flask application

import os
from dotenv import load_dotenv
load_dotenv()

class Config:
    """Base configuration."""
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'a_default_secret_key'
    DEBUG = os.environ.get('DEBUG', 'False').lower() in ['true', '1']
    TESTING = os.environ.get('TESTING', 'False').lower() in ['true', '1']
    
    DATABASE_URI = os.environ.get('DATABASE_URI') 
    CORS_HEADERS = 'Content-Type'
    
    # Logging Configuration
    LOG_LEVEL = os.environ.get('LOG_LEVEL', 'INFO')
    LOG_DIR = os.environ.get('LOG_DIR', 'logs')
    
    # Caching Configuration
    CACHE_TYPE = os.environ.get('CACHE_TYPE', 'SimpleCache')
    CACHE_DEFAULT_TIMEOUT = int(os.environ.get('CACHE_DEFAULT_TIMEOUT', 300))
    CACHE_REDIS_URL = os.environ.get('CACHE_REDIS_URL')
    
    # Pagination
    DEFAULT_PAGE_SIZE = int(os.environ.get('DEFAULT_PAGE_SIZE', 20))
    MAX_PAGE_SIZE = int(os.environ.get('MAX_PAGE_SIZE', 100))

    # Email Configuration
    MAIL_SERVER = os.environ.get('MAIL_SERVER', 'smtp.gmail.com')
    MAIL_PORT = int(os.environ.get('MAIL_PORT', 587))
    MAIL_USE_TLS = os.environ.get('MAIL_USE_TLS', 'True').lower() in ['true', '1']
    MAIL_USERNAME = os.environ.get('MAIL_USERNAME')
    MAIL_PASSWORD = os.environ.get('MAIL_PASSWORD')
    MAIL_DEFAULT_SENDER = os.environ.get('MAIL_DEFAULT_SENDER', 'smd.system.notification@gmail.com')

    # Celery configuration
    CELERY = {
        "broker_url": os.environ.get("CELERY_BROKER_URL", "redis://localhost:6379/0"),
        "result_backend": os.environ.get("CELERY_RESULT_BACKEND", "redis://localhost:6379/0"),
        "task_ignore_result": False,
        "beat_schedule": {
            "check-deadlines-every-morning": {
                "task": "tasks.check_deadlines_periodic_task",
                "schedule": 86400.0,  # Once every 24 hours
            },
        },
    }

class DevelopmentConfig(Config):
    """Development configuration."""
    DEBUG = True
    DATABASE_URI = os.environ.get('DATABASE_URI')
    LOG_LEVEL = 'DEBUG'
    CACHE_TYPE = 'SimpleCache' 


class TestingConfig(Config):
    """Testing configuration."""
    TESTING = True
    DATABASE_URI = os.environ.get('DATABASE_URI')


class ProductionConfig(Config):
    """Production configuration."""
    DATABASE_URI = os.environ.get('DATABASE_URI')
    LOG_LEVEL = 'WARNING'
    CACHE_TYPE = 'RedisCache'  # Use Redis in production
    DEBUG = False 

    
template = {
    "swagger": "2.0",
    "info": {
        "title": "Syllabus Management API",
        "description": "API for Syllabus Management (SMD)",
        "version": "1.0.0"
    },
    "basePath": "/",
    "schemes": [
        "http",
        "https"
    ],
    "consumes": [
        "application/json"
    ],
    "produces": [
        "application/json"
    ]
}
class SwaggerConfig:
    """Swagger configuration."""
    template = {
        "swagger": "2.0",
        "info": {
            "title": "Syllabus Management API",
            "description": "API for Syllabus Management (SMD)",
            "version": "1.0.0"
        },
        "basePath": "/",
        "schemes": [
            "http",
            "https"
        ],
        "consumes": [
            "application/json"
        ],
        "produces": [
            "application/json"
        ]
    }

    swagger_config = {
        "headers": [],
        "specs": [
            {
                "endpoint": 'apispec',
                "route": '/apispec.json',
                "rule_filter": lambda rule: True,
                "model_filter": lambda tag: True,
            }
        ],
        "static_url_path": "/flasgger_static",
        "swagger_ui": True,
        "specs_route": "/docs"
    }
</file>

<file path="apps/api/src/cors.py">
from flask_cors import CORS

def init_cors(app):
    # Allow multiple origins including localhost variants
    CORS(app, resources={
        r"/*": {
            "origins": ["http://localhost:3000", "http://127.0.0.1:3000", "http://localhost:3001"],
            "allow_headers": ["Authorization", "Content-Type", "X-Requested-With", "Accept"],
            "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"],
            "expose_headers": ["Content-Type", "Authorization"],
            "supports_credentials": True,
            "max_age": 3600,
            "send_wildcard": False,
            "always_send": True
        }
    }, supports_credentials=True)
    app.config.setdefault('CORS_HEADERS', 'Content-Type')
    return app
</file>

<file path="apps/api/src/create_app.py">
from flask import Flask
from config import Config
from api.middleware import middleware
from api.routes import register_routes
from infrastructure.databases import init_db
from utils.caching import cache
from utils.socket_io import init_socketio
from utils.mail import init_mail
from utils.logging_config import setup_logging as setup_structured_logging
from celery_utils import celery_init_app

def create_app():
    app = Flask(__name__)
    app.config.from_object(Config)

    # Initialize Celery
    celery_init_app(app)

    # Setup structured logging
    setup_structured_logging(
        app_name=app.config.get('APP_NAME', 'smd-api'),
        log_level=app.config.get('LOG_LEVEL', 'INFO'),
        log_dir=app.config.get('LOG_DIR', 'logs')
    )
    
    # Setup Flask-Caching
    cache.init_app(app, config={
        'CACHE_TYPE': app.config.get('CACHE_TYPE', 'SimpleCache'),
        'CACHE_DEFAULT_TIMEOUT': app.config.get('CACHE_DEFAULT_TIMEOUT', 300),
        'CACHE_REDIS_URL': app.config.get('CACHE_REDIS_URL')
    })

    init_db(app)
    init_socketio(app)
    init_mail(app)
    middleware(app)
    register_routes(app)

    return app
</file>

<file path="apps/api/src/dependency_container.py">
# Dependency Injection Container

from dependency_injector import containers, providers
from infrastructure.databases.mssql import SessionLocal

from infrastructure.repositories.subject_repository import SubjectRepository
from services.subject_service import SubjectService
from infrastructure.repositories.faculty_repository import FacultyRepository
from services.faculty_service import FacultyService
from infrastructure.repositories.department_repository import DepartmentRepository
from services.department_service import DepartmentService
from infrastructure.repositories.role_repository import RoleRepository
from services.role_service import RoleService
from infrastructure.repositories.user_repository import UserRepository
from services.user_service import UserService
from infrastructure.repositories.academic_year_repository import AcademicYearRepository
from services.academic_year_service import AcademicYearService
from infrastructure.repositories.program_repository import ProgramRepository
from services.program_service import ProgramService
from infrastructure.repositories.syllabus_repository import SyllabusRepository
from services.syllabus_service import SyllabusService
from infrastructure.repositories.syllabus_clo_repository import SyllabusCloRepository
from services.syllabus_clo_service import SyllabusCloService
from infrastructure.repositories.syllabus_material_repository import SyllabusMaterialRepository
from services.syllabus_material_service import SyllabusMaterialService
from infrastructure.repositories.teaching_plan_repository import TeachingPlanRepository
from services.teaching_plan_service import TeachingPlanService
from infrastructure.repositories.assessment_scheme_repository import AssessmentSchemeRepository
from services.assessment_scheme_service import AssessmentSchemeService
from infrastructure.repositories.assessment_component_repository import AssessmentComponentRepository
from services.assessment_component_service import AssessmentComponentService
from infrastructure.repositories.rubric_repository import RubricRepository
from services.rubric_service import RubricService
from infrastructure.repositories.assessment_clo_repository import AssessmentCloRepository
from services.assessment_clo_service import AssessmentCloService
from infrastructure.repositories.workflow_log_repository import WorkflowLogRepository

# NEW: Program Outcome, File Management, Mappings, Relationships, Comments, Notifications, System Settings, AI Audit
from infrastructure.repositories.program_outcome_repository import ProgramOutcomeRepository
from services.program_outcome_service import ProgramOutcomeService
from infrastructure.repositories.file_repository import FileRepository
from services.file_service import FileService
from infrastructure.repositories.clo_plo_mapping_repository import CloPloMappingRepository
from services.clo_plo_mapping_service import CloPloMappingService
from infrastructure.repositories.subject_relationship_repository import SubjectRelationshipRepository
from services.subject_relationship_service import SubjectRelationshipService
from infrastructure.repositories.syllabus_comment_repository import SyllabusCommentRepository
from services.syllabus_comment_service import SyllabusCommentService
from infrastructure.repositories.notification_repository import NotificationRepository
from services.notification_service import NotificationService
from infrastructure.repositories.system_setting_repository import SystemSettingRepository
from infrastructure.repositories.ai_auditlog_repository import AiAuditLogRepository
from infrastructure.repositories.system_auditlog_repository import SystemAuditLogRepository
from infrastructure.repositories.student_subscription_repository import StudentSubscriptionRepository
from infrastructure.repositories.student_report_repository import StudentReportRepository
from services.system_setting_service import SystemSettingService
from services.ocr_service import OCRService
from services.search_service import SearchService
from services.system_auditlog_service import SystemAuditLogService
from services.student_service import StudentService
from services.email_service import EmailService
from infrastructure.repositories.syllabus_snapshot_repository import SyllabusSnapshotRepository
from services.syllabus_snapshot_service import SyllabusSnapshotService
from infrastructure.repositories.syllabus_current_workflow_repository import SyllabusCurrentWorkflowRepository
from services.analysis_service import AnalysisService

class Container(containers.DeclarativeContainer):
    """Dependency Injection Container for SMD services."""

    wiring_config = containers.WiringConfiguration(modules=[
        "api.controllers.subject_controller",
        "api.controllers.faculty_controller",
        "api.controllers.department_controller",
        "api.controllers.role_controller",
        "api.controllers.user_controller",
        "api.controllers.academic_year_controller",
        "api.controllers.program_controller",
        "api.controllers.syllabus_controller",
        "api.controllers.syllabus_clo_controller",
        "api.controllers.syllabus_material_controller",
        "api.controllers.teaching_plan_controller",
        "api.controllers.assessment_scheme_controller",
        "api.controllers.assessment_component_controller",
        "api.controllers.rubric_controller",
        "api.controllers.assessment_clo_controller",
        "api.controllers.auth_controller",
        "api.controllers.ai_controller",
        "api.controllers.dashboard_controller",
        "api.controllers.program_outcome_controller",
        "api.controllers.file_controller",
        "api.controllers.clo_plo_mapping_controller",
        "api.controllers.subject_relationship_controller",
        "api.controllers.syllabus_comment_controller",
        "api.controllers.notification_controller",
        "api.controllers.system_setting_controller",
        "api.controllers.student_controller",
        "api.controllers.admin_controller",
    ])

    # Provide a request-scoped session (managed by SQLAlchemy scoped_session)
    from infrastructure.databases.mssql import db_session as sqlalchemy_db_session
    db_session = providers.Object(sqlalchemy_db_session)

    # Repositories
    subject_repository = providers.Factory(
        SubjectRepository,
        session=db_session
    )

    syllabus_snapshot_repository = providers.Factory(
        SyllabusSnapshotRepository,
        session=db_session
    )

    faculty_repository = providers.Factory(
        FacultyRepository,
        session=db_session
    )

    department_repository = providers.Factory(
        DepartmentRepository,
        session=db_session
    )

    academic_year_repository = providers.Factory(
        AcademicYearRepository,
        session=db_session
    )

    program_repository = providers.Factory(
        ProgramRepository,
        session=db_session
    )

    role_repository = providers.Factory(
        RoleRepository,
        session=db_session
    )

    user_repository = providers.Factory(
        UserRepository,
        session=db_session
    )
    # Services
    subject_service = providers.Factory(
        SubjectService,
        repository=subject_repository
    )

    faculty_service = providers.Factory(
        FacultyService,
        repository=faculty_repository
    )

    department_service = providers.Factory(
        DepartmentService,
        repository=department_repository
    )

    syllabus_repository = providers.Factory(
        SyllabusRepository,
        session=db_session
    )

    syllabus_clo_repository = providers.Factory(
        SyllabusCloRepository,
        session=db_session
    )

    syllabus_material_repository = providers.Factory(
        SyllabusMaterialRepository,
        session=db_session
    )

    teaching_plan_repository = providers.Factory(
        TeachingPlanRepository,
        session=db_session
    )

    assessment_scheme_repository = providers.Factory(
        AssessmentSchemeRepository,
        session=db_session
    )

    assessment_component_repository = providers.Factory(
        AssessmentComponentRepository,
        session=db_session
    )

    rubric_repository = providers.Factory(
        RubricRepository,
        session=db_session
    )

    assessment_clo_repository = providers.Factory(
        AssessmentCloRepository,
        session=db_session
    )

    workflow_log_repository = providers.Factory(
        WorkflowLogRepository,
        session=db_session
    )

    # NEW REPOSITORIES
    program_outcome_repository = providers.Factory(
        ProgramOutcomeRepository,
        session=db_session
    )
    
    file_repository = providers.Factory(
        FileRepository,
        session=db_session
    )

    clo_plo_mapping_repository = providers.Factory(
        CloPloMappingRepository,
        session=db_session
    )

    subject_relationship_repository = providers.Factory(
        SubjectRelationshipRepository,
        session=db_session
    )

    syllabus_comment_repository = providers.Factory(
        SyllabusCommentRepository,
        session=db_session
    )

    notification_repository = providers.Factory(
        NotificationRepository,
        session=db_session
    )

    system_setting_repository = providers.Factory(
        SystemSettingRepository,
        session=db_session
    )

    student_subscription_repository = providers.Factory(
        StudentSubscriptionRepository,
        session=db_session
    )

    student_report_repository = providers.Factory(
        StudentReportRepository,
        session=db_session
    )

    ai_auditlog_repository = providers.Factory(
        AiAuditLogRepository,
        session=db_session
    )

    system_auditlog_repository = providers.Factory(
        SystemAuditLogRepository,
        session=db_session
    )

    syllabus_current_workflow_repository = providers.Factory(
        SyllabusCurrentWorkflowRepository,
        session=db_session
    )

    academic_year_service = providers.Factory(
        AcademicYearService,
        repository=academic_year_repository
    )

    analysis_service = providers.Factory(
        AnalysisService,
        syllabus_repository=syllabus_repository,
        rel_repository=subject_relationship_repository
    )

    program_service = providers.Factory(
        ProgramService,
        repository=program_repository
    )

    email_service = providers.Factory(
        EmailService
    )

    # Move AI Service provider up so it can be used by syllabus_snapshot_service
    from services.ai_service import AiService
    ai_service = providers.Factory(
        AiService,
        audit_repository=ai_auditlog_repository
    )

    syllabus_snapshot_service = providers.Factory(
        SyllabusSnapshotService,
        repository=syllabus_snapshot_repository,
        ai_service=ai_service,
        syllabus_repository=syllabus_repository
    )

    notification_service = providers.Factory(
        NotificationService,
        repository=notification_repository,
        user_repository=user_repository,
        email_service=email_service
    )

    syllabus_service = providers.Factory(
        SyllabusService,
        repository=syllabus_repository,
        subject_repository=subject_repository,
        program_repository=program_repository,
        academic_year_repository=academic_year_repository,
        user_repository=user_repository,
        workflow_log_repository=workflow_log_repository,
        notification_service=notification_service,
        # NEW INJECTIONS:
        syllabus_clo_repository=syllabus_clo_repository,
        syllabus_material_repository=syllabus_material_repository,
        teaching_plan_repository=teaching_plan_repository,
        assessment_scheme_repository=assessment_scheme_repository,
        assessment_component_repository=assessment_component_repository,
        rubric_repository=rubric_repository,
        assessment_clo_repository=assessment_clo_repository,
        snapshot_service=syllabus_snapshot_service,
        current_workflow_repository=syllabus_current_workflow_repository,
        clo_plo_mapping_repository=clo_plo_mapping_repository,
        program_outcome_repository=program_outcome_repository
    )

    syllabus_clo_service = providers.Factory(
        SyllabusCloService,
        repository=syllabus_clo_repository,
        syllabus_repository=syllabus_repository
    )

    syllabus_material_service = providers.Factory(
        SyllabusMaterialService,
        repository=syllabus_material_repository,
        syllabus_repository=syllabus_repository
    )

    teaching_plan_service = providers.Factory(
        TeachingPlanService,
        repository=teaching_plan_repository,
        syllabus_repository=syllabus_repository
    )

    assessment_scheme_service = providers.Factory(
        AssessmentSchemeService,
        repository=assessment_scheme_repository,
        syllabus_repository=syllabus_repository
    )

    assessment_component_service = providers.Factory(
        AssessmentComponentService,
        repository=assessment_component_repository,
        scheme_repository=assessment_scheme_repository
    )

    rubric_service = providers.Factory(
        RubricService,
        repository=rubric_repository,
        component_repository=assessment_component_repository
    )

    assessment_clo_service = providers.Factory(
        AssessmentCloService,
        repository=assessment_clo_repository,
        component_repository=assessment_component_repository,
        syllabus_clo_repository=syllabus_clo_repository,
        assessment_scheme_repository=assessment_scheme_repository
    )
  

    # NEW SERVICES
    program_outcome_service = providers.Factory(
        ProgramOutcomeService,
        repository=program_outcome_repository,
        program_repository=program_repository
    )

    file_service = providers.Factory(
        FileService,
        repository=file_repository
    )

    clo_plo_mapping_service = providers.Factory(
        CloPloMappingService,
        repository=clo_plo_mapping_repository,
        syllabus_clo_repository=syllabus_clo_repository,
        program_outcome_repository=program_outcome_repository
    )

    subject_relationship_service = providers.Factory(
        SubjectRelationshipService,
        repository=subject_relationship_repository,
        subject_repository=subject_repository
    )

    syllabus_comment_service = providers.Factory(
        SyllabusCommentService,
        repository=syllabus_comment_repository,
        syllabus_repository=syllabus_repository,
        user_repository=user_repository
    )

    system_setting_service = providers.Factory(
        SystemSettingService,
        repository=system_setting_repository
    )

    ocr_service = providers.Factory(OCRService)
    
    search_service = providers.Factory(SearchService)

    student_service = providers.Factory(
        StudentService, 
        sub_repo=student_subscription_repository,
        report_repo=student_report_repository
    )

    system_auditlog_service = providers.Factory(
        SystemAuditLogService,
        repository=system_auditlog_repository
    )

    role_service = providers.Factory(
        RoleService,
        repository=role_repository
    )

    user_service = providers.Factory(
        UserService,
        repository=user_repository
    )
</file>

<file path="apps/api/src/domain/constants.py">
# Constants

# Define any constants used throughout the application here. 
# For example, you might define API version, error messages, or configuration keys.

API_VERSION = "v1"
DEFAULT_PAGE_SIZE = 20
MAX_PAGE_SIZE = 100

# Workflow Status Constants
class WorkflowStatus:
    """Syllabus workflow status constants."""
    DRAFT = 'DRAFT'
    PENDING = 'PENDING'
    PENDING_APPROVAL = 'PENDING APPROVAL'
    PENDING_FINAL_APPROVAL = 'PENDING FINAL APPROVAL'
    APPROVED = 'APPROVED'
    PUBLISHED = 'PUBLISHED'
    REJECTED = 'REJECTED'
    RETURNED = 'RETURNED'
    
    # Valid states for each action
    VALID_FOR_SUBMISSION = (DRAFT, RETURNED, REJECTED)
    VALID_FOR_EVALUATION = (PENDING, PENDING_APPROVAL, PENDING_FINAL_APPROVAL)
    PUBLIC_STATUSES = (APPROVED, PUBLISHED)
    
    ALL_STATES = (DRAFT, PENDING, PENDING_APPROVAL, PENDING_FINAL_APPROVAL, APPROVED, PUBLISHED, REJECTED, RETURNED)

# Add more constants as needed for your application.
</file>

<file path="apps/api/src/domain/exceptions.py">
class CustomException(Exception):
    """Base class for all custom exceptions in the application."""
    pass

class NotFoundException(CustomException):
    """Exception raised when a resource is not found."""
    def __init__(self, message="Resource not found"):
        self.message = message
        super().__init__(self.message)

class ValidationException(CustomException):
    """Exception raised for validation errors."""
    def __init__(self, message="Validation error"):
        self.message = message
        super().__init__(self.message)

class UnauthorizedException(CustomException):
    """Exception raised for unauthorized access."""
    def __init__(self, message="Unauthorized access"):
        self.message = message
        super().__init__(self.message)

class ConflictException(CustomException):
    """Exception raised for conflicts in the application."""
    def __init__(self, message="Conflict occurred"):
        self.message = message
        super().__init__(self.message)
</file>

<file path="apps/api/src/domain/models/...  # Business logic models">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/domain/models/user.py">
from sqlalchemy import Column, Integer, String, DateTime, Boolean
from infrastructure.databases.base import Base

class User:
    
    def __innit__(self, user_name: str, password: str, description: str = None, status: bool = True):
        self.user_name = user_name
        self.password = password
        self.description = description
        self.status = status
        self.created_at = None
        self.updated_at = None
</file>

<file path="apps/api/src/error_handler.py">
# Error handling logic for the Flask application

from flask import jsonify

class CustomError(Exception):
    status_code = 400

    def __init__(self, message, status_code=None):
        super().__init__(message)
        if status_code is not None:
            self.status_code = status_code
        self.message = message

    def to_dict(self):
        return {'message': self.message}

def handle_error(error):
    if isinstance(error, CustomError):
        response = jsonify(error.to_dict())
        response.status_code = error.status_code
        return response

    response = jsonify({'message': 'An unexpected error occurred.'})
    response.status_code = 500
    return response

def register_error_handlers(app):
    app.register_error_handler(Exception, handle_error)
</file>

<file path="apps/api/src/infrastructure/databases/__init__.py">
from infrastructure.databases.mssql import init_mssql
from infrastructure.models import (
    academic_year_model,
    ai_auditlog_model,
    assessment_clo_model,
    assessment_component_model,
    assessment_scheme_model,
    clo_plo_mapping_model,
    department_model,
    faculty_model,
    file_model,
    notification_model,
    notification_template_model,
    program_model,
    program_outcome_model,
    role_model,
    rubric_model,
    student_report_model,
    student_subscription_model,
    subject_model,
    subject_relationship_model,
    syllabus_clo_model,
    syllabus_comment_model,
    syllabus_current_workflow,
    syllabus_material_model,
    syllabus_model,
    system_auditlog_model,
    system_setting_model,
    teaching_plan_model,
    user_model,
    user_role_model,
    workflow_log_model,
    workflow_state_model,
    workflow_transition_model
)

def init_db(app):
    init_mssql(app)

# Migration Entities -> tables
from infrastructure.databases.mssql import Base
</file>

<file path="apps/api/src/infrastructure/databases/base.py">
from sqlalchemy.orm import declarative_base

Base = declarative_base()


# ORM: object relational mapping base class
# OOP : object oriented programming

# ERD --> class relational
# L·∫≠p trinhf h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng (logic) mapping class -> table (database)
</file>

<file path="apps/api/src/infrastructure/databases/mssql.py">
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, scoped_session
from sqlalchemy.pool import QueuePool
from config import Config
from infrastructure.databases.base import Base

# Database configuration
DATABASE_URI = Config.DATABASE_URI

# Configure engine with proper connection pooling
engine = create_engine(
    DATABASE_URI,
    poolclass=QueuePool,
    pool_size=30,              # Connection pool size
    max_overflow=60,           # Additional connections beyond pool_size (Total 90)
    pool_pre_ping=True,        # Verify connection before use
    pool_recycle=3600,         # Recycle connection after 1 hour
    echo=Config.DEBUG,         # Log SQL queries in debug mode
    connect_args={
        'timeout': 30
    }
)

# Use sessionmaker to create a factory for Session objects
SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine,
    expire_on_commit=False     # Don't expire objects after commit
)

# Create a scoped session for thread-safe usage across the application
# This is preferred for Flask applications as it provides one session per request/thread
db_session = scoped_session(SessionLocal)

# Alias for backward compatibility (mapped to the scoped session)
session = db_session

def init_mssql(app):
    """Initialize database with proper error handling."""
    @app.teardown_appcontext
    def shutdown_session(exception=None):
        """Ensure that the database session is removed after each request."""
        db_session.remove()

    try:
        Base.metadata.create_all(bind=engine)
        app.logger.info("‚úì Database tables created successfully")
    except Exception as e:
        app.logger.error(f"‚úó Failed to create database tables: {e}")
        raise
    @app.teardown_appcontext
    def shutdown_session(exception=None):
        db_session.remove()
</file>

<file path="apps/api/src/infrastructure/databases/mysql.py">

</file>

<file path="apps/api/src/infrastructure/models/__init__.py">
from .user_model import User
from .user_role_model import UserRole
from .role_model import Role
from .faculty_model import Faculty
from .department_model import Department
from .program_model import Program
from .program_outcome_model import ProgramOutcome
from .subject_model import Subject
from .academic_year_model import AcademicYear
from .syllabus_model import Syllabus
from .syllabus_clo_model import SyllabusClo
from .syllabus_material_model import SyllabusMaterial
from .teaching_plan_model import TeachingPlan
from .assessment_scheme_model import AssessmentScheme
from .assessment_component_model import AssessmentComponent
from .rubric_model import Rubric
from .clo_plo_mapping_model import CloPloMapping
from .assessment_clo_model import AssessmentClo
from .subject_relationship_model import SubjectRelationship
from .system_setting_model import SystemSetting
from .student_subscription_model import StudentSubscription
from .student_report_model import StudentReport
from .notification_model import Notification
from .syllabus_comment_model import SyllabusComment
from .workflow_log_model import WorkflowLog
from .workflow_state_model import WorkflowState
from .workflow_transition_model import WorkflowTransition
from .syllabus_current_workflow import SyllabusCurrentWorkflow
from .ai_auditlog_model import AiAuditLog

__all__ = [
    "User", "UserRole", "Role", "Faculty", "Department", "Program",
    "ProgramOutcome", "Subject", "AcademicYear", "Syllabus", "SyllabusClo",
    "SyllabusMaterial", "TeachingPlan", "AssessmentScheme", "AssessmentComponent", "Rubric",
    "CloPloMapping", "AssessmentClo", "SubjectRelationship", "SystemSetting",
    "StudentSubscription", "StudentReport", "Notification", "SyllabusComment",
    "WorkflowLog", "WorkflowState", "WorkflowTransition", "SyllabusCurrentWorkflow",
    "AiAuditLog"
]
</file>

<file path="apps/api/src/infrastructure/models/academic_year_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AcademicYear(Base):
    __tablename__ = 'academic_years'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(20), unique=True)
    start_date = Column(Date, nullable=True)
    end_date = Column(Date, nullable=True)
    is_active = Column(Boolean, default=False)
    
    # Relationships
    syllabuses = relationship("Syllabus", back_populates="academic_year")
</file>

<file path="apps/api/src/infrastructure/models/ai_auditlog_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AiAuditLog(Base):
    __tablename__ = 'ai_audit_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    action = Column(NVARCHAR(50))  # GENERATE, COMPARE_DIFF, SUMMARIZE
    input_tokens = Column(Integer)
    output_tokens = Column(Integer)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="ai_audit_logs")
</file>

<file path="apps/api/src/infrastructure/models/assessment_clo_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentClo(Base):
    __tablename__ = 'assessment_clos'
    
    assessment_component_id = Column(BigInteger, ForeignKey('assessment_components.id'), primary_key=True)
    syllabus_clo_id = Column(BigInteger, ForeignKey('syllabus_clos.id'), primary_key=True)
    
    # Relationships
    component = relationship("AssessmentComponent", back_populates="clos")
    syllabus_clo = relationship("SyllabusClo", back_populates="assessment_clos")
</file>

<file path="apps/api/src/infrastructure/models/assessment_component_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentComponent(Base):
    __tablename__ = 'assessment_components'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    scheme_id = Column(BigInteger, ForeignKey('assessment_schemes.id'), nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    weight = Column(DECIMAL(5, 2), nullable=False)
    
    # Relationships
    scheme = relationship("AssessmentScheme", back_populates="components")
    clos = relationship("AssessmentClo", back_populates="component")
    rubrics = relationship("Rubric", back_populates="component", cascade="all, delete-orphan")
</file>

<file path="apps/api/src/infrastructure/models/assessment_scheme_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class AssessmentScheme(Base):
    __tablename__ = 'assessment_schemes'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    name = Column(NVARCHAR(100))
    weight = Column(DECIMAL(5, 2))
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="assessment_schemes")
    components = relationship("AssessmentComponent", back_populates="scheme", cascade="all, delete-orphan")
</file>

<file path="apps/api/src/infrastructure/models/clo_plo_mapping_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class CloPloMapping(Base):
    __tablename__ = 'clo_plo_mappings'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_clo_id = Column(BigInteger, ForeignKey('syllabus_clos.id', ondelete='CASCADE'), nullable=False)
    program_plo_id = Column(BigInteger, ForeignKey('program_outcomes.id'), nullable=False)
    level = Column(NVARCHAR(1))  # I, R, M, A
    
    __table_args__ = (
        CheckConstraint("level IN ('I', 'R', 'M', 'A')", name='check_level'),
    )
    
    # Relationships
    syllabus_clo = relationship("SyllabusClo", back_populates="plo_mappings")
    program_plo = relationship("ProgramOutcome", back_populates="clo_mappings")
</file>

<file path="apps/api/src/infrastructure/models/department_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Department(Base):
    __tablename__ = 'departments'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    faculty_id = Column(BigInteger, ForeignKey('faculties.id'), nullable=False)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    
    # Relationships
    faculty = relationship("Faculty", back_populates="departments")
    users = relationship("User", back_populates="department")
    subjects = relationship("Subject", back_populates="department")
    programs = relationship("Program", back_populates="department")
</file>

<file path="apps/api/src/infrastructure/models/faculty_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base


class Faculty(Base):
    __tablename__ = 'faculties'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(20), unique=True, nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    description = Column(NVARCHAR(None))
    
    # Relationships
    departments = relationship("Department", back_populates="faculty")
</file>

<file path="apps/api/src/infrastructure/models/file_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
# IMPORT BASE CHUNG (QUAN TR·ªåNG)
from infrastructure.databases.base import Base

class File(Base):
    __tablename__ = 'files'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    uploader_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    file_name = Column(NVARCHAR(255), nullable=False)
    file_path = Column(NVARCHAR(500), nullable=False)
    file_size = Column(BigInteger)
    mime_type = Column(NVARCHAR(100))
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    uploader = relationship("User", back_populates="uploaded_files", foreign_keys=[uploader_id])
</file>

<file path="apps/api/src/infrastructure/models/notification_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Notification(Base):
    __tablename__ = 'notifications'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    title = Column(NVARCHAR(255), nullable=False)
    message = Column(UnicodeText)
    link = Column(NVARCHAR(500))
    is_read = Column(Boolean, default=False)
    type = Column(NVARCHAR(50))  # SYSTEM, REVIEW, REMINDER
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    user = relationship("User", back_populates="notifications")
</file>

<file path="apps/api/src/infrastructure/models/notification_template_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class NotificationTemplate(Base):
    __tablename__ = 'notification_templates'
    
    code = Column(NVARCHAR(50), primary_key=True)
    title_template = Column(NVARCHAR(255), nullable=False)
    body_template = Column(UnicodeText, nullable=False)
    channel = Column(NVARCHAR(20), default='SYSTEM')  # EMAIL, SMS, SYSTEM
</file>

<file path="apps/api/src/infrastructure/models/program_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Program(Base):
    __tablename__ = 'programs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=False)
    name = Column(NVARCHAR(255), nullable=False)
    total_credits = Column(Integer)
    
    # Relationships
    department = relationship("Department", back_populates="programs")
    outcomes = relationship("ProgramOutcome", back_populates="program")
    syllabuses = relationship("Syllabus", back_populates="program")
</file>

<file path="apps/api/src/infrastructure/models/program_outcome_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class ProgramOutcome(Base):
    __tablename__ = 'program_outcomes'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    program_id = Column(BigInteger, ForeignKey('programs.id'), nullable=False)
    code = Column(NVARCHAR(20))
    description = Column(UnicodeText)
    
    # Relationships
    program = relationship("Program", back_populates="outcomes")
    clo_mappings = relationship("CloPloMapping", back_populates="program_plo")
</file>

<file path="apps/api/src/infrastructure/models/role_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Role(Base):
    __tablename__ = 'roles'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    name = Column(NVARCHAR(50), unique=True, nullable=False)
    description = Column(NVARCHAR(255), nullable=True)
    
    # Relationships
    user_roles = relationship("UserRole", back_populates="role")
    workflow_transitions = relationship("WorkflowTransition", back_populates="allowed_role")
</file>

<file path="apps/api/src/infrastructure/models/rubric_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Rubric(Base):
    __tablename__ = 'rubrics'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    component_id = Column(BigInteger, ForeignKey('assessment_components.id', ondelete='CASCADE'), nullable=False)
    criteria = Column(UnicodeText, nullable=False)
    max_score = Column(DECIMAL(5, 2), nullable=False)
    description_level_pass = Column(UnicodeText)
    description_level_fail = Column(UnicodeText)
    
    # Relationships
    component = relationship("AssessmentComponent", back_populates="rubrics")
</file>

<file path="apps/api/src/infrastructure/models/student_report_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class StudentReport(Base):
    __tablename__ = 'student_reports'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    student_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    content = Column(UnicodeText, nullable=False)
    status = Column(NVARCHAR(20), default='PENDING')  # PENDING, RESOLVED, REJECTED
    admin_note = Column(UnicodeText)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="student_reports")
    student = relationship("User")
</file>

<file path="apps/api/src/infrastructure/models/student_subscription_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class StudentSubscription(Base):
    __tablename__ = 'student_subscriptions'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    student_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    student = relationship("User")
    subject = relationship("Subject", back_populates="student_subscriptions")
</file>

<file path="apps/api/src/infrastructure/models/subject_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class Subject(Base):
    __tablename__ = 'subjects'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=False)
    code = Column(NVARCHAR(20), unique=True, nullable=False, index=True)
    name_vi = Column(NVARCHAR(255), nullable=False)
    name_en = Column(NVARCHAR(255), nullable=False)
    credits = Column(Integer, nullable=False)
    credit_theory = Column(DECIMAL(5, 2), default=0)
    credit_practice = Column(DECIMAL(5, 2), default=0)
    credit_self_study = Column(DECIMAL(5, 2), default=0)
    
    # Relationships
    department = relationship("Department", back_populates="subjects")
    syllabuses = relationship("Syllabus", back_populates="subject")
    subject_relationships = relationship("SubjectRelationship", 
                                        foreign_keys="SubjectRelationship.subject_id",
                                        back_populates="subject")
    related_subjects = relationship("SubjectRelationship",
                                   foreign_keys="SubjectRelationship.related_subject_id",
                                   back_populates="related_subject")
    student_subscriptions = relationship("StudentSubscription", back_populates="subject")
</file>

<file path="apps/api/src/infrastructure/models/subject_relationship_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SubjectRelationship(Base):
    __tablename__ = 'subject_relationships'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    related_subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    type = Column(NVARCHAR(20), nullable=False)  # PREREQUISITE, COREQUISITE, PARALLEL
    
    # Relationships
    subject = relationship("Subject", foreign_keys=[subject_id], back_populates="subject_relationships")
    related_subject = relationship("Subject", foreign_keys=[related_subject_id], back_populates="related_subjects")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_clo_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusClo(Base):
    __tablename__ = 'syllabus_clos'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    code = Column(NVARCHAR(20), nullable=False)
    description = Column(UnicodeText, nullable=False)
    embedding_vector = Column(UnicodeText, nullable=True)  # JSON vector
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="clos")
    plo_mappings = relationship("CloPloMapping", back_populates="syllabus_clo", cascade="all, delete-orphan")
    assessment_clos = relationship("AssessmentClo", back_populates="syllabus_clo")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_comment_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusComment(Base):
    __tablename__ = 'syllabus_comments'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    content = Column(UnicodeText, nullable=False)
    parent_id = Column(BigInteger, ForeignKey('syllabus_comments.id'), nullable=True)
    is_resolved = Column(Boolean, default=False)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="comments")
    user = relationship("User", back_populates="comments")
    parent = relationship("SyllabusComment", remote_side=[id], backref="replies")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_current_workflow.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusCurrentWorkflow(Base):
    __tablename__ = 'syllabus_current_workflows'
    
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), primary_key=True)
    current_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    assigned_to_user_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    due_date = Column(DateTime, nullable=True)
    updated_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="current_workflow")
    current_state = relationship("WorkflowState", back_populates="current_workflows")
    assigned_to_user = relationship("User")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_material_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SyllabusMaterial(Base):
    __tablename__ = 'syllabus_materials'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    type = Column(NVARCHAR(50), nullable=False)  # MAIN, REFERENCE
    title = Column(NVARCHAR(555), nullable=False)
    author = Column(NVARCHAR(255))
    publisher = Column(NVARCHAR(255))
    published_year = Column(Integer)
    isbn = Column(NVARCHAR(50))
    url = Column(UnicodeText, nullable=True)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="materials")
</file>

<file path="apps/api/src/infrastructure/models/syllabus_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base

class Syllabus(Base):
    __tablename__ = 'syllabuses'
    
    # Unique constraint to prevent duplicate syllabuses
    __table_args__ = (
        UniqueConstraint('subject_id', 'program_id', 'academic_year_id', 'status', 
                        name='uq_syllabus_active'),
    )
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    subject_id = Column(BigInteger, ForeignKey('subjects.id'), nullable=False)
    program_id = Column(BigInteger, ForeignKey('programs.id'), nullable=False)
    academic_year_id = Column(BigInteger, ForeignKey('academic_years.id'), nullable=False)
    lecturer_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    status = Column(NVARCHAR(20))  # DRAFT, PENDING, APPROVED
    version = Column(NVARCHAR(10))
    time_allocation = Column(UnicodeText)  # JSON
    prerequisites = Column(UnicodeText)
    
    # Content fields
    description = Column(UnicodeText, nullable=True)  # M√¥ t·∫£ t√≥m t·∫Øt h·ªçc ph·∫ßn
    objectives = Column(UnicodeText, nullable=True)  # JSON array of course objectives
    student_duties = Column(UnicodeText, nullable=True)  # Nhi·ªám v·ª• c·ªßa sinh vi√™n
    other_requirements = Column(UnicodeText, nullable=True)  # Y√™u c·∫ßu kh√°c
    
    # Additional metadata
    pre_courses = Column(UnicodeText, nullable=True)  # HP h·ªçc tr∆∞·ªõc
    co_courses = Column(UnicodeText, nullable=True)  # HP song h√†nh
    course_type = Column(NVARCHAR(50), nullable=True)  # B·∫Øt bu·ªôc/T·ª± ch·ªçn
    component_type = Column(NVARCHAR(100), nullable=True)  # C∆° s·ªü ng√†nh, etc.
    date_prepared = Column(NVARCHAR(20), nullable=True)  # Ng√†y bi√™n so·∫°n
    date_edited = Column(NVARCHAR(20), nullable=True)  # Ng√†y ch·ªânh s·ª≠a
    dean = Column(NVARCHAR(255), nullable=True)  # Tr∆∞·ªüng khoa (Name)
    dean_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    head_department = Column(NVARCHAR(255), nullable=True)  # Tr∆∞·ªüng BM (Name)
    head_department_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    
    publish_date = Column(DateTime)
    is_active = Column(Boolean)
    embedding_vector = Column(UnicodeText, nullable=True)  # JSON vector
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
    
    # Relationships
    subject = relationship("Subject", back_populates="syllabuses")
    program = relationship("Program", back_populates="syllabuses")
    academic_year = relationship("AcademicYear", back_populates="syllabuses")
    lecturer = relationship("User", back_populates="syllabuses", foreign_keys=[lecturer_id])
    dean_user = relationship("User", foreign_keys=[dean_id])
    head_department_user = relationship("User", foreign_keys=[head_department_id])
    
    clos = relationship("SyllabusClo", back_populates="syllabus", cascade="all, delete-orphan")
    materials = relationship("SyllabusMaterial", back_populates="syllabus", cascade="all, delete-orphan")
    teaching_plans = relationship("TeachingPlan", back_populates="syllabus", cascade="all, delete-orphan")
    assessment_schemes = relationship("AssessmentScheme", back_populates="syllabus", cascade="all, delete-orphan")
    comments = relationship("SyllabusComment", back_populates="syllabus")
    workflow_logs = relationship("WorkflowLog", back_populates="syllabus")
    current_workflow = relationship("SyllabusCurrentWorkflow", back_populates="syllabus", uselist=False)
    student_reports = relationship("StudentReport", back_populates="syllabus")
    ai_audit_logs = relationship("AiAuditLog", back_populates="syllabus")
</file>

<file path="apps/api/src/infrastructure/models/system_auditlog_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class SystemAuditLog(Base):
    __tablename__ = 'system_audit_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=True)
    action_type = Column(NVARCHAR(50), nullable=False)
    resource_target = Column(NVARCHAR(100))
    ip_address = Column(NVARCHAR(45))
    user_agent = Column(UnicodeText)
    details = Column(UnicodeText)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    user = relationship("User")
</file>

<file path="apps/api/src/infrastructure/models/system_setting_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base

class SystemSetting(Base):
    __tablename__ = 'system_settings'
    
    key = Column(NVARCHAR(50), primary_key=True)
    value = Column(UnicodeText, nullable=False)
    type = Column(NVARCHAR(20), default='STRING')
    description = Column(NVARCHAR(255), nullable=True)
</file>

<file path="apps/api/src/infrastructure/models/teaching_plan_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class TeachingPlan(Base):
    __tablename__ = 'teaching_plans'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id', ondelete='CASCADE'), nullable=False)
    week = Column(Integer)
    topic = Column(UnicodeText)
    clos = Column(UnicodeText)  # Added to store associated CLOs
    activity = Column(UnicodeText)
    assessment = Column(UnicodeText)
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="teaching_plans")
</file>

<file path="apps/api/src/infrastructure/models/user_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
# IMPORT BASE CHUNG (QUAN TR·ªåNG)
from infrastructure.databases.base import Base

class User(Base):
    __tablename__ = 'users'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    department_id = Column(BigInteger, ForeignKey('departments.id'), nullable=True)
    username = Column(NVARCHAR(50), unique=True, nullable=False)
    email = Column(NVARCHAR(100), unique=True, nullable=False)
    password_hash = Column(NVARCHAR(255), nullable=False)
    full_name = Column(NVARCHAR(100), nullable=False)
    is_active = Column(Boolean, default=True)
    
    # S·ª¨A L·ªñI V√íNG L·∫∂P: Th√™m use_alter=True
    avatar_file_id = Column(BigInteger, ForeignKey('files.id', use_alter=True, name='fk_user_avatar_file'), nullable=True)
    
    # Relationships
    department = relationship("Department", back_populates="users")
    
    # L∆∞u √Ω: C·∫≠p nh·∫≠t t√™n relationship n·∫øu file_model d√πng t√™n class l√† File
    avatar_file = relationship("File", foreign_keys=[avatar_file_id])
    uploaded_files = relationship("File", back_populates="uploader", foreign_keys="File.uploader_id")
    
    roles = relationship("UserRole", back_populates="user")
    syllabuses = relationship(
        "Syllabus", 
        back_populates="lecturer", 
        primaryjoin="User.id == Syllabus.lecturer_id",
        foreign_keys="Syllabus.lecturer_id"
    )
    comments = relationship("SyllabusComment", back_populates="user")
    notifications = relationship("Notification", back_populates="user")
    workflow_logs = relationship("WorkflowLog", back_populates="actor")
</file>

<file path="apps/api/src/infrastructure/models/user_role_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class UserRole(Base):
    __tablename__ = 'user_roles'
    
    user_id = Column(BigInteger, ForeignKey('users.id'), primary_key=True)
    role_id = Column(BigInteger, ForeignKey('roles.id'), primary_key=True)
    
    # Relationships
    user = relationship("User", back_populates="roles")
    role = relationship("Role", back_populates="user_roles")
</file>

<file path="apps/api/src/infrastructure/models/workflow_log_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.mssql import NVARCHAR
from infrastructure.databases.base import Base


class WorkflowLog(Base):
    __tablename__ = 'workflow_logs'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    syllabus_id = Column(BigInteger, ForeignKey('syllabuses.id'), nullable=False)
    actor_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    action = Column(NVARCHAR(50))  # SUBMIT, APPROVE, REJECT
    from_status = Column(NVARCHAR(50))
    to_status = Column(NVARCHAR(50))
    comment = Column(UnicodeText)
    created_at = Column(DateTime, default=func.now())
    
    # Relationships
    syllabus = relationship("Syllabus", back_populates="workflow_logs")
    actor = relationship("User", back_populates="workflow_logs")
</file>

<file path="apps/api/src/infrastructure/models/workflow_state_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class WorkflowState(Base):
    __tablename__ = 'workflow_states'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    code = Column(NVARCHAR(50), unique=True, nullable=False)
    name = Column(NVARCHAR(100), nullable=False)
    color = Column(NVARCHAR(20))
    is_final = Column(Boolean, default=False)
    
    # Relationships
    transitions_from = relationship("WorkflowTransition", 
                                   foreign_keys="WorkflowTransition.from_state_id",
                                   back_populates="from_state")
    transitions_to = relationship("WorkflowTransition",
                                 foreign_keys="WorkflowTransition.to_state_id",
                                 back_populates="to_state")
    current_workflows = relationship("SyllabusCurrentWorkflow", back_populates="current_state")
</file>

<file path="apps/api/src/infrastructure/models/workflow_transition_model.py">
from datetime import datetime
from sqlalchemy import (
    Column, BigInteger, String, Integer, Date, DateTime, Boolean,
    ForeignKey, UnicodeText, DECIMAL, CheckConstraint, UniqueConstraint
)
from sqlalchemy.dialects.mssql import NVARCHAR
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from infrastructure.databases.base import Base

class WorkflowTransition(Base):
    __tablename__ = 'workflow_transitions'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    from_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    to_state_id = Column(BigInteger, ForeignKey('workflow_states.id'), nullable=False)
    allowed_role_id = Column(BigInteger, ForeignKey('roles.id'), nullable=False)
    action_name = Column(NVARCHAR(50))
    
    # Relationships
    from_state = relationship("WorkflowState", foreign_keys=[from_state_id], back_populates="transitions_from")
    to_state = relationship("WorkflowState", foreign_keys=[to_state_id], back_populates="transitions_to")
    allowed_role = relationship("Role", back_populates="workflow_transitions")
</file>

<file path="apps/api/src/infrastructure/repositories/academic_year_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.academic_year_model import AcademicYear

class AcademicYearRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[AcademicYear]:
        return self.session.query(AcademicYear).all()

    def get_by_id(self, id: int) -> Optional[AcademicYear]:
        return self.session.query(AcademicYear).filter_by(id=id).first()

    def create(self, data: dict) -> AcademicYear:
        ay = AcademicYear(**data)
        self.session.add(ay)
        self.session.commit()
        self.session.refresh(ay)
        return ay

    def update(self, id: int, data: dict) -> Optional[AcademicYear]:
        ay = self.get_by_id(id)
        if not ay:
            return None
        for key, value in data.items():
            if hasattr(ay, key):
                setattr(ay, key, value)
        self.session.commit()
        self.session.refresh(ay)
        return ay

    def delete(self, id: int) -> bool:
        ay = self.get_by_id(id)
        if not ay:
            return False
        self.session.delete(ay)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/ai_auditlog_repository.py">
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.ai_auditlog_model import AiAuditLog

class AiAuditLogRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, syllabus_id: int, action: str, input_tokens: int, output_tokens: int):
        log = AiAuditLog(syllabus_id=syllabus_id, action=action, input_tokens=input_tokens, output_tokens=output_tokens)
        self.session.add(log)
        self.session.commit()
        return log
</file>

<file path="apps/api/src/infrastructure/repositories/assessment_clo_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_clo_model import AssessmentClo
from infrastructure.models.syllabus_clo_model import SyllabusClo

class AssessmentCloRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def add_mapping(self, component_id: int, syllabus_clo_id: int) -> AssessmentClo:
        mapping = AssessmentClo(assessment_component_id=component_id, syllabus_clo_id=syllabus_clo_id)
        self.session.add(mapping)
        self.session.commit()
        return mapping

    def remove_mapping(self, component_id: int, syllabus_clo_id: int) -> bool:
        mapping = self.session.query(AssessmentClo).filter_by(assessment_component_id=component_id, syllabus_clo_id=syllabus_clo_id).first()
        if not mapping:
            return False
        self.session.delete(mapping)
        self.session.commit()
        return True

    def get_clos_by_component(self, component_id: int) -> List[SyllabusClo]:
        mappings = self.session.query(AssessmentClo).filter_by(assessment_component_id=component_id).all()
        return [m.syllabus_clo for m in mappings]
</file>

<file path="apps/api/src/infrastructure/repositories/assessment_component_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_component_model import AssessmentComponent

class AssessmentComponentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[AssessmentComponent]:
        return self.session.query(AssessmentComponent).filter_by(id=id).first()

    def create(self, data: dict) -> AssessmentComponent:
        item = AssessmentComponent(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[AssessmentComponent]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/assessment_scheme_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session, joinedload
from infrastructure.databases.mssql import session
from infrastructure.models.assessment_scheme_model import AssessmentScheme

class AssessmentSchemeRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[AssessmentScheme]:
        return self.session.query(AssessmentScheme).all()

    def get_by_id(self, id: int) -> Optional[AssessmentScheme]:
        return self.session.query(AssessmentScheme).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[AssessmentScheme]:
        # Load components eagerly
        return self.session.query(AssessmentScheme).options(joinedload(AssessmentScheme.components)).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> AssessmentScheme:
        s = AssessmentScheme(**data)
        self.session.add(s)
        self.session.commit()
        self.session.refresh(s)
        return s

    def update(self, id: int, data: dict) -> Optional[AssessmentScheme]:
        s = self.get_by_id(id)
        if not s:
            return None
        for k, v in data.items():
            if hasattr(s, k):
                setattr(s, k, v)
        self.session.commit()
        self.session.refresh(s)
        return s

    def delete(self, id: int) -> bool:
        s = self.get_by_id(id)
        if not s:
            return False
        self.session.delete(s)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/clo_plo_mapping_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.clo_plo_mapping_model import CloPloMapping

class CloPloMappingRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[CloPloMapping]:
        return self.session.query(CloPloMapping).filter_by(id=id).first()

    def get_by_syllabus_clo(self, syllabus_clo_id: int) -> List[CloPloMapping]:
        return self.session.query(CloPloMapping).filter_by(syllabus_clo_id=syllabus_clo_id).all()

    def create(self, data: dict) -> CloPloMapping:
        item = CloPloMapping(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/department_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.department_model import Department

class DepartmentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Department]:
        from sqlalchemy.orm import joinedload
        return self.session.query(Department).options(joinedload(Department.faculty)).all()

    def get_by_id(self, id: int) -> Optional[Department]:
        return self.session.query(Department).filter_by(id=id).first()

    def create(self, data: dict) -> Department:
        department = Department(**data)
        self.session.add(department)
        self.session.commit()
        self.session.refresh(department)
        return department

    def update(self, id: int, data: dict) -> Optional[Department]:
        department = self.get_by_id(id)
        if not department:
            return None
        for key, value in data.items():
            if hasattr(department, key):
                setattr(department, key, value)
        self.session.commit()
        self.session.refresh(department)
        return department

    def delete(self, id: int) -> bool:
        department = self.get_by_id(id)
        if not department:
            return False
        self.session.delete(department)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/faculty_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.faculty_model import Faculty

class FacultyRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Faculty]:
        return self.session.query(Faculty).all()

    def get_by_id(self, id: int) -> Optional[Faculty]:
        return self.session.query(Faculty).filter_by(id=id).first()

    def create(self, data: dict) -> Faculty:
        faculty = Faculty(**data)
        self.session.add(faculty)
        self.session.commit()
        self.session.refresh(faculty)
        return faculty

    def update(self, id: int, data: dict) -> Optional[Faculty]:
        faculty = self.get_by_id(id)
        if not faculty:
            return None
        for key, value in data.items():
            if hasattr(faculty, key):
                setattr(faculty, key, value)
        self.session.commit()
        self.session.refresh(faculty)
        return faculty

    def delete(self, id: int) -> bool:
        faculty = self.get_by_id(id)
        if not faculty:
            return False
        self.session.delete(faculty)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/file_repository.py">
from typing import Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.file_model import File

class FileRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[File]:
        return self.session.query(File).filter_by(id=id).first()

    def create(self, data: dict) -> File:
        file_record = File(**data)
        self.session.add(file_record)
        self.session.commit()
        self.session.refresh(file_record)
        return file_record

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/notification_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.notification_model import Notification

class NotificationRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_user(self, user_id: int, limit: int = 20, unread_only: bool = False) -> List[Notification]:
        query = self.session.query(Notification).filter_by(user_id=user_id)
        if unread_only:
            query = query.filter_by(is_read=False)
        return query.order_by(Notification.created_at.desc()).limit(limit).all()

    def create(self, data: dict) -> Notification:
        item = Notification(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def mark_as_read(self, id: int) -> bool:
        item = self.session.query(Notification).filter_by(id=id).first()
        if not item:
            return False
        item.is_read = True
        self.session.commit()
        return True

    def mark_all_as_read(self, user_id: int):
        self.session.query(Notification).filter_by(user_id=user_id, is_read=False).update({'is_read': True})
        self.session.commit()
</file>

<file path="apps/api/src/infrastructure/repositories/program_outcome_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.program_outcome_model import ProgramOutcome

class ProgramOutcomeRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[ProgramOutcome]:
        return self.session.query(ProgramOutcome).filter_by(id=id).first()

    def get_by_program_id(self, program_id: int) -> List[ProgramOutcome]:
        return self.session.query(ProgramOutcome).filter_by(program_id=program_id).all()

    def create(self, data: dict) -> ProgramOutcome:
        item = ProgramOutcome(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[ProgramOutcome]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/program_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.program_model import Program

class ProgramRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Program]:
        from sqlalchemy.orm import joinedload
        return self.session.query(Program).options(joinedload(Program.department)).all()

    def get_by_id(self, id: int) -> Optional[Program]:
        return self.session.query(Program).filter_by(id=id).first()

    def create(self, data: dict) -> Program:
        p = Program(**data)
        self.session.add(p)
        self.session.commit()
        self.session.refresh(p)
        return p

    def update(self, id: int, data: dict) -> Optional[Program]:
        p = self.get_by_id(id)
        if not p:
            return None
        for key, value in data.items():
            if hasattr(p, key):
                setattr(p, key, value)
        self.session.commit()
        self.session.refresh(p)
        return p

    def delete(self, id: int) -> bool:
        p = self.get_by_id(id)
        if not p:
            return False
        self.session.delete(p)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/role_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.role_model import Role

class RoleRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Role]:
        return self.session.query(Role).all()

    def get_by_id(self, id: int) -> Optional[Role]:
        return self.session.query(Role).filter_by(id=id).first()

    def get_by_name(self, name: str) -> Optional[Role]:
        return self.session.query(Role).filter_by(name=name).first()

    def create(self, data: dict) -> Role:
        role = Role(**data)
        self.session.add(role)
        self.session.commit()
        self.session.refresh(role)
        return role

    def delete(self, id: int) -> bool:
        role = self.get_by_id(id)
        if not role:
            return False
        self.session.delete(role)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/rubric_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.rubric_model import Rubric

class RubricRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[Rubric]:
        return self.session.query(Rubric).filter_by(id=id).first()

    def get_by_component_id(self, component_id: int) -> List[Rubric]:
        return self.session.query(Rubric).filter_by(component_id=component_id).all()

    def create(self, data: dict) -> Rubric:
        item = Rubric(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[Rubric]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/student_report_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.student_report_model import StudentReport

class StudentReportRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, data: dict) -> StudentReport:
        item = StudentReport(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def get_all(self) -> List[StudentReport]:
        return self.session.query(StudentReport).all()

    def update_status(self, id: int, status: str, admin_note: str = None):
        item = self.session.query(StudentReport).filter_by(id=id).first()
        if item:
            item.status = status
            if admin_note: item.admin_note = admin_note
            self.session.commit()
            self.session.refresh(item)
        return item
</file>

<file path="apps/api/src/infrastructure/repositories/student_subscription_repository.py">
from typing import List
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.student_subscription_model import StudentSubscription

class StudentSubscriptionRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def create(self, user_id: int, subject_id: int):
        # Check exists
        exists = self.session.query(StudentSubscription).filter_by(student_id=user_id, subject_id=subject_id).first()
        if exists: return exists
        
        item = StudentSubscription(student_id=user_id, subject_id=subject_id)
        self.session.add(item)
        self.session.commit()
        return item

    def delete(self, user_id: int, subject_id: int):
        item = self.session.query(StudentSubscription).filter_by(student_id=user_id, subject_id=subject_id).first()
        if item:
            self.session.delete(item)
            self.session.commit()
            return True
        return False

    def get_by_student(self, user_id: int) -> List[StudentSubscription]:
        return self.session.query(StudentSubscription).filter_by(student_id=user_id).all()
</file>

<file path="apps/api/src/infrastructure/repositories/subject_relationship_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session, joinedload
from infrastructure.databases.mssql import session
from infrastructure.models.subject_relationship_model import SubjectRelationship

class SubjectRelationshipRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[SubjectRelationship]:
        return self.session.query(SubjectRelationship).filter_by(id=id).first()

    def get_by_subject(self, subject_id: int) -> List[SubjectRelationship]:
        return (self.session.query(SubjectRelationship)
                .options(joinedload(SubjectRelationship.related_subject))
                .filter_by(subject_id=subject_id).all())

    def get_successors(self, subject_id: int) -> List[SubjectRelationship]:
        """Get subjects that have THIS subject as a prerequisite/related subject"""
        return (self.session.query(SubjectRelationship)
                .options(joinedload(SubjectRelationship.subject))
                .filter_by(related_subject_id=subject_id).all())

    def create(self, data: dict) -> SubjectRelationship:
        item = SubjectRelationship(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/subject_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.subject_model import Subject

class SubjectRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[Subject]:
        return self.session.query(Subject).all()

    def get_by_id(self, id: int) -> Optional[Subject]:
        return self.session.query(Subject).filter_by(id=id).first()

    def create(self, data: dict) -> Subject:
        subject = Subject(**data)
        self.session.add(subject)
        self.session.commit()
        self.session.refresh(subject)
        return subject

    def update(self, id: int, data: dict) -> Optional[Subject]:
        subject = self.get_by_id(id)
        if not subject:
            return None
        for key, value in data.items():
            if hasattr(subject, key):
                setattr(subject, key, value)
        self.session.commit()
        self.session.refresh(subject)
        return subject

    def delete(self, id: int) -> bool:
        subject = self.get_by_id(id)
        if not subject:
            return False
        self.session.delete(subject)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_clo_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_clo_model import SyllabusClo

class SyllabusCloRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SyllabusClo]:
        return self.session.query(SyllabusClo).all()

    def get_by_id(self, id: int) -> Optional[SyllabusClo]:
        return self.session.query(SyllabusClo).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[SyllabusClo]:
        return self.session.query(SyllabusClo).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> SyllabusClo:
        item = SyllabusClo(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[SyllabusClo]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_comment_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_comment_model import SyllabusComment

class SyllabusCommentRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[SyllabusComment]:
        return self.session.query(SyllabusComment).filter_by(id=id).first()

    def get_by_syllabus(self, syllabus_id: int) -> List[SyllabusComment]:
        return self.session.query(SyllabusComment).filter_by(syllabus_id=syllabus_id).order_by(SyllabusComment.created_at.asc()).all()

    def create(self, data: dict) -> SyllabusComment:
        item = SyllabusComment(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[SyllabusComment]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_material_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_material_model import SyllabusMaterial

class SyllabusMaterialRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).all()

    def get_by_id(self, id: int) -> Optional[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[SyllabusMaterial]:
        return self.session.query(SyllabusMaterial).filter_by(syllabus_id=syllabus_id).all()

    def create(self, data: dict) -> SyllabusMaterial:
        item = SyllabusMaterial(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/syllabus_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session, joinedload
from sqlalchemy import func
from infrastructure.databases.mssql import session
from infrastructure.models.syllabus_model import Syllabus
from infrastructure.models.assessment_scheme_model import AssessmentScheme
from infrastructure.models.assessment_component_model import AssessmentComponent

class SyllabusRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self, filters: dict = None) -> List[Syllabus]:
        # Eager load related entities to prevent N+1 queries
        query = (self.session.query(Syllabus)
                .options(
                    joinedload(Syllabus.subject),
                    joinedload(Syllabus.program),
                    joinedload(Syllabus.academic_year),
                    joinedload(Syllabus.lecturer)
                ))
        
        if filters:
            if 'status' in filters and filters['status']:
                status_val = filters['status']
                if isinstance(status_val, list):
                    query = query.filter(Syllabus.status.in_(status_val))
                else:
                    query = query.filter(Syllabus.status == status_val)
                
        return query.all()
    
    def get_all_paginated(self, page: int, page_size: int, filters: dict = None):
        """
        Get paginated syllabuses with eager loading
        Returns: (items, total_count)
        """
        query = (self.session.query(Syllabus)
                .options(
                    joinedload(Syllabus.subject),
                    joinedload(Syllabus.program),
                    joinedload(Syllabus.academic_year),
                    joinedload(Syllabus.lecturer)
                ))
        
        if filters:
            if 'status' in filters and filters['status']:
                status_val = filters['status']
                if isinstance(status_val, list):
                    query = query.filter(Syllabus.status.in_(status_val))
                else:
                    query = query.filter(Syllabus.status == status_val)

        query = query.order_by(Syllabus.created_at.desc())
        
        total = query.count()
        offset = (page - 1) * page_size
        items = query.offset(offset).limit(page_size).all()
        
        return items, total

    def get_by_id(self, id: int) -> Optional[Syllabus]:
        return (self.session.query(Syllabus)
                .options(
                    joinedload(Syllabus.subject),
                    joinedload(Syllabus.program),
                    joinedload(Syllabus.academic_year),
                    joinedload(Syllabus.lecturer)
                )
                .filter_by(id=id)
                .first())

    def get_by_subject_id(self, subject_id: int) -> List[Syllabus]:
        return (self.session.query(Syllabus)
                .options(
                    joinedload(Syllabus.subject),
                    joinedload(Syllabus.program),
                    joinedload(Syllabus.academic_year),
                    joinedload(Syllabus.lecturer)
                )
                .filter_by(subject_id=subject_id)
                .all())

    def get_active_by_subject(self, subject_id: int) -> Optional[Syllabus]:
        """Get the published or most recent active syllabus for a subject"""
        return (self.session.query(Syllabus)
                .filter(Syllabus.subject_id == subject_id)
                .filter(Syllabus.status.in_(['PUBLISHED', 'APPROVED']))
                .order_by(Syllabus.created_at.desc())
                .first())

    def get_details(self, id: int) -> Optional[Syllabus]:
        # Eagerly load related metadata AND collections
        return (
            self.session.query(Syllabus)
            .options(
                joinedload(Syllabus.subject),
                joinedload(Syllabus.program),
                joinedload(Syllabus.academic_year),
                joinedload(Syllabus.lecturer),
                joinedload(Syllabus.clos),
                joinedload(Syllabus.materials),
                joinedload(Syllabus.teaching_plans),
                joinedload(Syllabus.assessment_schemes)
                    .joinedload(AssessmentScheme.components)
                    .joinedload(AssessmentComponent.rubrics),
            )
            .filter_by(id=id)
            .first()
        )

    def create(self, data: dict) -> Syllabus:
        s = Syllabus(**data)
        self.session.add(s)
        self.session.commit()
        self.session.refresh(s)
        return s

    def update(self, id: int, data: dict) -> Optional[Syllabus]:
        s = self.get_by_id(id)
        if not s:
            return None
        for key, value in data.items():
            if hasattr(s, key):
                setattr(s, key, value)
        self.session.commit()
        self.session.refresh(s)
        return s

    def delete(self, id: int) -> bool:
        s = self.get_by_id(id)
        if not s:
            return False
        self.session.delete(s)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/system_setting_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.system_setting_model import SystemSetting

class SystemSettingRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[SystemSetting]:
        return self.session.query(SystemSetting).all()

    def get_by_key(self, key: str) -> Optional[SystemSetting]:
        return self.session.query(SystemSetting).filter_by(key=key).first()

    def set_value(self, key: str, value: str, description: str = None, type: str = 'STRING') -> SystemSetting:
        setting = self.get_by_key(key)
        if setting:
            setting.value = value
            if description: setting.description = description
        else:
            setting = SystemSetting(key=key, value=value, type=type, description=description)
            self.session.add(setting)
        self.session.commit()
        self.session.refresh(setting)
        return setting
</file>

<file path="apps/api/src/infrastructure/repositories/teaching_plan_repository.py">
from typing import List, Optional
from sqlalchemy.orm import Session
from infrastructure.databases.mssql import session
from infrastructure.models.teaching_plan_model import TeachingPlan

class TeachingPlanRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_by_id(self, id: int) -> Optional[TeachingPlan]:
        return self.session.query(TeachingPlan).filter_by(id=id).first()

    def get_by_syllabus_id(self, syllabus_id: int) -> List[TeachingPlan]:
        return self.session.query(TeachingPlan).filter_by(syllabus_id=syllabus_id).order_by(TeachingPlan.week).all()

    def create(self, data: dict) -> TeachingPlan:
        item = TeachingPlan(**data)
        self.session.add(item)
        self.session.commit()
        self.session.refresh(item)
        return item

    def update(self, id: int, data: dict) -> Optional[TeachingPlan]:
        item = self.get_by_id(id)
        if not item:
            return None
        for k, v in data.items():
            if hasattr(item, k):
                setattr(item, k, v)
        self.session.commit()
        self.session.refresh(item)
        return item

    def delete(self, id: int) -> bool:
        item = self.get_by_id(id)
        if not item:
            return False
        self.session.delete(item)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/user_repository.py">
from typing import List, Optional
from dotenv import load_dotenv
import os
from sqlalchemy.orm import Session
from infrastructure.databases import Base
from infrastructure.databases.mssql import session

# Import the User model
from infrastructure.models.user_model import User

load_dotenv()

class UserRepository:
    def __init__(self, session: Session = session):
        self.session = session

    def get_all(self) -> List[User]:
        return self.session.query(User).all()

    def get_by_username(self, username: str) -> Optional[User]:
        """Get user by username with input validation."""
        if not username or not isinstance(username, str):
            return None
        username = username.strip()
        if not username:
            return None
        return self.session.query(User).filter_by(username=username).first()

    def get_by_id(self, user_id: int) -> Optional[User]:
        return self.session.query(User).filter_by(id=user_id).first()

    def create(self, data: dict) -> User:
        user = User(**data)
        self.session.add(user)
        self.session.commit()
        self.session.refresh(user)
        return user

    def update(self, id: int, data: dict) -> Optional[User]:
        user = self.get_by_id(id)
        if not user:
            return None
        for key, value in data.items():
            if hasattr(user, key):
                setattr(user, key, value)
        self.session.commit()
        self.session.refresh(user)
        return user

    def delete(self, id: int) -> bool:
        user = self.get_by_id(id)
        if not user:
            return False
        
        # Delete related user_roles entries first (junction table)
        from infrastructure.models.user_role_model import UserRole
        self.session.query(UserRole).filter(UserRole.user_id == id).delete()
        
        # Now delete the user
        self.session.delete(user)
        self.session.commit()
        return True
</file>

<file path="apps/api/src/infrastructure/repositories/workflow_log_repository.py">
from typing import List
from infrastructure.models.workflow_log_model import WorkflowLog

class WorkflowLogRepository:
    def __init__(self, session):
        self.session = session

    def create(self, data: dict):
        wl = WorkflowLog(**data)
        self.session.add(wl)
        try:
            self.session.commit()
            self.session.refresh(wl)
            return wl
        except Exception:
            self.session.rollback()
            raise

    def get_by_syllabus_id(self, syllabus_id: int) -> List[WorkflowLog]:
        return self.session.query(WorkflowLog).filter_by(syllabus_id=syllabus_id).order_by(WorkflowLog.created_at.asc()).all()
</file>

<file path="apps/api/src/infrastructure/services/...  # Services that use third party libraries or services (e.g. email service)">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/migrations">
# This directory contains database migration files.
</file>

<file path="apps/api/src/requirements_additional.txt">
# Flask-Caching
flask-caching>=2.0.0

# Load testing
locust>=2.0.0

# Testing
pytest>=7.0.0
pytest-flask>=1.2.0
pytest-cov>=4.0.0
</file>

<file path="apps/api/src/requirements.txt">
Flask>=2.0
Flask-Cors>=3.0
Flask-SQLAlchemy>=2.5
SQLAlchemy>=1.4
marshmallow>=3.0
pymssql>=2.2
python-dotenv>=0.21 
Flask-RESTX>=1.1.0 
flasgger
fastapi
apispec
apispec_webframeworks
flask-swagger-ui
dependency-injector>=4.0
PyJWT>=2.0
google-genai>=0.1
flask-socketio>=5.3.0
python-socketio>=5.7.0
eventlet>=0.33.0
flask-mail>=0.9.1
celery>=5.3.0
redis>=5.0.0
pytesseract>=0.3.10
pdf2image>=1.16.0
opencv-python>=4.8.0
Pillow>=10.0.0
elasticsearch>=8.0.0
</file>

<file path="apps/api/src/scripts/import_check.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src
try:
    import services.syllabus_service as ss
    import services.ai_service as ai
    import api.schemas.syllabus_schema as sch
    import services.program_outcome_service as plo_svc
    import api.controllers.program_outcome_controller as plo_ctrl
    import services.file_service as file_svc
    import api.controllers.file_controller as file_ctrl
    import services.clo_plo_mapping_service as mapping_svc
    import api.controllers.clo_plo_mapping_controller as mapping_ctrl
    import services.subject_relationship_service as rel_svc
    import api.controllers.subject_relationship_controller as rel_ctrl
    import services.syllabus_comment_service as comment_svc
    import api.controllers.syllabus_comment_controller as comment_ctrl
    import services.notification_service as notif_svc
    import api.controllers.notification_controller as notif_ctrl
    import infrastructure.repositories.ai_auditlog_repository as audit_repo
    import services.system_setting_service as ss_svc
    import api.controllers.system_setting_controller as ss_ctrl
    import services.student_service as student_svc
    import api.controllers.student_controller as student_ctrl
    print('IMPORT_OK')
except Exception as e:
    print('IMPORT_FAIL', repr(e))
    raise
</file>

<file path="apps/api/src/scripts/run_postgres.sh">
#!/bin/bash

# Function to check if PostgreSQL is running
is_postgres_running() {
    pg_isready -q
    return $?
}

# Start PostgreSQL if it's not already running
if ! is_postgres_running; then
    echo "PostgreSQL is not running. Starting it now..."
    pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start
else
    echo "PostgreSQL is already running."
fi

# Create the database if it doesn't exist
if ! psql -lqt | cut -d \| -f 1 | grep -qw dbname; then
    createdb dbname
fi
</file>

<file path="apps/api/src/scripts/seed_users.py">
from dependency_container import Container
from datetime import date


def get_or_create(service, list_method_name, check_attr, check_value, create_method_name, create_data):
    list_method = getattr(service, list_method_name)
    for item in list_method():
        if getattr(item, check_attr) == check_value:
            return item
    create_method = getattr(service, create_method_name)
    return create_method(create_data)


def seed():
    container = Container()

    # Services
    role_service = container.role_service()
    user_service = container.user_service()
    faculty_service = container.faculty_service()
    department_service = container.department_service()
    academic_year_service = container.academic_year_service()
    program_service = container.program_service()
    subject_service = container.subject_service()
    syllabus_service = container.syllabus_service()
    syllabus_clo_service = container.syllabus_clo_service()
    syllabus_material_service = container.syllabus_material_service()

    # 1) Roles
    admin_role = role_service.get_by_name('ADMIN') or role_service.create_role({'name': 'ADMIN', 'description': 'ADMIN role'})
    print('‚úÖ  Role:', admin_role.name)
    lecturer_role = role_service.get_by_name('LECTURER') or role_service.create_role({'name': 'LECTURER', 'description': 'LECTURER role'})
    print('‚úÖ  Role:', lecturer_role.name)

    # 2) Users
    admin = user_service.get_by_username('admin')
    if not admin:
        admin = user_service.create_user({'username': 'admin', 'email': 'admin@example.com', 'full_name': 'Admin User', 'password': 'password123', 'is_active': True})
        print('‚úÖ  Created User: admin')
    else:
        print('‚úÖ  Found User: admin')

    lecturer = user_service.get_by_username('lecturer')
    if not lecturer:
        lecturer = user_service.create_user({'username': 'lecturer', 'email': 'lecturer@example.com', 'full_name': 'Lecturer User', 'password': 'password123', 'is_active': True})
        print('‚úÖ  Created User: lecturer')
    else:
        print('‚úÖ  Found User: lecturer')

    # Assign roles idempotently
    session = container.db_session()
    from infrastructure.models.user_role_model import UserRole

    def ensure_role(user, role):
        if not session.query(UserRole).filter_by(user_id=user.id, role_id=role.id).first():
            try:
                session.add(UserRole(user_id=user.id, role_id=role.id))
                session.commit()
                print(f"‚úÖ  Assigned role {role.name} to user {user.username}")
            except Exception:
                session.rollback()

    ensure_role(admin, admin_role)
    ensure_role(lecturer, lecturer_role)

    # 3) Faculty & Department
    faculty = get_or_create(faculty_service, 'list_faculties', 'code', 'FIT', 'create_faculty', {'code': 'FIT', 'name': 'Faculty of Information Technology'})
    print(f"‚úÖ  Faculty: {faculty.code} - {faculty.name}")

    department = None
    # department needs faculty_id
    for d in department_service.list_departments():
        if d.code == 'SE' and d.faculty_id == faculty.id:
            department = d
            break
    if not department:
        department = department_service.create_department({'faculty_id': faculty.id, 'code': 'SE', 'name': 'Software Engineering'})
        print('‚úÖ  Created Department: SE')
    else:
        print('‚úÖ  Found Department: SE')

    # 4) Academic Year, Program, Subject
    academic_year = get_or_create(academic_year_service, 'list_academic_years', 'code', '2025-2026', 'create_academic_year', {'code': '2025-2026', 'start_date': date(2025,9,1), 'end_date': date(2026,6,30)})
    print(f"‚úÖ  AcademicYear: {academic_year.code}")

    program = get_or_create(program_service, 'list_programs', 'name', 'Software Engineering K18', 'create_program', {'department_id': department.id, 'name': 'Software Engineering K18', 'total_credits': 120})
    print(f"‚úÖ  Program: {program.name}")

    subject = None
    for s in subject_service.list_subjects():
        if s.code == 'SWT301' and s.department_id == department.id:
            subject = s
            break
    if not subject:
        subject = subject_service.create_subject({'department_id': department.id, 'code': 'SWT301', 'name_vi': 'Gi·ªõi thi·ªáu K·ªπ thu·∫≠t Ph·∫ßn m·ªÅm', 'name_en': 'Introduction to Software Engineering', 'credits': 3})
        print('‚úÖ  Created Subject: SWT301')
    else:
        print('‚úÖ  Found Subject: SWT301')

    # 5) Syllabus
    syllabus = None
    for sy in syllabus_service.list_syllabuses():
        if sy.subject_id == subject.id and sy.program_id == program.id and sy.academic_year_id == academic_year.id:
            syllabus = sy
            break
    if not syllabus:
        syllabus = syllabus_service.create_syllabus({'subject_id': subject.id, 'program_id': program.id, 'academic_year_id': academic_year.id, 'lecturer_id': lecturer.id, 'version': '1.0'})
        print(f"‚úÖ  Created Syllabus ID: {syllabus.id}")
    else:
        print(f"‚úÖ  Found Syllabus ID: {syllabus.id}")

    # 6) Syllabus Details - CLOs
    existing_clos = {c.code for c in syllabus_clo_service.get_by_syllabus(syllabus.id)}
    clos_to_add = [
        {'code': 'CLO1', 'description': 'Explain software lifecycle.'},
        {'code': 'CLO2', 'description': 'Apply software requirements engineering.'},
        {'code': 'CLO3', 'description': 'Design basic software architecture.'},
    ]
    for clo in clos_to_add:
        if clo['code'] not in existing_clos:
            item = syllabus_clo_service.create_clo({'syllabus_id': syllabus.id, **clo})
            print(f"‚úÖ  Added CLO: {item.code}")
        else:
            print(f"‚úÖ  CLO exists: {clo['code']}")

    # Materials
    existing_mats = {m.title for m in syllabus_material_service.get_by_syllabus(syllabus.id)}
    mats_to_add = [
        {'type': 'MAIN', 'title': 'Software Engineering (Textbook)', 'author': 'Ian Sommerville', 'publisher': 'Pearson', 'isbn': '1234567890', 'syllabus_id': syllabus.id},
        {'type': 'REFERENCE', 'title': 'Design Patterns', 'author': 'Gamma et al.', 'publisher': 'Addison-Wesley', 'isbn': '0987654321', 'syllabus_id': syllabus.id},
    ]
    for mat in mats_to_add:
        if mat['title'] not in existing_mats:
            item = syllabus_material_service.create_material(mat)
            print(f"‚úÖ  Added Material: {item.title}")
        else:
            print(f"‚úÖ  Material exists: {mat['title']}")

    # Teaching Plans
    teaching_plan_service = container.teaching_plan_service()
    existing_weeks = {p.week for p in teaching_plan_service.list_plans_for_syllabus(syllabus.id)}
    plans_to_add = [
        {'week': 1, 'topic': 'Introduction to Software Engineering', 'activity': 'Lecture', 'assessment': 'Quiz', 'syllabus_id': syllabus.id},
        {'week': 2, 'topic': 'Software Process Models', 'activity': 'Lecture', 'assessment': 'Assignment 1', 'syllabus_id': syllabus.id},
        {'week': 3, 'topic': 'Requirements Engineering', 'activity': 'Lecture', 'assessment': 'Assignment 2', 'syllabus_id': syllabus.id},
    ]
    for plan in plans_to_add:
        if plan['week'] not in existing_weeks:
            item = teaching_plan_service.create_teaching_plan(plan)
            print(f"‚úÖ  Added Teaching Plan Week: {item.week}")
        else:
            print(f"‚úÖ  Teaching Plan exists for week: {plan['week']}")

    # Assessments: Schemes, Components, Rubrics, CLO mappings
    assessment_scheme_service = container.assessment_scheme_service()
    assessment_component_service = container.assessment_component_service()
    rubric_service = container.rubric_service()
    assessment_clo_service = container.assessment_clo_service()

    existing_schemes = {s.name for s in assessment_scheme_service.list_schemes_for_syllabus(syllabus.id)}

    # Example scheme: Midterm
    if 'Midterm' not in existing_schemes:
        scheme = assessment_scheme_service.create_scheme({'syllabus_id': syllabus.id, 'name': 'Midterm', 'weight': 30.0})
        print(f"‚úÖ  Created Assessment Scheme: {scheme.name}")
        comp = assessment_component_service.create_component({'scheme_id': scheme.id, 'name': 'Midterm Exam', 'weight': 30.0})
        print(f"‚úÖ  Created Assessment Component: {comp.name}")
        rubric = rubric_service.create_rubric({'component_id': comp.id, 'criteria': 'Comprehensive exam', 'max_score': 100})
        print(f"‚úÖ  Created Rubric for component: {rubric.criteria}")
        # Map to CLO1 if exists
        clo1 = None
        for c in syllabus_clo_service.get_by_syllabus(syllabus.id):
            if c.code == 'CLO1':
                clo1 = c
                break
        if clo1:
            assessment_clo_service.add_mapping(comp.id, clo1.id)
            print(f"‚úÖ  Mapped component {comp.name} to CLO {clo1.code}")
    else:
        print('‚úÖ  Midterm scheme exists')

    print('\n‚úÖ  Seeding complete!')


if __name__ == '__main__':
    seed()
</file>

<file path="apps/api/src/SDM-workspace.code-workspace">
{
	"folders": [
		{
			"path": ".."
		},
		{
			"path": "../../FE_SDM"
		}
	]
}
</file>

<file path="apps/api/src/services/...  # Services for interacting with the domain (business logic)">
# This file is intentionally left blank.
</file>

<file path="apps/api/src/services/academic_year_service.py">
from typing import List, Optional
from infrastructure.repositories.academic_year_repository import AcademicYearRepository

class AcademicYearService:
    def __init__(self, repository: AcademicYearRepository):
        self.repository = repository

    def list_academic_years(self) -> List:
        return self.repository.get_all()

    def get_academic_year(self, id: int):
        return self.repository.get_by_id(id)

    def create_academic_year(self, data: dict):
        return self.repository.create(data)

    def update_academic_year(self, id: int, data: dict):
        # If activating this academic year, deactivate all others
        if data.get('is_active') or data.get('isActive'):
            all_years = self.repository.get_all()
            for year in all_years:
                if year.id != id and year.is_active:
                    self.repository.update(year.id, {'is_active': False})
            # Ensure the data uses snake_case for database
            data['is_active'] = True
            data.pop('isActive', None)  # Remove camelCase if present
        return self.repository.update(id, data)

    def delete_academic_year(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/ai_service.py">
import os
import json
from datetime import datetime

# Prefer the new `google-genai` package
try:
    from google import genai
    _NEW_GENAI = True
except ImportError:
    try:
        import google.generativeai as genai
        _NEW_GENAI = False
    except ImportError:
        genai = None
        _NEW_GENAI = False


class AiService:
    def __init__(self, api_key: str = None, audit_repository=None):
        self.api_key = api_key or os.getenv('GEMINI_API_KEY')
        self.audit_repository = audit_repository

    def _log_usage(self, syllabus_id, action, in_tok, out_tok):
        if self.audit_repository and syllabus_id:
            try:
                self.audit_repository.create(syllabus_id, action, in_tok, out_tok)
            except Exception as e:
                print(f'Failed to log AI usage: {e}')

    def compare_syllabuses(self, base_data: dict, target_data: dict):
        """Analyze changes between two syllabus versions using AI"""
        if not self.api_key:
            return {"error": "Ch∆∞a c·∫•u h√¨nh GEMINI_API_KEY"}

        prompt = f"""
        B·∫°n l√† m·ªôt chuy√™n gia kh·∫£o th√≠ v√† ki·ªÉm ƒë·ªãnh ch·∫•t l∆∞·ª£ng gi√°o d·ª•c. 
        H√£y ph√¢n t√≠ch s·ª± thay ƒë·ªïi gi·ªØa hai phi√™n b·∫£n ƒë·ªÅ c∆∞∆°ng h·ªçc ph·∫ßn d∆∞·ªõi ƒë√¢y.
        
        Phi√™n b·∫£n 1 (C≈©): {json.dumps(base_data, ensure_ascii=False)}
        Phi√™n b·∫£n 2 (M·ªõi): {json.dumps(target_data, ensure_ascii=False)}
        
        H√£y cung c·∫•p b√°o c√°o so s√°nh chi ti·∫øt b·∫±ng ti·∫øng Vi·ªát, t·∫≠p trung v√†o:
        1. C√°c thay ƒë·ªïi v·ªÅ c·∫•u tr√∫c (S·ªë t√≠n ch·ªâ, ph√¢n b·ªï th·ªùi gian).
        2. S·ª± thay ƒë·ªïi v·ªÅ Chu·∫©n ƒë·∫ßu ra (CLO) - c√≥ th√™m/b·ªõt hay thay ƒë·ªïi ƒë·ªông t·ª´ Bloom kh√¥ng?
        3. S·ª± thay ƒë·ªïi v·ªÅ N·ªôi dung gi·∫£ng d·∫°y v√† H√¨nh th·ª©c ƒë√°nh gi√°.
        4. ƒê√°nh gi√° t√°c ƒë·ªông: Vi·ªác thay ƒë·ªïi n√†y c√≥ l√†m tƒÉng/gi·∫£m ƒë·ªô kh√≥ hay kh·ªëi l∆∞·ª£ng h·ªçc t·∫≠p kh√¥ng?
        
        Tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng JSON v·ªõi c·∫•u tr√∫c:
        {{
            "summary": "T√≥m t·∫Øt ng·∫Øn g·ªçn thay ƒë·ªïi ch√≠nh (2-3 c√¢u)",
            "detailed_analysis": [
                {{"category": "T√™n h·∫°ng m·ª•c", "change_type": "Added/Removed/Modified/Unchanged", "description": "M√¥ t·∫£ chi ti·∫øt s·ª± thay ƒë·ªïi"}}
            ],
            "impact_assessment": "ƒê√°nh gi√° chuy√™n m√¥n v·ªÅ t√°c ƒë·ªông c·ªßa c√°c thay ƒë·ªïi n√†y",
            "is_significant_change": true/false
        }}
        """

        try:
            model_name = os.getenv('AI_MODEL', 'gemini-3-flash-preview')
            if model_name.startswith('models/'):
                model_name = model_name.replace('models/', '')

            if _NEW_GENAI:
                client = genai.Client(api_key=self.api_key)
                # Config with JSON mode if supported
                response = client.models.generate_content(
                    model=model_name,
                    contents=prompt,
                    config={"response_mime_type": "application/json"}
                )
                text = response.text
            else:
                genai.configure(api_key=self.api_key)
                model = genai.GenerativeModel(model_name)
                response = model.generate_content(prompt)
                text = response.text

            # Parse JSON from response
            try:
                # Remove markdown code blocks if any
                if text.startswith("```json"):
                    text = text.replace("```json", "", 1).replace("```", "", 1).strip()
                elif text.startswith("```"):
                    text = text.replace("```", "", 2).strip()
                return json.loads(text)
            except Exception as pe:
                print(f"JSON Parse Error in AI Compare: {pe}")
                return {"summary": text, "error": "AI returned non-JSON response"}

        except Exception as e:
            print(f"AI Compare Error: {e}")
            return {"error": f"L·ªói AI: {str(e)}"}

    def analyze_clo_plo_alignment(self, clos_data: list, plos_data: list, mappings_data: list):
        """Ph√¢n t√≠ch m·ª©c ƒë·ªô ƒë√≥ng g√≥p c·ªßa CLO v√†o PLO gi√∫p ki·ªÉm ƒë·ªãnh ch·∫•t l∆∞·ª£ng"""
        if not self.api_key:
            return {"error": "Ch∆∞a c·∫•u h√¨nh GEMINI_API_KEY"}

        prompt = f"""
        B·∫°n l√† m·ªôt chuy√™n gia v·ªÅ thi·∫øt k·∫ø ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o theo chu·∫©n ƒë·∫ßu ra (Outcome-Based Education - OBE).
        H√£y ph√¢n t√≠ch ma tr·∫≠n thu·∫≠n ngh·ªãch gi·ªØa Chu·∫©n ƒë·∫ßu ra H·ªçc ph·∫ßn (CLO) v√† Chu·∫©n ƒë·∫ßu ra Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o (PLO).

        Danh s√°ch CLOs: {json.dumps(clos_data, ensure_ascii=False)}
        Danh s√°ch PLOs: {json.dumps(plos_data, ensure_ascii=False)}
        Ma tr·∫≠n Mapping hi·ªán t·∫°i: {json.dumps(mappings_data, ensure_ascii=False)}
        (Ghi ch√∫: Mapping level I=Introduced, R=Reinforced, M=Mastered, A=Assessed)

        H√£y th·ª±c hi·ªán:
        1. ƒê√°nh gi√° xem c√°c CLO c√≥ n·ªôi dung ph√π h·ª£p ƒë·ªÉ h·ªó tr·ª£ c√°c PLO t∆∞∆°ng ·ª©ng kh√¥ng?
        2. C√°c ƒë·ªông t·ª´ Bloom trong CLO ƒë√£ ƒë·ªß m·ª©c ƒë·ªô ƒë·ªÉ ƒë√°p ·ª©ng y√™u c·∫ßu c·ªßa PLO ch∆∞a?
        3. Ph√°t hi·ªán c√°c "ƒëi·ªÉm m√π": C√≥ PLO n√†o quan tr·ªçng m√† kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ ƒë·ªß b·ªüi c√°c CLO kh√¥ng?
        4. ƒê·ªÅ xu·∫•t c·∫£i thi·ªán Mapping ho·∫∑c c·∫£i thi·ªán c√°ch ph√°t bi·ªÉu CLO.

        Tr·∫£ v·ªÅ k·∫øt qu·∫£ JSON:
        {{
            "overall_score": 0-100,
            "analysis": "Nh·∫≠n x√©t t·ªïng qu√°t",
            "strengths": ["ƒêi·ªÉm m·∫°nh 1", "ƒêi·ªÉm m·∫°nh 2"],
            "weaknesses": ["ƒêi·ªÉm y·∫øu 1", "ƒêi·ªÉm y·∫øu 2"],
            "suggestions": [
                {{"clo": "CLO code", "suggestion": "ƒê·ªÅ xu·∫•t s·ª≠a n·ªôi dung ho·∫∑c m·ª©c ƒë·ªô Bloom"}},
                {{"plo": "PLO code", "issue": "PLO n√†y ƒëang thi·∫øu ƒë√≥ng g√≥p t·ª´ m√¥n h·ªçc n√†y"}}
            ],
            "is_valid": true/false
        }}
        """

        try:
            model_name = os.getenv('AI_MODEL', 'gemini-3-flash-preview')
            if model_name.startswith('models/'):
                model_name = model_name.replace('models/', '')

            if _NEW_GENAI:
                client = genai.Client(api_key=self.api_key)
                response = client.models.generate_content(
                    model=model_name,
                    contents=prompt,
                    config={"response_mime_type": "application/json"}
                )
                text = response.text
            else:
                genai.configure(api_key=self.api_key)
                model = genai.GenerativeModel(model_name)
                response = model.generate_content(prompt)
                text = response.text

            try:
                if text.startswith("```json"):
                    text = text.replace("```json", "", 1).replace("```", "", 1).strip()
                return json.loads(text)
            except:
                return {"analysis": text, "error": "AI returned non-JSON response"}
        except Exception as e:
            return {"error": f"L·ªói AI: {str(e)}"}

    def generate(self, subject_name: str, syllabus_id: int = None):
        if not self.api_key:
            return {"error": "Ch∆∞a c·∫•u h√¨nh GEMINI_API_KEY"}

        if genai is None:
            return {"error": "No generative AI client installed (install google-genai)"}

        # Complete Template matching frontend SyllabusData interface
        json_template = {
            "subject_name_vi": subject_name,
            "subject_name_en": "...",
            "subject_code": "XXX101",
            "credits": 3,
            "time_allocation": { 
                "theory": 30, 
                "exercises": 15, 
                "practice": 15, 
                "self_study": 90 
            },
            "prerequisites": "Kh√¥ng c√≥ y√™u c·∫ßu ti√™n quy·∫øt",
            "pre_courses": "Kh√¥ng",
            "co_courses": "Kh√¥ng",
            "course_type": "B·∫Øt bu·ªôc",
            "component_type": "C∆° s·ªü ng√†nh",
            "description": "M√¥ t·∫£ chi ti·∫øt v·ªÅ m√¥n h·ªçc, m·ª•c ti√™u, n·ªôi dung ch√≠nh...",
            "objectives": [
                "M·ª•c ti√™u 1: Sinh vi√™n hi·ªÉu ƒë∆∞·ª£c...",
                "M·ª•c ti√™u 2: Sinh vi√™n v·∫≠n d·ª•ng ƒë∆∞·ª£c...",
                "M·ª•c ti√™u 3: Sinh vi√™n ph√¢n t√≠ch ƒë∆∞·ª£c..."
            ],
            "clos": [
                { "code": "CLO1", "description": "Tr√¨nh b√†y ƒë∆∞·ª£c ki·∫øn th·ª©c c∆° b·∫£n v·ªÅ..." },
                { "code": "CLO2", "description": "V·∫≠n d·ª•ng ƒë∆∞·ª£c k·ªπ nƒÉng..." },
                { "code": "CLO3", "description": "Ph√¢n t√≠ch ƒë∆∞·ª£c v·∫•n ƒë·ªÅ..." },
                { "code": "CLO4", "description": "ƒê√°nh gi√° ƒë∆∞·ª£c..." },
                { "code": "CLO5", "description": "Thi·∫øt k·∫ø ƒë∆∞·ª£c..." }
            ],
            "plo_mapping": [
                { "clo_code": "CLO1", "plos": { "PLO1": "H", "PLO2": "M" } },
                { "clo_code": "CLO2", "plos": { "PLO3": "H", "PLO4": "M" } }
            ],
            "student_duties": "Sinh vi√™n c·∫ßn tham gia ƒë·∫ßy ƒë·ªß c√°c bu·ªïi h·ªçc, ho√†n th√†nh b√†i t·∫≠p, ƒë·ªçc t√†i li·ªáu tr∆∞·ªõc bu·ªïi h·ªçc...",
            "assessment_scheme": [
                { 
                    "component": "ƒêi·ªÉm qu√° tr√¨nh", 
                    "method": "B√†i t·∫≠p, th·∫£o lu·∫≠n, ki·ªÉm tra nh·ªè", 
                    "clos": "CLO1, CLO2", 
                    "criteria": "ƒê·ªô ch√≠nh x√°c, k·ªπ nƒÉng tr√¨nh b√†y", 
                    "weight": 40 
                },
                { 
                    "component": "Ki·ªÉm tra gi·ªØa k·ª≥", 
                    "method": "B√†i ki·ªÉm tra vi·∫øt", 
                    "clos": "CLO1, CLO2, CLO3", 
                    "criteria": "Ki·∫øn th·ª©c l√Ω thuy·∫øt, v·∫≠n d·ª•ng", 
                    "weight": 20 
                },
                { 
                    "component": "Thi cu·ªëi k·ª≥", 
                    "method": "B√†i thi vi·∫øt ho·∫∑c project", 
                    "clos": "CLO3, CLO4, CLO5", 
                    "criteria": "T·ªïng h·ª£p ki·∫øn th·ª©c, ·ª©ng d·ª•ng th·ª±c t·∫ø", 
                    "weight": 40 
                }
            ],
            "teaching_plan": [
                { "week": "1", "topic": "Gi·ªõi thi·ªáu m√¥n h·ªçc", "clos": "CLO1", "activity": "Gi·∫£ng, th·∫£o lu·∫≠n", "assessment": "Kh√¥ng" },
                { "week": "2", "topic": "Ch·ªß ƒë·ªÅ 1", "clos": "CLO1", "activity": "Gi·∫£ng, b√†i t·∫≠p", "assessment": "B√†i t·∫≠p nh√≥m" },
                { "week": "3-15", "topic": "...", "clos": "...", "activity": "...", "assessment": "..." }
            ],
            "materials": [
                { "type": "Main", "title": "T√™n t√°c gi·∫£, NƒÉm xu·∫•t b·∫£n, T√™n s√°ch, Nh√† xu·∫•t b·∫£n, ISBN (n·∫øu c√≥)" },
                { "type": "Main", "title": "..." },
                { "type": "Main", "title": "..." },
                { "type": "Ref", "title": "..." },
                { "type": "Ref", "title": "..." }
            ],
            "other_requirements": "Sinh vi√™n c·∫ßn c√≥ m√°y t√≠nh c√° nh√¢n c√†i ƒë·∫∑t c√°c ph·∫ßn m·ªÅm li√™n quan. Y√™u c·∫ßu tham gia ƒë·∫ßy ƒë·ªß c√°c bu·ªïi th·ª±c h√†nh t·∫°i ph√≤ng lab. C·∫ßn chu·∫©n b·ªã t√†i li·ªáu v√† ho√†n th√†nh b√†i t·∫≠p tr∆∞·ªõc m·ªói bu·ªïi h·ªçc.",
            "date_prepared": "2026-01-15",
            "date_edited": "2026-01-15",
            "lecturer": "TS. Nguy·ªÖn VƒÉn A",
            "head_department": "PGS.TS. Tr·∫ßn VƒÉn B",
            "dean": "GS.TS. L√™ VƒÉn C"
        }

        prompt = f"""
B·∫°n l√† chuy√™n gia thi·∫øt k·∫ø ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o ƒë·∫°i h·ªçc t·∫°i Vi·ªát Nam. H√£y t·∫°o m·ªôt ƒê·ªÄ C∆Ø∆†NG H·ªåC PH·∫¶N HO√ÄN CH·ªàNH cho m√¥n h·ªçc: "{subject_name}"

‚ö†Ô∏è Y√äU C·∫¶U B·∫ÆT BU·ªòC - PH·∫¢I TU√ÇN TH·ª¶ 100%:
1. Tr·∫£ v·ªÅ ƒê√öNG format JSON nh∆∞ template, KH√îNG th√™m markdown (```json) hay gi·∫£i th√≠ch
2. ‚≠ê QUAN TR·ªåNG NH·∫§T: ƒêi·ªÅn ƒê·∫¶Y ƒê·ª¶ T·∫§T C·∫¢ 9 M·ª§C, KH√îNG ƒë∆∞·ª£c b·ªè tr·ªëng hay ƒë·ªÉ "..."
3. N·ªôi dung ph·∫£i ph√π h·ª£p v·ªõi gi√°o d·ª•c ƒë·∫°i h·ªçc Vi·ªát Nam
4. C√°c m·ª•c c√≤n ƒêANG TR·ªêNG c·∫ßn ƒë·∫∑c bi·ªát ch√∫ √Ω ƒëi·ªÅn ƒë·∫ßy ƒë·ªß: M·ª§C 1 (subject_code, time_allocation, course_type), M·ª§C 5 (student_duties CHI TI·∫æT), M·ª§C 6 (assessment_scheme ƒê·∫¶Y ƒê·ª¶ 3 items), M·ª§C 7 (teaching_plan ƒê·ª¶ 15 TU·∫¶N), M·ª§C 9 (dates, lecturer, head_department, dean, other_requirements)

CHI TI·∫æT T·ª™NG M·ª§C:

üìö 1. TH√îNG TIN CHUNG:
- subject_name_en: D·ªãch chu·∫©n h·ªçc thu·∫≠t sang ti·∫øng Anh
- subject_code: M√£ HP 6-7 k√Ω t·ª± (VD: IT101, MATH201, PHY301)
- credits: S·ªë t√≠n ch·ªâ (th∆∞·ªùng 2-4)
- time_allocation: theory (30-45 ti·∫øt), exercises (0-15), practice (0-30), self_study (90-180)
- prerequisites: "Kh√¥ng" ho·∫∑c t√™n HP c·ª• th·ªÉ
- pre_courses: HP h·ªçc tr∆∞·ªõc (n·∫øu c√≥)
- co_courses: HP h·ªçc song song (n·∫øu c√≥)
- course_type: "B·∫Øt bu·ªôc" ho·∫∑c "T·ª± ch·ªçn"
- component_type: "C∆° s·ªü ng√†nh", "Chuy√™n ng√†nh", "ƒê·∫°i c∆∞∆°ng"

üéØ 2-4. M·ª§C TI√äU & CƒêR:
- description: 3-5 c√¢u m√¥ t·∫£ t·ªïng quan m√¥n h·ªçc
- objectives: M·∫£ng 3-5 m·ª•c ti√™u c·ª• th·ªÉ, r√µ r√†ng
- clos: T·ªêI THI·ªÇU 5 CLOs, m·ªói CLO:
  * code: "CLO1", "CLO2"...
  * description: B·∫Øt ƒë·∫ßu ƒë·ªông t·ª´ h√†nh ƒë·ªông (Tr√¨nh b√†y, Gi·∫£i th√≠ch, V·∫≠n d·ª•ng, Ph√¢n t√≠ch, ƒê√°nh gi√°, Thi·∫øt k·∫ø...)
- plo_mapping: Map t·ª´ng CLO v·ªõi PLO1-PLO6, gi√° tr·ªã: "H" (Cao), "M" (Trung b√¨nh), "L" (Th·∫•p)

üë§ 5. SINH VI√äN:
- student_duties: 3-5 c√¢u v·ªÅ tr√°ch nhi·ªám SV (tham gia l·ªõp, l√†m b√†i t·∫≠p, t·ª± h·ªçc...)

üìä 6. ƒê√ÅNH GI√Å:
- assessment_scheme: T·ªêI THI·ªÇU 3 th√†nh ph·∫ßn, t·ªïng weight = 100:
  * Qu√° tr√¨nh (30-50%): B√†i t·∫≠p, th·∫£o lu·∫≠n, ki·ªÉm tra nh·ªè
  * Gi·ªØa k·ª≥ (15-30%): Ki·ªÉm tra vi·∫øt
  * Cu·ªëi k·ª≥ (30-50%): Thi cu·ªëi k·ª≥ ho·∫∑c project
  * M·ªói item c√≥ ƒë·∫ßy ƒë·ªß: component, method, clos, criteria, weight

üìÖ 7. K·∫æ HO·∫†CH:
- teaching_plan: ƒê·ª¶ 15 TU·∫¶N, m·ªói tu·∫ßn c√≥:
  * week: "1", "2"... ƒë·∫øn "15"
  * topic: N·ªôi dung c·ª• th·ªÉ c·ªßa tu·∫ßn ƒë√≥
  * clos: CLO li√™n quan
  * activity: "Gi·∫£ng", "Th·∫£o lu·∫≠n", "Th·ª±c h√†nh", "B√†i t·∫≠p nh√≥m"...
  * assessment: "B√†i t·∫≠p", "Ki·ªÉm tra", "Kh√¥ng"...

üìñ 8. T√ÄI LI·ªÜU:
- materials: T·ªêI THI·ªÇU 6 items (3 Main + 3 Ref):
  * type: "Main" ho·∫∑c "Ref"
  * title: "T√°c gi·∫£ (nƒÉm). T√™n s√°ch. Nh√† xu·∫•t b·∫£n. ISBN (n·∫øu c√≥)"
  * D√πng t√™n s√°ch TH·∫¨T ho·∫∑c h·ª£p l√Ω v·ªõi m√¥n h·ªçc

üîß 9. KH√ÅC (B·∫ÆT BU·ªòC ƒêI·ªÄN ƒê·∫¶Y ƒê·ª¶):
- other_requirements: Y√™u c·∫ßu kh√°c (m√°y t√≠nh, ph·∫ßn m·ªÅm, thi·∫øt b·ªã...) - ƒêI·ªÄN C·ª§ TH·ªÇ
- date_prepared: "2026-01-15" (ƒë·ªãnh d·∫°ng YYYY-MM-DD)
- date_edited: "2026-01-15" (ƒë·ªãnh d·∫°ng YYYY-MM-DD)
- lecturer: "TS. Nguy·ªÖn VƒÉn A" (t√™n gi·∫£ ƒë·ªãnh v·ªõi h·ªçc h√†m h·ªçc v·ªã)
- head_department: "PGS.TS. Tr·∫ßn VƒÉn B" (PH·∫¢I C√ì)
- dean: "GS.TS. L√™ VƒÉn C" (PH·∫¢I C√ì)

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è KI·ªÇM TRA TR∆Ø·ªöC KHI TR·∫¢ V·ªÄ:
‚úÖ M·ª•c 1: subject_code, credits, time_allocation (4 fields), course_type, component_type - C√ì H·∫æT CH∆ØA?
‚úÖ M·ª•c 5: student_duties √≠t nh·∫•t 3 c√¢u - C√ì CH∆ØA?
‚úÖ M·ª•c 6: assessment_scheme c√≥ ƒê·ª¶ 3 items, t·ªïng weight = 100 - C√ì CH∆ØA?
‚úÖ M·ª•c 7: teaching_plan c√≥ ƒê·ª¶ 15 tu·∫ßn - C√ì CH∆ØA?
‚úÖ M·ª•c 9: dates, lecturer, head_department, dean, other_requirements - C√ì H·∫æT CH∆ØA?

TEMPLATE JSON CHU·∫®N (PH·∫¢I ƒêI·ªÄN H·∫æT T·∫§T C·∫¢ C√ÅC TR∆Ø·ªúNG N√ÄY):
{json.dumps(json_template, ensure_ascii=False, indent=2)}

üö®üö®üö® C·∫¢NH B√ÅO CU·ªêI C√ôNG: Output cu·ªëi c√πng PH·∫¢I l√† JSON ho√†n ch·ªânh v·ªõi T·∫§T C·∫¢ c√°c tr∆∞·ªùng ƒë∆∞·ª£c ƒëi·ªÅn, KH√îNG c√≥ "...", KH√îNG b·ªè tr·ªëng b·∫•t k·ª≥ tr∆∞·ªùng n√†o!
        """

        try:
            model_name = os.getenv('AI_MODEL', 'gemini-3-flash-preview')
            if model_name.startswith('models/'):
                model_name = model_name.replace('models/', '')
            
            max_tokens = int(os.getenv('AI_MAX_TOKENS', 16384))
            temperature = float(os.getenv('AI_TEMPERATURE', 1.0))

            if _NEW_GENAI:
                # Initialize client
                client = genai.Client(api_key=self.api_key)
                
                # In some versions of google-genai, the method is client.models.generate_content
                # and for others it might be slightly different. 
                # According to latest docs, it's client.models.generate_content(model='...', contents='...')
                response = client.models.generate_content(
                    model=model_name,
                    contents=prompt,
                    config={
                        "response_mime_type": "application/json",
                        "max_output_tokens": max_tokens,
                        "temperature": temperature
                    }
                )
                resp_text = response.text
            else:

                # Legacy package behavior
                genai.configure(api_key=self.api_key)
                model = genai.GenerativeModel(model_name)
                generation_config = {
                    "max_output_tokens": max_tokens,
                    "temperature": temperature,
                    "response_mime_type": "application/json"
                }
                response = model.generate_content(prompt, generation_config=generation_config)
                resp_text = getattr(response, "text", "")

            # Clean markdown formatting if present
            clean_text = resp_text
            if "```json" in clean_text:
                clean_text = clean_text.split("```json")[1].split("```")[0].strip()
            elif "```" in clean_text:
                clean_text = clean_text.split("```")[1].split("```")[0].strip()
            clean_text = clean_text.strip()
            
            # Log to file for debugging
            try:
                log_dir = os.path.join(os.path.dirname(__file__), '..', 'logs')
                os.makedirs(log_dir, exist_ok=True)
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                log_file = os.path.join(log_dir, f"ai_response_{timestamp}.txt")
                
                with open(log_file, 'w', encoding='utf-8') as f:
                    f.write("=" * 80 + "\n")
                    f.write(f"TIMESTAMP: {datetime.now().isoformat()}\n")
                    f.write(f"SUBJECT NAME: {subject_name}\n")
                    f.write("=" * 80 + "\n\n")
                    
                    f.write("PROMPT:\n")
                    f.write("-" * 80 + "\n")
                    f.write(prompt + "\n")
                    f.write("-" * 80 + "\n\n")
                    
                    f.write("RAW RESPONSE:\n")
                    f.write("-" * 80 + "\n")
                    f.write(resp_text + "\n")
                    f.write("-" * 80 + "\n\n")
                    
                    f.write("CLEANED JSON:\n")
                    f.write("-" * 80 + "\n")
                    f.write(clean_text + "\n")
                    f.write("-" * 80 + "\n")
                    
                print(f"[AI LOG] Response saved to: {log_file}")
            except Exception as log_err:
                print(f"[AI LOG ERROR] Failed to write log: {log_err}")
            
            # Simple token estimation
            input_tokens = len(prompt.split())
            output_tokens = len(clean_text.split())

            # Log usage if syllabus_id provided
            self._log_usage(syllabus_id, 'GENERATE', input_tokens, output_tokens)

            return json.loads(clean_text)
        except Exception as e:
            print(f"AI Generate Error: {e}")
            # Attempt to log error usage
            try:
                self._log_usage(syllabus_id, 'ERROR', 0, 0)
            except: pass
            return {"error": str(e)}

    def summarize_syllabus(self, syllabus_data: dict, syllabus_id: int = None):
        """Summarize an existing syllabus using AI"""
        if not self.api_key:
            return {"error": "Ch∆∞a c·∫•u h√¨nh GEMINI_API_KEY"}

        prompt = f"""
B·∫°n l√† m·ªôt c·ªë v·∫•n h·ªçc t·∫≠p. H√£y t√≥m t·∫Øt ƒë·ªÅ c∆∞∆°ng h·ªçc ph·∫ßn sau ƒë√¢y m·ªôt c√°ch ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu cho sinh vi√™n.
N·ªôi dung t√≥m t·∫Øt kho·∫£ng 150-200 t·ª´, t·∫≠p trung v√†o:
1. M√¥n h·ªçc n√†y d·∫°y v·ªÅ c√°i g√¨ n·ªïi b·∫≠t?
2. K·ªπ nƒÉng quan tr·ªçng nh·∫•t sinh vi√™n s·∫Ω ƒë·∫°t ƒë∆∞·ª£c?
3. L∆∞u √Ω quan tr·ªçng v·ªÅ c√°ch h·ªçc ho·∫∑c ƒë√°nh gi√°?

D·ªØ li·ªáu ƒë·ªÅ c∆∞∆°ng:
T√™n m√¥n: {syllabus_data.get('subject_name_vi')}
M√¥ t·∫£: {syllabus_data.get('description')}
M·ª•c ti√™u: {json.dumps(syllabus_data.get('objectives', []), ensure_ascii=False)}
CLOs: {json.dumps([c.get('description') for c in syllabus_data.get('clos', [])], ensure_ascii=False)}

Y√äU C·∫¶U: Tr·∫£ v·ªÅ k·∫øt qu·∫£ l√† chu·ªói vƒÉn b·∫£n thu·∫ßn t√∫y, c√≥ xu·ªëng d√≤ng h·ª£p l√Ω, KH√îNG C√ì ƒë·ªãnh d·∫°ng Markdown (nh∆∞ bold, heading) hay JSON.
"""

        try:
            model_name = os.getenv('AI_MODEL', 'gemini-3-flash-preview')
            if model_name.startswith('models/'):
                model_name = model_name.replace('models/', '')

            if _NEW_GENAI:
                client = genai.Client(api_key=self.api_key)
                response = client.models.generate_content(
                    model=model_name,
                    contents=prompt
                )
                resp_text = response.text
            else:
                genai.configure(api_key=self.api_key)
                model = genai.GenerativeModel(model_name)
                response = model.generate_content(prompt)
                resp_text = getattr(response, "text", "")

            # Log usage
            try:
                self._log_usage(syllabus_id, 'SUMMARIZE', len(prompt.split()), len(resp_text.split()))
            except: pass

            return {"summary": resp_text.strip()}
        except Exception as e:
            print(f"AI Summarize Error: {e}")
            return {"error": str(e)}
</file>

<file path="apps/api/src/services/assessment_clo_service.py">
from typing import List
from infrastructure.repositories.assessment_clo_repository import AssessmentCloRepository

class AssessmentCloService:
    def __init__(self, repository: AssessmentCloRepository, component_repository=None, syllabus_clo_repository=None, assessment_scheme_repository=None):
        self.repository = repository
        self.component_repository = component_repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.assessment_scheme_repository = assessment_scheme_repository

    def get_clos_for_component(self, component_id: int) -> List:
        return self.repository.get_clos_by_component(component_id)

    def add_mapping(self, component_id: int, syllabus_clo_id: int):
        component = self.component_repository.get_by_id(component_id)
        if not component:
            raise ValueError('Invalid component_id')
        syllabus_clo = self.syllabus_clo_repository.get_by_id(syllabus_clo_id)
        if not syllabus_clo:
            raise ValueError('Invalid syllabus_clo_id')

        # Determine the syllabus id for the component (via scheme relationship or scheme repository)
        comp_syllabus_id = None
        if getattr(component, 'scheme', None):
            comp_syllabus_id = component.scheme.syllabus_id
        elif hasattr(component, 'scheme_id'):
            if not self.assessment_scheme_repository:
                raise ValueError('Cannot determine component syllabus without assessment_scheme_repository')
            scheme = self.assessment_scheme_repository.get_by_id(component.scheme_id)
            if not scheme:
                raise ValueError('Invalid component: linked scheme not found')
            comp_syllabus_id = scheme.syllabus_id
        else:
            raise ValueError('Invalid component: cannot resolve related scheme')

        # Ensure both belong to the same syllabus
        if comp_syllabus_id != syllabus_clo.syllabus_id:
            raise ValueError('Cross-reference Error: Component and CLO must belong to the same Syllabus')

        return self.repository.add_mapping(component_id, syllabus_clo_id)

    def remove_mapping(self, component_id: int, syllabus_clo_id: int) -> bool:
        return self.repository.remove_mapping(component_id, syllabus_clo_id)
</file>

<file path="apps/api/src/services/assessment_component_service.py">
from typing import Optional
from infrastructure.repositories.assessment_component_repository import AssessmentComponentRepository

class AssessmentComponentService:
    def __init__(self, repository: AssessmentComponentRepository, scheme_repository=None):
        self.repository = repository
        self.scheme_repository = scheme_repository

    def get_component(self, id: int):
        return self.repository.get_by_id(id)

    def create_component(self, data: dict):
        scheme_id = data.get('scheme_id')
        if not scheme_id or not self.scheme_repository.get_by_id(scheme_id):
            raise ValueError('Invalid scheme_id')
        return self.repository.create(data)

    def update_component(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_component(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/assessment_scheme_service.py">
from typing import List, Optional
from infrastructure.repositories.assessment_scheme_repository import AssessmentSchemeRepository

class AssessmentSchemeService:
    def __init__(self, repository: AssessmentSchemeRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_schemes_for_syllabus(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus_id(syllabus_id)

    def get_scheme(self, id: int):
        return self.repository.get_by_id(id)

    def create_scheme(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_scheme(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_scheme(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/clo_plo_mapping_service.py">
from typing import List
from infrastructure.repositories.clo_plo_mapping_repository import CloPloMappingRepository

class CloPloMappingService:
    def __init__(self, repository: CloPloMappingRepository, syllabus_clo_repository=None, program_outcome_repository=None):
        self.repository = repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.program_outcome_repository = program_outcome_repository

    def get_by_clo(self, clo_id: int) -> List:
        return self.repository.get_by_syllabus_clo(clo_id)

    def create_mapping(self, data: dict):
        clo_id = data.get('syllabus_clo_id')
        plo_id = data.get('program_plo_id')
        
        if not self.syllabus_clo_repository.get_by_id(clo_id):
            raise ValueError('Invalid syllabus_clo_id')
        if not self.program_outcome_repository.get_by_id(plo_id):
            raise ValueError('Invalid program_plo_id')
            
        return self.repository.create(data)

    def delete_mapping(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/department_service.py">
from typing import List, Optional
from infrastructure.repositories.department_repository import DepartmentRepository

class DepartmentService:
    def __init__(self, repository: DepartmentRepository):
        self.repository = repository

    def list_departments(self) -> List:
        return self.repository.get_all()

    def get_department(self, id: int):
        return self.repository.get_by_id(id)

    def create_department(self, data: dict):
        return self.repository.create(data)

    def update_department(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_department(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/faculty_service.py">
from typing import List, Optional
from infrastructure.repositories.faculty_repository import FacultyRepository

class FacultyService:
    def __init__(self, repository: FacultyRepository):
        self.repository = repository

    def list_faculties(self) -> List:
        return self.repository.get_all()

    def get_faculty(self, id: int):
        return self.repository.get_by_id(id)

    def create_faculty(self, data: dict):
        return self.repository.create(data)

    def update_faculty(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_faculty(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/file_service.py">
import os
import uuid
from werkzeug.utils import secure_filename
from infrastructure.repositories.file_repository import FileRepository

UPLOAD_FOLDER = 'static/uploads'
ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx'}

class FileService:
    def __init__(self, repository: FileRepository):
        self.repository = repository
        if not os.path.exists(UPLOAD_FOLDER):
            os.makedirs(UPLOAD_FOLDER)

    def _allowed_file(self, filename):
        return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

    def upload_file(self, file_storage, uploader_id: int):
        if not file_storage or file_storage.filename == '':
            raise ValueError('No file selected')
        if not self._allowed_file(file_storage.filename):
            raise ValueError('File type not allowed')

        filename = secure_filename(file_storage.filename)
        unique_name = f"{uuid.uuid4()}_{filename}"
        file_path = os.path.join(UPLOAD_FOLDER, unique_name)
        
        # Save to disk
        file_storage.save(file_path)

        # Save to DB
        file_data = {
            'uploader_id': uploader_id,
            'file_name': filename,
            'file_path': file_path,
            'mime_type': file_storage.mimetype,
            'file_size': 0 # Optional: implement size check
        }
        return self.repository.create(file_data)
        
    def get_file(self, id: int):
        return self.repository.get_by_id(id)
</file>

<file path="apps/api/src/services/notification_service.py">
from typing import List
from infrastructure.repositories.notification_repository import NotificationRepository
from utils.socket_io import notify_user

class NotificationService:
    def __init__(self, repository: NotificationRepository, user_repository=None, email_service=None):
        self.repository = repository
        self.user_repository = user_repository
        self.email_service = email_service

    def get_user_notifications(self, user_id: int, unread_only: bool = False) -> List:
        return self.repository.get_by_user(user_id, unread_only=unread_only)

    def send_notification(self, user_id: int, title: str, message: str, link: str = None, type: str = 'SYSTEM', event_name: str = 'new_notification', send_email: bool = True):
        user = None
        if self.user_repository:
             user = self.user_repository.get_by_id(user_id)
             if not user:
                 raise ValueError('User not found')
        
        data = {
            'user_id': user_id,
            'title': title,
            'message': message,
            'link': link,
            'type': type,
            'is_read': False
        }
        
        # Save to DB
        notif = self.repository.create(data)
        
        # Emit via SocketIO for real-time update
        notify_user(user_id, event_name, {
            'id': notif.id,
            'title': title,
            'message': message,
            'link': link,
            'type': type,
            'is_read': False,
            'created_at': notif.created_at.isoformat() if hasattr(notif, 'created_at') and notif.created_at else None
        })

        # Send Email if requested and service available
        if send_email and self.email_service and user:
            # We don't want to block the response if email sending takes time
            # Ideally this should be a background task (Celery), but for now we do it inline
            # with safe try-except in the EmailService
            self.email_service.notify_user(user, title, message)
        
        return notif

    def notify_roles(self, roles: List[str], title: str, message: str, link: str = None, type: str = 'SYSTEM', event_name: str = 'new_notification'):
        """Send notification to all users belonging to specific roles"""
        if not self.user_repository:
            return
            
        users = self.user_repository.get_all()
        target_users = []
        for u in users:
            u_roles = [r.name for r in u.roles] if hasattr(u, 'roles') else []
            if any(role in u_roles for role in roles):
                target_users.append(u)
        
        for u in target_users:
            self.send_notification(u.id, title, message, link, type, event_name)

    def mark_read(self, id: int) -> bool:
        return self.repository.mark_as_read(id)

    def mark_all_read(self, user_id: int):
        return self.repository.mark_all_as_read(user_id)
</file>

<file path="apps/api/src/services/program_outcome_service.py">
from typing import List
from infrastructure.repositories.program_outcome_repository import ProgramOutcomeRepository

class ProgramOutcomeService:
    def __init__(self, repository: ProgramOutcomeRepository, program_repository=None):
        self.repository = repository
        self.program_repository = program_repository

    def list_by_program(self, program_id: int) -> List:
        return self.repository.get_by_program_id(program_id)

    def create_plo(self, data: dict):
        program_id = data.get('program_id')
        if not program_id or not self.program_repository.get_by_id(program_id):
            raise ValueError('Invalid program_id')
        return self.repository.create(data)

    def update_plo(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_plo(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/program_service.py">
from typing import List, Optional
from infrastructure.repositories.program_repository import ProgramRepository

class ProgramService:
    def __init__(self, repository: ProgramRepository):
        self.repository = repository

    def list_programs(self) -> List:
        return self.repository.get_all()

    def get_program(self, id: int):
        return self.repository.get_by_id(id)

    def create_program(self, data: dict):
        return self.repository.create(data)

    def update_program(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_program(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/role_service.py">
from typing import List, Optional
from infrastructure.repositories.role_repository import RoleRepository

class RoleService:
    def __init__(self, repository: RoleRepository):
        self.repository = repository

    def list_roles(self) -> List:
        return self.repository.get_all()

    def get_role(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_name(self, name: str):
        return self.repository.get_by_name(name)

    def create_role(self, data: dict):
        return self.repository.create(data)

    def delete_role(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/rubric_service.py">
from typing import List, Optional
from infrastructure.repositories.rubric_repository import RubricRepository

class RubricService:
    def __init__(self, repository: RubricRepository, component_repository=None):
        self.repository = repository
        self.component_repository = component_repository

    def list_rubrics_for_component(self, component_id: int) -> List:
        return self.repository.get_by_component_id(component_id)

    def get_rubric(self, id: int):
        return self.repository.get_by_id(id)

    def create_rubric(self, data: dict):
        component_id = data.get('component_id')
        if not component_id or not self.component_repository.get_by_id(component_id):
            raise ValueError('Invalid component_id')
        return self.repository.create(data)

    def update_rubric(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_rubric(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/student_service.py">
from typing import List
from infrastructure.repositories.student_subscription_repository import StudentSubscriptionRepository
from infrastructure.repositories.student_report_repository import StudentReportRepository

class StudentService:
    def __init__(self, sub_repo: StudentSubscriptionRepository, report_repo: StudentReportRepository):
        self.sub_repo = sub_repo
        self.report_repo = report_repo

    def subscribe(self, user_id: int, subject_id: int):
        return self.sub_repo.create(user_id, subject_id)

    def unsubscribe(self, user_id: int, subject_id: int):
        return self.sub_repo.delete(user_id, subject_id)

    def get_subscriptions(self, user_id: int):
        return self.sub_repo.get_by_student(user_id)

    def report_syllabus(self, user_id: int, syllabus_id: int, content: str):
        return self.report_repo.create({'student_id': user_id, 'syllabus_id': syllabus_id, 'content': content})

    def list_reports(self):
        return self.report_repo.get_all()

    def resolve_report(self, id: int, status: str, note: str = None):
        return self.report_repo.update_status(id, status, note)
</file>

<file path="apps/api/src/services/subject_relationship_service.py">
from typing import List
from infrastructure.repositories.subject_relationship_repository import SubjectRelationshipRepository

class SubjectRelationshipService:
    def __init__(self, repository: SubjectRelationshipRepository, subject_repository=None):
        self.repository = repository
        self.subject_repository = subject_repository

    def get_relationships(self, subject_id: int) -> List:
        return self.repository.get_by_subject(subject_id)

    def get_tree(self, subject_id: int):
        """
        Get recursive pre-reqs and successors for a subject tree view.
        Uses a visited set to avoid infinite loops in cyclical dependencies.
        """
        prerequisites = []
        successors = []
        
        # Helper for recursive search
        def find_prereqs(sid, visited):
            if sid in visited:
                return
            visited.add(sid)
            
            rels = self.repository.get_by_subject(sid)
            for r in rels:
                if r not in prerequisites:
                    prerequisites.append(r)
                if r.related_subject_id:
                    find_prereqs(r.related_subject_id, visited)

        def find_successors(sid, visited):
            if sid in visited:
                return
            visited.add(sid)
            
            rels = self.repository.get_successors(sid)
            for r in rels:
                if r not in successors:
                    successors.append(r)
                if r.subject_id:
                    find_successors(r.subject_id, visited)

        find_prereqs(subject_id, set())
        # Reset visited for successors search
        find_successors(subject_id, set())
        
        return {
            "prerequisites": prerequisites,
            "successors": successors
        }

    def add_relationship(self, data: dict):
        subject_id = data.get('subject_id')
        related_id = data.get('related_subject_id')
        
        if subject_id == related_id:
            raise ValueError('Subject cannot be related to itself')
        
        if not self.subject_repository.get_by_id(subject_id):
            raise ValueError('Invalid subject_id')
        if not self.subject_repository.get_by_id(related_id):
            raise ValueError('Invalid related_subject_id')
            
        return self.repository.create(data)

    def remove_relationship(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/subject_service.py">
from typing import List, Optional
from infrastructure.repositories.subject_repository import SubjectRepository

class SubjectService:
    def __init__(self, repository: SubjectRepository):
        self.repository = repository

    def list_subjects(self) -> List:
        return self.repository.get_all()

    def get_subject(self, id: int):
        return self.repository.get_by_id(id)

    def create_subject(self, data: dict):
        return self.repository.create(data)

    def update_subject(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_subject(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_clo_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_clo_repository import SyllabusCloRepository

class SyllabusCloService:
    def __init__(self, repository: SyllabusCloRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_clos(self) -> List:
        return self.repository.get_all()

    def get_clo(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_syllabus(self, syllabus_id: int):
        return self.repository.get_by_syllabus_id(syllabus_id)

    def create_clo(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_clo(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_clo(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_comment_service.py">
from typing import List
from infrastructure.repositories.syllabus_comment_repository import SyllabusCommentRepository

class SyllabusCommentService:
    def __init__(self, repository: SyllabusCommentRepository, syllabus_repository=None, user_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository
        self.user_repository = user_repository

    def get_comments(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus(syllabus_id)

    def add_comment(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        user_id = data.get('user_id')
        
        if not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        if not self.user_repository.get_by_id(user_id):
            raise ValueError('Invalid user_id')
            
        return self.repository.create(data)

    def resolve_comment(self, id: int):
        return self.repository.update(id, {'is_resolved': True})

    def delete_comment(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_material_service.py">
from typing import List, Optional
from infrastructure.repositories.syllabus_material_repository import SyllabusMaterialRepository

class SyllabusMaterialService:
    def __init__(self, repository: SyllabusMaterialRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_materials(self) -> List:
        return self.repository.get_all()

    def get_material(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_syllabus(self, syllabus_id: int):
        return self.repository.get_by_syllabus_id(syllabus_id)

    def create_material(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def delete_material(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/syllabus_service.py">
from typing import List, Optional
from datetime import datetime, timedelta
from infrastructure.repositories.syllabus_repository import SyllabusRepository
from domain.constants import WorkflowStatus
from infrastructure.models.workflow_log_model import WorkflowLog
from utils.logging_config import get_logger

logger = get_logger(__name__)

class SyllabusService:
    def __init__(self, repository: SyllabusRepository,
                 subject_repository=None,
                 program_repository=None,
                 academic_year_repository=None,
                 user_repository=None,
                 workflow_log_repository=None,
                 syllabus_clo_repository=None,
                 syllabus_material_repository=None,
                 teaching_plan_repository=None,
                 assessment_scheme_repository=None,
                 assessment_component_repository=None,
                 rubric_repository=None,
                 assessment_clo_repository=None,
                 notification_service=None,
                 snapshot_service=None,
                 current_workflow_repository=None,
                 clo_plo_mapping_repository=None,
                 program_outcome_repository=None):
        self.repository = repository
        self.subject_repository = subject_repository
        self.program_repository = program_repository
        self.academic_year_repository = academic_year_repository
        self.user_repository = user_repository
        self.workflow_log_repository = workflow_log_repository
        self.syllabus_clo_repository = syllabus_clo_repository
        self.syllabus_material_repository = syllabus_material_repository
        self.teaching_plan_repository = teaching_plan_repository
        self.assessment_scheme_repository = assessment_scheme_repository
        self.assessment_component_repository = assessment_component_repository
        self.rubric_repository = rubric_repository
        self.assessment_clo_repository = assessment_clo_repository
        self.notification_service = notification_service
        self.snapshot_service = snapshot_service
        self.current_workflow_repository = current_workflow_repository
        self.clo_plo_mapping_repository = clo_plo_mapping_repository
        self.program_outcome_repository = program_outcome_repository

    def get_kpis(self):
        """Calculate operational KPIs for Principal dashboard"""
        from datetime import datetime
        syllabuses = self.repository.get_all()
        # total stats
        total = len(syllabuses)
        pending = len([s for s in syllabuses if 'PENDING' in (s.status or '').upper()])
        
        # Calculate avg review time (SUBMIT to first APPROVE)
        review_times = []
        if self.workflow_log_repository:
            logs = self.workflow_log_repository.session.query(WorkflowLog).order_by(WorkflowLog.created_at).all()
            # Map syllabus -> [submit_time, first_approve_time]
            timing = {}
            for l in logs:
                sid = l.syllabus_id
                if sid not in timing: timing[sid] = [None, None]
                
                if l.action == 'SUBMIT' and not timing[sid][0]:
                    timing[sid][0] = l.created_at
                elif l.action == 'APPROVE' and timing[sid][0] and not timing[sid][1]:
                    timing[sid][1] = l.created_at
            
            for sid, times in timing.items():
                if times[0] and times[1]:
                    delta = (times[1] - times[0]).total_seconds() / 3600 # hours
                    review_times.append(delta)
        
        avg_hours = sum(review_times) / len(review_times) if review_times else 0
        
        return {
            "total_syllabuses": total,
            "pending_count": pending,
            "avg_review_time_hours": round(avg_hours, 1),
            "compliance_rate": round((total - pending) / total * 100, 1) if total > 0 else 0
        }

    def list_syllabuses(self, filters: dict = None) -> List:
        logger.info(f"Listing all syllabuses - filters: {filters}")
        try:
            result = self.repository.get_all(filters=filters)
            logger.info(f"Retrieved {len(result)} syllabuses")
            return result
        except Exception as e:
            logger.error(f"Error listing syllabuses: {str(e)}", exc_info=True)
            raise
    
    def list_syllabuses_paginated(self, page: int, page_size: int, filters: dict = None):
        """Get paginated list of syllabuses"""
        logger.info(f"Listing syllabuses - page {page}, size {page_size}, filters: {filters}")
        try:
            items, total = self.repository.get_all_paginated(page, page_size, filters=filters)
            logger.info(f"Retrieved {len(items)} of {total} syllabuses")
            return items, total
        except Exception as e:
            logger.error(f"Error listing paginated syllabuses: {str(e)}", exc_info=True)
            raise

    def check_workflow_deadlines(self):
        """Check all active workflows for overdue deadlines and send notifications."""
        if not self.current_workflow_repository or not self.notification_service:
            logger.warning("Deadline checker: Missing repository or notification service")
            return 0
        
        overdue_items = self.current_workflow_repository.get_overdue()
        count = 0
        for item in overdue_items:
            # Notify stakeholders based on state
            s = self.repository.get_by_id(item.syllabus_id)
            if not s: continue
            
            roles_to_notify = []
            if item.state == WorkflowStatus.PENDING:
                roles_to_notify = ['Head of Dept', 'Admin']
            elif item.state == WorkflowStatus.PENDING_APPROVAL:
                roles_to_notify = ['Academic Affairs', 'Admin']
            elif item.state == WorkflowStatus.PENDING_FINAL_APPROVAL:
                roles_to_notify = ['Principal', 'Admin']
            
            if roles_to_notify:
                self.notification_service.notify_roles(
                    roles=roles_to_notify,
                    title='C·∫¢NH B√ÅO QU√Å H·∫†N DUY·ªÜT',
                    message=f'ƒê·ªÅ c∆∞∆°ng m√¥n {s.subject.code if s.subject else "N/A"} ({item.state}) ƒë√£ qu√° h·∫°n duy·ªát ({item.due_date.strftime("%d/%m/%Y")}).',
                    link=f'/syllabus/{item.syllabus_id}',
                    event_name='workflow_overdue'
                )
                count += 1
                logger.info(f"Sent overdue notification for syllabus {item.syllabus_id}")
        
        return count

    def get_syllabus(self, id: int):
        return self.repository.get_by_id(id)

    def get_syllabus_details(self, id: int):
        return self.repository.get_details(id)

    def get_by_subject(self, subject_id: int):
        return self.repository.get_by_subject_id(subject_id)

    def _validate_assessment_weights(self, schemes_data: List):
        """Ensure each assessment scheme total weight is 100%"""
        if not schemes_data:
            return
            
        for scheme in schemes_data:
            components = scheme.get('components', [])
            total_weight = sum([float(c.get('weight', 0)) for c in components])
            # Use a small epsilon for float comparison
            if abs(total_weight - 100.0) > 0.1:
                scheme_name = scheme.get('name', 'ph∆∞∆°ng ph√°p ƒë√°nh gi√°')
                raise ValueError(f'T·ªïng tr·ªçng s·ªë c·ªßa {scheme_name} ph·∫£i b·∫±ng 100% (hi·ªán t·∫°i: {total_weight}%).')

    def create_syllabus(self, data: dict):
        import json
        from sqlalchemy.exc import IntegrityError
        from infrastructure.models.syllabus_model import Syllabus
        from infrastructure.models.syllabus_clo_model import SyllabusClo
        
        # Extract child data
        clos_data = data.pop('clos', [])
        materials_data = data.pop('materials', [])
        plans_data = data.pop('teaching_plans', [])
        schemes_data = data.pop('assessment_schemes', [])

        # Strict weight validation for non-drafts
        target_status = data.get('status', 'DRAFT').upper()
        if target_status != 'DRAFT':
            self._validate_assessment_weights(schemes_data)

        # Process JSON fields
        if 'time_allocation' in data and data['time_allocation'] is not None:
            if not isinstance(data['time_allocation'], str):
                data['time_allocation'] = json.dumps(data['time_allocation'])
        
        if 'objectives' in data and data['objectives'] is not None:
            if not isinstance(data['objectives'], str):
                data['objectives'] = json.dumps(data['objectives'])

        # Validate Foreign Keys
        subject_id = data.get('subject_id')
        if not subject_id or not self.subject_repository.get_by_id(subject_id):
            raise ValueError('Invalid subject_id')
        program_id = data.get('program_id')
        if not program_id or not self.program_repository.get_by_id(program_id):
            raise ValueError('Invalid program_id')
        academic_year_id = data.get('academic_year_id')
        if not academic_year_id or not self.academic_year_repository.get_by_id(academic_year_id):
            raise ValueError('Invalid academic_year_id')
        lecturer_id = data.get('lecturer_id')
        if not lecturer_id or not self.user_repository.get_by_id(lecturer_id):
            raise ValueError('Invalid lecturer_id')
        
        # Check for duplicate syllabus (same combo + same status)
        from infrastructure.models.syllabus_model import Syllabus
        target_status = data.get('status', 'DRAFT')
        existing = self.repository.session.query(Syllabus).filter_by(
            subject_id=subject_id,
            program_id=program_id,
            academic_year_id=academic_year_id,
            status=target_status
        ).first()
        
        if existing:
            subject = self.subject_repository.get_by_id(subject_id)
            status_map = {'DRAFT': 'b·∫£n nh√°p', 'APPROVED': 'b·∫£n ƒë√£ duy·ªát', 'PENDING': 'b·∫£n ch·ªù duy·ªát', 'REJECTED': 'b·∫£n b·ªã t·ª´ ch·ªëi'}
            status_vn = status_map.get(existing.status, existing.status)
            raise ValueError(f'ƒê√£ t·ªìn t·∫°i m·ªôt {status_vn} cho m√¥n {subject.name_vi if subject else "n√†y"} trong ch∆∞∆°ng tr√¨nh v√† nƒÉm h·ªçc n√†y (ID: {existing.id}).')

        # Filter data to only include valid columns for Syllabus model
        valid_columns = [c.key for c in Syllabus.__table__.columns]
        syllabus_data = {k: v for k, v in data.items() if k in valid_columns}
        
        # Use transaction to ensure atomicity
        try:
            # Create Header (don't commit yet to allow nested children)
            syllabus_data.setdefault('status', 'DRAFT')
            new_syllabus = Syllabus(**syllabus_data)
            self.repository.session.add(new_syllabus)
            self.repository.session.flush() # Get ID without committing
            sid = new_syllabus.id
            logger.info(f"Created syllabus header with ID: {sid}")

            # 1. Save CLOs
            if self.syllabus_clo_repository:
                for item in clos_data:
                    raw_plo_mappings = item.pop('plo_mappings', {}) or item.pop('ploMappings', {})
                    # Standardize to dict
                    plo_mappings = {}
                    if isinstance(raw_plo_mappings, list):
                        for m in raw_plo_mappings:
                            if isinstance(m, dict) and ('code' in m or 'ploCode' in m) and 'level' in m:
                                code = m.get('code') or m.get('ploCode')
                                plo_mappings[code] = m['level']
                    elif isinstance(raw_plo_mappings, dict):
                        plo_mappings = raw_plo_mappings
                    item['syllabus_id'] = sid
                    new_clo = self.syllabus_clo_repository.create(item)
                    
                    # Save PLO mappings
                    if plo_mappings and self.clo_plo_mapping_repository and self.program_outcome_repository:
                        from infrastructure.models.program_outcome_model import ProgramOutcome
                        for plo_code, level in plo_mappings.items():
                            if not level: continue
                            
                            # Clean level (ensure it's I, R, M, or A)
                            clean_level = str(level).strip().upper()[0] if level else ""
                            if clean_level not in ('I', 'R', 'M', 'A'):
                                # AI sometimes sends H, M, L. Map them to IRMA (I: Introduced, R: Reinforced, M: Mastered, A: Assessed)
                                ai_to_irma = {'H': 'M', 'M': 'R', 'L': 'I'}
                                clean_level = ai_to_irma.get(clean_level, 'I')
                            
                            if plo:
                                self.clo_plo_mapping_repository.create({
                                    'syllabus_clo_id': new_clo.id,
                                    'program_plo_id': plo.id,
                                    'level': clean_level if clean_level in ('I', 'R', 'M', 'A') else 'I'
                                })

            # 2. Save Materials
            if self.syllabus_material_repository:
                for item in materials_data:
                    item['syllabus_id'] = sid
                    self.syllabus_material_repository.create(item)

            # 3. Save Teaching Plans
            if self.teaching_plan_repository:
                for item in plans_data:
                    item['syllabus_id'] = sid
                    self.teaching_plan_repository.create(item)

            # 4. Save Assessment Schemes (Nested)
            if self.assessment_scheme_repository:
                for scheme in schemes_data:
                    components = scheme.pop('components', [])
                    scheme['syllabus_id'] = sid
                    new_scheme = self.assessment_scheme_repository.create(scheme)
                    if self.assessment_component_repository:
                        for comp in components:
                            rubrics = comp.pop('rubrics', [])
                            criteria = comp.pop('criteria', None)
                            clo_ids = comp.pop('clo_ids', [])
                            
                            # Handle clo_ids if it's a string (from AI or legacy UI)
                            final_clo_ids = []
                            if isinstance(clo_ids, str):
                                # If it's a comma separated string of codes like "CLO1, CLO2"
                                # we should ideally find the IDs. But since they are newly created,
                                # we might need to search the session for the newly created CLOs.
                                codes = [c.strip() for c in clo_ids.split(',') if c.strip()]
                                # Search for CLOs in the same syllabus we just created/flushed
                                for code in codes:
                                    existing_clo = self.repository.session.query(SyllabusClo).filter_by(
                                        syllabus_id=sid, code=code
                                    ).first()
                                    if existing_clo:
                                        final_clo_ids.append(existing_clo.id)
                            elif isinstance(clo_ids, list):
                                # If it's a list of integers or strings
                                for cid in clo_ids:
                                    if isinstance(cid, int):
                                        final_clo_ids.append(cid)
                                    elif isinstance(cid, str):
                                        # Try to find by code
                                        existing_clo = self.repository.session.query(SyllabusClo).filter_by(
                                            syllabus_id=sid, code=cid
                                        ).first()
                                        if existing_clo:
                                            final_clo_ids.append(existing_clo.id)

                            # Remove fields not in AssessmentComponent model to avoid TypeError
                            comp_data = {
                                'name': comp.get('name'),
                                'weight': comp.get('weight'),
                                'scheme_id': new_scheme.id
                            }
                            new_comp = self.assessment_component_repository.create(comp_data)
                            
                            # Create rubric if criteria provided
                            if criteria and self.rubric_repository:
                                self.rubric_repository.create({
                                    'component_id': new_comp.id,
                                    'criteria': criteria,
                                    'max_score': 10.0 # Default max score
                                })
                            
                            # Create rubric list if provided
                            if rubrics and self.rubric_repository:
                                for rub in rubrics:
                                    rub['component_id'] = new_comp.id
                                    self.rubric_repository.create(rub)
                                    
                            # Create CLO mappings
                            if final_clo_ids and self.assessment_clo_repository:
                                for clo_id in final_clo_ids:
                                    self.assessment_clo_repository.add_mapping(new_comp.id, clo_id)
            
            # Commit all at once
            self.repository.session.commit()
            logger.info(f"Successfully created syllabus {sid} with all children")
            return new_syllabus
            
        except IntegrityError as e:
            self.repository.session.rollback()
            logger.error(f"Integrity error creating syllabus: {str(e)}")
            raise ValueError('L·ªói r√†ng bu·ªôc d·ªØ li·ªáu. C√≥ th·ªÉ ƒë·ªÅ c∆∞∆°ng n√†y ƒë√£ t·ªìn t·∫°i.')
        except Exception as e:
            self.repository.session.rollback()
            logger.error(f"Error creating syllabus: {str(e)}", exc_info=True)
            raise

    def update_syllabus(self, id: int, data: dict):
        import json
        from infrastructure.models.syllabus_model import Syllabus
        
        logger.info(f"Updating syllabus {id}. Data keys: {list(data.keys())}")
        
        # Check current status before allowing update
        s = self.get_syllabus(id)
        if not s:
            return None
        
        current_status = (s.status or '').upper()
        if current_status not in ('DRAFT', 'REJECTED', 'RETURNED'):
            raise ValueError(f"Cannot update syllabus in {s.status} status")

        # Extract child data
        clos_data = data.pop('clos', None)
        materials_data = data.pop('materials', None)
        plans_data = data.pop('teaching_plans', None)
        schemes_data = data.pop('assessment_schemes', None)
        
        # Process JSON fields
        if 'time_allocation' in data and data['time_allocation'] is not None:
            if not isinstance(data['time_allocation'], str):
                data['time_allocation'] = json.dumps(data['time_allocation'])
        
        if 'objectives' in data and data['objectives'] is not None:
            if not isinstance(data['objectives'], str):
                data['objectives'] = json.dumps(data['objectives'])
        
        # Filter data to only include valid columns for Syllabus model
        valid_columns = [c.key for c in Syllabus.__table__.columns]
        update_data = {k: v for k, v in data.items() if k in valid_columns}
        
        # Use transaction for atomic update
        try:
            # Update Header
            updated_syllabus = self.repository.update(id, update_data)
            sid = updated_syllabus.id

            # Update Children (Delete and Re-insert pattern for simplicity in draft saving)
            program_id = updated_syllabus.program_id
            
            # 1. Update CLOs
            if clos_data is not None and self.syllabus_clo_repository:
                from infrastructure.models.syllabus_clo_model import SyllabusClo
                self.repository.session.query(SyllabusClo).filter_by(syllabus_id=sid).delete()
                for item in clos_data:
                    raw_plo_mappings = item.pop('plo_mappings', {}) or item.pop('ploMappings', {})
                    # Standardize to dict
                    plo_mappings = {}
                    if isinstance(raw_plo_mappings, list):
                        for m in raw_plo_mappings:
                            if isinstance(m, dict) and ('code' in m or 'ploCode' in m) and 'level' in m:
                                code = m.get('code') or m.get('ploCode')
                                plo_mappings[code] = m['level']
                    elif isinstance(raw_plo_mappings, dict):
                        plo_mappings = raw_plo_mappings
                    item['syllabus_id'] = sid
                    new_clo = self.syllabus_clo_repository.create(item)
                    
                    # Save PLO mappings
                    if plo_mappings and self.clo_plo_mapping_repository and self.program_outcome_repository:
                        from infrastructure.models.program_outcome_model import ProgramOutcome
                        for plo_code, level in plo_mappings.items():
                            if not level: continue
                            
                            clean_level = str(level).strip().upper()[0]
                            if clean_level not in ('I', 'R', 'M', 'A'):
                                # Map H, M, L to I, R, M
                                ai_to_irma = {'H': 'M', 'M': 'R', 'L': 'I'}
                                clean_level = ai_to_irma.get(clean_level, 'I')

                            plo = self.program_outcome_repository.session.query(ProgramOutcome).filter_by(
                                program_id=program_id, code=plo_code
                            ).first()
                            
                            if plo:
                                self.clo_plo_mapping_repository.create({
                                    'syllabus_clo_id': new_clo.id,
                                    'program_plo_id': plo.id,
                                    'level': clean_level
                                })

            # 2. Update Materials
            if materials_data is not None and self.syllabus_material_repository:
                from infrastructure.models.syllabus_material_model import SyllabusMaterial
                self.repository.session.query(SyllabusMaterial).filter_by(syllabus_id=sid).delete()
                for item in materials_data:
                    item['syllabus_id'] = sid
                    self.syllabus_material_repository.create(item)

            # 3. Update Teaching Plans
            if plans_data is not None and self.teaching_plan_repository:
                from infrastructure.models.teaching_plan_model import TeachingPlan
                self.repository.session.query(TeachingPlan).filter_by(syllabus_id=sid).delete()
                for item in plans_data:
                    item['syllabus_id'] = sid
                    self.teaching_plan_repository.create(item)

            # 4. Update Assessment Schemes (Nested)
            if schemes_data is not None and self.assessment_scheme_repository:
                from infrastructure.models.assessment_scheme_model import AssessmentScheme
                from infrastructure.models.assessment_component_model import AssessmentComponent
                from infrastructure.models.rubric_model import Rubric
                
                # Delete existing schemes (cascades should handle components/rubrics if configured, 
                # but we'll be thorough or rely on DB cascades)
                self.repository.session.query(AssessmentScheme).filter_by(syllabus_id=sid).delete()
                
                for scheme in schemes_data:
                    components = scheme.pop('components', [])
                    scheme['syllabus_id'] = sid
                    new_scheme = self.assessment_scheme_repository.create(scheme)
                    
                    if self.assessment_component_repository:
                        for comp in components:
                            rubrics = comp.pop('rubrics', [])
                            criteria = comp.pop('criteria', None)
                            clo_ids = comp.pop('clo_ids', [])
                            
                            comp_data = {
                                'name': comp.get('name'),
                                'weight': comp.get('weight'),
                                'scheme_id': new_scheme.id
                            }
                            new_comp = self.assessment_component_repository.create(comp_data)
                            
                            # Create rubric if criteria provided
                            if criteria and self.rubric_repository:
                                self.rubric_repository.create({
                                    'component_id': new_comp.id,
                                    'criteria': criteria,
                                    'max_score': 10.0
                                })
                                
                            if self.rubric_repository and rubrics:
                                for rub in rubrics:
                                    rub['component_id'] = new_comp.id
                                    self.rubric_repository.create(rub)
                                    
                            # Create CLO mappings
                            if clo_ids and self.assessment_clo_repository:
                                for clo_id in clo_ids:
                                    self.assessment_clo_repository.add_mapping(new_comp.id, clo_id)

            self.repository.session.commit()
            logger.info(f"Successfully updated syllabus {sid} with children")
            return updated_syllabus

        except Exception as e:
            self.repository.session.rollback()
            logger.error(f"Error updating syllabus {id}: {str(e)}", exc_info=True)
            raise

    def delete_syllabus(self, id: int) -> bool:
        return self.repository.delete(id)

    # Workflow methods
    def submit_syllabus(self, id: int, user_id: int):
        """Submit syllabus for evaluation with comprehensive validation."""
        s = self.repository.get_details(id)
        if not s:
            return None
        
        current_status = (s.status or '').upper()
        if current_status not in WorkflowStatus.VALID_FOR_SUBMISSION:
            raise ValueError(
                f'Ch·ªâ c√≥ th·ªÉ g·ª≠i duy·ªát ·ªü c√°c tr·∫°ng th√°i {WorkflowStatus.VALID_FOR_SUBMISSION}. '
                f'Tr·∫°ng th√°i hi·ªán t·∫°i: {current_status}'
            )
        
        # Comprehensive Content Validation
        errors = []
        if not s.description or len(s.description.strip()) < 50:
            errors.append('M√¥ t·∫£ h·ªçc ph·∫ßn ph·∫£i c√≥ √≠t nh·∫•t 50 k√Ω t·ª±.')
        
        if not s.clos or len(s.clos) == 0:
            errors.append('ƒê·ªÅ c∆∞∆°ng ph·∫£i c√≥ √≠t nh·∫•t m·ªôt Chu·∫©n ƒë·∫ßu ra (CLO).')
        
        if not s.teaching_plans or len(s.teaching_plans) < 5:
            errors.append('K·∫ø ho·∫°ch gi·∫£ng d·∫°y qu√° ng·∫Øn (t·ªëi thi·ªÉu 5 m·ª•c).')

        if not s.materials or len([m for m in s.materials if m.type == 'Main']) == 0:
            errors.append('Thi·∫øu t√†i li·ªáu h·ªçc t·∫≠p ch√≠nh (Main material).')

        # Validate assessment weight
        if not s.assessment_schemes:
            errors.append('Thi·∫øu ma tr·∫≠n ki·ªÉm tra ƒë√°nh gi√°.')
        else:
            for scheme in s.assessment_schemes:
                total_weight = sum([float(comp.weight or 0) for comp in (scheme.components or [])])
                if abs(total_weight - 100.0) > 0.1:
                    errors.append(f'T·ªïng tr·ªçng s·ªë c·ªßa "{scheme.name}" ph·∫£i b·∫±ng 100% (hi·ªán t·∫°i: {total_weight}%).')
        
        if errors:
            raise ValueError(" | ".join(errors))
        
        from_status = s.status
        updated = self.repository.update(id, {'status': WorkflowStatus.PENDING})
        if self.workflow_log_repository:
            self.workflow_log_repository.create({
                'syllabus_id': id,
                'actor_id': user_id,
                'action': 'SUBMIT',
                'from_status': from_status,
                'to_status': WorkflowStatus.PENDING,
                'comment': 'ƒê√£ ki·ªÉm tra t√≠nh h·ª£p l·ªá v√† g·ª≠i duy·ªát.'
            })

        # Track current workflow with deadline (e.g., 7 days for review)
        if self.current_workflow_repository:
            due_date = datetime.now() + timedelta(days=7)
            self.current_workflow_repository.update_or_create(id, {
                'state': WorkflowStatus.PENDING,
                'assigned_user_id': None, # Can be assigned to specific HoD if needed
                'due_date': due_date,
                'last_action_at': datetime.now()
            })
        
        # Notify HoD when a syllabus is submitted
        if self.notification_service:
            self.notification_service.notify_roles(
                roles=['Head of Dept', 'Academic Affairs', 'Admin'],
                title='ƒê·ªÅ c∆∞∆°ng m·ªõi ƒë∆∞·ª£c g·ª≠i',
                message=f'Gi·∫£ng vi√™n {s.lecturer.full_name if s.lecturer else "N/A"} v·ª´a g·ª≠i duy·ªát m√¥n {s.subject.code if s.subject else "N/A"}.',
                link=f'/syllabus/{id}',
                event_name='syllabus_submitted'
            )
        
        return updated

    def evaluate_syllabus(self, id: int, user_id: int, action: str, comment: Optional[str] = None):
        """Evaluate syllabus. Can only evaluate PENDING, PENDING APPROVAL, or PENDING FINAL APPROVAL syllabuses."""
        s = self.get_syllabus(id)
        if not s:
            return None
        
        # Get user role for workflow logic
        user = self.user_repository.get_by_id(user_id) if hasattr(self, 'user_repository') else None
        user_role_names = []
        if user and hasattr(user, 'roles'):
            user_role_names = [ur.role.name for ur in user.roles]
        
        action = action.upper()
        if action not in ('APPROVE', 'REJECT'):
            raise ValueError(f'Invalid action: {action}. Must be APPROVE or REJECT')
        
        current_status = (s.status or '').upper()
        # Use constants from WorkflowStatus
        current_status = s.status.upper()
        if current_status not in WorkflowStatus.VALID_FOR_EVALUATION:
             raise ValueError(
                f'Can only evaluate syllabuses in {WorkflowStatus.VALID_FOR_EVALUATION}. Current status: {s.status}'
            )
        
        from_status = s.status
        if action == 'APPROVE':
            # Role-based workflow validation and transitions using WorkflowStatus constants
            if current_status == WorkflowStatus.PENDING:
                if not any(r in user_role_names for r in ['Head of Dept', 'Admin']):
                    raise ValueError('Only Head of Department (HoD) or Admin can approve at this stage')
                new_status = WorkflowStatus.PENDING_APPROVAL
            elif current_status == WorkflowStatus.PENDING_APPROVAL:
                if not any(r in user_role_names for r in ['Academic Affairs', 'Admin']):
                    raise ValueError('Only Academic Affairs or Admin can approve at this stage')
                new_status = WorkflowStatus.PENDING_FINAL_APPROVAL
            elif current_status == WorkflowStatus.PENDING_FINAL_APPROVAL:
                if not any(r in user_role_names for r in ['Principal', 'Admin']):
                    raise ValueError('Only Principal or Admin can approve at this stage')
                new_status = WorkflowStatus.PUBLISHED
            else:
                new_status = WorkflowStatus.APPROVED
        else:  # REJECT
            if not comment:
                raise ValueError('Comment is required when rejecting')
            new_status = WorkflowStatus.RETURNED
        
        updated = self.repository.update(id, {'status': new_status})
        
        # Take Immutable Snapshot if approved/published
        if action == 'APPROVE' and new_status in WorkflowStatus.PUBLIC_STATUSES:
             if self.snapshot_service:
                 try:
                     # Get full details for snapshot
                     full_syllabus = self.repository.get_details(id)
                     if full_syllabus:
                         from api.schemas.syllabus_schema import SyllabusSchema
                         schema = SyllabusSchema()
                         # We use dump() to get a clean JSON-serializable dict
                         snapshot_dict = schema.dump(full_syllabus)
                         self.snapshot_service.create_snapshot(
                             syllabus_id=id,
                             version=full_syllabus.version or "1.0",
                             data=snapshot_dict,
                             created_by=user_id
                         )
                         logger.info(f"Snapshot created for syllabus {id} at status {new_status}")
                 except Exception as e:
                     logger.error(f"Failed to create snapshot for syllabus {id}: {str(e)}")

        if self.workflow_log_repository:
            self.workflow_log_repository.create({
                'syllabus_id': id,
                'actor_id': user_id,
                'action': action,
                'from_status': from_status,
                'to_status': new_status,
                'comment': comment
            })

        # Update current workflow tracking
        if self.current_workflow_repository:
            if new_status in WorkflowStatus.PUBLIC_STATUSES or new_status == WorkflowStatus.REJECTED:
                # Workflow finished or syllabus rejected - stop tracking deadline
                # NOTE: RETURNED might still need a deadline for lecturer to fix
                self.current_workflow_repository.update_or_create(id, {
                    'state': new_status,
                    'assigned_user_id': None,
                    'due_date': None,
                    'last_action_at': datetime.now()
                })
            else:
                # Next stage of evaluation - set new deadline (e.g. 5 days for next level)
                due_date = datetime.now() + timedelta(days=5)
                self.current_workflow_repository.update_or_create(id, {
                    'state': new_status,
                    'assigned_user_id': None, # Ideally assign to next role's users
                    'due_date': due_date,
                    'last_action_at': datetime.now()
                })
        
        # Notify the lecturer about the result
        if s.lecturer_id and self.notification_service:
            action_text = 'duy·ªát' if action == 'APPROVE' else 'tr·∫£ l·∫°i'
            self.notification_service.send_notification(
                user_id=s.lecturer_id,
                title=f'ƒê·ªÅ c∆∞∆°ng ƒë∆∞·ª£c {action_text}',
                message=f'M√¥n {s.subject.code if s.subject else "N/A"} ƒë√£ ƒë∆∞·ª£c {action_text}. Tr·∫°ng th√°i: {new_status}',
                link=f'/syllabus/{id}',
                event_name='syllabus_evaluated'
            )
            
        return updated

    def get_workflow_logs(self, syllabus_id: int):
        if not self.workflow_log_repository:
            return []
        return self.workflow_log_repository.get_by_syllabus_id(syllabus_id)
</file>

<file path="apps/api/src/services/system_setting_service.py">
from typing import List, Optional
from infrastructure.repositories.system_setting_repository import SystemSettingRepository

class SystemSettingService:
    def __init__(self, repository: SystemSettingRepository):
        self.repository = repository

    def get_all_settings(self) -> List:
        return self.repository.get_all()

    def update_setting(self, key: str, value: str, description: str = None):
        return self.repository.set_value(key, value, description)
</file>

<file path="apps/api/src/services/teaching_plan_service.py">
from typing import List, Optional
from infrastructure.repositories.teaching_plan_repository import TeachingPlanRepository

class TeachingPlanService:
    def __init__(self, repository: TeachingPlanRepository, syllabus_repository=None):
        self.repository = repository
        self.syllabus_repository = syllabus_repository

    def list_plans_for_syllabus(self, syllabus_id: int) -> List:
        return self.repository.get_by_syllabus_id(syllabus_id)

    def get_plan(self, id: int):
        return self.repository.get_by_id(id)

    def create_teaching_plan(self, data: dict):
        syllabus_id = data.get('syllabus_id')
        if not syllabus_id or not self.syllabus_repository.get_by_id(syllabus_id):
            raise ValueError('Invalid syllabus_id')
        return self.repository.create(data)

    def update_teaching_plan(self, id: int, data: dict):
        return self.repository.update(id, data)

    def delete_teaching_plan(self, id: int) -> bool:
        return self.repository.delete(id)
</file>

<file path="apps/api/src/services/user_service.py">
from typing import List, Optional
from werkzeug.security import generate_password_hash, check_password_hash
from infrastructure.repositories.user_repository import UserRepository

class UserService:
    def __init__(self, repository: UserRepository):
        self.repository = repository

    def list_users(self) -> List:
        return self.repository.get_all()

    def get_user(self, id: int):
        return self.repository.get_by_id(id)

    def get_by_username(self, username: str):
        return self.repository.get_by_username(username)

    def create_user(self, data: dict):
        # Hash password before saving
        if 'password' in data:
            data['password_hash'] = generate_password_hash(data.pop('password'))
        return self.repository.create(data)

    def update_user(self, id: int, data: dict):
        if 'password' in data:
            data['password_hash'] = generate_password_hash(data.pop('password'))
        return self.repository.update(id, data)

    def delete_user(self, id: int) -> bool:
        return self.repository.delete(id)

    def authenticate(self, username: str, password: str):
        user = self.get_by_username(username)
        if not user:
            return None
        if not check_password_hash(user.password_hash, password):
            return None
        return user
</file>

<file path="apps/api/src/swagger_config.json">
{
    "template": {
        "swagger": "2.0",
        "info": {
            "title": "Syllabus Management API",
            "description": "API for Syllabus Management (SMD)",
            "version": "1.0.0"
        },
        "basePath": "/",
        "schemes": [
            "http",
            "https"
        ],
        "consumes": [
            "application/json"
        ],
        "produces": [
            "application/json"
        ]
    },
    "swagger_config": {
        "headers": [],
        "specs": [
            {
                "endpoint": "apispec",
                "route": "/apispec.json"
            }
        ],
        "static_url_path": "/flasgger_static",
        "swagger_ui": true,
        "specs_route": "/docs"
    }
}
</file>

<file path="apps/api/src/tests/test_file_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

import os
import tempfile
from services.file_service import FileService, UPLOAD_FOLDER

class StubFileStorage:
    def __init__(self, filename, content=b"data", mimetype='application/octet-stream'):
        self.filename = filename
        self._content = content
        self.mimetype = mimetype

    def save(self, path):
        with open(path, 'wb') as f:
            f.write(self._content)


class StubRepo:
    def __init__(self):
        self.created = None
    def create(self, data):
        self.created = data
        class Item:
            def __init__(self, d):
                self.__dict__.update(d)
        return Item(data)


def test_upload_file_saves_to_disk_and_db(tmp_path, monkeypatch):
    # Use a temp upload folder
    tmp_dir = tmp_path / 'uploads'
    monkeypatch.setattr('services.file_service.UPLOAD_FOLDER', str(tmp_dir))

    repo = StubRepo()
    svc = FileService(repository=repo)

    file_storage = StubFileStorage('test.txt', b'hello', 'text/plain')
    record = svc.upload_file(file_storage, uploader_id=5)

    # Ensure file saved on disk
    assert os.path.exists(record.file_path)
    assert repo.created['uploader_id'] == 5
    assert repo.created['file_name'] == 'test.txt'


def test_upload_rejects_bad_extension():
    repo = StubRepo()
    svc = FileService(repository=repo)
    file_storage = StubFileStorage('test.exe')
    try:
        svc.upload_file(file_storage, uploader_id=1)
        assert False, 'Should raise ValueError for disallowed extension'
    except ValueError:
        pass
</file>

<file path="apps/api/src/tests/test_program_outcome_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

from services.program_outcome_service import ProgramOutcomeService

class StubRepo:
    def __init__(self):
        self.created = {}
    def create(self, data):
        self.created = data
        return data
    def update(self, id, data):
        return {'id': id, **data}
    def delete(self, id):
        return True

class StubProgramRepo:
    def __init__(self, exists=True):
        self.exists = exists
    def get_by_id(self, id):
        return {'id': id} if self.exists else None


def test_create_plo_requires_valid_program():
    repo = StubRepo()
    program_repo = StubProgramRepo(exists=False)
    svc = ProgramOutcomeService(repository=repo, program_repository=program_repo)
    try:
        svc.create_plo({'program_id': 1, 'code': 'PLO1', 'description': 'd'})
        assert False, 'Should have raised ValueError'
    except ValueError:
        pass

    program_repo = StubProgramRepo(exists=True)
    svc = ProgramOutcomeService(repository=repo, program_repository=program_repo)
    item = svc.create_plo({'program_id': 1, 'code': 'PLO1', 'description': 'd'})
    assert repo.created['code'] == 'PLO1'


def test_update_and_delete_delegates_to_repo():
    repo = StubRepo()
    svc = ProgramOutcomeService(repository=repo)
    updated = svc.update_plo(1, {'code': 'X'})
    assert updated['id'] == 1
    assert svc.delete_plo(1) is True
</file>

<file path="apps/api/src/tests/test_smoke_imports.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

from dependency_container import Container
from services.syllabus_service import SyllabusService
from services.program_outcome_service import ProgramOutcomeService
from services.file_service import FileService


def test_container_has_services():
    c = Container()
    assert hasattr(c, 'syllabus_service')
    assert hasattr(c, 'program_outcome_service')
    assert hasattr(c, 'file_service')


def test_service_classes_importable():
    assert callable(SyllabusService)
    assert callable(ProgramOutcomeService)
    assert callable(FileService)
</file>

<file path="apps/api/src/tests/test_syllabus_service.py">
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parents[1]))  # apps/api/src

import json
from services.syllabus_service import SyllabusService


class StubRepo:
    def __init__(self):
        self.created = []

    def create(self, data):
        # simulate DB model with id and status
        class Item:
            pass
        item = Item()
        item.id = 123
        item.status = data.get('status', 'DRAFT')
        self.created.append(data)
        return item

    def get_by_id(self, id):
        return None


class StubFKRepo:
    def __init__(self, exists=True):
        self.exists = exists

    def get_by_id(self, id):
        return {'id': id} if self.exists else None


class StubChildRepo:
    def __init__(self):
        self.items = []

    def create(self, data):
        self.items.append(data)
        class Item:
            def __init__(self, data, id):
                self.__dict__.update(data)
                self.id = id
        return Item(data, len(self.items))


def test_create_syllabus_creates_child_entities_and_serializes_time_allocation():
    repo = StubRepo()
    subj = StubFKRepo(True)
    prog = StubFKRepo(True)
    ay = StubFKRepo(True)
    user = StubFKRepo(True)
    clo_repo = StubChildRepo()
    mat_repo = StubChildRepo()
    plan_repo = StubChildRepo()
    scheme_repo = StubChildRepo()
    comp_repo = StubChildRepo()
    rubric_repo = StubChildRepo()

    svc = SyllabusService(
        repository=repo,
        subject_repository=subj,
        program_repository=prog,
        academic_year_repository=ay,
        user_repository=user,
        syllabus_clo_repository=clo_repo,
        syllabus_material_repository=mat_repo,
        teaching_plan_repository=plan_repo,
        assessment_scheme_repository=scheme_repo,
        assessment_component_repository=comp_repo,
        rubric_repository=rubric_repo
    )

    payload = {
        'subject_id': 1,
        'program_id': 1,
        'academic_year_id': 1,
        'lecturer_id': 1,
        'time_allocation': {'theory': 10, 'practice': 20},
        'clos': [{'code': 'C1', 'description': 'desc'}],
        'materials': [{'type': 'MAIN', 'title': 't'}],
        'teaching_plans': [{'week': 1, 'topic': 't'}],
        'assessment_schemes': [
            {
                'name': 'Scheme1',
                'weight': 50,
                'components': [
                    {'name': 'Comp1', 'weight': 100, 'rubrics': [{'criteria': 'r', 'max_score': 10}]}
                ]
            }
        ]
    }

    result = svc.create_syllabus(payload.copy())
    # header created
    assert result.id == 123
    # child repos created
    assert len(clo_repo.items) == 1
    assert len(mat_repo.items) == 1
    assert len(plan_repo.items) == 1
    assert len(scheme_repo.items) == 1
    assert len(comp_repo.items) == 1
    assert len(rubric_repo.items) == 1

    # ensure time_allocation was serialized as JSON in the header create payload
    header_payload = repo.created[0]
    assert isinstance(header_payload['time_allocation'], str)
    parsed = json.loads(header_payload['time_allocation'])
    assert parsed['theory'] == 10


def test_submit_syllabus_allows_returned_case_insensitive():
    class GetRepo:
        def __init__(self, status):
            class Item:
                pass
            self.item = Item()
            self.item.status = status
        def get_by_id(self, id):
            return self.item
        def update(self, id, data):
            return data

    for status in ['returned', 'RETURNED', 'Returned']:
        repo = GetRepo(status)
        svc = SyllabusService(repository=repo)
        updated = svc.submit_syllabus(1, 2)
        assert updated == {'status': 'PENDING'}
</file>

<file path="apps/api/src/utils/caching.py">
"""
Flask-Caching integration and cache utilities
"""
from flask_caching import Cache
from functools import wraps
from flask import request
import hashlib
import json

# Initialize cache (to be configured in create_app)
cache = Cache()


def cache_key_from_request():
    """
    Generate cache key from request parameters
    """
    args = request.args.to_dict()
    key_data = {
        'path': request.path,
        'args': args
    }
    key_string = json.dumps(key_data, sort_keys=True)
    return hashlib.md5(key_string.encode()).hexdigest()


def cached_response(timeout=300, key_prefix='view'):
    """
    Decorator to cache API responses
    
    Usage:
        @cached_response(timeout=600)
        def my_endpoint():
            pass
    
    Args:
        timeout: Cache timeout in seconds (default 5 minutes)
        key_prefix: Prefix for cache key
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # Generate cache key
            cache_key = f"{key_prefix}:{request.path}:{cache_key_from_request()}"
            
            # Try to get from cache
            cached = cache.get(cache_key)
            if cached is not None:
                return cached
            
            # Execute function and cache result
            result = func(*args, **kwargs)
            cache.set(cache_key, result, timeout=timeout)
            
            return result
        return wrapper
    return decorator


def invalidate_cache(key_pattern):
    """
    Invalidate cache entries matching pattern
    
    Args:
        key_pattern: Pattern to match cache keys (e.g., 'syllabus:*')
    """
    try:
        cache.delete_memoized(key_pattern)
    except Exception:
        # Fallback: clear all cache if pattern delete not supported
        cache.clear()


def cache_model(model_name, model_id, timeout=600):
    """
    Decorator to cache model by ID
    
    Usage:
        @cache_model('syllabus', syllabus_id)
        def get_syllabus(id):
            pass
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # Extract ID from kwargs or args
            entity_id = kwargs.get('id') or (args[0] if args else None)
            
            if entity_id:
                cache_key = f"model:{model_name}:{entity_id}"
                cached = cache.get(cache_key)
                if cached is not None:
                    return cached
            
            result = func(*args, **kwargs)
            
            if entity_id and result:
                cache_key = f"model:{model_name}:{entity_id}"
                cache.set(cache_key, result, timeout=timeout)
            
            return result
        return wrapper
    return decorator
</file>

<file path="apps/api/src/utils/logging_config.py">
"""
Centralized logging configuration for the application
"""
import logging
import logging.handlers
import json
from datetime import datetime
from pathlib import Path
import os

class JSONFormatter(logging.Formatter):
    """
    Custom JSON formatter for structured logging
    """
    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno
        }
        
        # Add exception info if present
        if record.exc_info:
            log_data["exception"] = self.formatException(record.exc_info)
        
        # Add extra fields if present
        if hasattr(record, 'user_id'):
            log_data["user_id"] = record.user_id
        if hasattr(record, 'request_id'):
            log_data["request_id"] = record.request_id
        if hasattr(record, 'duration_ms'):
            log_data["duration_ms"] = record.duration_ms
        if hasattr(record, 'status_code'):
            log_data["status_code"] = record.status_code
            
        return json.dumps(log_data)


def setup_logging(app_name: str = "smd-api", log_level: str = "INFO", log_dir: str = "logs"):
    """
    Setup application logging with file rotation and structured format
    
    Args:
        app_name: Application name for logger
        log_level: Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
        log_dir: Directory to store log files
    """
    # Create logs directory if it doesn't exist
    log_path = Path(log_dir)
    log_path.mkdir(exist_ok=True)
    
    # Get root logger
    logger = logging.getLogger(app_name)
    logger.setLevel(getattr(logging, log_level.upper()))
    
    # Remove existing handlers to avoid duplicates
    logger.handlers.clear()
    
    # Console handler with simple format for development
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)
    console_format = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    console_handler.setFormatter(console_format)
    logger.addHandler(console_handler)
    
    # File handler with JSON format for production
    file_handler = logging.handlers.RotatingFileHandler(
        log_path / f"{app_name}.log",
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5,
        encoding='utf-8'
    )
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(JSONFormatter())
    logger.addHandler(file_handler)
    
    # Separate error log file
    error_handler = logging.handlers.RotatingFileHandler(
        log_path / f"{app_name}_errors.log",
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5,
        encoding='utf-8'
    )
    error_handler.setLevel(logging.ERROR)
    error_handler.setFormatter(JSONFormatter())
    logger.addHandler(error_handler)
    
    # Don't propagate to root logger
    logger.propagate = False
    
    return logger


def get_logger(name: str):
    """
    Get a logger instance with the application's root logger as parent
    
    Args:
        name: Logger name (typically __name__ of the module)
    
    Returns:
        Logger instance
    """
    return logging.getLogger(f"smd-api.{name}")
</file>

<file path="apps/api/src/utils/pagination.py">
"""
Pagination utilities for list endpoints
"""
from typing import List, Dict, Any, Optional
from flask import request


class Pagination:
    """
    Pagination helper class
    """
    def __init__(self, items: List, page: int, page_size: int, total: int):
        self.items = items
        self.page = page
        self.page_size = page_size
        self.total = total
        self.pages = (total + page_size - 1) // page_size  # Ceiling division
    
    @property
    def has_prev(self) -> bool:
        return self.page > 1
    
    @property
    def has_next(self) -> bool:
        return self.page < self.pages
    
    @property
    def prev_page(self) -> Optional[int]:
        return self.page - 1 if self.has_prev else None
    
    @property
    def next_page(self) -> Optional[int]:
        return self.page + 1 if self.has_next else None
    
    def to_dict(self) -> Dict[str, Any]:
        """Convert pagination info to dictionary"""
        return {
            "data": self.items,  # Frontend expects 'data'
            "items": self.items,  # Keep for backward compatibility
            "total": self.total,  # Frontend expects 'total' at top level
            "total_pages": self.pages,  # Frontend expects 'total_pages' at top level
            "page": self.page,
            "page_size": self.page_size,
            "has_prev": self.has_prev,
            "has_next": self.has_next,
            "prev_page": self.prev_page,
            "next_page": self.next_page,
            "pagination": {  # Keep nested for backward compatibility
                "page": self.page,
                "page_size": self.page_size,
                "total_items": self.total,
                "total_pages": self.pages,
                "has_prev": self.has_prev,
                "has_next": self.has_next,
                "prev_page": self.prev_page,
                "next_page": self.next_page
            }
        }


def get_pagination_params(default_page_size: int = 20, max_page_size: int = 100) -> tuple:
    """
    Extract pagination parameters from request
    
    Args:
        default_page_size: Default number of items per page
        max_page_size: Maximum allowed page size
    
    Returns:
        Tuple of (page, page_size, offset)
    """
    page = request.args.get('page', 1, type=int)
    # Support both 'page_size' and 'limit' as aliases
    page_size = request.args.get('page_size', type=int) or request.args.get('limit', type=int) or default_page_size
    
    # Validate parameters
    page = max(1, page)  # Page must be at least 1
    page_size = min(max(1, page_size), max_page_size)  # Between 1 and max
    
    offset = (page - 1) * page_size
    
    return page, page_size, offset


def paginate(query, page: int, page_size: int, schema=None) -> Dict[str, Any]:
    """
    Paginate a SQLAlchemy query
    
    Args:
        query: SQLAlchemy query object
        page: Page number (1-indexed)
        page_size: Items per page
        schema: Optional Marshmallow schema for serialization
    
    Returns:
        Dictionary with items and pagination info
    """
    total = query.count()
    offset = (page - 1) * page_size
    items = query.offset(offset).limit(page_size).all()
    
    # Serialize if schema provided
    if schema:
        items = schema.dump(items, many=True)
    
    pagination = Pagination(items, page, page_size, total)
    return pagination.to_dict()
</file>

<file path="apps/api/src/utils/performance.py">
"""
Performance monitoring decorator and utilities
"""
import time
import functools
from utils.logging_config import get_logger

logger = get_logger(__name__)


def monitor_performance(func):
    """
    Decorator to monitor function execution time and log performance metrics
    
    Usage:
        @monitor_performance
        def my_function():
            pass
    """
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        func_name = f"{func.__module__}.{func.__name__}"
        
        try:
            logger.debug(f"Starting {func_name}")
            result = func(*args, **kwargs)
            
            duration_ms = (time.time() - start_time) * 1000
            logger.info(
                f"Completed {func_name}",
                extra={"duration_ms": duration_ms, "status": "success"}
            )
            
            # Warn if execution takes too long
            if duration_ms > 1000:  # > 1 second
                logger.warning(
                    f"Slow execution detected: {func_name} took {duration_ms:.2f}ms"
                )
            
            return result
            
        except Exception as e:
            duration_ms = (time.time() - start_time) * 1000
            logger.error(
                f"Failed {func_name}: {str(e)}",
                extra={"duration_ms": duration_ms, "status": "error"},
                exc_info=True
            )
            raise
    
    return wrapper


def log_api_request(func):
    """
    Decorator to log API requests with details
    
    Usage:
        @log_api_request
        def my_endpoint():
            pass
    """
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        from flask import request, g
        
        start_time = time.time()
        endpoint = f"{request.method} {request.path}"
        
        # Get user_id from Flask g context if available
        user_id = getattr(g, 'user_id', None)
        
        logger.info(
            f"API Request: {endpoint}",
            extra={
                "method": request.method,
                "path": request.path,
                "user_id": user_id,
                "ip": request.remote_addr
            }
        )
        
        try:
            result = func(*args, **kwargs)
            duration_ms = (time.time() - start_time) * 1000
            
            # Extract status code from response
            status_code = 200
            if isinstance(result, tuple) and len(result) > 1:
                status_code = result[1]
            
            logger.info(
                f"API Response: {endpoint}",
                extra={
                    "duration_ms": duration_ms,
                    "status_code": status_code,
                    "user_id": user_id
                }
            )
            
            return result
            
        except Exception as e:
            duration_ms = (time.time() - start_time) * 1000
            logger.error(
                f"API Error: {endpoint} - {str(e)}",
                extra={
                    "duration_ms": duration_ms,
                    "status_code": 500,
                    "user_id": user_id
                },
                exc_info=True
            )
            raise
    
    return wrapper
</file>

<file path="apps/api/tests/e2e_test_flow.py">
"""End-to-end happy-path test for Syllabus Management System

Run this script directly (python tests/e2e_test_flow.py).
Requires: requests, colorama

It will stop immediately and print an error in red if any step returns an unexpected status code.
"""

import sys
import time
import uuid
from datetime import date

import requests
import json
try:
    from colorama import Fore, Style, init as colorama_init
except Exception:
    print("Please install 'colorama' (pip install colorama) to run this script.")
    sys.exit(2)

colorama_init(autoreset=True)

BASE_URL = 'http://localhost:9999'


def log(step: str, message: str, status: str = 'INFO'):
    """Nicely print a log line.

    status: INFO, OK, FAIL
    """
    status = status.upper()
    if status == 'OK':
        color = Fore.GREEN
    elif status == 'FAIL':
        color = Fore.RED
    else:
        color = Fore.CYAN
    print(f"[{color}{status}{Style.RESET_ALL}] {step} - {message}")


def fail(step: str, message: str, resp=None):
    log(step, message, 'FAIL')
    if resp is not None:
        try:
            print(Fore.RED + resp.text)
        except Exception:
            pass
    sys.exit(1)


def expect_status(step: str, resp: requests.Response, expected: int):
    if resp.status_code != expected:
        fail(step, f"Expected HTTP {expected}, got {resp.status_code}", resp)
    log(step, f"HTTP {resp.status_code}", 'OK')


def post(path: str, json: dict, token: str = None):
    headers = {'Content-Type': 'application/json'}
    if token:
        headers['Authorization'] = f'Bearer {token}'
    return requests.post(BASE_URL + path, json=json, headers=headers)


def get(path: str, token: str = None):
    headers = {}
    if token:
        headers['Authorization'] = f'Bearer {token}'
    return requests.get(BASE_URL + path, headers=headers)


def run():
    # Step 1: Login admin
    step = '1. Login Admin'
    payload = {'username': 'admin', 'password': 'password123'}
    resp = post('/auth/login', payload)
    expect_status(step, resp, 200)
    token = resp.json().get('token')
    if not token:
        fail(step, 'No token returned', resp)
    log(step, 'Obtained token', 'OK')

    # Helper to generate short unique strings
    uid = str(uuid.uuid4())[:8]

    # Step 2: Create Faculty
    step = '2. Create Faculty'
    payload = {'code': f'E2E-FAC-{uid}', 'name': 'E2E Faculty'}
    resp = post('/faculties/', payload, token=token)
    expect_status(step, resp, 201)
    faculty_id = resp.json().get('id')

    # Step 3: Create Department
    step = '3. Create Department'
    payload = {'faculty_id': faculty_id, 'code': f'E2E-DEP-{uid}', 'name': 'E2E Department'}
    resp = post('/departments/', payload, token=token)
    expect_status(step, resp, 201)
    department_id = resp.json().get('id')

    # Step 4: Create Program
    step = '4. Create Program'
    payload = {'department_id': department_id, 'name': f'E2E Program {uid}', 'total_credits': 120}
    resp = post('/programs/', payload, token=token)
    expect_status(step, resp, 201)
    program_id = resp.json().get('id')

    # Step 5: Create Academic Year
    step = '5. Create Academic Year'
    payload = {'code': f'AY-{uid}', 'start_date': date.today().isoformat(), 'end_date': (date.today().replace(year=date.today().year + 1)).isoformat()}
    resp = post('/academic-years/', payload, token=token)
    expect_status(step, resp, 201)
    academic_year_id = resp.json().get('id')

    # Step 6: Create Lecturer (User)
    step = '6. Create Lecturer User'
    username = f'e2e_user_{uid}'
    payload = {'username': username, 'email': f'{username}@example.com', 'full_name': 'E2E Lecturer', 'password': 'pass1234'}
    resp = post('/users/', payload, token=token)
    expect_status(step, resp, 201)
    lecturer_id = resp.json().get('id')

    # Step 7: Create Subject
    step = '7. Create Subject'
    payload = {'department_id': department_id, 'code': f'E2E-SUB-{uid}', 'name_vi': 'E2E M√¥n h·ªçc', 'name_en': 'E2E Subject', 'credits': 3}
    resp = post('/subjects/', payload, token=token)
    expect_status(step, resp, 201)
    subject_id = resp.json().get('id')

    # Step 8: Create Syllabus (Draft)
    step = '8. Create Syllabus (Draft)'
    payload = {'subject_id': subject_id, 'program_id': program_id, 'academic_year_id': academic_year_id, 'lecturer_id': lecturer_id}
    resp = post('/syllabuses/', payload, token=token)
    expect_status(step, resp, 201)
    syllabus = resp.json()
    syllabus_id = syllabus.get('id')
    if syllabus.get('status') and syllabus.get('status') != 'DRAFT':
        fail(step, f"Expected status DRAFT, got {syllabus.get('status')}")

    # Step 9: Add CLO
    step = '9. Add CLO'
    payload = {'syllabus_id': syllabus_id, 'code': 'CLO-1', 'description': 'Understand basics of E2E.'}
    resp = post('/syllabus-clos/', payload, token=token)
    expect_status(step, resp, 201)
    clo_id = resp.json().get('id')

    # Step 10: Add Assessment Scheme
    step = '10. Add Assessment Scheme'
    payload = {'syllabus_id': syllabus_id, 'name': 'Progress Test', 'weight': 50}
    resp = post('/assessment-schemes/', payload, token=token)
    expect_status(step, resp, 201)
    scheme_id = resp.json().get('id')

    # Step 11: Add Assessment Component
    step = '11. Add Assessment Component'
    payload = {'scheme_id': scheme_id, 'name': 'Quiz 1', 'weight': 10}
    resp = post('/assessment-components/', payload, token=token)
    expect_status(step, resp, 201)
    component_id = resp.json().get('id')

    # Step 12: Map CLO to Component
    step = '12. Map CLO to Component'
    payload = {'assessment_component_id': component_id, 'syllabus_clo_id': clo_id}
    resp = post('/assessment-clos/', payload, token=token)
    expect_status(step, resp, 201)

    # Step 13: Verify Details
    step = '13. Verify Details'
    resp = get(f'/syllabuses/{syllabus_id}/details', token=token)
    expect_status(step, resp, 200)
    detail = resp.json()
    # Debug: dump details
    try:
        print(Fore.CYAN + json.dumps(detail, indent=2, ensure_ascii=False))
    except Exception:
        pass
    # Check CLO presence
    clos = detail.get('clos', [])
    if not any(c.get('id') == clo_id for c in clos):
        fail(step, 'CLO not found in syllabus details')
    # Check component presence inside assessment_schemes
    # API returns camelCase via BaseSchema; support both for robustness
    schemes = detail.get('assessmentSchemes') or detail.get('assessment_schemes', [])
    found_comp = False
    for s in schemes:
        for c in s.get('components', []):
            if c.get('id') == component_id:
                found_comp = True
                break
        if found_comp:
            break
    if not found_comp:
        fail(step, 'Component not found in syllabus details')
    log(step, 'CLO and Component found in syllabus details', 'OK')

    # Step 14: Submit Syllabus
    step = '14. Submit Syllabus'
    payload = {'user_id': lecturer_id}
    resp = post(f'/syllabuses/{syllabus_id}/submit', payload, token=token)
    expect_status(step, resp, 200)
    s = resp.json()
    if s.get('status') != 'PENDING':
        fail(step, f"Expected status PENDING, got {s.get('status')}")

    # Step 15: Approve Syllabus
    step = '15. Approve Syllabus'
    payload = {'action': 'APPROVE', 'user_id': lecturer_id}
    resp = post(f'/syllabuses/{syllabus_id}/evaluate', payload, token=token)
    expect_status(step, resp, 200)
    s = resp.json()
    if s.get('status') != 'APPROVED':
        fail(step, f"Expected status APPROVED, got {s.get('status')}")

    log('E2E', f'Successfully completed happy-path for syllabus {syllabus_id}', 'OK')


if __name__ == '__main__':
    try:
        run()
    except requests.exceptions.ConnectionError as e:
        print(Fore.RED + 'Failed to connect to API at ' + BASE_URL)
        print(str(e))
        sys.exit(2)
</file>

<file path="apps/api/tests/load_test.py">
"""
Load testing script using Locust
Install: pip install locust
Run: locust -f load_test.py --host=http://localhost:5000
"""
from locust import HttpUser, task, between
import random
import json


class SyllabusManagementUser(HttpUser):
    """
    Simulates user behavior for Syllabus Management System
    """
    wait_time = between(1, 3)  # Wait 1-3 seconds between tasks
    
    def on_start(self):
        """Called when a user starts - perform login"""
        # Login to get token
        response = self.client.post("/auth/login", json={
            "username": "test_user",
            "password": "test_password"
        })
        
        if response.status_code == 200:
            data = response.json()
            self.token = data.get('token')
            self.headers = {"Authorization": f"Bearer {self.token}"}
        else:
            self.token = None
            self.headers = {}
    
    @task(3)
    def list_syllabuses(self):
        """List syllabuses - most common operation (weight=3)"""
        page = random.randint(1, 5)
        self.client.get(
            f"/syllabuses/?page={page}&page_size=20",
            headers=self.headers,
            name="/syllabuses/ (paginated)"
        )
    
    @task(2)
    def get_syllabus_detail(self):
        """Get syllabus details (weight=2)"""
        syllabus_id = random.randint(1, 100)
        self.client.get(
            f"/syllabuses/{syllabus_id}",
            headers=self.headers,
            name="/syllabuses/:id"
        )
    
    @task(1)
    def list_subjects(self):
        """List subjects (weight=1)"""
        self.client.get(
            "/subjects/",
            headers=self.headers,
            name="/subjects/"
        )
    
    @task(1)
    def list_programs(self):
        """List programs (weight=1)"""
        self.client.get(
            "/programs/",
            headers=self.headers,
            name="/programs/"
        )
    
    @task(1)
    def get_system_settings(self):
        """Get system settings (weight=1)"""
        self.client.get(
            "/system-settings/",
            headers=self.headers,
            name="/system-settings/"
        )
    
    @task(1)
    def search_syllabuses(self):
        """Search syllabuses by subject (weight=1)"""
        subject_id = random.randint(1, 20)
        self.client.get(
            f"/syllabuses/?subject_id={subject_id}",
            headers=self.headers,
            name="/syllabuses/ (search)"
        )


class AdminUser(HttpUser):
    """
    Simulates admin user behavior with write operations
    """
    wait_time = between(2, 5)
    
    def on_start(self):
        """Login as admin"""
        response = self.client.post("/auth/login", json={
            "username": "admin",
            "password": "admin_password"
        })
        
        if response.status_code == 200:
            data = response.json()
            self.token = data.get('token')
            self.headers = {"Authorization": f"Bearer {self.token}"}
        else:
            self.token = None
            self.headers = {}
    
    @task(2)
    def list_syllabuses(self):
        """Admin lists syllabuses"""
        self.client.get(
            "/syllabuses/?page=1&page_size=50",
            headers=self.headers,
            name="[Admin] /syllabuses/"
        )
    
    @task(1)
    def create_syllabus(self):
        """Admin creates syllabus"""
        syllabus_data = {
            "subject_id": random.randint(1, 20),
            "program_id": random.randint(1, 10),
            "academic_year_id": random.randint(1, 5),
            "lecturer_id": random.randint(1, 50),
            "version": "1.0",
            "status": "DRAFT",
            "time_allocation": json.dumps({
                "theory": 30,
                "practice": 15
            }),
            "clos": [],
            "materials": [],
            "teaching_plans": [],
            "assessment_schemes": []
        }
        
        self.client.post(
            "/syllabuses/",
            json=syllabus_data,
            headers=self.headers,
            name="[Admin] /syllabuses/ (create)"
        )
    
    @task(1)
    def submit_syllabus(self):
        """Admin submits syllabus for approval"""
        syllabus_id = random.randint(1, 100)
        self.client.post(
            f"/syllabuses/{syllabus_id}/submit",
            headers=self.headers,
            name="[Admin] /syllabuses/:id/submit"
        )


# Test scenarios
class QuickLoadTest(HttpUser):
    """Quick load test with mixed operations"""
    tasks = [SyllabusManagementUser]
    weight = 80  # 80% regular users


class HeavyLoadTest(HttpUser):
    """Heavy load test including admin operations"""
    tasks = [SyllabusManagementUser, AdminUser]
    weight = 20  # 20% admin users
</file>

<file path="apps/api/tests/test_integration.py">
"""
Integration tests for Syllabus API endpoints
"""
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

import pytest
import json
from flask import Flask
from create_app import create_app


@pytest.fixture
def app():
    """Create application for testing"""
    app = create_app()
    app.config['TESTING'] = True
    return app


@pytest.fixture
def client(app):
    """Create test client"""
    return app.test_client()


@pytest.fixture
def auth_headers(client):
    """Get authentication headers"""
    response = client.post('/auth/login', json={
        'username': 'test_user',
        'password': 'test_password'
    })
    
    if response.status_code == 200:
        token = response.json.get('token')
        return {'Authorization': f'Bearer {token}'}
    return {}


class TestSyllabusEndpoints:
    """Test syllabus CRUD operations"""
    
    def test_list_syllabuses(self, client, auth_headers):
        """Test GET /syllabuses/"""
        response = client.get('/syllabuses/', headers=auth_headers)
        assert response.status_code == 200
        data = response.json
        assert isinstance(data, list)
    
    def test_list_syllabuses_paginated(self, client, auth_headers):
        """Test GET /syllabuses/?page=1&page_size=10"""
        response = client.get('/syllabuses/?page=1&page_size=10', headers=auth_headers)
        assert response.status_code == 200
        data = response.json
        assert 'items' in data
        assert 'pagination' in data
        assert data['pagination']['page'] == 1
        assert data['pagination']['page_size'] == 10
    
    def test_get_syllabus_by_id(self, client, auth_headers):
        """Test GET /syllabuses/:id"""
        response = client.get('/syllabuses/1', headers=auth_headers)
        assert response.status_code in [200, 404]  # OK or Not Found
        
        if response.status_code == 200:
            data = response.json
            assert 'id' in data
            assert data['id'] == 1
    
    def test_create_syllabus(self, client, auth_headers):
        """Test POST /syllabuses/"""
        syllabus_data = {
            'subject_id': 1,
            'program_id': 1,
            'academic_year_id': 1,
            'lecturer_id': 1,
            'version': '1.0',
            'status': 'DRAFT',
            'time_allocation': json.dumps({'theory': 30, 'practice': 15}),
            'clos': [],
            'materials': [],
            'teaching_plans': [],
            'assessment_schemes': []
        }
        
        response = client.post('/syllabuses/', 
                              json=syllabus_data, 
                              headers=auth_headers)
        
        # Should be 201 Created or 400/422 for validation errors
        assert response.status_code in [201, 400, 422]
    
    def test_submit_syllabus_requires_auth(self, client):
        """Test POST /syllabuses/:id/submit requires authentication"""
        response = client.post('/syllabuses/1/submit')
        assert response.status_code in [401, 403]  # Unauthorized


class TestPaginationFeature:
    """Test pagination functionality"""
    
    def test_default_pagination(self, client, auth_headers):
        """Test pagination with default values"""
        response = client.get('/syllabuses/?page=1', headers=auth_headers)
        assert response.status_code == 200
        data = response.json
        
        assert 'pagination' in data
        assert data['pagination']['page'] == 1
        assert data['pagination']['page_size'] == 20  # default
    
    def test_custom_page_size(self, client, auth_headers):
        """Test pagination with custom page size"""
        response = client.get('/syllabuses/?page=1&page_size=50', headers=auth_headers)
        assert response.status_code == 200
        data = response.json
        
        assert data['pagination']['page_size'] == 50
    
    def test_max_page_size_limit(self, client, auth_headers):
        """Test pagination respects max page size"""
        response = client.get('/syllabuses/?page=1&page_size=999', headers=auth_headers)
        assert response.status_code == 200
        data = response.json
        
        # Should be capped at MAX_PAGE_SIZE (100)
        assert data['pagination']['page_size'] <= 100


class TestPerformanceMonitoring:
    """Test performance monitoring"""
    
    def test_endpoint_performance_logged(self, client, auth_headers, caplog):
        """Test that endpoint performance is logged"""
        response = client.get('/syllabuses/', headers=auth_headers)
        assert response.status_code == 200
        
        # Check if performance logs are generated
        # (This requires proper logging setup in test environment)


class TestCaching:
    """Test caching functionality"""
    
    def test_cached_response(self, client, auth_headers):
        """Test that repeated requests use cache"""
        # First request
        response1 = client.get('/syllabuses/1', headers=auth_headers)
        
        # Second request (should be cached)
        response2 = client.get('/syllabuses/1', headers=auth_headers)
        
        if response1.status_code == 200:
            assert response1.json == response2.json


class TestErrorHandling:
    """Test error handling"""
    
    def test_invalid_syllabus_id(self, client, auth_headers):
        """Test GET /syllabuses/:id with invalid ID"""
        response = client.get('/syllabuses/999999', headers=auth_headers)
        assert response.status_code == 404
    
    def test_invalid_pagination_params(self, client, auth_headers):
        """Test pagination with invalid parameters"""
        response = client.get('/syllabuses/?page=-1&page_size=0', headers=auth_headers)
        # Should handle gracefully and return 200 with adjusted params
        assert response.status_code == 200


class TestWorkflowOperations:
    """Test workflow operations"""
    
    def test_submit_syllabus(self, client, auth_headers):
        """Test submitting syllabus for approval"""
        # First create a syllabus
        response = client.post('/syllabuses/1/submit', headers=auth_headers)
        
        # Should succeed or return validation error
        assert response.status_code in [200, 400, 404]
    
    def test_evaluate_syllabus(self, client, auth_headers):
        """Test evaluating syllabus"""
        evaluation_data = {
            'action': 'approve',
            'comment': 'Approved for publication'
        }
        
        response = client.post('/syllabuses/1/evaluate',
                              json=evaluation_data,
                              headers=auth_headers)
        
        assert response.status_code in [200, 400, 404]


# Run tests
if __name__ == '__main__':
    pytest.main([__file__, '-v'])
</file>

<file path="apps/web/app/(auth)/login/page.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { AlertCircle } from "lucide-react";
import axios from "@/lib/axios";

export default function LoginPage() {
  const router = useRouter();
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    try {
      // Use API client and backend contract: POST /auth/login with JSON
      // Added skipCamel to keep token names consistent with current localStorage logic
      const res = await axios.post("/auth/login", { username, password }, { skipSnake: true, skipCamel: true } as any);
      const data = res.data;

      // Save tokens
      if (data.access_token) localStorage.setItem("access_token", data.access_token);
      if (data.refresh_token) localStorage.setItem("refresh_token", data.refresh_token);
      
      // Save role from login response
      if (data.role) localStorage.setItem("role", data.role);

      // Wait a bit for localStorage to persist
      await new Promise(resolve => setTimeout(resolve, 100));

      // Fetch user info to verify and redirect
      try {
        const userRes = await axios.get("/users/me");
        const user = userRes.data;
        
        // Save user info to localStorage
        if (user.id) localStorage.setItem("user_id", String(user.id));
        if (user.fullName || user.full_name) {
          localStorage.setItem("full_name", user.fullName || user.full_name);
        }
        if (user.username) localStorage.setItem("username", user.username);
        
        // Save role from user info if available
        const roleFromUser = user.role || user?.roles?.[0]?.role?.name || user?.roles?.[0]?.name;
        if (roleFromUser) localStorage.setItem("role", roleFromUser);
        
        // Delay to ensure localStorage is saved
        const targetRole = roleFromUser || data.role;
        setTimeout(() => {
          window.location.href = targetRole === "Student" ? "/portal" : "/dashboard";
        }, 100);
      } catch (e) {
        // If user info not available, use role from login
        console.warn("Could not fetch user details, using role from login");
        setTimeout(() => {
          window.location.href = data.role === "Student" ? "/portal" : "/dashboard";
        }, 100);
      }
    
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-slate-50">
      {/* ƒê·ªîI BORDER TOP COLOR */}
      <Card className="w-full max-w-md shadow-xl border-t-4 border-t-teal-600">
        <CardHeader className="text-center pb-2">
          {/* ƒê·ªîI M√ÄU ICON N·ªÄN */}
          <div className="mx-auto w-12 h-12 bg-teal-50 rounded-lg flex items-center justify-center mb-4">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-teal-600"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
          </div>
          <CardTitle className="text-2xl font-bold text-slate-800">ƒêƒÉng nh·∫≠p H·ªá th·ªëng</CardTitle>
          <p className="text-sm text-slate-500">Syllabus Management System</p>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleLogin} className="space-y-4">
            {error && (
                <div className="flex items-center gap-2 text-red-600 bg-red-50 p-3 rounded-md text-sm border border-red-100">
                    <AlertCircle className="w-4 h-4" /> {error}
                </div>
            )}
            
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">T√™n ƒëƒÉng nh·∫≠p</label>
              <Input 
                value={username} 
                onChange={(e) => setUsername(e.target.value)} 
                placeholder="V√≠ d·ª•: gv1, hod1, sv1..." 
                required 
                className="h-10"
              />
            </div>
            
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">M·∫≠t kh·∫©u</label>
              <Input 
                type="password" 
                value={password} 
                onChange={(e) => setPassword(e.target.value)} 
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                required 
                className="h-10"
              />
            </div>

            {/* ƒê·ªîI M√ÄU N√öT SUBMIT */}
            <Button type="submit" className="w-full bg-teal-600 hover:bg-teal-700 h-10 text-base" disabled={loading}>
              {loading ? "ƒêang x·ª≠ l√Ω..." : "ƒêƒÉng nh·∫≠p"}
            </Button>

            <div className="text-xs text-center text-slate-400 mt-6 pt-4 border-t">
                <p className="mb-1 font-semibold">T√†i kho·∫£n m·∫∑c ƒë·ªãnh:</p>
                Admin: <b>admin</b> | Tr∆∞·ªüng b·ªô m√¥n: <b>hod1</b><br/>
                Gi·∫£ng vi√™n: <b>gv1</b> | Sinh vi√™n: <b>sv1</b> <br/>
                Ph√≤ng ƒë√†o t·∫°o: <b>aa1</b> <br/>
                (M·∫≠t kh·∫©u chung: 123456)
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/logs/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card } from "@/components/ui/card";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { FileClock, Loader2, RefreshCcw } from "lucide-react";
import { Button } from "@/components/ui/button";

interface Log {
  id: number;
  timestamp: string;
  username: string;
  action: string;
  details: string;
}

export default function SystemLogsPage() {
  const [logs, setLogs] = useState<Log[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchLogs = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/admin/logs?limit=50');
      const data = res.data;
      setLogs(data || []);
    } catch (e: any) {
      const status = e?.response?.status || e?.status;
      if (status === 403) alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!");
      else console.error(e);
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchLogs(); }, []);

  const getActionColor = (action: string) => {
      if (action === "LOGIN") return "bg-blue-100 text-blue-700 border-blue-200";
      if (action.includes("DELETE")) return "bg-red-100 text-red-700 border-red-200";
      if (action.includes("APPROVE")) return "bg-green-100 text-green-700 border-green-200";
      if (action.includes("CREATE")) return "bg-purple-100 text-purple-700 border-purple-200";
      return "bg-gray-100 text-gray-700";
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                <FileClock className="w-6 h-6 text-orange-600"/> Nh·∫≠t k√Ω H·ªá th·ªëng
            </h2>
            <p className="text-sm text-muted-foreground mt-1">Theo d√µi ho·∫°t ƒë·ªông c·ªßa ng∆∞·ªùi d√πng (50 b·∫£n ghi g·∫ßn nh·∫•t)</p>
        </div>
        <Button variant="outline" onClick={fetchLogs}><RefreshCcw className="w-4 h-4 mr-2"/> L√†m m·ªõi</Button>
      </div>

      <Card>
        <Table>
            <TableHeader>
                <TableRow>
                    <TableHead className="w-[180px]">Th·ªùi gian</TableHead>
                    <TableHead>Ng∆∞·ªùi th·ª±c hi·ªán</TableHead>
                    <TableHead>H√†nh ƒë·ªông</TableHead>
                    <TableHead>Chi ti·∫øt</TableHead>
                </TableRow>
            </TableHeader>
            <TableBody>
                {loading ? (
                    <TableRow><TableCell colSpan={4} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ƒêang t·∫£i d·ªØ li·ªáu...</TableCell></TableRow>
                ) : logs.length === 0 ? (
                    <TableRow><TableCell colSpan={4} className="text-center h-24 text-muted-foreground">Ch∆∞a c√≥ nh·∫≠t k√Ω n√†o.</TableCell></TableRow>
                ) : (
                    logs.map(log => (
                        <TableRow key={log.id}>
                            <TableCell className="text-xs text-gray-500 font-mono">
                                {new Date(log.timestamp).toLocaleString('vi-VN')}
                            </TableCell>
                            <TableCell className="font-bold text-sm">{log.username}</TableCell>
                            <TableCell>
                                <Badge variant="outline" className={getActionColor(log.action)}>
                                    {log.action}
                                </Badge>
                            </TableCell>
                            <TableCell className="text-sm text-gray-600">{log.details}</TableCell>
                        </TableRow>
                    ))
                )}
            </TableBody>
        </Table>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/settings/page.tsx">
/*
fixed issues in Academic Year settings page:
- Khi t·∫°o nƒÉm h·ªçc m·ªõi, kh√¥ng b·∫Øt bu·ªôc ph·∫£i nh·∫≠p start_date v√† end_date n·ªØa
- Th√™m th√¥ng b√°o khi t·∫°o nƒÉm h·ªçc th√†nh c√¥ng
- Sau khi k√≠ch ho·∫°t nƒÉm h·ªçc m·ªõi, reload trang ƒë·ªÉ Header c·∫≠p nh·∫≠t l·∫°i nƒÉm h·ªçc hi·ªán t·∫°i 
*/

"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { CheckCircle, Settings, Plus, Loader2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface AcademicYear {
  id: number;
  code: string;
  isActive: boolean;
}

export default function SettingsPage() {
  const [years, setYears] = useState<AcademicYear[]>([]);
  const [loading, setLoading] = useState(true);
  const [newYear, setNewYear] = useState({ code: "" });

  const fetchYears = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/academic-years/');
      const data = res.data;
      setYears(data || []);
    } catch (e) { console.error(e); } 
    finally { setLoading(false); }
  };

  useEffect(() => { fetchYears(); }, []);

  const handleCreate = async () => {
    if (!newYear.code) return alert("Vui l√≤ng nh·∫≠p m√£ nƒÉm h·ªçc");
    try {
      await axios.post('/academic-years/', { code: newYear.code });
      alert("Th√™m th√†nh c√¥ng!");
      setNewYear({ code: "" });
      fetchYears();
    } catch (e: any) { const message = e?.response?.data?.detail || e?.message || "L·ªói k·∫øt n·ªëi"; alert("L·ªói: " + message); }
  };

  const handleActivate = async (id: number) => {
      try {
          await axios.put(`/academic-years/${id}`, { isActive: true });
          alert("ƒê√£ k√≠ch ho·∫°t nƒÉm h·ªçc m·ªõi!");
          fetchYears();
          // Reload trang ƒë·ªÉ Header c·∫≠p nh·∫≠t l·∫°i
          window.location.reload();
      } catch(e: any) { const message = e?.response?.data?.detail || e?.message || "L·ªói k·∫øt n·ªëi"; alert("L·ªói: " + message); }
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
            <Settings className="w-6 h-6 text-slate-700"/> C·∫•u h√¨nh H·ªá th·ªëng
        </h2>
        <p className="text-sm text-muted-foreground mt-1">Qu·∫£n l√Ω nƒÉm h·ªçc v√† c√°c tham s·ªë h·ªá th·ªëng.</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* FORM TH√äM M·ªöI */}
        <Card className="md:col-span-1 h-fit">
            <CardHeader><CardTitle>Th√™m NƒÉm h·ªçc m·ªõi</CardTitle></CardHeader>
            <CardContent className="space-y-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">M√£ NƒÉm h·ªçc</label>
                    <Input placeholder="2026-2027" value={newYear.code} onChange={e => setNewYear({...newYear, code: e.target.value})} />
                    <p className="text-xs text-muted-foreground">VD: 2026-2027, HK1-2026</p>
                </div>
                <Button className="w-full mt-2" onClick={handleCreate}>
                    <Plus className="w-4 h-4 mr-2"/> Th√™m m·ªõi
                </Button>
            </CardContent>
        </Card>

        {/* DANH S√ÅCH */}
        <Card className="md:col-span-2">
            <CardHeader><CardTitle>Danh s√°ch NƒÉm h·ªçc</CardTitle></CardHeader>
            <CardContent>
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>M√£ nƒÉm h·ªçc</TableHead>
                            <TableHead>Tr·∫°ng th√°i</TableHead>
                            <TableHead className="text-right">H√†nh ƒë·ªông</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {loading ? (
                            <TableRow><TableCell colSpan={4} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ƒêang t·∫£i...</TableCell></TableRow>
                        ) : years.map(y => (
                            <TableRow key={y.id} className={y.isActive ? "bg-green-50" : ""}>
                                <TableCell className="font-mono font-bold">{y.code}</TableCell>
                                <TableCell>
                                    {y.isActive ? (
                                        <Badge className="bg-green-600 hover:bg-green-700">ƒêang k√≠ch ho·∫°t</Badge>
                                    ) : (
                                        <Badge variant="outline">Kh√¥ng ho·∫°t ƒë·ªông</Badge>
                                    )}
                                </TableCell>
                                <TableCell className="text-right">
                                    {!y.isActive && (
                                        <Button size="sm" variant="outline" onClick={() => handleActivate(y.id)}>
                                            <CheckCircle className="w-4 h-4 mr-2 text-green-600"/> K√≠ch ho·∫°t
                                        </Button>
                                    )}
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/admin/users/page.tsx">
/*

http://localhost:3000/admin/users
‚úÖ FIXED: Th√™m t√†i kho·∫£n v·ªõi vai tr√≤ ƒë∆∞·ª£c l∆∞u v√†o DB th√¥ng qua API /users/:id/roles
‚úÖ FIXED: ƒê√£ th√™m option ch·ªçn khoa (department) khi t·∫°o user
‚úÖ FIXED: Ki·ªÉm tra tr√πng username, email khi t·∫°o user m·ªõi
‚úÖ FIXED: Ki·ªÉm tra ƒë·ªãnh d·∫°ng email v·ªõi regex validation
‚úÖ FIXED: Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† vai tr√≤ c·ªßa user trong b·∫£ng (updated UserSchema to include roles)
‚úÖ FIXED: Ch·ªçn vai tr√≤ b·∫±ng dropdown gi·ªëng nh∆∞ ch·ªçn khoa
‚úÖ FIXED: H·ªç t√™n hi·ªÉn th·ªã - updated interface to use camelCase (fullName) matching API response
‚úÖ FIXED: Role assignment timing - Added 300ms delay + better error handling
‚úÖ FIXED: Th√™m t√≠nh nƒÉng Edit user v·ªõi modal ch·ªânh s·ª≠a
‚úÖ FIXED: SOLUTION FOR ROLE ASSIGNMENT:
- Sau khi g√°n role qua POST /users/:id/roles, ƒë·ª£i 300ms ƒë·ªÉ database commit
- Sau ƒë√≥ fetch l·∫°i users ƒë·ªÉ l·∫•y roles m·ªõi
- C√≥ error handling r√µ r√†ng ƒë·ªÉ b√°o l·ªói n·∫øu role assignment th·∫•t b·∫°i
- Hi·ªÉn th·ªã th√¥ng b√°o chi ti·∫øt n·∫øu c√≥ l·ªói t·ª´ API (vd: "method not allowed")

‚úÖ FIXED: NOTE: C·∫ßn ƒë·∫£m b·∫£o Flask API server ƒë√£ restart ƒë·ªÉ endpoint /users/:id/roles ho·∫°t ƒë·ªông
- L·ªói 500 khi x√≥a user
*/
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Trash2, Plus, Users, Loader2, Pencil } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface Role {
  id: number;
  name: string;
  description?: string;
}

interface Department {
  id: number;
  name: string;
  code: string;
  faculty_id: number;
}

interface User {
  id: number;
  username: string;
  fullName: string;  // API tr·∫£ v·ªÅ camelCase
  email: string;
  departmentId?: number;  // API tr·∫£ v·ªÅ camelCase
  isActive: boolean;  // API tr·∫£ v·ªÅ camelCase
  roles?: Array<{
    roleId: number;  // API tr·∫£ v·ªÅ camelCase
    role: Role;
  }>;
}

export default function UserManagementPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  const [open, setOpen] = useState(false); // Create modal state
  const [editOpen, setEditOpen] = useState(false); // Edit modal state
  const [editingUser, setEditingUser] = useState<User | null>(null); // User being edited
  const [departments, setDepartments] = useState<Department[]>([]);
  const [roles, setRoles] = useState<Role[]>([]);

  // Form state
  const [formData, setFormData] = useState({ 
    username: "", 
    password: "", 
    full_name: "", 
    email: "", 
    department_id: "",
    role_id: "" // Changed from role_ids array to single role_id
  });
  const [errors, setErrors] = useState<{username?: string; email?: string}>({});

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/users/');
      const data = res.data;
      setUsers(data || []);
    } catch (e: any) {
      const status = e?.response?.status || e?.status;
      if (status === 403) alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!");
      else console.error(e);
    } finally { setLoading(false); }
  };

  const fetchDepartments = async () => {
    try {
      const res = await axios.get('/departments/');
      setDepartments(res.data || []);
    } catch (e) {
      console.error("Failed to fetch departments:", e);
    }
  };

  const fetchRoles = async () => {
    try {
      const res = await axios.get('/roles/');
      setRoles(res.data || []);
    } catch (e) {
      console.error("Failed to fetch roles:", e);
    }
  };

  useEffect(() => { 
    fetchUsers(); 
    fetchDepartments();
    fetchRoles();
  }, []);

  const handleCreate = async () => {
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!formData.email || !emailRegex.test(formData.email)) {
      setErrors({ ...errors, email: "Email kh√¥ng h·ª£p l·ªá" });
      return alert("Vui l√≤ng nh·∫≠p email h·ª£p l·ªá!");
    }

    if (!formData.username || !formData.password || !formData.email) {
      return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
    }

    // Check for duplicate username and email
    const existingUser = users.find(u => 
      u.username.toLowerCase() === formData.username.toLowerCase() || 
      u.email.toLowerCase() === formData.email.toLowerCase()
    );
    if (existingUser) {
      if (existingUser.username.toLowerCase() === formData.username.toLowerCase()) {
        setErrors({ ...errors, username: "Username ƒë√£ t·ªìn t·∫°i" });
        return alert("Username ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!");
      }
      if (existingUser.email.toLowerCase() === formData.email.toLowerCase()) {
        setErrors({ ...errors, email: "Email ƒë√£ t·ªìn t·∫°i" });
        return alert("Email ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!");
      }
    }

    try {
        const userData: any = { 
            username: formData.username, 
            password: formData.password, 
            full_name: formData.full_name || formData.username,
            email: formData.email,
            is_active: true
        };
        
        // Add department_id if selected
        if (formData.department_id) {
          userData.department_id = parseInt(formData.department_id);
        }

        // Create user first
        const userResponse = await axios.post('/users/', userData);
        const newUser = userResponse.data;
        
        // Assign role if selected
        let roleAssigned = false;
        if (formData.role_id) {
          try {
            const roleResponse = await axios.post(`/users/${newUser.id}/roles`, {
              role_ids: [parseInt(formData.role_id)]
            });
            console.log("Role assigned successfully to user", newUser.id, roleResponse.data);
            roleAssigned = true;
            
            // Wait a bit for database to commit
            await new Promise(resolve => setTimeout(resolve, 300));
          } catch (roleError: any) {
            console.error("Could not assign role:", roleError);
            console.error("Error details:", roleError.response?.data);
            alert(`T·∫°o user th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ g√°n vai tr√≤: ${roleError.response?.data?.error || roleError.message}`);
          }
        }

        // Fetch users again to get updated roles BEFORE showing success message
        await fetchUsers();
        
        // Now show success and close modal
        if (roleAssigned || !formData.role_id) {
          alert("T·∫°o t√†i kho·∫£n th√†nh c√¥ng!");
        }
        setOpen(false);
        setFormData({ 
          username: "", 
          password: "", 
          full_name: "", 
          email: "", 
          department_id: "",
          role_id: ""
        });
        setErrors({});
    } catch (e: any) { 
      const message = e?.response?.data?.detail || e?.message || "L·ªói k·∫øt n·ªëi server"; 
      alert("L·ªói: " + message); 
    }
  };

  const handleEdit = (user: User) => {
    setEditingUser(user);
    setFormData({
      username: user.username,
      password: "", // Don't show password
      full_name: user.fullName,
      email: user.email,
      department_id: user.departmentId?.toString() || "",
      role_id: user.roles?.[0]?.roleId?.toString() || ""
    });
    setEditOpen(true);
  };

  const handleUpdate = async () => {
    if (!editingUser) return;
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!formData.email || !emailRegex.test(formData.email)) {
      setErrors({ ...errors, email: "Email kh√¥ng h·ª£p l·ªá" });
      return alert("Vui l√≤ng nh·∫≠p email h·ª£p l·ªá!");
    }

    // Check for duplicate email (excluding current user)
    const existingUser = users.find(u => 
      u.id !== editingUser.id && u.email.toLowerCase() === formData.email.toLowerCase()
    );
    if (existingUser) {
      setErrors({ ...errors, email: "Email ƒë√£ t·ªìn t·∫°i" });
      return alert("Email ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!");
    }

    try {
      const userData: any = {
        email: formData.email,
        full_name: formData.full_name || formData.username,
        is_active: true
      };

      // Add password if provided
      if (formData.password) {
        userData.password = formData.password;
      }

      // Add department_id if selected
      if (formData.department_id) {
        userData.department_id = parseInt(formData.department_id);
      }

      // Update user
      await axios.put(`/users/${editingUser.id}`, userData);

      // Update role if changed
      let roleUpdated = false;
      if (formData.role_id) {
        try {
          const roleResponse = await axios.post(`/users/${editingUser.id}/roles`, {
            role_ids: [parseInt(formData.role_id)]
          });
          console.log("Role updated successfully for user", editingUser.id, roleResponse.data);
          roleUpdated = true;
          
          // Wait a bit for database to commit
          await new Promise(resolve => setTimeout(resolve, 300));
        } catch (roleError: any) {
          console.error("Could not update role:", roleError);
          console.error("Error details:", roleError.response?.data);
          alert(`C·∫≠p nh·∫≠t user th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ g√°n vai tr√≤: ${roleError.response?.data?.error || roleError.message}`);
        }
      }

      // Fetch users again to get updated data BEFORE showing success message
      await fetchUsers();

      // Now show success and close modal
      if (roleUpdated || !formData.role_id) {
        alert("C·∫≠p nh·∫≠t t√†i kho·∫£n th√†nh c√¥ng!");
      }
      setEditOpen(false);
      setEditingUser(null);
      setFormData({
        username: "",
        password: "",
        full_name: "",
        email: "",
        department_id: "",
        role_id: ""
      });
      setErrors({});
    } catch (e: any) {
      const message = e?.response?.data?.detail || e?.message || "L·ªói k·∫øt n·ªëi server";
      alert("L·ªói: " + message);
    }
  };

  const handleDelete = async (id: number) => {
      if (!confirm("H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a user n√†y?")) return;
      try {
          await axios.delete(`/users/${id}`);
          alert("ƒê√£ x√≥a th√†nh c√¥ng!");
          fetchUsers();
      } catch (e: any) { const message = e?.response?.data?.detail || e?.message; alert("L·ªói: " + message); }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                <Users className="w-6 h-6 text-blue-600"/> Qu·∫£n tr·ªã Ng∆∞·ªùi d√πng
            </h2>
            <p className="text-sm text-muted-foreground mt-1">Qu·∫£n l√Ω danh s√°ch t√†i kho·∫£n truy c·∫≠p h·ªá th·ªëng</p>
        </div>
        
        {/* MODAL TH√äM USER */}
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button className="bg-blue-600 hover:bg-blue-700">
                    <Plus className="w-4 h-4 mr-2"/> Th√™m t√†i kho·∫£n
                </Button>
            </DialogTrigger>
            <DialogContent>
                <DialogHeader><DialogTitle>T·∫°o t√†i kho·∫£n m·ªõi</DialogTitle></DialogHeader>
                <div className="space-y-4 py-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">H·ªç v√† t√™n</label>
                        <Input value={formData.full_name} onChange={e => setFormData({...formData, full_name: e.target.value})} placeholder="VD: Nguy·ªÖn VƒÉn A" />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Email <span className="text-red-500">*</span></label>
                        <Input 
                          type="email" 
                          value={formData.email} 
                          onChange={e => {
                            setFormData({...formData, email: e.target.value});
                            if (errors.email) setErrors({...errors, email: undefined});
                          }} 
                          placeholder="VD: gvmoi@example.com" 
                          className={errors.email ? "border-red-500" : ""}
                          required 
                        />
                        {errors.email && <p className="text-xs text-red-500">{errors.email}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Username <span className="text-red-500">*</span></label>
                            <Input 
                              value={formData.username} 
                              onChange={e => {
                                setFormData({...formData, username: e.target.value});
                                if (errors.username) setErrors({...errors, username: undefined});
                              }} 
                              placeholder="VD: gv_moi" 
                              className={errors.username ? "border-red-500" : ""}
                              required 
                            />
                            {errors.username && <p className="text-xs text-red-500">{errors.username}</p>}
                        </div>
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Password <span className="text-red-500">*</span></label>
                            <Input type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="******" required />
                        </div>
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Khoa</label>
                        <select 
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background"
                            value={formData.department_id} 
                            onChange={e => setFormData({...formData, department_id: e.target.value})}
                        >
                            <option value="">-- Ch·ªçn khoa (kh√¥ng b·∫Øt bu·ªôc) --</option>
                            {departments.map(dept => (
                              <option key={dept.id} value={dept.id}>{dept.name} ({dept.code})</option>
                            ))}
                        </select>
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Vai tr√≤</label>
                        <select 
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background"
                            value={formData.role_id} 
                            onChange={e => setFormData({...formData, role_id: e.target.value})}
                        >
                            <option value="">-- Ch·ªçn vai tr√≤ (kh√¥ng b·∫Øt bu·ªôc) --</option>
                            {roles.map(role => (
                              <option key={role.id} value={role.id}>{role.name}</option>
                            ))}
                        </select>
                    </div>
                    <Button className="w-full mt-4 bg-blue-600 hover:bg-blue-700" onClick={handleCreate}>X√°c nh·∫≠n t·∫°o</Button>
                </div>
            </DialogContent>
        </Dialog>

        {/* MODAL EDIT USER */}
        <Dialog open={editOpen} onOpenChange={setEditOpen}>
            <DialogContent>
                <DialogHeader><DialogTitle>Ch·ªânh s·ª≠a th√¥ng tin t√†i kho·∫£n</DialogTitle></DialogHeader>
                <div className="space-y-4 py-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Username</label>
                        <Input value={formData.username} disabled className="bg-gray-100" />
                        <p className="text-xs text-gray-500">Username kh√¥ng th·ªÉ thay ƒë·ªïi</p>
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">H·ªç v√† t√™n</label>
                        <Input value={formData.full_name} onChange={e => setFormData({...formData, full_name: e.target.value})} placeholder="VD: Nguy·ªÖn VƒÉn A" />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Email <span className="text-red-500">*</span></label>
                        <Input 
                          type="email" 
                          value={formData.email} 
                          onChange={e => {
                            setFormData({...formData, email: e.target.value});
                            if (errors.email) setErrors({...errors, email: undefined});
                          }} 
                          placeholder="VD: gvmoi@example.com" 
                          className={errors.email ? "border-red-500" : ""}
                          required 
                        />
                        {errors.email && <p className="text-xs text-red-500">{errors.email}</p>}
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Password m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                        <Input type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="******" />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Khoa</label>
                        <select 
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background"
                            value={formData.department_id} 
                            onChange={e => setFormData({...formData, department_id: e.target.value})}
                        >
                            <option value="">-- Ch·ªçn khoa (kh√¥ng b·∫Øt bu·ªôc) --</option>
                            {departments.map(dept => (
                              <option key={dept.id} value={dept.id}>{dept.name} ({dept.code})</option>
                            ))}
                        </select>
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Vai tr√≤</label>
                        <select 
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background"
                            value={formData.role_id} 
                            onChange={e => setFormData({...formData, role_id: e.target.value})}
                        >
                            <option value="">-- Ch·ªçn vai tr√≤ (kh√¥ng b·∫Øt bu·ªôc) --</option>
                            {roles.map(role => (
                              <option key={role.id} value={role.id}>{role.name}</option>
                            ))}
                        </select>
                    </div>
                    <Button className="w-full mt-4 bg-blue-600 hover:bg-blue-700" onClick={handleUpdate}>C·∫≠p nh·∫≠t</Button>
                </div>
            </DialogContent>
        </Dialog>
      </div>

      <Card>
        <Table>
            <TableHeader>
                <TableRow>
                    <TableHead className="w-[80px]">ID</TableHead>
                    <TableHead>T√†i kho·∫£n</TableHead>
                    <TableHead>H·ªç t√™n hi·ªÉn th·ªã</TableHead>
                    <TableHead>Vai tr√≤</TableHead>
                    <TableHead className="text-right">H√†nh ƒë·ªông</TableHead>
                </TableRow>
            </TableHeader>
            <TableBody>
                {loading ? (
                    <TableRow><TableCell colSpan={5} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ƒêang t·∫£i danh s√°ch...</TableCell></TableRow>
                ) : users.length === 0 ? (
                    <TableRow><TableCell colSpan={5} className="text-center h-24 text-muted-foreground">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o.</TableCell></TableRow>
                ) : (
                    users.map(u => {
                        // Get role names from user's roles array
                        const userRoles = u.roles?.map(ur => ur.role.name) || [];
                        const primaryRole = userRoles[0] || 'No Role';
                        
                        return (
                        <TableRow key={u.id}>
                            <TableCell className="font-mono text-xs text-gray-500">#{u.id}</TableCell>
                            <TableCell className="font-bold">{u.username}</TableCell>
                            <TableCell>{u.fullName || '-'}</TableCell>
                            <TableCell>
                                <div className="flex flex-wrap gap-1">
                                  {userRoles.length > 0 ? userRoles.map((roleName, idx) => (
                                    <Badge key={idx} variant="outline" className={
                                        roleName === 'Admin' ? 'border-red-200 bg-red-50 text-red-700' :
                                        roleName === 'Student' ? 'border-green-200 bg-green-50 text-green-700' : 
                                        'border-blue-200 bg-blue-50 text-blue-700'
                                    }>
                                        {roleName}
                                    </Badge>
                                  )) : (
                                    <span className="text-xs text-gray-400">Ch∆∞a g√°n vai tr√≤</span>
                                  )}
                                </div>
                            </TableCell>
                            <TableCell className="text-right">
                                <div className="flex justify-end gap-2">
                                    <Button 
                                        variant="ghost" 
                                        size="icon" 
                                        onClick={() => handleEdit(u)} 
                                        className="text-gray-400 hover:text-blue-600 hover:bg-blue-50" 
                                        title="Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng"
                                    >
                                        <Pencil className="w-4 h-4"/>
                                    </Button>
                                    <Button 
                                        variant="ghost" 
                                        size="icon" 
                                        onClick={() => handleDelete(u.id)} 
                                        className="text-gray-400 hover:text-red-600 hover:bg-red-50" 
                                        title="X√≥a ng∆∞·ªùi d√πng"
                                    >
                                        <Trash2 className="w-4 h-4"/>
                                    </Button>
                                </div>
                            </TableCell>
                        </TableRow>
                        );
                    })
                )}
            </TableBody>
        </Table>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/layout.tsx">
// apps/web/app/(main)/layout.tsx
import Sidebar from "@/components/Sidebar";
import Header from "@/components/Header";
import { AuthProvider } from "@/contexts/AuthContext";
import { NotificationProvider } from "@/contexts/NotificationContext";

export default function MainLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <AuthProvider>
      <NotificationProvider>
        <div className="min-h-screen">
          {/* Sidebar c·ªë ƒë·ªãnh */}
          <div>
            <Sidebar />
          </div>

          {/* Khu v·ª±c n·ªôi dung ch√≠nh */}
          <div className="md:pl-64 min-h-screen flex flex-col">
            <Header />
            <main className="p-6 flex-1 bg-gray-50/50">
              {children}
            </main>
          </div>
        </div>
      </NotificationProvider>
    </AuthProvider>
  );
}
</file>

<file path="apps/web/app/(main)/page.tsx">
"use client";

import React, { useEffect, useState, useCallback } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "@/components/ui/table";
import { Edit, Eye, GitCompare, Loader2, RefreshCcw } from "lucide-react";
import SyllabusDeleteButton from "@/components/SyllabusDeleteButton"; 
import DashboardCharts from "@/components/DashboardCharts";
import axios from "@/lib/axios";

interface Syllabus {
  id: number;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  status: string;
  version: string;
  lecturer: string;
  dateEdited: string;
}

export default function Dashboard() {
  const router = useRouter();
  
  const [syllabuses, setSyllabuses] = useState<Syllabus[]>([]);
  const [total, setTotal] = useState(0);
  const [totalPages, setTotalPages] = useState(1);
  const [loading, setLoading] = useState(true);
  const [statsData, setStatsData] = useState(null);
  
  const [currentPage, setCurrentPage] = useState(1);
  const [searchTerm, setSearchTerm] = useState("");
  
  // Get user role
  const [userRole, setUserRole] = useState<string>("");
  
  useEffect(() => {
    if (typeof window !== "undefined") {
      const role = localStorage.getItem("role") || "";
      setUserRole(role);
    }
  }, []);

  const fetchData = useCallback(async (page: number, keyword: string) => {
    setLoading(true);

    try {
      const query = new URLSearchParams({ page: page.toString(), limit: "10", search: keyword });
      const listRes = await axios.get(`/syllabuses?${query.toString()}`);
      const list = listRes.data;
      setSyllabuses(list.data || []);
      setTotal(list.total || 0);
      setTotalPages(list.total_pages || 1);

      try {
        const statsRes = await axios.get(`/stats`);
        const stats = statsRes.data;
        setStatsData(stats);
      } catch (e) {
        // ignore stats error
      }

    } catch (err: any) {
      console.error(err);
      if (err?.response?.status === 401 || err?.status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("role");
        router.push("/login");
        return;
      }
    } finally { setLoading(false); }
  }, [router]);

  useEffect(() => {
    const timer = setTimeout(() => fetchData(currentPage, searchTerm), 500);
    return () => clearTimeout(timer);
  }, [searchTerm, currentPage, fetchData]);

  const renderStatusBadge = (status: string) => {
    let color = "bg-gray-500";
    let label = status;
    
    switch (status) {
        case "Approved": color = "bg-green-600"; break;
        case "Pending": color = "bg-yellow-500"; label = "Pending Review"; break;
        case "Pending Approval": color = "bg-orange-500"; label = "Pending AA"; break; 
        case "Returned": color = "bg-red-500"; break;
        case "Draft": color = "bg-slate-500"; break;
    }
    return <Badge className={color}>{label}</Badge>;
  };

  return (
    <div className="space-y-8">
      
      <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-2xl font-bold tracking-tight">Dashboard Overview</h2>
            <p className="text-sm text-muted-foreground">T·ªïng quan h·ªá th·ªëng th·ªùi gian th·ª±c</p>
          </div>
          <DashboardCharts data={statsData} />
      </section>

      <section className="space-y-4">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t pt-8">
            <div>
                <h3 className="text-xl font-bold tracking-tight">Qu·∫£n l√Ω ƒê·ªÅ c∆∞∆°ng</h3>
                <p className="text-sm text-muted-foreground">Danh s√°ch chi ti·∫øt c√°c h·ªçc ph·∫ßn</p>
            </div>
            <div className="w-full md:w-1/3 flex gap-2">
              <Input
                placeholder="T√¨m ki·∫øm theo t√™n ho·∫∑c m√£ HP..."
                value={searchTerm}
                onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                className="bg-white"
              />
              <Button variant="outline" size="icon" onClick={() => fetchData(currentPage, searchTerm)} title="L√†m m·ªõi">
                  <RefreshCcw className="w-4 h-4"/>
              </Button>
            </div>
          </div>

          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-[100px]">M√£ HP</TableHead>
                  <TableHead>T√™n H·ªçc Ph·∫ßn</TableHead>
                  <TableHead>Phi√™n b·∫£n</TableHead>
                  <TableHead>T√≠n ch·ªâ</TableHead>
                  <TableHead>Gi·∫£ng vi√™n</TableHead>
                  <TableHead>Tr·∫°ng th√°i</TableHead>
                  <TableHead className="text-right">H√†nh ƒë·ªông</TableHead> 
                </TableRow>
              </TableHeader>
              <TableBody>
                {loading && syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center">
                      <div className="flex justify-center items-center gap-2">
                        <Loader2 className="animate-spin w-4 h-4" /> ƒêang t·∫£i d·ªØ li·ªáu...
                      </div>
                    </TableCell>
                  </TableRow>
                ) : syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center text-muted-foreground">
                      Kh√¥ng t√¨m th·∫•y ƒë·ªÅ c∆∞∆°ng n√†o.
                    </TableCell>
                  </TableRow>
                ) : (
                  syllabuses.map((s) => (
                    <TableRow key={s.id}>
                      <TableCell className="font-bold">{s.subjectCode}</TableCell>
                      <TableCell>
                        <div className="font-medium">{s.subjectNameVi || "(Ch∆∞a c√≥ t√™n)"}</div>
                        <div className="text-xs text-muted-foreground truncate max-w-[200px]">{s.subjectNameEn}</div>
                      </TableCell>
                      <TableCell><Badge variant="outline" className="bg-slate-50">v{s.version || "1.0"}</Badge></TableCell>
                      <TableCell>{s.credits}</TableCell>
                      <TableCell className="text-sm text-gray-600">{s.lecturer}</TableCell>
                      <TableCell>{renderStatusBadge(s.status)}</TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2 items-center">
                            <Link href={`/syllabus/compare?baseId=${s.id - 1}&targetId=${s.id}`}>
                                <Button variant="outline" size="icon" title="So s√°nh b·∫£n c≈©"><GitCompare className="w-4 h-4 text-orange-600" /></Button>
                            </Link>
                            <Link href={`/syllabus/${s.id}`}>
                                <Button variant="ghost" size="icon" title="Xem chi ti·∫øt"><Eye className="w-4 h-4" /></Button>
                            </Link>
                            
                            {/* Edit - ch·ªâ Lecturer v√† Admin, v√† ch·ªâ khi Draft/Returned */}
                            {(userRole === "Lecturer" || userRole === "Admin") && 
                             (s.status === "Draft" || s.status === "Returned") && (
                                <Link href={`/syllabus/${s.id}/edit`}>
                                    <Button variant="ghost" size="icon" title="Ch·ªânh s·ª≠a"><Edit className="w-4 h-4 text-teal-600" /></Button>
                                </Link>
                            )}
                            
                            {/* Delete - ch·ªâ Admin */}
                            {userRole === "Admin" && s.status === "Draft" && (
                                <div className="scale-90"><SyllabusDeleteButton id={s.id} /></div>
                            )}
                        </div>
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
            
            <div className="flex items-center justify-between px-4 py-4 border-t">
              <div className="text-sm text-muted-foreground">Trang {currentPage} / {totalPages}</div>
              <div className="flex gap-2">
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage <= 1}>Tr∆∞·ªõc</Button>
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage >= totalPages}>Sau</Button>
              </div>
            </div>
          </Card>
      </section>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/profile/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios, { API_BASE } from "@/lib/axios";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { User, Shield, Key, Save, Mail, Building2, Edit2, Upload, History, AlertCircle } from "lucide-react";

interface Department {
  id: number;
  name: string;
  code: string;
  faculty?: {
    id: number;
    name: string;
    code: string;
  };
}

interface Role {
  id: number;
  name: string;
  description?: string;
}

interface UserProfile {
  id: number;
  username: string;
  email: string;
  fullName: string;
  isActive: boolean;
  avatarFileId?: number;
  department?: Department;
  roles?: Role[];
}

interface AuditLog {
  id: number;
  timestamp: string;
  action: string;
  resourceTarget: string;
  details?: string;
}

export default function ProfilePage() {
  const [user, setUser] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);
  const [auditLogs, setAuditLogs] = useState<AuditLog[]>([]);
  const [logsLoading, setLogsLoading] = useState(false);

  // State cho form ch·ªânh s·ª≠a th√¥ng tin
  const [editMode, setEditMode] = useState(false);
  const [editData, setEditData] = useState({ fullName: "", email: "" });
  const [editLoading, setEditLoading] = useState(false);

  // State cho form ƒë·ªïi m·∫≠t kh·∫©u
  const [passData, setPassData] = useState({ current: "", new: "", confirm: "" });
  const [passLoading, setPassLoading] = useState(false);

  // State cho upload avatar
  const [avatarUploading, setAvatarUploading] = useState(false);
  const fileInputRef = React.useRef<HTMLInputElement>(null);

  useEffect(() => {
    const fetchProfile = async () => {
        try {
            const userRes = await axios.get('/users/me');
            const userData = userRes.data;
            setUser(userData);
            setEditData({ 
              fullName: userData.fullName || "", 
              email: userData.email || "" 
            });
        } catch (e) { console.error(e); }
        finally { setLoading(false); }
    };
    fetchProfile();
  }, []);

  const fetchAuditLogs = async () => {
    if (!user) return;
    setLogsLoading(true);
    try {
      const res = await axios.get(`/admin/logs?userId=${user.id}&limit=20`);
      setAuditLogs(res.data || []);
    } catch (e) { 
      console.error(e); 
    } finally {
      setLogsLoading(false);
    }
  };

  const handleEditProfile = async () => {
    if (!user || !editData.fullName || !editData.email) {
      return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
    }

    setEditLoading(true);
    try {
      await axios.put(`/users/${user.id}`, {
        fullName: editData.fullName,
        email: editData.email
      });
      
      // C·∫≠p nh·∫≠t state local
      setUser({ ...user, fullName: editData.fullName, email: editData.email });
      setEditMode(false);
      alert("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!");
    } catch (err: any) {
      console.error(err);
      const message = err?.response?.data?.detail || "L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin";
      alert("L·ªói: " + message);
    } finally {
      setEditLoading(false);
    }
  };

  const handleChangePassword = async () => {
      // Validate c∆° b·∫£n
      if (!passData.current || !passData.new) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
      if (passData.new !== passData.confirm) return alert("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp");
      if (passData.new.length < 6) return alert("M·∫≠t kh·∫©u m·ªõi ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n");

      setPassLoading(true);
      try {
          await axios.post('/auth/change-password', { 
            currentPassword: passData.current, 
            newPassword: passData.new 
          });
          alert("Th√†nh c√¥ng! M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi.");
          setPassData({ current: "", new: "", confirm: "" }); // Reset form
      } catch (err: any) {
          console.error(err);
          const message = err?.response?.data?.detail || err?.message || "L·ªói k·∫øt n·ªëi server";
          alert("L·ªói: " + message);
      } finally {
          setPassLoading(false);
      }
  };

  const handleAvatarUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file || !user) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      return alert("Vui l√≤ng ch·ªçn file ·∫£nh (JPG, PNG, GIF...)");
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      return alert("K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB");
    }

    setAvatarUploading(true);
    try {
      // 1. Upload file
      const formData = new FormData();
      formData.append('file', file);
      formData.append('user_id', user.id.toString());
      
      const uploadRes = await axios.post('/files/upload', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      
      const fileId = uploadRes.data.id;

      // 2. Update user avatar_file_id
      await axios.put(`/users/${user.id}`, {
        avatar_file_id: fileId
      });

      // 3. Update local state
      setUser({ ...user, avatarFileId: fileId });
      alert("C·∫≠p nh·∫≠t avatar th√†nh c√¥ng!");
      
      // Refresh page ƒë·ªÉ load avatar m·ªõi
      window.location.reload();
    } catch (err: any) {
      console.error(err);
      const message = err?.response?.data?.detail || "L·ªói khi upload avatar";
      alert("L·ªói: " + message);
    } finally {
      setAvatarUploading(false);
      // Reset input
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    }
  };

  const formatDateTime = (dateStr: string) => {
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat('vi-VN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  };

  const getActionBadgeColor = (action: string) => {
    switch (action.toUpperCase()) {
      case 'LOGIN': return 'bg-green-100 text-green-700 border-green-200';
      case 'CREATE': return 'bg-blue-100 text-blue-700 border-blue-200';
      case 'UPDATE': return 'bg-yellow-100 text-yellow-700 border-yellow-200';
      case 'DELETE': return 'bg-red-100 text-red-700 border-red-200';
      default: return 'bg-gray-100 text-gray-700 border-gray-200';
    }
  };

  if (loading) return <div className="p-8 text-center">ƒêang t·∫£i th√¥ng tin...</div>;
  if (!user) return <div className="p-8 text-center">Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.</div>;

  return (
    <div className="max-w-5xl mx-auto space-y-6">
        <div className="flex items-center justify-between">
          <h2 className="text-2xl font-bold tracking-tight">H·ªì s∆° c√° nh√¢n</h2>
          {!user.isActive && (
            <Badge variant="destructive" className="gap-1">
              <AlertCircle className="w-3 h-3"/> T√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a
            </Badge>
          )}
        </div>
        
        <div className="grid gap-6 md:grid-cols-3">
            {/* C·ªôt tr√°i: Avatar & Info Card */}
            <Card className="md:col-span-1">
                <CardContent className="pt-6 flex flex-col items-center text-center">
                    <div className="relative mb-4">
                      <Avatar className="w-28 h-28 border-4 border-slate-100 shadow-md">
                          <AvatarImage 
                            src={user.avatarFileId 
                              ? `${API_BASE}/files/${user.avatarFileId}` 
                              : `https://ui-avatars.com/api/?name=${user.fullName}&background=0D8ABC&color=fff&size=128`
                            } 
                          />
                          <AvatarFallback>{user.fullName?.substring(0, 2).toUpperCase()}</AvatarFallback>
                      </Avatar>
                      <Button
                        size="sm"
                        variant="secondary"
                        className="absolute bottom-0 right-0 rounded-full w-8 h-8 p-0 shadow-lg"
                        onClick={() => fileInputRef.current?.click()}
                        disabled={avatarUploading}
                        title="Thay ƒë·ªïi avatar"
                      >
                        {avatarUploading ? (
                          <span className="animate-spin">‚è≥</span>
                        ) : (
                          <Upload className="w-4 h-4" />
                        )}
                      </Button>
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/*"
                        className="hidden"
                        onChange={handleAvatarUpload}
                      />
                    </div>
                    <h3 className="font-bold text-xl mb-1">{user.fullName}</h3>
                    <div className="text-sm text-muted-foreground mb-3">@{user.username}</div>
                    
                    {/* Roles */}
                    <div className="flex flex-wrap gap-2 justify-center mb-4">
                      {user.roles && user.roles.length > 0 ? (
                        user.roles.map((role, idx) => {
                          const roleId = role.id || (role as any).roleId || (role as any).role?.id || idx;
                          const roleName = role.name || (role as any).role?.name || "Unknown";
                          return (
                            <Badge key={`role-${roleId}-${idx}`} variant="outline" className="gap-1 bg-blue-50 text-blue-700 border-blue-200">
                              <Shield className="w-3 h-3"/> {roleName}
                            </Badge>
                          );
                        })
                      ) : (
                        <Badge variant="outline">Ch∆∞a c√≥ vai tr√≤</Badge>
                      )}
                    </div>

                    <Separator className="my-4"/>

                    {/* Department & Faculty */}
                    {user.department && (
                      <div className="w-full space-y-2 text-sm">
                        <div className="flex items-start gap-2 text-left">
                          <Building2 className="w-4 h-4 mt-0.5 text-muted-foreground flex-shrink-0"/>
                          <div>
                            <div className="font-medium">{user.department.name}</div>
                            {user.department.faculty && (
                              <div className="text-xs text-muted-foreground">{user.department.faculty.name}</div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                </CardContent>
            </Card>

            {/* C·ªôt ph·∫£i: Tabs */}
            <div className="md:col-span-2">
              <Tabs defaultValue="info" className="w-full">
                <TabsList className="grid w-full grid-cols-3">
                  <TabsTrigger value="info">Th√¥ng tin</TabsTrigger>
                  <TabsTrigger value="security">B·∫£o m·∫≠t</TabsTrigger>
                  <TabsTrigger value="history" onClick={fetchAuditLogs}>L·ªãch s·ª≠</TabsTrigger>
                </TabsList>

                {/* Tab: Th√¥ng tin */}
                <TabsContent value="info" className="space-y-4">
                  <Card>
                    <CardHeader>
                      <div className="flex items-center justify-between">
                        <CardTitle>Th√¥ng tin t√†i kho·∫£n</CardTitle>
                        {!editMode ? (
                          <Button variant="outline" size="sm" onClick={() => setEditMode(true)}>
                            <Edit2 className="w-4 h-4 mr-2"/> Ch·ªânh s·ª≠a
                          </Button>
                        ) : (
                          <div className="flex gap-2">
                            <Button variant="outline" size="sm" onClick={() => {
                              setEditMode(false);
                              setEditData({ fullName: user.fullName, email: user.email });
                            }}>
                              H·ªßy
                            </Button>
                            <Button size="sm" onClick={handleEditProfile} disabled={editLoading}>
                              <Save className="w-4 h-4 mr-2"/> {editLoading ? "ƒêang l∆∞u..." : "L∆∞u"}
                            </Button>
                          </div>
                        )}
                      </div>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="space-y-2">
                        <Label htmlFor="fullName" className="flex items-center gap-2">
                          <User className="w-4 h-4"/> H·ªç v√† t√™n
                        </Label>
                        <Input 
                          id="fullName"
                          value={editMode ? editData.fullName : user.fullName} 
                          onChange={e => editMode && setEditData({...editData, fullName: e.target.value})}
                          readOnly={!editMode}
                          className={!editMode ? "bg-slate-50" : ""}
                        />
                      </div>
                      
                      <div className="space-y-2">
                        <Label htmlFor="email" className="flex items-center gap-2">
                          <Mail className="w-4 h-4"/> Email
                        </Label>
                        <Input 
                          id="email"
                          type="email"
                          value={editMode ? editData.email : user.email} 
                          onChange={e => editMode && setEditData({...editData, email: e.target.value})}
                          readOnly={!editMode}
                          className={!editMode ? "bg-slate-50" : ""}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="username" className="flex items-center gap-2">
                          <Key className="w-4 h-4"/> T√™n ƒëƒÉng nh·∫≠p
                        </Label>
                        <Input 
                          id="username"
                          value={user.username} 
                          readOnly 
                          className="bg-slate-50"
                        />
                        <p className="text-xs text-muted-foreground">T√™n ƒëƒÉng nh·∫≠p kh√¥ng th·ªÉ thay ƒë·ªïi</p>
                      </div>
                    </CardContent>
                  </Card>
                </TabsContent>

                {/* Tab: B·∫£o m·∫≠t */}
                <TabsContent value="security" className="space-y-4">
                  <Card>
                    <CardHeader>
                      <CardTitle>ƒê·ªïi m·∫≠t kh·∫©u</CardTitle>
                      <CardDescription>ƒê·ªÉ b·∫£o m·∫≠t, vui l√≤ng s·ª≠ d·ª•ng m·∫≠t kh·∫©u m·∫°nh v√† kh√¥ng chia s·∫ª cho ng∆∞·ªùi kh√°c.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="space-y-2">
                        <Label htmlFor="currentPass">M·∫≠t kh·∫©u hi·ªán t·∫°i</Label>
                        <Input 
                          id="currentPass"
                          type="password" 
                          value={passData.current}
                          onChange={e => setPassData({...passData, current: e.target.value})}
                          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        />
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                          <Label htmlFor="newPass">M·∫≠t kh·∫©u m·ªõi</Label>
                          <Input 
                            id="newPass"
                            type="password"
                            value={passData.new}
                            onChange={e => setPassData({...passData, new: e.target.value})}
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                          />
                        </div>
                        <div className="space-y-2">
                          <Label htmlFor="confirmPass">Nh·∫≠p l·∫°i m·ªõi</Label>
                          <Input 
                            id="confirmPass"
                            type="password"
                            value={passData.confirm}
                            onChange={e => setPassData({...passData, confirm: e.target.value})}
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                          />
                        </div>
                      </div>
                      <div className="flex justify-end pt-2">
                        <Button onClick={handleChangePassword} disabled={passLoading}>
                          {passLoading ? "ƒêang x·ª≠ l√Ω..." : <><Save className="w-4 h-4 mr-2" /> ƒê·ªïi m·∫≠t kh·∫©u</>}
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </TabsContent>

                {/* Tab: L·ªãch s·ª≠ ho·∫°t ƒë·ªông */}
                <TabsContent value="history" className="space-y-4">
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <History className="w-5 h-5"/> L·ªãch s·ª≠ ho·∫°t ƒë·ªông
                      </CardTitle>
                      <CardDescription>20 ho·∫°t ƒë·ªông g·∫ßn nh·∫•t c·ªßa b·∫°n trong h·ªá th·ªëng</CardDescription>
                    </CardHeader>
                    <CardContent>
                      {logsLoading ? (
                        <div className="text-center py-8 text-muted-foreground">ƒêang t·∫£i...</div>
                      ) : auditLogs.length === 0 ? (
                        <div className="text-center py-8 text-muted-foreground">Ch∆∞a c√≥ l·ªãch s·ª≠ ho·∫°t ƒë·ªông</div>
                      ) : (
                        <div className="space-y-3">
                          {auditLogs.map((log, idx) => (
                            <div key={log.id || idx} className="flex items-start gap-3 p-3 rounded-lg border bg-card hover:bg-accent/50 transition-colors">
                              <Badge key={`badge-${log.id || idx}`} className={`mt-0.5 ${getActionBadgeColor(log.action)}`}>
                                {log.action}
                              </Badge>
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-sm">{log.resourceTarget}</div>
                                {log.details && (
                                  <div className="text-xs text-muted-foreground mt-1 line-clamp-2">{log.details}</div>
                                )}
                                <div className="text-xs text-muted-foreground mt-1">{formatDateTime(log.timestamp)}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </TabsContent>
              </Tabs>
            </div>
        </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/reviews/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Loader2, FileSignature, CheckCircle, XCircle, ArrowRight } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import axios from "@/lib/axios";

interface Syllabus {
  id: number;
  subjectNameVi: string;
  subjectCode: string;
  lecturer: string;
  dateEdited: string;
  status: string;
  version: string;
  headDepartment?: string; // T√™n tr∆∞·ªüng b·ªô m√¥n ƒë√£ duy·ªát
}

export default function ReviewPage() {
  const [reviews, setReviews] = useState<Syllabus[]>([]);
  const [loading, setLoading] = useState(true);
  const [userRole, setUserRole] = useState("");
  
  // State cho Modal t·ª´ ch·ªëi
  const [rejectId, setRejectId] = useState<number | null>(null);
  const [rejectReason, setRejectReason] = useState("");
  const [processing, setProcessing] = useState(false);

  const fetchReviews = async () => {
    setLoading(true);
    const role = localStorage.getItem("role") || "";
    setUserRole(role);

    // Determine status to fetch based on role
    let statusToFetch = "Pending";
    if (role === "Academic Affairs") statusToFetch = "Pending Approval";
    else if (role === "Principal") statusToFetch = "Pending Final Approval";
    else if (role === "Admin") statusToFetch = "";

    try {
      const url = statusToFetch ? `/syllabuses?status=${encodeURIComponent(statusToFetch)}&limit=100` : `/syllabuses?limit=100`;
      const res = await axios.get(url);
      const data = res.data;
      setReviews(data.data || []);
    } catch (err: any) {
      console.error(err);
      const status = err?.response?.status || err?.status;
      if (status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("role");
        window.location.href = "/login";
      }
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchReviews(); }, []);

  const handleApprove = async (id: number) => {
      // ƒê·ªïi th√¥ng b√°o t√πy theo role
      let msg = "X√°c nh·∫≠n duy·ªát?";
      if (userRole === "Head of Dept" || userRole === "HoD") {
          msg = "X√°c nh·∫≠n duy·ªát v√† chuy·ªÉn l√™n Ph√≤ng ƒê√†o t·∫°o?";
      } else if (userRole === "Academic Affairs" || userRole === "AA") {
          msg = "X√°c nh·∫≠n duy·ªát v√† chuy·ªÉn l√™n Ban Gi√°m hi·ªáu ph√™ duy·ªát cu·ªëi c√πng?";
      } else {
          msg = "X√°c nh·∫≠n PH√ä DUY·ªÜT CHI·∫æN L∆Ø·ª¢C CU·ªêI C√ôNG v√† c√¥ng b·ªë?";
      }

      if(!confirm(msg)) return;
      
      setProcessing(true);
      try {
          await axios.post(`/syllabuses/${id}/evaluate`, { action: 'approve' });
          alert("‚úÖ Ph√™ duy·ªát th√†nh c√¥ng!");
          fetchReviews();
      } catch(e: any) {
          const status = e?.response?.status || e?.status;
          
          if (status === 401) { 
              alert("‚ö†Ô∏è Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n."); 
              window.location.href = "/login"; 
              return; 
          }
          
          if (status === 403) {
              const message = e?.response?.data?.message || "B·∫°n kh√¥ng c√≥ quy·ªÅn ph√™ duy·ªát ƒë·ªÅ c∆∞∆°ng n√†y";
              alert("üö´ " + message);
              return;
          }
          
          if (status === 422) {
              const message = e?.response?.data?.message || "ƒê·ªÅ c∆∞∆°ng kh√¥ng trong tr·∫°ng th√°i ph√π h·ª£p";
              alert("‚ö†Ô∏è " + message);
              return;
          }
          
          const message = e?.response?.data?.message || e?.message || "L·ªói k·∫øt n·ªëi";
          alert("‚ùå " + message);
      } finally {
          setProcessing(false);
      }
  };

  const handleRejectSubmit = async () => {
      if (!rejectId || !rejectReason.trim()) return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi!");
      
      setProcessing(true);
      try {
          await axios.post(`/syllabuses/${rejectId}/evaluate`, { action: 'reject', comment: rejectReason });
          alert("‚úÖ ƒê√£ tr·∫£ v·ªÅ y√™u c·∫ßu s·ª≠a!");
          setRejectId(null);
          setRejectReason("");
          fetchReviews();
      } catch(e: any) {
          const status = e?.response?.status || e?.status;
          
          if (status === 403) {
              alert("üö´ B·∫°n kh√¥ng c√≥ quy·ªÅn t·ª´ ch·ªëi ƒë·ªÅ c∆∞∆°ng n√†y");
              return;
          }
          
          if (status === 422) {
              const message = e?.response?.data?.message || "ƒê·ªÅ c∆∞∆°ng kh√¥ng trong tr·∫°ng th√°i ph√π h·ª£p";
              alert("‚ö†Ô∏è " + message);
              return;
          }
          
          const message = e?.response?.data?.message || e?.message || "L·ªói k·∫øt n·ªëi";
          alert("‚ùå " + message);
      } finally { setProcessing(false); }
  };

  // X√°c ƒë·ªãnh ti√™u ƒë·ªÅ trang d·ª±a tr√™n Role
  const isAA = userRole === "Academic Affairs" || userRole === "AA";
  const isHoD = userRole === "Head of Dept" || userRole === "HoD";
  const isPrincipal = userRole === "Principal";

  const pageTitle = isPrincipal
    ? "Ph√™ duy·ªát Chi·∫øn l∆∞·ª£c (Ban Gi√°m hi·ªáu)"
    : isAA
    ? "Ph√™ duy·ªát c·∫•p Tr∆∞·ªùng (Ph√≤ng ƒê√†o t·∫°o)" 
    : "Ph√™ duy·ªát c·∫•p B·ªô m√¥n";

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
            <h2 className="text-2xl font-bold tracking-tight">{pageTitle}</h2>
            <p className="text-sm text-muted-foreground">
                {isPrincipal
                    ? "Danh s√°ch ƒë·ªÅ c∆∞∆°ng ƒë√£ qua ki·ªÉm duy·ªát chuy√™n m√¥n v√† nghi·ªáp v·ª•, ch·ªù ph√™ duy·ªát cu·ªëi c√πng."
                    : isAA 
                    ? "Danh s√°ch c√°c ƒë·ªÅ c∆∞∆°ng ƒë√£ ƒë∆∞·ª£c Tr∆∞·ªüng b·ªô m√¥n th√¥ng qua." 
                    : "Danh s√°ch c√°c ƒë·ªÅ c∆∞∆°ng ƒëang ch·ªù duy·ªát."}
            </p>
        </div>
        <Badge variant="secondary" className="text-base px-4 py-2 bg-yellow-100 text-yellow-800 hover:bg-yellow-200">
          Ch·ªù x·ª≠ l√Ω: {reviews.length}
        </Badge>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileSignature className="w-5 h-5"/> Danh s√°ch ch·ªù duy·ªát
          </CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>M√£ HP</TableHead>
                <TableHead>T√™n H·ªçc Ph·∫ßn</TableHead>
                <TableHead>Phi√™n b·∫£n</TableHead>
                <TableHead>Ng∆∞·ªùi g·ª≠i</TableHead>
                {(isAA || isPrincipal) && <TableHead>Tr·∫°ng th√°i duy·ªát</TableHead>}
                <TableHead>Ng√†y c·∫≠p nh·∫≠t</TableHead>
                <TableHead className="text-right">H√†nh ƒë·ªông</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow><TableCell colSpan={7} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> ƒêang t·∫£i...</TableCell></TableRow>
              ) : reviews.length === 0 ? (
                <TableRow><TableCell colSpan={7} className="text-center h-24 text-muted-foreground">Hi·ªán t·∫°i kh√¥ng c√≥ y√™u c·∫ßu n√†o c·∫ßn duy·ªát.</TableCell></TableRow>
              ) : (
                reviews.map((s) => (
                  <TableRow key={s.id}>
                    <TableCell className="font-bold">{s.subjectCode}</TableCell>
                    <TableCell>
                        <div className="font-medium">{s.subjectNameVi}</div>
                        {(s.status || "").toLowerCase() === "pending approval" && <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 border-blue-200 mt-1">ƒê√£ qua BM</Badge>}
                        {(s.status || "").toLowerCase() === "pending final approval" && <Badge variant="outline" className="text-xs bg-purple-50 text-purple-700 border-purple-200 mt-1">ƒê√£ qua PƒêT</Badge>}
                    </TableCell>
                    <TableCell><Badge variant="outline">v{s.version}</Badge></TableCell>
                    <TableCell className="text-gray-600">{s.lecturer}</TableCell>
                    
                    {(isAA || isPrincipal) && (
                        <TableCell className="text-green-600 font-medium">
                            <div className="flex items-center gap-1">
                                <CheckCircle className="w-3 h-3"/> 
                                {isPrincipal ? "PƒêT Approved" : (s.headDepartment || "BM Approved")}
                            </div>
                        </TableCell>
                    )}
                    
                    <TableCell>{s.dateEdited}</TableCell>
                    <TableCell className="text-right">
                      <div className="flex justify-end gap-2">
                        <Link href={`/syllabus/${s.id}/edit`}>
                             <Button variant="outline" size="sm">Xem chi ti·∫øt</Button>
                        </Link>
                        
                        <Button size="sm" className="bg-green-600 hover:bg-green-700" onClick={() => handleApprove(s.id)} title="Duy·ªát">
                            {isHoD ? <ArrowRight className="w-4 h-4"/> : <CheckCircle className="w-4 h-4"/>}
                        </Button>
                        
                        <Button size="sm" variant="destructive" onClick={() => setRejectId(s.id)} title="Tr·∫£ v·ªÅ">
                            <XCircle className="w-4 h-4"/>
                        </Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* MODAL NH·∫¨P L√ù DO T·ª™ CH·ªêI */}
      <Dialog open={!!rejectId} onOpenChange={(open) => !open && setRejectId(null)}>
        <DialogContent>
            <DialogHeader>
                <DialogTitle>Tr·∫£ v·ªÅ y√™u c·∫ßu s·ª≠a ƒë·ªïi</DialogTitle>
                <DialogDescription>
                    {isAA 
                        ? "ƒê·ªÅ c∆∞∆°ng s·∫Ω b·ªã tr·∫£ v·ªÅ tr·∫°ng th√°i 'Returned' cho Gi·∫£ng vi√™n (v√† th√¥ng b√°o cho Tr∆∞·ªüng BM)." 
                        : "Vui l√≤ng nh·∫≠p l√Ω do ƒë·ªÉ Gi·∫£ng vi√™n ch·ªânh s·ª≠a l·∫°i."}
                </DialogDescription>
            </DialogHeader>
            <div className="py-4">
                <Textarea 
                    placeholder="Nh·∫≠p l√Ω do c·ª• th·ªÉ..." 
                    rows={4}
                    value={rejectReason}
                    onChange={(e) => setRejectReason(e.target.value)}
                />
            </div>
            <DialogFooter>
                <Button variant="outline" onClick={() => setRejectId(null)}>H·ªßy b·ªè</Button>
                <Button variant="destructive" onClick={handleRejectSubmit} disabled={processing}>
                    {processing ? "ƒêang g·ª≠i..." : "X√°c nh·∫≠n Tr·∫£ v·ªÅ"}
                </Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/syllabus/[id]/edit/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Loader2 } from "lucide-react";
import SyllabusEditForm from "@/components/SyllabusEditForm";
import { SyllabusData, defaultSyllabus } from "@/components/Types";
import axios from "@/lib/axios";

export default function Page() {
  const params = useParams();
  const router = useRouter();
  const id = params?.id as string;

  const [syllabus, setSyllabus] = useState<SyllabusData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!id) {
      setError("not_found");
      setLoading(false);
      return;
    }

    const fetchSyllabus = async () => {
      try {
        const res = await axios.get(`/syllabuses/${id}/details`);
        const rawData = res.data;

        // Map backend plural names to frontend singular names used in Types.ts/Form
        const syllabusData: SyllabusData = {
            ...defaultSyllabus,
            id: rawData.id,
            subjectId: rawData.subjectId,
            programId: rawData.programId,
            academicYearId: rawData.academicYearId,
            lecturerId: rawData.lecturerId,
            status: rawData.status || "Draft",
            version: rawData.version || "1.0",
            
            // Content fields
            description: rawData.description || "",
            objectives: Array.isArray(rawData.objectives) ? rawData.objectives : [],
            studentDuties: rawData.studentDuties || "",
            otherRequirements: rawData.otherRequirements || "",
            
            // Foreign Keys for Dropdowns (already mapped to camelCase by axios interceptor)
            headDepartmentId: rawData.headDepartmentId,
            deanId: rawData.deanId,
            
            // Additional metadata
            preCourses: rawData.preCourses || "",
            coCourses: rawData.coCourses || "",
            courseType: rawData.courseType || "B·∫Øt bu·ªôc",
            componentType: rawData.componentType || "",
            datePrepared: rawData.datePrepared || "",
            dateEdited: rawData.dateEdited || "",
            dean: rawData.dean || "",
            headDepartment: rawData.headDepartment || "",
            
            // These come from Subject relationship (read-only display)
            // Robust check to handle both flattened and nested objects from backend
            subjectNameVi: typeof rawData.subjectNameVi === 'object' ? rawData.subjectNameVi?.nameVi : (rawData.subjectNameVi || ""),
            subjectNameEn: typeof rawData.subjectNameEn === 'object' ? rawData.subjectNameEn?.nameEn : (rawData.subjectNameEn || ""),
            subjectCode: typeof rawData.subjectCode === 'object' ? rawData.subjectCode?.code : (rawData.subjectCode || ""),
            credits: typeof rawData.credits === 'object' ? rawData.credits?.credits : (rawData.credits || 3),
            lecturer: typeof rawData.lecturer === 'object' ? rawData.lecturer?.fullName : (rawData.lecturer || ""),
            
            // Arrays - Backend plural vs Frontend singular
            clos: Array.isArray(rawData.clos) ? rawData.clos : [],
            ploMapping: Array.isArray(rawData.clos) 
                ? rawData.clos.map((clo: any) => {
                    const plos: { [key: string]: string } = {};
                    if (Array.isArray(clo.ploMappings)) {
                        clo.ploMappings.forEach((m: any) => {
                            if (m.programPloCode) plos[m.programPloCode] = m.level;
                        });
                    }
                    return { cloCode: clo.code, plos };
                })
                : [],
            
            // Mapping Assessment Systems
            assessmentScheme: Array.isArray(rawData.assessmentSchemes) && rawData.assessmentSchemes.length > 0 
                ? (rawData.assessmentSchemes[0].components || []).map((c: any) => ({
                    component: c.name || "",
                    weight: c.weight || 0,
                    method: c.method || "T·ª± lu·∫≠n",
                    criteria: c.criteria || "Theo ƒë√°p √°n",
                    // Map cloIds array back to string if needed, or just handle empty
                    clos: Array.isArray(c.cloIds) ? c.cloIds.join(", ") : (c.cloIds || "")
                }))
                : [],
                
            // Mapping Teaching Plans
            teachingPlan: Array.isArray(rawData.teachingPlans) 
                ? rawData.teachingPlans.map((p: any) => ({
                    week: p.week || 0,
                    topic: p.topic || "",
                    activity: p.activity || "",
                    assessment: p.assessment || "",
                    clos: Array.isArray(p.clos) ? p.clos.join(", ") : (p.clos || "")
                }))
                : [],
                
            materials: Array.isArray(rawData.materials) ? rawData.materials : [],
            timeAllocation: (() => {
                let ta = rawData.timeAllocation;
                if (typeof ta === 'string') {
                    try { ta = JSON.parse(ta); } catch(e) { ta = defaultSyllabus.timeAllocation; }
                }
                return ta || defaultSyllabus.timeAllocation;
            })(),
            prerequisites: rawData.prerequisites || "",
        };

        setSyllabus(syllabusData);
        setLoading(false);

      } catch (err: any) {
        console.error("Error fetching syllabus:", err);
        if (err?.response?.status === 404) {
          setError("not_found");
        } else if (err?.response?.status === 401) {
          router.push("/login");
        } else {
          setError("error");
        }
        setLoading(false);
      }
    };

    fetchSyllabus();
  }, [id, router]);

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <div className="flex flex-col items-center gap-3">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
          <p className="text-muted-foreground">ƒêang t·∫£i ƒë·ªÅ c∆∞∆°ng...</p>
        </div>
      </div>
    );
  }

  if (error === "not_found") {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Card className="w-full max-w-md text-center p-6">
          <CardHeader>
            <CardTitle className="text-xl">Kh√¥ng t√¨m th·∫•y ƒë·ªÅ c∆∞∆°ng</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-muted-foreground mb-4">ƒê·ªÅ c∆∞∆°ng n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
            <Link href="/dashboard" className="text-primary hover:underline">Quay v·ªÅ Dashboard</Link>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Card className="w-full max-w-md text-center p-6 border-red-200 bg-red-50">
          <CardHeader>
            <CardTitle className="text-xl text-red-600">L·ªói k·∫øt n·ªëi</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-red-600 mb-4">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë·ªÅ c∆∞∆°ng. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
            <Link href="/dashboard" className="text-primary hover:underline">Quay v·ªÅ Dashboard</Link>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!syllabus) return null;

  return <SyllabusEditForm initial={syllabus} />;
}
</file>

<file path="apps/web/app/(main)/syllabus/[id]/page.tsx">
// import Link from "next/link";
// import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
// import SyllabusDetailView from "@/components/SyllabusDetailView"; // Import component v·ª´a t·∫°o

// interface Syllabus {
//   id: number;
//   subject_name: string;
//   subject_code: string;
//   credits: number;
//   description?: string;
//   clos?: Array<{ code: string; description: string }>;
// }

// export default async function Page(props: { params: Promise<{ id: string }> }) {
//   const { id } = await props.params;

//   if (!id) return renderNotFound();

//   try {
//     // Server-side example using environment variable:
//     // const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

//     if (res.status === 404) return renderNotFound();
    
//     if (!res.ok) {
//       console.error("Failed to fetch syllabus", res.status);
//       return renderError();
//     }

//     const syllabus: Syllabus = await res.json();

//     // Render component giao di·ªán (Client Component)
//     return <SyllabusDetailView syllabus={syllabus} />;

//   } catch (err) {
//     console.error("Error fetching syllabus:", err);
//     return renderError();
//   }
// }

// // --- C√°c h√†m render l·ªói gi·ªØ nguy√™n ---

// function renderNotFound() {
//   return (
//     <div className="flex items-center justify-center p-12">
//       <Card className="w-full max-w-md text-center">
//         <CardHeader>
//           <CardTitle className="text-xl">Syllabus not found</CardTitle>
//         </CardHeader>
//         <CardContent>
//           <p className="text-sm text-muted-foreground mb-4">The requested syllabus does not exist or has been removed.</p>
//           <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
//         </CardContent>
//       </Card>
//     </div>
//   );
// }

// function renderError() {
//   return (
//     <div className="flex items-center justify-center p-12">
//       <Card className="w-full max-w-md text-center border-destructive/50">
//         <CardHeader>
//           <CardTitle className="text-xl text-destructive">Unable to load</CardTitle>
//         </CardHeader>
//         <CardContent>
//           <p className="text-sm text-muted-foreground mb-4">There was an error loading the details. Please ensure the backend server is running.</p>
//           <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
//         </CardContent>
//       </Card>
//     </div>
//   );
// }

import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import SyllabusDetailView from "@/components/SyllabusDetailView";
// Import Type t·ª´ file types (n·∫øu anh ƒë√£ t·∫°o) ho·∫∑c ƒë·ªãnh nghƒ©a tr·ª±c ti·∫øp ·ªü ƒë√¢y ƒë·ªÉ nhanh g·ªçn
import { SyllabusData, defaultSyllabus } from "@/components/Types"; 

// N·∫øu anh ch∆∞a t·∫°o file types.ts, h√£y uncomment ƒëo·∫°n d∆∞·ªõi ƒë√¢y ƒë·ªÉ d√πng t·∫°m:
/*
interface SyllabusData {
  id?: number;
  subject_name_vi: string;
  subject_name_en: string;
  subject_code: string;
  credits: number;
  time_allocation: { theory: number; exercises: number; practice: number; self_study: number; };
  prerequisites: string; pre_courses: string; co_courses: string;
  course_type: string; component_type: string;
  description: string;
  objectives: string[];
  clos: { code: string; description: string }[];
  plo_mapping: { clo_code: string; plos: { [key: string]: string } }[];
  student_duties: string;
  assessment_scheme: { component: string; method: string; clos: string; criteria: string; weight: number; }[];
  teaching_plan: { week: string; content: string; clos: string; activity: string; assessment: string; }[];
  materials: { type: "Main" | "Ref"; content: string; }[];
  date_prepared: string; date_edited: string; lecturer: string; head_department: string; dean: string;
}
*/

export default async function Page(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  if (!id) return renderNotFound();

  try {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

    if (res.status === 404) return renderNotFound();
    
    if (!res.ok) {
      console.error("Failed to fetch syllabus", res.status);
      return renderError();
    }

    const rawData = await res.json();

    // MERGE d·ªØ li·ªáu t·ª´ API v·ªõi d·ªØ li·ªáu m·∫∑c ƒë·ªãnh ƒë·ªÉ tr√°nh l·ªói "undefined" khi render
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: rawData.objectives || [],
        clos: rawData.clos || [],
        ploMapping: Array.isArray(rawData.clos) 
            ? rawData.clos.map((clo: any) => {
                const plos: { [key: string]: string } = {};
                const mappings = clo.plo_mappings || clo.ploMappings;
                if (Array.isArray(mappings)) {
                    mappings.forEach((m: any) => {
                        const code = m.program_plo_code || m.programPloCode;
                        if (code) plos[code] = m.level;
                    });
                }
                return { cloCode: clo.code, plos };
            })
            : [],
        assessmentScheme: rawData.assessmentScheme || [],
        teachingPlan: rawData.teachingPlan || [],
        materials: rawData.materials || [],
        timeAllocation: rawData.timeAllocation || { theory: 0, exercises: 0, practice: 0, selfStudy: 0 }
    };

    return <SyllabusDetailView syllabus={syllabus} />;

  } catch (err) {
    console.error("Error fetching syllabus:", err);
    return renderError();
  }
}

function renderNotFound() {
  return (
    <div className="flex items-center justify-center p-12">
      <Card className="w-full max-w-md text-center">
        <CardHeader>
          <CardTitle className="text-xl">Syllabus not found</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground mb-4">The requested syllabus does not exist or has been removed.</p>
          <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
        </CardContent>
      </Card>
    </div>
  );
}

function renderError() {
  return (
    <div className="flex items-center justify-center p-12">
      <Card className="w-full max-w-md text-center border-destructive/50">
        <CardHeader>
          <CardTitle className="text-xl text-destructive">Unable to load</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground mb-4">There was an error loading the details. Please ensure the backend server is running.</p>
          <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/syllabus/compare/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { useSearchParams, useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { ArrowLeft, Sparkles, Scale, Info, CheckCircle2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface DiffItem {
  field: string;
  old_value: string;
  new_value: string;
  type: string;
}

interface AiReport {
    summary?: string;
    impact_assessment?: string;
    is_significant_change?: boolean;
    detailed_analysis?: { category: string; description: string; change_type: string }[];
    error?: string;
}

export default function ComparePage() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const baseId = searchParams.get("baseId");
  const targetId = searchParams.get("targetId");

  const [data, setData] = useState<{ 
    base_version: string; 
    target_version: string; 
    diffs: DiffItem[];
    ai_report?: AiReport;
  } | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchDiff = async () => {
      if (!baseId || !targetId) return;

      try {
        const query = new URLSearchParams({ base_id: baseId, target_id: targetId }).toString();
        const res = await axios.get(`/syllabus/compare?${query}`);
        const data = res.data;
        setData(data);
      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    };
    fetchDiff();
  }, [baseId, targetId]);

  if (!baseId || !targetId) return <div className="p-8 text-center">Missing IDs to compare</div>;
  if (loading) return <div className="p-8 text-center">Analyzing changes...</div>;

  return (
    <div className="max-w-5xl mx-auto space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" onClick={() => router.back()}><ArrowLeft className="w-4 h-4 mr-2"/> Back</Button>
        <h1 className="text-2xl font-bold">So s√°nh Phi√™n b·∫£n</h1>
      </div>

      <div className="grid grid-cols-2 gap-4">
         <Card className="bg-slate-50 border-slate-200 shadow-sm">
            <CardHeader className="py-3 px-4 bg-slate-100/50 border-b">
                <CardTitle className="text-sm font-bold text-slate-500 uppercase tracking-wider">Phi√™n b·∫£n g·ªëc (v{data?.base_version})</CardTitle>
            </CardHeader>
         </Card>
         <Card className="bg-teal-50 border-teal-200 shadow-sm">
            <CardHeader className="py-3 px-4 bg-teal-100/50 border-b">
                <CardTitle className="text-sm font-bold text-teal-600 uppercase tracking-wider">Phi√™n b·∫£n m·ªõi (v{data?.target_version})</CardTitle>
            </CardHeader>
         </Card>
      </div>

      {/* AI CHANGE DETECTION REPORT */}
      {data?.ai_report && !data.ai_report.error && (
          <Card className="border-teal-200 bg-gradient-to-br from-teal-50 to-white overflow-hidden shadow-md">
              <CardHeader className="bg-teal-600 text-white py-3 flex flex-row items-center gap-2">
                  <Sparkles className="w-5 h-5" />
                  <CardTitle className="text-lg">AI Change Detection & Impact Analysis</CardTitle>
                  {data.ai_report.is_significant_change && (
                      <Badge className="ml-auto bg-amber-400 text-amber-900 border-none">Thay ƒë·ªïi ƒë√°ng k·ªÉ</Badge>
                  )}
              </CardHeader>
              <CardContent className="p-6 space-y-6">
                  {data.ai_report.summary && (
                      <div className="bg-white p-4 rounded-lg border border-teal-100 shadow-sm">
                          <h3 className="font-bold text-teal-800 flex items-center gap-2 mb-2">
                              <Info className="w-4 h-4" /> T√≥m t·∫Øt thay ƒë·ªïi
                          </h3>
                          <p className="text-slate-700 leading-relaxed">{data.ai_report.summary}</p>
                      </div>
                  )}

                  <div className="grid md:grid-cols-2 gap-6">
                      <div className="space-y-4">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2">
                            <Scale className="w-4 h-4 text-teal-600" /> Ph√¢n t√≠ch chi ti·∫øt
                        </h3>
                        <div className="space-y-3">
                            {data.ai_report.detailed_analysis?.map((item, idx) => (
                                <div key={idx} className="p-3 bg-white rounded-md border border-slate-100 shadow-sm text-sm">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="font-bold text-slate-700">{item.category}</span>
                                        <Badge variant="outline" className="text-[10px] py-0">{item.change_type}</Badge>
                                    </div>
                                    <p className="text-slate-500 text-xs">{item.description}</p>
                                </div>
                            ))}
                        </div>
                      </div>

                      <div className="bg-amber-50/50 p-4 rounded-lg border border-amber-100 self-start">
                          <h3 className="font-bold text-amber-800 flex items-center gap-2 mb-2">
                              <CheckCircle2 className="w-4 h-4" /> ƒê√°nh gi√° t√°c ƒë·ªông
                          </h3>
                          <p className="text-amber-900/80 text-sm whitespace-pre-line leading-relaxed italic">
                              "{data.ai_report.impact_assessment}"
                          </p>
                      </div>
                  </div>
              </CardContent>
          </Card>
      )}

      {data?.ai_report?.error && (
          <div className="p-4 bg-red-50 text-red-600 rounded-lg border border-red-100 text-sm italic">
            ‚ö†Ô∏è AI Analysis: {data.ai_report.error}
          </div>
      )}

      <div className="space-y-4 pt-4 border-t">
        <h2 className="text-xl font-bold text-slate-700">D·ªØ li·ªáu th√¥ (Field Comparison)</h2>
        {data?.diffs.length === 0 ? (
            <Card className="p-8 text-center text-green-600 font-bold border-green-200 bg-green-50">
                ‚úÖ Kh√¥ng c√≥ s·ª± thay ƒë·ªïi n√†o gi·ªØa 2 phi√™n b·∫£n n√†y.
            </Card>
        ) : (
            data?.diffs.map((diff, idx) => (
                <Card key={idx} className="overflow-hidden">
                    <div className="bg-gray-100 px-4 py-2 font-mono text-sm font-bold border-b uppercase text-gray-600">
                        Field: {diff.field}
                    </div>
                    <div className="grid grid-cols-2">
                        <div className="p-4 bg-red-50 text-red-700 border-r break-words">
                            <div className="text-xs font-bold text-red-400 mb-1">OLD</div>
                            {diff.old_value}
                        </div>
                        <div className="p-4 bg-green-50 text-green-700 break-words">
                            <div className="text-xs font-bold text-green-400 mb-1">NEW</div>
                            {diff.new_value}
                        </div>
                    </div>
                </Card>
            ))
        )}
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/(main)/syllabus/create/page.tsx">
"use client";

import React from "react";
import SyllabusEditForm from "@/components/SyllabusEditForm";
import { defaultSyllabus } from "@/components/Types";

export default function CreateSyllabusPage() {
  return <SyllabusEditForm initial={defaultSyllabus} />;
}
</file>

<file path="apps/web/app/(public)/layout.tsx">
"use client";

import React from "react";
import { useRouter } from "next/navigation";
import { BookOpen, LogOut } from "lucide-react";
import { Button } from "@/components/ui/button";
import { AuthProvider, useAuth } from "@/contexts/AuthContext";

function PublicLayoutContent({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  const { logout, role } = useAuth();

  const handleLogout = () => {
      logout();
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col">
      <header className="bg-white border-b sticky top-0 z-10 shadow-sm">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="bg-teal-600 p-2 rounded-lg">
                <BookOpen className="w-6 h-6 text-white" />
            </div>
            <span className="font-bold text-xl text-teal-900">SMD Portal</span>
          </div>
          <div className="flex gap-4 items-center">
             {role ? (
               <Button variant="ghost" onClick={handleLogout} className="text-red-600 hover:text-red-700 hover:bg-red-50 text-sm">
                  <LogOut className="w-4 h-4 mr-2" /> ƒêƒÉng xu·∫•t
               </Button>
             ) : (
               <Button onClick={() => router.push("/login")} className="bg-teal-600 hover:bg-teal-700 text-white text-sm">
                  ƒêƒÉng nh·∫≠p
               </Button>
             )}
          </div>
        </div>
      </header>

      <main className="flex-1 w-full max-w-6xl mx-auto p-4 md:py-8">
        {children}
      </main>

      <footer className="bg-white border-t py-6 text-center text-sm text-gray-500">
        ¬© 2025 University Syllabus Management System. All rights reserved.
      </footer>
    </div>
  );
}

export default function PublicLayout({ children }: { children: React.ReactNode }) {
  return (
    <AuthProvider>
      <PublicLayoutContent>{children}</PublicLayoutContent>
    </AuthProvider>
  );
}
</file>

<file path="apps/web/app/(public)/portal/[id]/page.tsx">
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import SyllabusDetailView from "@/components/SyllabusDetailView";
import StudentActionButtons from "@/components/StudentActionButtons";
import { SyllabusData, defaultSyllabus } from "@/components/Types";

export default async function StudentViewPage(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  try {
    // G·ªçi API l·∫•y chi ti·∫øt ƒë·ªÅ c∆∞∆°ng (S·ª¨A: s·ª≠ d·ª•ng endpoint public ƒë·ªÉ l·ªçc tr·∫°ng th√°i Approved/Published)
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/public/syllabus/${id}`, { cache: "no-store" });

    if (!res.ok) {
        return (
            <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
                <div className="text-xl font-bold text-gray-500">Kh√¥ng t√¨m th·∫•y ƒë·ªÅ c∆∞∆°ng n√†y.</div>
                <Link href="/portal"><Button>Quay l·∫°i trang ch·ªß</Button></Link>
            </div>
        );
    }

    const rawData = await res.json();
    
    // Merge d·ªØ li·ªáu an to√†n (convert backend camelCase to frontend camelCase model)
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: rawData.objectives || [],
        clos: rawData.clos || [],
        ploMapping: rawData.ploMapping || [],
        assessmentScheme: rawData.assessmentScheme || [],
        teachingPlan: rawData.teachingPlan || [],
        materials: rawData.materials || [],
        timeAllocation: rawData.timeAllocation || { theory: 0, exercises: 0, practice: 0, selfStudy: 0 }
    };

    return (
        <div className="container mx-auto pb-10 max-w-6xl px-4">
            {/* N√∫t quay l·∫°i & Actions */}
            <div className="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 py-4 border-b">
                <Link href="/portal">
                    <Button variant="ghost" className="gap-2 hover:bg-slate-100 text-slate-600">
                        <ArrowLeft className="w-4 h-4" /> Quay l·∫°i t√¨m ki·∫øm
                    </Button>
                </Link>

                <div className="w-full md:w-auto min-w-[320px]">
                    <StudentActionButtons 
                        syllabusId={syllabus.id!} 
                        subjectId={syllabus.subjectId!} 
                        subjectCode={syllabus.subjectCode} 
                    />
                </div>
            </div>

            {/* Hi·ªÉn th·ªã n·ªôi dung ƒë·ªÅ c∆∞∆°ng */}
            <div className="bg-white shadow-xl rounded-xl border-t-4 border-teal-600 overflow-hidden">
                <SyllabusDetailView syllabus={syllabus} hideManagementButtons={true} />
            </div>
        </div>
    );

  } catch (err) {
    return <div className="p-12 text-center text-red-500">L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i sau.</div>;
  }
}
</file>

<file path="apps/web/app/(public)/portal/page.tsx">
"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Search, BookOpen, User, Clock, GraduationCap, Loader2 } from "lucide-react";

interface SyllabusPublic {
  id: number;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  lecturer: string;
  version: string;
  description: string;
  dateEdited: string;
}

interface Program {
  id: number;
  name: string;
  code: string;
}

interface AcademicYear {
  id: number;
  code: string;
}

export default function StudentHomePage() {
  const [searchTerm, setSearchTerm] = useState("");
  const [results, setResults] = useState<SyllabusPublic[]>([]);
  const [loading, setLoading] = useState(false);
  const [debouncedTerm, setDebouncedTerm] = useState(searchTerm);

  // States for filters
  const [programs, setPrograms] = useState<Program[]>([]);
  const [academicYears, setAcademicYears] = useState<AcademicYear[]>([]);
  const [selectedProgram, setSelectedProgram] = useState<string>("");
  const [selectedYear, setSelectedYear] = useState<string>("");

  useEffect(() => {
    // Fetch filter data
    const fetchFilters = async () => {
        try {
            const [pRes, aRes] = await Promise.all([
                fetch(`${process.env.NEXT_PUBLIC_API_URL}/programs`),
                fetch(`${process.env.NEXT_PUBLIC_API_URL}/academic-years`)
            ]);
            if (pRes.ok) setPrograms(await pRes.json());
            if (aRes.ok) setAcademicYears(await aRes.json());
        } catch (e) {
            console.error("Error fetching filters:", e);
        }
    };
    fetchFilters();
  }, []);

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedTerm(searchTerm), 500);
    return () => clearTimeout(timer);
  }, [searchTerm]);

  useEffect(() => {
    const fetchData = async () => {
        setLoading(true);
        try {
            let url = `${process.env.NEXT_PUBLIC_API_URL}/public/syllabus?search=${encodeURIComponent(debouncedTerm)}`;
            if (selectedProgram) url += `&program_id=${selectedProgram}`;
            if (selectedYear) url += `&academic_year_id=${selectedYear}`;

            const res = await fetch(url);
            const data = await res.json();
            setResults(data.data || []);
        } catch(e) { console.error(e); } 
        finally { setLoading(false); }
    };
    fetchData();
  }, [debouncedTerm, selectedProgram, selectedYear]);

  return (
    <div className="space-y-12 pb-20">
      {/* ƒê·ªîI GRADIENT BACKGROUND */}
      <div className="text-center space-y-6 py-16 bg-gradient-to-b from-teal-50 to-white rounded-3xl border border-teal-100 px-4">
        <div className="inline-flex items-center px-3 py-1 rounded-full bg-teal-100 text-teal-700 text-xs font-bold mb-2">
            <GraduationCap className="w-4 h-4 mr-2"/> C·ªïng th√¥ng tin ƒê√†o t·∫°o
        </div>
        <h1 className="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight">Tra c·ª©u ƒê·ªÅ c∆∞∆°ng H·ªçc ph·∫ßn</h1>
        <p className="text-lg text-slate-600 max-w-2xl mx-auto">H·ªá th·ªëng d·ªØ li·ªáu s·ªë h√≥a ch√≠nh th·ª©c. T√¨m ki·∫øm th√¥ng tin chi ti·∫øt, chu·∫©n ƒë·∫ßu ra v√† t√†i li·ªáu h·ªçc t·∫≠p m·ªõi nh·∫•t.</p>
        
        <div className="max-w-xl mx-auto relative mt-8">
            <Search className="absolute left-4 top-3.5 h-5 w-5 text-teal-500" />
            <Input 
                className="pl-12 h-12 text-lg shadow-xl border-teal-100 focus-visible:ring-teal-500 rounded-full transition-all" 
                placeholder="Nh·∫≠p m√£ m√¥n (VD: IT001) ho·∫∑c t√™n m√¥n h·ªçc..." 
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
            />
            {loading && <div className="absolute right-4 top-4"><Loader2 className="w-4 h-4 animate-spin text-gray-400"/></div>}
        </div>

        <div className="max-w-2xl mx-auto mt-6 flex flex-wrap justify-center gap-4">
            <div className="flex items-center gap-2">
                <span className="text-sm font-medium text-slate-600">Ng√†nh:</span>
                <select 
                    className="h-9 rounded-md border border-teal-100 bg-white px-3 py-1 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                    value={selectedProgram}
                    onChange={(e) => setSelectedProgram(e.target.value)}
                >
                    <option value="">T·∫•t c·∫£ ng√†nh</option>
                    {programs.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                </select>
            </div>
            <div className="flex items-center gap-2">
                <span className="text-sm font-medium text-slate-600">NƒÉm h·ªçc:</span>
                <select 
                    className="h-9 rounded-md border border-teal-100 bg-white px-3 py-1 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                    value={selectedYear}
                    onChange={(e) => setSelectedYear(e.target.value)}
                >
                    <option value="">T·∫•t c·∫£ nƒÉm</option>
                    {academicYears.map(y => <option key={y.id} value={y.id}>{y.code}</option>)}
                </select>
            </div>
            {(selectedProgram || selectedYear || searchTerm) && (
                <Button 
                    variant="ghost" 
                    size="sm" 
                    className="text-teal-600 hover:text-teal-700 hover:bg-teal-50"
                    onClick={() => {
                        setSearchTerm("");
                        setSelectedProgram("");
                        setSelectedYear("");
                    }}
                >
                    X√≥a l·ªçc
                </Button>
            )}
        </div>
      </div>

      <div className="max-w-6xl mx-auto">
        <div className="flex items-center justify-between mb-6 px-2">
            <h2 className="text-xl font-bold text-slate-800">{searchTerm ? `K·∫øt qu·∫£ t√¨m ki·∫øm cho "${searchTerm}"` : "ƒê·ªÅ c∆∞∆°ng m·ªõi c·∫≠p nh·∫≠t"}</h2>
            <span className="text-sm text-slate-500">{results.length} k·∫øt qu·∫£</span>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {loading && results.length === 0 ? ([1,2,3].map(i => <div key={i} className="h-64 bg-gray-100 rounded-xl animate-pulse"></div>)) : results.length === 0 ? (
                <div className="col-span-full text-center py-16 text-gray-400 italic bg-slate-50 rounded-xl border border-dashed">Kh√¥ng t√¨m th·∫•y ƒë·ªÅ c∆∞∆°ng n√†o ph√π h·ª£p.</div>
            ) : (
                results.map((item) => (
                    /* ƒê·ªîI BORDER TOP CARD */
                    <Card key={item.id} className="group hover:shadow-lg transition-all duration-300 border-t-4 border-t-teal-500 flex flex-col h-full">
                        <CardHeader className="pb-3">
                            <div className="flex justify-between items-start mb-2">
                                <Badge variant="secondary" className="bg-teal-50 text-teal-700 hover:bg-teal-100 border-teal-200 font-mono">{item.subjectCode}</Badge>
                                <span className="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-0.5 rounded-full border border-green-200">v{item.version}</span>
                            </div>
                            <CardTitle className="text-lg leading-snug group-hover:text-teal-700 transition-colors min-h-[3.5rem] line-clamp-2">{item.subjectNameVi}</CardTitle>
                            <p className="text-xs text-muted-foreground line-clamp-1 italic">{item.subjectNameEn}</p>
                        </CardHeader>
                        <CardContent className="flex-1 pb-4">
                            <p className="text-sm text-gray-600 line-clamp-3 mb-4 h-[4.5em]">{item.description || "Ch∆∞a c√≥ m√¥ t·∫£ t√≥m t·∫Øt cho h·ªçc ph·∫ßn n√†y."}</p>
                            <div className="space-y-2 pt-4 border-t border-dashed">
                                <div className="flex items-center gap-2 text-xs text-gray-500"><BookOpen className="w-3.5 h-3.5 text-teal-500" /> <span className="font-medium">{item.credits} t√≠n ch·ªâ</span></div>
                                <div className="flex items-center gap-2 text-xs text-gray-500"><User className="w-3.5 h-3.5 text-purple-500" /> <span>GV: {item.lecturer}</span></div>
                                <div className="flex items-center gap-2 text-xs text-gray-500"><Clock className="w-3.5 h-3.5 text-orange-500" /> <span>C·∫≠p nh·∫≠t: {item.dateEdited}</span></div>
                            </div>
                        </CardContent>
                        <CardFooter className="pt-0 pb-6 px-6">
                            <Link href={`/portal/${item.id}`} className="w-full">
                                {/* ƒê·ªîI N√öT ACTION */}
                                <Button className="w-full bg-teal-700 hover:bg-teal-800 text-white transition-colors shadow-lg shadow-teal-100">Xem chi ti·∫øt</Button>
                            </Link>
                        </CardFooter>
                    </Card>
                ))
            )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="apps/web/app/layout.tsx">
// apps/web/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "SMD System",
  description: "Syllabus Management System",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
        {children}
      </body>
    </html>
  );
}
</file>

<file path="apps/web/components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="apps/web/components/DashboardCharts.tsx">
"use client";

import React from "react";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend, BarChart, Bar, XAxis, YAxis, CartesianGrid } from "recharts";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { FileText, Users, CheckCircle, Clock } from "lucide-react";

interface StatsData {
  totalSyllabus: number;
  totalUsers: number;
  statusBreakdown: { name: string; value: number; fill: string }[];
}

export default function DashboardCharts({ data }: { data: StatsData | null }) {
  if (!data) return <div className="h-48 flex items-center justify-center text-gray-400">ƒêang t·∫£i th·ªëng k√™...</div>;

  const breakdown = data.statusBreakdown || [];
  const approvedCount = breakdown.find(i => i.name === "ƒê√£ xu·∫•t b·∫£n")?.value || 0;
  const pendingCount = breakdown.find(i => i.name === "Ch·ªù duy·ªát")?.value || 0;

  return (
    <div className="space-y-6 mb-8 animate-in fade-in-50 slide-in-from-top-5 duration-500">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {/* S·ª¨A: Card n√†y ƒë·ªïi t·ª´ Blue -> Teal */}
        <Card className="bg-teal-50 border-teal-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-teal-100 rounded-full text-teal-600"><FileText className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">T·ªïng ƒë·ªÅ c∆∞∆°ng</p>
                    <h3 className="text-2xl font-bold text-teal-700">{data.totalSyllabus}</h3>
                </div>
            </CardContent>
        </Card>

        {/* C√°c Card kh√°c gi·ªØ nguy√™n m√†u ƒë·ªÉ ph√¢n bi·ªát tr·∫°ng th√°i (Xanh l√°, V√†ng, T√≠m) */}
        <Card className="bg-green-50 border-green-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-green-100 rounded-full text-green-600"><CheckCircle className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">ƒê√£ c√¥ng b·ªë</p>
                    <h3 className="text-2xl font-bold text-green-700">{approvedCount}</h3>
                </div>
            </CardContent>
        </Card>

        <Card className="bg-yellow-50 border-yellow-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-yellow-100 rounded-full text-yellow-600"><Clock className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">ƒêang ch·ªù duy·ªát</p>
                    <h3 className="text-2xl font-bold text-yellow-700">{pendingCount}</h3>
                </div>
            </CardContent>
        </Card>

        <Card className="bg-purple-50 border-purple-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-purple-100 rounded-full text-purple-600"><Users className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">Ng∆∞·ªùi d√πng</p>
                    <h3 className="text-2xl font-bold text-purple-700">{data.totalUsers}</h3>
                </div>
            </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Card className="shadow-sm">
            <CardHeader><CardTitle className="text-lg">T·ª∑ l·ªá tr·∫°ng th√°i ƒë·ªÅ c∆∞∆°ng</CardTitle></CardHeader>
            <CardContent className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                        <Pie
                            data={breakdown}
                            cx="50%" cy="50%"
                            innerRadius={60} outerRadius={100}
                            paddingAngle={5}
                            dataKey="value"
                        >
                            {breakdown.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.fill} stroke="none"/>
                            ))}
                        </Pie>
                        <Tooltip />
                        <Legend verticalAlign="bottom" height={36}/>
                    </PieChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>

        <Card className="shadow-sm">
            <CardHeader><CardTitle className="text-lg">Th·ªëng k√™ s·ªë l∆∞·ª£ng</CardTitle></CardHeader>
            <CardContent className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={breakdown} margin={{top: 20, right: 30, left: 0, bottom: 5}}>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                        <XAxis dataKey="name" tick={{fontSize: 12}} />
                        <YAxis allowDecimals={false} />
                        <Tooltip cursor={{fill: 'transparent'}} />
                        <Bar dataKey="value" radius={[4, 4, 0, 0]}>
                            {breakdown.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.fill} />
                            ))}
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/components/Header.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/contexts/AuthContext";
import { useNotifications } from "@/contexts/NotificationContext";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { LogOut, Bell } from "lucide-react";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import axios, { API_BASE } from "@/lib/axios";

export default function Header() {
  const router = useRouter();
  const { setRole: setAuthRole, setUserId, logout } = useAuth();
  const { notifications, unreadCount, markAsRead } = useNotifications();
  const [user, setUser] = useState<{ fullName: string; roles?: { id: number; name: string }[]; avatarFileId?: number } | null>(null);
  const [academicYear, setAcademicYear] = useState("Loading...");
  
  // H√†m fetch user & info
  useEffect(() => {
    const fetchData = async () => {
      const token = localStorage.getItem("access_token");
      if (!token) { router.push("/login"); return; }

      try {
        // L·∫•y User Info
        const userRes = await axios.get("/users/me");
        const userData = userRes.data;
        setUser(userData);

        if (userData?.id) {
          setUserId(userData.id.toString());
        }

        // Store role in context
        if (userData?.role) {
          setAuthRole(userData.role);
        } else if (userData?.roles && userData.roles.length > 0) {
          // Fallback if role string is missing but roles array exists
          const roleName = userData.roles[0].role?.name || userData.roles[0].name;
          if (roleName) setAuthRole(roleName);
        }

        // L·∫•y NƒÉm h·ªçc
        try {
          const yearRes = await axios.get("/academic-years/");
          const years = Array.isArray(yearRes.data) ? yearRes.data : [];
          const activeYear = years.find((y: any) => y.is_active || y.isActive);
          setAcademicYear(activeYear?.code || "Ch∆∞a c·∫•u h√¨nh");
        } catch (e) { /* ignore */ }
      } catch (err: any) {
        console.error("Header fetchData error:", err);
      }
    };
    fetchData();
  }, [router]);

  const handleRead = async (notif: any) => {
      if(!notif.is_read) {
          await markAsRead(notif.id);
      }
      if(notif.link) router.push(notif.link);
  };

  const handleLogout = () => {
    logout();
  };

  return (
    <header className="flex items-center justify-between gap-4 py-4 px-6 border-b border-border bg-background sticky top-0 z-10 shadow-sm">
      <div className="flex items-center gap-3">
        <div className="text-sm font-medium text-teal-800 bg-teal-50 px-3 py-1 rounded-full border border-teal-100">
            üìÖ {academicYear}
        </div>
      </div>

      <div className="flex items-center gap-4">
        {user ? (
            <>
                {/* --- CHU√îNG TH√îNG B√ÅO --- */}
                <Popover>
                    <PopoverTrigger asChild>
                        <Button variant="ghost" size="icon" className="relative">
                            <Bell className="w-5 h-5 text-gray-600" />
                            {unreadCount > 0 && (
                                <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                            )}
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent className="w-80 p-0" align="end">
                        <div className="p-3 border-b font-semibold text-sm bg-slate-50 rounded-t-md flex justify-between">
                            <span>Th√¥ng b√°o</span>
                            <span className="text-xs text-gray-500 font-normal">{unreadCount} ch∆∞a ƒë·ªçc</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto">
                            {notifications.length === 0 ? (
                                <div className="p-8 text-center text-xs text-gray-400">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
                            ) : (
                                notifications.map((n: any) => (
                                    <div 
                                        key={n.id} 
                                        onClick={() => handleRead(n)}
                                        className={`p-3 border-b cursor-pointer hover:bg-slate-50 transition-colors ${!n.is_read ? 'bg-blue-50/60' : ''}`}
                                    >
                                        <div className="text-sm font-semibold text-slate-800 mb-0.5">{n.title}</div>
                                        <div className="text-xs text-slate-600 line-clamp-2">{n.message}</div>
                                        <div className="text-[10px] text-slate-400 mt-2 text-right">
                                            {new Date(n.created_at).toLocaleString('vi-VN')}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </PopoverContent>
                </Popover>

                {/* --- USER INFO --- */}
                <div className="text-right hidden md:block">
                    <div className="text-sm font-bold">{user.fullName}</div>
                    <div className="text-xs text-muted-foreground">
                      {user.roles && user.roles.length > 0 
                        ? user.roles.map(r => r.name).join(", ") 
                        : "Ch∆∞a c√≥ vai tr√≤"}
                    </div>
                </div>
                <Avatar>
                    {user.avatarFileId ? (
                        <AvatarImage src={`${API_BASE}/files/${user.avatarFileId}`} />
                    ) : null}
                    <AvatarFallback className={user.roles?.[0]?.name === "Lecturer" ? "bg-teal-100 text-teal-600" : "bg-purple-100 text-purple-600"}>
                        {user.fullName?.substring(0, 2).toUpperCase() || (user.roles?.[0]?.name === "Lecturer" ? "GV" : "NV")}
                    </AvatarFallback>
                </Avatar>
                <Button variant="ghost" size="icon" onClick={handleLogout} title="Logout">
                    <LogOut className="w-5 h-5 text-gray-500" />
                </Button>
            </>
        ) : (
            <div className="text-sm text-muted-foreground">Loading...</div>
        )}
      </div>
    </header>
  );
}
</file>

<file path="apps/web/components/Sidebar.tsx">
"use client";

import React from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { useAuth } from "@/contexts/AuthContext";
import { 
    LayoutDashboard, 
    FilePlus2, 
    FileCheck, 
    UserCircle, 
    BookOpen,
    Menu,
    UserCog,
    FileClock,
    Settings,
    GraduationCap,
    Building,
    Users,
    Bell,
    Search,
    MessageSquareWarning
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger, SheetTitle } from "@/components/ui/sheet";

export default function Sidebar() {
  const pathname = usePathname();
  const { role, isLoading } = useAuth();

  if (isLoading) {
    return null; // Ho·∫∑c skeleton loader
  }

  const menuItems = [
    { 
        name: "Dashboard", 
        href: "/dashboard", 
        icon: LayoutDashboard,
        roles: ["ALL"] 
    },
    { 
        name: "Bi√™n so·∫°n ƒë·ªÅ c∆∞∆°ng", 
        href: "/syllabus/create", 
        icon: FilePlus2,
        roles: ["Lecturer", "Admin"] 
    },
    { 
        name: "Y√™u c·∫ßu ph√™ duy·ªát", 
        href: "/reviews", 
        icon: FileCheck,
        roles: ["Head of Dept", "Academic Affairs", "Principal", "Admin", "HoD", "AA"] 
    },
    { 
        name: "Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh", 
        href: "/admin/programs", 
        icon: GraduationCap,
        roles: ["Academic Affairs", "Admin", "AA"] 
    },
    { 
        name: "Qu·∫£n l√Ω H·ªçc ph·∫ßn", 
        href: "/admin/subjects", 
        icon: BookOpen,
        roles: ["Academic Affairs", "Admin", "AA"] 
    },
    { 
        name: "Qu·∫£n l√Ω Khoa/BM", 
        href: "/admin/departments", 
        icon: Building,
        roles: ["Academic Affairs", "Admin", "AA"] 
    },
    { 
        name: "Ph·∫£n h·ªìi/B√°o l·ªói", 
        href: "/admin/reports", 
        icon: MessageSquareWarning,
        roles: ["Admin", "Head of Dept", "HoD", "Academic Affairs", "AA"] 
    },
    { 
        name: "S·ªë h√≥a & Search AI", 
        href: "/admin/search", 
        icon: Search,
        roles: ["Admin", "Academic Affairs", "AA"] 
    },
    { 
        name: "Qu·∫£n tr·ªã User", 
        href: "/admin/users", 
        icon: Users,
        roles: ["Admin"] 
    },
    { 
        name: "Nh·∫≠t k√Ω h·ªá th·ªëng", 
        href: "/admin/logs", 
        icon: FileClock,
        roles: ["Admin"] 
    },
    { 
        name: "T√¨m ki·∫øm ƒë·ªÅ c∆∞∆°ng", 
        href: "/portal", 
        icon: Search,
        roles: ["Student", "ALL"] 
    },
    { 
        name: "Theo d√µi c·ªßa t√¥i", 
        href: "/portal/subscriptions", 
        icon: Bell,
        roles: ["Student"] 
    },
    { 
        name: "H·ªì s∆° c√° nh√¢n", 
        href: "/profile", 
        icon: UserCircle,
        roles: ["ALL"] 
    },
  ];

  const filteredMenu = menuItems.filter(item => 
    item.roles.includes("ALL") || item.roles.includes(role || "")
  );

  const NavContent = () => (
    <div className="flex flex-col h-full">
        <div className="mb-8 px-2">
          {/* ƒê·ªîI M√ÄU LOGO */}
          <h1 className="text-xl font-extrabold text-teal-700 tracking-tight flex items-center gap-2">
            <BookOpen className="w-6 h-6"/> SMD System
          </h1>
          <p className="text-xs text-slate-500 mt-1 ml-8">Syllabus Management</p>
        </div>
        
        <nav className="flex-1 space-y-1">
          {filteredMenu.map((m, idx) => {
            const isActive = pathname === m.href;
            return (
                <Link
                  key={`${m.href}-${idx}`}
                  href={m.href}
                  className={`flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200
                    ${isActive 
                        /* ƒê·ªîI M√ÄU ACTIVE: Blue -> Teal */
                        ? "bg-teal-50 text-teal-800 shadow-sm border border-teal-100 font-bold" 
                        : "text-slate-600 hover:bg-teal-50 hover:text-teal-700"
                    }`}
                >
                  <m.icon className={`w-5 h-5 ${isActive ? "text-teal-700" : "text-slate-400"}`} />
                  <span>{m.name}</span>
                </Link>
            );
          })}
        </nav>

        <div className="mt-auto border-t pt-4">
             <div className="text-xs text-center text-slate-400">
                v1.2.0-config
             </div>
        </div>
    </div>
  );

  return (
    <>
      <aside className="hidden md:flex md:flex-col md:w-64 md:h-screen md:fixed md:inset-y-0 md:overflow-y-auto md:bg-white md:border-r md:border-slate-200 md:p-4 z-50">
        <NavContent />
      </aside>

      <div className="md:hidden">
        <Sheet>
          <SheetTrigger asChild>
            <Button variant="ghost" size="icon" className="fixed top-3 left-4 z-50 bg-white shadow-sm border">
              <Menu className="w-5 h-5 text-slate-700" />
            </Button>
          </SheetTrigger>
          <SheetContent side="left" className="w-72 p-4">
            <SheetTitle className="sr-only">Menu</SheetTitle>
            <NavContent />
          </SheetContent>
        </Sheet>
      </div>
    </>
  );
}
</file>

<file path="apps/web/components/syllabus-form/MaterialsTab.tsx">
// apps/web/components/syllabus-form/MaterialsTab.tsx
"use client";

import React from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { SyllabusData } from "../Types";

interface MaterialsTabProps {
  data: SyllabusData;
  readOnly: boolean;
  onUpdate: (index: number, val: string) => void;
  onAdd: (type: "Main" | "Ref") => void;
  onRemove: (index: number) => void;
}

export default function MaterialsTab({ data, readOnly, onUpdate, onAdd, onRemove }: MaterialsTabProps) {
  
  const renderSection = (type: "Main" | "Ref", label: string) => (
    <div className="bg-slate-50 p-4 rounded-md mb-4 border border-slate-200">
      <h3 className="font-bold mb-3 text-slate-700">{label}</h3>
      <div className="space-y-3">
        {data.materials.map((m, originalIndex) => ({ m, originalIndex }))
          .filter(item => item.m.type === type)
          .map(({ m, originalIndex }, i) => (
            <div key={originalIndex} className="flex gap-2 items-center">
              <span className="text-sm font-bold w-8 text-gray-500">[{i + 1}]</span>
              <Input 
                value={m.title} 
                onChange={(e) => onUpdate(originalIndex, e.target.value)} 
                placeholder="V√≠ d·ª•: T√™n t√°c gi·∫£, NƒÉm xu·∫•t b·∫£n, T√™n s√°ch, Nh√† xu·∫•t b·∫£n..." 
                disabled={readOnly}
                className="bg-white flex-1"
              />
              {!readOnly && (
                <Button variant="ghost" size="icon" onClick={() => onRemove(originalIndex)} className="text-red-500 hover:text-red-700 hover:bg-red-50">‚úï</Button>
              )}
            </div>
        ))}
        {/* Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu ch∆∞a c√≥ t√†i li·ªáu n√†o */}
        {data.materials.filter(m => m.type === type).length === 0 && (
            <div className="text-sm text-gray-400 italic pl-8">Ch∆∞a c√≥ t√†i li·ªáu n√†o.</div>
        )}
      </div>
      {!readOnly && (
        <Button variant="outline" size="sm" className="mt-3 ml-8 border-dashed bg-white" onClick={() => onAdd(type)}>
          + Th√™m t√†i li·ªáu
        </Button>
      )}
    </div>
  );

  return (
    <div className="animate-in fade-in-50 space-y-4">
      {renderSection("Main", "8.1. T√†i li·ªáu ch√≠nh")}
      {renderSection("Ref", "8.2. T√†i li·ªáu tham kh·∫£o")}
    </div>
  );
}
</file>

<file path="apps/web/components/SyllabusDeleteButton.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogAction,
  AlertDialogCancel,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import axios from "@/lib/axios";

export default function SyllabusDeleteButton({ id }: { id: number }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  async function handleDelete() {
    setLoading(true);
    try {
      await axios.delete(`/syllabuses/${id}`);
      alert("X√≥a th√†nh c√¥ng!");
      router.push("/");
    } catch (err: any) {
      console.error("Network error deleting syllabus:", err);
      const status = err?.response?.status || err?.status;
      const message = err?.response?.data?.detail || err?.message;
      if (status === 401) {
        alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.");
        router.push("/login");
        return;
      }
      alert(message || "Delete failed");
    } finally {
      setLoading(false);
    }
  }

  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button variant="destructive">Delete</Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Are you sure?</AlertDialogTitle>
          <AlertDialogDescription>
            This action cannot be undone. The syllabus will be permanently deleted.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>Cancel</AlertDialogCancel>
          <AlertDialogAction asChild>
            <Button variant="destructive" onClick={handleDelete} disabled={loading}>
              {loading ? "Deleting..." : "Confirm"}
            </Button>
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
</file>

<file path="apps/web/components/SyllabusDetailView.tsx">
"use client";

import { useRef, useState } from "react";
import Link from "next/link";
import { useReactToPrint } from "react-to-print";
import { Printer, ArrowLeft, Pencil, BrainCircuit, CheckCircle2, AlertCircle, History } from "lucide-react";
import { Button } from "@/components/ui/button";
import VisualSubjectTree from "./VisualSubjectTree";
import StudentActionButtons from "./StudentActionButtons";
import SyllabusHistory from "./SyllabusHistory";
import axios from "@/lib/axios";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";

// QUAN TR·ªåNG: Import ƒë√∫ng ƒë∆∞·ªùng d·∫´n
import { SyllabusData } from "./Types"; 

export default function SyllabusDetailView({ 
  syllabus, 
  hideManagementButtons = false 
}: { 
  syllabus: SyllabusData, 
  hideManagementButtons?: boolean 
}) {
  const contentRef = useRef<HTMLDivElement>(null);
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<any>(null);
  
  const handlePrint = useReactToPrint({
    contentRef: contentRef,
    documentTitle: `${syllabus.subjectCode}_Syllabus`,
  });

  const analyzeAlignment = async () => {
    setAnalyzing(true);
    try {
      const res = await axios.post("/ai/analyze-alignment", { syllabus_id: syllabus.id });
      setAnalysisResult(res.data);
    } catch (err) {
      console.error(err);
      alert("L·ªói khi ph√¢n t√≠ch: " + (err as any).message);
    } finally {
      setAnalyzing(false);
    }
  };

  const printStyle = `
    @page { size: A4; margin: 20mm 20mm 20mm 20mm; } 
    @media print { 
        body { -webkit-print-color-adjust: exact; } 
        .print-break-avoid { break-inside: avoid; }
    }
    .word-table { width: 100%; border-collapse: collapse; font-size: 11pt; }
    .word-table td, .word-table th { border: 1px solid black; padding: 4px; vertical-align: top; }
    .word-header { font-family: "Times New Roman", serif; text-align: center; }
  `;

  return (
    <div className="p-6 bg-gray-100 min-h-screen font-sans">
      <style>{printStyle}</style>
      
      <div className="max-w-[210mm] mx-auto mb-4 flex justify-between print:hidden">
         {!hideManagementButtons ? (
           <Link href="/"><Button variant="ghost"><ArrowLeft className="mr-2 h-4 w-4" /> Quay l·∫°i</Button></Link>
         ) : <div></div>}
         <div className="flex gap-2">
            {!hideManagementButtons && (
              <>
              <Link href={`/syllabus/${syllabus.id}/edit`}><Button variant="outline"><Pencil className="mr-2 h-4 w-4" /> Ch·ªânh s·ª≠a</Button></Link>
              
              <Dialog>
                <DialogTrigger asChild>
                  <Button variant="secondary" onClick={analyzeAlignment} disabled={analyzing}>
                    <BrainCircuit className="mr-2 h-4 w-4" /> 
                    {analyzing ? "ƒêang ph√¢n t√≠ch..." : "AI Alignment"}
                  </Button>
                </DialogTrigger>
                <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
                    <DialogHeader>
                      <DialogTitle className="flex items-center gap-2">
                        <BrainCircuit className="w-5 h-5 text-purple-600" />
                        Ph√¢n t√≠ch ma tr·∫≠n CLO-PLO (AI)
                      </DialogTitle>
                    </DialogHeader>
                    
                    {analysisResult ? (
                      <div className="space-y-4 py-4">
                        <div className="flex items-center justify-between bg-slate-50 p-4 rounded-lg border">
                          <div className="font-semibold">ƒêi·ªÉm ph√π h·ª£p t·ªïng qu√°t:</div>
                          <div className={`text-2xl font-bold ${analysisResult.overall_score > 70 ? 'text-green-600' : 'text-amber-500'}`}>
                            {analysisResult.overall_score}%
                          </div>
                        </div>

                        <div>
                          <h4 className="font-bold flex items-center gap-1 mb-2">
                             <CheckCircle2 className="w-4 h-4 text-green-500" /> ƒêi·ªÉm m·∫°nh
                          </h4>
                          <ul className="list-disc pl-5 text-sm space-y-1">
                            {analysisResult.strengths?.map((s: string, i: number) => <li key={i}>{s}</li>)}
                          </ul>
                        </div>

                        <div>
                          <h4 className="font-bold flex items-center gap-1 mb-2">
                             <AlertCircle className="w-4 h-4 text-amber-500" /> ƒêi·ªÉm c·∫ßn c·∫£i thi·ªán
                          </h4>
                          <ul className="list-disc pl-5 text-sm space-y-1">
                            {analysisResult.weaknesses?.map((w: string, i: number) => <li key={i}>{w}</li>)}
                          </ul>
                        </div>

                        <div className="bg-blue-50 p-4 rounded-lg text-sm italic border-l-4 border-blue-400">
                          {analysisResult.analysis}
                        </div>

                        <div className="space-y-2">
                          <h4 className="font-bold text-sm">G·ª£i √Ω t·ª´ chuy√™n gia AI:</h4>
                          {analysisResult.suggestions?.map((s: any, i: number) => (
                            <div key={i} className="p-3 bg-white border rounded text-xs">
                              {s.clo && <Badge variant="outline" className="mb-1">{s.clo}</Badge>}
                              {s.plo && <Badge variant="outline" className="mb-1 bg-purple-50">{s.plo}</Badge>}
                              <p className="text-gray-700">{s.suggestion || s.issue}</p>
                            </div>
                          ))}
                        </div>
                      </div>
                    ) : (
                      <div className="py-12 text-center animate-pulse">
                        ƒêang l·∫•y √Ω ki·∫øn t·ª´ chuy√™n gia AI...
                      </div>
                    )}
                </DialogContent>
              </Dialog>
              </>
            )}
            <Button onClick={() => handlePrint()}><Printer className="mr-2 h-4 w-4" /> Xu·∫•t PDF / In</Button>
            {syllabus.id && <SyllabusHistory syllabusId={syllabus.id} />}
         </div>
      </div>

      <div className="flex justify-center">
        <div ref={contentRef} className="bg-white w-[210mm] min-h-[297mm] px-[15mm] py-[15mm] shadow-lg print:shadow-none text-black leading-snug" style={{ fontFamily: '"Times New Roman", Times, serif', fontSize: '12pt' }}>
            
            <div className="text-center font-bold mb-4">
                <div className="uppercase text-[11pt]">TR∆Ø·ªúNG ƒêH GIAO TH√îNG V·∫¨N T·∫¢I TP. H·ªí CH√ç MINH</div>
                <div className="uppercase text-[14pt] mt-2">ƒê·ªÄ C∆Ø∆†NG CHI TI·∫æT H·ªåC PH·∫¶N</div>
                <div className="italic font-normal text-[12pt]">(COURSE SYLLABUS)</div>
            </div>

            {/* Workflow & Deadline Banner */}
            {syllabus.status !== 'Draft' && syllabus.status !== 'Approved' && syllabus.status !== 'Published' && (
              <div className="mb-6 p-4 rounded-lg border bg-slate-50 flex items-center justify-between print:hidden">
                <div className="flex items-center gap-4">
                  <div>
                    <div className="text-xs text-muted-foreground uppercase font-semibold">Tr·∫°ng th√°i</div>
                    <Badge variant={syllabus.status === 'Returned' ? 'destructive' : 'secondary'}>
                      {syllabus.status}
                    </Badge>
                  </div>
                  {syllabus.dueDate && (
                    <div>
                      <div className="text-xs text-muted-foreground uppercase font-semibold flex items-center gap-1">
                        <AlertCircle className="w-3 h-3" /> H·∫°n duy·ªát
                      </div>
                      <div className={`text-sm font-bold ${new Date(syllabus.dueDate) < new Date() ? 'text-red-600' : 'text-amber-600'}`}>
                        {new Date(syllabus.dueDate).toLocaleDateString('vi-VN')}
                      </div>
                    </div>
                  )}
                  {syllabus.assignedTo && (
                    <div>
                      <div className="text-xs text-muted-foreground uppercase font-semibold">ƒêang ch·ªù x·ª≠ l√Ω b·ªüi</div>
                      <div className="text-sm font-medium">{syllabus.assignedTo}</div>
                    </div>
                  )}
                </div>
                {new Date(syllabus.dueDate || '') < new Date() && (
                   <Badge variant="destructive" className="animate-pulse">QU√Å H·∫†N</Badge>
                )}
              </div>
            )}

            {/* 1. TH√îNG TIN CHUNG */}
            <div className="mb-4">
                <h3 className="font-bold mb-2">1. T·ªïng qu√°t v·ªÅ h·ªçc ph·∫ßn (General course information)</h3>
                <table className="word-table">
                    <tbody>
                        <tr>
                            <td className="w-[140px]">T√™n h·ªçc ph·∫ßn</td>
                            <td colSpan={5}>
                                <div>Ti·∫øng Vi·ªát: <b>{syllabus.subjectNameVi}</b></div>
                                <div>Ti·∫øng Anh: <b>{syllabus.subjectNameEn}</b></div>
                                <div>M√£ HP: <b>{syllabus.subjectCode}</b></div>
                            </td>
                        </tr>
                        <tr>
                            <td>S·ªë t√≠n ch·ªâ</td>
                            <td colSpan={5} className="font-bold">{syllabus.credits || 0} ({syllabus.credits || 0}, 0, {syllabus.credits || 0})</td>
                        </tr>
                        <tr className="text-center font-semibold">
                            <td>Ph√¢n b·ªï th·ªùi gian</td><td>L√Ω thuy·∫øt</td><td>B√†i t·∫≠p/D·ª± √°n</td><td>Th·ª±c h√†nh</td><td>T·ªïng</td><td>T·ª± h·ªçc</td>
                        </tr>
                        <tr className="text-center">
                            <td></td>
                            <td>{syllabus.timeAllocation?.theory || 0}</td>
                            <td>{syllabus.timeAllocation?.exercises || 0}</td>
                            <td>{syllabus.timeAllocation?.practice || 0}</td>
                            <td className="font-bold">{((syllabus.timeAllocation?.theory || 0) + (syllabus.timeAllocation?.exercises || 0) + (syllabus.timeAllocation?.practice || 0))}</td>
                            <td>{syllabus.timeAllocation?.selfStudy || 0}</td>
                        </tr>
                        <tr><td>Thang ƒëi·ªÉm</td><td colSpan={5}>10</td></tr>
                        <tr><td>HP ti√™n quy·∫øt</td><td colSpan={5}>{syllabus.prerequisites || 'N/A'}</td></tr>
                        <tr><td>HP h·ªçc tr∆∞·ªõc</td><td colSpan={5}>{syllabus.preCourses || 'N/A'}</td></tr>
                        <tr><td>HP song h√†nh</td><td colSpan={5}>{syllabus.coCourses || 'N/A'}</td></tr>
                        <tr>
                            <td>Lo·∫°i h·ªçc ph·∫ßn</td>
                            <td colSpan={5}>
                                <span className="mr-8">{syllabus.courseType === 'B·∫Øt bu·ªôc' ? '‚òí' : '‚òê'} B·∫Øt bu·ªôc</span>
                                <span className="mr-8">{syllabus.courseType === 'T·ª± ch·ªçn b·∫Øt bu·ªôc' ? '‚òí' : '‚òê'} T·ª± ch·ªçn b·∫Øt bu·ªôc</span>
                                <span>{syllabus.courseType === 'T·ª± ch·ªçn t·ª± do' ? '‚òí' : '‚òê'} T·ª± ch·ªçn t·ª± do</span>
                            </td>
                        </tr>
                        <tr><td>Thu·ªôc th√†nh ph·∫ßn</td><td colSpan={5}>{syllabus.componentType}</td></tr>
                    </tbody>
                </table>
            </div>

            <div className="grid grid-cols-2 gap-4 text-xs italic mb-6">
                <div>
                   <p><b>Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o:</b> {syllabus.programName || "Ch∆∞a x√°c ƒë·ªãnh"}</p>
                   <p><b>NƒÉm h·ªçc √°p d·ª•ng:</b> {syllabus.academicYearName || "Ch∆∞a x√°c ƒë·ªãnh"}</p>
                </div>
                <div>
                   <p><b>Gi·∫£ng vi√™n bi√™n so·∫°n:</b> {syllabus.lecturer || "Gi·∫£ng vi√™n"}</p>
                   <p><b>Phi√™n b·∫£n:</b> {syllabus.version || "1.0"}</p>
                </div>
            </div>

            {/* B·∫¢N ƒê·ªí M√îN H·ªåC (Visual Subject Tree) */}
            <div className="mb-4 space-y-4 print:hidden">
                {/* T√≠nh nƒÉng sinh vi√™n: T√≥m t·∫Øt AI, Theo d√µi, B√°o l·ªói */}
                <StudentActionButtons 
                    syllabusId={syllabus.id!} 
                    subjectId={syllabus.subjectId!} 
                    subjectCode={syllabus.subjectCode}
                />

                <VisualSubjectTree 
                    subjectId={syllabus.subjectId!} 
                    currentSubjectName={syllabus.subjectNameVi} 
                />
            </div>

            {/* 2. M√î T·∫¢ */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">2. M√¥ t·∫£ t√≥m t·∫Øt h·ªçc ph·∫ßn (Course description)</h3>
                <p className="text-justify whitespace-pre-line">{syllabus.description}</p>
            </div>

            {/* 3. M·ª§C TI√äU */}
            <div className="mb-4">
                 <h3 className="font-bold mb-1">3. M·ª•c ti√™u h·ªçc ph·∫ßn (Course Objectives)</h3>
                 <p className="mb-1">H·ªçc ph·∫ßn n√†y trang b·ªã cho sinh vi√™n:</p>
                 <ul className="list-none pl-0">
                    {syllabus.objectives.map((obj, i) => <li key={i}>{obj}</li>)}
                 </ul>
            </div>

            {/* 4. CLOs & PLO Mapping */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">4. Chu·∫©n ƒë·∫ßu ra h·ªçc ph·∫ßn (Course Learning Outcomes - CLO)</h3>
                <p className="mb-2">Sau khi h·ªçc xong h·ªçc ph·∫ßn n√†y sinh vi√™n c√≥ kh·∫£ nƒÉng:</p>
                {syllabus.clos.map((c, i) => (
                    <div key={i} className="mb-1 text-justify flex">
                        <span className="font-bold min-w-[60px]">{c.code} :</span>
                        <span>{c.description}</span>
                    </div>
                ))}
                
                <p className="mt-2 mb-1 italic">Li√™n h·ªá gi·ªØa CƒêR h·ªçc ph·∫ßn (CLOs) v√† CƒêR CTƒêT (PLOs):</p>
                <table className="word-table text-center">
                    <thead>
                        <tr className="bg-gray-100">
                            <th>PLO/CLO</th>{[1,2,3,4,5,6,7].map(n => <th key={n}>PLO{n}</th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {syllabus.clos.map((clo, i) => {
                             const map = syllabus.ploMapping.find(m => m.cloCode === clo.code)?.plos || {};
                             return (
                                <tr key={i}>
                                    <td className="font-bold">{clo.code}</td>
                                    {[1,2,3,4,5,6,7].map(n => <td key={n}>{map[`PLO${n}`] || ""}</td>)}
                                </tr>
                             )
                        })}
                    </tbody>
                </table>
            </div>

            {/* 5. NHI·ªÜM V·ª§ */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">5. Nhi·ªám v·ª• c·ªßa sinh vi√™n (Students duties)</h3>
                <div className="whitespace-pre-line pl-4">{syllabus.studentDuties}</div>
            </div>

            {/* 6. ƒê√ÅNH GI√Å */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-1">6. Ph∆∞∆°ng ph√°p ki·ªÉm tra, ƒë√°nh gi√° (Assessment methods):</h3>
                <p className="mb-2">Ph∆∞∆°ng ph√°p ki·ªÉm tra ƒë√°nh gi√° c·ªßa HP ƒë·∫£m b·∫£o ng∆∞·ªùi h·ªçc ƒë·∫°t ƒë∆∞·ª£c CƒêR mong ƒë·ª£i</p>
                <table className="word-table">
                    <thead>
                        <tr className="bg-gray-100 font-bold text-center">
                            <td>Th√†nh ph·∫ßn ƒë√°nh gi√°</td><td>Ph∆∞∆°ng ph√°p/ H√¨nh th·ª©c ƒë√°nh gi√°</td><td>CƒêR HP (CLOs)</td><td>Ti√™u ch√≠ ƒë√°nh gi√°</td><td>Tr·ªçng s·ªë (%)</td>
                        </tr>
                    </thead>
                    <tbody>
                        {syllabus.assessmentScheme.map((item, i) => (
                             <tr key={i} className="text-center">
                                 <td className="text-left">{item.component}</td><td className="text-left">{item.method}</td><td>{item.clos}</td><td>{item.criteria}</td><td>{item.weight}</td>
                             </tr>
                        ))}
                        <tr className="font-bold text-center"><td colSpan={4}>T·ªïng c·ªông</td><td>100</td></tr>
                    </tbody>
                </table>
            </div>

            {/* 7. K·∫æ HO·∫†CH */}
            <div className="mb-4">
                <h3 className="font-bold mb-2">7. K·∫ø ho·∫°ch gi·∫£ng d·∫°y v√† h·ªçc t·∫≠p (Teaching and learning plan/outline)</h3>
                <table className="word-table">
                    <thead>
                        <tr className="bg-gray-100 font-bold text-center">
                            <td className="w-[10%]">Tu·∫ßn / Ch∆∞∆°ng</td><td className="w-[40%]">N·ªôi dung</td><td className="w-[10%]">CLOs</td><td className="w-[25%]">Ho·∫°t ƒë·ªông d·∫°y v√† h·ªçc</td><td className="w-[15%]">D·∫°ng b√†i ƒë√°nh gi√°</td>
                        </tr>
                    </thead>
                    <tbody>
                         <tr className="font-bold bg-gray-50"><td colSpan={5}>PH·∫¶N L√ù THUY·∫æT</td></tr>
                        {syllabus.teachingPlan.map((row, i) => (
                            <tr key={i}>
                                <td className="text-center">{row.week}</td><td className="whitespace-pre-line">{row.topic}</td><td className="text-center">{row.clos}</td><td className="text-center whitespace-pre-line">{row.activity}</td><td className="text-center">{row.assessment}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* 8. T√ÄI LI·ªÜU */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-1">8. T√†i li·ªáu h·ªçc t·∫≠p (Course materials)</h3>
                <div className="font-bold pl-0">8.1. T√†i li·ªáu ch√≠nh (Main materials)</div>
                <div className="pl-4 mb-2">
                    {syllabus.materials.filter(m => m.type === 'Main').map((m, i) => <div key={i}>[{i+1}] {m.title}</div>)}
                </div>
                <div className="font-bold pl-0">8.2. T√†i li·ªáu tham kh·∫£o (References materials)</div>
                <div className="pl-4">
                    {syllabus.materials.filter(m => m.type === 'Ref').map((m, i) => <div key={i}>[{i+1}] {m.title}</div>)}
                </div>
            </div>

            {/* 9. Y√äU C·∫¶U KH√ÅC (ƒê√É C√ì) */}
            <div className="mb-4">
                 <h3 className="font-bold mb-1">9. Y√™u c·∫ßu kh√°c v·ªÅ h·ªçc ph·∫ßn (Other course requirements and expectations)</h3>
                 <div className="pl-4 whitespace-pre-line">{syllabus.otherRequirements || "Kh√¥ng"}</div>
            </div>

            {/* 10. CH·ªÆ K√ù */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-2">10. Bi√™n so·∫°n v√† c·∫≠p nh·∫≠t ƒë·ªÅ c∆∞∆°ng</h3>
                <div className="pl-4">
                    <div>- Ng√†y bi√™n so·∫°n l·∫ßn ƒë·∫ßu: {syllabus.datePrepared}</div>
                    <div>- Ng√†y ch·ªânh s·ª≠a: {syllabus.dateEdited}</div>
                </div>
                
                <table className="w-full mt-6 text-center font-bold border-none uppercase">
                    <tbody>
                        <tr><td className="w-1/3 align-top pb-24">PH√íNG ƒê√ÄO T·∫†O</td><td className="w-1/3 align-top pb-24">QU·∫¢N L√ù CTƒêT</td><td className="w-1/3 align-top pb-24">GV L·∫¨P ƒê·ªÄ C∆Ø∆†NG</td></tr>
                        <tr><td></td><td>(ƒê√£ k√Ω)</td><td>(ƒê√£ k√Ω)</td></tr>
                        <tr><td></td><td>{syllabus.dean}</td><td>{syllabus.lecturer}</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="apps/web/components/SyllabusEditForm.tsx">
/*
khi v√†o trang http://localhost:3000/syllabus/create ƒë·ªÉ t·∫°o ƒë·ªÅ c∆∞∆°ng m·ªõi, sau khi ƒë√£ bi√™n so·∫°n ho√†n t·∫•t m√¨nh ·∫•n l∆∞u nh√°p
chuy·ªán x·∫£y ra l√† khi ·∫•n l∆∞u nh√°p nh·ªØng g√¨ m√¨nh ƒë√£ bi√™n so·∫°n kh√¥ng ƒë∆∞·ª£c l∆∞u
h√£y ki·ªÉm tra v√† s·ª≠a l·ªói n√†y gi√∫p m√¨nh, m·ª©c ƒë·ªô ∆∞u ti√™n r·∫•t cao ·∫£nh h∆∞·ªüng ƒë·∫øn to√†n b·ªô d·ª± √°n 
v√† n·∫øu kh√¥ng th·ªÉ s·ª≠a l·ªói n√†y th√¨ vi·∫øt l·∫°i t·ª´ ƒë·∫ßu l√† ƒëi·ªÅu ch·∫Øc ch·∫Øn x·∫£y ra 
*/
"use client";

import React, { useState, useEffect, useMemo } from "react";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { 
    Save, 
    Send, 
    FileDiff, 
    ArrowLeft, 
    MessageSquareWarning, 
    Sparkles, 
    Loader2,
    BookOpen,
    LineChart,
    Trash2
} from "lucide-react";
import { SyllabusData } from "./Types";
import MaterialsTab from "./syllabus-form/MaterialsTab";
import axios from "@/lib/axios";

export default function SyllabusEditForm({ initial }: { initial: SyllabusData }) {
  const router = useRouter();
  
  const [data, setData] = useState<SyllabusData>(initial);
  const [lastSavedString, setLastSavedString] = useState(JSON.stringify(initial));
  const [submitting, setSubmitting] = useState(false);
  const [userRole, setUserRole] = useState<string>("");
  const [aiLoading, setAiLoading] = useState(false);
  
  // Dropdown data
  const [subjects, setSubjects] = useState<any[]>([]);
  const [programs, setPrograms] = useState<any[]>([]);
  const [academicYears, setAcademicYears] = useState<any[]>([]);
  const [lecturers, setLecturers] = useState<any[]>([]);
  const [loadingDropdowns, setLoadingDropdowns] = useState(true);

  useEffect(() => {
    const role = localStorage.getItem("role") || "";
    setUserRole(role);
    
    // Load dropdown data
    const loadDropdowns = async () => {
      try {
        const [subjectsRes, programsRes, yearsRes] = await Promise.all([
          axios.get('/subjects'),
          axios.get('/programs'),
          axios.get('/academic-years')
        ]);
        
        setSubjects(subjectsRes.data || []);
        setPrograms(programsRes.data || []);
        setAcademicYears(yearsRes.data || []);
        
        // Get current user info from token
        const userId = localStorage.getItem("user_id");
        const userName = localStorage.getItem("full_name") || localStorage.getItem("username");
        
        if (userId) {
          setLecturers([{ 
            id: Number(userId), 
            fullName: userName,
            full_name: userName,
            username: userName
          }]);
          
          // Auto-select current user as lecturer for new syllabus
          if (!data.id && !data.lecturerId) {
            updateField("lecturerId", Number(userId));
            updateField("lecturer", userName || "");
          }
        }
      } catch (error) {
        console.error("Error loading dropdown data:", error);
        alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu dropdown. Vui l√≤ng refresh trang.");
      } finally {
        setLoadingDropdowns(false);
      }
    };
    
    loadDropdowns();
  }, []);

  const hasUnsavedChanges = useMemo(() => {
    return JSON.stringify(data) !== lastSavedString;
  }, [data, lastSavedString]);

  const isEditable = !data.id || 
                     (data.status || "Draft").toLowerCase() === "draft" || 
                     data.status?.toLowerCase() === "returned";


  const updateField = (field: keyof SyllabusData, value: any) => {
    if (isEditable || userRole === "Admin") setData((prev) => ({ ...prev, [field]: value }));
  };

  const updateTime = (key: keyof SyllabusData["timeAllocation"], val: number) => {
    if (isEditable || userRole === "Admin") setData((prev) => ({
      ...prev,
      timeAllocation: { ...prev.timeAllocation, [key]: val },
    }));
  }; 

  const addArrayItem = <T,>(field: keyof SyllabusData, newItem: T) => {
    if (isEditable || userRole === "Admin") setData((prev) => ({
      ...prev,
      [field]: [...(prev[field] as T[]), newItem],
    }));
  };

  const removeArrayItem = (field: keyof SyllabusData, index: number) => {
    if (isEditable || userRole === "Admin") setData((prev) => ({
      ...prev,
      [field]: (prev[field] as any[]).filter((_, i) => i !== index),
    }));
  };

  const updateArrayItem = <T,>(field: keyof SyllabusData, index: number, newItem: Partial<T>) => {
    if (isEditable || userRole === "Admin") {
      setData((prev) => {
        const arr = [...(prev[field] as T[])];
        arr[index] = { ...arr[index], ...newItem };
        return { ...prev, [field]: arr };
      });
    }
  };

  const handleAIGenerate = async () => {
    if (!data.subjectNameVi) {
      alert("Vui l√≤ng nh·∫≠p T√™n m√¥n h·ªçc (Ti·∫øng Vi·ªát) ƒë·ªÉ AI hi·ªÉu √Ω b·∫°n!");
      return;
    }

    if (!confirm(`AI s·∫Ω t·ª± ƒë·ªông so·∫°n th·∫£o n·ªôi dung cho m√¥n "${data.subjectNameVi}".\n\nD·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®. B·∫°n c√≥ ch·∫Øc kh√¥ng?`)) {
      return;
    }

    setAiLoading(true);
    try {
        // Send subjectName in camelCase, axios will convert to snake_case
        const res = await axios.post("/ai/generate", { subjectName: data.subjectNameVi });
        const aiData = res.data;
        
        if (!aiData || typeof aiData !== 'object') {
          throw new Error("D·ªØ li·ªáu AI tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá");
        }
        
        // Merge AI data with existing data
        setData(prev => ({
            ...prev,
            ...aiData,
            id: prev.id,
            status: prev.status,
            version: prev.version,
            subjectNameVi: prev.subjectNameVi, // Keep the original name
        }));
        
        alert("‚úÖ AI ƒë√£ so·∫°n th·∫£o xong! Vui l√≤ng ki·ªÉm tra l·∫°i c√°c Tab.");
    } catch (e: any) {
        console.error("AI Generate Error:", e);
        
        let errorMsg = "L·ªói k·∫øt n·ªëi ƒë·∫øn AI Server.";
        
        if (e?.response?.data?.message) {
          errorMsg = e.response.data.message;
        } else if (e?.response?.status === 404) {
          errorMsg = "Endpoint AI kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ki·ªÉm tra backend.";
        } else if (e?.message?.includes("Network Error")) {
          errorMsg = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend. Vui l√≤ng ki·ªÉm tra server c√≥ ƒëang ch·∫°y kh√¥ng.";
        } else if (e?.message) {
          errorMsg = e.message;
        }
        
        alert(`‚ùå L·ªói AI Generate:\n${errorMsg}\n\nVui l√≤ng ƒëi·ªÅn th√¥ng tin th·ªß c√¥ng.`);
    } finally {
        setAiLoading(false);
    }
  };

  const handleSave = async () => {
    // 1. Validation for weights
    const totalWeight = data.assessmentScheme.reduce((sum, item) => sum + (Number(item.weight) || 0), 0);
    if (totalWeight !== 100) {
        if (!confirm(`‚ö†Ô∏è T·ªïng tr·ªçng s·ªë hi·ªán t·∫°i l√† ${totalWeight}%, kh√¥ng b·∫±ng 100%.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u b·∫£n nh√°p n√†y kh√¥ng? (ƒê·ªÉ ƒë∆∞·ª£c duy·ªát, t·ªïng ph·∫£i b·∫±ng 100%)`)) {
            return;
        }
    }

    setSubmitting(true);
    try {
      const isEdit = !!data.id;

      if (!isEdit) {
        // Validate required IDs before creating
        if (!data.subjectId || !data.programId || !data.academicYearId || !data.lecturerId) {
          alert("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c ID b·∫Øt bu·ªôc:\n\n" +
            `- Subject ID: ${data.subjectId || 'THI·∫æU'}\n` +
            `- Program ID: ${data.programId || 'THI·∫æU'}\n` +
            `- Academic Year ID: ${data.academicYearId || 'THI·∫æU'}\n` +
            `- Lecturer ID: ${data.lecturerId || 'THI·∫æU'}\n\n` +
            "C√°c ID n√†y ph·∫£i ƒë∆∞·ª£c nh·∫≠p th·ªß c√¥ng ho·∫∑c ch·ªçn t·ª´ dropdown.");
          setSubmitting(false);
          return;
        }
        
        console.log("[DEBUG] Starting create syllabus with IDs:", {
          subjectId: data.subjectId,
          programId: data.programId,
          academicYearId: data.academicYearId,
          lecturerId: data.lecturerId
        });

        // Create parent syllabus first (axios will convert camelCase -> snake_case on POST)
        const parentPayload: any = {
          subjectId: data.subjectId,
          programId: data.programId,
          academicYearId: data.academicYearId,
          lecturerId: data.lecturerId,
          headDepartmentId: data.headDepartmentId,
          deanId: data.deanId,
          version: data.version || "1.0",
          timeAllocation: data.timeAllocation,
          prerequisites: data.prerequisites ?? null,
          
          // Content fields
          description: data.description ?? null,
          objectives: data.objectives || [],
          studentDuties: data.studentDuties ?? null,
          otherRequirements: data.otherRequirements ?? null,
          
          // Additional metadata
          preCourses: data.preCourses ?? null,
          coCourses: data.coCourses ?? null,
          courseType: data.courseType ?? null,
          componentType: data.componentType ?? null,
          datePrepared: data.datePrepared ?? null,
          dateEdited: data.dateEdited ?? null,
          dean: data.dean ?? null,
          headDepartment: data.headDepartment ?? null,
        };

        // Add child entities to payload - backend service handles them atomically
        parentPayload.clos = (data.clos || [])
          .filter((clo) => clo.code && clo.description)
          .map(clo => {
            // Merge PLO mappings for this CLO if they exist
            const mapping = data.ploMapping?.find(m => m.cloCode === clo.code);
            return {
              ...clo,
              ploMappings: mapping ? Object.entries(mapping.plos).map(([code, level]) => ({ code, level })) : []
            };
          });

        parentPayload.teachingPlans = data.teachingPlan?.filter((p) => p.week && p.topic) || [];
        parentPayload.materials = data.materials?.filter((m) => m.type && m.title) || [];
        
        // Convert assessment scheme to nested structure expected by backend
        if (data.assessmentScheme && data.assessmentScheme.length > 0) {
          parentPayload.assessmentSchemes = [{
            name: "Default Scheme",
            components: data.assessmentScheme.map(item => ({
              name: item.component,
              method: item.method,
              weight: item.weight,
              criteria: item.criteria,
              cloIds: item.clos // CLO codes/IDs reference
            }))
          }];
        }

        console.log("[DEBUG] Creating syllabus with full payload (header + children):", parentPayload);
        const res = await axios.post("/syllabuses", parentPayload);
        const resJson = res.data;
        console.log("[DEBUG] Server response:", resJson);
        
        if (!resJson?.id) {
          console.error("[ERROR] No ID returned from server. Full response:", resJson);
          throw new Error("Server kh√¥ng tr·∫£ v·ªÅ ID. Vui l√≤ng ki·ªÉm tra logs backend.");
        }

        const syllabusId = resJson.id;
        const childCounts = {
          clos: parentPayload.clos.length,
          plans: parentPayload.teachingPlans.length,
          materials: parentPayload.materials.length
        };
        
        console.log("[DEBUG] Syllabus created successfully with children:", childCounts);

        const newData = { ...data, id: syllabusId };
        setData(newData);
        setLastSavedString(JSON.stringify(newData));
        console.log("[DEBUG] Create completed successfully. Redirecting...");
        alert(`‚úÖ T·∫°o m·ªõi th√†nh c√¥ng!\n\nƒê·ªÅ c∆∞∆°ng ID: ${syllabusId}\n` +
              `üìö CLOs: ${childCounts.clos}\n` +
              `üìÖ K·∫ø ho·∫°ch: ${childCounts.plans}\n` +
              `üìñ T√†i li·ªáu: ${childCounts.materials}`);
        router.push(`/syllabus/${syllabusId}/edit`);
        return;
      }

      // Edit existing syllabus
      // Syncing payload with create logic to preserve children
      const updatePayload: any = {
        subjectId: data.subjectId,
        programId: data.programId,
        academicYearId: data.academicYearId,
        lecturerId: data.lecturerId,
        headDepartmentId: data.headDepartmentId,
        deanId: data.deanId,
        version: data.version,
        timeAllocation: data.timeAllocation,
        prerequisites: data.prerequisites ?? null,
        
        // Content fields
        description: data.description ?? null,
        objectives: data.objectives || [],
        studentDuties: data.studentDuties ?? null,
        otherRequirements: data.otherRequirements ?? null,
        
        // Additional metadata
        preCourses: data.preCourses ?? null,
        coCourses: data.coCourses ?? null,
        courseType: data.courseType ?? null,
        componentType: data.componentType ?? null,
        datePrepared: data.datePrepared ?? null,
        dateEdited: data.dateEdited ?? null,
        dean: data.dean ?? null,
        headDepartment: data.headDepartment ?? null,
      };

      // Synchronize child entities saving logic
      updatePayload.clos = (data.clos || [])
        .filter((clo) => clo.code && clo.description)
        .map(clo => {
          // Merge PLO mappings for this CLO
          const mapping = data.ploMapping?.find(m => m.cloCode === clo.code);
          return {
            ...clo,
            ploMappings: mapping ? Object.entries(mapping.plos).map(([code, level]) => ({ code, level })) : []
          };
        });

      updatePayload.teachingPlans = data.teachingPlan?.filter((p) => p.week && p.topic) || [];
      updatePayload.materials = data.materials?.filter((m) => m.type && m.title) || [];
      
      if (data.assessmentScheme && data.assessmentScheme.length > 0) {
        updatePayload.assessmentSchemes = [{
          name: "Default Scheme",
          components: data.assessmentScheme.map(item => ({
            name: item.component,
            method: item.method,
            weight: item.weight,
            criteria: item.criteria,
            cloIds: item.clos
          }))
        }];
      }
      
      console.log("[DEBUG] Updating syllabus with full synchronzed payload:", updatePayload);
      const updateRes = await axios.patch(`/syllabuses/${data.id}`, updatePayload);
      console.log("[DEBUG] Update response:", updateRes.data);
      setLastSavedString(JSON.stringify(data));
      router.refresh();
      alert(`‚úÖ ƒê√£ l∆∞u b·∫£n nh√°p!\n\nƒê·ªÅ c∆∞∆°ng ID: ${data.id}\nTh·ªùi gian: ${new Date().toLocaleTimeString()}`);

    } catch (error: any) {
      console.error("[ERROR] Save Error:", error);
      console.error("[ERROR] Error details:", {
        message: error.message,
        status: error?.response?.status,
        data: error?.response?.data,
        config: error?.config?.url
      });
      
      // Check for CORS or network errors
      if (error?.message?.includes('Network Error') || error?.code === 'ERR_NETWORK') {
        alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend.\n\nVui l√≤ng ki·ªÉm tra:\n1. Backend c√≥ ƒëang ch·∫°y kh√¥ng?\n2. ƒê√∫ng port ch∆∞a? (m·∫∑c ƒë·ªãnh: 9999)\n3. CORS ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ch∆∞a?");
        setSubmitting(false);
        return;
      }
      
      if (error?.response?.status === 401) {
        alert("‚ö†Ô∏è Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.");
        router.push("/login");
        return;
      }
      
      if (error?.response?.status === 403) {
        const message = error?.response?.data?.message || "B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y";
        alert(`üö´ ${message}\n\nCh·ªâ Lecturer v√† Admin c√≥ th·ªÉ t·∫°o/s·ª≠a ƒë·ªÅ c∆∞∆°ng.`);
        setSubmitting(false);
        return;
      }
      
      if (error?.response?.status === 422) {
        const message = error?.response?.data?.message || "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá";
        const details = error?.response?.data?.details || error?.response?.data?.error || "";
        alert(`‚ö†Ô∏è ${message}\n\nChi ti·∫øt: ${details}\n\nVui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng b·∫Øt bu·ªôc.`);
        setSubmitting(false);
        return;
      }
      
      const errorMsg = error?.response?.data?.error || error?.response?.data?.message || error?.message || "L·ªói khi l∆∞u d·ªØ li·ªáu.";
      const statusCode = error?.response?.status || "N/A";
      const url = error?.config?.url || "Unknown endpoint";
      
      alert(`‚ùå L·ªói khi l∆∞u ƒë·ªÅ c∆∞∆°ng\n\n` +
        `M√£ l·ªói: ${statusCode}\n` +
        `Endpoint: ${url}\n` +
        `Chi ti·∫øt: ${errorMsg}\n\n` +
        `Vui l√≤ng ki·ªÉm tra Console (F12) ƒë·ªÉ xem log chi ti·∫øt.`);
      
      console.log("[ERROR] Full error object:", error);
    } finally {
      setSubmitting(false);
    }
  };

  const handleWorkflow = async (action: "submit" | "approve" | "revise") => {
    if (!data.id) return;

    let confirmMsg = "";
    if (action === "submit") confirmMsg = "G·ª≠i ƒë·ªÅ c∆∞∆°ng ƒëi ph√™ duy·ªát? B·∫°n s·∫Ω kh√¥ng th·ªÉ ch·ªânh s·ª≠a trong l√∫c ch·ªù.";
    if (action === "approve") confirmMsg = "X√°c nh·∫≠n PH√ä DUY·ªÜT ƒë·ªÅ c∆∞∆°ng n√†y?";
    if (action === "revise") confirmMsg = "H·ªá th·ªëng s·∫Ω t·∫°o phi√™n b·∫£n M·ªöI (Draft) t·ª´ b·∫£n n√†y ƒë·ªÉ b·∫°n ch·ªânh s·ª≠a. Ti·∫øp t·ª•c?";

    if (!confirm(confirmMsg)) return;

    setSubmitting(true);
    try {
      let res;
      if (action === "approve") {
          res = await axios.post(`/syllabuses/${data.id}/evaluate`, { action: 'approve' });
      } else {
          res = await axios.post(`/syllabuses/${data.id}/${action}`);
      }
      const resData = res.data;

      if (action === "revise") {
        alert(`‚úÖ ƒê√£ t·∫°o phi√™n b·∫£n m·ªõi: ${resData.version}`);
        router.push(`/syllabus/${resData.id}/edit`);
        return;
      }
      alert("‚úÖ Thao t√°c th√†nh c√¥ng!");
      router.refresh();
    } catch (e: any) {
      console.error(e);
      
      const status = e?.response?.status;
      
      if (status === 403) {
        const message = e?.response?.data?.message || "B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y";
        alert(`üö´ ${message}`);
        return;
      }
      
      if (status === 422) {
        const message = e?.response?.data?.message || "ƒê·ªÅ c∆∞∆°ng kh√¥ng trong tr·∫°ng th√°i ph√π h·ª£p";
        alert(`‚ö†Ô∏è ${message}`);
        return;
      }
      
      const msg = e?.response?.data?.message || e?.response?.data?.detail || e?.message || "L·ªói k·∫øt n·ªëi server.";
      alert(`‚ùå ${msg}`);
    } finally {
      setSubmitting(false);
    }
  };

  const totalPeriods = (data.timeAllocation?.theory || 0) + (data.timeAllocation?.exercises || 0) + (data.timeAllocation?.practice || 0);

  const renderStatusBadge = () => {
    const status = (data.status || "Draft").toLowerCase();
    let colorClass = "bg-gray-500";
    let label = "B·∫£n nh√°p";

    if (status === "pending") { colorClass = "bg-yellow-500"; label = "Ch·ªù duy·ªát (BM)"; }
    else if (status === "pending approval") { colorClass = "bg-orange-500"; label = "Ch·ªù duy·ªát (PƒêT)"; }
    else if (status === "pending final approval") { colorClass = "bg-purple-500"; label = "Ch·ªù duy·ªát (BGH)"; }
    else if (status === "approved" || status === "published") { colorClass = "bg-green-600"; label = "ƒê√£ c√¥ng b·ªë"; }
    else if (status === "returned") { colorClass = "bg-red-500"; label = "Y√™u c·∫ßu s·ª≠a"; }

    return <Badge className={`${colorClass} hover:${colorClass} ml-3 text-sm px-3 py-1`}>{label}</Badge>;
  };

  return (
    <div className="w-full max-w-6xl mx-auto py-6 px-4">
      {data.status?.toLowerCase() === "returned" && data.feedback && (
          <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex gap-3 items-start shadow-sm animate-in slide-in-from-top-2">
             <MessageSquareWarning className="w-6 h-6 text-red-600 mt-0.5 shrink-0" />
             <div>
                <h3 className="font-bold text-red-700 text-lg">Y√™u c·∫ßu ch·ªânh s·ª≠a</h3>
                <p className="text-red-600 mt-1 whitespace-pre-wrap">{data.feedback}</p>
             </div>
          </div>
      )}

      <Card className="shadow-lg border-t-4 border-t-primary">
        <CardHeader className="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 mb-4 bg-slate-50/50 rounded-t-lg gap-4">
          <div>
            <div className="flex items-center gap-2">
              <CardTitle className="text-xl">
                {data.id ? `Bi√™n so·∫°n: ${data.subjectCode}` : "T·∫°o ƒê·ªÅ C∆∞∆°ng M·ªõi"}
              </CardTitle>
              {data.version && <Badge variant="outline" className="border-primary text-primary font-bold">v{data.version}</Badge>}
              {renderStatusBadge()}
            </div>
            <p className="text-sm text-gray-500 mt-1">
              {isEditable ? "B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªânh s·ª≠a" : "Ch·∫ø ƒë·ªô xem (Read-only)"}
            </p>
          </div>

          <div className="flex flex-wrap gap-2 items-center">
            <Button variant="outline" onClick={() => router.back()} size="sm">
                <ArrowLeft className="w-4 h-4 mr-2"/> Tho√°t
            </Button>

            {isEditable && (
              <Button onClick={handleSave} disabled={submitting || aiLoading} variant="secondary" className="border border-slate-300 relative" size="sm">
                <Save className="w-4 h-4 mr-2" /> L∆∞u Nh√°p
                {hasUnsavedChanges && (
                    <span className="absolute -top-1 -right-1 flex h-3 w-3">
                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                      <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                )}
              </Button>
            )}

            {data.id && (
              <>
                {(data.status?.toLowerCase() === "draft" || data.status?.toLowerCase() === "returned") && (
                  <div className="flex flex-col items-end">
                      {/* S·ª¨A: bg-blue-600 -> bg-teal-600 */}
                      <Button 
                        className="bg-teal-600 hover:bg-teal-700 text-white disabled:opacity-50 disabled:cursor-not-allowed" 
                        size="sm" 
                        onClick={() => handleWorkflow("submit")}
                        disabled={hasUnsavedChanges || submitting || aiLoading}
                        title={hasUnsavedChanges ? "B·∫°n c·∫ßn l∆∞u nh√°p tr∆∞·ªõc khi g·ª≠i duy·ªát" : "G·ª≠i ƒëi ph√™ duy·ªát"}
                      >
                        <Send className="w-4 h-4 mr-2" /> G·ª≠i Duy·ªát
                      </Button>
                  </div>
                )}

                {(data.status?.toLowerCase() === "pending" || data.status?.toLowerCase() === "pending approval" || data.status?.toLowerCase() === "pending final approval") && (userRole === "Head of Dept" || userRole === "HoD" || userRole === "Academic Affairs" || userRole === "AA" || userRole === "Principal" || userRole === "Admin") && (
                  <div className="flex gap-2">
                    <Button variant="outline" size="sm" onClick={() => router.push("/reviews")}>
                         X·ª≠ l√Ω y√™u c·∫ßu n√†y (Duy·ªát/Tr·∫£ v·ªÅ)
                    </Button>
                  </div>
                )}

                {data.status?.toLowerCase() === "approved" && (
                    <Button className="bg-purple-600 hover:bg-purple-700 text-white border-purple-800" size="sm" onClick={() => handleWorkflow("revise")}>
                        <FileDiff className="w-4 h-4 mr-2" /> T·∫°o phi√™n b·∫£n m·ªõi
                    </Button>
                )}
              </>
            )}
          </div>
        </CardHeader>

        <CardContent>
          <Tabs defaultValue="general" className="w-full">
            <TabsList className="grid w-full grid-cols-7 mb-6 h-auto p-1 bg-slate-100 italic">
              <TabsTrigger value="general">1. Th√¥ng tin chung</TabsTrigger>
              <TabsTrigger value="clos">2-4. M·ª•c ti√™u & CƒêR</TabsTrigger>
              <TabsTrigger value="plo">PLO Map</TabsTrigger>
              <TabsTrigger value="assessment">5-6. ƒê√°nh gi√°</TabsTrigger>
              <TabsTrigger value="plan">7. K·∫ø ho·∫°ch</TabsTrigger>
              <TabsTrigger value="materials">8. T√†i li·ªáu</TabsTrigger>
              <TabsTrigger value="others">9. Kh√°c</TabsTrigger>
            </TabsList>

            <div className={(!isEditable && userRole !== "Admin") ? "opacity-90 pointer-events-none" : ""}>
                <TabsContent value="general" className="space-y-6 animate-in fade-in-50">
                  {/* ... contents continue ... */}
                  <div className="bg-slate-50 border-2 border-slate-200 rounded-lg p-4 mb-6 shadow-sm">
                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                  <span className="text-lg">‚öôÔ∏è</span> C·∫•u tr√∫c th·ª±c thi & Ph√¢n quy·ªÅn
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-900">
                      M√¥n h·ªçc (Subject) <span className="text-red-600">*</span>
                    </label>
                    {loadingDropdowns ? (
                      <div className="text-sm text-gray-500">ƒêang t·∫£i...</div>
                    ) : (
                      <select 
                        className={`flex h-10 w-full rounded-md border px-3 py-2 text-sm ${data.id && userRole !== "Admin" ? 'bg-gray-100 border-gray-300' : 'bg-white border-blue-300'}`}
                        value={data.subjectId || ""}
                        disabled={!!data.id && userRole !== "Admin"} // Only Admin can change subject of existing syllabus
                        onChange={(e) => {
                          const subjectId = Number(e.target.value);
                          const subject = subjects.find(s => s.id === subjectId);
                          if (subject) {
                            updateField("subjectId", subjectId);
                            updateField("subjectCode", subject.code);
                            updateField("subjectNameVi", subject.nameVi || subject.name_vi);
                            updateField("subjectNameEn", subject.nameEn || subject.name_en);
                            updateField("credits", subject.credits);
                          }
                        }}
                      >
                        <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                        {subjects.map(s => (
                          <option key={s.id} value={s.id}>
                            {s.code} - {s.nameVi || s.name_vi}
                          </option>
                        ))}
                      </select>
                    )}
                  </div>
                  
                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-900">
                      NƒÉm h·ªçc (Academic Year) <span className="text-red-600">*</span>
                    </label>
                    {loadingDropdowns ? (
                      <div className="text-sm text-gray-500">ƒêang t·∫£i...</div>
                    ) : (
                      <select 
                        className="flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                        value={data.academicYearId || ""}
                        onChange={(e) => updateField("academicYearId", Number(e.target.value))}
                      >
                        <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                        {academicYears.map(y => (
                          <option key={y.id} value={y.id}>
                            {y.code}
                          </option>
                        ))}
                      </select>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-900">
                      Tr∆∞·ªüng B·ªô m√¥n <span className="text-red-600">*</span>
                    </label>
                    {loadingDropdowns ? (
                      <div className="text-sm text-gray-500">ƒêang t·∫£i...</div>
                    ) : (
                      <select 
                        className="flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                        value={data.headDepartmentId || ""}
                        onChange={(e) => updateField("headDepartmentId", Number(e.target.value))}
                      >
                        <option value="">-- Ch·ªçn Tr∆∞·ªüng B·ªô m√¥n --</option>
                        {lecturers.map(l => (
                          <option key={l.id} value={l.id}>
                            {l.fullName || l.full_name || l.username}
                          </option>
                        ))}
                      </select>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-900">
                      Ban Gi√°m hi·ªáu (K√Ω duy·ªát) <span className="text-red-600">*</span>
                    </label>
                    {loadingDropdowns ? (
                      <div className="text-sm text-gray-500">ƒêang t·∫£i...</div>
                    ) : (
                      <select 
                        className="flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                        value={data.deanId || ""}
                        onChange={(e) => updateField("deanId", Number(e.target.value))}
                      >
                        <option value="">-- Ch·ªçn ng∆∞·ªùi k√Ω --</option>
                        {lecturers.map(l => (
                          <option key={l.id} value={l.id}>
                            {l.fullName || l.full_name || l.username}
                          </option>
                        ))}
                      </select>
                    )}
                  </div>
                  
                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-900">
                      Ch∆∞∆°ng tr√¨nh (Program) <span className="text-red-600">*</span>
                    </label>
                    {loadingDropdowns ? (
                      <div className="text-sm text-gray-500">ƒêang t·∫£i...</div>
                    ) : (
                      <select 
                        className={`flex h-10 w-full rounded-md border px-3 py-2 text-sm ${data.id && userRole !== "Admin" ? 'bg-gray-100 border-gray-300' : 'bg-white border-slate-300'}`}
                        value={data.programId || ""}
                        disabled={!!data.id && userRole !== "Admin"}
                        onChange={(e) => updateField("programId", Number(e.target.value))}
                      >
                        <option value="">-- Ch·ªçn ch∆∞∆°ng tr√¨nh --</option>
                        {programs.map(p => (
                          <option key={p.id} value={p.id}>
                            {p.name || p.nameVi || p.name_vi}
                          </option>
                        ))}
                      </select>
                    )}
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-900">Ng∆∞·ªùi bi√™n so·∫°n</label>
                    <Input className="bg-gray-100" value={data.lecturer || ""} disabled />
                  </div>
                </div>
                {!data.id && (
                  <p className="text-xs text-amber-700 mt-2 font-medium">
                    üí° L∆∞u √Ω: C√°c tr∆∞·ªùng n√†y gi√∫p ƒë·ªãnh danh ƒë·ªÅ c∆∞∆°ng v√† ph√¢n quy·ªÅn ph√™ duy·ªát.
                  </p>
                )}
              </div>
              
              <div className="grid grid-cols-2 gap-6">
                <div className="space-y-2">
                    <label className="text-sm font-semibold flex justify-between items-center">
                        T√™n HP (Ti·∫øng Vi·ªát)
                        {isEditable && (
                            <button 
                                onClick={handleAIGenerate} 
                                disabled={aiLoading}
                                className="text-xs flex items-center gap-1 text-purple-600 hover:text-purple-800 font-bold transition-all hover:scale-105 border border-purple-200 px-2 py-1 rounded-full bg-purple-50"
                                title="T·ª± ƒë·ªông ƒëi·ªÅn n·ªôi dung b·∫±ng AI"
                            >
                                {aiLoading ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>}
                                {aiLoading ? "AI ƒëang vi·∫øt..." : "AI So·∫°n th·∫£o"}
                            </button>
                        )}
                    </label>
                    <Input value={data.subjectNameVi} onChange={(e) => updateField("subjectNameVi", e.target.value)} placeholder="VD: Nh·∫≠p m√¥n Tr√≠ tu·ªá Nh√¢n t·∫°o"/>
                </div>
                <div className="space-y-2"><label className="text-sm font-semibold">T√™n HP (Ti·∫øng Anh)</label><Input value={data.subjectNameEn} onChange={(e) => updateField("subjectNameEn", e.target.value)} /></div>
                <div className="space-y-2"><label className="text-sm font-semibold">M√£ H·ªçc Ph·∫ßn</label><Input value={data.subjectCode} onChange={(e) => updateField("subjectCode", e.target.value)} /></div>
                <div className="space-y-2"><label className="text-sm font-semibold">S·ªë t√≠n ch·ªâ</label><Input type="number" value={data.credits} onChange={(e) => updateField("credits", Number(e.target.value))} /></div>
              </div>
              <div className="border p-4 rounded-md bg-slate-50">
                <h3 className="font-bold mb-4 text-sm uppercase text-slate-600">Ph√¢n b·ªï th·ªùi gian (Ti·∫øt)</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                  <label className="text-sm">L√Ω thuy·∫øt <Input type="number" className="mt-1 bg-white" value={data.timeAllocation?.theory || 0} onChange={(e) => updateTime("theory", Number(e.target.value))} /></label>
                  <label className="text-sm">B√†i t·∫≠p/D·ª± √°n <Input type="number" className="mt-1 bg-white" value={data.timeAllocation?.exercises || 0} onChange={(e) => updateTime("exercises", Number(e.target.value))} /></label>
                  <label className="text-sm">Th·ª±c h√†nh <Input type="number" className="mt-1 bg-white" value={data.timeAllocation?.practice || 0} onChange={(e) => updateTime("practice", Number(e.target.value))} /></label>
                  <label className="text-sm">T·ª± h·ªçc <Input type="number" className="mt-1 bg-white" value={data.timeAllocation?.selfStudy || 0} onChange={(e) => updateTime("selfStudy", Number(e.target.value))} /></label>
                  <div className="text-sm font-bold pb-2 text-right md:text-left">T·ªïng tr√™n l·ªõp: <span className="text-lg text-primary ml-2">{totalPeriods}</span></div>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <label className="text-sm font-semibold">HP Ti√™n quy·∫øt <Input className="mt-1" value={data.prerequisites || ""} onChange={(e) => updateField("prerequisites", e.target.value)} /></label>
                <label className="text-sm font-semibold">HP H·ªçc tr∆∞·ªõc <Input className="mt-1" value={data.preCourses || ""} onChange={(e) => updateField("preCourses", e.target.value)} /></label>
                <label className="text-sm font-semibold">HP Song h√†nh <Input className="mt-1" value={data.coCourses || ""} onChange={(e) => updateField("coCourses", e.target.value)} /></label>
              </div>
               <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <label className="text-sm font-semibold">Lo·∫°i h·ªçc ph·∫ßn <select className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background mt-1" value={data.courseType || ""} onChange={(e) => updateField("courseType", e.target.value)}><option value="B·∫Øt bu·ªôc">B·∫Øt bu·ªôc</option><option value="T·ª± ch·ªçn b·∫Øt bu·ªôc">T·ª± ch·ªçn b·∫Øt bu·ªôc</option><option value="T·ª± ch·ªçn t·ª± do">T·ª± ch·ªçn t·ª± do</option></select></label>
                <label className="text-sm font-semibold">Thu·ªôc th√†nh ph·∫ßn <Input className="mt-1" value={data.componentType || ""} onChange={(e) => updateField("componentType", e.target.value)} /></label>
              </div>
              <div className="border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <label className="text-sm font-semibold">Ng√†y bi√™n so·∫°n <Input type="date" className="mt-1" value={data.datePrepared || ""} onChange={(e) => updateField("datePrepared", e.target.value)} /></label>
                <label className="text-sm font-semibold">Ng√†y ch·ªânh s·ª≠a <Input type="date" className="mt-1" value={data.dateEdited || ""} onChange={(e) => updateField("dateEdited", e.target.value)} /></label>
              </div>
            </TabsContent>

            {/* C√°c TabsContent kh√°c (clos, plo, assessment, plan, materials, others) gi·ªØ nguy√™n code c≈© v√¨ kh√¥ng c√≥ m√†u c·ª©ng, n√≥ s·∫Ω t·ª± ƒÉn theo m√†u Primary m·ªõi */}
            <TabsContent value="clos" className="space-y-6 animate-in fade-in-50">
              <div><label className="font-bold block mb-2">2. M√¥ t·∫£ t√≥m t·∫Øt h·ªçc ph·∫ßn</label><Textarea rows={4} value={data.description || ""} onChange={(e) => updateField("description", e.target.value)} /></div>
              <div className="bg-slate-50 p-4 rounded-md">
                <label className="font-bold block mb-2">3. M·ª•c ti√™u h·ªçc ph·∫ßn (Course Objectives)</label>
                {data.objectives.map((obj, i) => (
                  <div key={i} className="flex gap-2 mb-2"><Input value={obj} onChange={(e) => { const newObj = [...data.objectives]; newObj[i] = e.target.value; updateField("objectives", newObj); }} /><Button variant="ghost" onClick={() => { const newObj = data.objectives.filter((_, idx) => idx !== i); updateField("objectives", newObj); }}>‚úï</Button></div>
                ))}
                <Button variant="outline" size="sm" className="mt-2 border-dashed" onClick={() => updateField("objectives", [...data.objectives, `CO${data.objectives.length + 1}: `])}>+ Th√™m M·ª•c Ti√™u (CO)</Button>
              </div>
              <div>
                <label className="font-bold block mb-2">4. Chu·∫©n ƒë·∫ßu ra h·ªçc ph·∫ßn (CLOs)</label>
                <Table>
                  <TableHeader><TableRow><TableHead className="w-24">M√£ CƒêR</TableHead><TableHead>M√¥ t·∫£ chu·∫©n ƒë·∫ßu ra</TableHead><TableHead className="w-12"></TableHead></TableRow></TableHeader>
                  <TableBody>{data.clos.map((clo, i) => (
                    <TableRow key={i}><TableCell><Input className="font-bold" value={clo.code} onChange={(e) => updateArrayItem("clos", i, { code: e.target.value })} /></TableCell><TableCell><Input value={clo.description} onChange={(e) => updateArrayItem("clos", i, { description: e.target.value })} /></TableCell><TableCell><Button variant="ghost" size="icon" onClick={() => removeArrayItem("clos", i)}>‚úï</Button></TableCell></TableRow>
                  ))}</TableBody>
                </Table>
                <Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("clos", { code: `CLO${data.clos.length + 1}`, description: "" })}>+ Th√™m CLO M·ªõi</Button>
              </div>
            </TabsContent>

            <TabsContent value="plo" className="animate-in fade-in-50">
               {/* S·ª¨A: Alert bg-blue-50 -> bg-teal-50 */}
               <div className="alert bg-teal-50 text-teal-700 p-3 mb-4 text-sm rounded-md border border-teal-100"><strong>H∆∞·ªõng d·∫´n:</strong> ƒêi·ªÅn c√°c k√Ω t·ª± (I, R, M, A) v√†o c√°c √¥ t∆∞∆°ng ·ª©ng.</div>
               <div className="border rounded-md overflow-x-auto"><Table><TableHeader><TableRow><TableHead className="w-24 bg-gray-100">CLO \ PLO</TableHead>{[1, 2, 3, 4, 5, 6, 7].map((p) => (<TableHead key={p} className="text-center w-16 bg-gray-50">PLO{p}</TableHead>))}</TableRow></TableHeader><TableBody>{data.clos.map((clo, i) => { const rowMap = data.ploMapping.find((p) => p.cloCode === clo.code) || { cloCode: clo.code, plos: {} }; return (<TableRow key={i}><TableCell className="font-bold bg-gray-50">{clo.code}</TableCell>{[1, 2, 3, 4, 5, 6, 7].map((p) => (<TableCell key={p} className="p-1"><Input className="h-9 text-center uppercase" value={rowMap.plos[`PLO${p}`] || ""} onChange={(e) => { const val = e.target.value; const newMapping = [...data.ploMapping]; const existIdx = newMapping.findIndex((m) => m.cloCode === clo.code); if (existIdx >= 0) { newMapping[existIdx] = { ...newMapping[existIdx], plos: { ...newMapping[existIdx].plos, [`PLO${p}`]: val } } } else { newMapping.push({ cloCode: clo.code, plos: { [`PLO${p}`]: val } }); } updateField("ploMapping", newMapping); }} /></TableCell>))}</TableRow>); })}</TableBody></Table></div>
            </TabsContent>

            <TabsContent value="assessment" className="space-y-6 animate-in fade-in-50">
               <div className="bg-slate-50 p-4 rounded-md border border-slate-200 shadow-inner">
                  <label className="font-bold flex items-center gap-2 mb-2 text-slate-700">
                    <BookOpen className="w-4 h-4" /> 5. Nhi·ªám v·ª• c·ªßa sinh vi√™n
                  </label>
                  <Textarea 
                    rows={4} 
                    className="bg-white"
                    placeholder="VD: D·ª± l·ªõp t·ªëi thi·ªÉu 80% th·ªùi gian; ho√†n th√†nh c√°c b√†i t·∫≠p..."
                    value={data.studentDuties || ""} 
                    onChange={(e) => updateField("studentDuties", e.target.value)} 
                  />
               </div>

               <div className="space-y-4">
                  <div className="flex justify-between items-center bg-teal-50 p-3 rounded-md border border-teal-100">
                    <div>
                      <h3 className="font-bold text-teal-800 flex items-center gap-2">
                        <LineChart className="w-5 h-5" /> 6. Ph∆∞∆°ng ph√°p ki·ªÉm tra, ƒë√°nh gi√°
                      </h3>
                      <p className="text-xs text-teal-600 mt-1">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh t·ªïng tr·ªçng s·ªë.</p>
                    </div>
                    <div className="flex items-center gap-6">
                      <div className="text-right">
                        <div className="text-[10px] uppercase text-slate-500 font-semibold mb-0.5">T·ªïng tr·ªçng s·ªë</div>
                        <div className={`text-2xl font-black transition-colors ${data.assessmentScheme.reduce((sum: number, item: any) => sum + (item.weight || 0), 0) === 100 ? 'text-green-600' : 'text-rose-500'}`}>
                          {data.assessmentScheme.reduce((sum: number, item: any) => sum + (item.weight || 0), 0)}%
                        </div>
                      </div>
                      <Button 
                        type="button" 
                        variant="default" 
                        size="sm" 
                        className="bg-teal-600 hover:bg-teal-700 shadow-sm"
                        onClick={() => addArrayItem("assessmentScheme", { component: "", method: "", clos: "", criteria: "", weight: 10 })}
                      >
                         + Th√™m Th√†nh Ph·∫ßn
                      </Button>
                    </div>
                  </div>

                  <div className="overflow-hidden border rounded-xl shadow-sm bg-white">
                    <Table>
                      <TableHeader>
                        <TableRow className="bg-slate-50 hover:bg-slate-50">
                          <TableHead className="w-[180px] font-bold">Th√†nh ph·∫ßn ƒë√°nh gi√°</TableHead>
                          <TableHead className="font-bold">Ph∆∞∆°ng ph√°p / H√¨nh th·ª©c</TableHead>
                          <TableHead className="w-[180px] font-bold">ƒê√°p ·ª©ng CLO</TableHead>
                          <TableHead className="w-[100px] font-bold">Tr·ªçng s·ªë</TableHead>
                          <TableHead className="w-[10px]"></TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {data.assessmentScheme.length === 0 ? (
                          <TableRow>
                            <TableCell colSpan={5} className="text-center py-10 text-slate-400 italic">
                              Ch∆∞a c√≥ th√†nh ph·∫ßn ƒë√°nh gi√° n√†o.
                            </TableCell>
                          </TableRow>
                        ) : (
                          data.assessmentScheme.map((item: any, i: number) => (
                            <TableRow key={i} className="group hover:bg-slate-50/50">
                              <TableCell className="align-top">
                                <select 
                                  className="w-full h-10 px-3 py-2 rounded-md border border-input bg-background text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                                  value={item.component} 
                                  onChange={(e) => updateArrayItem("assessmentScheme", i, { component: e.target.value })}
                                >
                                  <option value="">-- Ch·ªçn --</option>
                                  <optgroup label="Th∆∞·ªùng xuy√™n">
                                    <option value="ƒê√°nh gi√° qu√° tr√¨nh">ƒê√°nh gi√° qu√° tr√¨nh</option>
                                    <option value="Tham gia l·ªõp">Tham gia l·ªõp</option>
                                    <option value="B√†i t·∫≠p v·ªÅ nh√†">B√†i t·∫≠p v·ªÅ nh√†</option>
                                  </optgroup>
                                  <optgroup label="ƒê·ªãnh k·ª≥">
                                    <option value="Ki·ªÉm tra l·∫ßn 1">Ki·ªÉm tra l·∫ßn 1</option>
                                    <option value="Ki·ªÉm tra gi·ªØa k·ª≥">Ki·ªÉm tra gi·ªØa k·ª≥</option>
                                    <option value="Th·ª±c h√†nh">Th·ª±c h√†nh</option>
                                  </optgroup>
                                  <optgroup label="T·ªïng k·∫øt">
                                    <option value="Thi cu·ªëi k·ª≥">Thi cu·ªëi k·ª≥</option>
                                    <option value="ƒê·ªì √°n/B√°o c√°o">ƒê·ªì √°n/B√°o c√°o</option>
                                  </optgroup>
                                </select>
                              </TableCell>
                              <TableCell className="align-top">
                                <Input 
                                  placeholder="V√≠ d·ª•: Tr·∫Øc nghi·ªám / V·∫•n ƒë√°p" 
                                  value={item.method} 
                                  onChange={(e) => updateArrayItem("assessmentScheme", i, { method: e.target.value })} 
                                />
                                <div className="mt-2">
                                  <Input 
                                    className="h-8 text-[11px] bg-slate-50/50" 
                                    placeholder="Ti√™u ch√≠ ƒë√°nh gi√°..." 
                                    value={item.criteria || ""} 
                                    onChange={(e) => updateArrayItem("assessmentScheme", i, { criteria: e.target.value })} 
                                  />
                                </div>
                              </TableCell>
                              <TableCell className="align-top">
                                <div className="flex flex-wrap gap-1.5 p-1 min-h-[40px]">
                                  {(data.clos || []).length > 0 ? (
                                    (data.clos || []).map((clo: any) => {
                                      const isSelected = item.clos?.split(',').map((s: string) => s.trim()).includes(clo.code);
                                      return (
                                        <Badge 
                                          key={clo.code} 
                                          variant={isSelected ? "default" : "outline"}
                                          className={`cursor-pointer transition-all select-none font-bold py-1 ${isSelected ? 'scale-105' : 'opacity-60 hover:opacity-100 hover:bg-slate-100'}`}
                                          onClick={() => {
                                            const currentClosArr = item.clos ? item.clos.split(',').map((s: string) => s.trim()).filter((s: string) => s) : [];
                                            const newClosArr = isSelected 
                                                ? currentClosArr.filter((c: string) => c !== clo.code)
                                                : [...currentClosArr, clo.code];
                                            updateArrayItem("assessmentScheme", i, { clos: newClosArr.join(', ') });
                                          }}
                                        >
                                          {clo.code}
                                        </Badge>
                                      );
                                    })
                                  ) : (
                                    <span className="text-[10px] text-slate-400 italic">Vui l√≤ng t·∫°o CLO tr∆∞·ªõc</span>
                                  )}
                                </div>
                              </TableCell>
                              <TableCell className="align-top">
                                <div className="relative">
                                  <Input 
                                    type="number" 
                                    className="pr-8 font-bold text-center"
                                    value={item.weight} 
                                    onChange={(e) => updateArrayItem("assessmentScheme", i, { weight: Number(e.target.value) })} 
                                  />
                                  <span className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs shadow-none">%</span>
                                </div>
                              </TableCell>
                              <TableCell className="align-top pt-3">
                                <Button 
                                  variant="ghost" 
                                  size="icon" 
                                  className="opacity-0 group-hover:opacity-100 transition-opacity hover:bg-rose-50 hover:text-rose-600"
                                  onClick={() => removeArrayItem("assessmentScheme", i)}
                                >
                                  <Trash2 className="w-4 h-4" />
                                </Button>
                              </TableCell>
                            </TableRow>
                          ))
                        )}
                      </TableBody>
                    </Table>
                  </div>
               </div>
            </TabsContent>

            <TabsContent value="plan" className="animate-in fade-in-50">
               <div className="mb-2"><label className="font-bold">7. K·∫ø ho·∫°ch gi·∫£ng d·∫°y v√† h·ªçc t·∫≠p</label></div><div className="border rounded-md overflow-hidden"><Table><TableHeader><TableRow><TableHead className="w-20">Tu·∫ßn</TableHead><TableHead className="w-1/3">N·ªôi dung</TableHead><TableHead className="w-24">CLOs</TableHead><TableHead>Ho·∫°t ƒë·ªông D·∫°y/H·ªçc</TableHead><TableHead className="w-32">ƒê√°nh gi√°</TableHead><TableHead className="w-10"></TableHead></TableRow></TableHeader><TableBody>{data.teachingPlan.map((row, i) => (<TableRow key={i}><TableCell className="align-top"><Input type="number" value={row.week} onChange={(e) => updateArrayItem("teachingPlan", i, { week: Number(e.target.value) })} /></TableCell><TableCell className="align-top"><Textarea className="min-h-[80px]" value={row.topic || ""} onChange={(e) => updateArrayItem("teachingPlan", i, { topic: e.target.value })} /></TableCell><TableCell className="align-top"><Input value={row.clos || ""} onChange={(e) => updateArrayItem("teachingPlan", i, { clos: e.target.value })} /></TableCell><TableCell className="align-top"><Textarea className="min-h-[80px]" value={row.activity || ""} onChange={(e) => updateArrayItem("teachingPlan", i, { activity: e.target.value })} /></TableCell><TableCell className="align-top"><Input value={row.assessment || ""} onChange={(e) => updateArrayItem("teachingPlan", i, { assessment: e.target.value })} /></TableCell><TableCell className="align-top"><Button variant="ghost" size="icon" onClick={() => removeArrayItem("teachingPlan", i)}>‚úï</Button></TableCell></TableRow>))}</TableBody></Table></div><Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("teachingPlan", { week: 1, topic: "", clos: "", activity: "", assessment: "" })}>+ Th√™m Tu·∫ßn / Ch∆∞∆°ng</Button>
            </TabsContent>

            <TabsContent value="materials">
                <MaterialsTab data={data} readOnly={!isEditable} onUpdate={(idx, val) => updateArrayItem("materials", idx, { title: val })} onAdd={(type) => addArrayItem("materials", { type: type, title: "" })} onRemove={(idx) => removeArrayItem("materials", idx)}/>
            </TabsContent>

            <TabsContent value="others" className="space-y-6 animate-in fade-in-50">
              <div className="bg-white p-6 rounded-md border shadow-sm"><label className="font-bold block mb-3 text-lg">9. Y√™u c·∫ßu kh√°c v·ªÅ h·ªçc ph·∫ßn</label><Textarea rows={8} className="resize-y" value={data.otherRequirements || ""} onChange={(e) => updateField("otherRequirements", e.target.value)} placeholder="V√≠ d·ª•: Sinh vi√™n ph·∫£i chu·∫©n b·ªã Laptop c√° nh√¢n..." /></div>
            </TabsContent>
            </div>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="apps/web/components/Types.ts">
export type SyllabusStatus = "Draft" | "Pending" | "Approved" | "Returned" | "Pending Approval" | "Published";

export interface SyllabusData {
  id?: number;
  // Required backend IDs
  subjectId?: number;
  programId?: number;
  academicYearId?: number;
  lecturerId?: number;
  headDepartmentId?: number;
  deanId?: number;
  
  status: SyllabusStatus;
  version?: string;
  dueDate?: string | null;
  assignedTo?: string | null;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  lecturer?: string | null;
  programName?: string | null;
  academicYearName?: string | null;
  feedback?: string | null;
  timeAllocation: {
    theory: number;
    exercises: number;
    practice: number;
    selfStudy: number;
  };
  prerequisites: string | null;
  preCourses: string | null;
  coCourses: string | null;
  courseType: string | null;
  componentType: string | null;
  description: string | null;
  objectives: string[];
  clos: { code: string; description: string }[];
  ploMapping: {
    cloCode: string;
    plos: { [key: string]: string };
  }[];
  studentDuties: string | null;
  assessmentScheme: {
    component: string;
    method: string;
    clos: string;
    criteria: string;
    weight: number;
  }[];
  teachingPlan: {
    week: number;
    topic: string;
    clos: string;
    activity: string;
    assessment: string;
  }[];
  materials: {
    type: "Main" | "Ref";
    title: string;
  }[];
  otherRequirements: string | null;
  datePrepared: string | null;
  dateEdited: string | null;
  headDepartment?: string | null;
  dean?: string | null;
}

export const defaultSyllabus: SyllabusData = {
  status: "Draft",
  // Set default IDs to undefined - user MUST select these
  subjectId: undefined,
  programId: undefined,
  academicYearId: undefined,
  lecturerId: undefined,
  headDepartmentId: undefined,
  deanId: undefined,
  
  subjectNameVi: "",
  subjectNameEn: "",
  subjectCode: "",
  credits: 3,
  timeAllocation: { theory: 0, exercises: 0, practice: 0, selfStudy: 0 },
  prerequisites: "",
  preCourses: "",
  coCourses: "",
  courseType: "B·∫Øt bu·ªôc",
  componentType: "C∆° s·ªü ng√†nh",
  description: "",
  objectives: [],
  clos: [],
  ploMapping: [],
  studentDuties: "",
  assessmentScheme: [],
  teachingPlan: [],
  materials: [],
  otherRequirements: "Kh√¥ng",
  datePrepared: new Date().toISOString().split('T')[0],
  dateEdited: new Date().toISOString().split('T')[0],
  lecturer: "",
  headDepartment: "",
  dean: ""
};
</file>

<file path="apps/web/components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="apps/web/components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="apps/web/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="apps/web/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="apps/web/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="apps/web/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="apps/web/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="apps/web/components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="apps/web/components/ui/sheet.tsx">
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="apps/web/components/ui/table.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="apps/web/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="apps/web/components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<
  HTMLTextAreaElement,
  React.ComponentProps<"textarea">
>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }
</file>

<file path="apps/web/Dockerfile">
# apps/web/Dockerfile
FROM node:20-alpine

WORKDIR /app

# Copy file package ƒë·ªÉ c√†i th∆∞ vi·ªán tr∆∞·ªõc
COPY package*.json ./

# T·∫Øt strict-ssl ƒë·ªÉ tr√°nh l·ªói m·∫°ng ECONNRESET n·∫øu m·∫°ng y·∫øu
RUN npm config set strict-ssl false

# C√†i ƒë·∫∑t th∆∞ vi·ªán (th√™m --legacy-peer-deps cho an to√†n)
RUN npm install --legacy-peer-deps

# Copy to√†n b·ªô code v√†o
COPY . .

# M·ªü port 3000
EXPOSE 3000

# Ch·∫°y ch·∫ø ƒë·ªô Dev
CMD ["npm", "run", "dev"]
</file>

<file path="apps/web/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="apps/web/lib/apiClient.ts">
export const API_BASE = process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000";

function isPlainObject(value: any) {
  return Object.prototype.toString.call(value) === "[object Object]";
}

function toSnakeCase(str: string) {
  return str.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);
}

function convertKeysToSnake(obj: any): any {
  if (Array.isArray(obj)) return obj.map(convertKeysToSnake);
  if (!isPlainObject(obj)) return obj;
  const out: any = {};
  for (const key of Object.keys(obj)) {
    const snakeKey = toSnakeCase(key);
    out[snakeKey] = convertKeysToSnake((obj as any)[key]);
  }
  return out;
}

export async function apiFetch(path: string, opts: {
  method?: string;
  body?: any;
  headers?: Record<string, string>;
  snake?: boolean; // convert body keys to snake_case when true (default for POST/PUT/PATCH)
} = {}) {
  const url = path.startsWith("http") ? path : `${API_BASE}${path.startsWith("/") ? path : `/${path}`}`;
  const token = (typeof window !== "undefined") ? localStorage.getItem("access_token") : null;

  const method = (opts.method || "GET").toUpperCase();
  const headers: Record<string, string> = {
    "Accept": "application/json",
    ...(opts.headers || {}),
  };

  if (token) headers["Authorization"] = `Bearer ${token}`;

  let body: any = undefined;
  if (opts.body !== undefined) {
    // If body is already a string, assume caller serialized it intentionally
    if (typeof opts.body === "string") {
      body = opts.body;
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    } else {
      const shouldSnake = opts.snake !== undefined ? opts.snake : (method === "POST" || method === "PUT" || method === "PATCH");
      const payload = shouldSnake ? convertKeysToSnake(opts.body) : opts.body;
      body = JSON.stringify(payload);
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    }
  }

  const res = await fetch(url, { method, headers, body });
  // If possible, parse JSON, else throw
  const text = await res.text();
  let json: any = null;
  try { json = text ? JSON.parse(text) : null; } catch (e) { /* not json */ }

  if (!res.ok) {
    const err: any = new Error(json?.detail || `Request failed: ${res.status}`);
    (err as any).status = res.status;
    (err as any).data = json;
    throw err;
  }

  return json;
}
</file>

<file path="apps/web/lib/axios.ts">
import axios, { AxiosRequestConfig, InternalAxiosRequestConfig } from "axios";

export const API_BASE = process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000";

function isPlainObject(value: any) {
  return Object.prototype.toString.call(value) === "[object Object]";
}

function toSnakeCase(str: string) {
  return str.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);
}

function convertKeysToSnake(obj: any): any {
  if (Array.isArray(obj)) return obj.map(convertKeysToSnake);
  if (!isPlainObject(obj)) return obj;
  const out: any = {};
  for (const key of Object.keys(obj)) {
    const snakeKey = toSnakeCase(key);
    out[snakeKey] = convertKeysToSnake((obj as any)[key]);
  }
  return out;
}

function toCamelCase(str: string) {
  return str.replace(/([-_][a-z])/ig, ($1) => {
    return $1.toUpperCase()
      .replace('-', '')
      .replace('_', '');
  });
}

function convertKeysToCamel(obj: any): any {
  if (Array.isArray(obj)) return obj.map(convertKeysToCamel);
  if (!isPlainObject(obj)) return obj;
  const out: any = {};
  for (const key of Object.keys(obj)) {
    const camelKey = toCamelCase(key);
    out[camelKey] = convertKeysToCamel((obj as any)[key]);
  }
  return out;
}

// Extend InternalAxiosRequestConfig to support skipSnake and skipCamel option
export interface CustomAxiosRequestConfig extends InternalAxiosRequestConfig<any> {
  skipSnake?: boolean;
  skipCamel?: boolean;
}

const instance = axios.create({
  baseURL: API_BASE,
  headers: { Accept: "application/json" },
});

// Request interceptor: attach Authorization and convert body keys to snake_case
instance.interceptors.request.use((config: CustomAxiosRequestConfig) => {
  try {
    // Attach token if in browser
    if (typeof window !== "undefined") {
      const token = localStorage.getItem("access_token");
      if (token && config.headers) {
        // Use standard header setting
        config.headers.Authorization = `Bearer ${token}`;
        console.debug("Requesting with token:", config.url);
      }
    }

    const method = (config.method || "get").toLowerCase();
    const shouldSnake = config.skipSnake === true ? false : (method === "post" || method === "put" || method === "patch");

    if (shouldSnake && config.data && isPlainObject(config.data)) {
      config.data = convertKeysToSnake(config.data);
    }
  } catch (e) {
    // ignore
    console.error("axios request interceptor error", e);
  }
  return config;
});

// Response interceptor: handle errors and convert body keys to camelCase
instance.interceptors.response.use(
  (res) => {
    const config = res.config as CustomAxiosRequestConfig;
    if (config.skipCamel !== true && res.data && (isPlainObject(res.data) || Array.isArray(res.data))) {
      res.data = convertKeysToCamel(res.data);
    }
    return res;
  },
  (err) => {
    // Handle 401 Unauthorized - token expired
    if (err.response?.status === 401) {
      console.error("‚ö†Ô∏è B·ªã l·ªói 401 ·ªü ƒë√¢y n√®:", err.config?.url);
      if (typeof window !== "undefined") {
        const currentPath = window.location.pathname;
        // Don't redirect if already on login page
        if (currentPath !== "/login") {
          // localStorage.removeItem("access_token");
          // localStorage.removeItem("refresh_token");
          // localStorage.removeItem("role");
          // window.location.href = "/login";
        }
      }
    }
    
    // Handle 403 Forbidden - no permission
    if (err.response?.status === 403) {
      const message = err.response?.data?.message || "B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y";
      console.warn("403 Forbidden:", message);
      
      // Add user-friendly message to error for components to use
      err.userMessage = message;
    }
    
    return Promise.reject(err);
  }
);

export default instance;
</file>

<file path="apps/web/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="apps/web/next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
</file>

<file path="apps/web/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="apps/web/package.json">
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-tabs": "^1.1.13",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.561.0",
    "next": "16.0.10",
    "react": "19.2.1",
    "react-dom": "19.2.1",
    "react-to-print": "^3.2.0",
    "recharts": "^3.6.0",
    "socket.io-client": "^4.7.2",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="apps/web/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="apps/web/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="apps/web/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="apps/web/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="apps/web/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="apps/web/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="apps/web/scripts/test_api.js">
(async () => {
  const base = process.env.API_BASE || 'http://localhost:9999';
  console.log('Testing API at', base);
  try {
    const loginRes = await fetch(`${base}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: 'admin', password: '123456' }),
    });

    let loginBody = null;
    try { loginBody = await loginRes.json(); } catch (e) { /* ignore */ }
    console.log('LOGIN status=', loginRes.status);
    console.log('LOGIN body=', loginBody);

    if (loginBody && loginBody.access_token) {
      const token = loginBody.access_token;
      const meRes = await fetch(`${base}/users/me`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      let meBody = null;
      try { meBody = await meRes.json(); } catch (e) { /* ignore */ }
      console.log('/users/me status=', meRes.status);
      console.log('/users/me body=', meBody);
    } else {
      console.log('No access_token returned from login. Cannot test /users/me.');
    }
  } catch (err) {
    console.error('Error during API test:', err);
  }
})();
</file>

<file path="apps/web/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

</files>
