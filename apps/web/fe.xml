This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/(auth)/login/page.tsx
app/(main)/admin/logs/page.tsx
app/(main)/admin/settings/page.tsx
app/(main)/admin/users/page.tsx
app/(main)/layout.tsx
app/(main)/page.tsx
app/(main)/profile/page.tsx
app/(main)/reviews/page.tsx
app/(main)/syllabus/[id]/edit/page.tsx
app/(main)/syllabus/[id]/page.tsx
app/(main)/syllabus/compare/page.tsx
app/(main)/syllabus/create/page.tsx
app/(public)/layout.tsx
app/(public)/portal/[id]/page.tsx
app/(public)/portal/page.tsx
app/favicon.ico
app/globals.css
app/layout.tsx
components.json
components/DashboardCharts.tsx
components/Header.tsx
components/Sidebar.tsx
components/syllabus-form/MaterialsTab.tsx
components/SyllabusDeleteButton.tsx
components/SyllabusDetailView.tsx
components/SyllabusEditForm.tsx
components/Types.ts
components/ui/alert-dialog.tsx
components/ui/avatar.tsx
components/ui/badge.tsx
components/ui/button.tsx
components/ui/card.tsx
components/ui/dialog.tsx
components/ui/input.tsx
components/ui/popover.tsx
components/ui/sheet.tsx
components/ui/table.tsx
components/ui/tabs.tsx
components/ui/textarea.tsx
Dockerfile
eslint.config.mjs
lib/apiClient.ts
lib/axios.ts
lib/utils.ts
next-env.d.ts
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
scripts/test_api.js
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/(auth)/login/page.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { AlertCircle } from "lucide-react";
import axios from "@/lib/axios";

export default function LoginPage() {
  const router = useRouter();
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    try {
      // Use API client and backend contract: POST /auth/login with JSON
      const res = await axios.post("/auth/login", { username, password }, { skipSnake: true } as any);
      const data = res.data;

      // Save tokens as specified by contract
      if (data.access_token) localStorage.setItem("access_token", data.access_token);
      if (data.refresh_token) localStorage.setItem("refresh_token", data.refresh_token);

      // Fetch user info to get role
      try {
        const userRes = await axios.get("/users/me");
        const user = userRes.data;
        if (user?.role) localStorage.setItem("role", user.role);
        if (user?.role === "Student") router.push("/portal");
        else router.push("/");
      } catch (e) {
        // If user info not available, fallback to homepage
        router.push("/");
      }
    
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-slate-50">
      {/* ĐỔI BORDER TOP COLOR */}
      <Card className="w-full max-w-md shadow-xl border-t-4 border-t-teal-600">
        <CardHeader className="text-center pb-2">
          {/* ĐỔI MÀU ICON NỀN */}
          <div className="mx-auto w-12 h-12 bg-teal-50 rounded-lg flex items-center justify-center mb-4">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-teal-600"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
          </div>
          <CardTitle className="text-2xl font-bold text-slate-800">Đăng nhập Hệ thống</CardTitle>
          <p className="text-sm text-slate-500">Syllabus Management System</p>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleLogin} className="space-y-4">
            {error && (
                <div className="flex items-center gap-2 text-red-600 bg-red-50 p-3 rounded-md text-sm border border-red-100">
                    <AlertCircle className="w-4 h-4" /> {error}
                </div>
            )}
            
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">Tên đăng nhập</label>
              <Input 
                value={username} 
                onChange={(e) => setUsername(e.target.value)} 
                placeholder="Ví dụ: gv1, hod1, sv1..." 
                required 
                className="h-10"
              />
            </div>
            
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">Mật khẩu</label>
              <Input 
                type="password" 
                value={password} 
                onChange={(e) => setPassword(e.target.value)} 
                placeholder="••••••" 
                required 
                className="h-10"
              />
            </div>

            {/* ĐỔI MÀU NÚT SUBMIT */}
            <Button type="submit" className="w-full bg-teal-600 hover:bg-teal-700 h-10 text-base" disabled={loading}>
              {loading ? "Đang xử lý..." : "Đăng nhập"}
            </Button>

            <div className="text-xs text-center text-slate-400 mt-6 pt-4 border-t">
                <p className="mb-1 font-semibold">Tài khoản mặc định:</p>
                Admin: <b>admin</b> | Trưởng bộ môn: <b>hod1</b><br/>
                Giảng viên: <b>gv1</b> | Sinh viên: <b>sv1</b> <br/>
                Phòng đào tạo: <b>aa1</b> <br/>
                (Mật khẩu chung: 123456)
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="app/(main)/admin/logs/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card } from "@/components/ui/card";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { FileClock, Loader2, RefreshCcw } from "lucide-react";
import { Button } from "@/components/ui/button";

interface Log {
  id: number;
  timestamp: string;
  username: string;
  action: string;
  details: string;
}

export default function SystemLogsPage() {
  const [logs, setLogs] = useState<Log[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchLogs = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/admin/logs?limit=50');
      const data = res.data;
      setLogs(data || []);
    } catch (e: any) {
      const status = e?.response?.status || e?.status;
      if (status === 403) alert("Bạn không có quyền truy cập!");
      else console.error(e);
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchLogs(); }, []);

  const getActionColor = (action: string) => {
      if (action === "LOGIN") return "bg-blue-100 text-blue-700 border-blue-200";
      if (action.includes("DELETE")) return "bg-red-100 text-red-700 border-red-200";
      if (action.includes("APPROVE")) return "bg-green-100 text-green-700 border-green-200";
      if (action.includes("CREATE")) return "bg-purple-100 text-purple-700 border-purple-200";
      return "bg-gray-100 text-gray-700";
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                <FileClock className="w-6 h-6 text-orange-600"/> Nhật ký Hệ thống
            </h2>
            <p className="text-sm text-muted-foreground mt-1">Theo dõi hoạt động của người dùng (50 bản ghi gần nhất)</p>
        </div>
        <Button variant="outline" onClick={fetchLogs}><RefreshCcw className="w-4 h-4 mr-2"/> Làm mới</Button>
      </div>

      <Card>
        <Table>
            <TableHeader>
                <TableRow>
                    <TableHead className="w-[180px]">Thời gian</TableHead>
                    <TableHead>Người thực hiện</TableHead>
                    <TableHead>Hành động</TableHead>
                    <TableHead>Chi tiết</TableHead>
                </TableRow>
            </TableHeader>
            <TableBody>
                {loading ? (
                    <TableRow><TableCell colSpan={4} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> Đang tải dữ liệu...</TableCell></TableRow>
                ) : logs.length === 0 ? (
                    <TableRow><TableCell colSpan={4} className="text-center h-24 text-muted-foreground">Chưa có nhật ký nào.</TableCell></TableRow>
                ) : (
                    logs.map(log => (
                        <TableRow key={log.id}>
                            <TableCell className="text-xs text-gray-500 font-mono">
                                {new Date(log.timestamp).toLocaleString('vi-VN')}
                            </TableCell>
                            <TableCell className="font-bold text-sm">{log.username}</TableCell>
                            <TableCell>
                                <Badge variant="outline" className={getActionColor(log.action)}>
                                    {log.action}
                                </Badge>
                            </TableCell>
                            <TableCell className="text-sm text-gray-600">{log.details}</TableCell>
                        </TableRow>
                    ))
                )}
            </TableBody>
        </Table>
      </Card>
    </div>
  );
}
</file>

<file path="app/(main)/admin/settings/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { CheckCircle, Settings, Plus, Loader2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface AcademicYear {
  id: number;
  code: string;
  name: string;
  is_active: boolean;
}

export default function SettingsPage() {
  const [years, setYears] = useState<AcademicYear[]>([]);
  const [loading, setLoading] = useState(true);
  const [newYear, setNewYear] = useState({ code: "", name: "" });

  const fetchYears = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/admin/academic-years');
      const data = res.data;
      setYears(data || []);
    } catch (e) { console.error(e); } 
    finally { setLoading(false); }
  };

  useEffect(() => { fetchYears(); }, []);

  const handleCreate = async () => {
    if (!newYear.code || !newYear.name) return alert("Vui lòng nhập đủ thông tin");
    try {
      await axios.post('/admin/academic-years', { code: newYear.code, name: newYear.name });
      alert("Thêm thành công!");
      setNewYear({ code: "", name: "" });
      fetchYears();
    } catch (e: any) { const message = e?.response?.data?.detail || e?.message || "Lỗi kết nối"; alert("Lỗi: " + message); }
  };

  const handleActivate = async (id: number) => {
      try {
          await axios.post(`/admin/academic-years/${id}/activate`);
          alert("Đã kích hoạt năm học mới!");
          fetchYears();
          // Reload trang để Header cập nhật lại
          window.location.reload();
      } catch(e: any) { const message = e?.response?.data?.detail || e?.message || "Lỗi kết nối"; alert("Lỗi: " + message); }
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
            <Settings className="w-6 h-6 text-slate-700"/> Cấu hình Hệ thống
        </h2>
        <p className="text-sm text-muted-foreground mt-1">Quản lý năm học và các tham số hệ thống.</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* FORM THÊM MỚI */}
        <Card className="md:col-span-1 h-fit">
            <CardHeader><CardTitle>Thêm Năm học mới</CardTitle></CardHeader>
            <CardContent className="space-y-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">Mã Năm học (Code)</label>
                    <Input placeholder="2026-2027" value={newYear.code} onChange={e => setNewYear({...newYear, code: e.target.value})} />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Tên hiển thị</label>
                    <Input placeholder="Năm học 2026 - 2027" value={newYear.name} onChange={e => setNewYear({...newYear, name: e.target.value})} />
                </div>
                <Button className="w-full mt-2" onClick={handleCreate}>
                    <Plus className="w-4 h-4 mr-2"/> Thêm mới
                </Button>
            </CardContent>
        </Card>

        {/* DANH SÁCH */}
        <Card className="md:col-span-2">
            <CardHeader><CardTitle>Danh sách Năm học</CardTitle></CardHeader>
            <CardContent>
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>Code</TableHead>
                            <TableHead>Tên hiển thị</TableHead>
                            <TableHead>Trạng thái</TableHead>
                            <TableHead className="text-right">Hành động</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {loading ? (
                            <TableRow><TableCell colSpan={4} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> Đang tải...</TableCell></TableRow>
                        ) : years.map(y => (
                            <TableRow key={y.id} className={y.is_active ? "bg-green-50" : ""}>
                                <TableCell className="font-mono font-bold">{y.code}</TableCell>
                                <TableCell>{y.name}</TableCell>
                                <TableCell>
                                    {y.is_active ? (
                                        <Badge className="bg-green-600 hover:bg-green-700">Đang kích hoạt</Badge>
                                    ) : (
                                        <Badge variant="outline">Không hoạt động</Badge>
                                    )}
                                </TableCell>
                                <TableCell className="text-right">
                                    {!y.is_active && (
                                        <Button size="sm" variant="outline" onClick={() => handleActivate(y.id)}>
                                            <CheckCircle className="w-4 h-4 mr-2 text-green-600"/> Kích hoạt
                                        </Button>
                                    )}
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="app/(main)/admin/users/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Trash2, Plus, Users, Loader2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";

interface User {
  id: number;
  username: string;
  full_name: string;
  role: string;
}

export default function UserManagementPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  const [open, setOpen] = useState(false); // Modal state

  // Form state
  const [formData, setFormData] = useState({ username: "", password: "", full_name: "", role: "Lecturer" });

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const res = await axios.get('/admin/users');
      const data = res.data;
      setUsers(data || []);
    } catch (e: any) {
      const status = e?.response?.status || e?.status;
      if (status === 403) alert("Bạn không có quyền truy cập trang này!");
      else console.error(e);
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchUsers(); }, []);

  const handleCreate = async () => {
    if (!formData.username || !formData.password) return alert("Vui lòng nhập đủ thông tin!");
    try {
        await axios.post('/admin/users', { username: formData.username, password: formData.password, fullName: formData.full_name, role: formData.role });
        alert("Tạo tài khoản thành công!");
        setOpen(false);
        setFormData({ username: "", password: "", full_name: "", role: "Lecturer" });
        fetchUsers();
    } catch (e: any) { const message = e?.response?.data?.detail || e?.message || "Lỗi kết nối server"; alert("Lỗi: " + message); }
  };

  const handleDelete = async (id: number) => {
      if (!confirm("Hành động này không thể hoàn tác. Bạn chắc chắn muốn xóa user này?")) return;
      try {
          await axios.delete(`/admin/users/${id}`);
          alert("Đã xóa thành công!");
          fetchUsers();
      } catch (e: any) { const message = e?.response?.data?.detail || e?.message; alert("Lỗi: " + message); }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                <Users className="w-6 h-6 text-blue-600"/> Quản trị Người dùng
            </h2>
            <p className="text-sm text-muted-foreground mt-1">Quản lý danh sách tài khoản truy cập hệ thống</p>
        </div>
        
        {/* MODAL THÊM USER */}
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button className="bg-blue-600 hover:bg-blue-700">
                    <Plus className="w-4 h-4 mr-2"/> Thêm tài khoản
                </Button>
            </DialogTrigger>
            <DialogContent>
                <DialogHeader><DialogTitle>Tạo tài khoản mới</DialogTitle></DialogHeader>
                <div className="space-y-4 py-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Họ và tên</label>
                        <Input value={formData.full_name} onChange={e => setFormData({...formData, full_name: e.target.value})} placeholder="VD: Nguyễn Văn A" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Username</label>
                            <Input value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} placeholder="VD: gv_moi" />
                        </div>
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Password</label>
                            <Input value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="******" />
                        </div>
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Vai trò</label>
                        <select 
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background"
                            value={formData.role} 
                            onChange={e => setFormData({...formData, role: e.target.value})}
                        >
                            <option value="Lecturer">Giảng viên (Lecturer)</option>
                            <option value="Head of Dept">Trưởng bộ môn (Head of Dept)</option>
                            <option value="Student">Sinh viên (Student)</option>
                            <option value="Admin">Quản trị viên (Admin)</option>
                        </select>
                    </div>
                    <Button className="w-full mt-4 bg-blue-600 hover:bg-blue-700" onClick={handleCreate}>Xác nhận tạo</Button>
                </div>
            </DialogContent>
        </Dialog>
      </div>

      <Card>
        <Table>
            <TableHeader>
                <TableRow>
                    <TableHead className="w-[80px]">ID</TableHead>
                    <TableHead>Tài khoản</TableHead>
                    <TableHead>Họ tên hiển thị</TableHead>
                    <TableHead>Vai trò</TableHead>
                    <TableHead className="text-right">Hành động</TableHead>
                </TableRow>
            </TableHeader>
            <TableBody>
                {loading ? (
                    <TableRow><TableCell colSpan={5} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> Đang tải danh sách...</TableCell></TableRow>
                ) : users.length === 0 ? (
                    <TableRow><TableCell colSpan={5} className="text-center h-24 text-muted-foreground">Chưa có người dùng nào.</TableCell></TableRow>
                ) : (
                    users.map(u => (
                        <TableRow key={u.id}>
                            <TableCell className="font-mono text-xs text-gray-500">#{u.id}</TableCell>
                            <TableCell className="font-bold">{u.username}</TableCell>
                            <TableCell>{u.full_name}</TableCell>
                            <TableCell>
                                <Badge variant="outline" className={
                                    u.role === 'Admin' ? 'border-red-200 bg-red-50 text-red-700' :
                                    u.role === 'Student' ? 'border-green-200 bg-green-50 text-green-700' : 
                                    'border-blue-200 bg-blue-50 text-blue-700'
                                }>
                                    {u.role}
                                </Badge>
                            </TableCell>
                            <TableCell className="text-right">
                                <Button variant="ghost" size="icon" onClick={() => handleDelete(u.id)} className="text-gray-400 hover:text-red-600 hover:bg-red-50" title="Xóa người dùng">
                                    <Trash2 className="w-4 h-4"/>
                                </Button>
                            </TableCell>
                        </TableRow>
                    ))
                )}
            </TableBody>
        </Table>
      </Card>
    </div>
  );
}
</file>

<file path="app/(main)/layout.tsx">
// apps/web/app/(main)/layout.tsx
import Sidebar from "@/components/Sidebar";
import Header from "@/components/Header";

export default function MainLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <div className="min-h-screen">
      {/* Sidebar cố định */}
      <div>
        <Sidebar />
      </div>

      {/* Khu vực nội dung chính */}
      <div className="md:pl-64 min-h-screen flex flex-col">
        <Header />
        <main className="p-6 flex-1 bg-gray-50/50">
          {children}
        </main>
      </div>
    </div>
  );
}
</file>

<file path="app/(main)/page.tsx">
"use client";

import React, { useEffect, useState, useCallback } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "@/components/ui/table";
import { Edit, Eye, GitCompare, Loader2, RefreshCcw } from "lucide-react";
import SyllabusDeleteButton from "@/components/SyllabusDeleteButton"; 
import DashboardCharts from "@/components/DashboardCharts";
import axios from "@/lib/axios";

interface Syllabus {
  id: number;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  status: string;
  version: string;
  lecturer: string;
  dateEdited: string;
}

export default function Dashboard() {
  const router = useRouter();
  
  const [syllabuses, setSyllabuses] = useState<Syllabus[]>([]);
  const [total, setTotal] = useState(0);
  const [totalPages, setTotalPages] = useState(1);
  const [loading, setLoading] = useState(true);
  const [statsData, setStatsData] = useState(null);
  
  const [currentPage, setCurrentPage] = useState(1);
  const [searchTerm, setSearchTerm] = useState("");

  const fetchData = useCallback(async (page: number, keyword: string) => {
    setLoading(true);

    try {
      const query = new URLSearchParams({ page: page.toString(), limit: "10", search: keyword });
      const listRes = await axios.get(`/syllabuses?${query.toString()}`);
      const list = listRes.data;
      setSyllabuses(list.data || []);
      setTotal(list.total || 0);
      setTotalPages(list.total_pages || 1);

      try {
        const statsRes = await axios.get(`/stats`);
        const stats = statsRes.data;
        setStatsData(stats);
      } catch (e) {
        // ignore stats error
      }

    } catch (err: any) {
      console.error(err);
      if (err?.response?.status === 401 || err?.status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("role");
        router.push("/login");
        return;
      }
    } finally { setLoading(false); }
  }, [router]);

  useEffect(() => {
    const timer = setTimeout(() => fetchData(currentPage, searchTerm), 500);
    return () => clearTimeout(timer);
  }, [searchTerm, currentPage, fetchData]);

  const renderStatusBadge = (status: string) => {
    let color = "bg-gray-500";
    let label = status;
    
    switch (status) {
        case "Approved": color = "bg-green-600"; break;
        case "Pending": color = "bg-yellow-500"; label = "Pending Review"; break;
        case "Pending Approval": color = "bg-orange-500"; label = "Pending AA"; break; 
        case "Returned": color = "bg-red-500"; break;
        case "Draft": color = "bg-slate-500"; break;
    }
    return <Badge className={color}>{label}</Badge>;
  };

  return (
    <div className="space-y-8">
      
      <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-2xl font-bold tracking-tight">Dashboard Overview</h2>
            <p className="text-sm text-muted-foreground">Tổng quan hệ thống thời gian thực</p>
          </div>
          <DashboardCharts data={statsData} />
      </section>

      <section className="space-y-4">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t pt-8">
            <div>
                <h3 className="text-xl font-bold tracking-tight">Quản lý Đề cương</h3>
                <p className="text-sm text-muted-foreground">Danh sách chi tiết các học phần</p>
            </div>
            <div className="w-full md:w-1/3 flex gap-2">
              <Input
                placeholder="Tìm kiếm theo tên hoặc mã HP..."
                value={searchTerm}
                onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                className="bg-white"
              />
              <Button variant="outline" size="icon" onClick={() => fetchData(currentPage, searchTerm)} title="Làm mới">
                  <RefreshCcw className="w-4 h-4"/>
              </Button>
            </div>
          </div>

          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-[100px]">Mã HP</TableHead>
                  <TableHead>Tên Học Phần</TableHead>
                  <TableHead>Phiên bản</TableHead>
                  <TableHead>Tín chỉ</TableHead>
                  <TableHead>Giảng viên</TableHead>
                  <TableHead>Trạng thái</TableHead>
                  <TableHead className="text-right">Hành động</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {loading && syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center">
                      <div className="flex justify-center items-center gap-2">
                        <Loader2 className="animate-spin w-4 h-4" /> Đang tải dữ liệu...
                      </div>
                    </TableCell>
                  </TableRow>
                ) : syllabuses.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={7} className="h-24 text-center text-muted-foreground">
                      Không tìm thấy đề cương nào.
                    </TableCell>
                  </TableRow>
                ) : (
                  syllabuses.map((s) => (
                    <TableRow key={s.id}>
                      <TableCell className="font-bold">{s.subjectCode}</TableCell>
                      <TableCell>
                        <div className="font-medium">{s.subjectNameVi || "(Chưa có tên)"}</div>
                        <div className="text-xs text-muted-foreground truncate max-w-[200px]">{s.subjectNameEn}</div>
                      </TableCell>
                      <TableCell><Badge variant="outline" className="bg-slate-50">v{s.version || "1.0"}</Badge></TableCell>
                      <TableCell>{s.credits}</TableCell>
                      <TableCell className="text-sm text-gray-600">{s.lecturer}</TableCell>
                      <TableCell>{renderStatusBadge(s.status)}</TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2 items-center">
                            <Link href={`/syllabus/compare?baseId=${s.id - 1}&targetId=${s.id}`}>
                                <Button variant="outline" size="icon" title="So sánh bản cũ"><GitCompare className="w-4 h-4 text-orange-600" /></Button>
                            </Link>
                            <Link href={`/syllabus/${s.id}`}>
                                <Button variant="ghost" size="icon" title="Xem chi tiết"><Eye className="w-4 h-4" /></Button>
                            </Link>
                            {(s.status === "Draft" || s.status === "Returned") && (
                                <Link href={`/syllabus/${s.id}/edit`}>
                                    {/* SỬA: text-blue-600 -> text-teal-600 */}
                                    <Button variant="ghost" size="icon" title="Chỉnh sửa"><Edit className="w-4 h-4 text-teal-600" /></Button>
                                </Link>
                            )}
                            {s.status === "Draft" && (
                                <div className="scale-90"><SyllabusDeleteButton id={s.id} /></div>
                            )}
                        </div>
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
            
            <div className="flex items-center justify-between px-4 py-4 border-t">
              <div className="text-sm text-muted-foreground">Trang {currentPage} / {totalPages}</div>
              <div className="flex gap-2">
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage <= 1}>Trước</Button>
                <Button variant="outline" size="sm" onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage >= totalPages}>Sau</Button>
              </div>
            </div>
          </Card>
      </section>
    </div>
  );
}
</file>

<file path="app/(main)/profile/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { User, Shield, Key, Save } from "lucide-react";

interface UserProfile {
  id: number;
  username: string;
  full_name: string;
  role: string;
}

export default function ProfilePage() {
  const [user, setUser] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);

  // State cho form đổi mật khẩu
  const [passData, setPassData] = useState({ current: "", new: "", confirm: "" });
  const [passLoading, setPassLoading] = useState(false);

  useEffect(() => {
    const fetchProfile = async () => {
        try {
            const userRes = await axios.get('/users/me');
            const userData = userRes.data;
            setUser(userData);
        } catch (e) { console.error(e); }
        finally { setLoading(false); }
    };
    fetchProfile();
  }, []);

  const handleChangePassword = async () => {
      // Validate cơ bản
      if (!passData.current || !passData.new) return alert("Vui lòng nhập đầy đủ thông tin");
      if (passData.new !== passData.confirm) return alert("Mật khẩu mới không khớp");
      if (passData.new.length < 6) return alert("Mật khẩu mới phải từ 6 ký tự trở lên");

      setPassLoading(true);
      try {
          await axios.post('/users/change-password', { currentPassword: passData.current, newPassword: passData.new });
          alert("Thành công! Mật khẩu đã được thay đổi.");
          setPassData({ current: "", new: "", confirm: "" }); // Reset form
      } catch (err: any) {
          console.error(err);
          const message = err?.response?.data?.detail || err?.message || "Lỗi kết nối server";
          alert("Lỗi: " + message);
      } finally {
          setPassLoading(false);
      }
  };

  if (loading) return <div className="p-8 text-center">Đang tải thông tin...</div>;
  if (!user) return <div className="p-8 text-center">Không tìm thấy thông tin người dùng.</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
        <h2 className="text-2xl font-bold tracking-tight">Hồ sơ cá nhân</h2>
        
        <div className="grid gap-6 md:grid-cols-3">
            {/* Cột trái: Avatar */}
            <Card className="md:col-span-1">
                <CardContent className="pt-6 flex flex-col items-center text-center">
                    <Avatar className="w-24 h-24 mb-4 border-4 border-slate-50">
                        <AvatarImage src={`https://ui-avatars.com/api/?name=${user.full_name}&background=0D8ABC&color=fff`} />
                        <AvatarFallback>User</AvatarFallback>
                    </Avatar>
                    <h3 className="font-bold text-xl">{user.full_name}</h3>
                    <div className="text-sm text-muted-foreground mb-4">@{user.username}</div>
                    <div className="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium border border-blue-200">
                        <Shield className="w-3 h-3 mr-1"/> {user.role}
                    </div>
                </CardContent>
            </Card>

            {/* Cột phải: Thông tin & Đổi Pass */}
            <div className="md:col-span-2 space-y-6">
                {/* Thông tin chung */}
                <Card>
                    <CardHeader>
                        <CardTitle>Thông tin tài khoản</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <label className="text-sm font-medium flex items-center gap-2 text-slate-600"><User className="w-4 h-4"/> Họ và tên</label>
                            <Input value={user.full_name} readOnly className="bg-slate-50"/>
                        </div>
                        <div className="space-y-2">
                            <label className="text-sm font-medium flex items-center gap-2 text-slate-600"><Key className="w-4 h-4"/> Tên đăng nhập</label>
                            <Input value={user.username} readOnly className="bg-slate-50"/>
                        </div>
                    </CardContent>
                </Card>

                {/* Form đổi mật khẩu */}
                <Card>
                    <CardHeader>
                        <CardTitle>Đổi mật khẩu</CardTitle>
                        <CardDescription>Để bảo mật, vui lòng không chia sẻ mật khẩu cho người khác.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Mật khẩu hiện tại</label>
                            <Input 
                                type="password" 
                                value={passData.current}
                                onChange={e => setPassData({...passData, current: e.target.value})}
                                placeholder="••••••"
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <label className="text-sm font-medium">Mật khẩu mới</label>
                                <Input 
                                    type="password"
                                    value={passData.new}
                                    onChange={e => setPassData({...passData, new: e.target.value})}
                                    placeholder="••••••"
                                />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-medium">Nhập lại mới</label>
                                <Input 
                                    type="password"
                                    value={passData.confirm}
                                    onChange={e => setPassData({...passData, confirm: e.target.value})}
                                    placeholder="••••••"
                                />
                            </div>
                        </div>
                        <div className="flex justify-end pt-2">
                            <Button onClick={handleChangePassword} disabled={passLoading}>
                                {passLoading ? "Đang xử lý..." : <><Save className="w-4 h-4 mr-2" /> Lưu thay đổi</>}
                            </Button>
                        </div>
                    </CardContent>
                </Card>
            </div>
        </div>
    </div>
  );
}
</file>

<file path="app/(main)/reviews/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from "@/components/ui/table";
import { Loader2, FileSignature, CheckCircle, XCircle, ArrowRight } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import axios from "@/lib/axios";

interface Syllabus {
  id: number;
  subjectNameVi: string;
  subjectCode: string;
  lecturer: string;
  dateEdited: string;
  status: string;
  version: string;
  headDepartment?: string; // Tên trưởng bộ môn đã duyệt
}

export default function ReviewPage() {
  const [reviews, setReviews] = useState<Syllabus[]>([]);
  const [loading, setLoading] = useState(true);
  const [userRole, setUserRole] = useState("");
  
  // State cho Modal từ chối
  const [rejectId, setRejectId] = useState<number | null>(null);
  const [rejectReason, setRejectReason] = useState("");
  const [processing, setProcessing] = useState(false);

  const fetchReviews = async () => {
    setLoading(true);
    const role = localStorage.getItem("role") || "";
    setUserRole(role);

    // Determine status to fetch based on role
    let statusToFetch = "Pending";
    if (role === "Academic Affairs") statusToFetch = "Pending Approval";
    else if (role === "Admin") statusToFetch = "";

    try {
      const url = statusToFetch ? `/syllabuses?status=${encodeURIComponent(statusToFetch)}&limit=100` : `/syllabuses?limit=100`;
      const res = await axios.get(url);
      const data = res.data;
      setReviews(data.data || []);
    } catch (err: any) {
      console.error(err);
      const status = err?.response?.status || err?.status;
      if (status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("role");
        window.location.href = "/login";
      }
    } finally { setLoading(false); }
  };

  useEffect(() => { fetchReviews(); }, []);

  const handleApprove = async (id: number) => {
      // Đổi thông báo tùy theo role
      const msg = userRole === "Head of Dept" 
        ? "Xác nhận duyệt và chuyển lên Phòng Đào tạo?" 
        : "Xác nhận PHÊ DUYỆT CUỐI CÙNG và công bố?";

      if(!confirm(msg)) return;
      
      try {
          await axios.post(`/syllabuses/${id}/approve`);
          alert("Thành công!");
          fetchReviews();
      } catch(e: any) {
          const status = e?.response?.status || e?.status;
          if (status === 401) { alert("Phiên đăng nhập hết hạn."); window.location.href = "/login"; return; }
          const message = e?.response?.data?.detail || e?.message;
          alert(message || "Lỗi kết nối");
      }
  };

  const handleRejectSubmit = async () => {
      if (!rejectId || !rejectReason.trim()) return alert("Vui lòng nhập lý do từ chối!");
      
      setProcessing(true);
      try {
          await axios.post(`/syllabuses/${rejectId}/reject`, { reason: rejectReason });
          alert("Đã trả về yêu cầu sửa!");
          setRejectId(null);
          setRejectReason("");
          fetchReviews();
      } catch(e: any) {
          const message = e?.response?.data?.detail || e?.message;
          alert(message || "Lỗi kết nối");
      } finally { setProcessing(false); }
  };

  // Xác định tiêu đề trang dựa trên Role
  const pageTitle = userRole === "Academic Affairs" 
    ? "Phê duyệt cấp Trường (Phòng Đào tạo)" 
    : "Phê duyệt cấp Bộ môn";

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
            <h2 className="text-2xl font-bold tracking-tight">{pageTitle}</h2>
            <p className="text-sm text-muted-foreground">
                {userRole === "Academic Affairs" 
                    ? "Danh sách các đề cương đã được Trưởng bộ môn thông qua." 
                    : "Danh sách các đề cương đang chờ duyệt."}
            </p>
        </div>
        <Badge variant="secondary" className="text-base px-4 py-2 bg-yellow-100 text-yellow-800 hover:bg-yellow-200">
          Chờ xử lý: {reviews.length}
        </Badge>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileSignature className="w-5 h-5"/> Danh sách chờ duyệt
          </CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Mã HP</TableHead>
                <TableHead>Tên Học Phần</TableHead>
                <TableHead>Phiên bản</TableHead>
                <TableHead>Người gửi</TableHead>
                {userRole === "Academic Affairs" && <TableHead>Trưởng BM duyệt</TableHead>}
                <TableHead>Ngày cập nhật</TableHead>
                <TableHead className="text-right">Hành động</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow><TableCell colSpan={7} className="text-center h-24"><Loader2 className="animate-spin w-4 h-4 inline mr-2"/> Đang tải...</TableCell></TableRow>
              ) : reviews.length === 0 ? (
                <TableRow><TableCell colSpan={7} className="text-center h-24 text-muted-foreground">Hiện tại không có yêu cầu nào cần duyệt.</TableCell></TableRow>
              ) : (
                reviews.map((s) => (
                  <TableRow key={s.id}>
                    <TableCell className="font-bold">{s.subjectCode}</TableCell>
                    <TableCell>
                        <div className="font-medium">{s.subjectNameVi}</div>
                        {s.status === "Pending Approval" && <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 border-blue-200 mt-1">Đã qua BM</Badge>}
                    </TableCell>
                    <TableCell><Badge variant="outline">v{s.version}</Badge></TableCell>
                    <TableCell className="text-gray-600">{s.lecturer}</TableCell>
                    
                    {userRole === "Academic Affairs" && (
                        <TableCell className="text-green-600 font-medium">
                            <div className="flex items-center gap-1">
                                <CheckCircle className="w-3 h-3"/> {s.headDepartment || "BM Approved"}
                            </div>
                        </TableCell>
                    )}
                    
                    <TableCell>{s.dateEdited}</TableCell>
                    <TableCell className="text-right">
                      <div className="flex justify-end gap-2">
                        <Link href={`/syllabus/${s.id}/edit`}>
                             <Button variant="outline" size="sm">Xem chi tiết</Button>
                        </Link>
                        
                        <Button size="sm" className="bg-green-600 hover:bg-green-700" onClick={() => handleApprove(s.id)} title="Duyệt">
                            {userRole === "Head of Dept" ? <ArrowRight className="w-4 h-4"/> : <CheckCircle className="w-4 h-4"/>}
                        </Button>
                        
                        <Button size="sm" variant="destructive" onClick={() => setRejectId(s.id)} title="Trả về">
                            <XCircle className="w-4 h-4"/>
                        </Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* MODAL NHẬP LÝ DO TỪ CHỐI */}
      <Dialog open={!!rejectId} onOpenChange={(open) => !open && setRejectId(null)}>
        <DialogContent>
            <DialogHeader>
                <DialogTitle>Trả về yêu cầu sửa đổi</DialogTitle>
                <DialogDescription>
                    {userRole === "Academic Affairs" 
                        ? "Đề cương sẽ bị trả về trạng thái 'Returned' cho Giảng viên (và thông báo cho Trưởng BM)." 
                        : "Vui lòng nhập lý do để Giảng viên chỉnh sửa lại."}
                </DialogDescription>
            </DialogHeader>
            <div className="py-4">
                <Textarea 
                    placeholder="Nhập lý do cụ thể..." 
                    rows={4}
                    value={rejectReason}
                    onChange={(e) => setRejectReason(e.target.value)}
                />
            </div>
            <DialogFooter>
                <Button variant="outline" onClick={() => setRejectId(null)}>Hủy bỏ</Button>
                <Button variant="destructive" onClick={handleRejectSubmit} disabled={processing}>
                    {processing ? "Đang gửi..." : "Xác nhận Trả về"}
                </Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="app/(main)/syllabus/[id]/edit/page.tsx">
import React from "react";
import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import SyllabusEditForm from "@/components/SyllabusEditForm";
import { SyllabusData, defaultSyllabus } from "@/components/Types";

export default async function Page(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  if (!id) return renderNotFound();

  try {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

    if (res.status === 404) return renderNotFound();
    
    if (!res.ok) {
      console.error("Failed to fetch syllabus", res.status);
      return renderError();
    }

    const rawData = await res.json();

    // Merge dữ liệu API với dữ liệu mặc định để tránh lỗi undefined
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: Array.isArray(rawData.objectives) ? rawData.objectives : [],
        clos: Array.isArray(rawData.clos) ? rawData.clos : [],
        ploMapping: Array.isArray(rawData.ploMapping) ? rawData.ploMapping : [],
        assessmentScheme: Array.isArray(rawData.assessmentScheme) ? rawData.assessmentScheme : [],
        teachingPlan: Array.isArray(rawData.teachingPlan) ? rawData.teachingPlan : [],
        materials: Array.isArray(rawData.materials) ? rawData.materials : [],
        timeAllocation: rawData.timeAllocation || defaultSyllabus.timeAllocation
    };

    return <SyllabusEditForm initial={syllabus} />;

  } catch (err) {
    console.error("Error fetching syllabus:", err);
    return renderError();
  }
}

function renderNotFound() {
    return (
        <div className="flex items-center justify-center min-h-[50vh]">
            <Card className="w-full max-w-md text-center p-6">
                <CardHeader>
                    <CardTitle className="text-xl">Không tìm thấy đề cương</CardTitle>
                </CardHeader>
                <CardContent>
                    <p className="text-muted-foreground mb-4">Đề cương này không tồn tại hoặc đã bị xóa.</p>
                    <Link href="/" className="text-blue-600 hover:underline">Quay về trang chủ</Link>
                </CardContent>
            </Card>
        </div>
    );
}

function renderError() {
    return (
        <div className="flex items-center justify-center min-h-[50vh]">
            <Card className="w-full max-w-md text-center p-6 border-red-200 bg-red-50">
                <CardHeader>
                    <CardTitle className="text-xl text-red-600">Lỗi kết nối</CardTitle>
                </CardHeader>
                <CardContent>
                    <p className="text-red-500 mb-4">Không thể tải dữ liệu từ Backend. Vui lòng kiểm tra lại server API.</p>
                    <Link href="/" className="text-red-700 font-bold hover:underline">Quay về trang chủ</Link>
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="app/(main)/syllabus/[id]/page.tsx">
// import Link from "next/link";
// import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
// import SyllabusDetailView from "@/components/SyllabusDetailView"; // Import component vừa tạo

// interface Syllabus {
//   id: number;
//   subject_name: string;
//   subject_code: string;
//   credits: number;
//   description?: string;
//   clos?: Array<{ code: string; description: string }>;
// }

// export default async function Page(props: { params: Promise<{ id: string }> }) {
//   const { id } = await props.params;

//   if (!id) return renderNotFound();

//   try {
//     // Server-side example using environment variable:
//     // const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

//     if (res.status === 404) return renderNotFound();
    
//     if (!res.ok) {
//       console.error("Failed to fetch syllabus", res.status);
//       return renderError();
//     }

//     const syllabus: Syllabus = await res.json();

//     // Render component giao diện (Client Component)
//     return <SyllabusDetailView syllabus={syllabus} />;

//   } catch (err) {
//     console.error("Error fetching syllabus:", err);
//     return renderError();
//   }
// }

// // --- Các hàm render lỗi giữ nguyên ---

// function renderNotFound() {
//   return (
//     <div className="flex items-center justify-center p-12">
//       <Card className="w-full max-w-md text-center">
//         <CardHeader>
//           <CardTitle className="text-xl">Syllabus not found</CardTitle>
//         </CardHeader>
//         <CardContent>
//           <p className="text-sm text-muted-foreground mb-4">The requested syllabus does not exist or has been removed.</p>
//           <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
//         </CardContent>
//       </Card>
//     </div>
//   );
// }

// function renderError() {
//   return (
//     <div className="flex items-center justify-center p-12">
//       <Card className="w-full max-w-md text-center border-destructive/50">
//         <CardHeader>
//           <CardTitle className="text-xl text-destructive">Unable to load</CardTitle>
//         </CardHeader>
//         <CardContent>
//           <p className="text-sm text-muted-foreground mb-4">There was an error loading the details. Please ensure the backend server is running.</p>
//           <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
//         </CardContent>
//       </Card>
//     </div>
//   );
// }

import Link from "next/link";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import SyllabusDetailView from "@/components/SyllabusDetailView";
// Import Type từ file types (nếu anh đã tạo) hoặc định nghĩa trực tiếp ở đây để nhanh gọn
import { SyllabusData, defaultSyllabus } from "@/components/Types"; 

// Nếu anh chưa tạo file types.ts, hãy uncomment đoạn dưới đây để dùng tạm:
/*
interface SyllabusData {
  id?: number;
  subject_name_vi: string;
  subject_name_en: string;
  subject_code: string;
  credits: number;
  time_allocation: { theory: number; exercises: number; practice: number; self_study: number; };
  prerequisites: string; pre_courses: string; co_courses: string;
  course_type: string; component_type: string;
  description: string;
  objectives: string[];
  clos: { code: string; description: string }[];
  plo_mapping: { clo_code: string; plos: { [key: string]: string } }[];
  student_duties: string;
  assessment_scheme: { component: string; method: string; clos: string; criteria: string; weight: number; }[];
  teaching_plan: { week: string; content: string; clos: string; activity: string; assessment: string; }[];
  materials: { type: "Main" | "Ref"; content: string; }[];
  date_prepared: string; date_edited: string; lecturer: string; head_department: string; dean: string;
}
*/

export default async function Page(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  if (!id) return renderNotFound();

  try {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

    if (res.status === 404) return renderNotFound();
    
    if (!res.ok) {
      console.error("Failed to fetch syllabus", res.status);
      return renderError();
    }

    const rawData = await res.json();

    // MERGE dữ liệu từ API với dữ liệu mặc định để tránh lỗi "undefined" khi render
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: rawData.objectives || [],
        clos: rawData.clos || [],
        ploMapping: rawData.ploMapping || [],
        assessmentScheme: rawData.assessmentScheme || [],
        teachingPlan: rawData.teachingPlan || [],
        materials: rawData.materials || [],
        timeAllocation: rawData.timeAllocation || { theory: 0, exercises: 0, practice: 0, selfStudy: 0 }
    };

    return <SyllabusDetailView syllabus={syllabus} />;

  } catch (err) {
    console.error("Error fetching syllabus:", err);
    return renderError();
  }
}

function renderNotFound() {
  return (
    <div className="flex items-center justify-center p-12">
      <Card className="w-full max-w-md text-center">
        <CardHeader>
          <CardTitle className="text-xl">Syllabus not found</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground mb-4">The requested syllabus does not exist or has been removed.</p>
          <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
        </CardContent>
      </Card>
    </div>
  );
}

function renderError() {
  return (
    <div className="flex items-center justify-center p-12">
      <Card className="w-full max-w-md text-center border-destructive/50">
        <CardHeader>
          <CardTitle className="text-xl text-destructive">Unable to load</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground mb-4">There was an error loading the details. Please ensure the backend server is running.</p>
          <Link className="text-sm font-medium text-primary hover:underline" href="/">Back to Dashboard</Link>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="app/(main)/syllabus/compare/page.tsx">
"use client";

import React, { useEffect, useState } from "react";
import axios from "@/lib/axios";
import { useSearchParams, useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";

interface DiffItem {
  field: string;
  old_value: string;
  new_value: string;
  type: string;
}

export default function ComparePage() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const baseId = searchParams.get("baseId");
  const targetId = searchParams.get("targetId");

  const [data, setData] = useState<{ base_version: string; target_version: string; diffs: DiffItem[] } | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchDiff = async () => {
      if (!baseId || !targetId) return;

      try {
        const query = new URLSearchParams({ base_id: baseId, target_id: targetId }).toString();
        const res = await axios.get(`/syllabus/compare?${query}`);
        const data = res.data;
        setData(data);
      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    };
    fetchDiff();
  }, [baseId, targetId]);

  if (!baseId || !targetId) return <div className="p-8 text-center">Missing IDs to compare</div>;
  if (loading) return <div className="p-8 text-center">Analyzing changes...</div>;

  return (
    <div className="max-w-5xl mx-auto space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" onClick={() => router.back()}><ArrowLeft className="w-4 h-4 mr-2"/> Back</Button>
        <h1 className="text-2xl font-bold">So sánh Phiên bản</h1>
      </div>

      <div className="grid grid-cols-2 gap-4">
         <Card className="bg-slate-50 border-slate-200">
            <CardHeader><CardTitle className="text-lg text-slate-500">Phiên bản gốc (v{data?.base_version})</CardTitle></CardHeader>
         </Card>
         <Card className="bg-blue-50 border-blue-200">
            <CardHeader><CardTitle className="text-lg text-blue-600">Phiên bản mới (v{data?.target_version})</CardTitle></CardHeader>
         </Card>
      </div>

      <div className="space-y-4">
        {data?.diffs.length === 0 ? (
            <Card className="p-8 text-center text-green-600 font-bold border-green-200 bg-green-50">
                ✅ Không có sự thay đổi nào giữa 2 phiên bản này.
            </Card>
        ) : (
            data?.diffs.map((diff, idx) => (
                <Card key={idx} className="overflow-hidden">
                    <div className="bg-gray-100 px-4 py-2 font-mono text-sm font-bold border-b uppercase text-gray-600">
                        Field: {diff.field}
                    </div>
                    <div className="grid grid-cols-2">
                        <div className="p-4 bg-red-50 text-red-700 border-r break-words">
                            <div className="text-xs font-bold text-red-400 mb-1">OLD</div>
                            {diff.old_value}
                        </div>
                        <div className="p-4 bg-green-50 text-green-700 break-words">
                            <div className="text-xs font-bold text-green-400 mb-1">NEW</div>
                            {diff.new_value}
                        </div>
                    </div>
                </Card>
            ))
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/(main)/syllabus/create/page.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";

// --- Types ---
type CLO = { id: string; code: string; description: string };
type Assessment = { id: string; component: string; weight: number; description: string };
type Material = { id: string; type: "Main" | "Ref"; author: string; title: string; publisher: string; year: string };

export default function CreateSyllabusPage() {
  const router = useRouter();
  const [tab, setTab] = useState("general");

  // --- State ---
  const [title, setTitle] = useState("");
  const [code, setCode] = useState("");
  const [credits, setCredits] = useState<number | "">(3);
  const [description, setDescription] = useState("");
  
  const [prerequisites, setPrerequisites] = useState("");
  const [preCourses, setPreCourses] = useState("");
  const [courseType, setCourseType] = useState("Bắt buộc");
  const [studentTasks, setStudentTasks] = useState("");

  // MỚI: State cho Time Allocation
  const [timeAllocation, setTimeAllocation] = useState({ theory: 0, exercises: 0, practice: 0, self_study: 0 });

  const [clos, setClos] = useState<CLO[]>([{ id: crypto.randomUUID(), code: "G1", description: "" }]);
  const [assessments, setAssessments] = useState<Assessment[]>([
    { id: crypto.randomUUID(), component: "Quá trình", weight: 50, description: "" },
    { id: crypto.randomUUID(), component: "Cuối kỳ", weight: 50, description: "" },
  ]);
  const [materials, setMaterials] = useState<Material[]>([]);

  const [submitting, setSubmitting] = useState(false);

  // --- Helpers ---
  function addCLO() { setClos(s => [...s, { id: crypto.randomUUID(), code: `G${s.length + 1}`, description: "" }]); }
  function updateCLO(id: string, f: Partial<CLO>) { setClos(s => s.map(c => c.id === id ? { ...c, ...f } : c)); }
  function removeCLO(id: string) { setClos(s => s.filter(c => c.id !== id)); }

  function addAssessment() { setAssessments(s => [...s, { id: crypto.randomUUID(), component: "", weight: 0, description: "" }]); }
  function updateAssessment(id: string, f: Partial<Assessment>) { setAssessments(s => s.map(a => a.id === id ? { ...a, ...f } : a)); }
  function removeAssessment(id: string) { setAssessments(s => s.filter(a => a.id !== id)); }

  function addMaterial() { setMaterials(s => [...s, { id: crypto.randomUUID(), type: "Main", author: "", title: "", publisher: "", year: "" }]); }
  function updateMaterial(id: string, f: Partial<Material>) { setMaterials(s => s.map(m => m.id === id ? { ...m, ...f } : m)); }
  function removeMaterial(id: string) { setMaterials(s => s.filter(m => m.id !== id)); }

  const totalWeight = assessments.reduce((sum, item) => sum + (Number(item.weight) || 0), 0);

  // --- Submit ---
  async function handleSubmit() {
    const payload = {
      subject_name: title,
      subject_code: code,
      credits: credits === "" ? 0 : credits,
      description,
      prerequisites,
      pre_courses: preCourses,
      course_type: courseType,
      student_tasks: studentTasks,
      time_allocation: timeAllocation, // Thêm vào payload
      clos: clos.map(c => ({ code: c.code, description: c.description })),
      assessment_scheme: assessments.map(a => ({ component: a.component, weight: Number(a.weight), description: a.description })),
      materials: materials.map(m => ({ type: m.type, title: m.title, author: m.author, publisher: m.publisher, year: m.year })),
    };

    setSubmitting(true);
    try {
      // Use the centralized client so base URL, Authorization header and snake_case conversion are handled automatically
      // Example usage (client-side):
      // const resJson = await (await import("@/lib/apiClient")).apiFetch("/syllabuses", { method: "POST", body: payload });
      // router.push("/");

      // (Legacy direct fetch removed from source; keep example above for reference)
    } catch (err) { alert("Lỗi: " + err); } 
    finally { setSubmitting(false); }
  }

  const selectClass = "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50";

  return (
    <div className="flex justify-center py-12 px-4">
      <Card className="w-full max-w-4xl">
        <CardHeader><CardTitle>Thêm Đề Cương Mới</CardTitle></CardHeader>
        <CardContent>
          <Tabs value={tab} onValueChange={setTab}>
            <TabsList className="w-full grid grid-cols-4">
              <TabsTrigger value="general">Thông tin chung</TabsTrigger>
              <TabsTrigger value="clos">CĐR (CLOs)</TabsTrigger>
              <TabsTrigger value="materials">Tài liệu</TabsTrigger>
              <TabsTrigger value="assessments">Đánh giá</TabsTrigger>
            </TabsList>

            <TabsContent value="general" className="space-y-4 mt-4">
              <div className="grid grid-cols-2 gap-4">
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">Tên học phần</span><Input value={title} onChange={e => setTitle(e.target.value)} /></label>
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">Mã học phần</span><Input value={code} onChange={e => setCode(e.target.value)} /></label>
              </div>
              <div className="grid grid-cols-2 gap-4">
                 <label className="flex flex-col gap-1"><span className="text-sm font-medium">Số tín chỉ</span><Input type="number" value={credits} onChange={e => setCredits(e.target.value === "" ? "" : Number(e.target.value))} /></label>
                 <label className="flex flex-col gap-1"><span className="text-sm font-medium">Loại học phần</span>
                    <select className={selectClass} value={courseType} onChange={e => setCourseType(e.target.value)}>
                        <option value="Bắt buộc">Bắt buộc</option>
                        <option value="Tự chọn">Tự chọn</option>
                    </select>
                 </label>
              </div>

              {/* KHUNG NHẬP PHÂN BỔ THỜI GIAN */}
              <div className="border p-4 rounded-md bg-gray-50">
                <span className="text-sm font-bold mb-2 block">Phân bổ thời gian (Tiết)</span>
                <div className="grid grid-cols-4 gap-2">
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">Lý thuyết</span>
                        <Input type="number" value={timeAllocation.theory} onChange={e => setTimeAllocation({...timeAllocation, theory: Number(e.target.value)})} />
                    </label>
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">Bài tập/Dự án</span>
                        <Input type="number" value={timeAllocation.exercises} onChange={e => setTimeAllocation({...timeAllocation, exercises: Number(e.target.value)})} />
                    </label>
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">Thực hành</span>
                        <Input type="number" value={timeAllocation.practice} onChange={e => setTimeAllocation({...timeAllocation, practice: Number(e.target.value)})} />
                    </label>
                    <label className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500">Tự học</span>
                        <Input type="number" value={timeAllocation.self_study} onChange={e => setTimeAllocation({...timeAllocation, self_study: Number(e.target.value)})} />
                    </label>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">HP Tiên quyết</span><Input value={prerequisites} onChange={e => setPrerequisites(e.target.value)} /></label>
                <label className="flex flex-col gap-1"><span className="text-sm font-medium">HP Học trước</span><Input value={preCourses} onChange={e => setPreCourses(e.target.value)} /></label>
              </div>
              <label className="flex flex-col gap-1"><span className="text-sm font-medium">Mô tả tóm tắt</span><Textarea value={description} onChange={e => setDescription(e.target.value)} /></label>
              <label className="flex flex-col gap-1"><span className="text-sm font-medium">Nhiệm vụ SV</span><Textarea value={studentTasks} onChange={e => setStudentTasks(e.target.value)} /></label>
            </TabsContent>

            {/* Các Tab khác giữ nguyên logic cũ */}
            <TabsContent value="clos" className="mt-4 space-y-4">
                {clos.map((c, idx) => (
                    <div key={c.id} className="flex gap-2"><Input className="w-24" value={c.code} onChange={e => updateCLO(c.id, {code: e.target.value})} /><Input value={c.description} onChange={e => updateCLO(c.id, {description: e.target.value})} /><Button variant="ghost" onClick={() => removeCLO(c.id)}>✕</Button></div>
                ))}
                <Button variant="outline" onClick={addCLO} className="w-full border-dashed">+ Thêm CLO</Button>
            </TabsContent>
            <TabsContent value="materials" className="space-y-4 mt-4">
                {materials.map((m, idx) => (
                    <div key={m.id} className="border p-3 rounded-md space-y-2 relative bg-gray-50">
                        <Button variant="ghost" size="sm" className="absolute top-2 right-2 text-red-500" onClick={() => removeMaterial(m.id)}>✕</Button>
                        <div className="flex gap-4">
                             <div className="w-1/4">
                                <span className="text-xs text-muted-foreground">Loại</span>
                                <select className={`${selectClass} h-9 mt-1`} value={m.type} onChange={e => updateMaterial(m.id, { type: e.target.value as any })}><option value="Main">Giáo trình</option><option value="Ref">Tham khảo</option></select>
                             </div>
                             <div className="w-3/4"><span className="text-xs text-muted-foreground">Tên tài liệu</span><Input className="h-9 mt-1" value={m.title} onChange={e => updateMaterial(m.id, { title: e.target.value })} /></div>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                             <Input className="h-8 text-sm" value={m.author} onChange={e => updateMaterial(m.id, { author: e.target.value })} placeholder="Tác giả" />
                             <Input className="h-8 text-sm" value={m.publisher} onChange={e => updateMaterial(m.id, { publisher: e.target.value })} placeholder="NXB" />
                             <Input className="h-8 text-sm" value={m.year} onChange={e => updateMaterial(m.id, { year: e.target.value })} placeholder="Năm" />
                        </div>
                    </div>
                ))}
                <Button variant="outline" onClick={addMaterial} className="w-full border-dashed">+ Thêm Tài liệu</Button>
            </TabsContent>
            <TabsContent value="assessments" className="mt-4 space-y-4">
                <div className="flex justify-between"><h3 className="font-medium">Điểm số</h3><Badge variant={totalWeight===100?"default":"destructive"}>{totalWeight}%</Badge></div>
                {assessments.map(a => (
                    <div key={a.id} className="flex gap-2"><Input className="w-1/3" value={a.component} onChange={e=>updateAssessment(a.id, {component:e.target.value})} /><Input className="w-20" type="number" value={a.weight} onChange={e=>updateAssessment(a.id, {weight:Number(e.target.value)})} /><Input className="flex-1" value={a.description} onChange={e=>updateAssessment(a.id, {description:e.target.value})} /><Button variant="ghost" onClick={()=>removeAssessment(a.id)}>✕</Button></div>
                ))}
                <Button variant="outline" onClick={addAssessment} className="w-full border-dashed">+ Thêm điểm</Button>
                <div className="pt-4 mt-4 border-t"><Button className="w-full" onClick={handleSubmit} disabled={submitting || totalWeight !== 100}>Lưu Đề Cương</Button></div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="app/(public)/layout.tsx">
"use client";

import React from "react";
import { useRouter } from "next/navigation";
import { BookOpen, LogOut } from "lucide-react";
import { Button } from "@/components/ui/button";

export default function PublicLayout({ children }: { children: React.ReactNode }) {
  const router = useRouter();

  const handleLogout = () => {
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      localStorage.removeItem("role");
      router.push("/login");
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col">
      <header className="bg-white border-b sticky top-0 z-10 shadow-sm">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            {/* SỬA: bg-blue-600 -> bg-teal-600 */}
            <div className="bg-teal-600 p-2 rounded-lg">
                <BookOpen className="w-6 h-6 text-white" />
            </div>
            {/* SỬA: text-blue-900 -> text-teal-900 */}
            <span className="font-bold text-xl text-teal-900">SMD Portal</span>
          </div>
          <div className="flex gap-4 items-center">
             <Button variant="ghost" onClick={handleLogout} className="text-red-600 hover:text-red-700 hover:bg-red-50 text-sm">
                <LogOut className="w-4 h-4 mr-2" /> Đăng xuất
             </Button>
          </div>
        </div>
      </header>

      <main className="flex-1 w-full max-w-6xl mx-auto p-4 md:py-8">
        {children}
      </main>

      <footer className="bg-white border-t py-6 text-center text-sm text-gray-500">
        © 2025 University Syllabus Management System. All rights reserved.
      </footer>
    </div>
  );
}
</file>

<file path="app/(public)/portal/[id]/page.tsx">
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import SyllabusDetailView from "@/components/SyllabusDetailView";
import { SyllabusData, defaultSyllabus } from "@/components/Types";

export default async function StudentViewPage(props: { params: Promise<{ id: string }> }) {
  const { id } = await props.params;

  try {
    // Gọi API lấy chi tiết đề cương (use public env var and plural resource)
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/syllabuses/${id}`, { cache: "no-store" });

    if (!res.ok) {
        return (
            <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
                <div className="text-xl font-bold text-gray-500">Không tìm thấy đề cương này.</div>
                <Link href="/portal"><Button>Quay lại trang chủ</Button></Link>
            </div>
        );
    }

    const rawData = await res.json();
    
    // Merge dữ liệu an toàn (convert backend camelCase to frontend camelCase model)
    const syllabus: SyllabusData = {
        ...defaultSyllabus,
        ...rawData,
        objectives: rawData.objectives || [],
        clos: rawData.clos || [],
        ploMapping: rawData.ploMapping || [],
        assessmentScheme: rawData.assessmentScheme || [],
        teachingPlan: rawData.teachingPlan || [],
        materials: rawData.materials || [],
        timeAllocation: rawData.timeAllocation || { theory: 0, exercises: 0, practice: 0, selfStudy: 0 }
    };

    return (
        <div className="container mx-auto pb-10">
            {/* Nút quay lại */}
            <div className="mb-6">
                <Link href="/portal">
                    <Button variant="outline" className="gap-2 bg-white hover:bg-slate-100">
                        <ArrowLeft className="w-4 h-4" /> Quay lại tìm kiếm
                    </Button>
                </Link>
            </div>

            {/* Hiển thị nội dung đề cương */}
            <div className="bg-white shadow-sm rounded-lg border overflow-hidden">
                <SyllabusDetailView syllabus={syllabus} />
            </div>
        </div>
    );

  } catch (err) {
    return <div className="p-12 text-center text-red-500">Lỗi kết nối server. Vui lòng thử lại sau.</div>;
  }
}
</file>

<file path="app/(public)/portal/page.tsx">
"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Search, BookOpen, User, Clock, GraduationCap, Loader2 } from "lucide-react";

interface SyllabusPublic {
  id: number;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  lecturer: string;
  version: string;
  description: string;
  dateEdited: string;
}

export default function StudentHomePage() {
  const [searchTerm, setSearchTerm] = useState("");
  const [results, setResults] = useState<SyllabusPublic[]>([]);
  const [loading, setLoading] = useState(false);
  const [debouncedTerm, setDebouncedTerm] = useState(searchTerm);

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedTerm(searchTerm), 500);
    return () => clearTimeout(timer);
  }, [searchTerm]);

  useEffect(() => {
    const fetchData = async () => {
        setLoading(true);
        try {
            const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/public/syllabus?search=${encodeURIComponent(debouncedTerm)}`);
            const data = await res.json();
            setResults(data.data || []);
        } catch(e) { console.error(e); } 
        finally { setLoading(false); }
    };
    fetchData();
  }, [debouncedTerm]);

  return (
    <div className="space-y-12 pb-20">
      {/* ĐỔI GRADIENT BACKGROUND */}
      <div className="text-center space-y-6 py-16 bg-gradient-to-b from-teal-50 to-white rounded-3xl border border-teal-100 px-4">
        <div className="inline-flex items-center px-3 py-1 rounded-full bg-teal-100 text-teal-700 text-xs font-bold mb-2">
            <GraduationCap className="w-4 h-4 mr-2"/> Cổng thông tin Đào tạo
        </div>
        <h1 className="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight">Tra cứu Đề cương Học phần</h1>
        <p className="text-lg text-slate-600 max-w-2xl mx-auto">Hệ thống dữ liệu số hóa chính thức. Tìm kiếm thông tin chi tiết, chuẩn đầu ra và tài liệu học tập mới nhất.</p>
        
        <div className="max-w-xl mx-auto relative mt-8">
            <Search className="absolute left-4 top-3.5 h-5 w-5 text-teal-500" />
            <Input 
                className="pl-12 h-12 text-lg shadow-xl border-teal-100 focus-visible:ring-teal-500 rounded-full transition-all" 
                placeholder="Nhập mã môn (VD: IT001) hoặc tên môn học..." 
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
            />
            {loading && <div className="absolute right-4 top-4"><Loader2 className="w-4 h-4 animate-spin text-gray-400"/></div>}
        </div>
      </div>

      <div className="max-w-6xl mx-auto">
        <div className="flex items-center justify-between mb-6 px-2">
            <h2 className="text-xl font-bold text-slate-800">{searchTerm ? `Kết quả tìm kiếm cho "${searchTerm}"` : "Đề cương mới cập nhật"}</h2>
            <span className="text-sm text-slate-500">{results.length} kết quả</span>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {loading && results.length === 0 ? ([1,2,3].map(i => <div key={i} className="h-64 bg-gray-100 rounded-xl animate-pulse"></div>)) : results.length === 0 ? (
                <div className="col-span-full text-center py-16 text-gray-400 italic bg-slate-50 rounded-xl border border-dashed">Không tìm thấy đề cương nào phù hợp.</div>
            ) : (
                results.map((item) => (
                    /* ĐỔI BORDER TOP CARD */
                    <Card key={item.id} className="group hover:shadow-lg transition-all duration-300 border-t-4 border-t-teal-500 flex flex-col h-full">
                        <CardHeader className="pb-3">
                            <div className="flex justify-between items-start mb-2">
                                <Badge variant="secondary" className="bg-teal-50 text-teal-700 hover:bg-teal-100 border-teal-200 font-mono">{item.subjectCode}</Badge>
                                <span className="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-0.5 rounded-full border border-green-200">v{item.version}</span>
                            </div>
                            <CardTitle className="text-lg leading-snug group-hover:text-teal-700 transition-colors min-h-[3.5rem] line-clamp-2">{item.subjectNameVi}</CardTitle>
                            <p className="text-xs text-muted-foreground line-clamp-1 italic">{item.subjectNameEn}</p>
                        </CardHeader>
                        <CardContent className="flex-1 pb-4">
                            <p className="text-sm text-gray-600 line-clamp-3 mb-4 h-[4.5em]">{item.description || "Chưa có mô tả tóm tắt cho học phần này."}</p>
                            <div className="space-y-2 pt-4 border-t border-dashed">
                                <div className="flex items-center gap-2 text-xs text-gray-500"><BookOpen className="w-3.5 h-3.5 text-teal-500" /> <span className="font-medium">{item.credits} tín chỉ</span></div>
                                <div className="flex items-center gap-2 text-xs text-gray-500"><User className="w-3.5 h-3.5 text-purple-500" /> <span>GV: {item.lecturer}</span></div>
                                <div className="flex items-center gap-2 text-xs text-gray-500"><Clock className="w-3.5 h-3.5 text-orange-500" /> <span>Cập nhật: {item.dateEdited}</span></div>
                            </div>
                        </CardContent>
                        <CardFooter className="pt-0 pb-6 px-6">
                            <Link href={`/portal/${item.id}`} className="w-full">
                                {/* ĐỔI NÚT ACTION */}
                                <Button className="w-full bg-teal-700 hover:bg-teal-800 text-white transition-colors shadow-lg shadow-teal-100">Xem chi tiết</Button>
                            </Link>
                        </CardFooter>
                    </Card>
                ))
            )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="app/layout.tsx">
// apps/web/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "SMD System",
  description: "Syllabus Management System",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
        {children}
      </body>
    </html>
  );
}
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="components/DashboardCharts.tsx">
"use client";

import React from "react";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend, BarChart, Bar, XAxis, YAxis, CartesianGrid } from "recharts";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { FileText, Users, CheckCircle, Clock } from "lucide-react";

interface StatsData {
  total_syllabus: number;
  total_users: number;
  status_breakdown: { name: string; value: number; fill: string }[];
}

export default function DashboardCharts({ data }: { data: StatsData | null }) {
  if (!data) return <div className="h-48 flex items-center justify-center text-gray-400">Đang tải thống kê...</div>;

  const approvedCount = data.status_breakdown.find(i => i.name === "Đã duyệt")?.value || 0;
  const pendingCount = data.status_breakdown.find(i => i.name === "Chờ duyệt")?.value || 0;

  return (
    <div className="space-y-6 mb-8 animate-in fade-in-50 slide-in-from-top-5 duration-500">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {/* SỬA: Card này đổi từ Blue -> Teal */}
        <Card className="bg-teal-50 border-teal-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-teal-100 rounded-full text-teal-600"><FileText className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">Tổng đề cương</p>
                    <h3 className="text-2xl font-bold text-teal-700">{data.total_syllabus}</h3>
                </div>
            </CardContent>
        </Card>

        {/* Các Card khác giữ nguyên màu để phân biệt trạng thái (Xanh lá, Vàng, Tím) */}
        <Card className="bg-green-50 border-green-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-green-100 rounded-full text-green-600"><CheckCircle className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">Đã công bố</p>
                    <h3 className="text-2xl font-bold text-green-700">{approvedCount}</h3>
                </div>
            </CardContent>
        </Card>

        <Card className="bg-yellow-50 border-yellow-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-yellow-100 rounded-full text-yellow-600"><Clock className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">Đang chờ duyệt</p>
                    <h3 className="text-2xl font-bold text-yellow-700">{pendingCount}</h3>
                </div>
            </CardContent>
        </Card>

        <Card className="bg-purple-50 border-purple-200 shadow-sm">
            <CardContent className="p-4 flex items-center gap-4">
                <div className="p-3 bg-purple-100 rounded-full text-purple-600"><Users className="w-6 h-6" /></div>
                <div>
                    <p className="text-sm text-gray-500 font-medium">Người dùng</p>
                    <h3 className="text-2xl font-bold text-purple-700">{data.total_users}</h3>
                </div>
            </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Card className="shadow-sm">
            <CardHeader><CardTitle className="text-lg">Tỷ lệ trạng thái đề cương</CardTitle></CardHeader>
            <CardContent className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                        <Pie
                            data={data.status_breakdown}
                            cx="50%" cy="50%"
                            innerRadius={60} outerRadius={100}
                            paddingAngle={5}
                            dataKey="value"
                        >
                            {data.status_breakdown.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.fill} stroke="none"/>
                            ))}
                        </Pie>
                        <Tooltip />
                        <Legend verticalAlign="bottom" height={36}/>
                    </PieChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>

        <Card className="shadow-sm">
            <CardHeader><CardTitle className="text-lg">Thống kê số lượng</CardTitle></CardHeader>
            <CardContent className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={data.status_breakdown} margin={{top: 20, right: 30, left: 0, bottom: 5}}>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                        <XAxis dataKey="name" tick={{fontSize: 12}} />
                        <YAxis allowDecimals={false} />
                        <Tooltip cursor={{fill: 'transparent'}} />
                        <Bar dataKey="value" radius={[4, 4, 0, 0]}>
                            {data.status_breakdown.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.fill} />
                            ))}
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="components/Header.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { LogOut, Bell } from "lucide-react";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import axios from "@/lib/axios";

export default function Header() {
  const router = useRouter();
  const [user, setUser] = useState<{ full_name: string; role: string } | null>(null);
  const [academicYear, setAcademicYear] = useState("Loading...");
  
  // State cho thông báo
  const [notifications, setNotifications] = useState<any[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);

  // Hàm fetch user & info
  useEffect(() => {
    const fetchData = async () => {
      const token = localStorage.getItem("access_token");
      if (!token) { router.push("/login"); return; }

      try {
        // Lấy User Info
        const userRes = await axios.get("/users/me");
        const userData = userRes.data;
        setUser(userData);
        if (userData?.role) localStorage.setItem("role", userData.role);

        // Lấy Năm học
        try {
          const sysRes = await axios.get("/system/info");
          const sys = sysRes.data;
          setAcademicYear(sys?.activeYearName || "Chưa cấu hình");
        } catch (e) { /* ignore */ }
      } catch (err: any) {
        console.error(err);
        localStorage.removeItem("access_token");
        router.push("/login");
      }
    };
    fetchData();
  }, [router]);

  // Hàm fetch thông báo (Polling)
  const fetchNotifications = async () => {
      try {
          const dataRes = await axios.get("/notifications");
          const data = dataRes.data;
          setNotifications(data.data || []);
          setUnreadCount(data.unread || 0);
      } catch(e) { console.error(e); }
  };

  useEffect(() => {
      fetchNotifications();
      const interval = setInterval(fetchNotifications, 15000); // Tự động check mỗi 15s
      return () => clearInterval(interval);
  }, []);

  const handleRead = async (notif: any) => {
      if(!notif.is_read) {
          try {
            await axios.post(`/notifications/${notif.id}/read`);
            setUnreadCount(prev => Math.max(0, prev - 1));
            setNotifications(prev => prev.map(n => n.id === notif.id ? {...n, is_read: true} : n));
          } catch(e) { console.error(e); }
      }
      if(notif.link) router.push(notif.link);
  };

  const handleLogout = () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    localStorage.removeItem("role");
    router.push("/login");
  };

  return (
    <header className="flex items-center justify-between gap-4 py-4 px-6 border-b border-border bg-background sticky top-0 z-10 shadow-sm">
      <div className="flex items-center gap-3">
        <div className="text-sm font-medium text-teal-800 bg-teal-50 px-3 py-1 rounded-full border border-teal-100">
            📅 {academicYear}
        </div>
      </div>

      <div className="flex items-center gap-4">
        {user ? (
            <>
                {/* --- CHUÔNG THÔNG BÁO --- */}
                <Popover>
                    <PopoverTrigger asChild>
                        <Button variant="ghost" size="icon" className="relative">
                            <Bell className="w-5 h-5 text-gray-600" />
                            {unreadCount > 0 && (
                                <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                            )}
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent className="w-80 p-0" align="end">
                        <div className="p-3 border-b font-semibold text-sm bg-slate-50 rounded-t-md flex justify-between">
                            <span>Thông báo</span>
                            <span className="text-xs text-gray-500 font-normal">{unreadCount} chưa đọc</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto">
                            {notifications.length === 0 ? (
                                <div className="p-8 text-center text-xs text-gray-400">Không có thông báo mới</div>
                            ) : (
                                notifications.map((n: any) => (
                                    <div 
                                        key={n.id} 
                                        onClick={() => handleRead(n)}
                                        className={`p-3 border-b cursor-pointer hover:bg-slate-50 transition-colors ${!n.is_read ? 'bg-blue-50/60' : ''}`}
                                    >
                                        <div className="text-sm font-semibold text-slate-800 mb-0.5">{n.title}</div>
                                        <div className="text-xs text-slate-600 line-clamp-2">{n.message}</div>
                                        <div className="text-[10px] text-slate-400 mt-2 text-right">
                                            {new Date(n.created_at).toLocaleString('vi-VN')}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </PopoverContent>
                </Popover>

                {/* --- USER INFO --- */}
                <div className="text-right hidden md:block">
                    <div className="text-sm font-bold">{user.full_name}</div>
                    <div className="text-xs text-muted-foreground">{user.role}</div>
                </div>
                <Avatar>
                    <AvatarFallback className={user.role === "Lecturer" ? "bg-teal-100 text-teal-600" : "bg-purple-100 text-purple-600"}>
                        {user.role === "Lecturer" ? "GV" : "NV"}
                    </AvatarFallback>
                </Avatar>
                <Button variant="ghost" size="icon" onClick={handleLogout} title="Logout">
                    <LogOut className="w-5 h-5 text-gray-500" />
                </Button>
            </>
        ) : (
            <div className="text-sm text-muted-foreground">Loading...</div>
        )}
      </div>
    </header>
  );
}
</file>

<file path="components/Sidebar.tsx">
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { 
    LayoutDashboard, 
    FilePlus2, 
    FileCheck, 
    UserCircle, 
    BookOpen,
    Menu,
    UserCog,
    FileClock,
    Settings
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger, SheetTitle } from "@/components/ui/sheet";

export default function Sidebar() {
  const pathname = usePathname();
  const [role, setRole] = useState("");

  useEffect(() => {
    setRole(localStorage.getItem("role") || "");
  }, []);

  const menuItems = [
    { 
        name: "Dashboard", 
        href: "/", 
        icon: LayoutDashboard,
        roles: ["ALL"] 
    },
    { 
        name: "Biên soạn đề cương", 
        href: "/syllabus/create", 
        icon: FilePlus2,
        roles: ["Lecturer", "Head of Dept", "Admin"] 
    },
    { 
        name: "Yêu cầu phê duyệt", 
        href: "/reviews", 
        icon: FileCheck,
        roles: ["Head of Dept", "Academic Affairs", "Admin"] 
    },
    { 
        name: "Quản trị User", 
        href: "/admin/users", 
        icon: UserCog,
        roles: ["Admin"] 
    },
    { 
        name: "Cấu hình hệ thống",
        href: "/admin/settings", 
        icon: Settings,
        roles: ["Admin"] 
    },
    { 
        name: "Nhật ký hệ thống", 
        href: "/admin/logs", 
        icon: FileClock,
        roles: ["Admin"] 
    },
    { 
        name: "Cổng sinh viên", 
        href: "/portal", 
        icon: BookOpen,
        roles: ["ALL"] 
    },
    { 
        name: "Hồ sơ cá nhân", 
        href: "/profile", 
        icon: UserCircle,
        roles: ["ALL"] 
    },
  ];

  const filteredMenu = menuItems.filter(item => 
    item.roles.includes("ALL") || item.roles.includes(role)
  );

  const NavContent = () => (
    <div className="flex flex-col h-full">
        <div className="mb-8 px-2">
          {/* ĐỔI MÀU LOGO */}
          <h1 className="text-xl font-extrabold text-teal-700 tracking-tight flex items-center gap-2">
            <BookOpen className="w-6 h-6"/> SMD System
          </h1>
          <p className="text-xs text-slate-500 mt-1 ml-8">Syllabus Management</p>
        </div>
        
        <nav className="flex-1 space-y-1">
          {filteredMenu.map((m) => {
            const isActive = pathname === m.href;
            return (
                <Link
                  key={m.href}
                  href={m.href}
                  className={`flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200
                    ${isActive 
                        /* ĐỔI MÀU ACTIVE: Blue -> Teal */
                        ? "bg-teal-50 text-teal-800 shadow-sm border border-teal-100 font-bold" 
                        : "text-slate-600 hover:bg-teal-50 hover:text-teal-700"
                    }`}
                >
                  <m.icon className={`w-5 h-5 ${isActive ? "text-teal-700" : "text-slate-400"}`} />
                  <span>{m.name}</span>
                </Link>
            );
          })}
        </nav>

        <div className="mt-auto border-t pt-4">
             <div className="text-xs text-center text-slate-400">
                v1.2.0-config
             </div>
        </div>
    </div>
  );

  return (
    <>
      <aside className="hidden md:flex md:flex-col md:w-64 md:h-screen md:fixed md:inset-y-0 md:overflow-y-auto md:bg-white md:border-r md:border-slate-200 md:p-4 z-50">
        <NavContent />
      </aside>

      <div className="md:hidden">
        <Sheet>
          <SheetTrigger asChild>
            <Button variant="ghost" size="icon" className="fixed top-3 left-4 z-50 bg-white shadow-sm border">
              <Menu className="w-5 h-5 text-slate-700" />
            </Button>
          </SheetTrigger>
          <SheetContent side="left" className="w-72 p-4">
            <SheetTitle className="sr-only">Menu</SheetTitle>
            <NavContent />
          </SheetContent>
        </Sheet>
      </div>
    </>
  );
}
</file>

<file path="components/syllabus-form/MaterialsTab.tsx">
// apps/web/components/syllabus-form/MaterialsTab.tsx
"use client";

import React from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { SyllabusData } from "../Types";

interface MaterialsTabProps {
  data: SyllabusData;
  readOnly: boolean;
  onUpdate: (index: number, val: string) => void;
  onAdd: (type: "Main" | "Ref") => void;
  onRemove: (index: number) => void;
}

export default function MaterialsTab({ data, readOnly, onUpdate, onAdd, onRemove }: MaterialsTabProps) {
  
  const renderSection = (type: "Main" | "Ref", label: string) => (
    <div className="bg-slate-50 p-4 rounded-md mb-4 border border-slate-200">
      <h3 className="font-bold mb-3 text-slate-700">{label}</h3>
      <div className="space-y-3">
        {data.materials.map((m, originalIndex) => ({ m, originalIndex }))
          .filter(item => item.m.type === type)
          .map(({ m, originalIndex }, i) => (
            <div key={originalIndex} className="flex gap-2 items-center">
              <span className="text-sm font-bold w-8 text-gray-500">[{i + 1}]</span>
              <Input 
                value={m.content} 
                onChange={(e) => onUpdate(originalIndex, e.target.value)} 
                placeholder="Ví dụ: Tên tác giả, Năm xuất bản, Tên sách, Nhà xuất bản..." 
                disabled={readOnly}
                className="bg-white flex-1"
              />
              {!readOnly && (
                <Button variant="ghost" size="icon" onClick={() => onRemove(originalIndex)} className="text-red-500 hover:text-red-700 hover:bg-red-50">✕</Button>
              )}
            </div>
        ))}
        {/* Hiển thị thông báo nếu chưa có tài liệu nào */}
        {data.materials.filter(m => m.type === type).length === 0 && (
            <div className="text-sm text-gray-400 italic pl-8">Chưa có tài liệu nào.</div>
        )}
      </div>
      {!readOnly && (
        <Button variant="outline" size="sm" className="mt-3 ml-8 border-dashed bg-white" onClick={() => onAdd(type)}>
          + Thêm tài liệu
        </Button>
      )}
    </div>
  );

  return (
    <div className="animate-in fade-in-50 space-y-4">
      {renderSection("Main", "8.1. Tài liệu chính")}
      {renderSection("Ref", "8.2. Tài liệu tham khảo")}
    </div>
  );
}
</file>

<file path="components/SyllabusDeleteButton.tsx">
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogAction,
  AlertDialogCancel,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import axios from "@/lib/axios";

export default function SyllabusDeleteButton({ id }: { id: number }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  async function handleDelete() {
    setLoading(true);
    try {
      await axios.delete(`/syllabuses/${id}`);
      alert("Xóa thành công!");
      router.push("/");
    } catch (err: any) {
      console.error("Network error deleting syllabus:", err);
      const status = err?.response?.status || err?.status;
      const message = err?.response?.data?.detail || err?.message;
      if (status === 401) {
        alert("Phiên đăng nhập hết hạn.");
        router.push("/login");
        return;
      }
      alert(message || "Delete failed");
    } finally {
      setLoading(false);
    }
  }

  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button variant="destructive">Delete</Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Are you sure?</AlertDialogTitle>
          <AlertDialogDescription>
            This action cannot be undone. The syllabus will be permanently deleted.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>Cancel</AlertDialogCancel>
          <AlertDialogAction asChild>
            <Button variant="destructive" onClick={handleDelete} disabled={loading}>
              {loading ? "Deleting..." : "Confirm"}
            </Button>
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
</file>

<file path="components/SyllabusDetailView.tsx">
"use client";

import React, { useRef } from "react";
import Link from "next/link";
import { useReactToPrint } from "react-to-print";
import { Printer, ArrowLeft, Pencil } from "lucide-react";
import { Button } from "@/components/ui/button";
// QUAN TRỌNG: Import đúng đường dẫn
import { SyllabusData } from "./Types"; 

export default function SyllabusDetailView({ syllabus }: { syllabus: SyllabusData }) {
  const contentRef = useRef<HTMLDivElement>(null);
  
  const handlePrint = useReactToPrint({
    contentRef: contentRef,
    documentTitle: `${syllabus.subjectCode}_Syllabus`,
  });

  const printStyle = `
    @page { size: A4; margin: 20mm 20mm 20mm 20mm; } 
    @media print { 
        body { -webkit-print-color-adjust: exact; } 
        .print-break-avoid { break-inside: avoid; }
    }
    .word-table { width: 100%; border-collapse: collapse; font-size: 11pt; }
    .word-table td, .word-table th { border: 1px solid black; padding: 4px; vertical-align: top; }
    .word-header { font-family: "Times New Roman", serif; text-align: center; }
  `;

  return (
    <div className="p-6 bg-gray-100 min-h-screen font-sans">
      <style>{printStyle}</style>
      
      <div className="max-w-[210mm] mx-auto mb-4 flex justify-between print:hidden">
         <Link href="/"><Button variant="ghost"><ArrowLeft className="mr-2 h-4 w-4" /> Quay lại</Button></Link>
         <div className="flex gap-2">
            <Link href={`/syllabus/${syllabus.id}/edit`}><Button variant="outline"><Pencil className="mr-2 h-4 w-4" /> Chỉnh sửa</Button></Link>
            <Button onClick={() => handlePrint()}><Printer className="mr-2 h-4 w-4" /> Xuất PDF / In</Button>
         </div>
      </div>

      <div className="flex justify-center">
        <div ref={contentRef} className="bg-white w-[210mm] min-h-[297mm] px-[15mm] py-[15mm] shadow-lg print:shadow-none text-black leading-snug" style={{ fontFamily: '"Times New Roman", Times, serif', fontSize: '12pt' }}>
            
            <div className="text-center font-bold mb-4">
                <div className="uppercase text-[11pt]">TRƯỜNG ĐH GIAO THÔNG VẬN TẢI TP. HỒ CHÍ MINH</div>
                <div className="uppercase text-[14pt] mt-2">ĐỀ CƯƠNG CHI TIẾT HỌC PHẦN</div>
                <div className="italic font-normal text-[12pt]">(COURSE SYLLABUS)</div>
            </div>

            {/* 1. THÔNG TIN CHUNG */}
            <div className="mb-4">
                <h3 className="font-bold mb-2">1. Tổng quát về học phần (General course information)</h3>
                <table className="word-table">
                    <tbody>
                        <tr>
                            <td className="w-[140px]">Tên học phần</td>
                            <td colSpan={5}>
                                <div>Tiếng Việt: <b>{syllabus.subjectNameVi}</b></div>
                                <div>Tiếng Anh: <b>{syllabus.subjectNameEn}</b></div>
                                <div>Mã HP: <b>{syllabus.subjectCode}</b></div>
                            </td>
                        </tr>
                        <tr>
                            <td>Số tín chỉ</td>
                            <td colSpan={5} className="font-bold">{syllabus.credits} ({syllabus.credits}, 0, {syllabus.credits})</td>
                        </tr>
                        <tr className="text-center font-semibold">
                            <td>Phân bổ thời gian</td><td>Lý thuyết</td><td>Bài tập/Dự án</td><td>Thực hành</td><td>Tổng</td><td>Tự học</td>
                        </tr>
                        <tr className="text-center">
                            <td></td>
                            <td>{syllabus.timeAllocation.theory}</td>
                            <td>{syllabus.timeAllocation.exercises}</td>
                            <td>{syllabus.timeAllocation.practice}</td>
                            <td className="font-bold">{(syllabus.timeAllocation.theory + syllabus.timeAllocation.exercises + syllabus.timeAllocation.practice)}</td>
                            <td>{syllabus.timeAllocation.selfStudy}</td>
                        </tr>
                        <tr><td>Thang điểm</td><td colSpan={5}>10</td></tr>
                        <tr><td>HP tiên quyết</td><td colSpan={5}>{syllabus.prerequisites}</td></tr>
                        <tr><td>HP học trước</td><td colSpan={5}>{syllabus.preCourses}</td></tr>
                        <tr><td>HP song hành</td><td colSpan={5}>{syllabus.coCourses}</td></tr>
                        <tr>
                            <td>Loại học phần</td>
                            <td colSpan={5}>
                                <span className="mr-8">{syllabus.courseType === 'Bắt buộc' ? '☒' : '☐'} Bắt buộc</span>
                                <span className="mr-8">{syllabus.courseType === 'Tự chọn bắt buộc' ? '☒' : '☐'} Tự chọn bắt buộc</span>
                                <span>{syllabus.courseType === 'Tự chọn tự do' ? '☒' : '☐'} Tự chọn tự do</span>
                            </td>
                        </tr>
                        <tr><td>Thuộc thành phần</td><td colSpan={5}>{syllabus.componentType}</td></tr>
                    </tbody>
                </table>
            </div>

            {/* 2. MÔ TẢ */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">2. Mô tả tóm tắt học phần (Course description)</h3>
                <p className="text-justify whitespace-pre-line">{syllabus.description}</p>
            </div>

            {/* 3. MỤC TIÊU */}
            <div className="mb-4">
                 <h3 className="font-bold mb-1">3. Mục tiêu học phần (Course Objectives)</h3>
                 <p className="mb-1">Học phần này trang bị cho sinh viên:</p>
                 <ul className="list-none pl-0">
                    {syllabus.objectives.map((obj, i) => <li key={i}>{obj}</li>)}
                 </ul>
            </div>

            {/* 4. CLOs & PLO Mapping */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">4. Chuẩn đầu ra học phần (Course Learning Outcomes - CLO)</h3>
                <p className="mb-2">Sau khi học xong học phần này sinh viên có khả năng:</p>
                {syllabus.clos.map((c, i) => (
                    <div key={i} className="mb-1 text-justify flex">
                        <span className="font-bold min-w-[60px]">{c.code} :</span>
                        <span>{c.description}</span>
                    </div>
                ))}
                
                <p className="mt-2 mb-1 italic">Liên hệ giữa CĐR học phần (CLOs) và CĐR CTĐT (PLOs):</p>
                <table className="word-table text-center">
                    <thead>
                        <tr className="bg-gray-100">
                            <th>PLO/CLO</th>{[1,2,3,4,5,6,7].map(n => <th key={n}>PLO{n}</th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {syllabus.clos.map((clo, i) => {
                             const map = syllabus.ploMapping.find(m => m.cloCode === clo.code)?.plos || {};
                             return (
                                <tr key={i}>
                                    <td className="font-bold">{clo.code}</td>
                                    {[1,2,3,4,5,6,7].map(n => <td key={n}>{map[`PLO${n}`] || ""}</td>)}
                                </tr>
                             )
                        })}
                    </tbody>
                </table>
            </div>

            {/* 5. NHIỆM VỤ */}
            <div className="mb-4">
                <h3 className="font-bold mb-1">5. Nhiệm vụ của sinh viên (Students duties)</h3>
                <div className="whitespace-pre-line pl-4">{syllabus.studentDuties}</div>
            </div>

            {/* 6. ĐÁNH GIÁ */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-1">6. Phương pháp kiểm tra, đánh giá (Assessment methods):</h3>
                <p className="mb-2">Phương pháp kiểm tra đánh giá của HP đảm bảo người học đạt được CĐR mong đợi</p>
                <table className="word-table">
                    <thead>
                        <tr className="bg-gray-100 font-bold text-center">
                            <td>Thành phần đánh giá</td><td>Phương pháp/ Hình thức đánh giá</td><td>CĐR HP (CLOs)</td><td>Tiêu chí đánh giá</td><td>Trọng số (%)</td>
                        </tr>
                    </thead>
                    <tbody>
                        {syllabus.assessmentScheme.map((item, i) => (
                             <tr key={i} className="text-center">
                                 <td className="text-left">{item.component}</td><td className="text-left">{item.method}</td><td>{item.clos}</td><td>{item.criteria}</td><td>{item.weight}</td>
                             </tr>
                        ))}
                        <tr className="font-bold text-center"><td colSpan={4}>Tổng cộng</td><td>100</td></tr>
                    </tbody>
                </table>
            </div>

            {/* 7. KẾ HOẠCH */}
            <div className="mb-4">
                <h3 className="font-bold mb-2">7. Kế hoạch giảng dạy và học tập (Teaching and learning plan/outline)</h3>
                <table className="word-table">
                    <thead>
                        <tr className="bg-gray-100 font-bold text-center">
                            <td className="w-[10%]">Tuần / Chương</td><td className="w-[40%]">Nội dung</td><td className="w-[10%]">CLOs</td><td className="w-[25%]">Hoạt động dạy và học</td><td className="w-[15%]">Dạng bài đánh giá</td>
                        </tr>
                    </thead>
                    <tbody>
                         <tr className="font-bold bg-gray-50"><td colSpan={5}>PHẦN LÝ THUYẾT</td></tr>
                        {syllabus.teachingPlan.map((row, i) => (
                            <tr key={i}>
                                <td className="text-center">{row.week}</td><td className="whitespace-pre-line">{row.content}</td><td className="text-center">{row.clos}</td><td className="text-center whitespace-pre-line">{row.activity}</td><td className="text-center">{row.assessment}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* 8. TÀI LIỆU */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-1">8. Tài liệu học tập (Course materials)</h3>
                <div className="font-bold pl-0">8.1. Tài liệu chính (Main materials)</div>
                <div className="pl-4 mb-2">
                    {syllabus.materials.filter(m => m.type === 'Main').map((m, i) => <div key={i}>[{i+1}] {m.content}</div>)}
                </div>
                <div className="font-bold pl-0">8.2. Tài liệu tham khảo (References materials)</div>
                <div className="pl-4">
                    {syllabus.materials.filter(m => m.type === 'Ref').map((m, i) => <div key={i}>[{i+1}] {m.content}</div>)}
                </div>
            </div>

            {/* 9. YÊU CẦU KHÁC (ĐÃ CÓ) */}
            <div className="mb-4">
                 <h3 className="font-bold mb-1">9. Yêu cầu khác về học phần (Other course requirements and expectations)</h3>
                 <div className="pl-4 whitespace-pre-line">{syllabus.otherRequirements || "Không"}</div>
            </div>

            {/* 10. CHỮ KÝ */}
            <div className="mb-4 print-break-avoid">
                <h3 className="font-bold mb-2">10. Biên soạn và cập nhật đề cương</h3>
                <div className="pl-4">
                    <div>- Ngày biên soạn lần đầu: {syllabus.datePrepared}</div>
                    <div>- Ngày chỉnh sửa: {syllabus.dateEdited}</div>
                </div>
                
                <table className="w-full mt-6 text-center font-bold border-none uppercase">
                    <tbody>
                        <tr><td className="w-1/3 align-top pb-24">PHÒNG ĐÀO TẠO</td><td className="w-1/3 align-top pb-24">QUẢN LÝ CTĐT</td><td className="w-1/3 align-top pb-24">GV LẬP ĐỀ CƯƠNG</td></tr>
                        <tr><td></td><td>(Đã ký)</td><td>(Đã ký)</td></tr>
                        <tr><td></td><td>{syllabus.dean}</td><td>{syllabus.lecturer}</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/SyllabusEditForm.tsx">
"use client";

import React, { useState, useEffect, useMemo } from "react";
import { useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { 
    Save, 
    Send, 
    FileDiff, 
    ArrowLeft, 
    MessageSquareWarning, 
    Sparkles, 
    Loader2   
} from "lucide-react";
import { SyllabusData } from "./Types";
import MaterialsTab from "./syllabus-form/MaterialsTab";
import axios from "@/lib/axios";

interface ExtendedSyllabusData extends SyllabusData {
    feedback?: string | null;
}

export default function SyllabusEditForm({ initial }: { initial: SyllabusData }) {
  const router = useRouter();
  
  const [data, setData] = useState<ExtendedSyllabusData>(initial);
  const [lastSavedString, setLastSavedString] = useState(JSON.stringify(initial));
  const [submitting, setSubmitting] = useState(false);
  const [userRole, setUserRole] = useState<string>("");
  const [aiLoading, setAiLoading] = useState(false);

  useEffect(() => {
    const role = localStorage.getItem("role") || "";
    setUserRole(role);
  }, []);

  const hasUnsavedChanges = useMemo(() => {
    return JSON.stringify(data) !== lastSavedString;
  }, [data, lastSavedString]);

  const isEditable = !data.id || data.status === "Draft" || data.status === "Returned";


  const updateField = (field: keyof SyllabusData, value: any) => {
    if (isEditable) setData((prev) => ({ ...prev, [field]: value }));
  };

  const updateTime = (key: keyof SyllabusData["timeAllocation"], val: number) => {
    if (isEditable) setData((prev) => ({
      ...prev,
      timeAllocation: { ...prev.timeAllocation, [key]: val },
    }));
  }; 

  const addArrayItem = <T,>(field: keyof SyllabusData, newItem: T) => {
    if (isEditable) setData((prev) => ({
      ...prev,
      [field]: [...(prev[field] as T[]), newItem],
    }));
  };

  const removeArrayItem = (field: keyof SyllabusData, index: number) => {
    if (isEditable) setData((prev) => ({
      ...prev,
      [field]: (prev[field] as any[]).filter((_, i) => i !== index),
    }));
  };

  const updateArrayItem = <T,>(field: keyof SyllabusData, index: number, newItem: Partial<T>) => {
    if (isEditable) {
      const arr = [...(data[field] as T[])];
      arr[index] = { ...arr[index], ...newItem };
      setData((prev) => ({ ...prev, [field]: arr }));
    }
  };

  const handleAIGenerate = async () => {
    if (!data.subjectNameVi) return alert("Vui lòng nhập Tên môn học (Tiếng Việt) để AI hiểu ý bạn!");

    if (!confirm(`AI sẽ tự động soạn thảo nội dung cho môn "${data.subjectNameVi}". Dữ liệu hiện tại sẽ bị ghi đè. Bạn có chắc không?`)) return; 

    setAiLoading(true);
    try {
        const res = await axios.post("/ai/generate", { subject_name: data.subjectNameVi }, { skipSnake: true } as any);
        const aiData = res.data;
        setData(prev => ({
            ...prev,
            ...aiData,
            id: prev.id,
            status: prev.status,
            version: prev.version
        }));
        alert("AI đã soạn thảo xong! Vui lòng kiểm tra lại các Tab.");
    } catch (e: any) {
        console.error(e);
        const msg = e?.response?.data?.detail || e?.message || "Lỗi kết nối đến AI Server.";
        alert(msg);
    } finally {
        setAiLoading(false);
    }
  };

  const handleSave = async () => {
    setSubmitting(true);
    try {
      const isEdit = !!data.id;

      if (!isEdit) {
        // Create parent syllabus first (axios will convert camelCase -> snake_case on POST)
        const parentPayload: any = { ...data };
        delete parentPayload.clos;
        delete parentPayload.teachingPlan;
        delete parentPayload.materials;

        const res = await axios.post("/syllabuses", parentPayload);
        const resJson = res.data;
        if (!resJson?.id) throw new Error("No id returned from server");

        const syllabusId = resJson.id;

        // Create children (CLOs, Teaching Plans, Materials) using Promise.all
        const closPromises = (data.clos || []).map((clo) => axios.post("/syllabus-clos", { syllabus_id: syllabusId, ...clo }));
        const planPromises = (data.teachingPlan || []).map((p) => axios.post("/teaching-plans", { syllabus_id: syllabusId, ...p }));
        const matPromises = (data.materials || []).map((m) => axios.post("/syllabus-materials", { syllabus_id: syllabusId, ...m }));

        await Promise.all([...closPromises, ...planPromises, ...matPromises]);

        const newData = { ...data, id: syllabusId };
        setData(newData);
        setLastSavedString(JSON.stringify(newData));
        router.push(`/syllabus/${syllabusId}/edit`);
        alert("Tạo mới thành công!");
        return;
      }

      // Edit existing syllabus
      await axios.patch(`/syllabuses/${data.id}`, data);
      setLastSavedString(JSON.stringify(data));
      router.refresh();
      alert("Đã lưu bản nháp!");

    } catch (error: any) {
      console.error("Save Error:", error);
      if (error?.status === 401) {
        alert("Phiên đăng nhập hết hạn.");
        router.push("/login");
        return;
      }
      alert(error?.message || "Lỗi khi lưu dữ liệu.");
    } finally {
      setSubmitting(false);
    }
  };

  const handleWorkflow = async (action: "submit" | "approve" | "revise") => {
    if (!data.id) return;

    let confirmMsg = "";
    if (action === "submit") confirmMsg = "Gửi đề cương đi phê duyệt? Bạn sẽ không thể chỉnh sửa trong lúc chờ.";
    if (action === "approve") confirmMsg = "Xác nhận PHÊ DUYỆT đề cương này?";
    if (action === "revise") confirmMsg = "Hệ thống sẽ tạo phiên bản MỚI (Draft) từ bản này để bạn chỉnh sửa. Tiếp tục?";

    if (!confirm(confirmMsg)) return;

    setSubmitting(true);
    try {
      const res = await axios.post(`/syllabuses/${data.id}/${action}`);
      const resData = res.data;

      if (action === "revise") {
        alert(`Đã tạo phiên bản mới: ${resData.version}`);
        router.push(`/syllabus/${resData.id}/edit`);
        return;
      }
      alert("Thao tác thành công!");
      router.refresh();
    } catch (e: any) {
      console.error(e);
      const msg = e?.response?.data?.detail || e?.message || "Lỗi kết nối server.";
      alert(msg);
    } finally {
      setSubmitting(false);
    }
  };

  const totalPeriods = (data.timeAllocation.theory || 0) + (data.timeAllocation.exercises || 0) + (data.timeAllocation.practice || 0);

  const renderStatusBadge = () => {
    const status = data.status || "Draft";
    let colorClass = "bg-gray-500";
    let label = "Bản nháp";

    if (status === "Pending") { colorClass = "bg-yellow-500"; label = "Chờ duyệt (BM)"; }
    else if (status === "Pending Approval") { colorClass = "bg-orange-500"; label = "Chờ duyệt (PĐT)"; }
    else if (status === "Approved") { colorClass = "bg-green-600"; label = "Đã công bố"; }
    else if (status === "Returned") { colorClass = "bg-red-500"; label = "Yêu cầu sửa"; }

    return <Badge className={`${colorClass} hover:${colorClass} ml-3 text-sm px-3 py-1`}>{label}</Badge>;
  };

  return (
    <div className="w-full max-w-6xl mx-auto py-6 px-4">
      {data.status === "Returned" && data.feedback && (
          <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex gap-3 items-start shadow-sm animate-in slide-in-from-top-2">
             <MessageSquareWarning className="w-6 h-6 text-red-600 mt-0.5 shrink-0" />
             <div>
                <h3 className="font-bold text-red-700 text-lg">Yêu cầu chỉnh sửa</h3>
                <p className="text-red-600 mt-1 whitespace-pre-wrap">{data.feedback}</p>
             </div>
          </div>
      )}

      <Card className="shadow-lg border-t-4 border-t-primary">
        <CardHeader className="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 mb-4 bg-slate-50/50 rounded-t-lg gap-4">
          <div>
            <div className="flex items-center gap-2">
              <CardTitle className="text-xl">
                {data.id ? `Biên soạn: ${data.subjectCode}` : "Tạo Đề Cương Mới"}
              </CardTitle>
              {data.version && <Badge variant="outline" className="border-primary text-primary font-bold">v{data.version}</Badge>}
              {renderStatusBadge()}
            </div>
            <p className="text-sm text-gray-500 mt-1">
              {isEditable ? "Bạn đang ở chế độ chỉnh sửa" : "Chế độ xem (Read-only)"}
            </p>
          </div>

          <div className="flex flex-wrap gap-2 items-center">
            <Button variant="outline" onClick={() => router.back()} size="sm">
                <ArrowLeft className="w-4 h-4 mr-2"/> Thoát
            </Button>

            {isEditable && (
              <Button onClick={handleSave} disabled={submitting || aiLoading} variant="secondary" className="border border-slate-300 relative" size="sm">
                <Save className="w-4 h-4 mr-2" /> Lưu Nháp
                {hasUnsavedChanges && (
                    <span className="absolute -top-1 -right-1 flex h-3 w-3">
                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                      <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                )}
              </Button>
            )}

            {data.id && (
              <>
                {(data.status === "Draft" || data.status === "Returned") && (
                  <div className="flex flex-col items-end">
                      {/* SỬA: bg-blue-600 -> bg-teal-600 */}
                      <Button 
                        className="bg-teal-600 hover:bg-teal-700 text-white disabled:opacity-50 disabled:cursor-not-allowed" 
                        size="sm" 
                        onClick={() => handleWorkflow("submit")}
                        disabled={hasUnsavedChanges || submitting || aiLoading}
                        title={hasUnsavedChanges ? "Bạn cần lưu nháp trước khi gửi duyệt" : "Gửi đi phê duyệt"}
                      >
                        <Send className="w-4 h-4 mr-2" /> Gửi Duyệt
                      </Button>
                  </div>
                )}

                {(data.status === "Pending" || data.status === "Pending Approval") && (userRole === "Head of Dept" || userRole === "Academic Affairs" || userRole === "Admin") && (
                  <div className="flex gap-2">
                    <Button variant="outline" size="sm" onClick={() => router.push("/reviews")}>
                         Xử lý yêu cầu này (Duyệt/Trả về)
                    </Button>
                  </div>
                )}

                {data.status === "Approved" && (
                    <Button className="bg-purple-600 hover:bg-purple-700 text-white border-purple-800" size="sm" onClick={() => handleWorkflow("revise")}>
                        <FileDiff className="w-4 h-4 mr-2" /> Tạo phiên bản mới
                    </Button>
                )}
              </>
            )}
          </div>
        </CardHeader>

        <CardContent className={!isEditable ? "opacity-95 pointer-events-none" : ""}>
          <Tabs defaultValue="general" className="w-full">
            <TabsList className="grid w-full grid-cols-7 mb-6 h-auto p-1 bg-slate-100">
              <TabsTrigger value="general">1. Thông tin chung</TabsTrigger>
              <TabsTrigger value="clos">2-4. Mục tiêu & CĐR</TabsTrigger>
              <TabsTrigger value="plo">PLO Map</TabsTrigger>
              <TabsTrigger value="assessment">5-6. Đánh giá</TabsTrigger>
              <TabsTrigger value="plan">7. Kế hoạch</TabsTrigger>
              <TabsTrigger value="materials">8. Tài liệu</TabsTrigger>
              <TabsTrigger value="others">9. Khác</TabsTrigger>
            </TabsList>

            <TabsContent value="general" className="space-y-6 animate-in fade-in-50">
              <div className="grid grid-cols-2 gap-6">
                <div className="space-y-2">
                    <label className="text-sm font-semibold flex justify-between items-center">
                        Tên HP (Tiếng Việt)
                        {isEditable && (
                            <button 
                                onClick={handleAIGenerate} 
                                disabled={aiLoading}
                                className="text-xs flex items-center gap-1 text-purple-600 hover:text-purple-800 font-bold transition-all hover:scale-105 border border-purple-200 px-2 py-1 rounded-full bg-purple-50"
                                title="Tự động điền nội dung bằng AI"
                            >
                                {aiLoading ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>}
                                {aiLoading ? "AI đang viết..." : "AI Soạn thảo"}
                            </button>
                        )}
                    </label>
                    <Input value={data.subjectNameVi} onChange={(e) => updateField("subjectNameVi", e.target.value)} placeholder="VD: Nhập môn Trí tuệ Nhân tạo"/>
                </div>
                <div className="space-y-2"><label className="text-sm font-semibold">Tên HP (Tiếng Anh)</label><Input value={data.subjectNameEn} onChange={(e) => updateField("subjectNameEn", e.target.value)} /></div>
                <div className="space-y-2"><label className="text-sm font-semibold">Mã Học Phần</label><Input value={data.subjectCode} onChange={(e) => updateField("subjectCode", e.target.value)} /></div>
                <div className="space-y-2"><label className="text-sm font-semibold">Số tín chỉ</label><Input type="number" value={data.credits} onChange={(e) => updateField("credits", Number(e.target.value))} /></div>
              </div>
              <div className="border p-4 rounded-md bg-slate-50">
                <h3 className="font-bold mb-4 text-sm uppercase text-slate-600">Phân bổ thời gian (Tiết)</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                  <label className="text-sm">Lý thuyết <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.theory} onChange={(e) => updateTime("theory", Number(e.target.value))} /></label>
                  <label className="text-sm">Bài tập/Dự án <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.exercises} onChange={(e) => updateTime("exercises", Number(e.target.value))} /></label>
                  <label className="text-sm">Thực hành <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.practice} onChange={(e) => updateTime("practice", Number(e.target.value))} /></label>
                  <label className="text-sm">Tự học <Input type="number" className="mt-1 bg-white" value={data.timeAllocation.selfStudy} onChange={(e) => updateTime("selfStudy", Number(e.target.value))} /></label>
                  <div className="text-sm font-bold pb-2 text-right md:text-left">Tổng trên lớp: <span className="text-lg text-primary ml-2">{totalPeriods}</span></div>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <label className="text-sm font-semibold">HP Tiên quyết <Input className="mt-1" value={data.prerequisites} onChange={(e) => updateField("prerequisites", e.target.value)} /></label>
                <label className="text-sm font-semibold">HP Học trước <Input className="mt-1" value={data.preCourses} onChange={(e) => updateField("preCourses", e.target.value)} /></label>
                <label className="text-sm font-semibold">HP Song hành <Input className="mt-1" value={data.coCourses} onChange={(e) => updateField("coCourses", e.target.value)} /></label>
              </div>
               <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <label className="text-sm font-semibold">Loại học phần <select className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background mt-1" value={data.courseType} onChange={(e) => updateField("courseType", e.target.value)}><option value="Bắt buộc">Bắt buộc</option><option value="Tự chọn bắt buộc">Tự chọn bắt buộc</option><option value="Tự chọn tự do">Tự chọn tự do</option></select></label>
                <label className="text-sm font-semibold">Thuộc thành phần <Input className="mt-1" value={data.componentType} onChange={(e) => updateField("componentType", e.target.value)} /></label>
              </div>
              <div className="border-t pt-4 grid grid-cols-1 md:grid-cols-4 gap-6">
                <label className="text-sm font-semibold">Ngày biên soạn <Input type="date" className="mt-1" value={data.datePrepared} onChange={(e) => updateField("datePrepared", e.target.value)} /></label>
                <label className="text-sm font-semibold">Ngày chỉnh sửa <Input type="date" className="mt-1" value={data.dateEdited} onChange={(e) => updateField("dateEdited", e.target.value)} /></label>
                <label className="text-sm font-semibold">Trưởng khoa/QL CTĐT <Input className="mt-1" value={data.dean} onChange={(e) => updateField("dean", e.target.value)} /></label>
                <label className="text-sm font-semibold">GV Biên soạn <Input className="mt-1 bg-gray-100" value={data.lecturer} disabled /></label>
              </div>
            </TabsContent>

            {/* Các TabsContent khác (clos, plo, assessment, plan, materials, others) giữ nguyên code cũ vì không có màu cứng, nó sẽ tự ăn theo màu Primary mới */}
            <TabsContent value="clos" className="space-y-6 animate-in fade-in-50">
              <div><label className="font-bold block mb-2">2. Mô tả tóm tắt học phần</label><Textarea rows={4} value={data.description} onChange={(e) => updateField("description", e.target.value)} /></div>
              <div className="bg-slate-50 p-4 rounded-md">
                <label className="font-bold block mb-2">3. Mục tiêu học phần (Course Objectives)</label>
                {data.objectives.map((obj, i) => (
                  <div key={i} className="flex gap-2 mb-2"><Input value={obj} onChange={(e) => { const newObj = [...data.objectives]; newObj[i] = e.target.value; updateField("objectives", newObj); }} /><Button variant="ghost" onClick={() => { const newObj = data.objectives.filter((_, idx) => idx !== i); updateField("objectives", newObj); }}>✕</Button></div>
                ))}
                <Button variant="outline" size="sm" className="mt-2 border-dashed" onClick={() => updateField("objectives", [...data.objectives, `CO${data.objectives.length + 1}: `])}>+ Thêm Mục Tiêu (CO)</Button>
              </div>
              <div>
                <label className="font-bold block mb-2">4. Chuẩn đầu ra học phần (CLOs)</label>
                <Table>
                  <TableHeader><TableRow><TableHead className="w-24">Mã CĐR</TableHead><TableHead>Mô tả chuẩn đầu ra</TableHead><TableHead className="w-12"></TableHead></TableRow></TableHeader>
                  <TableBody>{data.clos.map((clo, i) => (
                    <TableRow key={i}><TableCell><Input className="font-bold" value={clo.code} onChange={(e) => updateArrayItem("clos", i, { code: e.target.value })} /></TableCell><TableCell><Input value={clo.description} onChange={(e) => updateArrayItem("clos", i, { description: e.target.value })} /></TableCell><TableCell><Button variant="ghost" size="icon" onClick={() => removeArrayItem("clos", i)}>✕</Button></TableCell></TableRow>
                  ))}</TableBody>
                </Table>
                <Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("clos", { code: `CLO${data.clos.length + 1}`, description: "" })}>+ Thêm CLO Mới</Button>
              </div>
            </TabsContent>

            <TabsContent value="plo" className="animate-in fade-in-50">
               {/* SỬA: Alert bg-blue-50 -> bg-teal-50 */}
               <div className="alert bg-teal-50 text-teal-700 p-3 mb-4 text-sm rounded-md border border-teal-100"><strong>Hướng dẫn:</strong> Điền các ký tự (I, R, M, A) vào các ô tương ứng.</div>
               <div className="border rounded-md overflow-x-auto"><Table><TableHeader><TableRow><TableHead className="w-24 bg-gray-100">CLO \ PLO</TableHead>{[1, 2, 3, 4, 5, 6, 7].map((p) => (<TableHead key={p} className="text-center w-16 bg-gray-50">PLO{p}</TableHead>))}</TableRow></TableHeader><TableBody>{data.clos.map((clo, i) => { const rowMap = data.ploMapping.find((p) => p.cloCode === clo.code) || { cloCode: clo.code, plos: {} }; return (<TableRow key={i}><TableCell className="font-bold bg-gray-50">{clo.code}</TableCell>{[1, 2, 3, 4, 5, 6, 7].map((p) => (<TableCell key={p} className="p-1"><Input className="h-9 text-center uppercase" value={rowMap.plos[`PLO${p}`] || ""} onChange={(e) => { const val = e.target.value; const newMapping = [...data.ploMapping]; const existIdx = newMapping.findIndex((m) => m.cloCode === clo.code); if (existIdx >= 0) { newMapping[existIdx] = { ...newMapping[existIdx], plos: { ...newMapping[existIdx].plos, [`PLO${p}`]: val } } } else { newMapping.push({ cloCode: clo.code, plos: { [`PLO${p}`]: val } }); } updateField("ploMapping", newMapping); }} /></TableCell>))}</TableRow>); })}</TableBody></Table></div>
            </TabsContent>

            <TabsContent value="assessment" className="space-y-6 animate-in fade-in-50">
               <div><label className="font-bold block mb-2">5. Nhiệm vụ của sinh viên</label><Textarea rows={4} value={data.studentDuties} onChange={(e) => updateField("studentDuties", e.target.value)} /></div>
               <div><div className="flex justify-between items-center mb-2"><label className="font-bold block">6. Phương pháp kiểm tra, đánh giá</label><div className="text-sm">Tổng trọng số: <span className={`font-bold ml-2 ${data.assessmentScheme.reduce((sum, item) => sum + (item.weight || 0), 0) === 100 ? 'text-green-600' : 'text-red-600'}`}>{data.assessmentScheme.reduce((sum, item) => sum + (item.weight || 0), 0)}%</span></div></div><div className="border rounded-md"><Table><TableHeader><TableRow><TableHead>Thành phần</TableHead><TableHead>Phương pháp / Hình thức</TableHead><TableHead className="w-24">CĐR HP</TableHead><TableHead className="w-20">Tiêu chí</TableHead><TableHead className="w-20">Trọng số (%)</TableHead><TableHead className="w-10"></TableHead></TableRow></TableHeader><TableBody>{data.assessmentScheme.map((item, i) => (<TableRow key={i}><TableCell><Input value={item.component} onChange={(e) => updateArrayItem("assessmentScheme", i, { component: e.target.value })} /></TableCell><TableCell><Input value={item.method} onChange={(e) => updateArrayItem("assessmentScheme", i, { method: e.target.value })} /></TableCell><TableCell><Input value={item.clos} onChange={(e) => updateArrayItem("assessmentScheme", i, { clos: e.target.value })} /></TableCell><TableCell><Input value={item.criteria} onChange={(e) => updateArrayItem("assessmentScheme", i, { criteria: e.target.value })} /></TableCell><TableCell><Input type="number" value={item.weight} onChange={(e) => updateArrayItem("assessmentScheme", i, { weight: Number(e.target.value) })} /></TableCell><TableCell><Button variant="ghost" size="icon" onClick={() => removeArrayItem("assessmentScheme", i)}>✕</Button></TableCell></TableRow>))}</TableBody></Table></div><Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("assessmentScheme", { component: "", method: "", clos: "", criteria: "", weight: 0 })}>+ Thêm thành phần đánh giá</Button></div>
            </TabsContent>

            <TabsContent value="plan" className="animate-in fade-in-50">
               <div className="mb-2"><label className="font-bold">7. Kế hoạch giảng dạy và học tập</label></div><div className="border rounded-md overflow-hidden"><Table><TableHeader><TableRow><TableHead className="w-20">Tuần</TableHead><TableHead className="w-1/3">Nội dung</TableHead><TableHead className="w-24">CLOs</TableHead><TableHead>Hoạt động Dạy/Học</TableHead><TableHead className="w-32">Đánh giá</TableHead><TableHead className="w-10"></TableHead></TableRow></TableHeader><TableBody>{data.teachingPlan.map((row, i) => (<TableRow key={i}><TableCell className="align-top"><Input value={row.week} onChange={(e) => updateArrayItem("teachingPlan", i, { week: e.target.value })} /></TableCell><TableCell className="align-top"><Textarea className="min-h-[80px]" value={row.content} onChange={(e) => updateArrayItem("teachingPlan", i, { content: e.target.value })} /></TableCell><TableCell className="align-top"><Input value={row.clos} onChange={(e) => updateArrayItem("teachingPlan", i, { clos: e.target.value })} /></TableCell><TableCell className="align-top"><Textarea className="min-h-[80px]" value={row.activity} onChange={(e) => updateArrayItem("teachingPlan", i, { activity: e.target.value })} /></TableCell><TableCell className="align-top"><Input value={row.assessment} onChange={(e) => updateArrayItem("teachingPlan", i, { assessment: e.target.value })} /></TableCell><TableCell className="align-top"><Button variant="ghost" size="icon" onClick={() => removeArrayItem("teachingPlan", i)}>✕</Button></TableCell></TableRow>))}</TableBody></Table></div><Button variant="outline" className="w-full mt-2 border-dashed" onClick={() => addArrayItem("teachingPlan", { week: "", content: "", clos: "", activity: "", assessment: "" })}>+ Thêm Tuần / Chương</Button>
            </TabsContent>

            <TabsContent value="materials">
                <MaterialsTab data={data} readOnly={!isEditable} onUpdate={(idx, val) => updateArrayItem("materials", idx, { content: val })} onAdd={(type) => addArrayItem("materials", { type: type, content: "" })} onRemove={(idx) => removeArrayItem("materials", idx)}/>
            </TabsContent>

            <TabsContent value="others" className="space-y-6 animate-in fade-in-50">
              <div className="bg-white p-6 rounded-md border shadow-sm"><label className="font-bold block mb-3 text-lg">9. Yêu cầu khác về học phần</label><Textarea rows={8} className="resize-y" value={data.otherRequirements} onChange={(e) => updateField("otherRequirements", e.target.value)} placeholder="Ví dụ: Sinh viên phải chuẩn bị Laptop cá nhân..." /></div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="components/Types.ts">
export type SyllabusStatus = "Draft" | "Pending" | "Approved" | "Returned" | "Pending Approval";

export interface SyllabusData {
  id?: number;
  status: SyllabusStatus;
  version?: string;
  subjectNameVi: string;
  subjectNameEn: string;
  subjectCode: string;
  credits: number;
  timeAllocation: {
    theory: number;
    exercises: number;
    practice: number;
    selfStudy: number;
  };
  prerequisites: string;
  preCourses: string;
  coCourses: string;
  courseType: string;
  componentType: string;
  description: string;
  objectives: string[];
  clos: { code: string; description: string }[];
  ploMapping: {
    cloCode: string;
    plos: { [key: string]: string };
  }[];
  studentDuties: string;
  assessmentScheme: {
    component: string;
    method: string;
    clos: string;
    criteria: string;
    weight: number;
  }[];
  teachingPlan: {
    week: string;
    content: string;
    clos: string;
    activity: string;
    assessment: string;
  }[];
  materials: {
    type: "Main" | "Ref";
    content: string;
  }[];
  otherRequirements: string;
  datePrepared: string;
  dateEdited: string;
  lecturer: string;
  headDepartment: string;
  dean: string;
}

export const defaultSyllabus: SyllabusData = {
  status: "Draft",
  subjectNameVi: "",
  subjectNameEn: "",
  subjectCode: "",
  credits: 3,
  timeAllocation: { theory: 0, exercises: 0, practice: 0, selfStudy: 0 },
  prerequisites: "",
  preCourses: "",
  coCourses: "",
  courseType: "Bắt buộc",
  componentType: "Cơ sở ngành",
  description: "",
  objectives: [],
  clos: [],
  ploMapping: [],
  studentDuties: "",
  assessmentScheme: [],
  teachingPlan: [],
  materials: [],
  otherRequirements: "Không",
  datePrepared: new Date().toISOString().split('T')[0],
  dateEdited: new Date().toISOString().split('T')[0],
  lecturer: "",
  headDepartment: "",
  dean: ""
};
</file>

<file path="components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="components/ui/sheet.tsx">
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="components/ui/table.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<
  HTMLTextAreaElement,
  React.ComponentProps<"textarea">
>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }
</file>

<file path="Dockerfile">
# apps/web/Dockerfile
FROM node:20-alpine

WORKDIR /app

# Copy file package để cài thư viện trước
COPY package*.json ./

# Tắt strict-ssl để tránh lỗi mạng ECONNRESET nếu mạng yếu
RUN npm config set strict-ssl false

# Cài đặt thư viện (thêm --legacy-peer-deps cho an toàn)
RUN npm install --legacy-peer-deps

# Copy toàn bộ code vào
COPY . .

# Mở port 3000
EXPOSE 3000

# Chạy chế độ Dev
CMD ["npm", "run", "dev"]
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="lib/apiClient.ts">
export const API_BASE = process.env.NEXT_PUBLIC_API_URL || "http://localhost:9999";

function isPlainObject(value: any) {
  return Object.prototype.toString.call(value) === "[object Object]";
}

function toSnakeCase(str: string) {
  return str.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);
}

function convertKeysToSnake(obj: any): any {
  if (Array.isArray(obj)) return obj.map(convertKeysToSnake);
  if (!isPlainObject(obj)) return obj;
  const out: any = {};
  for (const key of Object.keys(obj)) {
    const snakeKey = toSnakeCase(key);
    out[snakeKey] = convertKeysToSnake((obj as any)[key]);
  }
  return out;
}

export async function apiFetch(path: string, opts: {
  method?: string;
  body?: any;
  headers?: Record<string, string>;
  snake?: boolean; // convert body keys to snake_case when true (default for POST/PUT/PATCH)
} = {}) {
  const url = path.startsWith("http") ? path : `${API_BASE}${path.startsWith("/") ? path : `/${path}`}`;
  const token = (typeof window !== "undefined") ? localStorage.getItem("access_token") : null;

  const method = (opts.method || "GET").toUpperCase();
  const headers: Record<string, string> = {
    "Accept": "application/json",
    ...(opts.headers || {}),
  };

  if (token) headers["Authorization"] = `Bearer ${token}`;

  let body: any = undefined;
  if (opts.body !== undefined) {
    // If body is already a string, assume caller serialized it intentionally
    if (typeof opts.body === "string") {
      body = opts.body;
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    } else {
      const shouldSnake = opts.snake !== undefined ? opts.snake : (method === "POST" || method === "PUT" || method === "PATCH");
      const payload = shouldSnake ? convertKeysToSnake(opts.body) : opts.body;
      body = JSON.stringify(payload);
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    }
  }

  const res = await fetch(url, { method, headers, body });
  // If possible, parse JSON, else throw
  const text = await res.text();
  let json: any = null;
  try { json = text ? JSON.parse(text) : null; } catch (e) { /* not json */ }

  if (!res.ok) {
    const err: any = new Error(json?.detail || `Request failed: ${res.status}`);
    (err as any).status = res.status;
    (err as any).data = json;
    throw err;
  }

  return json;
}
</file>

<file path="lib/axios.ts">
import axios, { AxiosRequestConfig, InternalAxiosRequestConfig } from "axios";

export const API_BASE = process.env.NEXT_PUBLIC_API_URL || "http://localhost:9999";

function isPlainObject(value: any) {
  return Object.prototype.toString.call(value) === "[object Object]";
}

function toSnakeCase(str: string) {
  return str.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);
}

function convertKeysToSnake(obj: any): any {
  if (Array.isArray(obj)) return obj.map(convertKeysToSnake);
  if (!isPlainObject(obj)) return obj;
  const out: any = {};
  for (const key of Object.keys(obj)) {
    const snakeKey = toSnakeCase(key);
    out[snakeKey] = convertKeysToSnake((obj as any)[key]);
  }
  return out;
}

// Extend InternalAxiosRequestConfig to support skipSnake option
export interface CustomAxiosRequestConfig extends InternalAxiosRequestConfig<any> {
  skipSnake?: boolean;
}

const instance = axios.create({
  baseURL: API_BASE,
  headers: { Accept: "application/json" },
});

// Request interceptor: attach Authorization and convert body keys to snake_case
instance.interceptors.request.use((config: CustomAxiosRequestConfig) => {
  try {
    // Attach token if in browser
    if (typeof window !== "undefined") {
      const token = localStorage.getItem("access_token");
      if (token) (config.headers as any)["Authorization"] = `Bearer ${token}`;
    }

    const method = (config.method || "get").toLowerCase();
    const shouldSnake = config.skipSnake === true ? false : (method === "post" || method === "put" || method === "patch");

    if (shouldSnake && config.data && isPlainObject(config.data)) {
      config.data = convertKeysToSnake(config.data);
    }
  } catch (e) {
    // ignore
    console.error("axios request interceptor error", e);
  }
  return config;
});

// Response interceptor: pass through (backend returns camelCase per contract)
instance.interceptors.response.use(
  (res) => res,
  (err) => {
    return Promise.reject(err);
  }
);

export default instance;
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="package.json">
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-tabs": "^1.1.13",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.561.0",
    "next": "16.0.10",
    "react": "19.2.1",
    "react-dom": "19.2.1",
    "react-to-print": "^3.2.0",
    "recharts": "^3.6.0",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="scripts/test_api.js">
(async () => {
  const base = process.env.API_BASE || 'http://localhost:9999';
  console.log('Testing API at', base);
  try {
    const loginRes = await fetch(`${base}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: 'admin', password: '123456' }),
    });

    let loginBody = null;
    try { loginBody = await loginRes.json(); } catch (e) { /* ignore */ }
    console.log('LOGIN status=', loginRes.status);
    console.log('LOGIN body=', loginBody);

    if (loginBody && loginBody.access_token) {
      const token = loginBody.access_token;
      const meRes = await fetch(`${base}/users/me`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      let meBody = null;
      try { meBody = await meRes.json(); } catch (e) { /* ignore */ }
      console.log('/users/me status=', meRes.status);
      console.log('/users/me body=', meBody);
    } else {
      console.log('No access_token returned from login. Cannot test /users/me.');
    }
  } catch (err) {
    console.error('Error during API test:', err);
  }
})();
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

</files>
